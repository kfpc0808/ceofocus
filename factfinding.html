<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FM - Financial Master</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        :root {
            --primary: #0066FF;
            --secondary: #2a5a8a;
            --accent: #00C9A7;
            --danger: #FF4757;
            --warning: #FFA502;
            --success: #26DE81;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --border: #e1e8ed;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .progress-bar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
        }

        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .save-status.show { opacity: 1; }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .toolbar {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            position: relative;
            z-index: 500;
        }
        .toolbar-left {
            font-weight: 500;
            font-size: 1.1rem;
            position: relative;
            z-index: 501;
        }
        .toolbar-right {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            position: relative;
            z-index: 501;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 502;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,102,255,0.3); }
        .btn.success { background: var(--success); }
        .btn.warning { background: var(--warning); }
        .btn.danger { background: var(--danger); }
        .btn.secondary { background: var(--secondary); }
        .btn.info { background: #17a2b8; }

.main-grid {
    display: grid;
    grid-template-columns: 50% 50%;  /* 또는 1fr 1fr */
    gap: 1rem;  /* gap을 줄임 */
    /* ... */
}

        .input-section {
            overflow: hidden;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        .card h2 {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card h3 {
            font-size: 1.1rem;
            color: var(--secondary);
            margin: 1.5rem 0 1rem 0;
            padding-left: 0.75rem;
            border-left: 4px solid var(--accent);
        }

        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.95rem;
        }
        .input-field {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }
        
        .input-field input,
        .input-field select {
            flex: 1;
            min-width: 0;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="month"],
        input[type="tel"],
        select {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
            height: 50px;
            line-height: 1.5;
            width: 100%;
        }

        textarea {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
            width: 100%;
            min-height: 80px;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .input-field input[type="number"],
        .input-field input[inputmode="numeric"] {
            text-align: right;
        }
        
        .input-field span {
            color: var(--text-light);
            font-weight: 500;
            white-space: nowrap;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .dynamic-container {
            border: 2px dashed var(--border);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #fafbfc;
            position: relative;
        }
        
        .btn-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-add {
            width: 100%;
            margin-top: 0.5rem;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,102,255,0.3);
        }

        .retirement-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .result-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .result-box h4 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .result-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 1rem;
            gap: 0.5rem;
            overflow-x: auto;
        }
        
        .step {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .step.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .step:hover { 
            transform: translateY(-2px); 
        }
        
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: var(--border);
            margin-bottom: 0.5rem;
        }
        
        .step.active .step-number {
            background: white;
            color: var(--primary);
        }

        .profile-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .info-box {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .info-box.primary { border-left: 4px solid var(--primary); }
        .info-box.accent { border-left: 4px solid var(--accent); }
        .info-box.success { border-left: 4px solid var(--success); }
        .info-box.warning { border-left: 4px solid var(--warning); }

        .question-box {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 2px solid var(--border);
        }

        .question-box h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-group label {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .radio-group label:hover {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .radio-group input[type="radio"] {
            width: auto;
            height: auto;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        footer {
            background: var(--text);
            color: white;
            text-align: center;
            padding: 1.5rem;
            margin-top: 3rem;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .two-col {
                grid-template-columns: 1fr;
            }
            .retirement-layout {
                grid-template-columns: 1fr !important;
            }
            .summary-grid {
                grid-template-columns: 1fr 1fr !important;
            }
            .toolbar {
                padding: 0.75rem;
                gap: 0.5rem;
            }
            
            .toolbar-right {
                flex-wrap: nowrap;
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
                padding-bottom: 0.5rem;
            }
            
            .toolbar-right::-webkit-scrollbar {
                display: none; /* Chrome, Safari */
            }
            
            .toolbar-right .btn {
                flex-shrink: 0;
                white-space: nowrap;
                font-size: 0.85rem;
                padding: 0.5rem 0.9rem;
            }
        }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- 모바일 경고 오버레이 -->
    <div id="mobileWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 3rem 2rem; border-radius: 20px; text-align: center; max-width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="font-size: 4rem; margin-bottom: 1.5rem;">💻</div>
            <h2 style="font-size: 1.5rem; color: #2c3e50; margin-bottom: 1rem; font-weight: 700;">PC 및 태블릿 권장</h2>
            <p style="color: #7f8c8d; font-size: 1rem; line-height: 1.6; margin-bottom: 1.5rem;">
                더 나은 사용자 경험을 위해<br>
                PC/태블릿에서 이용을 권장합니다.
            </p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">
                <strong>권장 환경:</strong><br>
                PC, 노트북, 태블릿 (768px 이상)
            </div>
            <button onclick="closeMobileWarning()" style="background: linear-gradient(135deg, #0066FF, #2a5a8a); color: white; border: none; padding: 1rem 2rem; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; box-shadow: 0 4px 12px rgba(0,102,255,0.3);">
                둘러보기
            </button>
        </div>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="save-status" id="saveStatus">
        <i class="fas fa-check-circle"></i> 저장됨
    </div>

    <header>
        <h1><i class="fas fa-chart-line"></i> FM - Financial Master</h1>
        <p>프리미엄 재무컨설팅 플랫폼</p>
    </header>

    <div class="toolbar">
        <div class="toolbar-left">
            <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                <strong id="customerName">고객명</strong>
                
                <a id="phoneCallLink" href="tel:" style="
                    display: none;
                    align-items: center;
                    gap: 0.4rem;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    padding: 0.35rem 0.75rem;
                    border-radius: 16px;
                    text-decoration: none;
                    font-weight: 600;
                    font-size: 0.8rem;
                    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
                    transition: all 0.2s;
                    white-space: nowrap;
                " onmouseover="this.style.transform='scale(1.05)'" 
                   onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-phone-alt"></i>
                    <span id="displayPhone"></span>
                </a>
            </div>
        </div>
        <div class="toolbar-right">
            <button class="btn success" id="saveBtn"><i class="fas fa-save"></i> 저장</button>
            <button class="btn warning" id="loadBtn"><i class="fas fa-upload"></i> 불러오기</button>
            <button class="btn info" id="refreshBtn"><i class="fas fa-sync-alt"></i> 새로고침</button>
            <button class="btn secondary" id="mainBtn"><i class="fas fa-home"></i> 메인</button>
            <button class="btn danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> 로그아웃</button>
        </div>
    </div>

    <div class="step-indicator">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <div>고객정보</div>
        </div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <div>재무현황</div>
        </div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <div>보험진단</div>
        </div>
        <div class="step" data-step="4">
            <div class="step-number">4</div>
            <div>은퇴준비</div>
        </div>
        <div class="step" data-step="5">
            <div class="step-number">5</div>
            <div>목적자금</div>
        </div>
        <div class="step" data-step="6">
            <div class="step-number">6</div>
            <div>투자성향</div>
        </div>
        <div class="step" data-step="7">
            <div class="step-number">7</div>
            <div>상속증여</div>
        </div>
        <div class="step" data-step="8">
            <div class="step-number">8</div>
            <div>총평</div>
        </div>
    </div>

    <div class="main-grid">
        <div class="input-section">
            <!-- Step 1: 고객 기본정보 -->
            <div class="card" id="step1">
                <h2><i class="fas fa-user"></i> Step 1. 고객 기본정보</h2>
                
                <div class="input-group">
                    <label><i class="fas fa-calendar"></i> 고객미팅일자</label>
                    <input type="date" id="meetingDate">
                </div>

                <h3>기본 프로필</h3>
                <div class="two-col">
                    <div class="input-group">
                        <label>이름 *</label>
                        <input type="text" id="name" placeholder="홍길동">
                    </div>
                    
                    <div class="input-group">
                        <label><i class="fas fa-phone"></i> 연락처 *</label>
                        <div style="display: flex; gap: 0.3rem; align-items: center;">
                            <input type="text" value="010" readonly style="width: 60px; text-align: center; background: #f0f0f0; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; height: 50px;">
                            <span style="font-weight: bold; color: #999;">-</span>
                            <input type="tel" id="phone1" maxlength="4" placeholder="1234" style="flex: 1; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; text-align: center; height: 50px;">
                            <span style="font-weight: bold; color: #999;">-</span>
                            <input type="tel" id="phone2" maxlength="4" placeholder="5678" style="flex: 1; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; text-align: center; height: 50px;">
                        </div>
                    </div>
                </div>

                <div class="two-col">
                    <div class="input-group">
                        <label>성별 *</label>
                        <select id="gender">
                            <option value="">선택</option>
                            <option value="남">남</option>
                            <option value="여">여</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>생년월일 *</label>
                        <input type="date" id="birthDate">
                        <span id="ageDisplay" style="font-size: 0.9rem; color: #666; margin-top: 0.3rem; display: block;"></span>
                    </div>
                </div>

                <div class="two-col">
                    <div class="input-group">
                        <label>월 소득</label>
                        <div class="input-field">
                            <input type="text" id="income" inputmode="numeric"
       oninput="formatInputNumber(this); updateStep1Analysis();">
                            <span>원</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>회사명</label>
                        <input type="text" id="companyName" placeholder="회사명 입력">
                    </div>
                </div>

                <div class="input-group">
                    <label>직업 *</label>
                    <select id="occupation">
                        <option value="">선택</option>
                        <option value="직장인(대기업)">직장인(대기업)</option>
                        <option value="직장인(중소기업)">직장인(중소기업)</option>
                        <option value="공무원">공무원</option>
                        <option value="자영업">자영업</option>
                        <option value="전문직">전문직</option>
                        <option value="직접입력">직접입력</option>
                    </select>
                    <input type="text" id="customOccupation" placeholder="직업을 입력하세요" style="display: none; margin-top: 0.5rem;">
                </div>

                <div class="input-group">
                    <label>주소</label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <select id="addressType" style="width: auto;">
                            <option value="">선택</option>
                            <option value="회사">회사</option>
                            <option value="집">집</option>
                        </select>
                    </div>
                    <input type="text" id="address" placeholder="상세 주소 입력">
                </div>

                <h3>가구 구조</h3>
                <div class="two-col">
                    <div class="input-group">
                        <label>혼인 여부</label>
                        <select id="maritalStatus">
                            <option value="미혼">미혼</option>
                            <option value="기혼">기혼</option>
                            <option value="이혼">이혼</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>자녀 수</label>
                        <select id="childrenCount">
                            <option value="0">없음</option>
                            <option value="1">1명</option>
                            <option value="2">2명</option>
                            <option value="3">3명</option>
                            <option value="4">4명</option>
                            <option value="5">5명</option>
                        </select>
                    </div>
                </div>

                <div id="spouseSection" style="display: none;">
                    <h3>배우자 정보</h3>
                    <div class="two-col">
                        <div class="input-group">
                            <label>성별</label>
                            <input type="text" id="spouseGender" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="input-group">
                            <label>생년월일</label>
                            <input type="date" id="spouseBirthDate">
                            <span id="spouseAgeDisplay" style="font-size: 0.9rem; color: #666; margin-top: 0.3rem; display: block;"></span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>직업</label>
                        <select id="spouseOccupation">
                            <option value="">선택</option>
                            <option value="직장인(대기업)">직장인(대기업)</option>
                            <option value="직장인(중소기업)">직장인(중소기업)</option>
                            <option value="공무원">공무원</option>
                            <option value="자영업">자영업</option>
                            <option value="전문직">전문직</option>
                            <option value="직접입력">직접입력</option>
                        </select>
                        <input type="text" id="spouseCustomOccupation" placeholder="직업을 입력하세요" style="display: none; margin-top: 0.5rem;">
                    </div>
                    <div class="two-col">
                        <div class="input-group">
                            <label>월 소득</label>
                            <div class="input-field">
                                <input type="text" id="spouseIncome" inputmode="numeric"
       oninput="formatInputNumber(this);">
                                <span>원</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>회사명</label>
                            <input type="text" id="spouseCompanyName" placeholder="회사명 입력">
                        </div>
                    </div>
                </div>

                <h3>추가 정보</h3>
                <div class="input-group">
                    <label>향후 주요 재무계획</label>
                    <textarea id="futurePlan" placeholder="주요 재무계획을 입력하세요"></textarea>
                </div>
                <div class="input-group">
                    <label>주요 관심사</label>
                    <textarea id="mainInterest" placeholder="주요 관심사를 입력하세요"></textarea>
                </div>
            </div>

            <!-- Step 2: 재무현황 -->
            <div class="card" id="step2" style="display:none;">
                <h2><i class="fas fa-wallet"></i> Step 2. 재무현황 진단</h2>
                
                <h3>🏠 부동산 자산</h3>
                <div id="realEstateContainer"></div>
                <button class="btn-add" id="addRealEstate"><i class="fas fa-plus"></i> 부동산 추가</button>

                <h3>💰 금융 자산</h3>
                <div id="financialAssetsContainer"></div>
                <button class="btn-add" id="addFinancialAsset"><i class="fas fa-plus"></i> 금융자산 추가</button>

                <h3>💳 부채</h3>
                <div id="debtContainer"></div>
                <button class="btn-add" id="addDebt"><i class="fas fa-plus"></i> 대출 추가</button>

                <h3>💵 월 수입</h3>
                <div id="monthlyIncomeContainer"></div>
                <button class="btn-add" id="addMonthlyIncome"><i class="fas fa-plus"></i> 수입 추가</button>

                <h3>💸 월 지출</h3>
                <div id="monthlyExpenseContainer"></div>
                <button class="btn-add" id="addMonthlyExpense"><i class="fas fa-plus"></i> 지출 추가</button>

                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-top: 2rem;">
                    <h3 style="color: white; border: none;">📊 재무현황 요약</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">총 자산</div>
                            <div class="summary-value" id="totalAssets">0원</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">총 부채</div>
                            <div class="summary-value" id="totalDebt">0원</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">순자산</div>
                            <div class="summary-value" id="netAssets">0원</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">월 잉여금</div>
                            <div class="summary-value" id="monthlySurplus">0원</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Step 3: 보험진단 -->
            <div class="card" id="step3" style="display:none;">
                <h2><i class="fas fa-shield-alt"></i> Step 3. 보험 진단</h2>
                
                <h3>보장성 보험</h3>
                <div id="insuranceContainer"></div>
                <button class="btn-add" id="addInsurance"><i class="fas fa-plus"></i> 보험 추가</button>

                <h3>연금 보험</h3>
                <div id="pensionContainer"></div>
                <button class="btn-add" id="addPension"><i class="fas fa-plus"></i> 연금 추가</button>

                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">📊 보험료 요약</h3>
                    <div class="two-col">
                        <div class="info-box primary">
                            <div style="color: var(--text-light); font-size: 0.9rem;">보장성 보험료</div>
                            <div style="font-size: 1.3rem; font-weight: 600;" id="totalInsurancePremium">0원</div>
                        </div>
                        <div class="info-box accent">
                            <div style="color: var(--text-light); font-size: 0.9rem;">연금 보험료</div>
                            <div style="font-size: 1.3rem; font-weight: 600;" id="totalPensionPremium">0원</div>
                        </div>
                        <div class="info-box success">
                            <div style="color: var(--text-light); font-size: 0.9rem;">연금 예상 환급액</div>
                            <div style="font-size: 1.3rem; font-weight: 600;" id="totalPensionReturn">0원</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: 은퇴준비 분석 -->
            <div class="card" id="step4" style="display:none;">
                <h2><i class="fas fa-umbrella-beach"></i> Step 4. 은퇴 준비 분석</h2>
                
                <div class="retirement-layout">
                    <!-- 왼쪽: 입력 영역 -->
                    <div>
                        <div class="card">
                            <h3>기본 정보</h3>
                            <div class="two-col">
                                <div class="input-group">
                                    <label>희망 은퇴 연령</label>
                                    <input type="number" id="retirementAge" placeholder="65" min="50" max="80">
                                </div>
                                <div class="input-group">
                                    <label>예상 수명</label>
                                    <input type="number" id="lifeExpectancy" placeholder="90" min="70" max="120">
                                </div>
                            </div>
                            <div class="input-group">
                                <label>은퇴 후 희망 월 생활비 (현재가치)</label>
                                <div class="input-field">
                                    <input type="text" id="retirementMonthlyExpense" inputmode="numeric" placeholder="5,000,000">
                                    <span>원</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>물가상승률 (%)</label>
                                <input type="number" id="inflationRate" value="3.1" step="0.1" min="0" max="10">
                            </div>
                        </div>

                        <div class="card">
                            <h3>국민연금</h3>
                            <div class="input-group">
                                <label>본인 예상 월 수령액</label>
                                <div class="input-field">
                                    <input type="text" id="nationalPension" inputmode="numeric" placeholder="1,500,000">
                                    <span>원</span>
                                </div>
                            </div>
                            <div class="input-group" id="spouseNationalPensionGroup" style="display: none;">
                                <label>배우자 예상 월 수령액</label>
                                <div class="input-field">
                                    <input type="text" id="spouseNationalPension" inputmode="numeric" placeholder="800,000">
                                    <span>원</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 오른쪽: 선택된 자산 상세 -->
                    <div>
                        <div class="card" style="background: #f8f9fa; border: 2px solid #e9ecef;">
                            <h3 style="color: var(--primary);">📋 은퇴자산 상세내역(생년월일 입력필수)</h3>
                            <div id="retirementAssetsDetailPanel">
                                <p style="color: #999; text-align: center; padding: 2rem;">
                                    Step 2에서 자산을 입력하고<br>
                                    각 항목의 체크박스를 선택하면<br>
                                    은퇴시점의 예상 가치가 자동으로 계산됩니다.(고객정보에서 '생년월일' 입력 필수)
                                </p>
                            </div>
                        </div>

                        <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; margin-top: 1.5rem;">
                            <h3 style="color: white; border: none;">💰 총 은퇴자산</h3>
                            <div style="font-size: 2rem; font-weight: 700; text-align: center; margin: 1rem 0;">
                                <span id="totalRetirementAssetsFuture">0원</span>
                            </div>
                            <div style="font-size: 0.9rem; opacity: 0.9; text-align: center;">
                                은퇴시점 예상가치 (물가상승률 반영)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 분석 결과 -->
                <div class="card" style="margin-top: 2rem;">
                    <h3>📊 은퇴 준비 분석 결과</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">은퇴 후 기간</div>
                            <div class="summary-value" id="retirementYears">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">총 필요금액</div>
                            <div class="summary-value" id="totalRetirementNeeds">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">현재 준비액</div>
                            <div class="summary-value" id="currentRetirementFunds">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">부족/초과액</div>
                            <div class="summary-value" id="retirementGap">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">준비도 점수</div>
                            <div class="summary-value" id="retirementScore" style="font-size: 2rem; color: var(--accent);">-</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;" id="retirementChartContainer"></div>

                    <div class="info-box primary" style="margin-top: 1.5rem;">
                        <h4 style="color: var(--primary);">💡 분석 및 제언</h4>
                        <div id="retirementAdvice">은퇴 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.</div>
                    </div>
                </div>
            </div>

            <!-- Step 5: 목적자금 -->
            <div class="card" id="step5" style="display:none;">
                <h2><i class="fas fa-bullseye"></i> Step 5. 목적자금</h2>
                
                <div id="goalContainer"></div>
                <button class="btn-add" id="addGoal"><i class="fas fa-plus"></i> 목표 추가</button>
            </div>

            <!-- Step 6: 투자성향 -->
            <div class="card" id="step6" style="display:none;">
                <h2><i class="fas fa-chart-bar"></i> Step 6. 투자성향 분석</h2>
                
                <div id="investmentQuestionsContainer"></div>
            </div>

<!-- Step 7: 상속증여 (국세청 플로우 완벽 반영) -->
<div class="card" id="step7" style="display:none;">
    <h2><i class="fas fa-gift"></i> Step 7. 상속·증여세 절세 전략</h2>
    
    <div class="retirement-layout">
        <!-- 좌측: 입력 패널 -->
        <div>
            <div class="card" style="background: #f8f9fa;">
                <h3>📋 기본 정보</h3>
                
                <div class="input-group">
                    <label>분석 유형</label>
                    <div class="radio-group" style="flex-direction: row; gap: 1rem;">
                        <label style="flex: 1;">
                            <input type="radio" name="taxType" value="gift" checked onchange="toggleTaxType()">
                            <span>증여</span>
                        </label>
                        <label style="flex: 1;">
                            <input type="radio" name="taxType" value="inheritance" onchange="toggleTaxType()">
                            <span>상속</span>
                        </label>
                    </div>
                </div>

                <div class="input-group">
                    <label id="donorLabel">증여자</label>
                    <input type="text" id="donor" placeholder="예: 홍길동 (부)">
                </div>

                <div class="input-group">
                    <label id="recipientLabel">수증자</label>
                    <input type="text" id="recipient" placeholder="예: 홍아들 (자녀)">
                </div>

                <div class="input-group">
                    <label>관계</label>
                    <select id="taxRelation">
                        <option value="자녀">직계비속 (자녀)</option>
                        <option value="배우자">배우자</option>
                        <option value="손자녀">직계비속 (손자녀)</option>
                        <option value="부모">직계존속 (부모)</option>
                        <option value="형제자매">형제자매</option>
                        <option value="기타친족">기타 친족</option>
                        <option value="비친족">친족 아님</option>
                    </select>
                </div>
            </div>

            <!-- 1. 재산가액 -->
            <div class="card" style="background: #f8f9fa;">
                <h3>💰 1. 증여/상속 재산가액</h3>
                
                <div class="input-group">
                    <label>부동산 가액</label>
                    <div class="input-field">
                        <input type="text" id="propertyValue" inputmode="numeric" oninput="formatInputNumber(this); calculateTaxTotal();" placeholder="0">
                        <span>원</span>
                    </div>
                </div>

                <div class="input-group">
                    <label>금융자산 (현금/예금/주식 등)</label>
                    <div class="input-field">
                        <input type="text" id="financialValue" inputmode="numeric" oninput="formatInputNumber(this); calculateTaxTotal();" placeholder="0">
                        <span>원</span>
                    </div>
                </div>

                <div class="input-group">
                    <label>기타 재산</label>
                    <div class="input-field">
                        <input type="text" id="otherValue" inputmode="numeric" oninput="formatInputNumber(this); calculateTaxTotal();" placeholder="0">
                        <span>원</span>
                    </div>
                </div>

                <div class="info-box primary">
                    <div style="color: var(--text-light); font-size: 0.9rem;">① 총 재산가액</div>
                    <div style="font-size: 1.5rem; font-weight: 700;" id="totalPropertyValue">0원</div>
                </div>
            </div>

            <!-- 2. 비과세 및 채무 -->
            <div class="card" style="background: #f8f9fa;">
                <h3>📝 2. 비과세 및 채무</h3>
                
                <div class="input-group">
                    <label>비과세 재산 (공익법인 출연, 문화재 등)</label>
                    <div class="input-field">
                        <input type="text" id="taxExempt" inputmode="numeric" oninput="formatInputNumber(this); calculateTaxTotal();" placeholder="0">
                        <span>원</span>
                    </div>
                </div>

                <div class="input-group">
                    <label>채무 (담보채무, 임대보증금 등)</label>
                    <div class="input-field">
                        <input type="text" id="debtAmount" inputmode="numeric" oninput="formatInputNumber(this); calculateTaxTotal();" placeholder="0">
                        <span>원</span>
                    </div>
                </div>

                <div class="input-group" id="funeralExpenseGroup" style="display: none;">
                    <label>장례비용 (최대 1천만원 또는 500만원)</label>
                    <div class="input-field">
                        <input type="text" id="funeralExpense" inputmode="numeric" oninput="formatInputNumber(this); calculateTaxTotal();" placeholder="0">
                        <span>원</span>
                    </div>
                </div>
            </div>

            <!-- 3. 사전증여재산 -->
            <div class="card" style="background: #f8f9fa;">
                <h3>📅 3. 기존 증여 이력</h3>
                
                <div class="input-group">
                    <label>최근 10년 이내 증여받은 금액</label>
                    <div class="input-field">
                        <input type="text" id="previousGiftAmount" inputmode="numeric" oninput="formatInputNumber(this); calculateTaxTotal();" placeholder="0">
                        <span>원</span>
                    </div>
                </div>

                <div class="input-group">
                    <label>증여 연도</label>
                    <input type="number" id="previousGiftYear" placeholder="예: 2020" min="2000" max="2025">
                </div>

                <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 0.5rem;">
                    * 직계존속으로부터의 증여는 10년, 기타는 5년 이내 합산
                </small>
            </div>

            <!-- 4. 수증자/상속인 정보 -->
            <div class="card" style="background: #f8f9fa;">
                <h3>👨‍👩‍👧‍👦 4. 수증자/상속인 정보</h3>
                
                <div class="input-group">
                    <label>수증자/상속인 나이</label>
                    <input type="number" id="recipientAge" placeholder="예: 30" min="0" max="120" onchange="calculateTaxTotal()">
                    <small style="color: #666; font-size: 0.85rem; margin-top: 0.3rem; display: block;">
                        * 미성년자(만 19세 미만)는 공제액이 다릅니다
                    </small>
                </div>

                <div id="inheritanceOnlyFields" style="display: none;">
                    <div class="input-group">
                        <label>상속인 수 (자녀)</label>
                        <input type="number" id="heirCount" placeholder="예: 2" min="1" max="10" value="1" onchange="calculateTaxTotal()">
                    </div>

                    <div class="input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="hasDisability" onchange="calculateTaxTotal()" style="width: auto; height: auto;">
                            <span>장애인 여부</span>
                        </label>
                    </div>

                    <div class="input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="isElderly" onchange="calculateTaxTotal()" style="width: auto; height: auto;">
                            <span>연로자 (65세 이상)</span>
                        </label>
                    </div>

                    <div class="input-group">
                        <label>배우자 실제 상속분 (배우자공제 계산용)</label>
                        <div class="input-field">
                            <input type="text" id="spouseInheritance" inputmode="numeric" oninput="formatInputNumber(this); calculateTaxTotal();" placeholder="0">
                            <span>원</span>
                        </div>
                        <small style="color: #666; font-size: 0.85rem; margin-top: 0.3rem; display: block;">
                            * 배우자공제: 최소 5억 ~ 최대 30억 (실제 상속분의 30% + 5억)
                        </small>
                    </div>
                </div>
            </div>

            <button class="btn" style="width: 100%; padding: 1rem; font-size: 1.1rem; margin-top: 1rem;" onclick="calculateDetailedTax()">
                <i class="fas fa-calculator"></i> 상세 세액 계산하기
            </button>
        </div>

        <!-- 우측: 결과 패널 -->
        <div>
            <div class="card" id="taxResultPanel" style="display: none;">
                <h3 style="color: var(--primary);">📊 세액 계산 결과</h3>
                
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #64748b; font-size: 0.95rem;">① 총 재산가액</span>
                        <span style="font-weight: 700; font-size: 1.05rem;" id="result1TotalProperty">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #64748b; font-size: 0.95rem;">② - 비과세/채무</span>
                        <span style="font-weight: 700; font-size: 1.05rem;" id="result2Exempt">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #64748b; font-size: 0.95rem;">③ + 사전증여재산</span>
                        <span style="font-weight: 700; font-size: 1.05rem;" id="result3PreviousGift">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 2px solid #3b82f6;">
                        <span style="font-weight: 700; font-size: 1.05rem; color: var(--primary);">④ = 과세가액</span>
                        <span style="font-weight: 700; font-size: 1.2rem; color: var(--primary);" id="result4TaxableAmount">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #64748b; font-size: 0.95rem;">⑤ - 공제액</span>
                        <span style="font-weight: 700; font-size: 1.05rem;" id="result5Deduction">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 2px solid #3b82f6;">
                        <span style="font-weight: 700; font-size: 1.05rem; color: var(--primary);">⑥ = 과세표준</span>
                        <span style="font-weight: 700; font-size: 1.2rem; color: var(--primary);" id="result6TaxBase">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #64748b; font-size: 0.95rem;">⑦ × 세율 - 누진공제</span>
                        <span style="font-weight: 700; font-size: 1.05rem;" id="result7TaxRate">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #64748b; font-size: 0.95rem;">⑧ + 세대생략 할증</span>
                        <span style="font-weight: 700; font-size: 1.05rem;" id="result8Surcharge">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="color: #64748b; font-size: 0.95rem;">⑨ - 세액공제 (10%)</span>
                        <span style="font-weight: 700; font-size: 1.05rem;" id="result9Credit">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 1rem 0; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); margin: 1rem -1.5rem -1.5rem -1.5rem; padding: 1rem 1.5rem; border-radius: 0 0 12px 12px;">
                        <span style="font-weight: 700; font-size: 1.2rem; color: #dc2626;">⑩ 최종 납부세액</span>
                        <span style="font-weight: 700; font-size: 1.5rem; color: #dc2626;" id="result10FinalTax">-</span>
                    </div>
                </div>

                <div id="deductionDetail" style="background: #fffbeb; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 1.5rem; display: none;">
                    <h4 style="color: #92400e; margin-bottom: 0.75rem; font-size: 0.95rem;">📋 공제 상세내역</h4>
                    <div id="deductionDetailContent" style="line-height: 1.8; color: #78350f; font-size: 0.85rem;"></div>
                </div>

                <div id="scenarioComparison" style="display: none; margin-top: 1.5rem;">
                    <h3>📈 시나리오별 비교</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 10px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">시나리오 1</div>
                            <div style="font-weight: 600; font-size: 0.95rem; color: #64748b; margin-bottom: 0.75rem;">직접 증여</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;" id="scenario1Amount">-</div>
                            <div style="display: inline-block; padding: 0.25rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">현재 방식</div>
                        </div>
                        
                        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 10px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">시나리오 2</div>
                            <div style="font-weight: 600; font-size: 0.95rem; color: #64748b; margin-bottom: 0.75rem;">배우자 경유</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;" id="scenario2Amount">-</div>
                            <div style="display: inline-block; padding: 0.25rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 20px; font-size: 0.8rem; font-weight: 600;" id="scenario2Savings">-</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; border-radius: 10px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 0.85rem; color: #166534; margin-bottom: 0.5rem;">시나리오 3</div>
                            <div style="font-weight: 600; font-size: 0.95rem; color: #166534; margin-bottom: 0.75rem;">10년 분할</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;" id="scenario3Amount">-</div>
                            <div style="display: inline-block; padding: 0.25rem 0.75rem; background: #dcfce7; color: #166534; border-radius: 20px; font-size: 0.8rem; font-weight: 600;" id="scenario3Savings">✨ 최대 절세</div>
                        </div>
                    </div>
                </div>

                <div class="info-box primary" style="margin-top: 1.5rem;" id="taxStrategyAdvice">
                    <h4 style="color: var(--primary); margin-bottom: 0.75rem;">💡 추천 절세 전략</h4>
                    <div id="taxStrategyContent">계산 버튼을 눌러주세요.</div>
                </div>

                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #f59e0b; margin-top: 1.5rem; display: none;" id="optimalPlan">
                    <h4 style="color: #92400e; margin-bottom: 1rem;">⚡ 최적 실행 방안</h4>
                    <div id="optimalPlanContent"></div>
                </div>
            </div>

            <div class="card" style="background: #fffbeb; border: 2px solid #fbbf24;">
                <h4 style="color: #92400e; margin-bottom: 1rem;">💡 참고사항</h4>
                <div style="line-height: 1.8; color: #78350f; font-size: 0.9rem;">
                    <strong>증여재산공제 (10년 합산)</strong><br>
                    • 배우자: 6억원<br>
                    • 직계비속 (성년): 5천만원<br>
                    • 직계비속 (미성년): 2천만원<br>
                    • 직계존속: 5천만원<br>
                    • 기타친족: 1천만원<br><br>
                    
                    <strong>세율 (누진세율)</strong><br>
                    • 1억 이하: 10%<br>
                    • 5억 이하: 20% (누진공제 1천만원)<br>
                    • 10억 이하: 30% (누진공제 6천만원)<br>
                    • 30억 이하: 40% (누진공제 1.6억원)<br>
                    • 30억 초과: 50% (누진공제 4.6억원)<br><br>
                    
                    <strong>⚠️ 주의</strong><br>
                    위 세액은 개략적인 추정치이며, 실제 세액은 다양한 요인에 따라 달라질 수 있습니다. 
                    정확한 세무 계획은 반드시 세무사와 상담하시기 바랍니다.
                </div>
            </div>
        </div>
    </div>

    <!-- 하위 호환성 -->
    <div style="display: none;">
        <input type="text" id="inheritanceAmount" value="0">
        <select id="inheritanceRelation"><option value="자녀">자녀</option></select>
        <textarea id="inheritanceRecipients"></textarea>
        <input type="text" id="giftAmount" value="0">
        <select id="giftRelation"><option value="자녀">자녀</option></select>
        <textarea id="giftPurpose"></textarea>
    </div>
</div>

            <!-- Step 8: 총평 -->
            <div class="card" id="step8" style="display:none;">
                <h2><i class="fas fa-file-alt"></i> Step 8. 종합 분석 및 총평</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center;">
                    <h3 style="color: white; border: none; padding: 0; margin-bottom: 1rem;">🎯 고객정보 기반 재무솔루션</h3>
                    <p style="opacity: 0.9; margin-bottom: 1.5rem;">모든 입력 데이터를 기반으로 맞춤형 재무 솔루션을 생성합니다</p>
                    <button class="btn" id="generateAISolution" style="background: white; color: var(--primary); font-weight: 600; padding: 1rem 2rem;">
                        <i class="fas fa-magic"></i> 고객정보 Summary 생성
                    </button>
                </div>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center;">
                    <h3 style="color: white; border: none; padding: 0; margin-bottom: 1rem;">📄 전문 PDF 보고서</h3>
                    <p style="opacity: 0.9; margin-bottom: 1.5rem;">모든 입력 데이터를 기반으로 전문적인 재무분석 보고서를 생성합니다</p>
                    <button class="btn" id="generatePDFReport" style="background: white; color: #667eea; font-weight: 600; padding: 1rem 2rem;">
                        <i class="fas fa-file-pdf"></i> PDF 보고서 다운로드
                    </button>
                </div>

                <div id="aiSolutionResult" style="display: none;">
                    <div class="info-box primary">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">💡 고객정보 Summary</h4>
                        <div id="aiSolutionText" style="line-height: 1.8; white-space: pre-wrap;"></div>
                    </div>
                </div>

                <h3>수동 총평 입력</h3>
                <div class="input-group">
                    <label>종합 분석 및 제안</label>
                    <textarea id="finalSummary" rows="10" placeholder="종합적인 재무 분석 및 제안사항을 입력하세요"></textarea>
                </div>
            </div>
        </div>
        <!-- 분석 섹션 (우측 패널) -->
        <div class="analysis-section">
            <div class="card" id="analysis1">
                <h2><i class="fas fa-user-check"></i> 고객 프로필 요약</h2>
                
                <div class="profile-summary">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">👤</div>
                    <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;" id="summaryName">고객명</div>
                    <div style="font-size: 1.1rem; opacity: 0.9;" id="summaryAge">만 -세</div>
                </div>

                <div class="info-box warning" id="summaryMeetingBox" style="display: none;">
                    <div style="color: var(--text-light); font-size: 0.9rem;">미팅일자</div>
                    <div style="font-size: 1.1rem; font-weight: 600;" id="summaryMeeting">-</div>
                </div>

                <div class="info-box primary">
                    <div style="color: var(--text-light); font-size: 0.9rem;">가구형태</div>
                    <div style="font-size: 1.1rem; font-weight: 600;" id="summaryFamily">-</div>
                </div>
                <div class="info-box accent">
                    <div style="color: var(--text-light); font-size: 0.9rem;">직업</div>
                    <div style="font-size: 1.1rem; font-weight: 600;" id="summaryJob">-</div>
                </div>
                <div class="info-box success">
                    <div style="color: var(--text-light); font-size: 0.9rem;">월 소득</div>
                    <div style="font-size: 1.1rem; font-weight: 600;" id="summaryIncome">-</div>
                </div>
            </div>

            <div class="card" id="analysis2" style="display:none;">
                <h2><i class="fas fa-chart-pie"></i> 재무현황 분석</h2>
                
                <div class="result-grid">
                    <div class="result-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h4>총 자산</h4>
                        <div class="result-value">0원</div>
                    </div>
                    <div class="result-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h4>총 부채</h4>
                        <div class="result-value">0원</div>
                    </div>
                    <div class="result-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h4>순자산</h4>
                        <div class="result-value">0원</div>
                    </div>
                    <div class="result-box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h4>월 잉여금</h4>
                        <div class="result-value">0원</div>
                    </div>
                </div>

                <div id="financialChartContainer"></div>

                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">💡 재무 건전성 평가</h3>
                    <p style="line-height: 1.8; color: var(--text);" id="financialAdvice">
                        재무 데이터를 입력하시면 자동으로 분석 결과가 표시됩니다.
                    </p>
                </div>
            </div>

            <div class="card" id="analysis3" style="display:none;">
                <h2><i class="fas fa-shield-alt"></i> 보험 진단 결과</h2>
                
                <div class="result-grid">
                    <div class="result-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h4>가입 보험 수</h4>
                        <div class="result-value" id="insuranceCount">0개</div>
                    </div>
                    <div class="result-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h4>월 보험료</h4>
                        <div class="result-value" id="totalPremium">0원</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">🛡️ 보장 분석</h3>
                    <p style="line-height: 1.8; color: var(--text);" id="insuranceAdvice">
                        보험 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.
                    </p>
                </div>
            </div>

            <div class="card" id="analysis4" style="display:none;">
                <h2><i class="fas fa-umbrella-beach"></i> 은퇴 준비 분석</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">은퇴 후 필요 기간</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">총 필요 자금</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">현재 준비액</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">부족액</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">-</div>
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">🖐️ 은퇴 준비 점수</h3>
                    <div style="font-size: 3rem; font-weight: 700; text-align: center; color: var(--primary); margin: 1rem 0;">-</div>
                    <p style="line-height: 1.8; color: var(--text); text-align: center;">
                        은퇴 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.
                    </p>
                </div>
            </div>

            <div class="card" id="analysis5" style="display:none;">
                <h2><i class="fas fa-bullseye"></i> 목적자금 달성 계획</h2>
                
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">총 목표 금액</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="totalGoalAmount">0원</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">현재 준비액</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="totalGoalCurrent">0원</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">필요 추가액</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="totalGoalGap">0원</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">달성률</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="goalAchievementRate">0%</div>
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">🎯 목표 달성 전략</h3>
                    <p style="line-height: 1.8; color: var(--text);" id="goalAdvice">
                        목적자금 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.
                    </p>
                </div>
            </div>

            <div class="card" id="analysis6" style="display:none;">
                <h2><i class="fas fa-chart-bar"></i> 투자성향 결과</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                    <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;" id="investmentType">-</div>
                    <div style="font-size: 1.2rem; opacity: 0.9;" id="investmentScore">총점: 0점</div>
                </div>

                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">📈 투자 성향 분석</h3>
                    <p style="line-height: 1.8; color: var(--text);" id="investmentAdvice">
                        투자성향 질문에 답변하시면 자동으로 분석 결과가 표시됩니다.
                    </p>
                </div>
            </div>

            <div class="card" id="analysis7" style="display:none;">
                <h2><i class="fas fa-gift"></i> 상속·증여 분석</h2>
                
                <div class="result-grid">
                    <div class="result-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h4>예상 상속액</h4>
                        <div class="result-value" id="totalInheritance">0원</div>
                    </div>
                    <div class="result-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h4>증여 예정액</h4>
                        <div class="result-value" id="totalGift">0원</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">💎 상속·증여 전략</h3>
                    <p style="line-height: 1.8; color: var(--text);" id="inheritanceAdvice">
                        상속·증여 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.
                    </p>
                </div>
            </div>

            <div class="card" id="analysis8" style="display:none;">
                <h2><i class="fas fa-clipboard-check"></i> 종합 분석 결과</h2>
                
                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                    <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">종합 재무 건강도</div>
                    <div style="font-size: 3rem; font-weight: 700;" id="overallScore">-</div>
                </div>

                <div id="comprehensiveAnalysis" style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">📋 종합 평가</h3>
                    <p style="line-height: 1.8; color: var(--text);">
                        모든 단계의 정보를 입력하시면 종합적인 분석 결과가 표시됩니다.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        Copyright © 2025 (주)한국FP센터. All Rights Reserved.
    </footer>

    <script>
        // 모바일 경고 닫기
        function closeMobileWarning() {
            document.getElementById('mobileWarning').style.display = 'none';
            document.body.style.overflow = 'auto';
            sessionStorage.setItem('mobileWarningClosed', 'true');
        }

        let currentStep = 1;
        let realEstateCount = 0;
        let financialAssetCount = 0;
        let debtCount = 0;
        let monthlyIncomeCount = 0;
        let monthlyExpenseCount = 0;
        let insuranceCount = 0;
        let pensionCount = 0;
        let goalCount = 0;

        const incomeCategories = ['급여', '사업소득', '임대소득', '이자소득', '배당소득', '연금소득', '기타', '직접입력'];
        const expenseCategories = ['식비', '주거비', '교통비', '통신비', '의료비', '교육비', '문화생활비', '보험료', '저축', '기타', '직접입력'];
        const insuranceTypes = ['생명보험', '손해보험', '종신보험', '실손보험', '자동차보험', '질병보험', '암보험', '직접입력'];
        
        const investmentQuestions = [
            {
                q: "투자 경험이 얼마나 되셨나요?",
                options: [
                    { text: "투자 경험이 전혀 없음", score: 1 },
                    { text: "1년 미만", score: 2 },
                    { text: "1-3년", score: 3 },
                    { text: "3-5년", score: 4 },
                    { text: "5년 이상", score: 5 }
                ]
            },
            {
                q: "투자 목적은 무엇인가요?",
                options: [
                    { text: "원금 보존", score: 1 },
                    { text: "안정적인 수익", score: 2 },
                    { text: "적절한 수익과 안정성", score: 3 },
                    { text: "높은 수익 추구", score: 4 },
                    { text: "최고 수익 추구 (고위험 감수)", score: 5 }
                ]
            },
            {
                q: "투자 자금의 사용 계획은?",
                options: [
                    { text: "1년 이내 사용 예정", score: 1 },
                    { text: "1-3년 내 사용 예정", score: 2 },
                    { text: "3-5년 내 사용 예정", score: 3 },
                    { text: "5-10년 내 사용 예정", score: 4 },
                    { text: "10년 이상 장기 투자", score: 5 }
                ]
            },
            {
                q: "현재 재무 상황은?",
                options: [
                    { text: "수입이 불안정하고 부채가 많음", score: 1 },
                    { text: "수입은 있으나 저축 여력 없음", score: 2 },
                    { text: "안정적 수입과 적절한 저축", score: 3 },
                    { text: "안정적 수입과 충분한 저축", score: 4 },
                    { text: "매우 안정적이며 투자 여력 충분", score: 5 }
                ]
            },
            {
                q: "투자금이 20% 손실이 발생한다면?",
                options: [
                    { text: "견딜 수 없어 즉시 매도", score: 1 },
                    { text: "매우 불안하지만 보유", score: 2 },
                    { text: "불안하지만 기다림", score: 3 },
                    { text: "추가 매수 고려", score: 4 },
                    { text: "기회로 생각하고 적극 매수", score: 5 }
                ]
            },
            {
                q: "선호하는 투자 상품은?",
                options: [
                    { text: "예금/적금", score: 1 },
                    { text: "채권/채권형 펀드", score: 2 },
                    { text: "혼합형 펀드", score: 3 },
                    { text: "주식형 펀드", score: 4 },
                    { text: "개별 주식/파생상품", score: 5 }
                ]
            },
            {
                q: "연간 기대 수익률은?",
                options: [
                    { text: "원금 보존 (0-2%)", score: 1 },
                    { text: "예금 수준 (2-4%)", score: 2 },
                    { text: "적정 수익 (4-8%)", score: 3 },
                    { text: "높은 수익 (8-15%)", score: 4 },
                    { text: "매우 높은 수익 (15% 이상)", score: 5 }
                ]
            },
            {
                q: "금융 지식 수준은?",
                options: [
                    { text: "기본 예금 정도만 이해", score: 1 },
                    { text: "펀드 정도 이해", score: 2 },
                    { text: "주식 투자 가능", score: 3 },
                    { text: "다양한 상품 이해", score: 4 },
                    { text: "전문가 수준", score: 5 }
                ]
            },
            {
                q: "투자 결정 시 중요한 요소는?",
                options: [
                    { text: "원금 보장", score: 1 },
                    { text: "안정성", score: 2 },
                    { text: "안정성과 수익의 균형", score: 3 },
                    { text: "수익성", score: 4 },
                    { text: "최대 수익", score: 5 }
                ]
            },
            {
                q: "포트폴리오 구성 시 주식 비중은?",
                options: [
                    { text: "0% (주식 투자 안함)", score: 1 },
                    { text: "0-20%", score: 2 },
                    { text: "20-50%", score: 3 },
                    { text: "50-80%", score: 4 },
                    { text: "80-100%", score: 5 }
                ]
            }
        ];

        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(Math.round(num || 0));
        }

        function unformat(str) {
            return parseInt((str || '').toString().replace(/,/g, '') || '0');
        }

        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        function switchStep(step) {
            for (let i = 1; i <= 8; i++) {
                const stepEl = document.getElementById(`step${i}`);
                const analysisEl = document.getElementById(`analysis${i}`);
                if (stepEl) stepEl.style.display = 'none';
                if (analysisEl) analysisEl.style.display = 'none';
                const stepIndicator = document.querySelector(`[data-step="${i}"]`);
                if (stepIndicator) stepIndicator.classList.remove('active');
            }
            
            const targetStep = document.getElementById(`step${step}`);
            const targetAnalysis = document.getElementById(`analysis${step}`);
            if (targetStep) targetStep.style.display = 'block';
            if (targetAnalysis) targetAnalysis.style.display = 'block';
            
            const targetIndicator = document.querySelector(`[data-step="${step}"]`);
            if (targetIndicator) targetIndicator.classList.add('active');
            
            currentStep = step;
            
            const progress = (step / 8) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            updateAnalysis();
        }

        function updateAnalysis() {
            if (currentStep === 1) {
                updateStep1Analysis();
            } else if (currentStep === 2) {
                calculateFinancialAnalysis();
            } else if (currentStep === 3) {
                calculateInsuranceAnalysis();
            } else if (currentStep === 4) {
                calculateRetirementAnalysis();
            } else if (currentStep === 5) {
                calculateGoalAnalysis();
            } else if (currentStep === 6) {
                calculateInvestmentAnalysis();
            } else if (currentStep === 7) {
                calculateInheritanceAnalysis();
            } else if (currentStep === 8) {
                calculateOverallAnalysis();
            }
        }

        function updateStep1Analysis() {
            const name = document.getElementById('name').value || '고객명';
            const birthDate = document.getElementById('birthDate').value;
            const age = calculateAge(birthDate);
            const marital = document.getElementById('maritalStatus').value;
            const children = document.getElementById('childrenCount').value;
            const occupation = document.getElementById('occupation').value;
            const customOccupation = document.getElementById('customOccupation').value;
            const income = document.getElementById('income').value;
            const meetingDate = document.getElementById('meetingDate').value;

            document.getElementById('customerName').textContent = name;
            document.getElementById('summaryName').textContent = name;
            document.getElementById('summaryAge').textContent = age > 0 ? `만 ${age}세` : '만 -세';
            document.getElementById('summaryFamily').textContent = `${marital} / 자녀 ${children}명`;
            document.getElementById('summaryJob').textContent = occupation === '직접입력' ? customOccupation : (occupation || '-');
            document.getElementById('summaryIncome').textContent = income ? formatNumber(unformat(income)) + '원' : '-';
            
            if (meetingDate) {
                document.getElementById('summaryMeetingBox').style.display = 'block';
                document.getElementById('summaryMeeting').textContent = meetingDate;
            }
        }

        function calculateFinancialAnalysis() {
            let totalRealEstate = 0;
            let totalFinancial = 0;
            let totalDebt = 0;
            let totalIncome = 0;
            let totalExpense = 0;

            for (let i = 0; i < realEstateCount; i++) {
                const val = document.getElementById(`realEstateValue_${i}`);
                if (val && val.value) totalRealEstate += unformat(val.value);
            }

            for (let i = 0; i < financialAssetCount; i++) {
                const val = document.getElementById(`assetBalance_${i}`);
                if (val && val.value) totalFinancial += unformat(val.value);
            }

            for (let i = 0; i < debtCount; i++) {
                const val = document.getElementById(`debtBalance_${i}`);
                if (val && val.value) totalDebt += unformat(val.value);
            }

            for (let i = 0; i < monthlyIncomeCount; i++) {
                const val = document.getElementById(`incomeAmount_${i}`);
                if (val && val.value) totalIncome += unformat(val.value);
            }

            for (let i = 0; i < monthlyExpenseCount; i++) {
                const val = document.getElementById(`expenseAmount_${i}`);
                if (val && val.value) totalExpense += unformat(val.value);
            }

            const totalAssets = totalRealEstate + totalFinancial;
            const netAssets = totalAssets - totalDebt;
            const monthlySurplus = totalIncome - totalExpense;

            document.getElementById('totalAssets').textContent = formatNumber(totalAssets) + '원';
            document.getElementById('totalDebt').textContent = formatNumber(totalDebt) + '원';
            document.getElementById('netAssets').textContent = formatNumber(netAssets) + '원';
            document.getElementById('monthlySurplus').textContent = formatNumber(monthlySurplus) + '원';

            const analysis2ResultBoxes = document.querySelectorAll('#analysis2 .result-value');
            if (analysis2ResultBoxes.length >= 4) {
                analysis2ResultBoxes[0].textContent = formatNumber(totalAssets) + '원';
                analysis2ResultBoxes[1].textContent = formatNumber(totalDebt) + '원';
                analysis2ResultBoxes[2].textContent = formatNumber(netAssets) + '원';
                analysis2ResultBoxes[3].textContent = formatNumber(monthlySurplus) + '원';
            }

            createFinancialCharts(totalRealEstate, totalFinancial, totalDebt, totalIncome, totalExpense);

            let advice = '';
            const debtRatio = totalAssets > 0 ? (totalDebt / totalAssets * 100) : 0;
            
            if (totalAssets === 0 && totalDebt === 0) {
                advice = '📝 재무 데이터를 입력하시면 자동으로 분석 결과가 표시됩니다.';
            } else if (netAssets > 0 && monthlySurplus > 0) {
                if (debtRatio < 30) {
                    advice = `✅ 재무 상태가 매우 양호합니다. 순자산이 플러스이며 월 잉여금도 발생하고 있습니다. 부채비율 ${debtRatio.toFixed(1)}%로 안정적입니다.`;
                } else if (debtRatio < 50) {
                    advice = `✅ 재무 상태가 양호합니다. 순자산과 월 잉여금이 있으나, 부채비율 ${debtRatio.toFixed(1)}%로 다소 높은 편입니다. 부채 관리가 필요합니다.`;
                } else {
                    advice = `⚠️ 순자산은 양호하나 부채비율이 ${debtRatio.toFixed(1)}%로 높습니다. 부채 상환 계획이 필요합니다.`;
                }
            } else if (netAssets > 0 && monthlySurplus <= 0) {
                advice = `⚠️ 순자산은 양호하나 월 잉여금이 부족합니다. 지출 관리가 필요합니다. 현재 월 ${formatNumber(Math.abs(monthlySurplus))}원 부족 상태입니다.`;
            } else if (netAssets <= 0) {
                advice = `🚨 부채가 자산보다 많습니다 (순자산: ${formatNumber(netAssets)}원). 부채 상환 계획이 시급합니다.`;
            }
            
            document.getElementById('financialAdvice').textContent = advice;
        }

        function createFinancialCharts(realEstate, financial, debt, income, expense) {
            const chartContainer = document.getElementById('financialChartContainer');
            if (!chartContainer) return;
            
            const totalAssets = realEstate + financial;
            
            let chartsHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h4 style="text-align: center; margin-bottom: 1rem; color: var(--secondary);">자산 구성</h4>
                        <div style="position: relative; height: 200px;">
            `;
            
            if (totalAssets > 0) {
                const realEstatePercent = (realEstate / totalAssets * 100);
                const financialPercent = (financial / totalAssets * 100);
                
                chartsHTML += `
                    <div style="display: flex; flex-direction: column; height: 100%; justify-content: center; gap: 1rem;">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>🏠 부동산</span>
                                <span><strong>${realEstatePercent.toFixed(1)}%</strong></span>
                            </div>
                            <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #667eea, #764ba2); width: ${realEstatePercent}%; height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-size: 0.85rem; font-weight: 600;">
                                    ${formatNumber(realEstate)}원
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>💰 금융자산</span>
                                <span><strong>${financialPercent.toFixed(1)}%</strong></span>
                            </div>
                            <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #f093fb, #f5576c); width: ${financialPercent}%; height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-size: 0.85rem; font-weight: 600;">
                                    ${formatNumber(financial)}원
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                chartsHTML += `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">데이터 없음</div>`;
            }
            
            chartsHTML += `
                        </div>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h4 style="text-align: center; margin-bottom: 1rem; color: var(--secondary);">월 수지 현황</h4>
                        <div style="position: relative; height: 200px;">
            `;
            
            if (income > 0 || expense > 0) {
                const maxValue = Math.max(income, expense);
                const incomeHeight = maxValue > 0 ? (income / maxValue * 100) : 0;
                const expenseHeight = maxValue > 0 ? (expense / maxValue * 100) : 0;
                
                chartsHTML += `
                    <div style="display: flex; height: 100%; align-items: flex-end; justify-content: space-around; gap: 2rem;">
                        <div style="flex: 1; text-align: center;">
                            <div style="background: linear-gradient(180deg, #43e97b, #38f9d7); height: ${incomeHeight}%; min-height: 40px; border-radius: 8px 8px 0 0; display: flex; flex-direction: column; justify-content: flex-start; padding-top: 10px; color: white; font-weight: 600;">
                                ${formatNumber(income)}원
                            </div>
                            <div style="margin-top: 0.5rem; font-weight: 600;">💵 수입</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div style="background: linear-gradient(180deg, #fa709a, #fee140); height: ${expenseHeight}%; min-height: 40px; border-radius: 8px 8px 0 0; display: flex; flex-direction: column; justify-content: flex-start; padding-top: 10px; color: white; font-weight: 600;">
                                ${formatNumber(expense)}원
                            </div>
                            <div style="margin-top: 0.5rem; font-weight: 600;">💸 지출</div>
                        </div>
                    </div>
                `;
            } else {
                chartsHTML += `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">데이터 없음</div>`;
            }
            
            chartsHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            chartContainer.innerHTML = chartsHTML;
        }

        function calculateInsuranceAnalysis() {
            let insurancePremium = 0;
            let pensionPremium = 0;
            let pensionReturn = 0;
            let insuranceCountValue = 0;

            for (let i = 0; i < insuranceCount; i++) {
                const premium = document.getElementById(`insurancePremium_${i}`);
                if (premium && premium.value) {
                    insurancePremium += unformat(premium.value);
                    insuranceCountValue++;
                }
            }

            for (let i = 0; i < pensionCount; i++) {
                const premium = document.getElementById(`pensionPremium_${i}`);
                const returnVal = document.getElementById(`pensionReturn_${i}`);
                if (premium && premium.value) pensionPremium += unformat(premium.value);
                if (returnVal && returnVal.value) pensionReturn += unformat(returnVal.value);
            }

            document.getElementById('totalInsurancePremium').textContent = formatNumber(insurancePremium) + '원';
            document.getElementById('totalPensionPremium').textContent = formatNumber(pensionPremium) + '원';
            document.getElementById('totalPensionReturn').textContent = formatNumber(pensionReturn) + '원';

            document.getElementById('insuranceCount').textContent = insuranceCountValue + '개';
            document.getElementById('totalPremium').textContent = formatNumber(insurancePremium + pensionPremium) + '원';

            let advice = '';
            const totalPremium = insurancePremium + pensionPremium;
            
            if (totalPremium === 0) {
                advice = '📋 보험 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.';
            } else {
                const income = unformat(document.getElementById('income').value || '0');
                const premiumRatio = income > 0 ? (totalPremium / income * 100) : 0;
                
                if (premiumRatio < 10) {
                    advice = `✅ 월 보험료가 소득의 ${premiumRatio.toFixed(1)}%로 적정 수준입니다. 보장성 ${formatNumber(insurancePremium)}원, 연금 ${formatNumber(pensionPremium)}원으로 균형잡혀 있습니다.`;
                } else if (premiumRatio < 15) {
                    advice = `⚠️ 월 보험료가 소득의 ${premiumRatio.toFixed(1)}%로 다소 높은 편입니다. 보장 내역을 검토하여 불필요한 중복 가입이 있는지 확인이 필요합니다.`;
                } else {
                    advice = `🚨 월 보험료가 소득의 ${premiumRatio.toFixed(1)}%로 매우 높습니다. 보험료 부담이 과도하여 재무 계획에 악영향을 줄 수 있습니다. 보험 구조조정이 시급합니다.`;
                }
            }
            
            document.getElementById('insuranceAdvice').textContent = advice;
        }

        function calculateRetirementAnalysis() {
            const retirementAge = parseInt(document.getElementById('retirementAge').value || '65');
            const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value || '90');
            const monthlyExpense = unformat(document.getElementById('retirementMonthlyExpense').value || '0');
            const inflationRate = parseFloat(document.getElementById('inflationRate').value || '3.1') / 100;
            const nationalPension = unformat(document.getElementById('nationalPension').value || '0');
            const spouseNationalPension = unformat(document.getElementById('spouseNationalPension').value || '0');
            
            const birthDate = document.getElementById('birthDate').value;
            const currentAge = calculateAge(birthDate);
            
            if (currentAge === 0 || retirementAge === 0 || lifeExpectancy === 0) {
                document.getElementById('retirementAdvice').textContent = '은퇴 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.';
                return;
            }
            
            const yearsToRetirement = retirementAge - currentAge;
            const retirementYears = lifeExpectancy - retirementAge;
            
            // 물가상승률 반영한 미래 생활비
            const futureMonthlyExpense = monthlyExpense * Math.pow(1 + inflationRate, yearsToRetirement);
            
            // 총 필요 금액 (연금 제외)
            const monthlyPension = nationalPension + spouseNationalPension;
            const monthlyGap = Math.max(0, futureMonthlyExpense - monthlyPension);
            const totalNeeds = monthlyGap * 12 * retirementYears;
            
            // 현재 준비액 (은퇴자산으로 선택된 항목들)
            let currentFunds = 0;
            const detailPanel = document.getElementById('retirementAssetsDetailPanel');
            let detailHTML = '';
            
            // 금융자산
            for (let i = 0; i < financialAssetCount; i++) {
                const checkbox = document.getElementById(`retirementAsset_${i}`);
                if (checkbox && checkbox.checked) {
                    const balance = unformat(document.getElementById(`assetBalance_${i}`).value || '0');
                    const rate = parseFloat(document.getElementById(`assetRate_${i}`).value || '0') / 100;
                    const futureValue = balance * Math.pow(1 + rate, yearsToRetirement);
                    currentFunds += futureValue;
                    
                    const assetType = document.getElementById(`assetType_${i}`).value;
                    detailHTML += `
                        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid var(--accent);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>${assetType}</strong>
                                <span style="color: var(--primary);">연 ${rate * 100}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #666;">
                                <span>현재: ${formatNumber(balance)}원</span>
                                <span>→</span>
                                <span style="font-weight: 600; color: var(--success);">${retirementAge}세: ${formatNumber(futureValue)}원</span>
                            </div>
                        </div>
                    `;
                }
            }
            
            // 연금보험
            for (let i = 0; i < pensionCount; i++) {
                const checkbox = document.getElementById(`retirementPension_${i}`);
                if (checkbox && checkbox.checked) {
                    const returnVal = unformat(document.getElementById(`pensionReturn_${i}`).value || '0');
                    currentFunds += returnVal;
                    
                    const pensionName = document.getElementById(`pensionName_${i}`).value;
                    detailHTML += `
                        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid var(--primary);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>${pensionName}</strong>
                                <span style="color: var(--primary);">연금보험</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                <span style="font-weight: 600; color: var(--success);">예상 수령액: ${formatNumber(returnVal)}원</span>
                            </div>
                        </div>
                    `;
                }
            }
            
            if (detailHTML === '') {
                detailHTML = `
                    <p style="color: #999; text-align: center; padding: 2rem;">
                        Step 2에서 자산을 입력하고<br>
                        각 항목의 체크박스를 선택하면<br>
                        은퇴시점의 예상 가치가 자동으로 계산됩니다.
                    </p>
                `;
            }
            
            detailPanel.innerHTML = detailHTML;
            document.getElementById('totalRetirementAssetsFuture').textContent = formatNumber(currentFunds) + '원';
            
            const gap = totalNeeds - currentFunds;
            const preparationRate = totalNeeds > 0 ? (currentFunds / totalNeeds * 100) : 0;
const score = Math.min(100, Math.round(preparationRate));
            
            document.getElementById('retirementYears').textContent = retirementYears + '년';
            document.getElementById('totalRetirementNeeds').textContent = formatNumber(totalNeeds) + '원';
            document.getElementById('currentRetirementFunds').textContent = formatNumber(currentFunds) + '원';
            document.getElementById('retirementGap').textContent = (gap >= 0 ? '-' : '+') + formatNumber(Math.abs(gap)) + '원';
            document.getElementById('retirementScore').textContent = score + '점';
            
            // 원형 진행률 차트 생성
            createRetirementCircleChart(preparationRate, score, totalNeeds, currentFunds, gap);
            
            let advice = '';
            if (score >= 80) {
                advice = `✅ 훌륭합니다! 은퇴 준비가 ${preparationRate.toFixed(1)}%로 매우 양호합니다. 현재 계획대로 진행하시면 안정적인 은퇴 생활이 가능합니다.`;
            } else if (score >= 50) {
                advice = `⚠️ 은퇴 준비가 ${preparationRate.toFixed(1)}%입니다. 추가로 ${formatNumber(Math.abs(gap))}원이 더 필요합니다. 월 저축을 늘리거나 투자 수익률을 높이는 방안을 검토해보세요.`;
            } else {
                advice = `🚨 은퇴 준비가 ${preparationRate.toFixed(1)}%로 부족합니다. ${formatNumber(Math.abs(gap))}원이 추가로 필요합니다. 지금부터 적극적인 재무 계획이 필요합니다.`;
            }
            
            document.getElementById('retirementAdvice').textContent = advice;
        }

        function createRetirementCircleChart(rate, score, totalNeeds, currentFunds, gap) {
            const container = document.getElementById('retirementChartContainer');
            if (!container) return;
            
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (rate / 100) * circumference;
            
            let color = '#ef4444';
            if (rate >= 80) color = '#10b981';
            else if (rate >= 50) color = '#f59e0b';
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem; align-items: center;">
                    <div style="position: relative; width: 200px; height: 200px; margin: 0 auto;">
                        <svg width="200" height="200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="90" fill="none" stroke="#e5e7eb" stroke-width="16"/>
                            <circle cx="100" cy="100" r="90" fill="none" stroke="${color}" stroke-width="16"
                                stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                                stroke-linecap="round" style="transition: stroke-dashoffset 1s ease;"/>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: ${color};">${rate.toFixed(1)}%</div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">준비율</div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 1rem; border-radius: 10px; margin-bottom: 0.75rem;">
                            <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.25rem;">💰 총 필요자금</div>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #1e293b;">${formatNumber(totalNeeds)}원</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 1rem; border-radius: 10px; margin-bottom: 0.75rem;">
                            <div style="color: #166534; font-size: 0.85rem; margin-bottom: 0.25rem;">✅ 현재 준비액</div>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #10b981;">${formatNumber(currentFunds)}원</div>
                        </div>
                        <div style="background: linear-gradient(135deg, ${gap >= 0 ? '#fee2e2' : '#f0fdf4'} 0%, ${gap >= 0 ? '#fecaca' : '#dcfce7'} 100%); padding: 1rem; border-radius: 10px; margin-bottom: 0.75rem;">
                            <div style="color: ${gap >= 0 ? '#991b1b' : '#166534'}; font-size: 0.85rem; margin-bottom: 0.25rem;">${gap >= 0 ? '⚠️ 추가 필요금액' : '🎉 초과 준비액'}</div>
                            <div style="font-size: 1.3rem; font-weight: 700; color: ${gap >= 0 ? '#dc2626' : '#10b981'};">${formatNumber(Math.abs(gap))}원</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1.25rem; border-radius: 10px; text-align: center;">
                            <div style="color: #1e40af; font-size: 0.9rem; margin-bottom: 0.5rem;">은퇴 준비 점수</div>
                            <div style="font-size: 2.5rem; font-weight: 700; color: #1e40af;">${score}점</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateGoalAnalysis() {
            let totalGoal = 0;
            let totalCurrent = 0;
            
            for (let i = 0; i < goalCount; i++) {
                const goalAmount = document.getElementById(`goalAmount_${i}`);
                const currentSavings = document.getElementById(`currentSavings_${i}`);
                if (goalAmount && goalAmount.value) totalGoal += unformat(goalAmount.value);
                if (currentSavings && currentSavings.value) totalCurrent += unformat(currentSavings.value);
            }
            
            const gap = totalGoal - totalCurrent;
            const achievementRate = totalGoal > 0 ? (totalCurrent / totalGoal * 100) : 0;
            
            document.getElementById('totalGoalAmount').textContent = formatNumber(totalGoal) + '원';
            document.getElementById('totalGoalCurrent').textContent = formatNumber(totalCurrent) + '원';
            document.getElementById('totalGoalGap').textContent = formatNumber(gap) + '원';
            document.getElementById('goalAchievementRate').textContent = achievementRate.toFixed(1) + '%';
            
            let advice = '';
            if (totalGoal === 0) {
                advice = '📋 목적자금 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.';
            } else if (achievementRate >= 80) {
                advice = `✅ 목표 달성률 ${achievementRate.toFixed(1)}%로 매우 양호합니다. 현재 계획대로 진행하시면 목표를 달성할 수 있습니다.`;
            } else if (achievementRate >= 50) {
                advice = `⚠️ 목표 달성률 ${achievementRate.toFixed(1)}%입니다. 추가로 ${formatNumber(gap)}원이 필요합니다. 저축을 늘리거나 투자 전략을 재검토해보세요.`;
            } else {
                advice = `🚨 목표 달성률 ${achievementRate.toFixed(1)}%로 부족합니다. ${formatNumber(gap)}원이 추가로 필요합니다. 목표 기간 연장 또는 저축액 증액을 고려해보세요.`;
            }
            
            document.getElementById('goalAdvice').textContent = advice;
        }

        function calculateInvestmentAnalysis() {
            let totalScore = 0;
            let answeredQuestions = 0;
            
            investmentQuestions.forEach((q, qIndex) => {
                const selected = document.querySelector(`input[name="q${qIndex}"]:checked`);
                if (selected) {
                    totalScore += parseInt(selected.value);
                    answeredQuestions++;
                }
            });
            
            if (answeredQuestions === 0) {
                document.getElementById('investmentAdvice').textContent = '투자성향 질문에 답변하시면 자동으로 분석 결과가 표시됩니다.';
                return;
            }
            
            let type = '';
            let typeEmoji = '';
            let advice = '';
            
            if (totalScore <= 15) {
                type = '안정형';
                typeEmoji = '🛡️';
                advice = '원금 보존을 최우선으로 하는 투자자입니다. 예금, 적금, 국채 등 안전자산 위주의 포트폴리오를 권장합니다.';
            } else if (totalScore <= 25) {
                type = '안정추구형';
                typeEmoji = '📊';
                advice = '안정성을 중시하되 적정 수익도 추구하는 투자자입니다. 채권형 펀드와 안정형 혼합 펀드가 적합합니다.';
            } else if (totalScore <= 35) {
                type = '위험중립형';
                typeEmoji = '⚖️';
                advice = '안정성과 수익성의 균형을 추구하는 투자자입니다. 혼합형 펀드나 배당주 투자가 적합합니다.';
            } else if (totalScore <= 45) {
                type = '적극투자형';
                typeEmoji = '📈';
                advice = '높은 수익을 위해 상당한 위험을 감수할 수 있는 투자자입니다. 주식형 펀드나 개별 주식 투자가 가능합니다.';
            } else {
                type = '공격투자형';
                typeEmoji = '🚀';
                advice = '최고 수익을 위해 높은 위험도 감수하는 투자자입니다. 성장주, 신흥시장, 레버리지 상품 등 공격적 투자가 가능합니다.';
            }
            
            document.getElementById('investmentType').textContent = typeEmoji + ' ' + type;
            document.getElementById('investmentScore').textContent = `총점: ${totalScore}점`;
            document.getElementById('investmentAdvice').textContent = advice;
        }

        function calculateInheritanceAnalysis() {
            const inheritanceAmount = unformat(document.getElementById('inheritanceAmount').value || '0');
            const giftAmount = unformat(document.getElementById('giftAmount').value || '0');
            
            document.getElementById('totalInheritance').textContent = formatNumber(inheritanceAmount) + '원';
            document.getElementById('totalGift').textContent = formatNumber(giftAmount) + '원';
            
            let advice = '';
            const totalAmount = inheritanceAmount + giftAmount;
            
            if (totalAmount === 0) {
                advice = '📋 상속·증여 정보를 입력하시면 자동으로 분석 결과가 표시됩니다.';
            } else if (totalAmount < 500000000) {
                advice = '✅ 현재 규모는 상속세 부담이 크지 않습니다. 기본 공제를 활용하면 세금을 최소화할 수 있습니다.';
            } else if (totalAmount < 1000000000) {
                advice = '⚠️ 상속·증여 규모가 있습니다. 배우자 공제, 자녀 공제 등을 최대한 활용하는 전략이 필요합니다.';
            } else {
                advice = '🚨 상속·증여 규모가 큽니다. 사전증여, 신탁 활용, 가업승계 등 종합적인 절세 전략이 필수입니다. 전문가 상담을 권장합니다.';
            }
            
            document.getElementById('inheritanceAdvice').textContent = advice;
        }
        // 증여/상속 구분 토글
        function toggleTaxType() {
            const taxType = document.querySelector('input[name="taxType"]:checked').value;
            const inheritanceOnlyFields = document.getElementById('inheritanceOnlyFields');
            const funeralExpenseGroup = document.getElementById('funeralExpenseGroup');
            const donorLabel = document.getElementById('donorLabel');
            const recipientLabel = document.getElementById('recipientLabel');
            
            if (taxType === 'inheritance') {
                inheritanceOnlyFields.style.display = 'block';
                funeralExpenseGroup.style.display = 'block';
                donorLabel.textContent = '피상속인 (망인)';
                recipientLabel.textContent = '상속인';
            } else {
                inheritanceOnlyFields.style.display = 'none';
                funeralExpenseGroup.style.display = 'none';
                donorLabel.textContent = '증여자';
                recipientLabel.textContent = '수증자';
            }
        }

        // 총 재산가액 계산
        function calculateTaxTotal() {
            const propertyValue = unformat(document.getElementById('propertyValue').value || '0');
            const financialValue = unformat(document.getElementById('financialValue').value || '0');
            const otherValue = unformat(document.getElementById('otherValue').value || '0');
            const total = propertyValue + financialValue + otherValue;
            document.getElementById('totalPropertyValue').textContent = formatNumber(total) + '원';
        }

        // 상세 세액 계산 (국세청 플로우 완벽 반영)
        function calculateDetailedTax() {
            const taxType = document.querySelector('input[name="taxType"]:checked').value;
            const relation = document.getElementById('taxRelation').value;
            const propertyValue = unformat(document.getElementById('propertyValue').value || '0');
            const financialValue = unformat(document.getElementById('financialValue').value || '0');
            const otherValue = unformat(document.getElementById('otherValue').value || '0');
            const taxExempt = unformat(document.getElementById('taxExempt').value || '0');
            const debtAmount = unformat(document.getElementById('debtAmount').value || '0');
            const funeralExpense = unformat(document.getElementById('funeralExpense').value || '0');
            const previousGiftAmount = unformat(document.getElementById('previousGiftAmount').value || '0');
            const recipientAge = parseInt(document.getElementById('recipientAge').value || '20');
            
            // ① 총 재산가액
            const step1Total = propertyValue + financialValue + otherValue;
            
            if (step1Total === 0) {
                alert('증여/상속 재산을 입력해주세요.');
                return;
            }
            
            // ② 비과세 및 채무 공제
            let step2Exempt = taxExempt + debtAmount;
            if (taxType === 'inheritance') {
                step2Exempt += Math.min(funeralExpense, 10000000); // 장례비용 최대 1천만원
            }
            
            // ③ 사전증여재산 가산
            const step3PreviousGift = previousGiftAmount;
            
            // ④ 과세가액
            const step4TaxableAmount = step1Total - step2Exempt + step3PreviousGift;
            
            // ⑤ 공제액 계산
            let step5Deduction = 0;
            let deductionDetails = '';
            
            if (taxType === 'gift') {
                // 증여재산공제
                if (relation === '배우자') {
                    step5Deduction = 600000000;
                    deductionDetails = '• 배우자공제: 6억원';
                } else if (relation === '자녀') {
                    step5Deduction = recipientAge < 19 ? 20000000 : 50000000;
                    deductionDetails = `• 직계비속공제: ${formatNumber(step5Deduction)}원 (${recipientAge < 19 ? '미성년' : '성년'})`;
                } else if (relation === '손자녀') {
                    step5Deduction = recipientAge < 19 ? 20000000 : 50000000;
                    deductionDetails = `• 직계비속공제: ${formatNumber(step5Deduction)}원 (${recipientAge < 19 ? '미성년' : '성년'})`;
                } else if (relation === '부모') {
                    step5Deduction = 50000000;
                    deductionDetails = '• 직계존속공제: 5천만원';
                } else if (relation === '기타친족') {
                    step5Deduction = 10000000;
                    deductionDetails = '• 기타친족공제: 1천만원';
                } else {
                    step5Deduction = 0;
                    deductionDetails = '• 공제액: 없음';
                }
            } else {
                // 상속공제
                const heirCount = parseInt(document.getElementById('heirCount').value || '1');
                const hasDisability = document.getElementById('hasDisability').checked;
                const isElderly = document.getElementById('isElderly').checked;
                const spouseInheritance = unformat(document.getElementById('spouseInheritance').value || '0');
                
                // 기초공제
                const basicDeduction = 200000000;
                deductionDetails += `• 기초공제: 2억원\n`;
                
                // 인적공제
                let personalDeduction = 0;
                personalDeduction += heirCount * 50000000; // 자녀공제
                deductionDetails += `• 자녀공제: ${formatNumber(heirCount * 50000000)}원 (${heirCount}명 × 5천만원)\n`;
                
                if (recipientAge < 19) {
                    const minorDeduction = (19 - recipientAge) * 10000000;
                    personalDeduction += minorDeduction;
                    deductionDetails += `• 미성년자공제: ${formatNumber(minorDeduction)}원\n`;
                }
                
                if (isElderly) {
                    personalDeduction += 50000000;
                    deductionDetails += `• 연로자공제: 5천만원\n`;
                }
                
                if (hasDisability) {
                    const disabilityDeduction = (85 - recipientAge) * 10000000;
                    personalDeduction += disabilityDeduction;
                    deductionDetails += `• 장애인공제: ${formatNumber(disabilityDeduction)}원\n`;
                }
                
                // 일괄공제 vs 기초+인적공제
                const lumpSumDeduction = 500000000;
                const standardDeduction = basicDeduction + personalDeduction;
                
                if (lumpSumDeduction > standardDeduction) {
                    step5Deduction = lumpSumDeduction;
                    deductionDetails = `• 일괄공제: 5억원 (기초+인적공제 ${formatNumber(standardDeduction)}원 대신 선택)\n`;
                } else {
                    step5Deduction = standardDeduction;
                }
                
                // 배우자공제
                if (spouseInheritance > 0) {
                    const spouseDeduction = Math.max(500000000, Math.min(3000000000, spouseInheritance * 0.3 + 500000000));
                    step5Deduction += spouseDeduction;
                    deductionDetails += `• 배우자공제: ${formatNumber(spouseDeduction)}원\n`;
                }
                
                // 금융재산공제 (간략화)
                if (financialValue >= 20000000) {
                    const finDeduction = Math.min(200000000, financialValue - 20000000);
                    step5Deduction += finDeduction;
                    deductionDetails += `• 금융재산공제: ${formatNumber(finDeduction)}원\n`;
                }
            }
            
            // ⑥ 과세표준
            const step6TaxBase = Math.max(0, step4TaxableAmount - step5Deduction);
            
            // ⑦ 세율 적용
            let step7Tax = 0;
            let taxRateInfo = '';
            if (step6TaxBase <= 100000000) {
                step7Tax = step6TaxBase * 0.1;
                taxRateInfo = '10% (누진공제 없음)';
            } else if (step6TaxBase <= 500000000) {
                step7Tax = step6TaxBase * 0.2 - 10000000;
                taxRateInfo = '20% (누진공제 1천만원)';
            } else if (step6TaxBase <= 1000000000) {
                step7Tax = step6TaxBase * 0.3 - 60000000;
                taxRateInfo = '30% (누진공제 6천만원)';
            } else if (step6TaxBase <= 3000000000) {
                step7Tax = step6TaxBase * 0.4 - 160000000;
                taxRateInfo = '40% (누진공제 1.6억원)';
            } else {
                step7Tax = step6TaxBase * 0.5 - 460000000;
                taxRateInfo = '50% (누진공제 4.6억원)';
            }
            
            // ⑧ 세대생략 할증
            let step8Surcharge = 0;
            if (relation === '손자녀') {
                if (recipientAge < 19 && step1Total > 2000000000) {
                    step8Surcharge = step7Tax * 0.4;
                } else {
                    step8Surcharge = step7Tax * 0.3;
                }
            }
            
            const step8Total = step7Tax + step8Surcharge;
            
            // ⑨ 세액공제 (신고세액공제 10%)
            const step9Credit = step8Total * 0.1;
            
            // ⑩ 최종 납부세액
            const step10FinalTax = step8Total - step9Credit;
            
            // 결과 표시
            document.getElementById('taxResultPanel').style.display = 'block';
            document.getElementById('result1TotalProperty').textContent = formatNumber(step1Total) + '원';
            document.getElementById('result2Exempt').textContent = formatNumber(step2Exempt) + '원';
            document.getElementById('result3PreviousGift').textContent = formatNumber(step3PreviousGift) + '원';
            document.getElementById('result4TaxableAmount').textContent = formatNumber(step4TaxableAmount) + '원';
            document.getElementById('result5Deduction').textContent = formatNumber(step5Deduction) + '원';
            document.getElementById('result6TaxBase').textContent = formatNumber(step6TaxBase) + '원';
            document.getElementById('result7TaxRate').textContent = taxRateInfo;
            document.getElementById('result8Surcharge').textContent = step8Surcharge > 0 ? formatNumber(step8Surcharge) + '원' : '해당없음';
            document.getElementById('result9Credit').textContent = formatNumber(step9Credit) + '원';
            document.getElementById('result10FinalTax').textContent = formatNumber(step10FinalTax) + '원';
            
            // 공제 상세내역 표시
            if (deductionDetails) {
                document.getElementById('deductionDetail').style.display = 'block';
                document.getElementById('deductionDetailContent').innerHTML = deductionDetails.replace(/\n/g, '<br>');
            }
            
            // 시나리오 비교 (증여만)
            if (taxType === 'gift') {
                calculateScenarios(step1Total, relation, recipientAge, previousGiftAmount);
            } else {
                document.getElementById('scenarioComparison').style.display = 'none';
            }
            
            // 추천 전략
            generateTaxStrategy(step1Total, step10FinalTax, relation, recipientAge, taxType);
        }
        function calculateOverallAnalysis() {
            const name = document.getElementById('name').value || '고객명';
            
            let scores = [];
            let summaryText = `${name}님의 종합 재무 건강도 평가\n\n`;
            
            // 재무현황 점수
            calculateFinancialAnalysis();
            const totalAssets = unformat(document.getElementById('totalAssets').textContent);
            const totalDebt = unformat(document.getElementById('totalDebt').textContent);
            const debtRatio = totalAssets > 0 ? (totalDebt / totalAssets * 100) : 0;
            let financialScore = 0;
            if (debtRatio < 30) financialScore = 10;
            else if (debtRatio < 50) financialScore = 7;
            else if (debtRatio < 70) financialScore = 5;
            else financialScore = 3;
            scores.push(financialScore);
            summaryText += `1. 재무 건강도: ${financialScore}/10점\n`;
            
            // 은퇴 준비 점수
            const retirementScore = parseInt(document.getElementById('retirementScore').textContent || '0');
            scores.push(retirementScore);
            summaryText += `2. 은퇴 준비도: ${retirementScore}/10점\n`;
            
            // 보험 점수
            const insurancePremium = unformat(document.getElementById('totalInsurancePremium').textContent);
            const income = unformat(document.getElementById('income').value || '0');
            const premiumRatio = income > 0 ? (insurancePremium / income * 100) : 0;
            let insuranceScore = 0;
            if (premiumRatio > 0 && premiumRatio < 10) insuranceScore = 10;
            else if (premiumRatio < 15) insuranceScore = 7;
            else if (premiumRatio === 0) insuranceScore = 5;
            else insuranceScore = 3;
            scores.push(insuranceScore);
            summaryText += `3. 보험 적정성: ${insuranceScore}/10점\n`;
            
            const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
            
            document.getElementById('overallScore').textContent = avgScore + '점';
            
            let overallAdvice = '';
            if (avgScore >= 8) {
                overallAdvice = `✅ 훌륭합니다! ${name}님의 전반적인 재무 상태가 매우 양호합니다. 현재의 계획을 유지하시면 됩니다.`;
            } else if (avgScore >= 6) {
                overallAdvice = `⚠️ ${name}님의 재무 상태는 양호하나 일부 개선이 필요합니다. 취약 부분을 보완하면 더욱 안정적인 재무 구조를 만들 수 있습니다.`;
            } else {
                overallAdvice = `🚨 ${name}님의 재무 상태에 주의가 필요합니다. 체계적인 재무 설계와 전략 수립이 시급합니다.`;
            }
            
            document.getElementById('comprehensiveAnalysis').innerHTML = `
                <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary);">📋 종합 평가</h3>
                <p style="line-height: 1.8; color: var(--text); white-space: pre-wrap;">${summaryText}</p>
                <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid var(--primary);">
                    <p style="line-height: 1.8; color: var(--text);">${overallAdvice}</p>
                </div>
            `;
        }

        // 동적 요소 생성 함수들
        function addRealEstate() {
            const container = document.getElementById('realEstateContainer');
            const html = `
                <div class="dynamic-container" id="realEstate_${realEstateCount}">
                    <button class="btn-remove" onclick="removeElement('realEstate_${realEstateCount}')">×</button>
                    <div class="two-col">
                        <div class="input-group">
                            <label>부동산 종류</label>
                            <select id="realEstateType_${realEstateCount}">
                                <option value="아파트">아파트</option>
                                <option value="단독주택">단독주택</option>
                                <option value="빌라">빌라/연립</option>
                                <option value="상가">상가</option>
                                <option value="토지">토지</option>
                                <option value="오피스텔">오피스텔</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>평가액</label>
                            <div class="input-field">
                                <input type="text" id="realEstateValue_${realEstateCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateFinancialAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>소재지</label>
                        <input type="text" id="realEstateLocation_${realEstateCount}" placeholder="예: 서울시 강남구">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            realEstateCount++;
        }

        function addFinancialAsset() {
            const container = document.getElementById('financialAssetsContainer');
            const html = `
                <div class="dynamic-container" id="financialAsset_${financialAssetCount}">
                    <button class="btn-remove" onclick="removeElement('financialAsset_${financialAssetCount}')">×</button>
                    <div class="input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="retirementAsset_${financialAssetCount}" onchange="calculateRetirementAnalysis()" style="width: auto; height: auto;">
                            <span>💰 이 자산을 은퇴자금으로 사용 예정</span>
                        </label>
                    </div>
                    <div class="two-col">
                        <div class="input-group">
                            <label>자산 종류</label>
                            <select id="assetType_${financialAssetCount}">
                                <option value="예금">예금</option>
                                <option value="적금">적금</option>
                                <option value="주식">주식</option>
                                <option value="펀드">펀드</option>
                                <option value="채권">채권</option>
                                <option value="ETF">ETF</option>
                                <option value="ISA">ISA</option>
                                <option value="IRP">IRP</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>잔액</label>
                            <div class="input-field">
                                <input type="text" id="assetBalance_${financialAssetCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateFinancialAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                    </div>
                    <div class="two-col">
                        <div class="input-group">
                            <label>금융기관</label>
                            <input type="text" id="assetInstitution_${financialAssetCount}" placeholder="예: 신한은행">
                        </div>
                        <div class="input-group">
                            <label>예상 수익률 (연)</label>
                            <div class="input-field">
                                <input type="number" id="assetRate_${financialAssetCount}" step="0.1" value="3.0" onchange="calculateRetirementAnalysis()">
                                <span>%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            financialAssetCount++;
        }

        function addDebt() {
            const container = document.getElementById('debtContainer');
            const html = `
                <div class="dynamic-container" id="debt_${debtCount}">
                    <button class="btn-remove" onclick="removeElement('debt_${debtCount}')">×</button>
                    <div class="two-col">
                        <div class="input-group">
                            <label>대출 종류</label>
                            <select id="debtType_${debtCount}">
                                <option value="주택담보대출">주택담보대출</option>
                                <option value="신용대출">신용대출</option>
                                <option value="자동차대출">자동차대출</option>
                                <option value="학자금대출">학자금대출</option>
                                <option value="전세자금대출">전세자금대출</option>
                                <option value="사업자대출">사업자대출</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>잔액</label>
                            <div class="input-field">
                                <input type="text" id="debtBalance_${debtCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateFinancialAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                    </div>
                    <div class="two-col">
                        <div class="input-group">
                            <label>금융기관</label>
                            <input type="text" id="debtInstitution_${debtCount}" placeholder="예: 국민은행">
                        </div>
                        <div class="input-group">
                            <label>이자율 (연)</label>
                            <div class="input-field">
                                <input type="number" id="debtRate_${debtCount}" step="0.1" value="4.5">
                                <span>%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            debtCount++;
        }

        function addMonthlyIncome() {
            const container = document.getElementById('monthlyIncomeContainer');
            const html = `
                <div class="dynamic-container" id="monthlyIncome_${monthlyIncomeCount}">
                    <button class="btn-remove" onclick="removeElement('monthlyIncome_${monthlyIncomeCount}')">×</button>
                    <div class="two-col">
                        <div class="input-group">
                            <label>항목</label>
                            <select id="incomeCategory_${monthlyIncomeCount}" onchange="toggleCustomInput('incomeCategory_${monthlyIncomeCount}', 'customIncomeCategory_${monthlyIncomeCount}')">
                                ${incomeCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                            <input type="text" id="customIncomeCategory_${monthlyIncomeCount}" placeholder="항목 입력" style="display: none; margin-top: 0.5rem;">
                        </div>
                        <div class="input-group">
                            <label>금액</label>
                            <div class="input-field">
                                <input type="text" id="incomeAmount_${monthlyIncomeCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateFinancialAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            monthlyIncomeCount++;
        }

        function addMonthlyExpense() {
            const container = document.getElementById('monthlyExpenseContainer');
            const html = `
                <div class="dynamic-container" id="monthlyExpense_${monthlyExpenseCount}">
                    <button class="btn-remove" onclick="removeElement('monthlyExpense_${monthlyExpenseCount}')">×</button>
                    <div class="two-col">
                        <div class="input-group">
                            <label>항목</label>
                            <select id="expenseCategory_${monthlyExpenseCount}" onchange="toggleCustomInput('expenseCategory_${monthlyExpenseCount}', 'customExpenseCategory_${monthlyExpenseCount}')">
                                ${expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                            <input type="text" id="customExpenseCategory_${monthlyExpenseCount}" placeholder="항목 입력" style="display: none; margin-top: 0.5rem;">
                        </div>
                        <div class="input-group">
                            <label>금액</label>
                            <div class="input-field">
                                <input type="text" id="expenseAmount_${monthlyExpenseCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateFinancialAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            monthlyExpenseCount++;
        }

        function addInsurance() {
            const container = document.getElementById('insuranceContainer');
            const html = `
                <div class="dynamic-container" id="insurance_${insuranceCount}">
                    <button class="btn-remove" onclick="removeElement('insurance_${insuranceCount}')">×</button>
                    <div class="two-col">
                        <div class="input-group">
                            <label>보험 종류</label>
                            <select id="insuranceType_${insuranceCount}" onchange="toggleCustomInput('insuranceType_${insuranceCount}', 'customInsuranceType_${insuranceCount}')">
                                ${insuranceTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                            <input type="text" id="customInsuranceType_${insuranceCount}" placeholder="보험 종류 입력" style="display: none; margin-top: 0.5rem;">
                        </div>
                        <div class="input-group">
                            <label>보험사</label>
                            <input type="text" id="insuranceCompany_${insuranceCount}" placeholder="예: 삼성생명">
                        </div>
                    </div>
                    <div class="two-col">
                        <div class="input-group">
                            <label>보험료 (월)</label>
                            <div class="input-field">
                                <input type="text" id="insurancePremium_${insuranceCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateInsuranceAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>보장 금액</label>
                            <div class="input-field">
                                <input type="text" id="insuranceCoverage_${insuranceCount}" inputmode="numeric" oninput="formatInputNumber(this);">
                                <span>원</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            insuranceCount++;
        }

        function addPension() {
            const container = document.getElementById('pensionContainer');
            const html = `
                <div class="dynamic-container" id="pension_${pensionCount}">
                    <button class="btn-remove" onclick="removeElement('pension_${pensionCount}')">×</button>
                    <div class="input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="retirementPension_${pensionCount}" onchange="calculateRetirementAnalysis()" style="width: auto; height: auto;">
                            <span>💰 이 연금을 은퇴자금으로 사용 예정</span>
                        </label>
                    </div>
                    <div class="two-col">
                        <div class="input-group">
                            <label>연금 이름</label>
                            <input type="text" id="pensionName_${pensionCount}" placeholder="예: 연금저축보험">
                        </div>
                        <div class="input-group">
                            <label>보험사</label>
                            <input type="text" id="pensionCompany_${pensionCount}" placeholder="예: 교보생명">
                        </div>
                    </div>
                    <div class="two-col">
                        <div class="input-group">
                            <label>월 납입액</label>
                            <div class="input-field">
                                <input type="text" id="pensionPremium_${pensionCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateInsuranceAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>예상 월 수령액</label>
                            <div class="input-field">
                                <input type="text" id="pensionReturn_${pensionCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateInsuranceAnalysis(); calculateRetirementAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            pensionCount++;
        }

        function addGoal() {
            const container = document.getElementById('goalContainer');
            const html = `
                <div class="dynamic-container" id="goal_${goalCount}">
                    <button class="btn-remove" onclick="removeElement('goal_${goalCount}')">×</button>
                    <div class="two-col">
                        <div class="input-group">
                            <label>목표명</label>
                            <input type="text" id="goalName_${goalCount}" placeholder="예: 주택구입">
                        </div>
                        <div class="input-group">
                            <label>목표 기간</label>
                            <input type="month" id="goalDate_${goalCount}">
                        </div>
                    </div>
                    <div class="two-col">
                        <div class="input-group">
                            <label>목표 금액</label>
                            <div class="input-field">
                                <input type="text" id="goalAmount_${goalCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateGoalAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>현재 준비액</label>
                            <div class="input-field">
                                <input type="text" id="currentSavings_${goalCount}" inputmode="numeric" oninput="formatInputNumber(this); calculateGoalAnalysis();">
                                <span>원</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            goalCount++;
        }

        function removeElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
                updateAnalysis();
            }
        }

        function toggleCustomInput(selectId, customInputId) {
            const select = document.getElementById(selectId);
            const customInput = document.getElementById(customInputId);
            if (select && customInput) {
                customInput.style.display = select.value === '직접입력' ? 'block' : 'none';
            }
        }

        function formatInputNumber(input) {
            let value = input.value.replace(/,/g, '');
            if (!isNaN(value) && value !== '') {
                input.value = formatNumber(value);
            }
        }

        function generateInvestmentQuestions() {
            const container = document.getElementById('investmentQuestionsContainer');
            let html = '';
            
            investmentQuestions.forEach((question, qIndex) => {
                html += `
                    <div class="question-box">
                        <h4>Q${qIndex + 1}. ${question.q}</h4>
                        <div class="radio-group">
                `;
                
                question.options.forEach((option, oIndex) => {
                    html += `
                        <label>
                            <input type="radio" name="q${qIndex}" value="${option.score}" onchange="calculateInvestmentAnalysis()">
                            ${option.text}
                        </label>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        // 상속/증여세 계산 함수
        function calculateTaxAnalysis() {
            const taxType = document.querySelector('input[name="taxType"]:checked').value;
            const relation = document.getElementById('taxRelation').value;
            const propertyValue = unformat(document.getElementById('propertyValue').value || '0');
            const financialValue = unformat(document.getElementById('financialValue').value || '0');
            const otherValue = unformat(document.getElementById('otherValue').value || '0');
            const previousGiftAmount = unformat(document.getElementById('previousGiftAmount').value || '0');
            const recipientAge = parseInt(document.getElementById('recipientAge').value || '20');
            
            const totalProperty = propertyValue + financialValue + otherValue;
            document.getElementById('totalPropertyValue').textContent = formatNumber(totalProperty) + '원';
            
            if (totalProperty === 0) {
                alert('증여/상속 재산을 입력해주세요.');
                return;
            }
            
            // 관계별 공제액 (10년 합산)
            let deduction = 0;
            if (relation === '배우자') {
                deduction = 600000000; // 6억
            } else if (relation === '자녀') {
                deduction = recipientAge < 19 ? 20000000 : 50000000; // 미성년 2천만원, 성년 5천만원
            } else if (relation === '손자녀') {
                deduction = recipientAge < 19 ? 20000000 : 50000000;
            } else if (relation === '부모') {
                deduction = 50000000;
            } else if (relation === '기타친족') {
                deduction = 10000000;
            } else {
                deduction = 0;
            }
            
            // 과세표준 계산
            const taxBase = Math.max(0, totalProperty + previousGiftAmount - deduction);
            
            // 세율 적용 (누진세율)
            let taxAmount = 0;
            if (taxBase <= 100000000) {
                taxAmount = taxBase * 0.1;
            } else if (taxBase <= 500000000) {
                taxAmount = taxBase * 0.2 - 10000000;
            } else if (taxBase <= 1000000000) {
                taxAmount = taxBase * 0.3 - 60000000;
            } else if (taxBase <= 3000000000) {
                taxAmount = taxBase * 0.4 - 160000000;
            } else {
                taxAmount = taxBase * 0.5 - 460000000;
            }
            
            // 세대생략 할증 (손자녀)
            if (relation === '손자녀') {
                if (recipientAge < 19 && totalProperty > 2000000000) {
                    taxAmount *= 1.4; // 40% 할증
                } else {
                    taxAmount *= 1.3; // 30% 할증
                }
            }
            
            // 신고세액공제 10%
            taxAmount = taxAmount * 0.9;
            
            // 결과 표시
            document.getElementById('taxResultPanel').style.display = 'block';
            document.getElementById('resultTotalProperty').textContent = formatNumber(totalProperty) + '원';
            document.getElementById('resultDeduction').textContent = formatNumber(deduction) + '원';
            document.getElementById('resultPreviousGift').textContent = formatNumber(previousGiftAmount) + '원';
            document.getElementById('resultTaxBase').textContent = formatNumber(taxBase) + '원';
            document.getElementById('resultTaxAmount').textContent = formatNumber(taxAmount) + '원';
            
            // 시나리오 비교
            calculateScenarios(totalProperty, relation, recipientAge, previousGiftAmount);
            
            // 추천 전략
            generateTaxStrategy(totalProperty, taxAmount, relation, recipientAge);
        }
        
        function calculateScenarios(totalProperty, relation, recipientAge, previousGift) {
            // 시나리오 1: 직접 증여 (현재)
            const scenario1 = calculateSingleTax(totalProperty, relation, recipientAge, previousGift);
            
            // 시나리오 2: 배우자 경유
            let scenario2 = 0;
            if (relation !== '배우자') {
                const toSpouse = calculateSingleTax(totalProperty, '배우자', 40, 0);
                const fromSpouse = calculateSingleTax(totalProperty, relation, recipientAge, 0);
                scenario2 = toSpouse + fromSpouse;
            } else {
                scenario2 = scenario1;
            }
            
            // 시나리오 3: 10년 분할
            const perYear = totalProperty / 10;
            const scenario3 = calculateSingleTax(perYear, relation, recipientAge, 0) * 10;
            
            document.getElementById('scenario1Amount').textContent = formatNumber(scenario1) + '원';
            document.getElementById('scenario2Amount').textContent = formatNumber(scenario2) + '원';
            document.getElementById('scenario3Amount').textContent = formatNumber(scenario3) + '원';
            
            const savings2 = scenario1 - scenario2;
            const savings3 = scenario1 - scenario3;
            
            if (relation !== '배우자') {
                document.getElementById('scenario2Savings').textContent = savings2 > 0 ? `절세 ${formatNumber(savings2)}원` : '동일';
            } else {
                document.getElementById('scenario2Savings').textContent = '해당없음';
            }
            
            document.getElementById('scenario3Savings').textContent = savings3 > 0 ? `절세 ${formatNumber(savings3)}원` : '동일';
            
            document.getElementById('scenarioComparison').style.display = 'block';
        }
        
        function calculateSingleTax(amount, relation, age, previousGift) {
            let deduction = 0;
            if (relation === '배우자') deduction = 600000000;
            else if (relation === '자녀' || relation === '손자녀') deduction = age < 19 ? 20000000 : 50000000;
            else if (relation === '부모') deduction = 50000000;
            else if (relation === '기타친족') deduction = 10000000;
            
            const taxBase = Math.max(0, amount + previousGift - deduction);
            let tax = 0;
            
            if (taxBase <= 100000000) tax = taxBase * 0.1;
            else if (taxBase <= 500000000) tax = taxBase * 0.2 - 10000000;
            else if (taxBase <= 1000000000) tax = taxBase * 0.3 - 60000000;
            else if (taxBase <= 3000000000) tax = taxBase * 0.4 - 160000000;
            else tax = taxBase * 0.5 - 460000000;
            
            if (relation === '손자녀') {
                tax *= (age < 19 && amount > 2000000000) ? 1.4 : 1.3;
            }
            
            return tax * 0.9; // 신고세액공제
        }
        
        function generateTaxStrategy(totalProperty, taxAmount, relation, age) {
            const content = document.getElementById('taxStrategyContent');
            let strategy = '';
            
            if (totalProperty < 100000000) {
                strategy = `
                    ✅ <strong>소액 증여 전략</strong><br>
                    • 현재 재산 규모는 세금 부담이 크지 않습니다<br>
                    • 기본 공제만으로도 충분히 절세 가능<br>
                    • 10년 단위로 분할하면 세금 0원도 가능
                `;
            } else if (totalProperty < 500000000) {
                strategy = `
                    ⚠️ <strong>중간 규모 증여 전략</strong><br>
                    • 10년 분할 증여로 ${formatNumber(taxAmount * 0.5)}원 이상 절세 가능<br>
                    • ${age < 19 ? '자녀가 성년이 된 후' : '지금 바로'} 증여 시작 권장<br>
                    • 배우자를 경유하면 추가 절세 가능
                `;
            } else {
                strategy = `
                    🚨 <strong>고액 증여 전략 (전문가 상담 필수)</strong><br>
                    • <strong>10년 분할 증여</strong>: 매년 ${formatNumber(totalProperty / 10)}원씩<br>
                    • <strong>배우자 경유 증여</strong>: 1단계 절세 효과<br>
                    • <strong>신탁 활용</strong>: 추가 절세 및 증여 취소 방지<br>
                    • <strong>가업승계 특례</strong>: 해당 시 최대 100억 한도<br><br>
                    ⚡ 예상 절세액: 최대 ${formatNumber(taxAmount * 0.7)}원
                `;
            }
            
            content.innerHTML = strategy;
            
            // 최적 실행 방안
            if (totalProperty >= 100000000) {
                const optimalPlan = document.getElementById('optimalPlan');
                const optimalContent = document.getElementById('optimalPlanContent');
                optimalPlan.style.display = 'block';
                
                const yearlyAmount = totalProperty / 10;
                optimalContent.innerHTML = `
                    <strong>📅 10개년 증여 플랜</strong><br><br>
                    <strong>1단계 (1-3년차)</strong><br>
                    • 매년 ${formatNumber(yearlyAmount)}원씩 증여<br>
                    • 예상 세금: 연 ${formatNumber(calculateSingleTax(yearlyAmount, relation, age, 0))}원<br><br>
                    
                    <strong>2단계 (4-7년차)</strong><br>
                    • 동일 금액 지속 증여<br>
                    • 10년 합산 과세로 누적 관리<br><br>
                    
                    <strong>3단계 (8-10년차)</strong><br>
                    • 잔여 금액 완료<br>
                    • 총 절세액: <strong style="color: #dc2626;">${formatNumber(taxAmount - calculateSingleTax(yearlyAmount, relation, age, 0) * 10)}원</strong>
                `;
            }
        }

        // PDF 생성 함수 (스타일 1: 클래식 프로페셔널)
function generatePDF() {
    // 인쇄 전 확인
    if (!document.getElementById('name').value) {
        alert('고객명을 입력해주세요.');
        return;
    }
    
    // 현재 상태 저장
    const originalStep = currentStep;
    const stepStates = {};
    
    // 모든 step과 analysis를 강제로 보이게 설정
    for (let i = 1; i <= 8; i++) {
        const stepEl = document.getElementById(`step${i}`);
        const analysisEl = document.getElementById(`analysis${i}`);
        
        if (stepEl) {
            stepStates[`step${i}`] = stepEl.style.display;
            stepEl.style.display = 'block';
        }
        if (analysisEl) {
            stepStates[`analysis${i}`] = analysisEl.style.display;
            analysisEl.style.display = 'block';
        }
    }
    
    // 인쇄 실행
    window.print();
    
    // 인쇄 완료 후 원래 상태로 복원 (약간의 지연 후)
    setTimeout(() => {
        for (let i = 1; i <= 8; i++) {
            const stepEl = document.getElementById(`step${i}`);
            const analysisEl = document.getElementById(`analysis${i}`);
            
            if (stepEl && stepStates[`step${i}`] !== undefined) {
                stepEl.style.display = i === originalStep ? 'block' : 'none';
            }
            if (analysisEl && stepStates[`analysis${i}`] !== undefined) {
                analysisEl.style.display = i === originalStep ? 'block' : 'none';
            }
        }
    }, 1000);
}

// 인쇄용 CSS 동적 추가
function addPrintStyles() {
    const printCSS = `
        <style id="printStyles">
        @media print {
            /* 페이지 설정 */
            @page {
                size: A4;
                margin: 15mm;
            }
            
            /* 불필요한 요소 숨기기 */
            header, .toolbar, .step-indicator, 
            .btn-add, .btn-remove, .btn, 
            footer, .progress-bar-container,
            .save-status {
                display: none !important;
            }
            
            /* 메인 그리드 인쇄용 레이아웃 */
            .main-grid {
                display: block !important;
                grid-template-columns: none !important;
            }
            
            /* 입력 섹션과 분석 섹션 모두 표시 */
            .input-section, .analysis-section {
                display: block !important;
                width: 100% !important;
            }
            
            /* 분석 섹션은 입력 섹션 뒤에 배치 */
            .analysis-section {
                margin-top: 30px !important;
            }
            
            /* 각 분석 카드도 페이지 브레이크 고려 */
            .analysis-section .card {
                page-break-inside: avoid;
                margin-bottom: 20px !important;
            }
            
            /* 각 Step 카드 스타일링 */
            .card {
                page-break-inside: avoid;
                margin-bottom: 20px !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
            }
            
            /* Step 제목 스타일링 */
            .card h2 {
                background: #f8f9fa !important;
                padding: 10px 15px !important;
                margin: -24px -24px 20px -24px !important;
                color: #2C3E50 !important;
                border-bottom: 2px solid #e9ecef !important;
            }
            
            /* 동적 컨테이너 스타일링 */
            .dynamic-container {
                border: 1px solid #e9ecef !important;
                background: #fafbfc !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid;
            }
            
            /* 입력 필드 스타일링 */
            input, select, textarea {
                border: 1px solid #ddd !important;
                background: white !important;
                color: #333 !important;
                font-size: 12px !important;
            }
            
            /* 2열 레이아웃 유지 */
            .two-col {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }
            
            /* 은퇴 레이아웃 */
            .retirement-layout {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 15px !important;
            }
            
            /* 요약 정보 스타일링 */
            .summary-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .result-grid {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
                gap: 10px !important;
            }
            
            .result-box, .profile-summary {
                background: #f8f9fa !important;
                border: 1px solid #dee2e6 !important;
                color: #333 !important;
            }
            
            /* 페이지 브레이크 */
            #step2, #step4, #step6, #step8 {
                page-break-before: always;
            }
            
            /* 투자성향 질문 스타일링 */
            .question-box {
                border: 1px solid #e9ecef !important;
                background: white !important;
                margin-bottom: 10px !important;
                page-break-inside: avoid;
            }
            
            .radio-group label {
                border: 1px solid #e9ecef !important;
                background: #f8f9fa !important;
                margin-bottom: 3px !important;
                padding: 8px !important;
                font-size: 11px !important;
            }
            
            /* 색상 조정 */
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* 폰트 크기 조정 */
            body {
                font-size: 12px !important;
                line-height: 1.4 !important;
            }
            
            h2 {
                font-size: 16px !important;
            }
            
            h3 {
                font-size: 14px !important;
            }
            
            label {
                font-size: 11px !important;
            }
        }
        </style>
    `;
    
    // 기존 인쇄 스타일 제거 후 새로 추가
    const existingStyle = document.getElementById('printStyles');
    if (existingStyle) {
        existingStyle.remove();
    }
    
    document.head.insertAdjacentHTML('beforeend', printCSS);
}

// 페이지 로드 시 인쇄 스타일 추가
document.addEventListener('DOMContentLoaded', addPrintStyles);

        // AI 솔루션 생성
        function generateAISolution() {
            const name = document.getElementById('name').value || '고객님';
            const age = calculateAge(document.getElementById('birthDate').value);
            const totalAssets = unformat(document.getElementById('totalAssets').textContent);
            const netAssets = unformat(document.getElementById('netAssets').textContent);
            const monthlySurplus = unformat(document.getElementById('monthlySurplus').textContent);
            const retirementScore = document.getElementById('retirementScore').textContent;
            
            let summary = `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${name}님의 재무 현황 Summary
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 기본 정보
- 나이: 만 ${age}세
- 총 자산: ${formatNumber(totalAssets)}원
- 순자산: ${formatNumber(netAssets)}원
- 월 잉여금: ${formatNumber(monthlySurplus)}원

📈 재무 건강도 평가
`;
            
            if (netAssets > 0 && monthlySurplus > 0) {
                summary += `✅ 재무 상태 양호 - 순자산과 월 잉여금 모두 플러스\n`;
            } else if (netAssets > 0) {
                summary += `⚠️ 주의 필요 - 순자산은 양호하나 월 잉여금 부족\n`;
            } else {
                summary += `🚨 긴급 개선 필요 - 부채가 자산을 초과\n`;
            }
            
            summary += `\n🎯 은퇴 준비도: ${retirementScore}\n`;
            
            if (parseInt(retirementScore) >= 8) {
                summary += `✅ 은퇴 준비 우수 - 현재 계획 유지\n`;
            } else if (parseInt(retirementScore) >= 5) {
                summary += `⚠️ 은퇴 준비 보통 - 추가 저축 필요\n`;
            } else {
                summary += `🚨 은퇴 준비 부족 - 적극적 대응 필요\n`;
            }
            
            summary += `\n💡 핵심 제안사항
1. ${monthlySurplus > 0 ? '월 잉여금을 활용한 추가 저축 실행' : '지출 구조조정을 통한 잉여금 확보'}
2. ${parseInt(retirementScore) < 8 ? '은퇴 준비 자산 확대 필요' : '현재 은퇴 계획 유지'}
3. 정기적인 재무 점검으로 목표 달성 모니터링

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;
            
            document.getElementById('aiSolutionResult').style.display = 'block';
            document.getElementById('aiSolutionText').textContent = summary;
        }

function collectFormData(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return {};
    
    const data = {};
    const inputs = container.querySelectorAll('input, select, textarea');
    const processedRadios = new Set();
    
    inputs.forEach(input => {
        if (input.id || input.name) {
            if (input.type === 'checkbox') {
                data[input.id] = input.checked;
            } else if (input.type === 'radio') {
                if (!processedRadios.has(input.name)) {
                    const checked = container.querySelector(`input[name="${input.name}"]:checked`);
                    if (checked) {
                        data[input.name] = checked.value;
                    }
                    processedRadios.add(input.name);
                }
            } else if (input.id) {
                data[input.id] = input.value;
            }
        }
    });
    
    return data;
}

function saveData() {
    const allData = {
        timestamp: new Date().toISOString(),
        step1: {
            meetingDate: document.getElementById('meetingDate').value,
            name: document.getElementById('name').value,
            phone1: document.getElementById('phone1').value,
            phone2: document.getElementById('phone2').value,
            gender: document.getElementById('gender').value,
            birthDate: document.getElementById('birthDate').value,
            income: document.getElementById('income').value,
            companyName: document.getElementById('companyName').value,
            occupation: document.getElementById('occupation').value,
            customOccupation: document.getElementById('customOccupation').value,
            addressType: document.getElementById('addressType').value,
            address: document.getElementById('address').value,
            maritalStatus: document.getElementById('maritalStatus').value,
            childrenCount: document.getElementById('childrenCount').value,
            spouseBirthDate: document.getElementById('spouseBirthDate').value,
            spouseOccupation: document.getElementById('spouseOccupation').value,
            spouseCustomOccupation: document.getElementById('spouseCustomOccupation').value,
            spouseIncome: document.getElementById('spouseIncome').value,
            spouseCompanyName: document.getElementById('spouseCompanyName').value,
            futurePlan: document.getElementById('futurePlan').value,
            mainInterest: document.getElementById('mainInterest').value
        },
        step2: {
            realEstate: [],
            financialAssets: [],
            debts: [],
            monthlyIncome: [],
            monthlyExpense: []
        },
        step3: {
            insurance: [],
            pension: []
        },
        step4: {
            retirementAge: document.getElementById('retirementAge').value,
            lifeExpectancy: document.getElementById('lifeExpectancy').value,
            retirementMonthlyExpense: document.getElementById('retirementMonthlyExpense').value,
            inflationRate: document.getElementById('inflationRate').value,
            nationalPension: document.getElementById('nationalPension').value,
            spouseNationalPension: document.getElementById('spouseNationalPension').value
        },
        step5: {
            goals: []
        },
        step6: collectFormData('investmentQuestionsContainer'),
        step7: {
            taxType: document.querySelector('input[name="taxType"]:checked')?.value || 'gift',
            donor: document.getElementById('donor').value,
            recipient: document.getElementById('recipient').value,
            taxRelation: document.getElementById('taxRelation').value,
            propertyValue: document.getElementById('propertyValue').value,
            financialValue: document.getElementById('financialValue').value,
            otherValue: document.getElementById('otherValue').value,
            taxExempt: document.getElementById('taxExempt').value,
            debtAmount: document.getElementById('debtAmount').value,
            funeralExpense: document.getElementById('funeralExpense').value,
            previousGiftAmount: document.getElementById('previousGiftAmount').value,
            previousGiftYear: document.getElementById('previousGiftYear').value,
            recipientAge: document.getElementById('recipientAge').value,
            heirCount: document.getElementById('heirCount').value,
            hasDisability: document.getElementById('hasDisability').checked,
            isElderly: document.getElementById('isElderly').checked,
            spouseInheritance: document.getElementById('spouseInheritance').value
        },
        step8: {
            finalSummary: document.getElementById('finalSummary').value
        },
        counts: {
            realEstateCount,
            financialAssetCount,
            debtCount,
            monthlyIncomeCount,
            monthlyExpenseCount,
            insuranceCount,
            pensionCount,
            goalCount
        }
    };
    
    // Step2 동적 데이터 저장
    for (let i = 0; i < realEstateCount; i++) {
        const container = document.getElementById(`realEstate_${i}`);
        if (container) {
            allData.step2.realEstate.push({
                type: document.getElementById(`realEstateType_${i}`)?.value,
                value: document.getElementById(`realEstateValue_${i}`)?.value,
                location: document.getElementById(`realEstateLocation_${i}`)?.value
            });
        }
    }
    
    for (let i = 0; i < financialAssetCount; i++) {
        const container = document.getElementById(`financialAsset_${i}`);
        if (container) {
            allData.step2.financialAssets.push({
                retirementAsset: document.getElementById(`retirementAsset_${i}`)?.checked,
                type: document.getElementById(`assetType_${i}`)?.value,
                balance: document.getElementById(`assetBalance_${i}`)?.value,
                institution: document.getElementById(`assetInstitution_${i}`)?.value,
                rate: document.getElementById(`assetRate_${i}`)?.value
            });
        }
    }
    
    for (let i = 0; i < debtCount; i++) {
        const container = document.getElementById(`debt_${i}`);
        if (container) {
            allData.step2.debts.push({
                type: document.getElementById(`debtType_${i}`)?.value,
                balance: document.getElementById(`debtBalance_${i}`)?.value,
                institution: document.getElementById(`debtInstitution_${i}`)?.value,
                rate: document.getElementById(`debtRate_${i}`)?.value
            });
        }
    }
    
    for (let i = 0; i < monthlyIncomeCount; i++) {
        const container = document.getElementById(`monthlyIncome_${i}`);
        if (container) {
            allData.step2.monthlyIncome.push({
                category: document.getElementById(`incomeCategory_${i}`)?.value,
                customCategory: document.getElementById(`customIncomeCategory_${i}`)?.value,
                amount: document.getElementById(`incomeAmount_${i}`)?.value
            });
        }
    }
    
    for (let i = 0; i < monthlyExpenseCount; i++) {
        const container = document.getElementById(`monthlyExpense_${i}`);
        if (container) {
            allData.step2.monthlyExpense.push({
                category: document.getElementById(`expenseCategory_${i}`)?.value,
                customCategory: document.getElementById(`customExpenseCategory_${i}`)?.value,
                amount: document.getElementById(`expenseAmount_${i}`)?.value
            });
        }
    }
    
    // Step3 동적 데이터 저장
    for (let i = 0; i < insuranceCount; i++) {
        const container = document.getElementById(`insurance_${i}`);
        if (container) {
            allData.step3.insurance.push({
                type: document.getElementById(`insuranceType_${i}`)?.value,
                customType: document.getElementById(`customInsuranceType_${i}`)?.value,
                company: document.getElementById(`insuranceCompany_${i}`)?.value,
                premium: document.getElementById(`insurancePremium_${i}`)?.value,
                coverage: document.getElementById(`insuranceCoverage_${i}`)?.value
            });
        }
    }
    
    for (let i = 0; i < pensionCount; i++) {
        const container = document.getElementById(`pension_${i}`);
        if (container) {
            allData.step3.pension.push({
                retirementPension: document.getElementById(`retirementPension_${i}`)?.checked,
                name: document.getElementById(`pensionName_${i}`)?.value,
                company: document.getElementById(`pensionCompany_${i}`)?.value,
                premium: document.getElementById(`pensionPremium_${i}`)?.value,
                returnAmount: document.getElementById(`pensionReturn_${i}`)?.value
            });
        }
    }
    
    // Step5 동적 데이터 저장
    for (let i = 0; i < goalCount; i++) {
        const container = document.getElementById(`goal_${i}`);
        if (container) {
            allData.step5.goals.push({
                name: document.getElementById(`goalName_${i}`)?.value,
                date: document.getElementById(`goalDate_${i}`)?.value,
                amount: document.getElementById(`goalAmount_${i}`)?.value,
                currentSavings: document.getElementById(`currentSavings_${i}`)?.value
            });
        }
    }
    
const name = document.getElementById('name').value || '고객';
const date = new Date().toLocaleDateString('sv-SE'); 
const fileName = `FM_${name}_${date}.fmd`;  // ← .json을 .fmd로 변경

const json = JSON.stringify(allData, null, 2);
// 암호화 추가
const encrypted = CryptoJS.AES.encrypt(json, 'FM-Secret-Key-2025').toString();
const blob = new Blob([encrypted], { type: 'application/octet-stream' });  // ← type 변경
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showSaveStatus('저장 완료!');
}

function loadData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.fmd';  // ← .json을 .fmd로 변경
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                // 복호화 추가
                const encrypted = event.target.result;
                const decrypted = CryptoJS.AES.decrypt(encrypted, 'FM-Secret-Key-2025');
                const json = decrypted.toString(CryptoJS.enc.Utf8);
                const data = JSON.parse(json);
                
                // Step1 복원
if (data.step1) {
    Object.keys(data.step1).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.value = data.step1[key] || '';
    });
    
    // 배우자 섹션 표시
    if (data.step1.maritalStatus === '기혼') {
        document.getElementById('spouseSection').style.display = 'block';
        document.getElementById('spouseNationalPensionGroup').style.display = 'block';
    }
    
    // 직업 직접입력
    if (data.step1.occupation === '직접입력') {
        document.getElementById('customOccupation').style.display = 'block';
    }
    if (data.step1.spouseOccupation === '직접입력') {
        document.getElementById('spouseCustomOccupation').style.display = 'block';
    }
const phone1 = document.getElementById('phone1').value;
const phone2 = document.getElementById('phone2').value;
if (phone1 && phone2) {
    const fullPhone = `010-${phone1}-${phone2}`;
    document.getElementById('phoneCallLink').href = `tel:${fullPhone}`;
    document.getElementById('phoneCallLink').style.display = 'inline-flex';
    document.getElementById('displayPhone').textContent = fullPhone;
}    
}          
                // Step2 복원
                if (data.step2 && data.counts) {
                    // 기존 항목 제거
                    document.getElementById('realEstateContainer').innerHTML = '';
                    document.getElementById('financialAssetsContainer').innerHTML = '';
                    document.getElementById('debtContainer').innerHTML = '';
                    document.getElementById('monthlyIncomeContainer').innerHTML = '';
                    document.getElementById('monthlyExpenseContainer').innerHTML = '';
                    
                    realEstateCount = 0;
                    financialAssetCount = 0;
                    debtCount = 0;
                    monthlyIncomeCount = 0;
                    monthlyExpenseCount = 0;
                    
                    // 부동산 복원
                    data.step2.realEstate.forEach(item => {
                        addRealEstate();
                        const i = realEstateCount - 1;
                        if (item.type) document.getElementById(`realEstateType_${i}`).value = item.type;
                        if (item.value) document.getElementById(`realEstateValue_${i}`).value = item.value;
                        if (item.location) document.getElementById(`realEstateLocation_${i}`).value = item.location;
                    });
                    
                    // 금융자산 복원
                    data.step2.financialAssets.forEach(item => {
                        addFinancialAsset();
                        const i = financialAssetCount - 1;
                        if (item.retirementAsset) document.getElementById(`retirementAsset_${i}`).checked = item.retirementAsset;
                        if (item.type) document.getElementById(`assetType_${i}`).value = item.type;
                        if (item.balance) document.getElementById(`assetBalance_${i}`).value = item.balance;
                        if (item.institution) document.getElementById(`assetInstitution_${i}`).value = item.institution;
                        if (item.rate) document.getElementById(`assetRate_${i}`).value = item.rate;
                    });
                    
                    // 부채 복원
                    data.step2.debts.forEach(item => {
                        addDebt();
                        const i = debtCount - 1;
                        if (item.type) document.getElementById(`debtType_${i}`).value = item.type;
                        if (item.balance) document.getElementById(`debtBalance_${i}`).value = item.balance;
                        if (item.institution) document.getElementById(`debtInstitution_${i}`).value = item.institution;
                        if (item.rate) document.getElementById(`debtRate_${i}`).value = item.rate;
                    });
                    
                    // 월수입 복원
                    data.step2.monthlyIncome.forEach(item => {
                        addMonthlyIncome();
                        const i = monthlyIncomeCount - 1;
                        if (item.category) {
                            document.getElementById(`incomeCategory_${i}`).value = item.category;
                            if (item.category === '직접입력') {
                                document.getElementById(`customIncomeCategory_${i}`).style.display = 'block';
                                if (item.customCategory) document.getElementById(`customIncomeCategory_${i}`).value = item.customCategory;
                            }
                        }
                        if (item.amount) document.getElementById(`incomeAmount_${i}`).value = item.amount;
                    });
                    
                    // 월지출 복원
                    data.step2.monthlyExpense.forEach(item => {
                        addMonthlyExpense();
                        const i = monthlyExpenseCount - 1;
                        if (item.category) {
                            document.getElementById(`expenseCategory_${i}`).value = item.category;
                            if (item.category === '직접입력') {
                                document.getElementById(`customExpenseCategory_${i}`).style.display = 'block';
                                if (item.customCategory) document.getElementById(`customExpenseCategory_${i}`).value = item.customCategory;
                            }
                        }
                        if (item.amount) document.getElementById(`expenseAmount_${i}`).value = item.amount;
                    });
                }
                
                // Step3 복원
                if (data.step3) {
                    document.getElementById('insuranceContainer').innerHTML = '';
                    document.getElementById('pensionContainer').innerHTML = '';
                    insuranceCount = 0;
                    pensionCount = 0;
                    
                    // 보험 복원
                    data.step3.insurance.forEach(item => {
                        addInsurance();
                        const i = insuranceCount - 1;
                        if (item.type) {
                            document.getElementById(`insuranceType_${i}`).value = item.type;
                            if (item.type === '직접입력') {
                                document.getElementById(`customInsuranceType_${i}`).style.display = 'block';
                                if (item.customType) document.getElementById(`customInsuranceType_${i}`).value = item.customType;
                            }
                        }
                        if (item.company) document.getElementById(`insuranceCompany_${i}`).value = item.company;
                        if (item.premium) document.getElementById(`insurancePremium_${i}`).value = item.premium;
                        if (item.coverage) document.getElementById(`insuranceCoverage_${i}`).value = item.coverage;
                    });
                    
                    // 연금 복원
                    data.step3.pension.forEach(item => {
                        addPension();
                        const i = pensionCount - 1;
                        if (item.retirementPension) document.getElementById(`retirementPension_${i}`).checked = item.retirementPension;
                        if (item.name) document.getElementById(`pensionName_${i}`).value = item.name;
                        if (item.company) document.getElementById(`pensionCompany_${i}`).value = item.company;
                        if (item.premium) document.getElementById(`pensionPremium_${i}`).value = item.premium;
                        if (item.returnAmount) document.getElementById(`pensionReturn_${i}`).value = item.returnAmount;
                    });
                }
                
                // Step4 복원
                if (data.step4) {
                    Object.keys(data.step4).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = data.step4[key] || '';
                    });
                }
                
                // Step5 복원
                if (data.step5) {
                    document.getElementById('goalContainer').innerHTML = '';
                    goalCount = 0;
                    
                    data.step5.goals.forEach(item => {
                        addGoal();
                        const i = goalCount - 1;
                        if (item.name) document.getElementById(`goalName_${i}`).value = item.name;
                        if (item.date) document.getElementById(`goalDate_${i}`).value = item.date;
                        if (item.amount) document.getElementById(`goalAmount_${i}`).value = item.amount;
                        if (item.currentSavings) document.getElementById(`currentSavings_${i}`).value = item.currentSavings;
                    });
                }
                
                // Step6 복원 (투자성향)
                if (data.step6) {
                    Object.keys(data.step6).forEach(key => {
                        const radio = document.querySelector(`input[name="${key}"][value="${data.step6[key]}"]`);
                        if (radio) radio.checked = true;
                    });
                }
                
                // Step7 복원
                if (data.step7) {
                    // 증여/상속 타입
                    if (data.step7.taxType) {
                        const taxTypeRadio = document.querySelector(`input[name="taxType"][value="${data.step7.taxType}"]`);
                        if (taxTypeRadio) {
                            taxTypeRadio.checked = true;
                            toggleTaxType();
                        }
                    }
                    
                    // 나머지 필드
                    Object.keys(data.step7).forEach(key => {
                        if (key === 'taxType') return;
                        const el = document.getElementById(key);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = data.step7[key];
                            } else {
                                el.value = data.step7[key] || '';
                            }
                        }
                    });
                }
                
                // Step8 복원
                if (data.step8) {
                    Object.keys(data.step8).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = data.step8[key] || '';
                    });
                }
                
                updateAnalysis();
                showSaveStatus('불러오기 완료!');
                alert('데이터를 성공적으로 불러왔습니다!');
            } catch (error) {
                console.error('파일 읽기 오류:', error);
                alert('파일을 읽을 수 없습니다: ' + error.message);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}
        function showSaveStatus(message = '저장됨') {
            const status = document.getElementById('saveStatus');
            status.textContent = message;
            status.classList.add('show');
            setTimeout(() => {
                status.classList.remove('show');
            }, 2000);
        }

        function refreshPage() {
            if (confirm('모든 입력 내용이 초기화됩니다. 계속하시겠습니까?')) {
                location.reload();
            }
        }

        function goToMain() {
            if (confirm('메인 페이지로 이동하시겠습니까?')) {
                window.location.href = '/';
            }
        }

        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                // 모바일 경고 상태 초기화
                sessionStorage.removeItem('mobileWarningClosed');
                window.location.href = '/logout';
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 모바일 감지 및 경고 표시
            function checkMobileAccess() {
                if (sessionStorage.getItem('mobileWarningClosed') === 'true') {
                    return;
                }
                
                const isMobile = window.innerWidth < 768;
                const mobileWarning = document.getElementById('mobileWarning');
                
                if (isMobile) {
                    mobileWarning.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } else {
                    mobileWarning.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }
            
            // 페이지 로드 시 확인
            checkMobileAccess();
            
            // 화면 크기 변경 시에도 확인
            window.addEventListener('resize', checkMobileAccess);

            // 오늘 날짜를 미팅일자에 자동 설정
            const today = new Date().toLocaleDateString('sv-SE');
            document.getElementById('meetingDate').value = today;
            
            // Step 탭 클릭 이벤트
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('click', function() {
                    const stepNum = parseInt(this.getAttribute('data-step'));
                    switchStep(stepNum);
                });
            });
            
            // 툴바 버튼 이벤트
            document.getElementById('saveBtn').addEventListener('click', saveData);
            document.getElementById('loadBtn').addEventListener('click', loadData);
            document.getElementById('refreshBtn').addEventListener('click', refreshPage);
            document.getElementById('mainBtn').addEventListener('click', goToMain);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Step 1 이벤트
            document.getElementById('birthDate').addEventListener('change', function() {
                const age = calculateAge(this.value);
                document.getElementById('ageDisplay').textContent = age > 0 ? `(만 ${age}세)` : '';
                updateAnalysis();
            });
            
            document.getElementById('spouseBirthDate').addEventListener('change', function() {
                const age = calculateAge(this.value);
                document.getElementById('spouseAgeDisplay').textContent = age > 0 ? `(만 ${age}세)` : '';
            });
            
            document.getElementById('occupation').addEventListener('change', function() {
                toggleCustomInput('occupation', 'customOccupation');
            });
            
            document.getElementById('spouseOccupation').addEventListener('change', function() {
                toggleCustomInput('spouseOccupation', 'spouseCustomOccupation');
            });
            
            document.getElementById('maritalStatus').addEventListener('change', function() {
                const spouseSection = document.getElementById('spouseSection');
                const spouseNationalPensionGroup = document.getElementById('spouseNationalPensionGroup');
                
                if (this.value === '기혼') {
                    spouseSection.style.display = 'block';
                    spouseNationalPensionGroup.style.display = 'block';
                    
                    const gender = document.getElementById('gender').value;
                    const spouseGender = gender === '남' ? '여' : '남';
                    document.getElementById('spouseGender').value = spouseGender;
                } else {
                    spouseSection.style.display = 'none';
                    spouseNationalPensionGroup.style.display = 'none';
                }
            });
            // Step 1 실시간 업데이트 추가
['name', 'birthDate', 'maritalStatus', 'childrenCount', 'occupation', 
 'customOccupation', 'income', 'companyName', 'meetingDate'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', updateStep1Analysis);
        el.addEventListener('change', updateStep1Analysis);
    }
});
            document.getElementById('gender').addEventListener('change', function() {
                if (document.getElementById('maritalStatus').value === '기혼') {
                    const spouseGender = this.value === '남' ? '여' : '남';
                    document.getElementById('spouseGender').value = spouseGender;
                }
            });
            

// 전화번호 업데이트
['name', 'phone1', 'phone2'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        const name = document.getElementById('name').value;
        const phone1 = document.getElementById('phone1').value;
        const phone2 = document.getElementById('phone2').value;
        
        if (phone1 && phone2) {
            const fullPhone = `010-${phone1}-${phone2}`;
            document.getElementById('phoneCallLink').href = `tel:${fullPhone}`;
            document.getElementById('phoneCallLink').style.display = 'inline-flex';
            document.getElementById('displayPhone').textContent = fullPhone;
        } else {
            document.getElementById('phoneCallLink').style.display = 'none';
        }
        
        updateAnalysis();
    });
});
            // Step 2 버튼 이벤트
            document.getElementById('addRealEstate').addEventListener('click', addRealEstate);
            document.getElementById('addFinancialAsset').addEventListener('click', addFinancialAsset);
            document.getElementById('addDebt').addEventListener('click', addDebt);
            document.getElementById('addMonthlyIncome').addEventListener('click', addMonthlyIncome);
            document.getElementById('addMonthlyExpense').addEventListener('click', addMonthlyExpense);
            
            // Step 3 버튼 이벤트
            document.getElementById('addInsurance').addEventListener('click', addInsurance);
            document.getElementById('addPension').addEventListener('click', addPension);
            
            // Step 4 이벤트
            ['retirementAge', 'lifeExpectancy', 'retirementMonthlyExpense', 'inflationRate', 
             'nationalPension', 'spouseNationalPension'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', calculateRetirementAnalysis);
                }
            });
            
            // Step 5 버튼 이벤트
            document.getElementById('addGoal').addEventListener('click', addGoal);
            
            // Step 6: 투자성향 질문 생성
            generateInvestmentQuestions();
            
            // Step 7: 상속/증여세 계산
            
            // Step 8 버튼 이벤트
            document.getElementById('generateAISolution').addEventListener('click', generateAISolution);
            document.getElementById('generatePDFReport').addEventListener('click', generatePDF);
            
            // 초기 분석 실행
            updateAnalysis();
        });
    </script>
<div style="position: absolute; left: -9999px;">
    <canvas id="assetsChart" width="400" height="200"></canvas>
</div>
</body>
</html>
