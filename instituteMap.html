<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ ì§€ë„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { 
      height:100%; 
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif; 
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
    }
    
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(12, 44, 84, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #fff;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .btn-back {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-back:hover {
      background: rgba(255,255,255,0.25);
    }
    
    #map { 
      height: 100%; 
      width: 100%;
    }
    
    .infocard { 
      font-size: 14px; 
      line-height: 1.6;
      min-width: 280px;
      max-width: 350px;
    }
    
    .infocard h4 { 
      margin: 0 0 10px; 
      font-size: 17px;
      color: #0c2c54;
      font-weight: 700;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .infocard .detail {
      margin: 8px 0;
      color: #475569;
      font-size: 13px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }
    
    .infocard .detail .icon {
      font-size: 14px;
      min-width: 18px;
    }
    
    .infocard .detail a {
      color: #0c2c54;
      text-decoration: none;
      font-weight: 600;
    }
    
    .infocard .detail a:hover {
      color: #FF8802;
    }
    
    .section-title {
      font-size: 12px;
      color: #64748b;
      font-weight: 700;
      margin: 12px 0 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-group { 
      display: flex; 
      gap: 6px; 
      flex-wrap: wrap; 
      margin-top: 4px; 
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px; 
      border: 1px solid #e2e8f0; 
      border-radius: 8px;
      background: #fff; 
      text-decoration: none; 
      font-size: 12px; 
      cursor: pointer;
      transition: 0.2s;
      color: #334155;
      font-weight: 600;
    }
    
    .btn:hover { 
      background: #f1f5f9;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .btn-phone {
      background: #10b981;
      color: #fff;
      border: none;
    }
    
    .btn-phone:hover {
      background: #059669;
    }
    
    .btn-web {
      background: #3b82f6;
      color: #fff;
      border: none;
    }
    
    .btn-web:hover {
      background: #2563eb;
    }
    
    .btn-kakao {
      background: #FEE500;
      color: #000;
      border: none;
    }
    
    .btn-kakao:hover {
      background: #FDDC00;
    }
    
    .btn-naver {
      background: #03C75A;
      color: #fff;
      border: none;
    }
    
    .btn-naver:hover {
      background: #02B350;
    }
    
    .btn-tmap {
      background: #1E40AF;
      color: #fff;
      border: none;
    }
    
    .btn-tmap:hover {
      background: #1E3A8A;
    }
    
    .btn-google {
      background: #EA4335;
      color: #fff;
      border: none;
    }
    
    .btn-google:hover {
      background: #D33426;
    }
    
    .company-label { 
      background: rgba(255,255,255,0.95); 
      border: 2px solid #0c2c54;
      border-radius: 8px; 
      padding: 5px 10px; 
      font-size: 12px;
      font-weight: 700;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      color: #0c2c54;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .company-label:hover {
      background: #FF8802;
      color: #fff;
      border-color: #FF8802;
      transform: scale(1.05);
    }
    
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      z-index: 9999;
    }
    
    .loading-screen.hide { display: none; }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .loading-progress {
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.1rem;
      }
      
      .btn-back {
        padding: 0.5rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .infocard {
        font-size: 13px;
        min-width: 250px;
      }
      
      .infocard h4 {
        font-size: 15px;
      }
      
      .btn {
        font-size: 11px;
        padding: 7px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">ì§€ë„ ë¡œë”© ì¤‘...</div>
    <div class="loading-progress" id="loadingProgress"></div>
  </div>
  
  <div class="header">
    <h1>ğŸ—ºï¸ ê³ ê° ì°¾ê¸°</h1>
    <a href="index.html" class="btn-back">â† ëŒì•„ê°€ê¸°</a>
  </div>
  
  <div id="map"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
      authDomain: "kfpc-company-support-project.firebaseapp.com",
      projectId: "kfpc-company-support-project"
    };
    
    let auth = null;
    let institutes = [];
    
    function updateLoadingText(text, progress = '') {
      const elText = document.getElementById('loadingText');
      const elProgress = document.getElementById('loadingProgress');
      if(elText) elText.textContent = text;
      if(elProgress) elProgress.textContent = progress;
    }
    
    async function initApp() {
      try {
        updateLoadingText('Firebase ì´ˆê¸°í™” ì¤‘...');
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        
        const user = await new Promise((resolve) => {
          auth.onAuthStateChanged((user) => {
            resolve(user);
          });
        });
        
        if (!user) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = 'login.html';
          return;
        }
        
        console.log('âœ… ì‚¬ìš©ì ë¡œê·¸ì¸ í™•ì¸:', user.uid);
        
        updateLoadingText('CSV ë°ì´í„° ë¡œë“œ ì¤‘...');
        await loadCSVData();
        
        updateLoadingText('ì§€ë„ ìƒì„± ì¤‘...');
        initMap();
        
        document.getElementById('loadingScreen').classList.add('hide');
        
      } catch (error) {
        console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        alert('ì•± ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
        window.location.href = 'index.html';
      }
    }
    
    async function loadCSVData() {
      return new Promise((resolve, reject) => {
        // ì‹¤ì œ íŒŒì¼ëª…ìœ¼ë¡œ ìˆ˜ì •
        const csvPath = 'institute.csv';
        
        Papa.parse(csvPath, {
          download: true,
          header: true,
          dynamicTyping: true,  // ìˆ«ì ìë™ ë³€í™˜
          skipEmptyLines: true,
          complete: function(results) {
            console.log('âœ… CSV ë¡œë“œ ì„±ê³µ:', results.data.length, 'ê°œ');
            
            // lat, lngê°€ ìˆëŠ” ë°ì´í„°ë§Œ í•„í„°ë§
            institutes = results.data.filter(row => {
              return row.lat != null && row.lng != null && 
                     !isNaN(row.lat) && !isNaN(row.lng);
            });
            
            console.log('âœ… ìœ íš¨í•œ ì¢Œí‘œ ë°ì´í„°:', institutes.length, 'ê°œ');
            console.log('ìƒ˜í”Œ ë°ì´í„°:', institutes[0]);
            resolve();
          },
          error: function(error) {
            console.error('âŒ CSV ë¡œë“œ ì‹¤íŒ¨:', error);
            reject(error);
          }
        });
      });
    }
    
    const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const escapeHtml = (s) => (s||"").replace(/[&<>"']/g,(ch)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[ch]));
    const telHref = (phone) => `tel:${(phone||"").replace(/[^0-9+]/g,"")}`;
    const normalizeUrl = (u) => !u ? null : (/^https?:\/\//i.test(u) ? u : `https://${u}`);

    // ì¸ë±ìŠ¤ë¡œ ë°ì´í„° ì°¸ì¡°í•˜ëŠ” í•¨ìˆ˜ë“¤
    function openKakaoMapByIndex(index) {
      const p = institutesGlobal[index];
      if(!p) return;
      openKakaoMap(p);
    }
    
    function openNaverMapByIndex(index) {
      const p = institutesGlobal[index];
      if(!p) return;
      openNaverMap(p);
    }
    
    function openTmapByIndex(index) {
      const p = institutesGlobal[index];
      if(!p) return;
      openTmap(p);
    }
    
    function openGoogleMapByIndex(index) {
      const p = institutesGlobal[index];
      if(!p) return;
      openGoogleMap(p);
    }

    function openKakaoMap(p){
      const name = encodeURIComponent(p.companyName || "ëª©ì ì§€");
      const address = p.instituteAddress || p.companyAddress || "";
      const url = (p.lat && p.lng)
        ? `https://map.kakao.com/link/to/${name},${p.lat},${p.lng}`
        : `https://map.kakao.com/?q=${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    }
    
    function openNaverMap(p){
      const name = encodeURIComponent(p.companyName || "ëª©ì ì§€");
      const address = p.instituteAddress || p.companyAddress || "";
      const url = (p.lat && p.lng)
        ? `https://map.naver.com/v5/search/${name}?c=${p.lng},${p.lat},15,0,0,0`
        : `https://map.naver.com/v5/search/${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    }
    
    function openTmap(p){
      const name = encodeURIComponent(p.companyName || "ëª©ì ì§€");
      const address = p.instituteAddress || p.companyAddress || "";
      const url = (p.lat && p.lng)
        ? `https://map.tmap.co.kr/?rGoX=${p.lng}&rGoY=${p.lat}&rGoName=${name}`
        : `https://map.tmap.co.kr/search?searchKeyword=${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    }
    
    function openGoogleMap(p){
      const address = p.instituteAddress || p.companyAddress || p.companyName || "";
      const url = (p.lat && p.lng)
        ? `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`
        : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    }

    let map, group;
    let institutesGlobal = []; // ì „ì—­ ë°°ì—´ë¡œ ì €ì¥
    
    function initMap() {
      map = L.map('map', { zoomControl: true });
      const defaultCenter = [37.5665, 126.9780];
      map.setView(defaultCenter, 11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      group = L.featureGroup().addTo(map);

      // ì „ì—­ ë°°ì—´ì— ë³µì‚¬
      institutesGlobal = [...institutes];

      institutes.forEach((p, index) => {
        if(!p.lat || !p.lng) return;
        
        const marker = L.marker([p.lat, p.lng]).addTo(group);

        const tooltip = marker.bindTooltip(p.companyName || "íšŒì‚¬ëª… ì—†ìŒ", {
          permanent: true,
          direction: 'top',
          offset: [0, -8],
          className: 'company-label'
        }).openTooltip();
        
        // ì¸ë±ìŠ¤ë¡œ ì°¸ì¡°í•˜ë„ë¡ ìˆ˜ì •
        marker.bindPopup(() => makePopupHtml(index), { 
          maxWidth: 380,
          className: 'custom-popup'
        });

        marker.on('click', () => marker.openPopup());
        
        const tooltipElement = tooltip.getTooltip().getElement();
        if(tooltipElement) {
          tooltipElement.addEventListener('mouseenter', () => {
            marker.openPopup();
          });
        }
      });

      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    function makePopupHtml(index){
      const p = institutesGlobal[index];
      if(!p) return '<div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      
      const address = p.instituteAddress || p.companyAddress || "";
      
      const companyInfo = `
        <div class="infocard">
          <h4>${escapeHtml(p.companyName || "íšŒì‚¬ëª… ì—†ìŒ")}</h4>
          
          <div class="detail">
            <span class="icon">ğŸ“</span>
            <span>${escapeHtml(address || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ")}</span>
          </div>
      `;
      
      const industryInfo = p.industryType ? `
        <div class="detail">
          <span class="icon">ğŸ¢</span>
          <span>${escapeHtml(p.industryType)}</span>
        </div>
      ` : "";
      
      const scaleInfo = p.scale ? `
        <div class="detail">
          <span class="icon">ğŸ“Š</span>
          <span>${escapeHtml(p.scale)}</span>
        </div>
      ` : "";
      
      const categoryInfo = p.category ? `
        <div class="detail">
          <span class="icon">ğŸ”–</span>
          <span>${escapeHtml(p.category)}</span>
        </div>
      ` : "";
      
      const ceoInfo = p.ceoName ? `
        <div class="detail">
          <span class="icon">ğŸ‘¤</span>
          <span>ëŒ€í‘œ: ${escapeHtml(p.ceoName)}</span>
        </div>
      ` : "";
      
      const certInfo = p.certificationDate ? `
        <div class="detail">
          <span class="icon">ğŸ“…</span>
          <span>ì¸ì •ì¼ì: ${escapeHtml(p.certificationDate)}</span>
        </div>
      ` : "";
      
      let contactSection = "";
      if(p.Tel || p.website) {
        contactSection = '<div class="section-title">ğŸ“ ì—°ë½ì²˜</div><div class="btn-group">';
        
        if(p.Tel && isMobile()) {
          contactSection += `<a class="btn btn-phone" href="${telHref(p.Tel)}">ğŸ“ ì „í™”ê±¸ê¸°</a>`;
        } else if(p.Tel) {
          contactSection += `<span class="btn" style="cursor:default;">ğŸ“ ${escapeHtml(p.Tel)}</span>`;
        }
        
        if(p.website) {
          contactSection += `<a class="btn btn-web" href="${normalizeUrl(p.website)}" target="_blank" rel="noopener">ğŸŒ ì›¹ì‚¬ì´íŠ¸</a>`;
        }
        
        contactSection += '</div>';
      }
      
      // ì¸ë±ìŠ¤ë¡œ ì°¸ì¡°í•˜ë„ë¡ ìˆ˜ì •
      const navSection = `
        <div class="section-title">ğŸ—ºï¸ ê¸¸ì°¾ê¸°</div>
        <div class="btn-group">
          <button class="btn btn-kakao" onclick="openKakaoMapByIndex(${index})">ì¹´ì¹´ì˜¤ë§µ</button>
          <button class="btn btn-naver" onclick="openNaverMapByIndex(${index})">ë„¤ì´ë²„ë§µ</button>
          <button class="btn btn-tmap" onclick="openTmapByIndex(${index})">Të§µ</button>
          <button class="btn btn-google" onclick="openGoogleMapByIndex(${index})">êµ¬ê¸€ë§µ</button>
        </div>
      `;

      return companyInfo + industryInfo + scaleInfo + categoryInfo + ceoInfo + certInfo + contactSection + navSection + '</div>';
    }
    
    // ì „ì—­ ìŠ¤ì½”í”„ë¡œ í•¨ìˆ˜ ë…¸ì¶œ (HTML onclickì—ì„œ ì‚¬ìš©)
    window.openKakaoMapByIndex = openKakaoMapByIndex;
    window.openNaverMapByIndex = openNaverMapByIndex;
    window.openTmapByIndex = openTmapByIndex;
    window.openGoogleMapByIndex = openGoogleMapByIndex;
    
    initApp();
  </script>
</body>
</html>