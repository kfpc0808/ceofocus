<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>기업부설연구소 지도</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { 
      height:100%; 
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif; 
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
    }
    
    /* 헤더 */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(12, 44, 84, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #fff;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .btn-back {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-back:hover {
      background: rgba(255,255,255,0.25);
    }
    
    /* 지도 */
    #map { 
      height: 100%; 
      width: 100%;
    }
    
    /* 팝업 스타일 */
    .infocard { 
      font-size: 14px; 
      line-height: 1.5;
      min-width: 250px;
    }
    
    .infocard h4 { 
      margin: 0 0 8px; 
      font-size: 16px;
      color: #0c2c54;
      font-weight: 700;
    }
    
    .infocard .detail {
      margin: 4px 0;
      color: #475569;
      font-size: 13px;
    }
    
    .row { 
      display: flex; 
      gap: 6px; 
      flex-wrap: wrap; 
      margin-top: 12px; 
    }
    
    .btn {
      display: inline-block; 
      padding: 8px 12px; 
      border: 1px solid #e2e8f0; 
      border-radius: 8px;
      background: #fff; 
      text-decoration: none; 
      font-size: 13px; 
      cursor: pointer;
      transition: 0.2s;
      color: #334155;
      font-weight: 600;
    }
    
    .btn:hover { 
      background: #f1f5f9;
      transform: translateY(-1px);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FF8802 0%, #FF6B00 100%);
      color: #fff;
      border: none;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #FF6B00 0%, #FF5500 100%);
    }
    
    .menu {
      position: absolute; 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      padding: 8px; 
      z-index: 9999;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      min-width: 200px;
    }
    
    .menu button { 
      display: block; 
      width: 100%; 
      text-align: left; 
      margin: 3px 0; 
      border: none; 
      background: none; 
      padding: 10px 12px; 
      cursor: pointer; 
      font-size: 14px;
      border-radius: 6px;
      transition: 0.2s;
    }
    
    .menu button:hover {
      background: #f1f5f9;
    }
    
    .lbl { 
      background: rgba(255,255,255,0.95); 
      border: 1px solid rgba(0,0,0,0.15); 
      border-radius: 6px; 
      padding: 4px 8px; 
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* 로딩 화면 */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      z-index: 9999;
    }
    
    .loading-screen.hide { display: none; }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
    }
    
    /* 모바일 대응 */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.1rem;
      }
      
      .btn-back {
        padding: 0.5rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .infocard {
        font-size: 13px;
      }
      
      .infocard h4 {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- 로딩 화면 -->
  <div class="loading-screen" id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text">지도 로딩 중...</div>
  </div>
  
  <!-- 헤더 -->
  <div class="header">
    <h1>🗺️ 고객 찾기</h1>
    <a href="index.html" class="btn-back">← 돌아가기</a>
  </div>
  
  <!-- 지도 -->
  <div id="map"></div>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
      authDomain: "kfpc-company-support-project.firebaseapp.com",
      projectId: "kfpc-company-support-project"
    };
    
    let auth = null;
    let institutes = [];
    
    // Firebase 초기화 및 인증 확인
    async function initApp() {
      try {
        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        
        // 로그인 확인
        const user = await new Promise((resolve) => {
          auth.onAuthStateChanged((user) => {
            resolve(user);
          });
        });
        
        if (!user) {
          alert('로그인이 필요합니다.');
          window.location.href = 'login.html';
          return;
        }
        
        console.log('✅ 사용자 로그인 확인:', user.uid);
        
        // CSV 데이터 로드
        await loadCSVData();
        
        // 지도 초기화
        initMap();
        
        // 로딩 화면 숨기기
        document.getElementById('loadingScreen').classList.add('hide');
        
      } catch (error) {
        console.error('❌ 초기화 오류:', error);
        alert('앱 로딩에 실패했습니다.\n\n' + error.message);
        window.location.href = 'index.html';
      }
    }
    
    // CSV 데이터 로드
    async function loadCSVData() {
      return new Promise((resolve, reject) => {
        // CSV 파일 경로 (같은 폴더에 있다고 가정)
        const csvPath = 'institute.csv';
        
        Papa.parse(csvPath, {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: function(results) {
            console.log('✅ CSV 로드 성공:', results.data.length, '개');
            institutes = results.data.filter(row => {
              // lat, lng가 있는 데이터만 필터링
              return row.lat != null && row.lng != null;
            });
            console.log('✅ 유효한 위치 데이터:', institutes.length, '개');
            resolve();
          },
          error: function(error) {
            console.warn('⚠️ CSV 로드 실패, 샘플 데이터 사용:', error);
            // CSV 로드 실패 시 샘플 데이터 사용
            institutes = [
              {
                companyName: "Kyungil Corporation",
                address: "서울특별시 중구 세종대로 110",
                lat: 37.5665, lng: 126.9780,
                phone: "02-1234-5678",
                website: "https://example.com",
                industryType: "전자",
                certificationDate: "2021-06-15"
              },
              {
                companyName: "Market Kurly R&D",
                address: "서울특별시 송파구 올림픽로 300",
                lat: 37.5145, lng: 127.1056,
                phone: "02-9876-5432",
                website: "https://marketkurly.com",
                industryType: "유통/물류",
                certificationDate: "2022-03-08"
              }
            ];
            resolve();
          }
        });
      });
    }
    
    // 공용 유틸
    const APP_NAME = "kr.fpcenter.web";
    const PREF_KEY = "preferredMap";
    const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const getPref = () => localStorage.getItem(PREF_KEY) || null;
    const setPref = (v) => localStorage.setItem(PREF_KEY, v);
    const escapeHtml = (s) => (s||"").replace(/[&<>"']/g,(ch)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[ch]));
    const telHref = (phone) => `tel:${(phone||"").replace(/[^0-9+]/g,"")}`;
    const normalizeUrl = (u) => !u ? null : (/^https?:\/\//i.test(u) ? u : `https://${u}`);

    // 지도앱 딥링크
    function tmapLinkFor(p){
      const name = encodeURIComponent(p.companyName || p.address || "목적지");
      if(p.lng != null && p.lat != null) return { 
        app: `tmap://route?goalname=${name}&goalx=${p.lng}&goaly=${p.lat}`,
        web: `https://map.tmap.co.kr/?rGoX=${p.lng}&rGoY=${p.lat}&rGoName=${name}` 
      };
      const q = encodeURIComponent(p.address || name);
      return { app: `tmap://search?name=${q}`, web: `https://map.tmap.co.kr/search?searchKeyword=${q}` };
    }
    
    function kakaoMapLinkFor(p){
      const name = encodeURIComponent(p.companyName || p.address || "목적지");
      if(p.lat != null && p.lng != null) return { 
        app: `kakaomap://route?ep=${p.lat},${p.lng}&by=CAR`,
        web: `https://map.kakao.com/link/to/${name},${p.lat},${p.lng}` 
      };
      const q = encodeURIComponent(p.address || "");
      return { app: `kakaomap://search?q=${q}`, web: `https://map.kakao.com/?q=${q}` };
    }
    
    function naverMapLinkFor(p){
      const name = encodeURIComponent(p.companyName || p.address || "목적지");
      if(p.lat != null && p.lng != null) return { 
        app: `nmap://route/car?dlat=${p.lat}&dlng=${p.lng}&dname=${name}&appname=${encodeURIComponent(APP_NAME)}`,
        web: `https://map.naver.com/v5/search/${name}?c=${p.lng},${p.lat},15,0,0,0` 
      };
      const q = encodeURIComponent(p.address || "");
      return { app: `nmap://search?query=${q}&appname=${encodeURIComponent(APP_NAME)}`, web: `https://map.naver.com/v5/search/${q}` };
    }
    
    function openWithFallback(links){
      const t = setTimeout(() => window.open(links.web, "_blank"), 900);
      window.location.href = links.app;
      window.addEventListener("pagehide", () => clearTimeout(t), {once: true});
      window.addEventListener("blur", () => clearTimeout(t), {once: true});
    }
    
    const openTmap = (p) => openWithFallback(tmapLinkFor(p));
    const openKakaoMap = (p) => openWithFallback(kakaoMapLinkFor(p));
    const openNaverMap = (p) => openWithFallback(naverMapLinkFor(p));
    
    function openGoogleMap(p){
      const q = (p.lat != null && p.lng != null)
        ? `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`
        : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.address || p.companyName || "")}`;
      window.open(q, "_blank");
    }

    // 선호 지도 기반 스마트 길찾기
    let currentMenu;
    function smartNavigate(p){
      const pref = getPref();
      if(pref === "kakao") return openKakaoMap(p);
      if(pref === "naver") return openNaverMap(p);
      if(pref === "tmap")  return openTmap(p);
      if(pref === "google") return openGoogleMap(p);
      openProviderMenu(null, p);
    }
    
    function openProviderMenu(anchor, p){
      if(currentMenu){ currentMenu.remove(); currentMenu = null; }
      window.__lastPlaceForMenu = p;
      const m = document.createElement("div");
      m.className = "menu";
      m.innerHTML = `
        <button onclick="chooseProvider('kakao')">🟡 카카오맵으로 계속</button>
        <button onclick="chooseProvider('naver')">🟢 네이버맵으로 계속</button>
        <button onclick="chooseProvider('tmap')">🗺️ T맵으로 계속</button>
        <button onclick="chooseProvider('google')">🔵 구글맵으로 계속</button>
        <hr style='margin:6px 0; border:none; border-top:1px solid #e2e8f0;'>
        <button onclick='currentMenu.remove()'>취소</button>`;
      document.body.appendChild(m); 
      currentMenu = m;
      const x = anchor ? anchor.getBoundingClientRect().left : window.innerWidth / 2 - 100;
      const y = anchor ? anchor.getBoundingClientRect().bottom : 100;
      m.style.left = x + "px"; 
      m.style.top = y + "px";
    }
    
    function chooseProvider(v){
      setPref(v);
      const p = window.__lastPlaceForMenu;
      if(v === "kakao") openKakaoMap(p);
      else if(v === "naver") openNaverMap(p);
      else if(v === "tmap") openTmap(p);
      else openGoogleMap(p);
      if(currentMenu) currentMenu.remove(), currentMenu = null;
    }

    // Leaflet 지도 초기화
    let map, group;
    
    function initMap() {
      map = L.map('map', { zoomControl: true });
      const defaultCenter = [37.5665, 126.9780]; // 서울시청
      map.setView(defaultCenter, 11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // 마커 그룹
      group = L.featureGroup().addTo(map);

      institutes.forEach(p => {
        if(p.lat == null || p.lng == null) return;
        
        const marker = L.marker([p.lat, p.lng]).addTo(group);

        // 회사명 라벨(항상 보이게)
        marker.bindTooltip(p.companyName || "", {
          permanent: true,
          direction: 'top',
          offset: [0, -8],
          className: 'lbl'
        }).openTooltip();

        // 상세 팝업
        marker.bindPopup(makePopupHtml(p), { maxWidth: 340 });

        // 클릭 시 팝업 open
        marker.on('click', () => marker.openPopup());
      });

      // 데이터에 맞춰 화면 경계 맞춤
      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    function makePopupHtml(p){
      const phoneBtn = (p.phone && isMobile()) 
        ? `<a class="btn" href="${telHref(p.phone)}">📞 전화</a>` 
        : "";
      const webBtn = p.website 
        ? `<a class="btn" href="${normalizeUrl(p.website)}" target="_blank" rel="noopener">🌐 웹사이트</a>` 
        : "";
      const smartBtn = `<button class="btn btn-primary" onclick='smartNavigate(${JSON.stringify({companyName:p.companyName,address:p.address,lat:p.lat,lng:p.lng})})'>🚗 길찾기</button>`;
      
      const cert = p.certificationDate 
        ? `<div class="detail">인정일자: ${escapeHtml(p.certificationDate)}</div>` 
        : "";
      const ind = p.industryType 
        ? `<div class="detail">업종: ${escapeHtml(p.industryType)}</div>` 
        : "";

      return `
        <div class="infocard">
          <h4>${escapeHtml(p.companyName)}</h4>
          <div class="detail">${escapeHtml(p.address || "")}</div>
          ${ind}
          ${cert}
          <div class="row">
            ${smartBtn}
            ${phoneBtn}
            ${webBtn}
          </div>
        </div>
      `;
    }
    
    // 앱 시작
    initApp();
  </script>
</body>
</html>