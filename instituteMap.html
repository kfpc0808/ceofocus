<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Í∏∞ÏóÖÎ∂ÄÏÑ§Ïó∞Íµ¨ÏÜå ÏßÄÎèÑ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { 
      height:100%; 
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif; 
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
    }
    
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(12, 44, 84, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #fff;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .btn-back {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-back:hover {
      background: rgba(255,255,255,0.25);
    }
    
    #map { 
      height: 100%; 
      width: 100%;
    }
    
    .infocard { 
      font-size: 14px; 
      line-height: 1.6;
      min-width: 280px;
      max-width: 350px;
    }
    
    .infocard h4 { 
      margin: 0 0 10px; 
      font-size: 17px;
      color: #0c2c54;
      font-weight: 700;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .infocard .detail {
      margin: 8px 0;
      color: #475569;
      font-size: 13px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }
    
    .infocard .detail .icon {
      font-size: 14px;
      min-width: 18px;
    }
    
    .infocard .detail a {
      color: #0c2c54;
      text-decoration: none;
      font-weight: 600;
    }
    
    .infocard .detail a:hover {
      color: #FF8802;
    }
    
    .section-title {
      font-size: 12px;
      color: #64748b;
      font-weight: 700;
      margin: 12px 0 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-group { 
      display: flex; 
      gap: 6px; 
      flex-wrap: wrap; 
      margin-top: 4px; 
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px; 
      border: 1px solid #e2e8f0; 
      border-radius: 8px;
      background: #fff; 
      text-decoration: none; 
      font-size: 12px; 
      cursor: pointer;
      transition: 0.2s;
      color: #334155;
      font-weight: 600;
    }
    
    .btn:hover { 
      background: #f1f5f9;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .btn-phone {
      background: #10b981;
      color: #fff;
      border: none;
    }
    
    .btn-phone:hover {
      background: #059669;
    }
    
    .btn-web {
      background: #3b82f6;
      color: #fff;
      border: none;
    }
    
    .btn-web:hover {
      background: #2563eb;
    }
    
    .btn-kakao {
      background: #FEE500;
      color: #000;
      border: none;
    }
    
    .btn-kakao:hover {
      background: #FDDC00;
    }
    
    .btn-naver {
      background: #03C75A;
      color: #fff;
      border: none;
    }
    
    .btn-naver:hover {
      background: #02B350;
    }
    
    .btn-tmap {
      background: #1E40AF;
      color: #fff;
      border: none;
    }
    
    .btn-tmap:hover {
      background: #1E3A8A;
    }
    
    .btn-google {
      background: #EA4335;
      color: #fff;
      border: none;
    }
    
    .btn-google:hover {
      background: #D33426;
    }
    
    .company-label { 
      background: rgba(255,255,255,0.95); 
      border: 2px solid #0c2c54;
      border-radius: 8px; 
      padding: 5px 10px; 
      font-size: 12px;
      font-weight: 700;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      color: #0c2c54;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .company-label:hover {
      background: #FF8802;
      color: #fff;
      border-color: #FF8802;
      transform: scale(1.05);
    }
    
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      z-index: 9999;
    }
    
    .loading-screen.hide { display: none; }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .loading-progress {
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.1rem;
      }
      
      .btn-back {
        padding: 0.5rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .infocard {
        font-size: 13px;
        min-width: 250px;
      }
      
      .infocard h4 {
        font-size: 15px;
      }
      
      .btn {
        font-size: 11px;
        padding: 7px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">ÏßÄÎèÑ Î°úÎî© Ï§ë...</div>
    <div class="loading-progress" id="loadingProgress"></div>
  </div>
  
  <div class="header">
    <h1>üó∫Ô∏è Í≥†Í∞ù Ï∞æÍ∏∞</h1>
    <a href="index.html" class="btn-back">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</a>
  </div>
  
  <div id="map"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
      authDomain: "kfpc-company-support-project.firebaseapp.com",
      projectId: "kfpc-company-support-project"
    };
    
    let auth = null;
    let institutes = [];
    
    function updateLoadingText(text, progress = '') {
      const elText = document.getElementById('loadingText');
      const elProgress = document.getElementById('loadingProgress');
      if(elText) elText.textContent = text;
      if(elProgress) elProgress.textContent = progress;
    }
    
    async function initApp() {
      try {
        updateLoadingText('Firebase Ï¥àÍ∏∞Ìôî Ï§ë...');
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        
        const user = await new Promise((resolve) => {
          auth.onAuthStateChanged((user) => {
            resolve(user);
          });
        });
        
        if (!user) {
          alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
          window.location.href = 'login.html';
          return;
        }
        
        console.log('‚úÖ ÏÇ¨Ïö©Ïûê Î°úÍ∑∏Ïù∏ ÌôïÏù∏:', user.uid);
        
        updateLoadingText('CSV Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...');
        await loadCSVData();
        
        updateLoadingText('ÏßÄÎèÑ ÏÉùÏÑ± Ï§ë...');
        initMap();
        
        document.getElementById('loadingScreen').classList.add('hide');
        
      } catch (error) {
        console.error('‚ùå Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
        alert('Ïï± Î°úÎî©Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\n' + error.message);
        window.location.href = 'index.html';
      }
    }
    
    async function loadCSVData() {
      return new Promise((resolve, reject) => {
        // Ïã§Ï†ú ÌååÏùºÎ™ÖÏúºÎ°ú ÏàòÏ†ï
        const csvPath = 'institute.csv';
        
        Papa.parse(csvPath, {
          download: true,
          header: true,
          dynamicTyping: true,  // Ïà´Ïûê ÏûêÎèô Î≥ÄÌôò
          skipEmptyLines: true,
          complete: function(results) {
            console.log('‚úÖ CSV Î°úÎìú ÏÑ±Í≥µ:', results.data.length, 'Í∞ú');
            
            // lat, lngÍ∞Ä ÏûàÎäî Îç∞Ïù¥ÌÑ∞Îßå ÌïÑÌÑ∞ÎßÅ
            institutes = results.data.filter(row => {
              return row.lat != null && row.lng != null && 
                     !isNaN(row.lat) && !isNaN(row.lng);
            });
            
            console.log('‚úÖ Ïú†Ìö®Ìïú Ï¢åÌëú Îç∞Ïù¥ÌÑ∞:', institutes.length, 'Í∞ú');
            console.log('ÏÉòÌîå Îç∞Ïù¥ÌÑ∞:', institutes[0]);
            resolve();
          },
          error: function(error) {
            console.error('‚ùå CSV Î°úÎìú Ïã§Ìå®:', error);
            reject(error);
          }
        });
      });
    }
    
    const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const escapeHtml = (s) => (s||"").replace(/[&<>"']/g,(ch)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[ch]));
    const telHref = (phone) => `tel:${(phone||"").replace(/[^0-9+]/g,"")}`;
    const normalizeUrl = (u) => !u ? null : (/^https?:\/\//i.test(u) ? u : `https://${u}`);

    // Ïù∏Îç±Ïä§Î°ú Îç∞Ïù¥ÌÑ∞ Ï∞∏Ï°∞ÌïòÎäî Ìï®ÏàòÎì§
    function openKakaoMapByIndex(index) {
      const p = institutesGlobal[index];
      if(!p) return;
      openKakaoMap(p);
    }
    
    function openNaverMapByIndex(index) {
      const p = institutesGlobal[index];
      if(!p) return;
      openNaverMap(p);
    }
    
    function openTmapByIndex(index) {
      const p = institutesGlobal[index];
      if(!p) return;
      openTmap(p);
    }
    
    function openGoogleMapByIndex(index) {
      const p = institutesGlobal[index];
      if(!p) return;
      openGoogleMap(p);
    }

    function openKakaoMap(p){
      const name = encodeURIComponent(p.companyName || "Î™©Ï†ÅÏßÄ");
      const address = p.instituteAddress || p.companyAddress || "";
      const url = (p.lat && p.lng)
        ? `https://map.kakao.com/link/to/${name},${p.lat},${p.lng}`
        : `https://map.kakao.com/?q=${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    }
    
    function openNaverMap(p){
      const name = encodeURIComponent(p.companyName || "Î™©Ï†ÅÏßÄ");
      const address = p.instituteAddress || p.companyAddress || "";
      const url = (p.lat && p.lng)
        ? `https://map.naver.com/v5/search/${name}?c=${p.lng},${p.lat},15,0,0,0`
        : `https://map.naver.com/v5/search/${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    }
    
    function openTmap(p){
      const name = encodeURIComponent(p.companyName || "Î™©Ï†ÅÏßÄ");
      const address = p.instituteAddress || p.companyAddress || "";
      const url = (p.lat && p.lng)
        ? `https://map.tmap.co.kr/?rGoX=${p.lng}&rGoY=${p.lat}&rGoName=${name}`
        : `https://map.tmap.co.kr/search?searchKeyword=${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    }
    
    function openGoogleMap(p){
      const address = p.instituteAddress || p.companyAddress || p.companyName || "";
      const url = (p.lat && p.lng)
        ? `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`
        : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    }

    let map, group;
    let institutesGlobal = []; // Ï†ÑÏó≠ Î∞∞Ïó¥Î°ú Ï†ÄÏû•
    
    function initMap() {
      map = L.map('map', { zoomControl: true });
      const defaultCenter = [37.5665, 126.9780];
      map.setView(defaultCenter, 11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      group = L.featureGroup().addTo(map);

      // Ï†ÑÏó≠ Î∞∞Ïó¥Ïóê Î≥µÏÇ¨
      institutesGlobal = [...institutes];

      institutes.forEach((p, index) => {
        if(!p.lat || !p.lng) return;
        
        const marker = L.marker([p.lat, p.lng]).addTo(group);

        const tooltip = marker.bindTooltip(p.companyName || "ÌöåÏÇ¨Î™Ö ÏóÜÏùå", {
          permanent: true,
          direction: 'top',
          offset: [0, -8],
          className: 'company-label'
        }).openTooltip();
        
        // Ïù∏Îç±Ïä§Î°ú Ï∞∏Ï°∞ÌïòÎèÑÎ°ù ÏàòÏ†ï
        marker.bindPopup(() => makePopupHtml(index), { 
          maxWidth: 380,
          className: 'custom-popup'
        });

        marker.on('click', () => marker.openPopup());
        
        const tooltipElement = tooltip.getTooltip().getElement();
        if(tooltipElement) {
          tooltipElement.addEventListener('mouseenter', () => {
            marker.openPopup();
          });
        }
      });

      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    function makePopupHtml(index){
      const p = institutesGlobal[index];
      if(!p) return '<div>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
      
      const address = p.instituteAddress || p.companyAddress || "";
      
      const companyInfo = `
        <div class="infocard">
          <h4>${escapeHtml(p.companyName || "ÌöåÏÇ¨Î™Ö ÏóÜÏùå")}</h4>
          
          <div class="detail">
            <span class="icon">üìç</span>
            <span>${escapeHtml(address || "Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå")}</span>
          </div>
      `;
      
      const industryInfo = p.industryType ? `
        <div class="detail">
          <span class="icon">üè¢</span>
          <span>${escapeHtml(p.industryType)}</span>
        </div>
      ` : "";
      
      const scaleInfo = p.scale ? `
        <div class="detail">
          <span class="icon">üìä</span>
          <span>${escapeHtml(p.scale)}</span>
        </div>
      ` : "";
      
      const categoryInfo = p.category ? `
        <div class="detail">
          <span class="icon">üîñ</span>
          <span>${escapeHtml(p.category)}</span>
        </div>
      ` : "";
      
      const ceoInfo = p.ceoName ? `
        <div class="detail">
          <span class="icon">üë§</span>
          <span>ÎåÄÌëú: ${escapeHtml(p.ceoName)}</span>
        </div>
      ` : "";
      
      const certInfo = p.certificationDate ? `
        <div class="detail">
          <span class="icon">üìÖ</span>
          <span>Ïù∏Ï†ïÏùºÏûê: ${escapeHtml(p.certificationDate)}</span>
        </div>
      ` : "";
      
      let contactSection = "";
      if(p.Tel || p.website) {
        contactSection = '<div class="section-title">üìû Ïó∞ÎùΩÏ≤ò</div><div class="btn-group">';
        
        if(p.Tel && isMobile()) {
          contactSection += `<a class="btn btn-phone" href="${telHref(p.Tel)}">üìû Ï†ÑÌôîÍ±∏Í∏∞</a>`;
        } else if(p.Tel) {
          contactSection += `<span class="btn" style="cursor:default;">üìû ${escapeHtml(p.Tel)}</span>`;
        }
        
        if(p.website) {
          contactSection += `<a class="btn btn-web" href="${normalizeUrl(p.website)}" target="_blank" rel="noopener">üåê ÏõπÏÇ¨Ïù¥Ìä∏</a>`;
        }
        
        contactSection += '</div>';
      }
      
      // Ïù∏Îç±Ïä§Î°ú Ï∞∏Ï°∞ÌïòÎèÑÎ°ù ÏàòÏ†ï
      const navSection = `
        <div class="section-title">üó∫Ô∏è Í∏∏Ï∞æÍ∏∞</div>
        <div class="btn-group">
          <button class="btn btn-kakao" onclick="openKakaoMapByIndex(${index})">Ïπ¥Ïπ¥Ïò§Îßµ</button>
          <button class="btn btn-naver" onclick="openNaverMapByIndex(${index})">ÎÑ§Ïù¥Î≤ÑÎßµ</button>
          <button class="btn btn-tmap" onclick="openTmapByIndex(${index})">TÎßµ</button>
          <button class="btn btn-google" onclick="openGoogleMapByIndex(${index})">Íµ¨Í∏ÄÎßµ</button>
        </div>
      `;

      return companyInfo + industryInfo + scaleInfo + categoryInfo + ceoInfo + certInfo + contactSection + navSection + '</div>';
    }
    
    // Ï†ÑÏó≠ Ïä§ÏΩîÌîÑÎ°ú Ìï®Ïàò ÎÖ∏Ï∂ú (HTML onclickÏóêÏÑú ÏÇ¨Ïö©)
    window.openKakaoMapByIndex = openKakaoMapByIndex;
    window.openNaverMapByIndex = openNaverMapByIndex;
    window.openTmapByIndex = openTmapByIndex;
    window.openGoogleMapByIndex = openGoogleMapByIndex;
    
    initApp();
  </script>
</body>
</html>