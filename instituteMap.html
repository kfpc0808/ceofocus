<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ ì§€ë„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { 
      height:100%; 
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif; 
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
    }
    
    /* í—¤ë” */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(12, 44, 84, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #fff;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .btn-back {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-back:hover {
      background: rgba(255,255,255,0.25);
    }
    
    /* ì§€ë„ */
    #map { 
      height: 100%; 
      width: 100%;
    }
    
    /* íŒì—… ìŠ¤íƒ€ì¼ */
    .infocard { 
      font-size: 14px; 
      line-height: 1.5;
      min-width: 250px;
    }
    
    .infocard h4 { 
      margin: 0 0 8px; 
      font-size: 16px;
      color: #0c2c54;
      font-weight: 700;
    }
    
    .infocard .detail {
      margin: 4px 0;
      color: #475569;
      font-size: 13px;
    }
    
    .row { 
      display: flex; 
      gap: 6px; 
      flex-wrap: wrap; 
      margin-top: 12px; 
    }
    
    .btn {
      display: inline-block; 
      padding: 8px 12px; 
      border: 1px solid #e2e8f0; 
      border-radius: 8px;
      background: #fff; 
      text-decoration: none; 
      font-size: 13px; 
      cursor: pointer;
      transition: 0.2s;
      color: #334155;
      font-weight: 600;
    }
    
    .btn:hover { 
      background: #f1f5f9;
      transform: translateY(-1px);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FF8802 0%, #FF6B00 100%);
      color: #fff;
      border: none;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #FF6B00 0%, #FF5500 100%);
    }
    
    .menu {
      position: absolute; 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      padding: 8px; 
      z-index: 9999;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      min-width: 200px;
    }
    
    .menu button { 
      display: block; 
      width: 100%; 
      text-align: left; 
      margin: 3px 0; 
      border: none; 
      background: none; 
      padding: 10px 12px; 
      cursor: pointer; 
      font-size: 14px;
      border-radius: 6px;
      transition: 0.2s;
    }
    
    .menu button:hover {
      background: #f1f5f9;
    }
    
    .lbl { 
      background: rgba(255,255,255,0.95); 
      border: 1px solid rgba(0,0,0,0.15); 
      border-radius: 6px; 
      padding: 4px 8px; 
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* ë¡œë”© í™”ë©´ */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      z-index: 9999;
    }
    
    .loading-screen.hide { display: none; }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
    }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.1rem;
      }
      
      .btn-back {
        padding: 0.5rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .infocard {
        font-size: 13px;
      }
      
      .infocard h4 {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- ë¡œë”© í™”ë©´ -->
  <div class="loading-screen" id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text">ì§€ë„ ë¡œë”© ì¤‘...</div>
  </div>
  
  <!-- í—¤ë” -->
  <div class="header">
    <h1>ğŸ—ºï¸ ê³ ê° ì°¾ê¸°</h1>
    <a href="index.html" class="btn-back">â† ëŒì•„ê°€ê¸°</a>
  </div>
  
  <!-- ì§€ë„ -->
  <div id="map"></div>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
      authDomain: "kfpc-company-support-project.firebaseapp.com",
      projectId: "kfpc-company-support-project"
    };
    
    let auth = null;
    let institutes = [];
    
    // Firebase ì´ˆê¸°í™” ë° ì¸ì¦ í™•ì¸
    async function initApp() {
      try {
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        
        // ë¡œê·¸ì¸ í™•ì¸
        const user = await new Promise((resolve) => {
          auth.onAuthStateChanged((user) => {
            resolve(user);
          });
        });
        
        if (!user) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = 'login.html';
          return;
        }
        
        console.log('âœ… ì‚¬ìš©ì ë¡œê·¸ì¸ í™•ì¸:', user.uid);
        
        // CSV ë°ì´í„° ë¡œë“œ
        await loadCSVData();
        
        // ì§€ë„ ì´ˆê¸°í™”
        initMap();
        
        // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
        document.getElementById('loadingScreen').classList.add('hide');
        
      } catch (error) {
        console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        alert('ì•± ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
        window.location.href = 'index.html';
      }
    }
    
    // CSV ë°ì´í„° ë¡œë“œ
    async function loadCSVData() {
      return new Promise((resolve, reject) => {
        // CSV íŒŒì¼ ê²½ë¡œ (ê°™ì€ í´ë”ì— ìˆë‹¤ê³  ê°€ì •)
        const csvPath = 'institute.csv';
        
        Papa.parse(csvPath, {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: function(results) {
            console.log('âœ… CSV ë¡œë“œ ì„±ê³µ:', results.data.length, 'ê°œ');
            institutes = results.data.filter(row => {
              // lat, lngê°€ ìˆëŠ” ë°ì´í„°ë§Œ í•„í„°ë§
              return row.lat != null && row.lng != null;
            });
            console.log('âœ… ìœ íš¨í•œ ìœ„ì¹˜ ë°ì´í„°:', institutes.length, 'ê°œ');
            resolve();
          },
          error: function(error) {
            console.warn('âš ï¸ CSV ë¡œë“œ ì‹¤íŒ¨, ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©:', error);
            // CSV ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
            institutes = [
              {
                companyName: "Kyungil Corporation",
                address: "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110",
                lat: 37.5665, lng: 126.9780,
                phone: "02-1234-5678",
                website: "https://example.com",
                industryType: "ì „ì",
                certificationDate: "2021-06-15"
              },
              {
                companyName: "Market Kurly R&D",
                address: "ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300",
                lat: 37.5145, lng: 127.1056,
                phone: "02-9876-5432",
                website: "https://marketkurly.com",
                industryType: "ìœ í†µ/ë¬¼ë¥˜",
                certificationDate: "2022-03-08"
              }
            ];
            resolve();
          }
        });
      });
    }
    
    // ê³µìš© ìœ í‹¸
    const APP_NAME = "kr.fpcenter.web";
    const PREF_KEY = "preferredMap";
    const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const getPref = () => localStorage.getItem(PREF_KEY) || null;
    const setPref = (v) => localStorage.setItem(PREF_KEY, v);
    const escapeHtml = (s) => (s||"").replace(/[&<>"']/g,(ch)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[ch]));
    const telHref = (phone) => `tel:${(phone||"").replace(/[^0-9+]/g,"")}`;
    const normalizeUrl = (u) => !u ? null : (/^https?:\/\//i.test(u) ? u : `https://${u}`);

    // ì§€ë„ì•± ë”¥ë§í¬
    function tmapLinkFor(p){
      const name = encodeURIComponent(p.companyName || p.address || "ëª©ì ì§€");
      if(p.lng != null && p.lat != null) return { 
        app: `tmap://route?goalname=${name}&goalx=${p.lng}&goaly=${p.lat}`,
        web: `https://map.tmap.co.kr/?rGoX=${p.lng}&rGoY=${p.lat}&rGoName=${name}` 
      };
      const q = encodeURIComponent(p.address || name);
      return { app: `tmap://search?name=${q}`, web: `https://map.tmap.co.kr/search?searchKeyword=${q}` };
    }
    
    function kakaoMapLinkFor(p){
      const name = encodeURIComponent(p.companyName || p.address || "ëª©ì ì§€");
      if(p.lat != null && p.lng != null) return { 
        app: `kakaomap://route?ep=${p.lat},${p.lng}&by=CAR`,
        web: `https://map.kakao.com/link/to/${name},${p.lat},${p.lng}` 
      };
      const q = encodeURIComponent(p.address || "");
      return { app: `kakaomap://search?q=${q}`, web: `https://map.kakao.com/?q=${q}` };
    }
    
    function naverMapLinkFor(p){
      const name = encodeURIComponent(p.companyName || p.address || "ëª©ì ì§€");
      if(p.lat != null && p.lng != null) return { 
        app: `nmap://route/car?dlat=${p.lat}&dlng=${p.lng}&dname=${name}&appname=${encodeURIComponent(APP_NAME)}`,
        web: `https://map.naver.com/v5/search/${name}?c=${p.lng},${p.lat},15,0,0,0` 
      };
      const q = encodeURIComponent(p.address || "");
      return { app: `nmap://search?query=${q}&appname=${encodeURIComponent(APP_NAME)}`, web: `https://map.naver.com/v5/search/${q}` };
    }
    
    function openWithFallback(links){
      const t = setTimeout(() => window.open(links.web, "_blank"), 900);
      window.location.href = links.app;
      window.addEventListener("pagehide", () => clearTimeout(t), {once: true});
      window.addEventListener("blur", () => clearTimeout(t), {once: true});
    }
    
    const openTmap = (p) => openWithFallback(tmapLinkFor(p));
    const openKakaoMap = (p) => openWithFallback(kakaoMapLinkFor(p));
    const openNaverMap = (p) => openWithFallback(naverMapLinkFor(p));
    
    function openGoogleMap(p){
      const q = (p.lat != null && p.lng != null)
        ? `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`
        : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.address || p.companyName || "")}`;
      window.open(q, "_blank");
    }

    // ì„ í˜¸ ì§€ë„ ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ê¸¸ì°¾ê¸°
    let currentMenu;
    function smartNavigate(p){
      const pref = getPref();
      if(pref === "kakao") return openKakaoMap(p);
      if(pref === "naver") return openNaverMap(p);
      if(pref === "tmap")  return openTmap(p);
      if(pref === "google") return openGoogleMap(p);
      openProviderMenu(null, p);
    }
    
    function openProviderMenu(anchor, p){
      if(currentMenu){ currentMenu.remove(); currentMenu = null; }
      window.__lastPlaceForMenu = p;
      const m = document.createElement("div");
      m.className = "menu";
      m.innerHTML = `
        <button onclick="chooseProvider('kakao')">ğŸŸ¡ ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ ê³„ì†</button>
        <button onclick="chooseProvider('naver')">ğŸŸ¢ ë„¤ì´ë²„ë§µìœ¼ë¡œ ê³„ì†</button>
        <button onclick="chooseProvider('tmap')">ğŸ—ºï¸ Të§µìœ¼ë¡œ ê³„ì†</button>
        <button onclick="chooseProvider('google')">ğŸ”µ êµ¬ê¸€ë§µìœ¼ë¡œ ê³„ì†</button>
        <hr style='margin:6px 0; border:none; border-top:1px solid #e2e8f0;'>
        <button onclick='currentMenu.remove()'>ì·¨ì†Œ</button>`;
      document.body.appendChild(m); 
      currentMenu = m;
      const x = anchor ? anchor.getBoundingClientRect().left : window.innerWidth / 2 - 100;
      const y = anchor ? anchor.getBoundingClientRect().bottom : 100;
      m.style.left = x + "px"; 
      m.style.top = y + "px";
    }
    
    function chooseProvider(v){
      setPref(v);
      const p = window.__lastPlaceForMenu;
      if(v === "kakao") openKakaoMap(p);
      else if(v === "naver") openNaverMap(p);
      else if(v === "tmap") openTmap(p);
      else openGoogleMap(p);
      if(currentMenu) currentMenu.remove(), currentMenu = null;
    }

    // Leaflet ì§€ë„ ì´ˆê¸°í™”
    let map, group;
    
    function initMap() {
      map = L.map('map', { zoomControl: true });
      const defaultCenter = [37.5665, 126.9780]; // ì„œìš¸ì‹œì²­
      map.setView(defaultCenter, 11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // ë§ˆì»¤ ê·¸ë£¹
      group = L.featureGroup().addTo(map);

      institutes.forEach(p => {
        if(p.lat == null || p.lng == null) return;
        
        const marker = L.marker([p.lat, p.lng]).addTo(group);

        // íšŒì‚¬ëª… ë¼ë²¨(í•­ìƒ ë³´ì´ê²Œ)
        marker.bindTooltip(p.companyName || "", {
          permanent: true,
          direction: 'top',
          offset: [0, -8],
          className: 'lbl'
        }).openTooltip();

        // ìƒì„¸ íŒì—…
        marker.bindPopup(makePopupHtml(p), { maxWidth: 340 });

        // í´ë¦­ ì‹œ íŒì—… open
        marker.on('click', () => marker.openPopup());
      });

      // ë°ì´í„°ì— ë§ì¶° í™”ë©´ ê²½ê³„ ë§ì¶¤
      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    function makePopupHtml(p){
      const phoneBtn = (p.phone && isMobile()) 
        ? `<a class="btn" href="${telHref(p.phone)}">ğŸ“ ì „í™”</a>` 
        : "";
      const webBtn = p.website 
        ? `<a class="btn" href="${normalizeUrl(p.website)}" target="_blank" rel="noopener">ğŸŒ ì›¹ì‚¬ì´íŠ¸</a>` 
        : "";
      const smartBtn = `<button class="btn btn-primary" onclick='smartNavigate(${JSON.stringify({companyName:p.companyName,address:p.address,lat:p.lat,lng:p.lng})})'>ğŸš— ê¸¸ì°¾ê¸°</button>`;
      
      const cert = p.certificationDate 
        ? `<div class="detail">ì¸ì •ì¼ì: ${escapeHtml(p.certificationDate)}</div>` 
        : "";
      const ind = p.industryType 
        ? `<div class="detail">ì—…ì¢…: ${escapeHtml(p.industryType)}</div>` 
        : "";

      return `
        <div class="infocard">
          <h4>${escapeHtml(p.companyName)}</h4>
          <div class="detail">${escapeHtml(p.address || "")}</div>
          ${ind}
          ${cert}
          <div class="row">
            ${smartBtn}
            ${phoneBtn}
            ${webBtn}
          </div>
        </div>
      `;
    }
    
    // ì•± ì‹œì‘
    initApp();
  </script>
</body>
</html>