<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>KFPC 미래가치 계산기</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Malgun Gothic',sans-serif; background:#f9fafb; line-height:1.6; color:#1f2937; }
    .container { max-width:1280px; margin:0 auto; padding:20px; }
    .top-header { display:flex; align-items:center; gap:20px; margin-bottom:12px; padding:10px 0; }
    .top-header { position: relative; }
    .close-btn { position: absolute; top: 10px; right: 0; width: 40px; height: 40px; background: rgba(79, 70, 229, 0.1); border: 2px solid rgba(79, 70, 229, 0.3); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #4f46e5; transition: all 0.3s; z-index: 100; }
    .close-btn:hover { background: rgba(79, 70, 229, 0.2); transform: rotate(90deg); border-color: #4f46e5; }
    .close-btn:active { transform: rotate(90deg) scale(0.95); }
    .logo-kfpc { font-size:32px; font-weight:900; letter-spacing:3px; background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; text-shadow:0 2px 10px rgba(79,70,229,.3); }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:9999; padding:20px; }
    .modal-content { background:#fff; border-radius:16px; max-width:600px; width:100%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 25px -5px rgba(0,0,0,.1); }
    .modal-header { background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); color:#fff; padding:24px; border-radius:16px 16px 0 0; }
    .modal-header h2 { font-size:22px; font-weight:bold; margin-bottom:8px; }
    .modal-body { padding:24px; }
    .info-box { padding:16px; border-radius:8px; margin-bottom:16px; border-left:4px solid; }
    .info-box.blue { background:#eff6ff; border-color:#3b82f6; }
    .info-box.yellow { background:#fef3c7; border-color:#f59e0b; }
    .info-box.green { background:#d1fae5; border-color:#10b981; }
    .btn-primary{ width:100%; padding:16px; background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:bold; cursor:pointer; transition:.2s; }
    .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 10px 20px rgba(79,70,229,.3); }
    .card{ background:#fff; border-radius:12px; padding:16px 24px; box-shadow:0 1px 3px rgba(0,0,0,.1); margin-bottom:20px; }
    .card-header{ display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .icon-box{ width:48px; height:48px; background:#e0e7ff; border-radius:10px; display:flex; align-items:center; justify-content:center; }
    .form-group{ margin-bottom:20px; }
    .form-label{ display:block; font-weight:600; margin-bottom:8px; color:#374151; font-size:14px; }
    .input-wrapper{ position:relative; }
    .form-input{ width:100%; padding:12px; border:1px solid #d1d5db; border-radius:8px; font-size:16px; transition:.2s; }
    .form-input:focus{ outline:none; border-color:#4f46e5; box-shadow:0 0 0 3px rgba(79,70,229,.1); }
    .input-prefix,.input-suffix{ position:absolute; top:50%; transform:translateY(-50%); color:#6b7280; font-size:14px; }
    .input-prefix{ left:12px; } .input-suffix{ right:12px; }
    .has-prefix{ padding-left:32px; } .has-suffix{ padding-right:60px; }
    .form-hint{ margin-top:6px; font-size:12px; color:#6b7280; line-height:1.5; }
    .button-group{ display:flex; align-items:center; gap:8px; margin-top:8px; }
    .btn-toggle{ padding:6px 12px; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; background:#e5e7eb; color:#4b5563; transition:.2s; }
    .btn-toggle.active{ background:#4f46e5; color:#fff; }
    .btn-calculate{ width:100%; padding:14px; background:#f59e0b; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; margin-top:24px; transition:.2s; }
    .btn-calculate:hover{ background:#d97706; transform:translateY(-2px); box-shadow:0 6px 15px rgba(245,158,11,.3); }
    .result-card{ background:#fff; border-radius:12px; padding:24px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .result-header{ background:#312e81; color:#fff; padding:16px; border-radius:8px; margin-bottom:16px; }
    .result-row{ display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #e5e7eb; }
    .result-row:last-child{ border-bottom:none; }
    .result-explain{ background:#f3f4f6; padding:12px; border-radius:8px; margin-top:12px; font-size:13px; color:#4b5563; line-height:1.6; }
    .chart-section{ display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-top:24px; padding-top:24px; border-top:1px solid #e5e7eb; text-align:center; }
    .chart-color{ width:16px; height:16px; border-radius:4px; margin:0 auto 8px; }
    .chart-color.purple{ background:#8b5cf6; } .chart-color.blue{ background:#60a5fa; } .chart-color.yellow{ background:#fbbf24; }
    .chart-container{ margin-top:24px; padding:20px; background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .schedule-toggle{ width:100%; padding:16px; background:none; border:none; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:.2s; }
    .schedule-table{ width:100%; margin-top:16px; border-collapse:collapse; font-size:14px; }
    .schedule-table thead{ background:#312e81; color:#fff; }
    .schedule-table th,.schedule-table td{ padding:12px; text-align:left; border-bottom:1px solid #e5e7eb; }
    .hidden{ display:none; }
    .footer{ text-align:center; padding:30px 20px; color:#6b7280; font-size:13px; border-top:1px solid #e5e7eb; margin-top:40px; }
    @media (max-width:768px){
      .container{ padding:12px; } .top-header{ padding:8px 0; margin-bottom:10px; }
      .card{ padding:12px 16px; } .card-header{ gap:10px; margin-bottom:10px; }
      .modal-header h2{ font-size:18px; } .chart-section{ grid-template-columns:1fr; }
      .logo-kfpc{ font-size:26px; letter-spacing:2px; }
      .card-header h1{ font-size:18px !important; } .card-header p{ font-size:12px !important; }
      .schedule-table{ font-size:12px; } .schedule-table th,.schedule-table td{ padding:8px 6px; }
    }
    @media (min-width:1024px){ .main-grid{ display:grid; grid-template-columns:1fr 2fr; gap:24px; } }
  </style>
</head>
<body>
  <!-- 웰컴 모달 -->
  <div id="welcomeModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>🎉 KFPC 미래가치 계산기에 오신 것을 환영합니다!</h2>
        <p>당신의 투자 미래를 미리 확인해보세요</p>
      </div>
      <div class="modal-body">
        <div class="info-box blue">
          <h3 style="font-weight:bold; margin-bottom:8px;">💰 이 계산기로 무엇을 할 수 있나요?</h3>
          <p style="font-size:14px;">지금 투자한 돈이 미래에 얼마가 될지 정확하게 계산할 수 있습니다. 복리의 힘을 직접 확인하세요!</p>
        </div>
        <div class="info-box yellow">
          <h3 style="font-weight:bold; margin-bottom:12px;">📋 사용 방법</h3>
          <p style="font-size:14px;">
            <strong>1단계:</strong> 처음 투자할 금액 입력<br>
            <strong>2단계:</strong> 예상 수익률 입력 (은행 이자율, 주식 수익률 등)<br>
            <strong>3단계:</strong> 투자 기간 입력 (몇 년 동안 투자할지)<br>
            <strong>4단계:</strong> 매년 추가할 금액 입력 (선택사항)<br>
            <strong>5단계:</strong> 계산하기 버튼 클릭!
          </p>
        </div>
        <div class="info-box green">
          <h3 style="font-weight:bold; margin-bottom:8px;">📊 결과에서 확인할 수 있는 것</h3>
          <p style="font-size:14px;">• 최종 금액 (투자 후 받을 총 금액)<br>• 연도별 자산 증가 그래프<br>• 매년 잔액 상세 표</p>
        </div>
        <button class="btn-primary" onclick="closeModal()">확인, 계산기 사용하기 →</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="top-header"><div class="logo-kfpc">KFPC</div><div class="close-btn" onclick="closeAndGoHome()" title="닫기">✕</div></div>

    <div class="card">
      <div class="card-header">
        <div class="icon-box">
          <svg width="24" height="24" fill="none" stroke="#4f46e5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
          </svg>
        </div>
        <div>
          <h1 style="font-size:20px; font-weight:bold; margin-bottom:2px;">미래 가치 계산기</h1>
          <p style="font-size:13px; color:#6b7280;">투자의 미래 가치를 정확하게 계산합니다</p>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <!-- 입력 -->
      <div>
        <div class="card">
          <div class="form-group">
            <label class="form-label">처음 투자할 금액</label>
            <div class="input-wrapper">
              <span class="input-prefix">₩</span>
              <input type="text" id="presentValue" class="form-input has-prefix" value="10,000,000">
            </div>
            <p class="form-hint">💰 지금 가지고 있는 돈 또는 처음에 넣을 금액을 입력하세요</p>
          </div>

          <div class="form-group">
            <label class="form-label">예상 수익률 (연간)</label>
            <div class="input-wrapper">
              <input type="text" id="interestRate" class="form-input has-suffix" value="6">
              <span class="input-suffix">%</span>
            </div>
            <p class="form-hint">📈 1년에 몇 %의 수익을 기대하나요?</p>
          </div>

          <div class="form-group">
            <label class="form-label">투자 기간</label>
            <input type="text" id="periods" class="form-input" value="20">
            <p class="form-hint">⏰ 몇 년 동안 투자할 건가요? (숫자만 입력)</p>
          </div>

          <div class="form-group">
            <label class="form-label">매년 추가할 금액 (선택사항)</label>
            <div class="input-wrapper">
              <input type="text" id="periodicDeposit" class="form-input has-suffix" value="200,000">
              <span class="input-suffix">/ 년</span>
            </div>
            <div class="button-group">
              <span style="font-size:12px; color:#6b7280;">추가 시기:</span>
              <button class="btn-toggle active" id="btnBeginning" onclick="setTiming('beginning')">매년 초</button>
              <button class="btn-toggle" id="btnEnd" onclick="setTiming('end')">매년 말</button>
            </div>
            <p class="form-hint">💸 매년 추가로 저축할 금액 (안 하면 0)</p>
          </div>

          <button class="btn-calculate" onclick="calculate()">📊 계산하기</button>
        </div>
      </div>

      <!-- 결과 -->
      <div>
        <div id="resultArea" class="result-card" style="text-align:center; padding:48px 24px;">
          <svg width="64" height="64" fill="none" stroke="#d1d5db" viewBox="0 0 24 24" style="margin:0 auto 16px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
          </svg>
          <p style="color:#6b7280;">왼쪽에 정보를 입력하고<br><strong>계산하기</strong> 버튼을 눌러주세요</p>
        </div>
      </div>
    </div>

    <div class="footer">Copyright © 2025 KFPC Co., Ltd. All Rights Reserved.</div>
  </div>

  <script>
    let timing = 'beginning';
    let chartInstance = null;

    function closeModal(){ document.getElementById('welcomeModal').style.display='none'; }

    // 닫기 버튼 - index로 이동
    function closeAndGoHome() {
      window.location.href = 'index.html';
    }

    function formatNumber(v){ if(!v) return ''; const n=v.toString().replace(/[^\d]/g,''); return n.replace(/\B(?=(\d{3})+(?!\d))/g,','); }
    function parseNum(v){ if(!v) return 0; return parseFloat(v.toString().replace(/,/g,''))||0; }
    function formatCurrency(n){ return '₩'+Math.round(n).toLocaleString('ko-KR'); }

    function setTiming(t){
      timing=t;
      document.getElementById('btnBeginning').className = t==='beginning'?'btn-toggle active':'btn-toggle';
      document.getElementById('btnEnd').className       = t==='end'?'btn-toggle active':'btn-toggle';
    }

    document.getElementById('presentValue').addEventListener('input', e=> e.target.value = formatNumber(e.target.value));
    document.getElementById('periodicDeposit').addEventListener('input', e=> e.target.value = formatNumber(e.target.value));

    /* Chart.js 로딩 보장 */
    function ensureChartJs(cb){
      if(typeof Chart!=='undefined'){ cb(); return; }
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js';
      s.onload=cb;
      s.onerror=()=>{
        const s2=document.createElement('script');
        s2.src='https://unpkg.com/chart.js@4.4.6/dist/chart.umd.js';
        s2.onload=cb;
        s2.onerror=()=>{ console.error('Chart.js 로딩 실패'); alert('❌ 그래프 라이브러리 로딩 실패'); };
        document.head.appendChild(s2);
      };
      document.head.appendChild(s);
    }

    function calculate(){
      const pv = parseNum(document.getElementById('presentValue').value);
      const rate = parseFloat(document.getElementById('interestRate').value)/100 || 0;
      const n = parseInt(document.getElementById('periods').value) || 0;
      const pmt = parseNum(document.getElementById('periodicDeposit').value);

      if(n<=0){ alert('투자 기간을 1년 이상 입력해주세요.'); return; }

      const fvLump = pv * Math.pow(1+rate, n);
      let fvAnn = 0;
      if(pmt!==0 && rate!==0){
        fvAnn = pmt * ((Math.pow(1+rate,n)-1)/rate);
        if(timing==='beginning') fvAnn *= (1+rate);
      }else if(pmt!==0){ fvAnn = pmt * n; }

      const totalFV = fvLump + fvAnn;
      const totalDep = pmt * n;
      const totalInt = totalFV - pv - totalDep;

      const p1 = ((pv/totalFV)*100).toFixed(1);
      const p2 = ((totalDep/totalFV)*100).toFixed(1);
      const p3 = ((totalInt/totalFV)*100).toFixed(1);

      const schedule=[];
      for(let i=1;i<=n;i++){
        let beginBalance, interest, endBalance;
        if(i===1){
          if(timing==='beginning'){ beginBalance=pv+pmt; interest=beginBalance*rate; endBalance=beginBalance+interest; }
          else { beginBalance=pv; interest=beginBalance*rate; endBalance=beginBalance+interest+pmt; }
        }else{
          const prevEnd=schedule[i-2].endBalance;
          if(timing==='beginning'){ beginBalance=prevEnd+pmt; interest=beginBalance*rate; endBalance=beginBalance+interest; }
          else { beginBalance=prevEnd; interest=beginBalance*rate; endBalance=beginBalance+interest+pmt; }
        }
        schedule.push({ period:i, beginBalance, deposit:pmt, interest, endBalance });
      }

      let html = '<div class="result-header"><h3 style="font-size:20px;">💰 계산 결과</h3></div>';
      html += `<div class="result-row"><span>최종 금액 (미래 가치):</span><span style="font-weight:bold; font-size:20px; color:#4f46e5;">${formatCurrency(totalFV)}</span></div>`;
      html += `<div class="result-row"><span>처음 투자 금액:</span><span>${formatCurrency(pv)}</span></div>`;
      html += `<div class="result-row"><span>투자 기간:</span><span>${n}년</span></div>`;
      html += `<div class="result-row"><span>연 수익률:</span><span>${(rate*100).toFixed(2)}%</span></div>`;
      html += `<div class="result-row"><span>추가 저축 총액:</span><span style="color:#3b82f6;">${formatCurrency(totalDep)}</span></div>`;
      html += `<div class="result-row"><span>총 이자 수익:</span><span style="color:#10b981; font-weight:600;">${formatCurrency(totalInt)}</span></div>`;
      html += '<div class="result-explain"><strong>📊 결과 설명:</strong><br>';
      html += `${n}년 동안 연 ${(rate*100).toFixed(1)}%의 수익률로 투자하면, 처음 투자금 ${formatCurrency(pv)}이(가) <strong>${formatCurrency(totalFV)}</strong>으로 증가합니다. `;
      if(pmt>0){ html += `매년 ${formatCurrency(pmt)}씩 추가로 저축하면 총 ${formatCurrency(totalDep)}을(를) 더 넣게 되며, `; }
      html += `복리 효과로 <strong style="color:#10b981;">${formatCurrency(totalInt)}</strong>의 이자 수익이 발생합니다.</div>`;
      html += '<div class="chart-section">';
      html += `<div><div class="chart-color purple"></div><p style="font-size:12px; color:#6b7280;">시작 금액</p><p style="font-weight:600;">${p1}%</p></div>`;
      html += `<div><div class="chart-color blue"></div><p style="font-size:12px; color:#6b7280;">추가 저축</p><p style="font-weight:600;">${p2}%</p></div>`;
      html += `<div><div class="chart-color yellow"></div><p style="font-size:12px; color:#6b7280;">이자 수익</p><p style="font-weight:600;">${p3}%</p></div>`;
      html += '</div>';

      const area = document.getElementById('resultArea');
      area.innerHTML = html;
      area.style.textAlign='left'; area.style.padding='24px';

      ensureChartJs(()=>{ drawChart(schedule); addScheduleTable(schedule); });
    }

    function drawChart(schedule){
      // 고정 크기 설정 (반응형 리사이즈 OFF)
      const CHART_MAX_WIDTH = 900;   // 필요시 조절
      const CHART_HEIGHT    = 260;

      if(chartInstance){ try{ chartInstance.destroy(); }catch(e){} chartInstance=null; }
      const existing=document.querySelector('.chart-container'); if(existing) existing.remove();

      const container=document.getElementById('resultArea');

      const chartDiv=document.createElement('div');
      chartDiv.className='chart-container';
      chartDiv.style.maxWidth = CHART_MAX_WIDTH + 'px';
      chartDiv.style.margin   = '24px auto 0';

      const title=document.createElement('h3');
      title.style.marginBottom='16px'; title.style.fontSize='18px';
      title.innerHTML='📈 연도별 자산 증가 그래프';
      chartDiv.appendChild(title);

      const canvas=document.createElement('canvas');
      canvas.id='growthChart';
      const parentW = container.clientWidth || 800;
      const width   = Math.min(parentW, CHART_MAX_WIDTH);
      canvas.style.display='block';
      canvas.style.width  = width + 'px';
      canvas.style.height = CHART_HEIGHT + 'px';
      canvas.width  = width;          // 렌더 해상도
      canvas.height = CHART_HEIGHT;   // 렌더 해상도
      chartDiv.appendChild(canvas);

      container.appendChild(chartDiv);

      const labels   = schedule.map(s=>`${s.period}년차`);
      const balances = schedule.map(s=>s.endBalance);
      const interests= schedule.map(s=>s.interest);

      const ctx=canvas.getContext('2d');
      chartInstance = new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            { label:'총 자산', data:balances, borderColor:'#4f46e5', backgroundColor:'rgba(79,70,229,.1)', borderWidth:3, fill:true, tension:.4, pointRadius:2, pointHoverRadius:4 },
            { label:'연간 이자', data:interests, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.1)', borderWidth:2, fill:false, tension:.4, pointRadius:2, pointHoverRadius:4 }
          ]
        },
        options:{
          responsive:false,             // ✅ 무한 리사이즈 차단
          maintainAspectRatio:false,
          plugins:{
            legend:{ display:true, position:'top', labels:{ font:{ size:13, weight:'bold' }, padding:12 } },
            tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } }
          },
          scales:{
            x:{ ticks:{ maxTicksLimit:10 } },
            y:{ beginAtZero:true, ticks:{ callback:(v)=> v>=1_000_000 ? '₩'+(v/1_000_000).toFixed(1)+'M' : '₩'+Math.round(v).toLocaleString() } }
          }
        }
      });
      // 추가 resize 호출 없음 (루프 방지)
    }

    function addScheduleTable(schedule){
      const container=document.getElementById('resultArea');
      let html = '<div style="margin-top:24px; background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.1);">';
      html += '<button class="schedule-toggle" onclick="toggleSchedule()">';
      html += '<div><span style="font-size:18px; font-weight:600;">📋 연도별 상세 내역</span>';
      html += '<p style="font-size:12px; color:#6b7280; margin-top:4px;">매년 자산이 어떻게 증가하는지 자세히 확인하세요</p></div>';
      html += '<svg id="scheduleIcon" width="20" height="20" fill="none" stroke="#4f46e5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
      html += '</button>';
      html += '<div id="scheduleTable" class="hidden" style="overflow-x:auto;">';
      html += '<table class="schedule-table"><thead><tr>';
      html += '<th style="text-align:center;">연차</th><th>기간 시작 금액</th><th>추가 저축</th><th>발생 이자</th><th>기간 말 금액</th>';
      html += '</tr></thead><tbody>';
      for(const r of schedule){
        html += '<tr>';
        html += `<td style="text-align:center; font-weight:600;">${r.period}년</td>`;
        html += `<td>${formatCurrency(r.beginBalance)}</td>`;
        html += `<td style="color:#3b82f6;">${formatCurrency(r.deposit)}</td>`;
        html += `<td style="color:#10b981; font-weight:600;">${formatCurrency(r.interest)}</td>`;
        html += `<td style="font-weight:700; color:#4f46e5;">${formatCurrency(r.endBalance)}</td>`;
        html += '</tr>';
      }
      html += '</tbody></table></div></div>';
      container.insertAdjacentHTML('beforeend', html);
    }

    function toggleSchedule(){
      const table=document.getElementById('scheduleTable');
      const icon=document.getElementById('scheduleIcon');
      if(table.classList.contains('hidden')){ table.classList.remove('hidden'); icon.style.transform='rotate(180deg)'; }
      else { table.classList.add('hidden'); icon.style.transform='rotate(0deg)'; }
    }
  </script>

  <!-- Chart.js는 ensureChartJs로 동적 로딩됩니다 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer onload=""></script>
</body>
</html>