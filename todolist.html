<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Do List</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            padding: 20px;
            padding-top: 80px;
        }

        /* ìƒë‹¨ ê³ ì • í—¤ë” */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* ê²€ìƒ‰ ë°” */
        .search-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f1f3f4;
            padding: 6px 12px;
            border-radius: 24px;
            transition: all 0.3s;
        }

        .search-container:focus-within {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .search-input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
            width: 200px;
            color: #202124;
        }

        .search-input::placeholder {
            color: #5f6368;
        }

        .search-icon {
            color: #5f6368;
            font-size: 16px;
        }

        .search-clear {
            background: none;
            border: none;
            color: #5f6368;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            display: none;
        }

        .search-clear.show {
            display: block;
        }

        .search-results {
            font-size: 12px;
            color: #5f6368;
            white-space: nowrap;
        }

        .search-nav {
            display: flex;
            gap: 4px;
        }

        .search-nav-btn {
            background: none;
            border: 1px solid #dadce0;
            color: #5f6368;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .search-nav-btn:hover {
            background: #f1f3f4;
        }

        .search-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ê²€ìƒ‰ í•˜ì´ë¼ì´íŠ¸ */
        .search-highlight {
            background-color: #ffeb3b;
            padding: 2px 0;
            border-radius: 2px;
        }

        .search-highlight.current {
            background-color: #ff9800;
            color: white;
        }

        /* ë‚ ì§œ ì„ íƒ ë‹¬ë ¥ */
        .date-picker {
            position: fixed;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            min-width: 280px;
        }

        .date-picker.show {
            display: block;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .date-picker-title {
            font-size: 15px;
            font-weight: 600;
            color: #202124;
        }

        .date-picker-nav {
            display: flex;
            gap: 8px;
        }

        .date-picker-nav button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #5f6368;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .date-picker-nav button:hover {
            background: #f1f3f4;
        }

        .date-picker-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .date-picker-weekday {
            text-align: center;
            font-size: 12px;
            color: #5f6368;
            font-weight: 600;
            padding: 4px;
        }

        .date-picker-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .date-picker-day {
            aspect-ratio: 1;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 50%;
            font-size: 13px;
            color: #202124;
            transition: all 0.2s;
        }

        .date-picker-day:hover {
            background: #f1f3f4;
        }

        .date-picker-day.today {
            border: 2px solid #4285f4;
            font-weight: 600;
        }

        .date-picker-day.selected {
            background: #4285f4;
            color: white;
            font-weight: 600;
        }

        .date-picker-day.other-month {
            color: #9aa0a6;
        }

        .date-picker-day:disabled {
            color: #dadce0;
            cursor: not-allowed;
        }

        .date-picker-footer {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }

        .date-picker-footer button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .date-picker-today-btn {
            background: #f1f3f4;
            color: #202124;
        }

        .date-picker-today-btn:hover {
            background: #e8eaed;
        }

        .date-picker-clear-btn {
            background: white;
            border: 1px solid #dadce0 !important;
            color: #5f6368;
        }

        .date-picker-clear-btn:hover {
            background: #f8f9fa;
        }

        /* ë‚ ì§œ íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .date-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e8f0fe;
            color: #1967d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        .date-tag:hover {
            background: #d2e3fc;
        }

        .date-tag.past {
            background: #fce8e6;
            color: #c5221f;
        }

        .date-tag.today {
            background: #e6f4ea;
            color: #137333;
        }

        /* ì‚¬ìš©ì ê°€ì´ë“œ ì•„ì½”ë””ì–¸ */
        .guide-accordion {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #f8f9fa;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .guide-header:hover {
            background: #e8eaed;
        }

        .guide-title {
            font-size: 16px;
            font-weight: 600;
            color: #202124;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guide-toggle {
            font-size: 14px;
            color: #5f6368;
            transition: transform 0.3s;
        }

        .guide-toggle.open {
            transform: rotate(180deg);
        }

        .guide-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .guide-content.open {
            max-height: 2000px;
        }

        .guide-inner {
            padding: 20px;
            color: #202124;
            line-height: 1.6;
        }

        .guide-section {
            margin-bottom: 24px;
        }

        .guide-section:last-child {
            margin-bottom: 0;
        }

        .guide-section h3 {
            font-size: 15px;
            font-weight: 600;
            color: #1967d2;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .guide-section pre {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            border-left: 3px solid #4285f4;
            margin: 8px 0;
        }

        .guide-section ul {
            list-style: none;
            padding-left: 0;
        }

        .guide-section li {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
        }

        .guide-section li:before {
            content: "â€¢";
            position: absolute;
            left: 6px;
            color: #4285f4;
            font-weight: bold;
        }

        .guide-highlight {
            background: #fff59d;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }

        .guide-warning {
            background: #fef7e0;
            border-left: 3px solid #f9ab00;
            padding: 12px;
            border-radius: 4px;
            margin: 8px 0;
        }

        .guide-tip {
            background: #e8f0fe;
            border-left: 3px solid #1967d2;
            padding: 12px;
            border-radius: 4px;
            margin: 8px 0;
        }

        .btn {
            padding: 8px 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #3367d6;
        }

        .btn-secondary {
            background: #5f6368;
        }

        .btn-secondary:hover {
            background: #4a4d50;
        }

        /* ì‹¤ì‹œê°„ ë™ê¸°í™” ì•Œë¦¼ ë°°ë„ˆ */
        .sync-notification {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px 20px;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 999;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { top: 40px; opacity: 0; }
            to { top: 60px; opacity: 1; }
        }

        .sync-notification.show {
            display: flex;
        }

        .sync-notification .message {
            font-size: 14px;
            color: #856404;
            font-weight: 500;
        }

        .sync-notification .btn-update {
            padding: 6px 12px;
            background: #ffc107;
            color: #333;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .sync-notification .btn-update:hover {
            background: #ffb300;
        }

        .sync-notification .btn-dismiss {
            background: transparent;
            border: none;
            color: #856404;
            cursor: pointer;
            font-size: 18px;
            padding: 0 5px;
        }

        /* ì—°ê²° ìƒíƒœ í‘œì‹œ */
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #5f6368;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-dot.connected {
            background: #34a853;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot.syncing {
            background: #fbbc04;
            animation: blink 0.8s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .item {
            margin-bottom: 8px;
            position: relative;
        }

        .item-content {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background 0.15s;
            cursor: text;
        }

        .item-content:hover {
            background: #f8f9fa;
        }

        /* ì™„ë£Œ ì²´í¬ë°•ìŠ¤ */
        .checkbox {
            width: 18px;
            height: 18px;
            min-width: 18px;
            border: 2px solid #dadce0;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-top: 3px;
            flex-shrink: 0;
        }

        .checkbox:hover {
            border-color: #4285f4;
            background: #f8f9fa;
        }

        .checkbox.checked {
            background: #4285f4;
            border-color: #4285f4;
        }

        .checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* ë³„í‘œ (ì¤‘ìš” í‘œì‹œ) */
        .star {
            width: 20px;
            height: 20px;
            min-width: 20px;
            cursor: pointer;
            font-size: 16px;
            color: #dadce0;
            transition: all 0.2s;
            margin-top: 2px;
            flex-shrink: 0;
            user-select: none;
        }

        .star:hover {
            color: #fbbc04;
            transform: scale(1.2);
        }

        .star.important {
            color: #fbbc04;
        }

        /* ì™„ë£Œëœ í…ìŠ¤íŠ¸ */
        .text.completed {
            text-decoration: line-through;
            color: #9aa0a6;
        }

        .bullet {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #5f6368;
            margin-top: 5px;
            flex-shrink: 0;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .bullet::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            /* pointer-events: none ì œê±°í•˜ì—¬ í´ë¦­ ì˜ì—­ í™•ëŒ€ */
        }

        .bullet:hover {
            background: #4285f4;
            transform: scale(1.6);
            box-shadow: 0 0 0 8px rgba(66, 133, 244, 0.2);
        }

        .bullet:active {
            cursor: grabbing;
            background: #1967d2;
        }

        /* ë“œë˜ê·¸ í•¸ë“¤ */
        .drag-handle {
            color: #9aa0a6;
            font-size: 14px;
            font-weight: bold;
            cursor: grab;
            user-select: none;
            padding: 2px 4px;
            margin-left: -4px;
            opacity: 0;
            transition: opacity 0.2s;
            line-height: 1.5;
            flex-shrink: 0;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .item-content:hover .drag-handle {
            opacity: 1;
        }

        .drag-handle:hover {
            color: #4285f4;
            background: #f1f3f4;
            border-radius: 4px;
        }

        /* ìë¬¼ì‡  ì•„ì´ì½˜ */
        .lock-icon {
            font-size: 14px;
            cursor: pointer;
            margin-left: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            user-select: none;
        }

        .item-content:hover .lock-icon {
            opacity: 1;
        }

        .lock-icon.locked {
            opacity: 1;
        }

        .lock-icon:hover {
            transform: scale(1.2);
        }

        /* ë³´í˜¸ëœ í•­ëª© */
        .item-content.locked {
            background: #f5f5f5;
            border-left: 3px solid #9aa0a6;
            padding-left: 8px;
        }

        .item-content.locked .text {
            color: #5f6368;
            cursor: not-allowed;
            user-select: none;
        }

        .item-content.locked:hover {
            background: #eeeeee;
        }

        .text {
            flex: 1;
            min-height: 24px;
            line-height: 24px;
            outline: none;
            word-break: break-word;
            color: #000000;
        }

        .text:empty:before {
            content: attr(data-placeholder);
            color: #9aa0a6;
        }

        .text:focus {
            outline: none;
        }

        /* í•˜ì´ë¼ì´íŠ¸ ë° ìƒ‰ìƒ */
        /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ì„œì‹ */
        .bold { font-weight: 700; }
        .italic { font-style: italic; }
        .underline { text-decoration: underline; }
        .strikethrough { text-decoration: line-through; }
        
        /* í˜•ê´‘íœ ìƒ‰ìƒ - 8ì¢…ë¥˜ */
        .highlight-yellow { background-color: #fff59d; }
        .highlight-green { background-color: #c8e6c9; }
        .highlight-blue { background-color: #bbdefb; }
        .highlight-pink { background-color: #f8bbd0; }
        .highlight-orange { background-color: #ffccbc; }
        .highlight-purple { background-color: #e1bee7; }
        .highlight-cyan { background-color: #b2ebf2; }
        .highlight-lime { background-color: #f0f4c3; }
        
        /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ - 10ì¢…ë¥˜ */
        .text-red { color: #e53935; }
        .text-blue { color: #1e88e5; }
        .text-green { color: #43a047; }
        .text-purple { color: #8e24aa; }
        .text-orange { color: #fb8c00; }
        .text-pink { color: #d81b60; }
        .text-cyan { color: #00acc1; }
        .text-brown { color: #6d4c41; }
        .text-grey { color: #757575; }
        .text-black { color: #000000; }

        /* í¼ì¹˜ê¸°/ì ‘ê¸° í† ê¸€ ë²„íŠ¼ */
        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #5f6368;
            padding: 0;
            margin-left: auto;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
            user-select: none;
        }

        .toggle-btn:hover {
            background: #f1f3f4;
            border-radius: 4px;
        }

        .toggle-btn:active {
            background: #e8eaed;
        }

        @media (max-width: 768px) {
            .toggle-btn {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
        }

        /* ìì‹ ì•„ì´í…œ ë“¤ì—¬ì“°ê¸° */
        .children {
            margin-left: 30px;
            margin-top: 4px;
        }

        .children.collapsed {
            display: none;
        }

        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ í‘œì‹œ */
        .drag-over-top {
            border-top: 3px solid #4285f4;
            padding-top: 8px;
        }

        .drag-over-bottom {
            border-bottom: 3px solid #4285f4;
            padding-bottom: 8px;
        }

        .drag-over-child {
            background: #e8f0fe !important;
            border-left: 3px solid #4285f4;
            padding-left: 12px;
        }

        .dragging {
            opacity: 0.3;
            pointer-events: none;
        }

        /* ë“œë˜ê·¸ ì¤‘ ëª¨ë“  ê°€ëŠ¥í•œ ìœ„ì¹˜ í‘œì‹œ */
        .drag-active .item {
            position: relative;
        }

        .drag-active .item::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: transparent;
            transition: background 0.2s;
        }

        .drag-active .item:hover::before {
            background: #4285f4;
            opacity: 0.3;
        }

        /* ë“œë¡­ ê°€ì´ë“œ ë¼ì¸ */
        .drop-guide {
            position: absolute;
            height: 2px;
            background: #4285f4;
            left: 0;
            right: 0;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        .drop-guide.show {
            display: block;
            animation: guidePulse 0.5s infinite;
        }

        @keyframes guidePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .drop-guide::before {
            content: '';
            position: absolute;
            left: 0;
            top: -3px;
            width: 8px;
            height: 8px;
            background: #4285f4;
            border-radius: 50%;
        }

        /* ë ˆë²¨ í‘œì‹œ */
        .drag-level-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            display: none;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .drag-level-indicator.show {
            display: block;
        }

        /* í¬ë§· íˆ´ë°” */
        .format-toolbar {
            position: fixed;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 320px;
        }

        .format-toolbar.show {
            display: flex;
        }

        .format-toolbar-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 8px;
        }

        .format-toolbar-copy-btn {
            padding: 6px 12px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .format-toolbar-copy-btn:hover {
            background: #3367d6;
            transform: scale(1.05);
        }

        .format-toolbar-close-btn {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid #dadce0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: #5f6368;
            transition: all 0.2s;
            line-height: 1;
        }

        .format-toolbar-close-btn:hover {
            background: #f1f3f4;
            border-color: #5f6368;
            color: #202124;
        }

        .format-toolbar-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .format-toolbar-title {
            font-size: 11px;
            color: #5f6368;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .format-toolbar-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .format-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            min-width: 36px;
            text-align: center;
        }

        .format-btn:hover {
            background: #f1f3f4;
            border-color: #4285f4;
            transform: scale(1.05);
        }

        .format-btn-remove {
            background: #f44336;
            color: white;
            border: none;
            width: 100%;
            margin-top: 4px;
        }

        .format-btn-remove:hover {
            background: #d32f2f;
        }

        /* ì¤Œ í‘œì‹œ */
        .zoom-breadcrumb {
            padding: 10px 0;
            font-size: 14px;
            color: #5f6368;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }

        .zoom-breadcrumb:hover {
            color: #4285f4;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-top: 180px;
            }

            .container {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .header h1 {
                font-size: 16px;
            }

            .header-controls {
                width: 100%;
                flex-wrap: wrap;
                justify-content: space-between;
            }

            .search-container {
                order: -1;
                width: 100%;
                margin-bottom: 8px;
            }

            .search-input {
                width: 100%;
            }

            .search-results {
                order: -1;
            }

            .search-nav {
                order: -1;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .sync-notification {
                top: 160px;
                left: 10px;
                right: 10px;
                transform: none;
                width: auto;
            }

            .children {
                margin-left: 20px;
            }

            /* ëª¨ë°”ì¼ í¬ë§· íˆ´ë°” */
            .format-toolbar {
                max-width: calc(100vw - 20px);
                left: 10px !important;
                right: 10px;
            }

            .format-btn {
                padding: 10px 8px;
                min-width: 32px;
                font-size: 12px;
            }

            /* ëª¨ë°”ì¼ ë‚ ì§œ ì„ íƒê¸° */
            .date-picker {
                left: 10px !important;
                right: 10px;
                max-width: calc(100vw - 20px);
                width: auto;
            }

            .date-picker-day {
                font-size: 14px;
                padding: 12px 0;
            }

            /* ëª¨ë°”ì¼ ìë¬¼ì‡  ì•„ì´ì½˜ - í•­ìƒ í‘œì‹œ */
            .lock-icon {
                opacity: 1 !important;
                font-size: 18px;
                display: inline-block !important;
                visibility: visible !important;
                padding: 4px;
                margin: -4px;
                margin-left: 6px;
            }

            .item-content {
                padding: 8px;
            }

            /* ëª¨ë°”ì¼ ë“œë˜ê·¸ í•¸ë“¤ - í•­ìƒ í‘œì‹œ */
            .drag-handle {
                opacity: 1;
                font-size: 16px;
            }

            /* ëª¨ë°”ì¼ í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
            .checkbox {
                width: 22px;
                height: 22px;
                min-width: 22px;
            }

            .star {
                font-size: 20px;
                width: 24px;
                height: 24px;
                min-width: 24px;
            }

            .bullet {
                width: 16px;
                height: 16px;
                /* ::beforeë¥¼ í†µí•´ í„°ì¹˜ ì˜ì—­ ì´ë¯¸ í™•ëŒ€ë˜ì–´ ìˆìŒ */
            }

            /* ëª¨ë°”ì¼ ê°€ì´ë“œ */
            .guide-accordion {
                margin-bottom: 15px;
            }

            .guide-header {
                padding: 12px 15px;
            }

            .guide-title {
                font-size: 14px;
            }

            .guide-inner {
                padding: 15px;
            }

            .guide-section h3 {
                font-size: 14px;
            }

            .guide-section pre {
                font-size: 12px;
                padding: 10px;
            }
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <h1>ğŸ“ To Do List</h1>
        <div class="header-controls">
            <!-- ê²€ìƒ‰ ë°” -->
            <div class="search-container">
                <span class="search-icon">ğŸ”</span>
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="ê²€ìƒ‰..." 
                       oninput="handleSearch()"
                       onkeydown="handleSearchKeydown(event)">
                <button class="search-clear" id="searchClear" onclick="clearSearch()">Ã—</button>
            </div>
            <div class="search-results" id="searchResults" style="display:none;"></div>
            <div class="search-nav" id="searchNav" style="display:none;">
                <button class="search-nav-btn" onclick="prevSearchResult()">â†‘</button>
                <button class="search-nav-btn" onclick="nextSearchResult()">â†“</button>
            </div>
            
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ì˜¤í”„ë¼ì¸</span>
            </div>
            <button class="btn" id="connectBtn" onclick="connectDrive()">â˜ï¸ Drive ì—°ê²°</button>
            <button class="btn btn-secondary" id="saveBtn" onclick="saveToDrive()" style="display:none;">
                ğŸ’¾ ì €ì¥
            </button>
            <button class="btn btn-secondary" id="loadBtn" onclick="loadFromDrive()" style="display:none;">
                ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
        </div>
    </div>

    <!-- ì‹¤ì‹œê°„ ë™ê¸°í™” ì•Œë¦¼ -->
    <div class="sync-notification" id="syncNotification">
        <span class="message">ğŸ”„ ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤!</span>
        <button class="btn-update" onclick="updateFromCloud()">ì—…ë°ì´íŠ¸</button>
        <button class="btn-dismiss" onclick="dismissNotification()">Ã—</button>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container">
        <div id="zoomBreadcrumb" class="zoom-breadcrumb" style="display:none;" onclick="zoomOut()">
            â† ëŒì•„ê°€ê¸°
        </div>

        <!-- ì‚¬ìš© ê°€ì´ë“œ -->
        <div class="guide-accordion">
            <div class="guide-header" onclick="toggleGuide()">
                <span class="guide-title">ğŸ’¡ ë¹ ë¥¸ ì‹œì‘ ê°€ì´ë“œ</span>
                <span class="guide-toggle" id="guideToggle">â–¼</span>
            </div>
            <div class="guide-content" id="guideContent">
                <div class="guide-inner">
                    
                    <!-- í•„ìˆ˜ ë‹¨ì¶•í‚¤ -->
                    <div class="guide-section">
                        <h3>âŒ¨ï¸ í•„ìˆ˜ ë‹¨ì¶•í‚¤ (PC)</h3>
                        <pre>Enter          ìƒˆ ì¤„ ìƒì„±
Tab            ë“¤ì—¬ì“°ê¸° (ìì‹ìœ¼ë¡œ)
Shift+Tab      ë‚´ì–´ì“°ê¸° (ë¶€ëª¨ë¡œ)
@              ë‚ ì§œ ì…ë ¥
Backspace      ë¹ˆ ì¤„ì—ì„œ ëˆ„ë¥´ë©´ ì‚­ì œ</pre>
                        <p style="font-size: 13px; color: #5f6368; margin-top: 8px;">
                            ğŸ“± <strong>ëª¨ë°”ì¼:</strong> ë“¤ì—¬ì“°ê¸°ëŠ” ì (â—)ì„ í•œ ë²ˆ íƒ­í•˜ì„¸ìš”
                        </p>
                    </div>

                    <!-- í•µì‹¬ ê¸°ëŠ¥ -->
                    <div class="guide-section">
                        <h3>ğŸ¯ í•µì‹¬ ê¸°ëŠ¥</h3>
                        <ul>
                            <li><span class="guide-highlight">ğŸ“… ë‚ ì§œ ì…ë ¥:</span> @ ì…ë ¥ â†’ ë‹¬ë ¥ íŒì—… â†’ ë‚ ì§œ ì„ íƒ (ì˜ˆ: ğŸ“… 01-15 (ìˆ˜))</li>
                            <li><span class="guide-highlight">ğŸ”’ í–‰ ë³´í˜¸:</span> í˜¸ë²„ â†’ ğŸ”“ í´ë¦­ â†’ ë³´í˜¸ í™œì„±í™” (í¸ì§‘/ì‚­ì œ ë¶ˆê°€)</li>
                            <li><span class="guide-highlight">âœï¸ í…ìŠ¤íŠ¸ ì„œì‹:</span> í…ìŠ¤íŠ¸ ì„ íƒ â†’ ìë™ íŒì—… (ë³¼ë“œ/ì´íƒ¤ë¦­/ë°‘ì¤„/ì·¨ì†Œì„ /í˜•ê´‘íœ 8ì¢…/ê¸€ììƒ‰ 10ì¢…)</li>
                            <li><span class="guide-highlight">ğŸ” ê²€ìƒ‰:</span> ìƒë‹¨ ê²€ìƒ‰ì°½ ì…ë ¥ â†’ ì‹¤ì‹œê°„ ê²°ê³¼ â†’ â†‘â†“ ë˜ëŠ” Enterë¡œ ì´ë™</li>
                            <li><span class="guide-highlight">ğŸ¯ ë“œë˜ê·¸ ì´ë™:</span> 
                                <br>â†’ <strong>PC:</strong> ì²´í¬ë°•ìŠ¤ì™€ ë³„ ì‚¬ì´ì˜ ê²€ì€ ì (â—)ì„ ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•˜ê³  ë“œë˜ê·¸
                                <br>â†’ ì  ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ <strong>íŒŒë€ìƒ‰</strong>ìœ¼ë¡œ ì»¤ì§‘ë‹ˆë‹¤
                                <br>â†’ <strong>ëª¨ë°”ì¼:</strong> ì ì„ 0.5ì´ˆ ê¸¸ê²Œ ëˆ„ë¥¸ í›„ ì´ë™
                                <br>â†’ <strong>ëª¨ë°”ì¼ ë“¤ì—¬ì“°ê¸°:</strong> ì ì„ í•œ ë²ˆ íƒ­í•˜ë©´ í•˜ìœ„ ë ˆë²¨ë¡œ ì´ë™
                            </li>
                        </ul>
                    </div>

                    <!-- í´ë¼ìš°ë“œ ë™ê¸°í™” -->
                    <div class="guide-section">
                        <h3>â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” (ì¤‘ìš”!)</h3>
                        <div class="guide-tip">
                            <strong>ğŸ“Œ ì²« ì„¤ì •:</strong> [Drive ì—°ê²°] í´ë¦­ â†’ Google ë¡œê·¸ì¸ â†’ ê¶Œí•œ ìŠ¹ì¸
                        </div>
                        <ul>
                            <li>30ì´ˆë§ˆë‹¤ ìë™ ì €ì¥</li>
                            <li>10ì´ˆë§ˆë‹¤ ìµœì‹  ë²„ì „ í™•ì¸</li>
                            <li>ë‹¤ë¥¸ ê¸°ê¸°: ê°™ì€ Google ê³„ì • ë¡œê·¸ì¸ â†’ [ë¶ˆëŸ¬ì˜¤ê¸°] í´ë¦­</li>
                            <li>ì˜¤í”„ë¼ì¸ ì‚¬ìš© ê°€ëŠ¥ (ë¡œì»¬ ì €ì¥)</li>
                        </ul>
                    </div>

                    <!-- ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  ì‚¬í•­ -->
                    <div class="guide-section">
                        <h3>âš ï¸ ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  ì‚¬í•­</h3>
                        <div class="guide-warning">
                            <strong>1. ë³´í˜¸ëœ í•­ëª© (ğŸ”’):</strong> í¸ì§‘/ì‚­ì œ ë¶ˆê°€ â†’ ë¨¼ì € ğŸ”“ë¡œ í•´ì œ í•„ìš”<br>
                            <strong>2. ë‚ ì§œ í˜•ì‹:</strong> ì—°ë„ í‘œì‹œ ì•ˆ ë¨ (ì›”-ì¼ë§Œ, ì˜ˆ: 01-15 (ìˆ˜))<br>
                            <strong>3. ë“œë˜ê·¸ ì œí•œ:</strong> ë¶€ëª¨ë¥¼ ìì‹ìœ¼ë¡œ ì´ë™ ë¶ˆê°€ (ìˆœí™˜ ë°©ì§€)<br>
                            <strong>4. ìë™ ì €ì¥:</strong> 30ì´ˆë§ˆë‹¤ ìë™ ì €ì¥ (ì†ì‹¤ ê±±ì • NO)
                        </div>
                    </div>

                    <!-- ìœ ìš©í•œ íŒ -->
                    <div class="guide-section">
                        <h3>ğŸ’¡ ìœ ìš©í•œ íŒ</h3>
                        <ul>
                            <li>Bullet (â€¢) í´ë¦­ â†’ í•´ë‹¹ í•­ëª©ë§Œ ì§‘ì¤‘ ë³´ê¸°</li>
                            <li>ì¤‘ìš” í•­ëª©ì€ ğŸ”’ ë³´í˜¸ë¡œ ì‹¤ìˆ˜ ë°©ì§€</li>
                            <li>ì™„ë£Œëœ ì‘ì—…ë„ ğŸ”’ ê±¸ì–´ì„œ ë³´ì¡´</li>
                            <li>@ë‚ ì§œë¡œ ë§ˆê°ì¼ í‘œì‹œ</li>
                            <li>ìƒ‰ìƒìœ¼ë¡œ ìš°ì„ ìˆœìœ„ êµ¬ë¶„</li>
                        </ul>
                    </div>

                    <!-- ë¬¸ì œ í•´ê²° -->
                    <div class="guide-section">
                        <h3>ğŸš¨ ë¬¸ì œ í•´ê²°</h3>
                        <pre>í¸ì§‘ ì•ˆ ë¨    â†’ ğŸ”’ í™•ì¸ í›„ í•´ì œ
ë™ê¸°í™” ì•ˆ ë¨  â†’ [ë¶ˆëŸ¬ì˜¤ê¸°] í´ë¦­
ë‚´ìš© ì‚¬ë¼ì§   â†’ [ë¶ˆëŸ¬ì˜¤ê¸°]ë¡œ ë³µêµ¬</pre>
                    </div>

                    <!-- 3ì¤„ ìš”ì•½ -->
                    <div class="guide-section">
                        <div class="guide-tip">
                            <strong>ğŸ“ 3ì¤„ ìš”ì•½:</strong><br>
                            1. Enterë¡œ ì¤„ ì¶”ê°€, Tabìœ¼ë¡œ ë“¤ì—¬ì“°ê¸°<br>
                            2. @ë‚ ì§œ, ğŸ”’ë³´í˜¸, ìƒ‰ìƒ ê¸°ëŠ¥ í™œìš©<br>
                            3. Google Drive ì—°ê²°í•˜ë©´ ìë™ ë°±ì—…
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="root"></div>
        <!-- ë“œë¡­ ê°€ì´ë“œ ë¼ì¸ -->
        <div class="drop-guide" id="dropGuide"></div>
    </div>

    <!-- ë ˆë²¨ í‘œì‹œ -->
    <div class="drag-level-indicator" id="levelIndicator">ë ˆë²¨ 0</div>

    <!-- ë‚ ì§œ ì„ íƒ ë‹¬ë ¥ -->
    <div class="date-picker" id="datePicker">
        <div class="date-picker-header">
            <div class="date-picker-title" id="datePickerTitle">2025ë…„ 1ì›”</div>
            <div class="date-picker-nav">
                <button onclick="prevMonth()">â—€</button>
                <button onclick="nextMonth()">â–¶</button>
            </div>
        </div>
        <div class="date-picker-weekdays">
            <div class="date-picker-weekday">ì¼</div>
            <div class="date-picker-weekday">ì›”</div>
            <div class="date-picker-weekday">í™”</div>
            <div class="date-picker-weekday">ìˆ˜</div>
            <div class="date-picker-weekday">ëª©</div>
            <div class="date-picker-weekday">ê¸ˆ</div>
            <div class="date-picker-weekday">í† </div>
        </div>
        <div class="date-picker-days" id="datePickerDays"></div>
        <div class="date-picker-footer">
            <button class="date-picker-today-btn" onclick="selectToday()">ì˜¤ëŠ˜</button>
            <button class="date-picker-clear-btn" onclick="closeDatePicker()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- í¬ë§· íˆ´ë°” -->
    <div class="format-toolbar" id="formatToolbar">
        <!-- íˆ´ë°” í—¤ë” -->
        <div class="format-toolbar-header">
            <button class="format-toolbar-copy-btn" onclick="copySelectedText()" title="ì„ íƒí•œ í…ìŠ¤íŠ¸ ë³µì‚¬">ğŸ“‹ ê¸€ìë³µì‚¬</button>
            <button class="format-toolbar-close-btn" onclick="closeFormatToolbar()" title="ë‹«ê¸°">âœ•</button>
        </div>
        
        <!-- ê¸°ë³¸ ì„œì‹ ì„¹ì…˜ -->
        <div class="format-toolbar-section">
            <div class="format-toolbar-title">âœï¸ ê¸°ë³¸ ì„œì‹</div>
            <div class="format-toolbar-row">
                <button class="format-btn" onclick="applyFormat('bold')" title="êµµê²Œ"><strong>B</strong></button>
                <button class="format-btn" onclick="applyFormat('italic')" title="ê¸°ìš¸ì„"><em>I</em></button>
                <button class="format-btn" onclick="applyFormat('underline')" title="ë°‘ì¤„"><u>U</u></button>
                <button class="format-btn" onclick="applyFormat('strikethrough')" title="ì·¨ì†Œì„ "><s>S</s></button>
            </div>
        </div>
        
        <!-- í˜•ê´‘íœ ì„¹ì…˜ -->
        <div class="format-toolbar-section">
            <div class="format-toolbar-title">ğŸ–ï¸ í˜•ê´‘íœ</div>
            <div class="format-toolbar-row">
                <button class="format-btn" onclick="applyFormat('highlight-yellow')" style="background:#fff59d;" title="ë…¸ë€ìƒ‰">ë…¸</button>
                <button class="format-btn" onclick="applyFormat('highlight-green')" style="background:#c8e6c9;" title="ì´ˆë¡ìƒ‰">ì´ˆ</button>
                <button class="format-btn" onclick="applyFormat('highlight-blue')" style="background:#bbdefb;" title="íŒŒë€ìƒ‰">íŒŒ</button>
                <button class="format-btn" onclick="applyFormat('highlight-pink')" style="background:#f8bbd0;" title="ë¶„í™ìƒ‰">ë¶„</button>
                <button class="format-btn" onclick="applyFormat('highlight-orange')" style="background:#ffccbc;" title="ì£¼í™©ìƒ‰">ì£¼</button>
                <button class="format-btn" onclick="applyFormat('highlight-purple')" style="background:#e1bee7;" title="ë³´ë¼ìƒ‰">ë³´</button>
                <button class="format-btn" onclick="applyFormat('highlight-cyan')" style="background:#b2ebf2;" title="ì²­ë¡ìƒ‰">ì²­</button>
                <button class="format-btn" onclick="applyFormat('highlight-lime')" style="background:#f0f4c3;" title="ì—°ë‘ìƒ‰">ì—°</button>
            </div>
        </div>
        
        <!-- í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì„¹ì…˜ -->
        <div class="format-toolbar-section">
            <div class="format-toolbar-title">ğŸ¨ ê¸€ì ìƒ‰</div>
            <div class="format-toolbar-row">
                <button class="format-btn" onclick="applyFormat('text-red')" style="color:#e53935;" title="ë¹¨ê°•">A</button>
                <button class="format-btn" onclick="applyFormat('text-blue')" style="color:#1e88e5;" title="íŒŒë‘">A</button>
                <button class="format-btn" onclick="applyFormat('text-green')" style="color:#43a047;" title="ì´ˆë¡">A</button>
                <button class="format-btn" onclick="applyFormat('text-purple')" style="color:#8e24aa;" title="ë³´ë¼">A</button>
                <button class="format-btn" onclick="applyFormat('text-orange')" style="color:#fb8c00;" title="ì£¼í™©">A</button>
                <button class="format-btn" onclick="applyFormat('text-pink')" style="color:#d81b60;" title="ë¶„í™">A</button>
                <button class="format-btn" onclick="applyFormat('text-cyan')" style="color:#00acc1;" title="ì²­ë¡">A</button>
                <button class="format-btn" onclick="applyFormat('text-brown')" style="color:#6d4c41;" title="ê°ˆìƒ‰">A</button>
                <button class="format-btn" onclick="applyFormat('text-grey')" style="color:#757575;" title="íšŒìƒ‰">A</button>
                <button class="format-btn" onclick="applyFormat('text-black')" style="color:#000000;" title="ê²€ì •">A</button>
            </div>
        </div>
        
        <!-- ì œê±° ë²„íŠ¼ -->
        <button class="format-btn format-btn-remove" onclick="removeFormat()">âœ• ì„œì‹ ì œê±°</button>
    </div>

    <script>
        // ========================================
        // ì „ì—­ ë³€ìˆ˜
        // ========================================
        let data = {
            items: [],
            zoomedItem: null
        };
        
        let accessToken = sessionStorage.getItem('gdrive_token');
        let fileId = localStorage.getItem('gdrive_file_id');
        let isConnected = false;
        let autoSaveInterval = null;
        let syncCheckInterval = null;
        let lastModifiedTime = null;
        let isEditing = false;
        let editTimeout = null;

        // Google Drive API ì„¤ì •
        const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAVtAzm9UjgGB1pqChvGvGKH7RpH0KCiVM';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';

        // ========================================
        // Firebase + Google Drive í†µí•© (FMA ë°©ì‹)
        // ========================================
        
        // ì•”í˜¸í™” í‚¤ ë° Google Client ID
        const ENCRYPTION_KEY = "K7mP9nR4sT2vX8wY3zA6bC1dE5fG0hJ9";
        const GOOGLE_CLIENT_ID = "1012609333373-7dtjkn5j0fqkk7u3qhvftvk7jkh5r1md.apps.googleusercontent.com";
        
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
            authDomain: "kfpc-company-support-project.firebaseapp.com",
            databaseURL: "https://kfpc-company-support-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kfpc-company-support-project",
            storageBucket: "kfpc-company-support-project.firebasestorage.app",
            messagingSenderId: "1012609333373",
            appId: "1:1012609333373:web:ffba9039a7f9568356d914",
            measurementId: "G-Y757PLYBEE"
        };
        
        // Firebase ì´ˆê¸°í™”
        let firebaseAuth = null;
        let currentUser = null;
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                firebaseAuth = firebase.auth();
            }
        } catch (error) {
            console.warn('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        }
        
        // ìƒˆë¡œìš´ Google Drive ë³€ìˆ˜ë“¤
        let newAccessToken = null;
        let tokenClient = null;
        let gisInited = false;
        
        // ========================================
        // ì•”í˜¸í™” í•¨ìˆ˜ë“¤
        // ========================================
        
        const encryptData = (data) => {
            return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
        };
        
        const decryptData = (encryptedData) => {
            const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        };
        
        // ========================================
        // Google Drive í•¨ìˆ˜ë“¤ (FMA ë°©ì‹)
        // ========================================
        
        // ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥/ë³µì›
        const saveLoginState = () => {
            if (newAccessToken) {
                localStorage.setItem('googleAccessToken', newAccessToken);
                localStorage.setItem('tokenExpiry', Date.now() + 3600000);
            }
        };
        
        const restoreLoginState = () => {
            const token = localStorage.getItem('googleAccessToken');
            const expiry = localStorage.getItem('tokenExpiry');
            
            if (token && expiry && Date.now() < parseInt(expiry)) {
                newAccessToken = token;
                return true;
            }
            
            localStorage.removeItem('googleAccessToken');
            localStorage.removeItem('tokenExpiry');
            return false;
        };
        
        // Google Identity Services ì´ˆê¸°í™”
        const initGoogleDrive = async () => {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkGIS = setInterval(() => {
                    attempts++;
                    if (window.google && window.google.accounts) {
                        clearInterval(checkGIS);
                        
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: GOOGLE_CLIENT_ID,
                            scope: 'https://www.googleapis.com/auth/drive.file',
                            callback: (response) => {
                                if (response.error) {
                                    console.error('âŒ ì¸ì¦ ì˜¤ë¥˜:', response.error);
                                    alert('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.error);
                                } else {
                                    newAccessToken = response.access_token;
                                    saveLoginState();
                                    gisInited = true;
                                    console.log('âœ… Google Drive ì¸ì¦ ì™„ë£Œ');
                                    onNewDriveConnected();
                                }
                            },
                        });
                        
                        gisInited = true;
                        resolve();
                    }
                    
                    if (attempts >= maxAttempts) {
                        clearInterval(checkGIS);
                        console.error('âŒ Google Identity Services ë¡œë“œ ì‹¤íŒ¨');
                        resolve();
                    }
                }, 100);
            });
        };
        
        // Drive ì ‘ê·¼ ê¶Œí•œ ìš”ì²­
        const requestDriveAccess = async () => {
            if (newAccessToken) {
                const expiry = localStorage.getItem('tokenExpiry');
                if (expiry && Date.now() < parseInt(expiry)) {
                    return true;
                }
            }
            
            if (!gisInited) {
                await initGoogleDrive();
            }
            
            return new Promise((resolve) => {
                if (!tokenClient) {
                    console.error('âŒ Token Clientê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    resolve(false);
                    return;
                }
                
                const originalCallback = tokenClient.callback;
                tokenClient.callback = (response) => {
                    tokenClient.callback = originalCallback;
                    if (response.error) {
                        resolve(false);
                    } else {
                        newAccessToken = response.access_token;
                        saveLoginState();
                        resolve(true);
                    }
                };
                
                tokenClient.requestAccessToken();
            });
        };
        
        // íŒŒì¼ ì°¾ê¸°
        const findFile = async (fileName) => {
            try {
                await requestDriveAccess();
                
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='${fileName}'&fields=files(id,name,modifiedTime)`,
                    {
                        headers: { 'Authorization': `Bearer ${newAccessToken}` }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }
                
                const data = await response.json();
                return data.files && data.files.length > 0 ? data.files[0] : null;
            } catch (error) {
                console.error('âŒ íŒŒì¼ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                return null;
            }
        };
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const downloadFromDrive = async (fileId) => {
            try {
                await requestDriveAccess();
                
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    {
                        headers: { 'Authorization': `Bearer ${newAccessToken}` }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Download failed: ${response.status}`);
                }
                
                return await response.text();
            } catch (error) {
                console.error('âŒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                return null;
            }
        };
        
        // íŒŒì¼ ì—…ë¡œë“œ
        const uploadToDrive = async (fileName, content) => {
            try {
                await requestDriveAccess();
                
                const metadata = {
                    name: fileName,
                    mimeType: 'application/octet-stream'
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([content], { type: 'application/octet-stream' }));
                
                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${newAccessToken}` },
                        body: form
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('âŒ íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                return null;
            }
        };
        
        // íŒŒì¼ ì—…ë°ì´íŠ¸
        const updateFile = async (fileId, content) => {
            try {
                await requestDriveAccess();
                
                const response = await fetch(
                    `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${newAccessToken}`,
                            'Content-Type': 'application/octet-stream'
                        },
                        body: content
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Update failed: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('âŒ íŒŒì¼ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                return null;
            }
        };
        
        // ë“œë¼ì´ë¸Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        const loadFromNewDrive = async () => {
            try {
                const file = await findFile('todolist.tdd');
                
                if (file) {
                    const encryptedData = await downloadFromDrive(file.id);
                    if (encryptedData) {
                        const todoData = decryptData(encryptedData);
                        console.log('âœ… To Do List ë¡œë“œ ì™„ë£Œ');
                        return todoData;
                    }
                }
                
                console.log('â„¹ï¸ ì €ì¥ëœ To Do List ì—†ìŒ');
                return null;
            } catch (error) {
                console.error('âŒ ë“œë¼ì´ë¸Œ ë¡œë“œ ì˜¤ë¥˜:', error);
                return null;
            }
        };
        
        // ë“œë¼ì´ë¸Œì— ì €ì¥
        const saveToNewDrive = async (todoData) => {
            try {
                const encrypted = encryptData(todoData);
                const file = await findFile('todolist.tdd');
                
                if (file) {
                    await updateFile(file.id, encrypted);
                    console.log('âœ… To Do List ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    await uploadToDrive('todolist.tdd', encrypted);
                    console.log('âœ… To Do List ì €ì¥ ì™„ë£Œ');
                }
                
                return true;
            } catch (error) {
                console.error('âŒ ë“œë¼ì´ë¸Œ ì €ì¥ ì˜¤ë¥˜:', error);
                return false;
            }
        };
        
        // ìƒˆë¡œìš´ Drive ì—°ê²° ì™„ë£Œ ì‹œ
        const onNewDriveConnected = async () => {
            console.log('âœ… ìƒˆë¡œìš´ Google Drive ì—°ê²° ì™„ë£Œ');
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('statusDot').className = 'status-dot connected';
            document.getElementById('statusText').textContent = 'ì—°ê²°ë¨';
            
            // Firebase ë¡œê·¸ì¸ ì²´í¬
            if (firebaseAuth) {
                await checkFirebaseLogin();
            }
            
            // ìë™ìœ¼ë¡œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            const savedData = await loadFromNewDrive();
            if (savedData) {
                data = savedData;
                render();
                showToast('âœ… ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
            }
            
            // ìë™ ì €ì¥ ì‹œì‘ (5ë¶„ë§ˆë‹¤)
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            autoSaveInterval = setInterval(async () => {
                await saveToNewDrive(data);
                console.log('ğŸ”„ ìë™ ì €ì¥ ì™„ë£Œ');
            }, 300000); // 5ë¶„
            
            showToast('âœ… Google Drive ì—°ê²° ì™„ë£Œ!');
        };
        
        // Firebase ë¡œê·¸ì¸ ì²´í¬
        const checkFirebaseLogin = async () => {
            if (!firebaseAuth) return;
            
            return new Promise((resolve) => {
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        console.log('âœ… Firebase ë¡œê·¸ì¸ ì™„ë£Œ:', user.email);
                        resolve(true);
                    } else {
                        console.log('â„¹ï¸ Firebase ë¡œê·¸ì¸ í•„ìš”');
                        
                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            await firebaseAuth.signInWithPopup(provider);
                            console.log('âœ… Firebase ìë™ ë¡œê·¸ì¸ ì™„ë£Œ');
                            resolve(true);
                        } catch (error) {
                            console.warn('Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                            resolve(false);
                        }
                    }
                });
            });
        };

        // ========================================
        // ê°€ì´ë“œ ì•„ì½”ë””ì–¸
        // ========================================
        function toggleGuide() {
            const content = document.getElementById('guideContent');
            const toggle = document.getElementById('guideToggle');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                toggle.classList.remove('open');
            } else {
                content.classList.add('open');
                toggle.classList.add('open');
            }
        }

        // ========================================
        // ì´ˆê¸°í™”
        // ========================================
        window.onload = function() {
            loadFromLocalStorage();
            render();
            
            // ìƒˆë¡œìš´ Google Drive ì´ˆê¸°í™” ì‹œì‘
            initGoogleDrive().then(() => {
                // ì €ì¥ëœ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                if (restoreLoginState()) {
                    console.log('âœ… ë¡œê·¸ì¸ ìƒíƒœ ë³µì›');
                    onNewDriveConnected();
                } else {
                    console.log('â„¹ï¸ ë¡œê·¸ì¸ í•„ìš”');
                    // Drive ì—°ê²° ë²„íŠ¼ í™œì„±í™”
                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'â˜ï¸ Drive ì—°ê²°';
                    connectBtn.style.opacity = '1';
                    connectBtn.style.cursor = 'pointer';
                }
            });
            
            // Google Drive ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ - ì¤€ë¹„ ì¤‘
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.style.display = 'inline-block';
            connectBtn.disabled = true;
            connectBtn.textContent = 'â³ ì¤€ë¹„ ì¤‘...';
            connectBtn.style.opacity = '0.6';
            connectBtn.style.cursor = 'not-allowed';
            document.getElementById('statusText').textContent = 'ì˜¤í”„ë¼ì¸';
            
            // Google API ìë™ ë¡œë“œ (ê¸°ì¡´ ì‹œìŠ¤í…œ ìœ ì§€)
            setTimeout(() => {
                loadGoogleAPI();
            }, 100);

            // í…ìŠ¤íŠ¸ ì„ íƒì‹œ í¬ë§· íˆ´ë°” í‘œì‹œ
            document.addEventListener('mouseup', showFormatToolbar);
            document.addEventListener('touchend', showFormatToolbar);
            
            // ì…ë ¥ í›„ ìë™ ì €ì¥ (1ì´ˆ í›„)
            document.addEventListener('input', () => {
                if (newAccessToken && gisInited) {
                    clearTimeout(editTimeout);
                    editTimeout = setTimeout(async () => {
                        await saveToNewDrive(data);
                        console.log('ğŸ’¾ ìë™ ì €ì¥ ì™„ë£Œ (ì…ë ¥ í›„)');
                    }, 1000);
                }
            });
        };

        function initClient() {
            try {
                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: SCOPES
                }).then(() => {
                    console.log('âœ… Google API ì´ˆê¸°í™” ì™„ë£Œ');
                    
                    // ë²„íŠ¼ í™œì„±í™”
                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'â˜ï¸ Drive ì—°ê²°';
                    connectBtn.style.opacity = '1';
                    connectBtn.style.cursor = 'pointer';
                    
                    // ì´ë¯¸ ë¡œê·¸ì¸ëœ ê²½ìš°
                    if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                        accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                        sessionStorage.setItem('gdrive_token', accessToken);
                        onConnected();
                    }
                }).catch(err => {
                    console.error('Google API ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
                    showToast('âš ï¸ Google API ì´ˆê¸°í™” ì‹¤íŒ¨. CLIENT_IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                    
                    // ë²„íŠ¼ì„ ì—ëŸ¬ ìƒíƒœë¡œ
                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨ (ì¬ì‹œë„)';
                    connectBtn.style.opacity = '1';
                    connectBtn.style.cursor = 'pointer';
                });
            } catch (error) {
                console.error('Google API ì´ˆê¸°í™” ì˜ˆì™¸:', error);
                showToast('âŒ API ì´ˆê¸°í™” ì˜¤ë¥˜');
                
                // ë²„íŠ¼ì„ ì—ëŸ¬ ìƒíƒœë¡œ
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.disabled = false;
                connectBtn.textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨ (ì¬ì‹œë„)';
                connectBtn.style.opacity = '1';
                connectBtn.style.cursor = 'pointer';
            }
        }

        // ========================================
        // Google API ë¡œë“œ
        // ========================================
        function loadGoogleAPI() {
            // Google APIê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
            if (typeof gapi !== 'undefined') {
                if (gapi.auth2 && gapi.auth2.getAuthInstance()) {
                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'â˜ï¸ Drive ì—°ê²°';
                    connectBtn.style.opacity = '1';
                    connectBtn.style.cursor = 'pointer';
                }
                return;
            }
            
            // Google API ë™ì  ë¡œë“œ
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = function() {
                gapi.load('client:auth2', function() {
                    initClient();
                });
            };
            script.onerror = function() {
                showToast('âŒ Google API ë¡œë“œ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.');
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.disabled = false;
                connectBtn.textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨ (ì¬ì‹œë„)';
                connectBtn.style.opacity = '1';
                connectBtn.style.cursor = 'pointer';
            };
            document.head.appendChild(script);
        }

        // ========================================
        // Google Drive ì—°ê²°
        // ========================================
        function connectDrive() {
            // ë²„íŠ¼ì´ ë¹„í™œì„±í™” ìƒíƒœë©´ ë¬´ì‹œ
            if (document.getElementById('connectBtn').disabled) {
                return;
            }
            
            // ìƒˆë¡œìš´ Google Drive ì‹œìŠ¤í…œ ì‚¬ìš© (ìš°ì„ )
            if (gisInited && tokenClient) {
                requestDriveAccess().then(success => {
                    if (success) {
                        onNewDriveConnected();
                    } else {
                        showToast('âŒ Google Drive ì—°ê²° ì‹¤íŒ¨');
                    }
                });
                return;
            }
            
            // ê¸°ì¡´ ì‹œìŠ¤í…œ í´ë°±
            // Google APIê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°
            if (typeof gapi === 'undefined') {
                showToast('âš ï¸ Google APIê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                loadGoogleAPI();
                return;
            }
            
            // Google APIê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš°
            if (!gapi.auth2 || !gapi.auth2.getAuthInstance()) {
                showToast('âš ï¸ Google API ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                return;
            }
            
            signInToGoogle();
        }
        
        function signInToGoogle() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                sessionStorage.setItem('gdrive_token', accessToken);
                onConnected();
            }).catch(err => {
                showToast('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (err.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            });
        }

        function onConnected() {
            isConnected = true;
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('loadBtn').style.display = 'inline-block';
            document.getElementById('statusDot').className = 'status-dot connected';
            document.getElementById('statusText').textContent = 'ì—°ê²°ë¨';

            // ìë™ ì €ì¥ ì‹œì‘ (30ì´ˆë§ˆë‹¤)
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(autoSaveToDrive, 30000);

            // ì‹¤ì‹œê°„ ë™ê¸°í™” ì²´í¬ ì‹œì‘ (10ì´ˆë§ˆë‹¤)
            if (syncCheckInterval) clearInterval(syncCheckInterval);
            syncCheckInterval = setInterval(checkForUpdates, 10000);

            // ì¦‰ì‹œ í•œ ë²ˆ ë¶ˆëŸ¬ì˜¤ê¸°
            loadFromDrive();
        }

        // ========================================
        // ì‹¤ì‹œê°„ ë™ê¸°í™” ì²´í¬ (10ì´ˆë§ˆë‹¤)
        // ========================================
        async function checkForUpdates() {
            if (!isConnected || !fileId || isEditing) return;

            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?fields=modifiedTime`, {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });

                if (response.ok) {
                    const fileMetadata = await response.json();
                    const cloudModifiedTime = new Date(fileMetadata.modifiedTime).getTime();

                    // ë¡œì»¬ë³´ë‹¤ í´ë¼ìš°ë“œê°€ ìµœì‹ ì¸ ê²½ìš°
                    if (lastModifiedTime && cloudModifiedTime > lastModifiedTime) {
                        showSyncNotification();
                    }
                }
            } catch (error) {
                console.error('ë™ê¸°í™” ì²´í¬ ì‹¤íŒ¨:', error);
            }
        }

        function showSyncNotification() {
            document.getElementById('syncNotification').classList.add('show');
        }

        function dismissNotification() {
            document.getElementById('syncNotification').classList.remove('show');
        }

        async function updateFromCloud() {
            dismissNotification();
            await loadFromDrive();
            showToast('ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function showToast(message) {
            const notification = document.getElementById('syncNotification');
            notification.querySelector('.message').textContent = message;
            notification.querySelector('.btn-update').style.display = 'none';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
                notification.querySelector('.btn-update').style.display = 'inline-block';
            }, 2000);
        }

        // ========================================
        // Google Drive ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        // ========================================
        async function saveToDrive() {
            if (!isConnected) return;

            try {
                document.getElementById('statusDot').className = 'status-dot syncing';
                document.getElementById('statusText').textContent = 'ì €ì¥ ì¤‘...';

                const content = JSON.stringify(data);
                const blob = new Blob([content], { type: 'application/json' });

                let uploadResponse;
                if (fileId) {
                    // ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸
                    uploadResponse = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: blob
                    });
                } else {
                    // ìƒˆ íŒŒì¼ ìƒì„±
                    const metadata = {
                        name: 'workflowy-data.json',
                        parents: ['appDataFolder']
                    };

                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);

                    uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + accessToken },
                        body: form
                    });

                    const result = await uploadResponse.json();
                    fileId = result.id;
                    localStorage.setItem('gdrive_file_id', fileId);
                }

                if (uploadResponse.ok) {
                    // ì €ì¥ ì‹œê°„ ì—…ë°ì´íŠ¸
                    const metadataResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?fields=modifiedTime`, {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });
                    const metadata = await metadataResponse.json();
                    lastModifiedTime = new Date(metadata.modifiedTime).getTime();

                    document.getElementById('statusDot').className = 'status-dot connected';
                    document.getElementById('statusText').textContent = 'ì €ì¥ ì™„ë£Œ';
                    setTimeout(() => {
                        document.getElementById('statusText').textContent = 'ì—°ê²°ë¨';
                    }, 2000);
                } else {
                    throw new Error('ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Drive ì €ì¥ ì‹¤íŒ¨:', error);
                document.getElementById('statusDot').className = 'status-dot';
                document.getElementById('statusText').textContent = 'ì €ì¥ ì‹¤íŒ¨';
            }
        }

        async function loadFromDrive() {
            if (!isConnected) return;

            try {
                document.getElementById('statusDot').className = 'status-dot syncing';
                document.getElementById('statusText').textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

                // íŒŒì¼ ê²€ìƒ‰
                if (!fileId) {
                    const searchResponse = await fetch(
                        `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='workflowy-data.json'`,
                        { headers: { 'Authorization': 'Bearer ' + accessToken } }
                    );
                    const searchResult = await searchResponse.json();
                    
                    if (searchResult.files && searchResult.files.length > 0) {
                        fileId = searchResult.files[0].id;
                        localStorage.setItem('gdrive_file_id', fileId);
                    } else {
                        document.getElementById('statusDot').className = 'status-dot connected';
                        document.getElementById('statusText').textContent = 'íŒŒì¼ ì—†ìŒ';
                        return;
                    }
                }

                // íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });

                if (response.ok) {
                    const content = await response.text();
                    data = JSON.parse(content);
                    
                    // ìˆ˜ì • ì‹œê°„ ì—…ë°ì´íŠ¸
                    const metadataResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?fields=modifiedTime`, {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });
                    const metadata = await metadataResponse.json();
                    lastModifiedTime = new Date(metadata.modifiedTime).getTime();

                    saveToLocalStorage();
                    render();
                    document.getElementById('statusDot').className = 'status-dot connected';
                    document.getElementById('statusText').textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ';
                    setTimeout(() => {
                        document.getElementById('statusText').textContent = 'ì—°ê²°ë¨';
                    }, 2000);
                } else {
                    throw new Error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Drive ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                document.getElementById('statusDot').className = 'status-dot';
                document.getElementById('statusText').textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
            }
        }

        function autoSaveToDrive() {
            if (isConnected && !isEditing) {
                saveToDrive();
            }
        }

        // ========================================
        // ë¡œì»¬ ì €ì¥ì†Œ
        // ========================================
        function saveToLocalStorage() {
            localStorage.setItem('workflowy_data', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('workflowy_data');
            if (saved) {
                data = JSON.parse(saved);
            } else {
                data = {
                    items: [{ id: Date.now(), text: '', children: [], completed: false, important: false }],
                    zoomedItem: null
                };
            }
        }

        // ========================================
        // ë Œë”ë§
        // ========================================
        function render() {
            const root = document.getElementById('root');
            const items = data.zoomedItem ? 
                [data.items.find(item => findItem(item, data.zoomedItem))] :
                data.items;

            root.innerHTML = items ? items.map(item => renderItem(item)).join('') : '';

            // ì¤Œ ë¸Œë ˆë“œí¬ëŸ¼ í‘œì‹œ
            if (data.zoomedItem) {
                document.getElementById('zoomBreadcrumb').style.display = 'block';
            } else {
                document.getElementById('zoomBreadcrumb').style.display = 'none';
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
            attachEventListeners();

            // ê²€ìƒ‰ ì¤‘ì´ì—ˆë‹¤ë©´ ê²€ìƒ‰ ë‹¤ì‹œ ìˆ˜í–‰
            if (searchQuery) {
                setTimeout(() => {
                    performSearch(searchQuery);
                }, 50);
            }
        }

        function renderItem(item) {
            const isLocked = item.locked ? 'locked' : '';
            const lockIcon = item.locked ? 'ğŸ”’' : 'ğŸ”“';
            const contentEditable = item.locked ? 'false' : 'true';
            const isCompleted = item.completed ? 'completed' : '';
            const isChecked = item.completed ? 'checked' : '';
            const isImportant = item.important ? 'important' : '';
            const hasChildren = item.children && item.children.length > 0;
            const isCollapsed = item.collapsed || false;
            
            return `
                <div class="item" data-id="${item.id}">
                    <div class="item-content ${isLocked}">
                        <div class="checkbox ${isChecked}" onclick="toggleComplete(${item.id})" title="ì™„ë£Œ í‘œì‹œ"></div>
                        <div class="star ${isImportant}" onclick="toggleImportant(${item.id})" title="ì¤‘ìš” í‘œì‹œ">â˜…</div>
                        <div class="bullet" draggable="true" title="ë“œë˜ê·¸í•˜ì—¬ ì´ë™"></div>
                        <span class="lock-icon ${isLocked}" onclick="toggleLock(${item.id})" title="${item.locked ? 'ë³´í˜¸ í•´ì œ' : 'ë³´í˜¸í•˜ê¸°'}">${lockIcon}</span>
                        <div class="text ${isCompleted}" 
                             contenteditable="${contentEditable}" 
                             data-id="${item.id}"
                             data-placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                             oninput="handleInput(${item.id})"
                             onkeydown="handleKeyDown(event, ${item.id})"
                             onpaste="handlePaste(event)"
                             onfocus="handleFocus()"
                             onblur="handleBlur()"
                             >${item.text || ''}</div>
                        ${hasChildren ? `
                            <button class="toggle-btn" onclick="toggleCollapse(${item.id})" title="${isCollapsed ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}">
                                ${isCollapsed ? 'â–¶' : 'â–¼'}
                            </button>
                        ` : ''}
                    </div>
                    ${hasChildren ? `
                        <div class="children ${isCollapsed ? 'collapsed' : ''}">
                            ${item.children.map(child => renderItem(child)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function attachEventListeners() {
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ - bulletì— ì—°ê²°
            document.querySelectorAll('.bullet').forEach(bullet => {
                // ë“œë˜ê·¸ ì´ë²¤íŠ¸
                bullet.addEventListener('dragstart', handleDragStart);
                
                // í´ë¦­ ì´ë²¤íŠ¸ (ì¤Œ ê¸°ëŠ¥)
                bullet.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const item = e.target.closest('.item');
                    if (item) {
                        const id = parseInt(item.dataset.id);
                        handleBulletClick(id);
                    }
                });
                
                // ëª¨ë°”ì¼ í„°ì¹˜
                bullet.addEventListener('touchstart', handleTouchStart, { passive: false });
                bullet.addEventListener('touchmove', handleTouchMove, { passive: false });
                bullet.addEventListener('touchend', handleTouchEnd);
            });

            document.querySelectorAll('.item').forEach(el => {
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('dragend', handleDragEnd);
            });
        }

        // ========================================
        // ì•„ì´í…œ ì¡°ì‘
        // ========================================
        function findItem(item, id) {
            if (item.id === id) return item;
            if (item.children) {
                for (let child of item.children) {
                    const found = findItem(child, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function findItemInArray(items, id) {
            for (let item of items) {
                if (item.id === id) return item;
                if (item.children) {
                    const found = findItemInArray(item.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function handleFocus() {
            isEditing = true;
            if (editTimeout) clearTimeout(editTimeout);
        }

        function handleBlur() {
            editTimeout = setTimeout(() => {
                isEditing = false;
            }, 1000);
        }

        function handleInput(id) {
            const el = document.querySelector(`[data-id="${id}"].text`);
            const item = findItemInArray(data.items, id);
            if (item && !item.locked) {
                item.text = el.innerHTML;
                saveToLocalStorage();
            }
        }

        function handlePaste(e) {
            // ê¸°ë³¸ paste ë™ì‘ ë°©ì§€
            e.preventDefault();
            
            // í´ë¦½ë³´ë“œì—ì„œ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            let text = '';
            if (e.clipboardData && e.clipboardData.getData) {
                text = e.clipboardData.getData('text/plain');
            } else if (window.clipboardData && window.clipboardData.getData) {
                text = window.clipboardData.getData('Text');
            }
            
            // ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€ê²½
            text = text.replace(/\r?\n/g, ' ').trim();
            
            // í˜„ì¬ ì„ íƒ ì˜ì—­ ê°€ì ¸ì˜¤ê¸°
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            range.deleteContents();
            
            // í…ìŠ¤íŠ¸ ë…¸ë“œ ìƒì„±í•˜ì—¬ ì‚½ì…
            const textNode = document.createTextNode(text);
            range.insertNode(textNode);
            
            // ì»¤ì„œë¥¼ ì‚½ì…ëœ í…ìŠ¤íŠ¸ ë’¤ë¡œ ì´ë™
            range.setStartAfter(textNode);
            range.setEndAfter(textNode);
            selection.removeAllRanges();
            selection.addRange(range);
            
            // ë³€ê²½ì‚¬í•­ ì €ì¥
            const textEl = e.target;
            if (textEl && textEl.dataset.id) {
                const id = parseInt(textEl.dataset.id);
                const item = findItemInArray(data.items, id);
                if (item) {
                    item.text = textEl.innerHTML;
                    saveToLocalStorage();
                }
            }
        }

        function createNewItem(afterId) {
            const item = findItemInArray(data.items, afterId);
            if (!item) return;

            const newItem = { id: Date.now(), text: '', children: [], completed: false, important: false };
            
            // ë¶€ëª¨ ì°¾ê¸°
            function insertAfter(items, targetId) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].id === targetId) {
                        items.splice(i + 1, 0, newItem);
                        return true;
                    }
                    if (items[i].children && insertAfter(items[i].children, targetId)) {
                        return true;
                    }
                }
                return false;
            }

            insertAfter(data.items, afterId);
            saveToLocalStorage();
            render();

            // ìƒˆ ì•„ì´í…œì— í¬ì»¤ìŠ¤ (ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤)
            setTimeout(() => {
                const newEl = document.querySelector(`[data-id="${newItem.id}"].text`);
                if (newEl) {
                    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë¨¼ì € ì¡°ì • (ë¶€ë“œëŸ½ê²Œ)
                    newEl.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                    // í¬ì»¤ìŠ¤
                    setTimeout(() => {
                        newEl.focus({ preventScroll: true });
                    }, 100);
                }
            }, 10);
        }

        function deleteItem(id) {
            const item = findItemInArray(data.items, id);
            
            // ë³´í˜¸ëœ í•­ëª©ì€ ì‚­ì œ ë¶ˆê°€
            if (item && item.locked) {
                showToast('ğŸ”’ ë³´í˜¸ëœ í•­ëª©ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            function removeFromArray(items) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].id === id) {
                        items.splice(i, 1);
                        return true;
                    }
                    if (items[i].children && removeFromArray(items[i].children)) {
                        return true;
                    }
                }
                return false;
            }

            removeFromArray(data.items);
            saveToLocalStorage();
            render();
        }

        // ========================================
        // í–‰ ë³´í˜¸ ê¸°ëŠ¥
        // ========================================
        function toggleLock(id) {
            const item = findItemInArray(data.items, id);
            if (!item) return;
            
            // ë³´í˜¸ ìƒíƒœ í† ê¸€
            item.locked = !item.locked;
            
            // ì‹œê°ì  í”¼ë“œë°±
            if (item.locked) {
                showToast('ğŸ”’ í–‰ì´ ë³´í˜¸ë˜ì—ˆìŠµë‹ˆë‹¤');
            } else {
                showToast('ğŸ”“ í–‰ ë³´í˜¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            }
            
            saveToLocalStorage();
            render();
        }

        // ========================================
        // í¼ì¹˜ê¸°/ì ‘ê¸° ê¸°ëŠ¥
        // ========================================
        function toggleCollapse(id) {
            const item = findItemInArray(data.items, id);
            if (!item) return;
            
            item.collapsed = !item.collapsed;
            saveToLocalStorage();
            render();
        }

        // ========================================
        // ì™„ë£Œ ë° ì¤‘ìš” í‘œì‹œ
        // ========================================
        function toggleComplete(id) {
            const item = findItemInArray(data.items, id);
            if (!item || item.locked) return;
            
            item.completed = !item.completed;
            saveToLocalStorage();
            render();
        }

        function toggleImportant(id) {
            const item = findItemInArray(data.items, id);
            if (!item) return;
            
            item.important = !item.important;
            saveToLocalStorage();
            render();
        }

        function indentItem(id) {
            // Tabìœ¼ë¡œ ë“¤ì—¬ì“°ê¸°
            function indent(items) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].id === id && i > 0) {
                        const item = items.splice(i, 1)[0];
                        items[i - 1].children = items[i - 1].children || [];
                        items[i - 1].children.push(item);
                        return true;
                    }
                    if (items[i].children && indent(items[i].children)) {
                        return true;
                    }
                }
                return false;
            }

            const success = indent(data.items);
            if (!success && window.innerWidth <= 768) {
                // ëª¨ë°”ì¼ì—ì„œ ë“¤ì—¬ì“°ê¸° ì‹¤íŒ¨ ì‹œ ì•ˆë‚´
                showToast('â„¹ï¸ ì²« ë²ˆì§¸ í•­ëª©ì€ ë“¤ì—¬ì“°ê¸°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            saveToLocalStorage();
            render();
        }

        function outdentItem(id) {
            // Shift+Tabìœ¼ë¡œ ë‚´ì–´ì“°ê¸°
            function outdent(items, parent = null, parentArray = data.items) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].id === id && parent) {
                        const item = items.splice(i, 1)[0];
                        const parentIndex = parentArray.indexOf(parent);
                        parentArray.splice(parentIndex + 1, 0, item);
                        return true;
                    }
                    if (items[i].children && outdent(items[i].children, items[i], items)) {
                        return true;
                    }
                }
                return false;
            }

            outdent(data.items);
            saveToLocalStorage();
            render();
        }

        function handleBulletClick(id) {
            // ëª¨ë°”ì¼ í™”ë©´ì—ì„œëŠ” ë“¤ì—¬ì“°ê¸° (í•˜ìœ„ë¡œ ì´ë™)
            if (window.innerWidth <= 768) {
                indentItem(id);
                return;
            }
            
            // PCì—ì„œëŠ” ì¤Œ ì¸/ì•„ì›ƒ
            if (data.zoomedItem === id) {
                data.zoomedItem = null;
            } else {
                data.zoomedItem = id;
            }
            saveToLocalStorage();
            render();
        }

        function zoomOut() {
            data.zoomedItem = null;
            saveToLocalStorage();
            render();
        }

        // ========================================
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ì™„ì „ ììœ  ì´ë™)
        // ========================================
        let draggedElement = null;
        let draggedId = null;
        let draggedItemData = null;
        let dropGuide = null;
        let levelIndicator = null;

        function handleDragStart(e) {
            e.stopPropagation();
            
            console.log('ğŸ¯ ë“œë˜ê·¸ ì‹œì‘!', e.currentTarget);
            
            // bullet(currentTarget)ì—ì„œ item ì°¾ê¸°
            const item = e.currentTarget.closest('.item');
            if (!item) {
                console.log('âŒ itemì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            console.log('âœ… item ì°¾ìŒ:', item);
            
            draggedElement = item;
            draggedId = parseInt(item.dataset.id);
            draggedItemData = findItemInArray(data.items, draggedId);
            
            // ë“œë˜ê·¸ ì´ë¯¸ì§€ ì„¤ì •
            const dragImage = item.cloneNode(true);
            dragImage.style.opacity = '0.5';
            document.body.appendChild(dragImage);
            e.dataTransfer.setDragImage(dragImage, 0, 0);
            setTimeout(() => document.body.removeChild(dragImage), 0);
            
            draggedElement.classList.add('dragging');
            document.body.classList.add('drag-active');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', item.innerHTML);

            dropGuide = document.getElementById('dropGuide');
            levelIndicator = document.getElementById('levelIndicator');
            
            console.log('âœ… ë“œë˜ê·¸ ì„¤ì • ì™„ë£Œ!');
        }

        function handleDragOver(e) {
            e.preventDefault();
            if (!draggedElement) return;

            const target = e.target.closest('.item');
            if (!target) {
                hideDropGuide();
                return;
            }

            // ìê¸° ìì‹ ì´ë‚˜ ìì‹ ì˜ ìì‹ì—ê²ŒëŠ” ë“œë¡­ ë¶ˆê°€
            if (target === draggedElement || isDescendant(draggedId, parseInt(target.dataset.id))) {
                hideDropGuide();
                return;
            }

            const targetId = parseInt(target.dataset.id);
            const rect = target.getBoundingClientRect();
            const mouseY = e.clientY;
    const mouseX = e.clientX;
            const targetTop = rect.top;
            const targetBottom = rect.bottom;
            const targetHeight = rect.height;
            
            // ëª¨ë“  ì•„ì´í…œ í•˜ì´ë¼ì´íŠ¸ ì œê±°
            document.querySelectorAll('.item').forEach(el => {
                el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-child');
            });

            // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ë”°ë¼ ë“œë¡­ ìœ„ì¹˜ ê²°ì •
            let dropPosition;
            let dropLevel;
            
            // ìœ„ìª½ 1/4 ì˜ì—­
            if (mouseY < targetTop + targetHeight * 0.25) {
                dropPosition = 'before';
                dropLevel = getItemLevel(targetId);
                showDropGuide(rect.top, rect.left);
                target.classList.add('drag-over-top');
            }
            // ì•„ë˜ìª½ 1/4 ì˜ì—­
            else if (mouseY > targetBottom - targetHeight * 0.25) {
                dropPosition = 'after';
                dropLevel = getItemLevel(targetId);
                showDropGuide(rect.bottom, rect.left);
                target.classList.add('drag-over-bottom');
            }
            // ì¤‘ê°„ ì˜ì—­ - ìì‹ìœ¼ë¡œ
            else {
                dropPosition = 'child';
                dropLevel = getItemLevel(targetId) + 1;
                target.classList.add('drag-over-child');
                hideDropGuide();
            }

            // ë ˆë²¨ í‘œì‹œ
            showLevelIndicator(dropLevel, dropPosition);

            // ë°ì´í„° ì €ì¥
            e.dataTransfer.dropEffect = 'move';
            // X-axis assist: indent â†’ child
    const indentThresh = rect.left + Math.min(40, rect.width * 0.25);
    if (mouseX > indentThresh && dropPosition !== 'before' && dropPosition !== 'after') {
        dropPosition = 'child';
        target.classList.remove('drag-over-top','drag-over-bottom');
        target.classList.add('drag-over-child');
    }
    target.dataset.dropPosition = dropPosition;
        }

        function handleDragLeave(e) {
            const target = e.target.closest('.item');
            if (target) {
                target.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-child');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!draggedElement) return;

            const target = e.target.closest('.item');
            if (!target || target === draggedElement) {
                handleDragEnd(e);
                return;
            }

            const targetId = parseInt(target.dataset.id);
            
            // ìì‹ ì˜ ìì‹ì—ê²Œ ë“œë¡­ ë°©ì§€
            if (isDescendant(draggedId, targetId)) {
                alert('ìì‹ í•­ëª©ìœ¼ë¡œëŠ” ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                handleDragEnd(e);
                return;
            }

            const position = target.dataset.dropPosition || 'child';
            moveItemAnywhere(draggedId, targetId, position);
            
            target.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-child');
            handleDragEnd(e);
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            document.body.classList.remove('drag-active');
            document.querySelectorAll('.item').forEach(el => {
                el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-child');
                delete el.dataset.dropPosition;
            });
            hideDropGuide();
            hideLevelIndicator();
            draggedElement = null;
            draggedId = null;
            draggedItemData = null;
        }

        // ì™„ì „ ììœ  ì´ë™ í•¨ìˆ˜
        function moveItemAnywhere(fromId, toId, position) {
            // 1. ì´ë™í•  ì•„ì´í…œ ì°¾ê¸° ë° ì œê±°
            let movedItem = null;
            
            function removeItem(items) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].id === fromId) {
                        movedItem = items.splice(i, 1)[0];
                        return true;
                    }
                    if (items[i].children && removeItem(items[i].children)) {
                        return true;
                    }
                }
                return false;
            }

            removeItem(data.items);
            if (!movedItem) return;

            // 2. ìƒˆ ìœ„ì¹˜ì— ì‚½ì…
            function insertItem(items, parentLevel = 0) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].id === toId) {
                        if (position === 'before') {
                            // ê°™ì€ ë ˆë²¨ì— ìœ„ì— ì‚½ì…
                            items.splice(i, 0, movedItem);
                        } else if (position === 'after') {
                            // ê°™ì€ ë ˆë²¨ì— ì•„ë˜ ì‚½ì…
                            items.splice(i + 1, 0, movedItem);
                        } else if (position === 'child') {
                            // ìì‹ìœ¼ë¡œ ì‚½ì…
                            items[i].children = items[i].children || [];
                            items[i].children.push(movedItem);
                        }
                        return true;
                    }
                    if (items[i].children && insertItem(items[i].children, parentLevel + 1)) {
                        return true;
                    }
                }
                return false;
            }

            insertItem(data.items);
            saveToLocalStorage();
            render();
        }

        // ì•„ì´í…œì˜ ë ˆë²¨ ê³„ì‚°
        function getItemLevel(itemId) {
            function findLevel(items, level = 0) {
                for (let item of items) {
                    if (item.id === itemId) return level;
                    if (item.children) {
                        const childLevel = findLevel(item.children, level + 1);
                        if (childLevel !== -1) return childLevel;
                    }
                }
                return -1;
            }
            return findLevel(data.items);
        }

        // ìì† ì—¬ë¶€ í™•ì¸ (ìˆœí™˜ ë°©ì§€)
        function isDescendant(ancestorId, itemId) {
            const ancestor = findItemInArray(data.items, ancestorId);
            if (!ancestor) return false;

            function checkChildren(item) {
                if (item.id === itemId) return true;
                if (item.children) {
                    for (let child of item.children) {
                        if (checkChildren(child)) return true;
                    }
                }
                return false;
            }

            return checkChildren(ancestor);
        }

        // ë“œë¡­ ê°€ì´ë“œ ë¼ì¸ í‘œì‹œ
        function showDropGuide(top, left) {
            if (!dropGuide) return;
            const container = document.querySelector('.container');
            const containerRect = container.getBoundingClientRect();
            
            dropGuide.style.top = (top - containerRect.top + container.scrollTop) + 'px';
            dropGuide.style.left = (left - containerRect.left) + 'px';
            dropGuide.classList.add('show');
        }

        function hideDropGuide() {
            if (dropGuide) {
                dropGuide.classList.remove('show');
            }
        }

        // ë ˆë²¨ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        function showLevelIndicator(level, position) {
            if (!levelIndicator) return;
            
            const positionText = {
                'before': 'ìœ„ì—',
                'after': 'ì•„ë˜ì—',
                'child': 'ìì‹ìœ¼ë¡œ'
            };
            
            levelIndicator.textContent = `ë ˆë²¨ ${level} - ${positionText[position]} ì´ë™`;
            levelIndicator.classList.add('show');
        }

        function hideLevelIndicator() {
            if (levelIndicator) {
                levelIndicator.classList.remove('show');
            }
        }

        // ========================================
        // ëª¨ë°”ì¼ í„°ì¹˜ ë“œë˜ê·¸ (ì™„ì „ ììœ  ì´ë™)
        // ========================================
        let touchStartY = 0;
        let touchItem = null;
        let touchStartTime = 0;

        function handleTouchStart(e) {
            touchItem = e.currentTarget.closest('.item');
            if (touchItem) {
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                
                // ê¸¸ê²Œ ëˆ„ë¥´ë©´ ë“œë˜ê·¸ ì‹œì‘ (500ms)
                setTimeout(() => {
                    if (touchItem && (Date.now() - touchStartTime >= 500)) {
                        touchItem.classList.add('dragging');
                        document.body.classList.add('drag-active');
                        draggedId = parseInt(touchItem.dataset.id);
                        
                        levelIndicator = document.getElementById('levelIndicator');
                        if (levelIndicator) {
                            levelIndicator.classList.add('show');
                        }
                    }
                }, 500);
            }
        }

        function handleTouchMove(e) {
            if (!touchItem || !touchItem.classList.contains('dragging')) return;
            e.preventDefault();

            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            const target = element ? element.closest('.item') : null;

            // ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì œê±°
            document.querySelectorAll('.item').forEach(el => {
                el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-child');
            });

            if (!target || target === touchItem) {
                hideLevelIndicator();
                return;
            }

            // ìì‹ ì˜ ìì‹ì—ê²Œ ë“œë¡­ ë°©ì§€
            const targetId = parseInt(target.dataset.id);
            if (isDescendant(draggedId, targetId)) {
                hideLevelIndicator();
                return;
            }

            const rect = target.getBoundingClientRect();
            const y = touch.clientY - rect.top;
            const height = rect.height;

            let position;
            let level;

            // ë“œë¡­ ìœ„ì¹˜ ê²°ì •
            if (y < height * 0.25) {
                position = 'before';
                level = getItemLevel(targetId);
                target.classList.add('drag-over-top');
            } else if (y > height * 0.75) {
                position = 'after';
                level = getItemLevel(targetId);
                target.classList.add('drag-over-bottom');
            } else {
                position = 'child';
                level = getItemLevel(targetId) + 1;
                target.classList.add('drag-over-child');
            }

            // ë ˆë²¨ í‘œì‹œ
            showLevelIndicator(level, position);
            target.dataset.dropPosition = position;
        }

        function handleTouchEnd(e) {
            if (!touchItem || !touchItem.classList.contains('dragging')) {
                touchItem = null;
                return;
            }

            const touch = e.changedTouches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            const target = element ? element.closest('.item') : null;

            if (target && target !== touchItem) {
                const touchId = parseInt(touchItem.dataset.id);
                const targetId = parseInt(target.dataset.id);
                
                // ìì‹ ì˜ ìì‹ì—ê²Œ ë“œë¡­ ë°©ì§€
                if (!isDescendant(touchId, targetId)) {
                    const position = target.dataset.dropPosition || 'child';
                    moveItemAnywhere(touchId, targetId, position);
                }
            }

            // ì •ë¦¬
            touchItem.classList.remove('dragging');
            document.body.classList.remove('drag-active');
            document.querySelectorAll('.item').forEach(el => {
                el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-child');
                delete el.dataset.dropPosition;
            });
            hideLevelIndicator();
            touchItem = null;
            draggedId = null;
        }

        // ========================================
        // ê²€ìƒ‰ ê¸°ëŠ¥
        // ========================================
        let searchResults = [];
        let currentSearchIndex = -1;
        let searchQuery = '';

        function handleSearch() {
            const input = document.getElementById('searchInput');
            const query = input.value.trim();
            searchQuery = query;

            // X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            const clearBtn = document.getElementById('searchClear');
            if (query) {
                clearBtn.classList.add('show');
            } else {
                clearBtn.classList.remove('show');
            }

            if (query.length === 0) {
                clearSearchHighlights();
                hideSearchResults();
                return;
            }

            // ê²€ìƒ‰ ì‹¤í–‰
            performSearch(query);
        }

        function handleSearchKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) {
                    prevSearchResult();
                } else {
                    nextSearchResult();
                }
            } else if (e.key === 'Escape') {
                clearSearch();
            }
        }

        function performSearch(query) {
            clearSearchHighlights();
            searchResults = [];

            if (!query) return;

            const lowerQuery = query.toLowerCase();
            
            // ëª¨ë“  í…ìŠ¤íŠ¸ ìš”ì†Œì—ì„œ ê²€ìƒ‰
            const textElements = document.querySelectorAll('.text');
            
            textElements.forEach((el, index) => {
                const text = el.textContent;
                const lowerText = text.toLowerCase();
                
                if (lowerText.includes(lowerQuery)) {
                    // ë§¤ì¹­ë˜ëŠ” ëª¨ë“  ìœ„ì¹˜ ì°¾ê¸°
                    let startIndex = 0;
                    while (true) {
                        const foundIndex = lowerText.indexOf(lowerQuery, startIndex);
                        if (foundIndex === -1) break;
                        
                        searchResults.push({
                            element: el,
                            start: foundIndex,
                            end: foundIndex + query.length,
                            itemId: parseInt(el.dataset.id)
                        });
                        
                        startIndex = foundIndex + 1;
                    }
                }
            });

            // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            if (searchResults.length > 0) {
                highlightSearchResults();
                currentSearchIndex = 0;
                showSearchResults();
                scrollToCurrentResult();
            } else {
                hideSearchResults();
            }
        }

        function highlightSearchResults() {
            searchResults.forEach((result, index) => {
                const el = result.element;
                const text = el.textContent;
                const before = text.substring(0, result.start);
                const match = text.substring(result.start, result.end);
                const after = text.substring(result.end);
                
                const span = document.createElement('span');
                span.className = 'search-highlight';
                if (index === currentSearchIndex) {
                    span.className += ' current';
                }
                span.textContent = match;
                span.dataset.searchIndex = index;
                
                el.innerHTML = escapeHtml(before);
                el.appendChild(span);
                el.appendChild(document.createTextNode(after));
            });
        }

        function clearSearchHighlights() {
            document.querySelectorAll('.search-highlight').forEach(el => {
                const parent = el.parentElement;
                parent.textContent = parent.textContent; // HTML ì œê±°í•˜ê³  ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ
            });
        }

        function showSearchResults() {
            const resultsEl = document.getElementById('searchResults');
            const navEl = document.getElementById('searchNav');
            
            resultsEl.textContent = `${currentSearchIndex + 1} / ${searchResults.length}`;
            resultsEl.style.display = 'block';
            navEl.style.display = 'flex';
            
            // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            const prevBtn = navEl.children[0];
            const nextBtn = navEl.children[1];
            prevBtn.disabled = currentSearchIndex === 0;
            nextBtn.disabled = currentSearchIndex === searchResults.length - 1;
        }

        function hideSearchResults() {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchNav').style.display = 'none';
            searchResults = [];
            currentSearchIndex = -1;
        }

        function nextSearchResult() {
            if (searchResults.length === 0) return;
            
            currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
            updateCurrentHighlight();
            scrollToCurrentResult();
            showSearchResults();
        }

        function prevSearchResult() {
            if (searchResults.length === 0) return;
            
            currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
            updateCurrentHighlight();
            scrollToCurrentResult();
            showSearchResults();
        }

        function updateCurrentHighlight() {
            document.querySelectorAll('.search-highlight').forEach((el, index) => {
                if (index === currentSearchIndex) {
                    el.classList.add('current');
                } else {
                    el.classList.remove('current');
                }
            });
        }

        function scrollToCurrentResult() {
            if (currentSearchIndex < 0 || currentSearchIndex >= searchResults.length) return;
            
            const result = searchResults[currentSearchIndex];
            const el = result.element;
            
            // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // ì ì‹œ ê°•ì¡° íš¨ê³¼
            el.style.backgroundColor = '#e8f0fe';
            setTimeout(() => {
                el.style.backgroundColor = '';
            }, 1000);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchClear').classList.remove('show');
            clearSearchHighlights();
            hideSearchResults();
            searchQuery = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // ë‚ ì§œ ì„ íƒ ê¸°ëŠ¥ (@)
        // ========================================
        let datePickerVisible = false;
        let datePickerTargetElement = null;
        let datePickerCaretPosition = null;
        let currentPickerDate = new Date();

        function handleKeyDown(e, id) {
            const el = e.target;
            const item = findItemInArray(data.items, id);
            
            // ë³´í˜¸ëœ í•­ëª©ì€ ëŒ€ë¶€ë¶„ì˜ í‚¤ ì…ë ¥ ì°¨ë‹¨
            if (item && item.locked) {
                // ë„¤ë¹„ê²Œì´ì…˜ í‚¤ëŠ” í—ˆìš©
                if (e.key !== 'Escape' && e.key !== 'Tab' && !e.key.startsWith('Arrow')) {
                    e.preventDefault();
                    showToast('ğŸ”’ ë³´í˜¸ëœ í•­ëª©ì…ë‹ˆë‹¤');
                    return;
                }
            }
            
            // @ ì…ë ¥ ê°ì§€
            if (e.key === '@') {
                setTimeout(() => {
                    showDatePicker(el);
                }, 10);
            }
            
            // Enter: ìƒˆ ì•„ì´í…œ ìƒì„±
            if (e.key === 'Enter' && !e.shiftKey && !datePickerVisible) {
                e.preventDefault();
                createNewItem(id);
            }
            
            // Tab: ë“¤ì—¬ì“°ê¸°
            else if (e.key === 'Tab') {
                e.preventDefault();
                if (e.shiftKey) {
                    outdentItem(id);
                } else {
                    indentItem(id);
                }
            }
            
            // Backspace: ë¹ˆ ì•„ì´í…œ ì‚­ì œ
            else if (e.key === 'Backspace' && el.textContent.trim() === '') {
                e.preventDefault();
                deleteItem(id);
            }

            // ESC: ë‚ ì§œ ì„ íƒê¸° ë‹«ê¸°
            else if (e.key === 'Escape' && datePickerVisible) {
                e.preventDefault();
                closeDatePicker();
            }
        }

        function showDatePicker(element) {
            datePickerTargetElement = element;
            datePickerVisible = true;
            currentPickerDate = new Date();
            
            // ì»¤ì„œ ìœ„ì¹˜ ê³„ì‚°
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                const picker = document.getElementById('datePicker');
                picker.style.left = rect.left + 'px';
                picker.style.top = (rect.bottom + 5) + 'px';
                picker.classList.add('show');
                
                // ë‹¬ë ¥ ë Œë”ë§
                renderCalendar();
            }
        }

        function renderCalendar() {
            const year = currentPickerDate.getFullYear();
            const month = currentPickerDate.getMonth();
            
            // ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('datePickerTitle').textContent = 
                `${year}ë…„ ${month + 1}ì›”`;
            
            // í•´ë‹¹ ì›”ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ë‚ 
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();
            
            const daysContainer = document.getElementById('datePickerDays');
            daysContainer.innerHTML = '';
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            
            // ì´ì „ ë‹¬ ë‚ ì§œë“¤
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevLastDate - i;
                const btn = createDayButton(day, 'other-month');
                btn.onclick = () => {
                    prevMonth();
                    setTimeout(() => {
                        selectDate(new Date(year, month - 1, day));
                    }, 10);
                };
                daysContainer.appendChild(btn);
            }
            
            // í˜„ì¬ ë‹¬ ë‚ ì§œë“¤
            for (let day = 1; day <= lastDate; day++) {
                const btn = createDayButton(day);
                
                if (isCurrentMonth && day === today.getDate()) {
                    btn.classList.add('today');
                }
                
                btn.onclick = () => selectDate(new Date(year, month, day));
                daysContainer.appendChild(btn);
            }
            
            // ë‹¤ìŒ ë‹¬ ë‚ ì§œë“¤ (7ì˜ ë°°ìˆ˜ë¡œ ë§ì¶”ê¸°)
            const totalCells = daysContainer.children.length;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            
            for (let day = 1; day <= remainingCells; day++) {
                const btn = createDayButton(day, 'other-month');
                btn.onclick = () => {
                    nextMonth();
                    setTimeout(() => {
                        selectDate(new Date(year, month + 1, day));
                    }, 10);
                };
                daysContainer.appendChild(btn);
            }
        }

        function createDayButton(day, className = '') {
            const btn = document.createElement('button');
            btn.className = 'date-picker-day ' + className;
            btn.textContent = day;
            return btn;
        }

        function prevMonth() {
            currentPickerDate.setMonth(currentPickerDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentPickerDate.setMonth(currentPickerDate.getMonth() + 1);
            renderCalendar();
        }

        function selectToday() {
            selectDate(new Date());
        }

        function selectDate(date) {
            if (!datePickerTargetElement) return;
            
            // ë‚ ì§œ í¬ë§·íŒ… (ì›”-ì¼ë§Œ)
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const weekday = weekdays[date.getDay()];
            
            const dateString = `${month}-${day} (${weekday})`;
            
            // @ ì œê±°í•˜ê³  ë‚ ì§œ íƒœê·¸ ì‚½ì…
            const content = datePickerTargetElement.innerHTML;
            const lastAtIndex = content.lastIndexOf('@');
            
            if (lastAtIndex !== -1) {
                const before = content.substring(0, lastAtIndex);
                const after = content.substring(lastAtIndex + 1);
                
                // ë‚ ì§œ íƒœê·¸ ìƒì„±
                const dateTag = createDateTag(date, dateString);
                
                datePickerTargetElement.innerHTML = before;
                datePickerTargetElement.appendChild(dateTag);
                datePickerTargetElement.innerHTML += after;
                
                // ì•„ì´í…œ ë°ì´í„° ì €ì¥
                const id = parseInt(datePickerTargetElement.dataset.id);
                const item = findItemInArray(data.items, id);
                if (item) {
                    item.text = datePickerTargetElement.innerHTML;
                    saveToLocalStorage();
                }
                
                // ì»¤ì„œë¥¼ ë‚ ì§œ íƒœê·¸ ë’¤ë¡œ ì´ë™
                moveCursorAfterElement(dateTag);
            }
            
            closeDatePicker();
        }

        function createDateTag(date, dateString) {
            const span = document.createElement('span');
            span.className = 'date-tag';
            span.contentEditable = false;
            span.textContent = 'ğŸ“… ' + dateString;
            
            // ê³¼ê±°/ì˜¤ëŠ˜/ë¯¸ë˜ êµ¬ë¶„
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const compareDate = new Date(date);
            compareDate.setHours(0, 0, 0, 0);
            
            if (compareDate < today) {
                span.classList.add('past');
            } else if (compareDate.getTime() === today.getTime()) {
                span.classList.add('today');
            }
            
            return span;
        }

        function moveCursorAfterElement(element) {
            const range = document.createRange();
            const selection = window.getSelection();
            
            // ìš”ì†Œ ë‹¤ìŒì— ê³µë°± ì¶”ê°€
            const space = document.createTextNode('\u00A0');
            element.parentNode.insertBefore(space, element.nextSibling);
            
            range.setStartAfter(space);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function closeDatePicker() {
            document.getElementById('datePicker').classList.remove('show');
            datePickerVisible = false;
            datePickerTargetElement = null;
        }

        // ë‹¬ë ¥ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(e) {
            const picker = document.getElementById('datePicker');
            if (datePickerVisible && !picker.contains(e.target) && !e.target.classList.contains('text')) {
                closeDatePicker();
            }
        });

        // ========================================
        // í…ìŠ¤íŠ¸ í¬ë§·íŒ…
        // ========================================
        function showFormatToolbar() {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) {
                document.getElementById('formatToolbar').classList.remove('show');
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            const toolbar = document.getElementById('formatToolbar');
            
            // íˆ´ë°” ìœ„ì¹˜ ê³„ì‚° (ì„ íƒ ì˜ì—­ ìœ„ìª½ì— í‘œì‹œ)
            let top = rect.top - 180; // íˆ´ë°” ë†’ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ìœ„ì— í‘œì‹œ
            let left = rect.left;
            
            // í™”ë©´ ìœ„ìª½ì„ ë²—ì–´ë‚˜ë©´ ì•„ë˜ìª½ì— í‘œì‹œ
            if (top < 10) {
                top = rect.bottom + 10;
            }
            
            // í™”ë©´ ì˜¤ë¥¸ìª½ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡
            if (left + 320 > window.innerWidth) {
                left = window.innerWidth - 330;
            }
            
            toolbar.style.left = Math.max(10, left) + 'px';
            toolbar.style.top = top + 'px';
            toolbar.classList.add('show');
        }

        function applyFormat(className) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const span = document.createElement('span');
            span.className = className;
            
            try {
                range.surroundContents(span);
            } catch (e) {
                // ì´ë¯¸ í¬ë§·ëœ í…ìŠ¤íŠ¸ì˜ ê²½ìš°
                const fragment = range.extractContents();
                span.appendChild(fragment);
                range.insertNode(span);
            }

            // ë³€ê²½ì‚¬í•­ ì €ì¥
            const textEl = selection.anchorNode.parentElement.closest('.text');
            if (textEl) {
                const id = parseInt(textEl.dataset.id);
                const item = findItemInArray(data.items, id);
                if (item) {
                    item.text = textEl.innerHTML;
                    saveToLocalStorage();
                }
            }

            document.getElementById('formatToolbar').classList.remove('show');
        }

        function removeFormat() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;
            
            if (container.nodeType === Node.TEXT_NODE && container.parentElement.tagName === 'SPAN') {
                const span = container.parentElement;
                const parent = span.parentElement;
                parent.replaceChild(document.createTextNode(span.textContent), span);
            }

            // ë³€ê²½ì‚¬í•­ ì €ì¥
            const textEl = selection.anchorNode.parentElement.closest('.text');
            if (textEl) {
                const id = parseInt(textEl.dataset.id);
                const item = findItemInArray(data.items, id);
                if (item) {
                    item.text = textEl.innerHTML;
                    saveToLocalStorage();
                }
            }

            document.getElementById('formatToolbar').classList.remove('show');
        }

        // ========================================
        // íˆ´ë°” ê¸€ìë³µì‚¬ ë° ë‹«ê¸°
        // ========================================
        function copySelectedText() {
            const selection = window.getSelection();
            if (!selection.rangeCount) {
                showToast('âš ï¸ ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const selectedText = selection.toString();
            if (!selectedText) {
                showToast('âš ï¸ ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(selectedText).then(() => {
                    showToast('ğŸ“‹ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closeFormatToolbar();
                }).catch(err => {
                    // í´ë°±: êµ¬í˜• ë°©ì‹
                    fallbackCopy(selectedText);
                });
            } else {
                // êµ¬í˜• ë¸Œë¼ìš°ì € í´ë°±
                fallbackCopy(selectedText);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('ğŸ“‹ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeFormatToolbar();
            } catch (err) {
                showToast('âŒ ë³µì‚¬ ì‹¤íŒ¨');
            }
            
            document.body.removeChild(textarea);
        }

        function closeFormatToolbar() {
            document.getElementById('formatToolbar').classList.remove('show');
        }
    </script>

    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>

<script>
// === Pointer-drag fallback + child-friendly positioning ===
(function(){
  var ptrDragging = false;
  var ptrStartEl = null;
  var ptrCandidateTarget = null;
  var ptrCandidatePos = 'child';

  function computePosition(el, clientY, clientX){
    var rect = el.getBoundingClientRect();
    var h = rect.height;
    var topQ = rect.top + h * 0.30;      // widened bands
    var botQ = rect.bottom - h * 0.30;
    if (clientY < topQ) return 'before';
    if (clientY > botQ) return 'after';
    var indentThresh = rect.left + Math.min(40, rect.width * 0.25);
    if (clientX > indentThresh) return 'child';
    return 'child';
  }

  function clearHL(el){
    if(!el) return;
    el.classList.remove('drag-over-top','drag-over-bottom','drag-over-child');
  }
  function setHL(el, pos){
    clearHL(el);
    if(!el) return;
    if(pos==='before') el.classList.add('drag-over-top');
    else if(pos==='after') el.classList.add('drag-over-bottom');
    else el.classList.add('drag-over-child');
  }

  function onMouseMove(e){
    if(!ptrDragging || !ptrStartEl) return;
    var el = document.elementFromPoint(e.clientX, e.clientY);
    if(!el){
      if(ptrCandidateTarget){ clearHL(ptrCandidateTarget); ptrCandidateTarget=null; }
      return;
    }
    var target = el.closest && el.closest('.item');
    if(!target){
      if(ptrCandidateTarget){ clearHL(ptrCandidateTarget); ptrCandidateTarget=null; }
      return;
    }
    try {
      var startId = parseInt(ptrStartEl.dataset.id);
      var tgtId = parseInt(target.dataset.id);
      if(target === ptrStartEl || (typeof isDescendant==='function' && isDescendant(startId, tgtId))){
        if(ptrCandidateTarget){ clearHL(ptrCandidateTarget); }
        ptrCandidateTarget = null;
        return;
      }
    } catch(_) {}

    var pos = computePosition(target, e.clientY, e.clientX);
    if(ptrCandidateTarget && ptrCandidateTarget!==target) clearHL(ptrCandidateTarget);
    ptrCandidateTarget = target;
    ptrCandidatePos = pos;
    setHL(target, pos);
  }

  function onMouseUp(e){
    if(!ptrDragging) return;
    document.removeEventListener('mousemove', onMouseMove, true);
    document.removeEventListener('mouseup', onMouseUp, true);
    try{
      if(ptrStartEl && ptrCandidateTarget){
        var fromId = parseInt(ptrStartEl.dataset.id);
        var toId = parseInt(ptrCandidateTarget.dataset.id);
        var pos = ptrCandidatePos || 'child';
        if(typeof moveItemAnywhere === 'function'){
          moveItemAnywhere(fromId, toId, pos);
        }
      }
    } finally {
      if(ptrCandidateTarget) clearHL(ptrCandidateTarget);
      ptrDragging = false;
      ptrStartEl = null;
      ptrCandidateTarget = null;
    }
  }

  function startPointerDragFromBullet(bullet, ev){
    ev.preventDefault();
    var item = bullet.closest('.item');
    if(!item) return;
    ptrDragging = true;
    ptrStartEl = item;
    document.addEventListener('mousemove', onMouseMove, true);
    document.addEventListener('mouseup', onMouseUp, true);
  }

  function bindPointerFallback(){
    document.querySelectorAll('.bullet').forEach(function(b){
      if(b.__ptrBound) return;
      b.__ptrBound = true;
      b.addEventListener('mousedown', function(ev){
        if(ev.button !== 0) return;
        startPointerDragFromBullet(b, ev);
      }, true);
      b.addEventListener('touchstart', function(ev){
        var t = ev.touches && ev.touches[0];
        if(!t) return;
        startPointerDragFromBullet(b, ev);
      }, {passive:false});
      b.addEventListener('touchmove', function(ev){
        var t = ev.touches && ev.touches[0];
        if(!t) return;
        onMouseMove({clientX: t.clientX, clientY: t.clientY});
        ev.preventDefault();
      }, {passive:false});
      b.addEventListener('touchend', function(ev){
        onMouseUp(ev);
      });
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindPointerFallback);
  } else {
    bindPointerFallback();
  }
  if(typeof MutationObserver !== 'undefined'){
    var mo = new MutationObserver(function(){
      bindPointerFallback();
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }
})();
</script>

</body>
</html>