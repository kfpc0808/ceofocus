<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üîî ÏïåÎ¶º Íµ¨ÎèÖ - KFPC</title>
    
    <!-- Google OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: clamp(25px, 5vw, 40px);
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .icon {
            font-size: clamp(48px, 12vw, 64px);
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: clamp(22px, 5vw, 28px);
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 25px;
            font-size: clamp(13px, 3vw, 14px);
            line-height: 1.5;
        }
        
        .benefits {
            text-align: left;
            margin: 25px 0;
            padding: clamp(15px, 3vw, 20px);
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .benefit-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: clamp(13px, 3vw, 14px);
        }
        
        .benefit-item:last-child {
            margin-bottom: 0;
        }
        
        .benefit-icon {
            font-size: clamp(20px, 4vw, 24px);
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .consultant-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: clamp(15px, 3vw, 20px);
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid #1976d2;
        }
        
        .consultant-name {
            font-size: clamp(18px, 4vw, 20px);
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .consultant-title {
            color: #666;
            font-size: clamp(12px, 3vw, 14px);
        }
        
        .subscribe-btn {
            width: 100%;
            padding: clamp(15px, 3vw, 18px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: clamp(16px, 3.5vw, 18px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
        }
        
        .subscribe-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .subscribe-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .subscribe-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: clamp(13px, 3vw, 14px);
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-message.show {
            display: block;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .privacy-notice {
            margin-top: 20px;
            font-size: clamp(11px, 2.5vw, 12px);
            color: #999;
            line-height: 1.6;
        }
        
        .footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: clamp(10px, 2.5vw, 12px);
            color: #999;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: clamp(12px, 3vw, 13px);
            color: #856404;
            text-align: left;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üîî</div>
        <h1>ÏïåÎ¶ºÎ∞õÍ∏∞</h1>
        <p class="subtitle"><span id="displayCustomerName"></span>ÎãòÍªò Í∞ÄÏû• Í∑ÄÌïòÍ≥† Í∞ÄÏπòÏûàÎäî Ï†ïÎ≥¥Î•º Ï†ÑÌï¥ÎìúÎ¶ΩÎãàÎã§.</p>
        
        <!-- Îã¥Îãπ Ïª®ÏÑ§ÌÑ¥Ìä∏ Ï†ïÎ≥¥ -->
        <div class="consultant-info" id="consultantInfo">
            <div class="consultant-signature" id="consultantSignature" style="font-size: clamp(14px, 3vw, 16px); color: #1976d2; line-height: 1.6;">
                <span id="companyName"></span> <span id="consultantName"></span> <span id="consultantTitle"></span> ÎìúÎ¶º
            </div>
        </div>
        
        <!-- Íµ¨ÎèÖ Î≤ÑÌäº -->
        <button class="subscribe-btn" id="subscribeBtn" onclick="subscribePush()">
            Î∞õÍ∏∞
        </button>
        
        <!-- ÏÉÅÌÉú Î©îÏãúÏßÄ -->
        <div class="status-message" id="statusMessage"></div>
        
        <!-- Í∞úÏù∏Ï†ïÎ≥¥ ÏïàÎÇ¥ -->
        <div class="privacy-notice">
            *ÏïåÎ¶ºÏùÑ ÌóàÏö©ÌïòÏãúÎ©¥ Ï†ïÎ≥¥Î•º Î∞õÏïÑÎ≥¥Ïã§ Ïàò ÏûàÏúºÎ©∞, Ïñ∏Ï†úÎì†ÏßÄ Ìï¥Ï†úÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.
        </div>
        
        <div class="footer">
            ¬© 2025 KFPC. All rights reserved.
        </div>
    </div>

    <script>
        // ================================================================
        // Ï†ÑÏó≠ Î≥ÄÏàò
        // ================================================================
        
        let gapiLoaded = false;
        let gisLoaded = false;
        let tokenClient;
        let accessToken = null;
        
        // Google Drive API ÏÑ§Ï†ï
        const CLIENT_ID = '288996084140-0eo93heqd66hqhg0fh1rbum6scnt3757.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBl4elHOfZ97gcK5vBQol9f0PUYxaK80Qk';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        
        // Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
            authDomain: "kfpc-company-support-project.firebaseapp.com",
            databaseURL: "https://kfpc-company-support-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kfpc-company-support-project",
            storageBucket: "kfpc-company-support-project.firebasestorage.app",
            messagingSenderId: "1012609333373",
            appId: "1:1012609333373:web:ffba9039a7f9568356d914",
            measurementId: "G-Y757PLYBEE"
        };
        
        // Firebase Ï¥àÍ∏∞Ìôî
        let firebaseAuth = null;
        let currentUser = null;
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                firebaseAuth = firebase.auth();
            }
        } catch (error) {
            console.warn('Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
        }
        
        // Drive Ìè¥Îçî Î∞è ÌååÏùº ÏÑ§Ï†ï
        const FOLDER_NAME = 'KFPC_PushSystem';
        const SUBSCRIBERS_FILE = 'subscribers.json';
        
        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const urlParams = new URLSearchParams(window.location.search);
        const consultantId = urlParams.get('c') || urlParams.get('consultant') || 'default';
        const customerId = urlParams.get('id') || urlParams.get('customer') || null;
        const customerName = decodeURIComponent(urlParams.get('name') || 'Í≥†Í∞ù');
        const consultantName = decodeURIComponent(urlParams.get('c') || 'Îã¥ÎãπÏûê');
        const consultantTitle = decodeURIComponent(urlParams.get('title') || 'Ïû¨Î¨¥ Ïª®ÏÑ§ÌÑ¥Ìä∏');
        const companyName = decodeURIComponent(urlParams.get('company') || 'KFPC');
        
        // ÌôîÎ©¥Ïóê Ï†ïÎ≥¥ ÌëúÏãú
        document.getElementById('displayCustomerName').textContent = customerName;
        document.getElementById('companyName').textContent = companyName;
        document.getElementById('consultantName').textContent = consultantName;
        document.getElementById('consultantTitle').textContent = consultantTitle;
        
        // ================================================================
        // Google API Ï¥àÍ∏∞Ìôî
        // ================================================================
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiLoaded = true;
                console.log('‚úÖ GAPI ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå GAPI Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
            }
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisLoaded = true;
            console.log('‚úÖ GIS Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        }
        
        // ================================================================
        // Firebase Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
        // ================================================================
        
        async function checkFirebaseLogin() {
            if (!firebaseAuth) return;
            
            return new Promise((resolve) => {
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        console.log('‚úÖ Firebase Î°úÍ∑∏Ïù∏ ÏôÑÎ£å:', user.email);
                        resolve(true);
                    } else {
                        console.log('‚ÑπÔ∏è Firebase Î°úÍ∑∏Ïù∏ ÌïÑÏöî');
                        
                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            await firebaseAuth.signInWithPopup(provider);
                            console.log('‚úÖ Firebase ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏôÑÎ£å');
                            resolve(true);
                        } catch (error) {
                            console.warn('Firebase Î°úÍ∑∏Ïù∏ Ïã§Ìå®:', error);
                            resolve(false);
                        }
                    }
                });
            });
        }
        
        // ================================================================
        // Google Drive Ïó∞Îèô Ìï®Ïàò
        // ================================================================
        
        async function getAccessToken() {
            return new Promise((resolve, reject) => {
                try {
                    tokenClient.callback = async (response) => {
                        if (response.error !== undefined) {
                            reject(response);
                        }
                        accessToken = response.access_token;
                        resolve(accessToken);
                    };
                    
                    if (accessToken === null) {
                        tokenClient.requestAccessToken({prompt: 'consent'});
                    } else {
                        tokenClient.requestAccessToken({prompt: ''});
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        async function findFolder(folderName) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                return response.result.files.length > 0 ? response.result.files[0].id : null;
            } catch (error) {
                console.error('Ìè¥Îçî Ï∞æÍ∏∞ Ïò§Î•ò:', error);
                return null;
            }
        }
        
        async function createFolder(folderName) {
            try {
                const response = await gapi.client.drive.files.create({
                    resource: {
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder'
                    },
                    fields: 'id'
                });
                
                return response.result.id;
            } catch (error) {
                console.error('Ìè¥Îçî ÏÉùÏÑ± Ïò§Î•ò:', error);
                return null;
            }
        }
        
        async function findFileInFolder(fileName, folderId) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                return response.result.files.length > 0 ? response.result.files[0] : null;
            } catch (error) {
                console.error('ÌååÏùº Ï∞æÍ∏∞ Ïò§Î•ò:', error);
                return null;
            }
        }
        
        async function loadSubscribers(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                return JSON.parse(response.body);
            } catch (error) {
                console.error('Íµ¨ÎèÖÏûê Î°úÎìú Ïò§Î•ò:', error);
                return [];
            }
        }
        
        async function saveSubscribers(subscribers, folderId, fileId = null) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            
            const metadata = {
                name: SUBSCRIBERS_FILE,
                mimeType: 'application/json',
                parents: [folderId]
            };
            
            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(subscribers, null, 2) +
                close_delim;
            
            try {
                const response = await gapi.client.request({
                    path: fileId ? `/upload/drive/v3/files/${fileId}` : '/upload/drive/v3/files',
                    method: fileId ? 'PATCH' : 'POST',
                    params: {
                        uploadType: 'multipart'
                    },
                    headers: {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    body: multipartRequestBody
                });
                
                return response.result.id;
            } catch (error) {
                console.error('Íµ¨ÎèÖÏûê Ï†ÄÏû• Ïò§Î•ò:', error);
                throw error;
            }
        }
        
        // ================================================================
        // ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
        // ================================================================
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.innerHTML = message;
            statusEl.className = `status-message show ${type}`;
            
            // 5Ï¥à ÌõÑ ÏûêÎèô Ïà®ÍπÄ (ÏóêÎü¨ Ï†úÏô∏)
            if (type !== 'error') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 5000);
            }
        }
        
        // ================================================================
        // Ìë∏Ïãú Íµ¨ÎèÖ Î©îÏù∏ Ìï®Ïàò
        // ================================================================
        
        window.subscribePush = async function() {
            const btn = document.getElementById('subscribeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Ï≤òÎ¶¨ Ï§ë...';
            
            try {
                // 1. Î∏åÎùºÏö∞Ï†Ä ÏßÄÏõê ÌôïÏù∏
                if (!('Notification' in window)) {
                    throw new Error('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                }
                
                // 2. ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠
                showStatus('üì± ÏïåÎ¶º Í∂åÌïúÏùÑ ÏöîÏ≤≠ÌïòÍ≥† ÏûàÏäµÎãàÎã§...', 'info');
                const permission = await Notification.requestPermission();
                
                if (permission !== 'granted') {
                    throw new Error('ÏïåÎ¶º Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏïåÎ¶ºÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                // 3. Google Drive Ïù∏Ï¶ù
                showStatus('üîê Google Í≥ÑÏ†ï Ïó∞Í≤∞ Ï§ë...', 'info');
                if (!gapiLoaded || !gisLoaded) {
                    throw new Error('Google APIÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                await getAccessToken();
                
                // Firebase Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
                await checkFirebaseLogin();
                
                // 4. Íµ¨ÎèÖ Ï†ïÎ≥¥ Ï†ÄÏû•
                showStatus('üíæ Íµ¨ÎèÖ Ï†ïÎ≥¥Î•º Ï†ÄÏû•ÌïòÍ≥† ÏûàÏäµÎãàÎã§...', 'info');
                await saveSubscription();
                
                // 5. ÏôÑÎ£å
                showStatus('‚úÖ ÏïåÎ¶º Íµ¨ÎèÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!<br>Ïù¥Ï†ú Ïã§ÏãúÍ∞Ñ Ï†ïÎ≥¥Î•º Î∞õÏïÑÎ≥¥Ïã§ Ïàò ÏûàÏäµÎãàÎã§.', 'success');
                btn.innerHTML = '‚úÖ Íµ¨ÎèÖ ÏôÑÎ£å';
                btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                
                // ÌÖåÏä§Ìä∏ ÏïåÎ¶º ÌëúÏãú
                setTimeout(() => {
                    new Notification('üéâ Íµ¨ÎèÖ ÏôÑÎ£å!', {
                        body: `${consultantName}ÎãòÏùò ÏïåÎ¶ºÏùÑ Î∞õÏùÑ Ï§ÄÎπÑÍ∞Ä ÎêòÏóàÏäµÎãàÎã§.`,
                        icon: 'üîî',
                        badge: 'üîî'
                    });
                }, 1000);
                
                // 5Ï¥à ÌõÑ Ï∞Ω Îã´Í∏∞ ÎòêÎäî Î¶¨Îã§Ïù¥Î†âÌä∏
                setTimeout(() => {
                    showStatus('‚úÖ Íµ¨ÎèÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Ïù¥ Ï∞ΩÏùÑ Îã´ÏúºÏÖîÎèÑ Îê©ÎãàÎã§.', 'success');
                }, 3000);
                
            } catch (error) {
                console.error('Íµ¨ÎèÖ Ïò§Î•ò:', error);
                let errorMessage = '‚ùå ' + error.message;
                
                if (error.message.includes('Í∂åÌïú')) {
                    errorMessage += '<br><br>üí° <strong>Ìï¥Í≤∞ Î∞©Î≤ï:</strong><br>1. Î∏åÎùºÏö∞Ï†Ä Ï£ºÏÜåÏ∞Ω ÏôºÏ™Ω ÏûêÎ¨ºÏá† ÏïÑÏù¥ÏΩò ÌÅ¥Î¶≠<br>2. ÏïåÎ¶º Í∂åÌïúÏùÑ "ÌóàÏö©"ÏúºÎ°ú Î≥ÄÍ≤Ω<br>3. ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑ';
                }
                
                showStatus(errorMessage, 'error');
                btn.disabled = false;
                btn.innerHTML = 'üîî ÏïåÎ¶º Î∞õÍ∏∞';
            }
        };
        
        // ================================================================
        // Íµ¨ÎèÖ Ï†ïÎ≥¥ Ï†ÄÏû•
        // ================================================================
        
        async function saveSubscription() {
            try {
                // Ìè¥Îçî ÌôïÏù∏ ÎòêÎäî ÏÉùÏÑ±
                let folderId = await findFolder(FOLDER_NAME);
                if (!folderId) {
                    folderId = await createFolder(FOLDER_NAME);
                }
                
                if (!folderId) {
                    throw new Error('Drive Ìè¥ÎçîÎ•º ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
                // Í∏∞Ï°¥ Íµ¨ÎèÖÏûê ÌååÏùº ÌôïÏù∏
                const file = await findFileInFolder(SUBSCRIBERS_FILE, folderId);
                let subscribers = [];
                
                if (file) {
                    subscribers = await loadSubscribers(file.id);
                }
                
                // ÏÉà Íµ¨ÎèÖÏûê Ï†ïÎ≥¥ ÏÉùÏÑ±
                const newSubscriber = {
                    id: Date.now(),
                    consultantId: consultantId,
                    customerId: customerId,
                    customerName: customerName,
                    consultantName: consultantName,
                    subscribedAt: new Date().toISOString(),
                    permission: 'granted',
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    notificationToken: 'browser-notification-' + Date.now(), // Í∞ÑÎã®Ìïú ÌÜ†ÌÅ∞
                    status: 'active'
                };
                
                // Í∏∞Ï°¥ Íµ¨ÎèÖÏûê ÌôïÏù∏ (Ï§ëÎ≥µ Î∞©ÏßÄ)
                const existingIndex = subscribers.findIndex(s => 
                    s.customerId === customerId && s.consultantId === consultantId
                );
                
                if (existingIndex >= 0) {
                    // Í∏∞Ï°¥ Íµ¨ÎèÖÏûê ÏóÖÎç∞Ïù¥Ìä∏
                    subscribers[existingIndex] = {
                        ...subscribers[existingIndex],
                        ...newSubscriber,
                        updatedAt: new Date().toISOString()
                    };
                    console.log('‚úÖ Í∏∞Ï°¥ Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏');
                } else {
                    // ÏÉà Íµ¨ÎèÖÏûê Ï∂îÍ∞Ä
                    subscribers.push(newSubscriber);
                    console.log('‚úÖ ÏÉà Íµ¨ÎèÖÏûê Ï∂îÍ∞Ä');
                }
                
                // DriveÏóê Ï†ÄÏû•
                await saveSubscribers(subscribers, folderId, file ? file.id : null);
                
                // localStorageÏóêÎèÑ Î∞±ÏóÖ Ï†ÄÏû•
                localStorage.setItem('kfpc_subscriber_info', JSON.stringify(newSubscriber));
                
                console.log('‚úÖ Íµ¨ÎèÖ Ï†ïÎ≥¥ Ï†ÄÏû• ÏôÑÎ£å:', newSubscriber);
                
            } catch (error) {
                console.error('Íµ¨ÎèÖ Ï†ïÎ≥¥ Ï†ÄÏû• Ïò§Î•ò:', error);
                throw new Error('Íµ¨ÎèÖ Ï†ïÎ≥¥ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // ================================================================
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌôïÏù∏
        // ================================================================
        
        window.addEventListener('load', async () => {
            // Ïù¥ÎØ∏ Íµ¨ÎèÖÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            if ('Notification' in window && Notification.permission === 'granted') {
                const savedInfo = localStorage.getItem('kfpc_subscriber_info');
                if (savedInfo) {
                    showStatus('‚úÖ Ïù¥ÎØ∏ ÏïåÎ¶ºÏùÑ Íµ¨ÎèÖÌïòÍ≥† Í≥ÑÏã≠ÎãàÎã§.', 'info');
                    document.getElementById('subscribeBtn').innerHTML = '‚úÖ Íµ¨ÎèÖ Ï§ë';
                    document.getElementById('subscribeBtn').style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                }
            }
            
            // URL ÌååÎùºÎØ∏ÌÑ∞ Î°úÍ∑∏ (ÎîîÎ≤ÑÍπÖÏö©)
            console.log('üìä Íµ¨ÎèÖ ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥:', {
                consultantId,
                customerId,
                customerName,
                consultantName,
                consultantTitle
            });
        });
        
        // GAPI Î∞è GIS Î°úÎìú
        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;
    </script>
    
    <!-- Google API Î°úÎìú -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
