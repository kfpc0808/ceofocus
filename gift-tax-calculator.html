<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ì¦ì—¬ì„¸ ì™„ì „ ê³„ì‚°ê¸° - KFPC</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%);
            min-height: 100vh;
            padding: 1rem;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 2rem;
            font-weight: 900;
            color: #1565c0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            letter-spacing: 2px;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: rgba(21, 101, 192, 0.1);
            border: 2px solid rgba(21, 101, 192, 0.3);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #1565c0;
            transition: all 0.3s;
            z-index: 100;
        }

        .close-btn:hover {
            background: rgba(21, 101, 192, 0.2);
            transform: rotate(90deg);
            border-color: #1565c0;
        }

        .close-btn:active {
            transform: rotate(90deg) scale(0.95);
        }

        .header {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #1976d2;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }

        .info-box p {
            color: #0d47a1;
            font-size: 0.85rem;
            line-height: 1.5;
            margin: 0.25rem 0;
        }

        .warning-badge {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .law-badge {
            display: inline-block;
            background: #1976d2;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.25rem;
        }

        .form-table {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .section-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .form-row {
            display: grid;
            grid-template-columns: 250px 1fr;
            border-bottom: 1px solid #e0e0e0;
            min-height: 60px;
        }

        .form-label {
            background: #f8f9fa;
            padding: 1rem;
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            border-right: 1px solid #e0e0e0;
        }

        .form-label.required::before {
            content: '*';
            color: #d32f2f;
            margin-right: 0.25rem;
            font-weight: 700;
        }

        .form-content {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .input-field {
            padding: 0.5rem 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25,118,210,0.1);
        }

        .input-number {
            width: 200px;
            text-align: right;
        }

        .input-date {
            width: auto;
            min-width: 150px;
        }

        select.input-field {
            cursor: pointer;
            background: white;
        }

        .unit {
            color: #666;
            font-size: 0.9rem;
        }

        .help-text {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.5;
            margin-top: 0.5rem;
            width: 100%;
        }

        .law-reference {
            font-size: 0.8rem;
            color: #1976d2;
            font-weight: 600;
            margin-top: 0.25rem;
            width: 100%;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-input {
            width: 1.2rem;
            height: 1.2rem;
            cursor: pointer;
        }

        .btn-primary {
            padding: 0.6rem 1.5rem;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-primary:hover {
            background: #1565c0;
            transform: translateY(-1px);
        }

        .btn-secondary {
            padding: 0.6rem 1.5rem;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .calculate-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, #1976d2 0%, #3949ab 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 2rem;
            box-shadow: 0 4px 15px rgba(25,118,210,0.3);
            transition: all 0.3s;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25,118,210,0.4);
        }

        .result-summary {
            background: linear-gradient(135deg, #1976d2 0%, #3949ab 100%);
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(25,118,210,0.3);
            padding: 2rem;
            color: white;
            margin: 1.5rem 0;
        }

        .result-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .result-amount {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
        }

        .result-note {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .detail-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .detail-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .detail-row.total {
            font-weight: 700;
            font-size: 1.15rem;
            border-top: 2px solid #e0e0e0;
            margin-top: 0.5rem;
            padding-top: 1rem;
        }

        .detail-label {
            color: #555;
        }

        .detail-value {
            font-weight: 600;
            color: #1976d2;
        }

        .explanation {
            background: #e3f2fd;
            border-left: 3px solid #1976d2;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
        }

        .explanation-title {
            font-weight: 700;
            color: #0d47a1;
            margin-bottom: 0.5rem;
        }

        .explanation-text {
            color: #1565c0;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .warning-box {
            background: #fff8e1;
            border: 2px solid #ffd54f;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }

        .warning-box strong {
            color: #f57f17;
            display: block;
            margin-bottom: 0.5rem;
        }

        .warning-box p {
            color: #f57f17;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 1rem;
        }

        .modal-body {
            color: #333;
            line-height: 1.8;
        }

        .modal-body h3 {
            color: #1976d2;
            margin: 1.5rem 0 0.75rem 0;
            font-size: 1.1rem;
        }

        .modal-body ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal-body li {
            margin-bottom: 0.5rem;
        }

        .modal-btn {
            width: 100%;
            padding: 1rem;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1.5rem;
        }

        .chart-container {
            margin: 1.5rem 0;
            padding: 1.5rem;
            border-radius: 0.75rem;
        }

        .footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1.5rem;
            color: #666;
            font-size: 0.85rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding: 2rem 0;
        }

        .history-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            border-left: 3px solid #1976d2;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-item-date {
            font-weight: 600;
            color: #1976d2;
        }

        .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .logo {
                font-size: 1.5rem;
            }

            .header {
                padding: 1.5rem;
            }

            .page-title {
                font-size: 1.4rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-label {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .input-number {
                width: 100%;
            }

            .result-amount {
                font-size: 2rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="guideModal" class="modal active">
        <div class="modal-content">
            <div class="modal-header">ğŸ“Š ì¦ì—¬ì„¸ ì™„ì „ ê³„ì‚°ê¸° ì‚¬ìš© ê°€ì´ë“œ</div>
            <div class="modal-body">
                <p><strong>í™˜ì˜í•©ë‹ˆë‹¤!</strong> ì´ ê³„ì‚°ê¸°ëŠ” 2025ë…„ í˜„í–‰ ì„¸ë²•ì˜ ëª¨ë“  ì¦ì—¬ ìœ í˜•ì„ í¬í•¨í•œ ì™„ì „íŒì…ë‹ˆë‹¤.</p>
                
                <h3>âœ¨ ì™„ì „íŒì˜ íŠ¹ì§•</h3>
                <ul>
                    <li>âœ… ì¼ë°˜ ì¦ì—¬ / ë¶€ë‹´ë¶€ì¦ì—¬ êµ¬ë¶„</li>
                    <li>âœ… ì¬ì‚° ìœ í˜•ë³„ ìƒì„¸ ì…ë ¥ (ë¶€ë™ì‚°, ê¸ˆìœµ, ì£¼ì‹ ë“±)</li>
                    <li>âœ… 10ë…„ ë‚´ ì¦ì—¬ì´ë ¥ ìƒì„¸ ê´€ë¦¬</li>
                    <li>âœ… í˜¼ì¸/ì¶œì‚° ì¦ì—¬ì¬ì‚° ê³µì œ (ê° ìµœëŒ€ 1ì–µì›)</li>
                    <li>âœ… ìƒì¥ì£¼ì‹ í• ì¦í‰ê°€ (ìµœëŒ€ì£¼ì£¼ 20%)</li>
                    <li>âœ… ë¹„ìƒì¥ì£¼ì‹ í• ì¦í‰ê°€ (ìµœëŒ€ì£¼ì£¼ 20%)</li>
                    <li>âœ… ì„¸ëŒ€ìƒëµ í• ì¦ê³¼ì„¸ 30%</li>
                    <li>âœ… ì‹ ê³ ì„¸ì•¡ê³µì œ 3%</li>
                    <li>âœ… ì‹ ê³ ê¸°í•œ ìë™ ê³„ì‚°</li>
                    <li>âœ… ê´€ë ¨ ë²•ë¥  ì¡°í•­ í‘œì‹œ</li>
                </ul>
                
                <h3>ğŸ’¡ ì…ë ¥ ìˆœì„œ</h3>
                <ul>
                    <li><strong>1ë‹¨ê³„:</strong> ì¦ì—¬ì¼ì ë° ìˆ˜ì¦ì ì •ë³´ ì…ë ¥</li>
                    <li><strong>2ë‹¨ê³„:</strong> ì¦ì—¬ì¬ì‚° ìƒì„¸ ì…ë ¥ (ìœ í˜•ë³„)</li>
                    <li><strong>3ë‹¨ê³„:</strong> ë¶€ë‹´ë¶€ì¦ì—¬ ì‹œ ì±„ë¬´ì•¡ ì…ë ¥</li>
                    <li><strong>4ë‹¨ê³„:</strong> 10ë…„ ë‚´ ì¦ì—¬ì´ë ¥ ì…ë ¥</li>
                    <li><strong>5ë‹¨ê³„:</strong> íŠ¹ìˆ˜ê³µì œ (í˜¼ì¸/ì¶œì‚°) ì…ë ¥</li>
                    <li><strong>6ë‹¨ê³„:</strong> í• ì¦ í•­ëª© í™•ì¸</li>
                </ul>

                <h3>âš ï¸ ì¤‘ìš” ì‚¬í•­</h3>
                <ul>
                    <li>ëª¨ë“  ê¸ˆì•¡ì€ <strong>ì›í™”(â‚©)</strong> ê¸°ì¤€ì…ë‹ˆë‹¤.</li>
                    <li>ìë™ìœ¼ë¡œ ì²œë‹¨ìœ„ ì½¤ë§ˆê°€ í‘œì‹œë©ë‹ˆë‹¤.</li>
                    <li>ì¦ì—¬ì¼ë¡œë¶€í„° 3ê°œì›” ì´ë‚´ ì‹ ê³  í•„ìˆ˜</li>
                    <li>ë¶€ë‹´ë¶€ì¦ì—¬ëŠ” ì¦ì—¬ì„¸+ì–‘ë„ì†Œë“ì„¸ ì¤‘ê³¼ ëŒ€ìƒ</li>
                    <li>10ë…„ ë‚´ ë™ì¼ì¸ ì¦ì—¬ëŠ” í•©ì‚°ê³¼ì„¸</li>
                    <li>ìˆ«ì ì…ë ¥ë€ì€ í´ë¦­í•˜ë©´ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                </ul>

                <p style="margin-top: 1.5rem; color: #d32f2f; font-weight: 600;">
                    â€» ì •í™•í•œ ì„¸ì•¡ ì‚°ì •ì€ ì„¸ë¬´ì‚¬ ë“± ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
                </p>
            </div>
            <button class="modal-btn" onclick="closeGuide()">í™•ì¸í•˜ê³  ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="container">
        <div class="logo">KFPC</div>

        <div class="header">
            <h1 class="page-title">
                ì¦ì—¬ì„¸ ì™„ì „ ê³„ì‚°ê¸°
                <span class="warning-badge">ì„¸ë²• ì™„ì „ ì¤€ìˆ˜</span>
            </h1>
            <div class="info-box">
                <p>âœ… 2025ë…„ í˜„í–‰ ì„¸ë²• 100% ë°˜ì˜ | ëª¨ë“  ì¦ì—¬ ìœ í˜• í¬í•¨ | ì„¸ë²• ê¸°ì¤€ ì •í™•í•œ ê³„ì‚°</p>
            </div>
        </div>

        <div class="form-table">
            <div class="section-header">ğŸ“… ê¸°ë³¸ ì •ë³´</div>
            
            <div class="form-row">
                <div class="form-label required">ì¦ì—¬ì¼ì</div>
                <div class="form-content">
                    <input type="date" id="giftDate" class="input-field input-date" value="2025-10-19">
                    <div class="help-text">ì¦ì—¬ê°€ ì´ë£¨ì–´ì§„ ë‚ ì§œë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”. (ì‹ ê³ ê¸°í•œ: ì¦ì—¬ì¼ë¡œë¶€í„° 3ê°œì›” ì´ë‚´)</div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ68ì¡° - ì¦ì—¬ì„¸ ê³¼ì„¸í‘œì¤€ ì‹ ê³ </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label required">ì¦ì—¬ìì™€ì˜ ê´€ê³„</div>
                <div class="form-content">
                    <select id="relation" class="input-field" onchange="updateDeductionInfo()">
                        <option value="spouse">ë°°ìš°ì</option>
                        <option value="lineal_descendant_adult">ì§ê³„ë¹„ì† (ì„±ë…„, ë§Œ 19ì„¸ ì´ìƒ)</option>
                        <option value="lineal_descendant_minor">ì§ê³„ë¹„ì† (ë¯¸ì„±ë…„, ë§Œ 19ì„¸ ë¯¸ë§Œ)</option>
                        <option value="lineal_ascendant">ì§ê³„ì¡´ì† (ë¶€ëª¨, ì¡°ë¶€ëª¨)</option>
                        <option value="other_relative">ê¸°íƒ€ ì¹œì¡± (6ì´Œ ì´ë‚´ í˜ˆì¡±, 4ì´Œ ì´ë‚´ ì¸ì²™)</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                    <div class="help-text" id="deductionInfo">ë°°ìš°ì: 6ì–µì› ê³µì œ</div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ53ì¡° - ì¦ì—¬ì¬ì‚°ê³µì œ</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label">ì¦ì—¬ ìœ í˜•</div>
                <div class="form-content">
                    <select id="giftType" class="input-field" onchange="toggleDebtFields()">
                        <option value="normal">ì¼ë°˜ ì¦ì—¬</option>
                        <option value="burden">ë¶€ë‹´ë¶€ ì¦ì—¬</option>
                    </select>
                    <div class="help-text">
                        <strong>ë¶€ë‹´ë¶€ì¦ì—¬:</strong> ì±„ë¬´ë¥¼ í•¨ê»˜ ì´ì „í•˜ëŠ” ì¦ì—¬<br>
                        â€¢ ì¦ì—¬ì: ì±„ë¬´ì•¡ ë¹„ìœ¨ë§Œí¼ ì–‘ë„ì†Œë“ì„¸ ê³¼ì„¸ (ì†Œë“ì„¸ë²• ì œ88ì¡°)<br>
                        â€¢ ìˆ˜ì¦ì: (ì¦ì—¬ì¬ì‚°ê°€ì•¡ - ì±„ë¬´) Ã— ì¦ì—¬ì„¸ìœ¨ë¡œ ì¦ì—¬ì„¸ ê³¼ì„¸
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ47ì¡° ì œ2í•­ - ë¶€ë‹´ë¶€ì¦ì—¬</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label">ìˆ˜ì¦ì ê±°ì£¼ ì—¬ë¶€</div>
                <div class="form-content">
                    <select id="residency" class="input-field">
                        <option value="resident">ê±°ì£¼ì</option>
                        <option value="non_resident">ë¹„ê±°ì£¼ì</option>
                    </select>
                    <div class="help-text">
                        <strong>ë¹„ê±°ì£¼ì:</strong> êµ­ë‚´ ì¬ì‚°ë§Œ ê³¼ì„¸, ê³µì œì•¡ 2ì²œë§Œì› ì ìš©<br>
                        ê±°ì£¼ì íŒì •ì€ êµ­ë‚´ì— ì£¼ì†Œë¥¼ ë‘ê±°ë‚˜ 183ì¼ ì´ìƒ ê±°ì†Œë¥¼ ë‘” ê²½ìš°
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ2ì¡°, ì œ53ì¡° ì œ1í•­ - ê±°ì£¼ìì™€ ë¹„ê±°ì£¼ì</div>
                </div>
            </div>
        </div>

        <div class="form-table">
            <div class="section-header">ğŸ  ì¦ì—¬ì¬ì‚° ìƒì„¸</div>

            <div class="form-row">
                <div class="form-label">ë¶€ë™ì‚°</div>
                <div class="form-content">
                    <input type="text" id="realEstate" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <div class="help-text">
                        í† ì§€, ê±´ë¬¼, ì•„íŒŒíŠ¸ ë“± (ì‹œê°€ ë˜ëŠ” ê¸°ì¤€ì‹œê°€)<br>
                        <strong>í‰ê°€ë°©ë²•:</strong> â‘  ì‹œê°€ (ë§¤ë§¤ì‚¬ë¡€ê°€ì•¡, ê°ì •ê°€ì•¡ ë“±) â‘¡ ë³´ì¶©ì  í‰ê°€ë°©ë²• (ê³µì‹œê°€ê²© ë“±)
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ60ì¡° ë‚´ì§€ ì œ66ì¡° - ì¬ì‚°ì˜ í‰ê°€</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label">í˜„ê¸ˆ ë° ì˜ˆê¸ˆ</div>
                <div class="form-content">
                    <input type="text" id="cash" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <div class="help-text">í˜„ê¸ˆ, ë³´í†µì˜ˆê¸ˆ, ì •ê¸°ì˜ˆê¸ˆ, ì ê¸ˆ, MMF, CMA ë“± ê¸ˆìœµìƒí’ˆ</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label">ìƒì¥ì£¼ì‹</div>
                <div class="form-content">
                    <input type="text" id="listedStocks" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <div class="checkbox-wrapper" style="margin-left: 1rem;">
                        <input type="checkbox" id="listedMajorShareholder" class="checkbox-input">
                        <label for="listedMajorShareholder">ìµœëŒ€ì£¼ì£¼ (20% í• ì¦)</label>
                    </div>
                    <div class="help-text">
                        <strong>í‰ê°€:</strong> ì¦ì—¬ì¼ ì „í›„ 2ê°œì›” í‰ê·  ì¢…ê°€<br>
                        <strong>ìµœëŒ€ì£¼ì£¼:</strong> ë³¸ì¸ + íŠ¹ìˆ˜ê´€ê³„ì¸ ì§€ë¶„ í•©ê³„ ê¸°ì¤€ìœ¼ë¡œ 20% í• ì¦ í‰ê°€<br>
                        (ì¤‘ì†Œê¸°ì—… ë° ë§¤ì¶œì•¡ 5ì²œì–µ ë¯¸ë§Œ ì¤‘ê²¬ê¸°ì—… ì œì™¸)
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ63ì¡°, ì œ63ì¡°ì˜2 - ì£¼ì‹í‰ê°€ ë° í• ì¦</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label">ë¹„ìƒì¥ì£¼ì‹</div>
                <div class="form-content">
                    <input type="text" id="unlistedStocks" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <div class="checkbox-wrapper" style="margin-left: 1rem;">
                        <input type="checkbox" id="unlistedMajorShareholder" class="checkbox-input">
                        <label for="unlistedMajorShareholder">ìµœëŒ€ì£¼ì£¼ (20% í• ì¦)</label>
                    </div>
                    <div class="help-text">
                        <strong>í‰ê°€:</strong> ìˆœì†ìµê°€ì¹˜(3ë…„ í‰ê· )ì™€ ìˆœìì‚°ê°€ì¹˜ì˜ ê°€ì¤‘í‰ê·  (3:2)<br>
                        <strong>ìµœëŒ€ì£¼ì£¼:</strong> ë³¸ì¸ + íŠ¹ìˆ˜ê´€ê³„ì¸ ì§€ë¶„ í•©ê³„ ê¸°ì¤€ìœ¼ë¡œ 20% í• ì¦ í‰ê°€<br>
                        (ì¤‘ì†Œê¸°ì—… ë° ì¤‘ê²¬ê¸°ì—… ì œì™¸)
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ63ì¡°, ì œ63ì¡°ì˜2 - ì£¼ì‹í‰ê°€ ë° í• ì¦</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label">ì±„ê¶Œ ë° ì¦ê¶Œ</div>
                <div class="form-content">
                    <input type="text" id="bonds" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <div class="help-text">íšŒì‚¬ì±„, êµ­ì±„, ì§€ë°©ì±„, í€ë“œ, ETF ë“± ìœ ê°€ì¦ê¶Œ</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label">ê¸°íƒ€ ì¬ì‚°</div>
                <div class="form-content">
                    <input type="text" id="otherAssets" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <div class="help-text">ê³¨í”„íšŒì›ê¶Œ, ìë™ì°¨, ê·€ê¸ˆì†, ì§€ì ì¬ì‚°ê¶Œ, ì˜ì—…ê¶Œ ë“±</div>
                </div>
            </div>
        </div>

        <div class="form-table" id="debtSection" style="display: none;">
            <div class="section-header">ğŸ’³ ë¶€ë‹´ë¶€ì¦ì—¬ ì±„ë¬´</div>

            <div class="form-row">
                <div class="form-label">ì¸ìˆ˜ ì±„ë¬´ì•¡</div>
                <div class="form-content">
                    <input type="text" id="assumedDebt" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <div class="help-text">ìˆ˜ì¦ìê°€ ì¸ìˆ˜í•˜ëŠ” ì±„ë¬´ì•¡ (ì €ë‹¹ê¶Œ, ì „ì„¸ë³´ì¦ê¸ˆ, ëŒ€ì¶œê¸ˆ ë“±)</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label"></div>
                <div class="form-content">
                    <div style="background: #fff3e0; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #ff9800; width: 100%;">
                        <strong style="color: #f57f17;">âš ï¸ ë¶€ë‹´ë¶€ì¦ì—¬ ì£¼ì˜ì‚¬í•­</strong>
                        <p style="color: #f57f17; font-size: 0.85rem; margin-top: 0.5rem; line-height: 1.6;">
                            â€¢ <strong>ì¦ì—¬ì„¸:</strong> (ì¦ì—¬ì¬ì‚°ê°€ì•¡ - ì±„ë¬´) Ã— ì„¸ìœ¨<br>
                            â€¢ <strong>ì–‘ë„ì†Œë“ì„¸:</strong> ì¦ì—¬ìì—ê²Œ ì±„ë¬´ì•¡ ë¹„ìœ¨ë§Œí¼ ì–‘ë„ì„¸ ê³¼ì„¸ (ì†Œë“ì„¸ë²• ì œ88ì¡°)<br>
                            â€¢ <strong>ì·¨ë“ì„¸:</strong> ì±„ë¬´ì•¡ í¬í•¨ ì „ì²´ ê°€ì•¡ì— ëŒ€í•´ ê³¼ì„¸<br>
                            â€¢ ë¶€ë‹´ë¶€ì¦ì—¬ëŠ” ì¦ì—¬ì„¸ì™€ ì–‘ë„ì„¸ê°€ ë™ì‹œì— ë°œìƒí•˜ë¯€ë¡œ ì„¸ë¬´ì‚¬ ìƒë‹´ í•„ìˆ˜
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-table">
            <div class="section-header">ğŸ“œ 10ë…„ ë‚´ ë™ì¼ì¸ ì¦ì—¬ ì´ë ¥</div>

            <div class="form-row">
                <div class="form-label"></div>
                <div class="form-content">
                    <button type="button" class="btn-primary" onclick="addGiftHistory()">+ ì¦ì—¬ ì´ë ¥ ì¶”ê°€</button>
                    <div class="help-text">
                        <strong>í•©ì‚°ê³¼ì„¸:</strong> ë™ì¼ì¸ìœ¼ë¡œë¶€í„° 10ë…„ ë‚´ ë°›ì€ ì¦ì—¬ëŠ” í•©ì‚°í•˜ì—¬ ê³¼ì„¸ë©ë‹ˆë‹¤.<br>
                        ì¦ì—¬ì¬ì‚°ê³µì œëŠ” 10ë…„ê°„ 1íšŒë§Œ ì ìš©ë˜ë¯€ë¡œ, ì´ì „ ì¦ì—¬ì‹œ ê³µì œë°›ì€ ê¸ˆì•¡ì€ ì°¨ê°ë©ë‹ˆë‹¤.
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ47ì¡° ì œ2í•­ - ì¦ì—¬ì¬ì‚°ì˜ í•©ì‚°ê³¼ì„¸</div>
                    <div id="giftHistoryList" style="width: 100%; margin-top: 1rem;"></div>
                </div>
            </div>
        </div>

        <div class="form-table">
            <div class="section-header">ğŸ íŠ¹ìˆ˜ ê³µì œ í•­ëª©</div>

            <div class="form-row">
                <div class="form-label">í˜¼ì¸ ì¦ì—¬ì¬ì‚° ê³µì œ</div>
                <div class="form-content">
                    <input type="text" id="marriageDeduction" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <span class="warning-badge">ìµœëŒ€ 1ì–µì›</span>
                    <div class="help-text">
                        <strong>ìš”ê±´:</strong> í˜¼ì¸ì‹ ê³ ì¼ ì „í›„ ê° 2ë…„ ì´ë‚´ ì§ê³„ì¡´ì†ìœ¼ë¡œë¶€í„° ë°›ì€ ì¬ì‚° (ìµœëŒ€ 1ì–µì› í•œë„)<br>
                        ì¦ì—¬ì„¸ ê³¼ì„¸í‘œì¤€ ì‹ ê³ ì„œì— í˜¼ì¸ì‹ ê³  ì‚¬ì‹¤ ì…ì¦ì„œë¥˜ ì²¨ë¶€ í•„ìš”
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ53ì¡° ì œ1í•­ ì œ2í˜¸ - í˜¼ì¸ì¦ì—¬ì¬ì‚°ê³µì œ</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-label">ì¶œì‚°Â·ì…ì–‘ ì¦ì—¬ì¬ì‚° ê³µì œ</div>
                <div class="form-content">
                    <input type="text" id="childbirthDeduction" class="input-field input-number" value="0" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                    <span class="unit">ì›</span>
                    <span class="warning-badge">ìµœëŒ€ 1ì–µì›</span>
                    <div class="help-text">
                        <strong>ìš”ê±´:</strong> ìë…€ ì¶œìƒì¼ ë˜ëŠ” ì…ì–‘ì‹ ê³ ì¼ë¡œë¶€í„° 2ë…„ ì´ë‚´ ì§ê³„ì¡´ì†ìœ¼ë¡œë¶€í„° ë°›ì€ ì¬ì‚° (ìµœëŒ€ 1ì–µì›)<br>
                        ìë…€ 1ëª…ë‹¹ 1íšŒì— í•œí•´ ì ìš©
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ53ì¡° ì œ1í•­ ì œ3í˜¸ - ì¶œì‚°Â·ì…ì–‘ê³µì œ</div>
                </div>
            </div>
        </div>

        <div class="form-table">
            <div class="section-header">âš¡ í• ì¦ ê³¼ì„¸ í•­ëª©</div>

            <div class="form-row">
                <div class="form-label">ì„¸ëŒ€ìƒëµ í• ì¦ê³¼ì„¸</div>
                <div class="form-content">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="generationSkipping" class="checkbox-input">
                        <label for="generationSkipping">ì„¸ëŒ€ìƒëµ ì¦ì—¬ í•´ë‹¹ (30% í• ì¦)</label>
                    </div>
                    <div class="help-text">
                        <strong>ëŒ€ìƒ:</strong> ì§ê³„ë¹„ì†(ìë…€)ì„ ì œì³ë‘ê³  ì†ìë…€ì—ê²Œ ì§ì ‘ ì¦ì—¬ ì‹œ 30% í• ì¦<br>
                        <strong>ì˜ˆì™¸:</strong> ìë…€ê°€ ì‚¬ë§í•œ ê²½ìš°, ìë…€ê°€ ì—†ëŠ” ê²½ìš° ë“±ì€ ì œì™¸
                    </div>
                    <div class="law-reference">ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ57ì¡° - ì„¸ëŒ€ìƒëµì¦ì—¬ì— ëŒ€í•œ í• ì¦ê³¼ì„¸</div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button type="button" class="btn-secondary" style="padding: 1rem 3rem;" onclick="resetForm()">ì´ˆê¸°í™”</button>
            <button type="button" class="calculate-btn" style="flex: 1; max-width: 400px; margin: 0;" onclick="calculate()">ğŸ’ ì¦ì—¬ì„¸ ê³„ì‚°í•˜ê¸°</button>
        </div>

        <div id="resultSection" style="display: none;">
            <div class="result-summary">
                <div class="result-title">ğŸ’° ìµœì¢… ë‚©ë¶€í•  ì¦ì—¬ì„¸</div>
                <div class="result-amount" id="finalTaxAmount">0 ì›</div>
                <div class="result-note" id="resultNote">ì‹ ê³ ì„¸ì•¡ê³µì œ 3% ì ìš© | ì„¸ëŒ€ìƒëµ/ìµœëŒ€ì£¼ì£¼ í• ì¦ ë°˜ì˜</div>
            </div>

            <div class="explanation">
                <div class="explanation-title">ğŸ“Œ ê³„ì‚° ê²°ê³¼ ìš”ì•½</div>
                <div class="explanation-text" id="summaryText"></div>
            </div>

            <div class="explanation" style="background: #fff3e0; border-left: 3px solid #ff9800;">
                <div class="explanation-title" style="color: #f57f17;">â° ì‹ ê³  ê¸°í•œ ì•ˆë‚´</div>
                <div class="explanation-text" style="color: #f57f17;" id="deadlineText"></div>
            </div>

            <div class="detail-card">
                <div class="detail-title">ğŸ“Š ìƒì„¸ ê³„ì‚° ë‚´ì—­</div>
                <div id="detailContent"></div>
            </div>

            <div class="detail-card">
                <div class="detail-title">ğŸ“ˆ ì¦ì—¬ì¬ì‚° êµ¬ì„±</div>
                <div class="chart-container">
                    <canvas id="assetChart"></canvas>
                </div>
            </div>

            <div class="detail-card">
                <div class="detail-title">ğŸ“‹ ì¦ì—¬ì„¸ ì„¸ìœ¨í‘œ (2025ë…„ í˜„í–‰)</div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #ddd;">ê³¼ì„¸í‘œì¤€</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #ddd;">ì„¸ìœ¨</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #ddd;">ëˆ„ì§„ê³µì œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td style="padding: 0.75rem; border-bottom: 1px solid #eee;">1ì–µì› ì´í•˜</td>
                            <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #eee;">10%</td>
                            <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #eee;">-</td></tr>
                        <tr><td style="padding: 0.75rem; border-bottom: 1px solid #eee;">1ì–µì› ì´ˆê³¼ ~ 5ì–µì›</td>
                            <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #eee;">20%</td>
                            <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #eee;">1ì²œë§Œì›</td></tr>
                        <tr><td style="padding: 0.75rem; border-bottom: 1px solid #eee;">5ì–µì› ì´ˆê³¼ ~ 10ì–µì›</td>
                            <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #eee;">30%</td>
                            <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #eee;">6ì²œë§Œì›</td></tr>
                        <tr><td style="padding: 0.75rem; border-bottom: 1px solid #eee;">10ì–µì› ì´ˆê³¼ ~ 30ì–µì›</td>
                            <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #eee;">40%</td>
                            <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #eee;">1ì–µ 6ì²œë§Œì›</td></tr>
                        <tr><td style="padding: 0.75rem;">30ì–µì› ì´ˆê³¼</td>
                            <td style="padding: 0.75rem; text-align: right;">50%</td>
                            <td style="padding: 0.75rem; text-align: right;">4ì–µ 6ì²œë§Œì›</td></tr>
                    </tbody>
                </table>
                <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                    â€» ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ56ì¡° - ì¦ì—¬ì„¸ ì„¸ìœ¨
                </div>
            </div>
        </div>

        <div class="warning-box">
            <strong>âš ï¸ ì¤‘ìš” ìœ ì˜ì‚¬í•­</strong>
            <p>
                â€¢ ë³¸ ê³„ì‚°ê¸°ëŠ” 2025ë…„ í˜„í–‰ ì„¸ë²•ì„ ê¸°ì¤€ìœ¼ë¡œ ì œì‘ë˜ì—ˆìœ¼ë©°, ëª¨ë“  ì¦ì—¬ ìœ í˜•ì„ í¬í•¨í•©ë‹ˆë‹¤.<br>
                â€¢ ì„¸ë²•ì— ë”°ë¥¸ ì •í™•í•œ ê³„ì‚°ì‹ì„ ì ìš©í•˜ì˜€ìœ¼ë‚˜, ê°œë³„ ì‚¬ì•ˆì˜ íŠ¹ìˆ˜ì„±ì€ ë°˜ì˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                â€¢ ì •í™•í•œ ì„¸ì•¡ ì‚°ì • ë° ì‹ ê³ ë¥¼ ìœ„í•´ì„œëŠ” ë°˜ë“œì‹œ ì„¸ë¬´ì‚¬ ë“± ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br>
                â€¢ <strong>ì¦ì—¬ì„¸ ì‹ ê³ ê¸°í•œ:</strong> ì¦ì—¬ì¼ì´ ì†í•˜ëŠ” ë‹¬ì˜ ë§ì¼ë¶€í„° 3ê°œì›” ì´ë‚´<br>
                â€¢ <strong>ì‹ ê³ ë¶ˆì„±ì‹¤ ê°€ì‚°ì„¸:</strong> ë¯¸ì‹ ê³  ì‹œ 20%, ê³¼ì†Œì‹ ê³  ì‹œ 10% ê°€ì‚°ì„¸ ë¶€ê³¼<br>
                â€¢ ë¶€ë‹´ë¶€ì¦ì—¬ëŠ” ì–‘ë„ì†Œë“ì„¸ë„ í•¨ê»˜ ë°œìƒí•˜ë¯€ë¡œ ì¢…í•©ì ì¸ ì„¸ë¬´ ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </p>
        </div>

        <div class="footer">
            Copyright Â© 2025 KFPC Co., Ltd. All Rights Reserved.<br>
            ë³¸ ê³„ì‚°ê¸°ëŠ” ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ë° ê´€ë ¨ ë²•ë ¹ì— ê·¼ê±°í•˜ì—¬ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
    </div>

    <script>
        let assetChart = null;
        let giftHistoryCount = 0;

        function closeGuide() {
            document.getElementById('guideModal').classList.remove('active');
        }

        // ë‹«ê¸° ë²„íŠ¼ - indexë¡œ ì´ë™
        function closeAndGoHome() {
            window.location.href = 'index.html';
        }

        function toggleDebtFields() {
            const giftType = document.getElementById('giftType').value;
            document.getElementById('debtSection').style.display = giftType === 'burden' ? 'block' : 'none';
        }

        function updateDeductionInfo() {
            const relation = document.getElementById('relation').value;
            const infoText = document.getElementById('deductionInfo');
            
            const deductions = {
                'spouse': 'ë°°ìš°ì: 6ì–µì› ê³µì œ (10ë…„ê°„ í•©ì‚°)',
                'lineal_descendant_adult': 'ì§ê³„ë¹„ì† (ì„±ë…„): 5ì²œë§Œì› ê³µì œ (10ë…„ê°„ í•©ì‚°)',
                'lineal_descendant_minor': 'ì§ê³„ë¹„ì† (ë¯¸ì„±ë…„): 2ì²œë§Œì› ê³µì œ (10ë…„ê°„ í•©ì‚°)',
                'lineal_ascendant': 'ì§ê³„ì¡´ì†: 5ì²œë§Œì› ê³µì œ (10ë…„ê°„ í•©ì‚°)',
                'other_relative': 'ê¸°íƒ€ ì¹œì¡±: 1ì²œë§Œì› ê³µì œ (10ë…„ê°„ í•©ì‚°)',
                'other': 'ê¸°íƒ€: ê³µì œ ì—†ìŒ'
            };
            
            infoText.textContent = deductions[relation] || '';
        }

        function formatNumber(num) {
            return Math.floor(num).toLocaleString('ko-KR');
        }

        function formatInput(input) {
            let value = input.value.replace(/,/g, '');
            if (!isNaN(value) && value !== '') {
                value = parseFloat(value);
                if (value < 0) value = 0;
                input.value = formatNumber(value);
            } else if (value === '') {
                input.value = '0';
            }
        }

        function formatInputRealtime(input) {
            // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ ì €ì¥
            let cursorPos = input.selectionStart;
            let oldValue = input.value;
            
            // ìˆ«ìì™€ ì½¤ë§ˆë§Œ ë‚¨ê¸°ê³  ëª¨ë‘ ì œê±°
            let value = input.value.replace(/[^\d,]/g, '');
            
            // ì½¤ë§ˆ ì œê±°
            value = value.replace(/,/g, '');
            
            // ë¹ˆ ê°’ ì²˜ë¦¬
            if (value === '') {
                input.value = '';
                return;
            }
            
            // 0ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° ì²˜ë¦¬ (0ì€ í—ˆìš©, 01, 02 ë“±ì€ 1, 2ë¡œ ë³€í™˜)
            if (value.length > 1 && value[0] === '0') {
                value = parseInt(value, 10).toString();
            }
            
            // ìˆ«ìë¥¼ ì²œë‹¨ìœ„ ì½¤ë§ˆë¡œ í¬ë§·íŒ…
            let formatted = formatNumber(parseInt(value, 10));
            
            // ì½¤ë§ˆ ê°œìˆ˜ ë³€í™” ê³„ì‚°
            let oldCommaCount = (oldValue.substring(0, cursorPos).match(/,/g) || []).length;
            let newCommaCount = (formatted.substring(0, cursorPos).match(/,/g) || []).length;
            
            // ìƒˆë¡œìš´ ê°’ ì„¤ì •
            input.value = formatted;
            
            // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
            let newCursorPos = cursorPos + (newCommaCount - oldCommaCount);
            input.setSelectionRange(newCursorPos, newCursorPos);
        }

        function parseValue(value) {
            if (typeof value === 'string') {
                return parseFloat(value.replace(/,/g, '')) || 0;
            }
            return parseFloat(value) || 0;
        }

        function addGiftHistory() {
            giftHistoryCount++;
            const container = document.getElementById('giftHistoryList');
            const div = document.createElement('div');
            div.className = 'history-item';
            div.id = `history_${giftHistoryCount}`;
            div.innerHTML = `
                <div class="history-item-header">
                    <span class="history-item-date">ì¦ì—¬ ${giftHistoryCount}</span>
                    <button type="button" class="remove-btn" onclick="removeHistory(${giftHistoryCount})">ì‚­ì œ</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                    <input type="date" id="historyDate_${giftHistoryCount}" class="input-field" style="width: 100%;">
                    <input type="text" id="historyAmount_${giftHistoryCount}" class="input-field" placeholder="ì¦ì—¬ê°€ì•¡" style="width: 100%; text-align: right;" inputmode="numeric" pattern="[0-9,]*" oninput="formatInputRealtime(this)">
                </div>
            `;
            container.appendChild(div);
        }

        function removeHistory(id) {
            const element = document.getElementById(`history_${id}`);
            if (element) element.remove();
        }

        function resetForm() {
            if (confirm('ì…ë ¥í•œ ë‚´ìš©ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                location.reload();
            }
        }

        function calculate() {
            try {
                const giftDateInput = document.getElementById('giftDate').value;
                if (!giftDateInput) {
                    alert('ì¦ì—¬ì¼ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                const giftDate = new Date(giftDateInput);
                
                const relation = document.getElementById('relation').value;
                const giftType = document.getElementById('giftType').value;
                const residency = document.getElementById('residency').value;

                const realEstate = parseValue(document.getElementById('realEstate').value);
                const cash = parseValue(document.getElementById('cash').value);
                let listedStocks = parseValue(document.getElementById('listedStocks').value);
                let unlistedStocks = parseValue(document.getElementById('unlistedStocks').value);
                const bonds = parseValue(document.getElementById('bonds').value);
                const otherAssets = parseValue(document.getElementById('otherAssets').value);

                const listedMajor = document.getElementById('listedMajorShareholder').checked;
                const unlistedMajor = document.getElementById('unlistedMajorShareholder').checked;
                
                const listedOriginal = listedStocks;
                const unlistedOriginal = unlistedStocks;
                
                if (listedMajor) listedStocks = listedStocks * 1.2;
                if (unlistedMajor) unlistedStocks = unlistedStocks * 1.2;

                const totalAssets = realEstate + cash + listedStocks + unlistedStocks + bonds + otherAssets;

                if (totalAssets <= 0) {
                    alert('ì¦ì—¬ì¬ì‚°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const assumedDebt = giftType === 'burden' ? parseValue(document.getElementById('assumedDebt').value) : 0;
                const giftAmount = totalAssets - assumedDebt;

                let priorGifts = 0;
                const historyItems = document.querySelectorAll('[id^="historyAmount_"]');
                historyItems.forEach(item => {
                    priorGifts += parseValue(item.value);
                });

                let baseDeduction = 0;
                if (residency === 'non_resident') {
                    baseDeduction = 20000000;
                } else {
                    const deductions = {
                        'spouse': 600000000,
                        'lineal_descendant_adult': 50000000,
                        'lineal_descendant_minor': 20000000,
                        'lineal_ascendant': 50000000,
                        'other_relative': 10000000,
                        'other': 0
                    };
                    baseDeduction = deductions[relation] || 0;
                }

                let marriageDeduction = parseValue(document.getElementById('marriageDeduction').value);
                marriageDeduction = Math.min(marriageDeduction, 100000000);
                
                let childbirthDeduction = parseValue(document.getElementById('childbirthDeduction').value);
                childbirthDeduction = Math.min(childbirthDeduction, 100000000);

                const totalDeduction = baseDeduction + marriageDeduction + childbirthDeduction;

                const totalGiftAmount = giftAmount + priorGifts;
                let taxBase = Math.max(0, totalGiftAmount - totalDeduction);

                let calculatedTax = 0;
                if (taxBase > 3000000000) {
                    calculatedTax = taxBase * 0.5 - 460000000;
                } else if (taxBase > 1000000000) {
                    calculatedTax = taxBase * 0.4 - 160000000;
                } else if (taxBase > 500000000) {
                    calculatedTax = taxBase * 0.3 - 60000000;
                } else if (taxBase > 100000000) {
                    calculatedTax = taxBase * 0.2 - 10000000;
                } else if (taxBase > 0) {
                    calculatedTax = taxBase * 0.1;
                }
                calculatedTax = Math.floor(calculatedTax);

                const generationSkipping = document.getElementById('generationSkipping').checked;
                let generationSurcharge = 0;
                let totalTax = calculatedTax;
                if (generationSkipping) {
                    generationSurcharge = Math.floor(calculatedTax * 0.3);
                    totalTax += generationSurcharge;
                }

                const reportDeduction = Math.floor(totalTax * 0.03);
                const finalTax = Math.floor(totalTax - reportDeduction);

                const deadline = new Date(giftDate);
                deadline.setMonth(deadline.getMonth() + 3);
                const lastDay = new Date(deadline.getFullYear(), deadline.getMonth() + 1, 0);
                deadline.setDate(Math.min(deadline.getDate(), lastDay.getDate()));

                displayResults({
                    giftDate, realEstate, cash, listedStocks: listedOriginal, unlistedStocks: unlistedOriginal,
                    listedStocksValued: listedStocks, unlistedStocksValued: unlistedStocks,
                    bonds, otherAssets, listedMajor, unlistedMajor, totalAssets, assumedDebt, giftAmount,
                    priorGifts, totalGiftAmount, baseDeduction, marriageDeduction,
                    childbirthDeduction, totalDeduction, taxBase, calculatedTax,
                    generationSkipping, generationSurcharge, totalTax, reportDeduction,
                    finalTax, deadline, relation, giftType, residency
                });

            } catch (error) {
                alert('ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nëª¨ë“  ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + error.message);
            }
        }

        function displayResults(r) {
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('finalTaxAmount').textContent = formatNumber(r.finalTax) + ' ì›';
            
            let noteText = 'ì‹ ê³ ì„¸ì•¡ê³µì œ 3% ì ìš©';
            if (r.generationSkipping) noteText += ' | ì„¸ëŒ€ìƒëµ í• ì¦ 30%';
            if (r.listedMajor || r.unlistedMajor) noteText += ' | ìµœëŒ€ì£¼ì£¼ í• ì¦ 20%';
            document.getElementById('resultNote').textContent = noteText;

            let summary = `ì´ ì¦ì—¬ì¬ì‚° ${formatNumber(r.totalAssets)}ì›`;
            if (r.assumedDebt > 0) summary += ` (ì±„ë¬´ ${formatNumber(r.assumedDebt)}ì› ì°¨ê°)`;
            if (r.priorGifts > 0) summary += `, 10ë…„ ë‚´ ì¦ì—¬ì´ë ¥ ${formatNumber(r.priorGifts)}ì›ì„ í•©ì‚°`;
            summary += `í•˜ì—¬ ì´ ${formatNumber(r.totalGiftAmount)}ì›ì—ì„œ `;
            summary += `ì¦ì—¬ì¬ì‚°ê³µì œ ${formatNumber(r.totalDeduction)}ì›ì„ ì°¨ê°í•œ `;
            summary += `ê³¼ì„¸í‘œì¤€ ${formatNumber(r.taxBase)}ì›ì´ ì‚°ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. `;
            if (r.generationSkipping) summary += `ì„¸ëŒ€ìƒëµ í• ì¦ ${formatNumber(r.generationSurcharge)}ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. `;
            summary += `ìµœì¢… ë‚©ë¶€ì„¸ì•¡ì€ ${formatNumber(r.finalTax)}ì›ì…ë‹ˆë‹¤.`;
            
            document.getElementById('summaryText').textContent = summary;

            const deadlineStr = `${r.deadline.getFullYear()}ë…„ ${r.deadline.getMonth() + 1}ì›” ${r.deadline.getDate()}ì¼`;
            document.getElementById('deadlineText').innerHTML = `
                <strong>ì¦ì—¬ì¼:</strong> ${r.giftDate.getFullYear()}ë…„ ${r.giftDate.getMonth() + 1}ì›” ${r.giftDate.getDate()}ì¼<br>
                <strong>ì‹ ê³ ê¸°í•œ:</strong> ${deadlineStr}ê¹Œì§€ (ì¦ì—¬ì¼ ì†í•œ ë‹¬ì˜ ë§ì¼ë¶€í„° 3ê°œì›”)<br>
                <strong>ì‹ ê³ ë°©ë²•:</strong> ê´€í•  ì„¸ë¬´ì„œ ë°©ë¬¸ ë˜ëŠ” í™ˆíƒìŠ¤ ì „ìì‹ ê³ <br>
                <strong>ë‚©ë¶€ë°©ë²•:</strong> ì „ìë‚©ë¶€, ì€í–‰ ë°©ë¬¸ë‚©ë¶€, ê³„ì¢Œì´ì²´ ë“±<br>
                <strong>â€»</strong> ê¸°í•œ ë‚´ ë¯¸ì‹ ê³  ì‹œ 20% ê°€ì‚°ì„¸, ê³¼ì†Œì‹ ê³  ì‹œ 10% ê°€ì‚°ì„¸ ë¶€ê³¼
            `;

            let html = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #1976d2; margin-bottom: 1rem;">1ï¸âƒ£ ì¦ì—¬ì¬ì‚°</h3>
                    <div class="detail-row"><span>ë¶€ë™ì‚°</span><span>${formatNumber(r.realEstate)} ì›</span></div>
                    <div class="detail-row"><span>í˜„ê¸ˆÂ·ì˜ˆê¸ˆ</span><span>${formatNumber(r.cash)} ì›</span></div>
                    <div class="detail-row"><span>ìƒì¥ì£¼ì‹</span><span>${formatNumber(r.listedStocks)} ì› ${r.listedMajor ? 'â†’ ' + formatNumber(r.listedStocksValued) + 'ì› (í• ì¦ 20%)' : ''}</span></div>
                    <div class="detail-row"><span>ë¹„ìƒì¥ì£¼ì‹</span><span>${formatNumber(r.unlistedStocks)} ì› ${r.unlistedMajor ? 'â†’ ' + formatNumber(r.unlistedStocksValued) + 'ì› (í• ì¦ 20%)' : ''}</span></div>
                    <div class="detail-row"><span>ì±„ê¶ŒÂ·ì¦ê¶Œ</span><span>${formatNumber(r.bonds)} ì›</span></div>
                    <div class="detail-row"><span>ê¸°íƒ€ì¬ì‚°</span><span>${formatNumber(r.otherAssets)} ì›</span></div>
                    <div class="detail-row total"><span>ì¦ì—¬ì¬ì‚° ì´ì•¡</span><span>${formatNumber(r.totalAssets)} ì›</span></div>
            `;

            if (r.assumedDebt > 0) {
                html += `<div class="detail-row" style="color: #f44336;"><span>(-) ì±„ë¬´ ì¸ìˆ˜ì•¡</span><span>${formatNumber(r.assumedDebt)} ì›</span></div>
                         <div class="detail-row total"><span>ìˆœ ì¦ì—¬ê°€ì•¡</span><span>${formatNumber(r.giftAmount)} ì›</span></div>`;
            }

            html += `</div>

                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #1976d2; margin-bottom: 1rem;">2ï¸âƒ£ ì¦ì—¬ì¬ì‚°ê³µì œ</h3>
                    <div class="detail-row"><span>ê¸°ë³¸ê³µì œ</span><span>${formatNumber(r.baseDeduction)} ì›</span></div>`;
            
            if (r.marriageDeduction > 0) html += `<div class="detail-row"><span>í˜¼ì¸ê³µì œ</span><span>${formatNumber(r.marriageDeduction)} ì›</span></div>`;
            if (r.childbirthDeduction > 0) html += `<div class="detail-row"><span>ì¶œì‚°ê³µì œ</span><span>${formatNumber(r.childbirthDeduction)} ì›</span></div>`;
            
            html += `<div class="detail-row total"><span>ì´ ê³µì œì•¡</span><span>${formatNumber(r.totalDeduction)} ì›</span></div>
                 </div>

                 <div style="margin-bottom: 2rem;">
                    <h3 style="color: #1976d2; margin-bottom: 1rem;">3ï¸âƒ£ ê³¼ì„¸í‘œì¤€ ë° ì„¸ì•¡</h3>
                    <div class="detail-row"><span>ì¦ì—¬ì¬ì‚°ê°€ì•¡</span><span>${formatNumber(r.giftAmount)} ì›</span></div>`;
            
            if (r.priorGifts > 0) {
                html += `<div class="detail-row"><span>(+) 10ë…„ ë‚´ ì¦ì—¬ì´ë ¥</span><span>${formatNumber(r.priorGifts)} ì›</span></div>
                         <div class="detail-row"><span>í•©ì‚° ì¦ì—¬ê°€ì•¡</span><span>${formatNumber(r.totalGiftAmount)} ì›</span></div>`;
            }
            
            html += `<div class="detail-row"><span>(-) ì¦ì—¬ì¬ì‚°ê³µì œ</span><span>${formatNumber(r.totalDeduction)} ì›</span></div>
                     <div class="detail-row total"><span>ê³¼ì„¸í‘œì¤€</span><span>${formatNumber(r.taxBase)} ì›</span></div>
                     <div class="detail-row"><span>ì‚°ì¶œì„¸ì•¡</span><span>${formatNumber(r.calculatedTax)} ì›</span></div>`;
            
            if (r.generationSkipping) {
                html += `<div class="detail-row" style="color: #d32f2f;"><span>(+) ì„¸ëŒ€ìƒëµ í• ì¦(30%)</span><span>${formatNumber(r.generationSurcharge)} ì›</span></div>`;
            }
            
            html += `<div class="detail-row" style="color: #43a047;"><span>(-) ì‹ ê³ ì„¸ì•¡ê³µì œ(3%)</span><span>${formatNumber(r.reportDeduction)} ì›</span></div>
                     <div class="detail-row total"><span>ìµœì¢… ë‚©ë¶€ì„¸ì•¡</span><span>${formatNumber(r.finalTax)} ì›</span></div>
                 </div>
                 <div style="background: #e3f2fd; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                    <div style="color: #1565c0; font-size: 0.9rem; line-height: 1.6;">
                        <strong>âœ” ê´€ë ¨ ë²•ë ¹</strong><br>
                        â€¢ ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ47ì¡° - ì¦ì—¬ì„¸ ê³¼ì„¸ê°€ì•¡<br>
                        â€¢ ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ53ì¡° - ì¦ì—¬ì¬ì‚°ê³µì œ<br>
                        â€¢ ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ56ì¡° - ì¦ì—¬ì„¸ ì„¸ìœ¨<br>
                        â€¢ ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ57ì¡° - ì„¸ëŒ€ìƒëµ í• ì¦<br>
                        â€¢ ìƒì†ì„¸ë°ì¦ì—¬ì„¸ë²• ì œ78ì¡° - ì‹ ê³ ì„¸ì•¡ê³µì œ
                    </div>
                </div>`;

            document.getElementById('detailContent').innerHTML = html;

            drawChart(r);

            setTimeout(() => {
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function drawChart(r) {
            const ctx = document.getElementById('assetChart').getContext('2d');
            if (assetChart) assetChart.destroy();
            
            const labels = [];
            const data = [];
            const colors = ['#1976d2', '#2196f3', '#42a5f5', '#64b5f6', '#90caf9', '#bbdefb'];
            
            if (r.realEstate > 0) { labels.push('ë¶€ë™ì‚°'); data.push(r.realEstate); }
            if (r.cash > 0) { labels.push('í˜„ê¸ˆÂ·ì˜ˆê¸ˆ'); data.push(r.cash); }
            if (r.listedStocksValued > 0) { labels.push('ìƒì¥ì£¼ì‹'); data.push(r.listedStocksValued); }
            if (r.unlistedStocksValued > 0) { labels.push('ë¹„ìƒì¥ì£¼ì‹'); data.push(r.unlistedStocksValued); }
            if (r.bonds > 0) { labels.push('ì±„ê¶ŒÂ·ì¦ê¶Œ'); data.push(r.bonds); }
            if (r.otherAssets > 0) { labels.push('ê¸°íƒ€ì¬ì‚°'); data.push(r.otherAssets); }
            
            assetChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                    return ctx.label + ': ' + formatNumber(ctx.parsed) + 'ì› (' + pct + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        window.onload = function() {
            updateDeductionInfo();
        };
    </script>
</body>
</html>