<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¨ ë°œì†¡ê´€ë¦¬ - Send Management</title>
    
    <!-- Google OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .back-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .drive-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .drive-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }
        
        .logout-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4);
        }
        
        /* í—¤ë” */
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        /* íƒ­ ë²„íŠ¼ */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }
        
        /* ì¹´ë“œ */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .card h2 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        /* í¼ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }
        
        /* ê³ ê° ë¦¬ìŠ¤íŠ¸ */
        .customer-search {
            margin-bottom: 15px;
        }
        
        .customer-search input {
            width: 100%;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 25px;
            color: #333;
            font-size: 14px;
        }
        
        .customer-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }
        
        .customer-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }
        
        .customer-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .customer-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .customer-info {
            flex: 1;
        }
        
        .customer-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 3px;
        }
        
        .customer-meta {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .position-input {
            width: 100px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: #333;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .position-label {
            font-size: 12px;
            opacity: 0.8;
            margin-right: 5px;
            flex-shrink: 0;
        }
        
        .select-all-container {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .select-all-container label {
            font-weight: bold;
            cursor: pointer;
        }
        
        .selected-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        
        /* ê¸°ë…ì¼ ë‹¬ë ¥ */
        .anniversary-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .anniversary-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .anniversary-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .anniversary-item.birthday {
            border-left-color: #ff6b9d;
        }
        
        .anniversary-item.anniversary {
            border-left-color: #ffd93d;
        }
        
        .anniversary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .anniversary-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .anniversary-date {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
        }
        
        .anniversary-type {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* ê°œì¸í™” ë³€ìˆ˜ ì•ˆë‚´ */
        .personalization-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .personalization-info strong {
            display: block;
            margin-bottom: 8px;
        }
        
        .variable-tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-family: monospace;
        }
        
        /* ë°˜ë³µ ì„¤ì • */
        .repeat-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            opacity: 0.9;
            font-size: 14px;
        }
        
        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .hidden {
            display: none;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .checkbox-label input {
            width: auto;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .repeat-settings {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="top-nav">
            <button class="back-btn" onclick="goBack()">â† ë’¤ë¡œê°€ê¸°</button>
            <div class="nav-buttons">
                <button class="drive-btn" onclick="connectDrive()" id="driveBtn">ğŸ”— ë“œë¼ì´ë¸Œ ì—°ë™</button>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- í—¤ë” -->
        <h1>ğŸ“¨ ë°œì†¡ê´€ë¦¬</h1>
        <p class="subtitle">ê³ ê° ë©”ì‹œì§€ ë°œì†¡ ë° ê¸°ë…ì¼ ìë™ ë°œì†¡ ê´€ë¦¬</p>

        <!-- íƒ­ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('send')">ğŸ“¤ ë©”ì‹œì§€ ë°œì†¡</button>
            <button class="tab-btn" onclick="switchTab('anniversary')">ğŸ‚ ê¸°ë…ì¼ ìë™ë°œì†¡</button>
            <button class="tab-btn" onclick="switchTab('log')">ğŸ“‹ ë°œì†¡ ë¡œê·¸</button>
            <button class="tab-btn" onclick="switchTab('template')">ğŸ“ í…œí”Œë¦¿</button>
        </div>

        <!-- ë°œì†¡ íƒ­ -->
        <div id="sendTab" class="tab-content">
            <div class="grid-2">
                <!-- ê³ ê° ì„ íƒ -->
                <div class="card">
                    <h2>ğŸ‘¥ ë°œì†¡ ëŒ€ìƒ ì„ íƒ</h2>
                    
                    <div class="customer-search">
                        <input type="text" id="customerSearch" placeholder="ğŸ” ê³ ê° ì´ë¦„, íšŒì‚¬ëª…ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="searchCustomers()">
                    </div>
                    
                    <div class="select-all-container">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label for="selectAll">ì „ì²´ ì„ íƒ</label>
                        <div class="selected-count" id="selectedCount">0ëª… ì„ íƒë¨</div>
                    </div>
                    
                    <div class="customer-list" id="customerList">
                        <p style="text-align: center; opacity: 0.7; padding: 20px;">
                            ë“œë¼ì´ë¸Œ ì—°ë™ í›„ ê³ ê° ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤
                        </p>
                    </div>
                </div>
                
                <!-- ë©”ì‹œì§€ ì‘ì„± -->
                <div class="card">
                    <h2>âœï¸ ë©”ì‹œì§€ ì‘ì„±</h2>
                    
                    <div class="personalization-info">
                        <strong>ğŸ’¡ ê°œì¸í™” ë³€ìˆ˜ ì‚¬ìš©í•˜ê¸°:</strong>
                        <span class="variable-tag">{name}</span> = ê³ ê° ì´ë¦„<br>
                        <span class="variable-tag">{position}</span> = ì§í•¨<br>
                        ì˜ˆì‹œ: "{name} {position}ë‹˜ ìƒì¼ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!"<br>
                        â†’ "í™ê¸¸ë™ ê³¼ì¥ë‹˜ ìƒì¼ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!"
                    </div>
                    
                    <form id="sendForm" onsubmit="sendMessage(event)">
                        <div class="form-group">
                            <label>ì œëª©</label>
                            <input type="text" id="messageTitle" required placeholder="ë©”ì‹œì§€ ì œëª©">
                        </div>
                        
                        <div class="form-group">
                            <label>ë³¸ë¬¸</label>
                            <textarea id="messageBody" required placeholder="{name} {position}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!"></textarea>
                        </div>
                        
                        <div class="checkbox-label">
                            <input type="checkbox" id="usePosition" checked>
                            <label for="usePosition">ì§í•¨ ì‚¬ìš© ("{position}ë‹˜" í˜•ì‹)</label>
                        </div>
                        
                        <div class="form-group">
                            <label>ë°œì†¡ ìœ í˜•</label>
                            <select id="sendType" onchange="toggleSchedule()">
                                <option value="immediate">ì¦‰ì‹œ ë°œì†¡</option>
                                <option value="scheduled">ì˜ˆì•½ ë°œì†¡</option>
                            </select>
                        </div>
                        
                        <div class="form-group hidden" id="scheduleGroup">
                            <label>ì˜ˆì•½ ë‚ ì§œ/ì‹œê°„</label>
                            <input type="datetime-local" id="scheduleTime">
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="resetSendForm()">ì·¨ì†Œ</button>
                            <button type="submit" class="btn btn-primary">ğŸš€ ë°œì†¡í•˜ê¸°</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ê¸°ë…ì¼ ìë™ë°œì†¡ íƒ­ -->
        <div id="anniversaryTab" class="tab-content hidden">
            <div class="card">
                <h2>ğŸ‚ ê¸°ë…ì¼ ëª©ë¡</h2>
                <p style="opacity: 0.8; margin-bottom: 20px;">
                    ê¸°ë…ì¼ì„ í´ë¦­í•˜ë©´ ìë™ ë°œì†¡ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </p>
                
                <div class="anniversary-list" id="anniversaryList">
                    <p style="text-align: center; opacity: 0.7; padding: 20px;">
                        ë“œë¼ì´ë¸Œ ì—°ë™ í›„ ê¸°ë…ì¼ì´ í‘œì‹œë©ë‹ˆë‹¤
                    </p>
                </div>
            </div>
        </div>

        <!-- ë¡œê·¸ íƒ­ -->
        <div id="logTab" class="tab-content hidden">
            <div class="card">
                <h2>ğŸ“‹ ë°œì†¡ ë¡œê·¸</h2>
                <div id="logList">
                    <p style="text-align: center; opacity: 0.7; padding: 20px;">
                        ë°œì†¡ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤
                    </p>
                </div>
            </div>
        </div>

        <!-- í…œí”Œë¦¿ íƒ­ -->
        <div id="templateTab" class="tab-content hidden">
            <div class="card">
                <h2>ğŸ“ ë©”ì‹œì§€ í…œí”Œë¦¿</h2>
                <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openTemplateModal()">â• ìƒˆ í…œí”Œë¦¿ ì¶”ê°€</button>
                <div id="templateList">
                    <p style="text-align: center; opacity: 0.7; padding: 20px;">
                        ë“±ë¡ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ê¸°ë…ì¼ ìë™ë°œì†¡ ì„¤ì • ëª¨ë‹¬ -->
    <div id="anniversaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="anniversaryModalTitle">ğŸ‚ ìƒì¼ ìë™ë°œì†¡ ì„¤ì •</h2>
                <button class="close-modal" onclick="closeAnniversaryModal()">&times;</button>
            </div>
            <form id="anniversaryForm" onsubmit="saveAnniversarySchedule(event)">
                <div class="form-group">
                    <label>ëŒ€ìƒ ê³ ê°</label>
                    <input type="text" id="anniversaryCustomer" readonly>
                </div>
                
                <div class="form-group">
                    <label>ê¸°ë…ì¼ ë‚ ì§œ</label>
                    <input type="text" id="anniversaryDate" readonly>
                </div>
                
                <div class="form-group">
                    <label>ì œëª©</label>
                    <input type="text" id="anniversaryTitle" required>
                </div>
                
                <div class="form-group">
                    <label>ë³¸ë¬¸</label>
                    <textarea id="anniversaryBody" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>ë°œì†¡ ì‹œê°</label>
                    <input type="time" id="anniversarySendTime" value="09:00" required>
                </div>
                
                <div class="form-group">
                    <label>ë°˜ë³µ ì„¤ì •</label>
                    <select id="repeatCycle" onchange="toggleRepeatOptions()">
                        <option value="once">1íšŒë§Œ ë°œì†¡</option>
                        <option value="yearly">ë§¤ë…„ ë°˜ë³µ</option>
                        <option value="monthly">ë§¤ì›” ë°˜ë³µ</option>
                    </select>
                </div>
                
                <div id="repeatOptions" class="hidden">
                    <div class="repeat-settings">
                        <div class="form-group">
                            <label>ë°œì†¡ íšŸìˆ˜</label>
                            <input type="number" id="repeatCount" min="1" placeholder="ë¬´ì œí•œì€ ë¹„ì›Œë‘ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ë§Œë£Œì¼</label>
                            <input type="date" id="repeatEndDate">
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAnniversaryModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-success">âœ… ìë™ë°œì†¡ ì„¤ì •</button>
                </div>
            </form>
        </div>
    </div>

    <!-- í…œí”Œë¦¿ ëª¨ë‹¬ -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ í…œí”Œë¦¿ ì¶”ê°€</h2>
                <button class="close-modal" onclick="closeTemplateModal()">&times;</button>
            </div>
            <form id="templateForm" onsubmit="saveTemplate(event)">
                <div class="form-group">
                    <label>í…œí”Œë¦¿ ì´ë¦„</label>
                    <input type="text" id="templateName" required>
                </div>
                <div class="form-group">
                    <label>ì œëª©</label>
                    <input type="text" id="templateTitle" required>
                </div>
                <div class="form-group">
                    <label>ë³¸ë¬¸</label>
                    <textarea id="templateBody" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== ì „ì—­ ë³€ìˆ˜ =====
        let customers = [];
        let messages = [];
        let templates = [];
        let anniversarySchedules = [];
        let selectedCustomersData = {}; // { customerId: { selected: true, position: 'ìˆ˜ì •ëœì§í•¨' } }
        let accessToken = null;
        let isDriveConnected = false;
        let currentAnniversaryCustomer = null;

        // ===== ì•”í˜¸í™”/ë³µí˜¸í™” =====
        const ENCRYPTION_KEY = 'ceofocus-secret-key-2025';

        function encryptData(data) {
            const jsonStr = JSON.stringify(data);
            let encrypted = '';
            for (let i = 0; i < jsonStr.length; i++) {
                encrypted += String.fromCharCode(
                    jsonStr.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length)
                );
            }
            return btoa(encrypted);
        }

        function decryptData(encrypted) {
            try {
                const decoded = atob(encrypted);
                let decrypted = '';
                for (let i = 0; i < decoded.length; i++) {
                    decrypted += String.fromCharCode(
                        decoded.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length)
                    );
                }
                return JSON.parse(decrypted);
            } catch (e) {
                console.error('ë³µí˜¸í™” ì‹¤íŒ¨:', e);
                return null;
            }
        }

        // ===== Google Drive ì—°ë™ =====
        function connectDrive() {
            if (isDriveConnected) {
                alert('ì´ë¯¸ Google Driveì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            const client = google.accounts.oauth2.initTokenClient({
                client_id: '288996084140-0eo93heqd66hqhg0fh1rbum6scnt3757.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        isDriveConnected = true;
                        localStorage.setItem('googleAccessToken', accessToken);
                        document.getElementById('driveBtn').textContent = 'âœ… ì—°ë™ ì™„ë£Œ';
                        alert('âœ… Google Drive ì—°ë™ ì™„ë£Œ!');
                        loadAllData();
                    }
                }
            });

            client.requestAccessToken();
        }

        async function loadAllData() {
            await loadCustomersFromDrive();
            await loadMessagesFromDrive();
            renderCustomers();
            renderAnniversaries();
        }

        async function loadCustomersFromDrive() {
            if (!isDriveConnected || !accessToken) return;

            try {
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='clients.fmd'&spaces=drive`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const searchResult = await searchResponse.json();
                const fileId = searchResult.files && searchResult.files[0]?.id;

                if (!fileId) {
                    console.log('ê³ ê° íŒŒì¼ ì—†ìŒ');
                    return;
                }

                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const encryptedData = await response.text();
                const data = decryptData(encryptedData);

                if (data && data.customers) {
                    customers = data.customers;
                    console.log('âœ… ê³ ê° ë°ì´í„° ë¡œë“œ:', customers.length + 'ëª…');
                }
            } catch (error) {
                console.error('ê³ ê° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function loadMessagesFromDrive() {
            if (!isDriveConnected || !accessToken) return;

            try {
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='messages.fmd'&spaces=drive`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const searchResult = await searchResponse.json();
                const fileId = searchResult.files && searchResult.files[0]?.id;

                if (!fileId) {
                    console.log('ë©”ì‹œì§€ íŒŒì¼ ì—†ìŒ');
                    return;
                }

                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const encryptedData = await response.text();
                const data = decryptData(encryptedData);

                if (data) {
                    messages = data.messages || [];
                    templates = data.templates || [];
                    anniversarySchedules = data.anniversarySchedules || [];
                    console.log('âœ… ë©”ì‹œì§€ ë°ì´í„° ë¡œë“œ');
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function saveMessagesToDrive() {
            if (!isDriveConnected || !accessToken) return;

            try {
                const data = {
                    messages: messages,
                    templates: templates,
                    anniversarySchedules: anniversarySchedules,
                    lastUpdate: new Date().toISOString()
                };

                const encryptedData = encryptData(data);
                const blob = new Blob([encryptedData], { type: 'text/plain' });

                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='messages.fmd'&spaces=drive`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const searchResult = await searchResponse.json();
                let fileId = searchResult.files && searchResult.files[0]?.id;

                const metadata = {
                    name: 'messages.fmd',
                    mimeType: 'text/plain'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                const url = fileId
                    ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`
                    : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

                const method = fileId ? 'PATCH' : 'POST';

                await fetch(url, {
                    method: method,
                    headers: { Authorization: `Bearer ${accessToken}` },
                    body: form
                });

                console.log('âœ… Drive ì €ì¥ ì™„ë£Œ');
            } catch (error) {
                console.error('Drive ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        // ===== ê³ ê° ë Œë”ë§ =====
        function renderCustomers() {
            const customerList = document.getElementById('customerList');
            
            if (customers.length === 0) {
                customerList.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            const searchTerm = document.getElementById('customerSearch')?.value.toLowerCase() || '';
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || 
                (c.company && c.company.toLowerCase().includes(searchTerm))
            );

            customerList.innerHTML = filtered.map(customer => {
                const isSelected = selectedCustomersData[customer.id]?.selected || false;
                const currentPosition = selectedCustomersData[customer.id]?.position || customer.position || '';
                
                return `
                    <div class="customer-item">
                        <input type="checkbox" 
                               id="customer-${customer.id}" 
                               value="${customer.id}"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleCustomer(${customer.id})">
                        <div class="customer-info" style="cursor: pointer;" onclick="document.getElementById('customer-${customer.id}').click()">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-meta">
                                ${customer.company || ''} | 
                                ${customer.phone || ''} | 
                                ìƒì¼: ${customer.birth ? formatBirthDate(customer.birth) : 'ë¯¸ë“±ë¡'}
                            </div>
                        </div>
                        <span class="position-label">ì§í•¨:</span>
                        <input type="text" 
                               class="position-input" 
                               value="${currentPosition}" 
                               placeholder="ì§í•¨ ì…ë ¥"
                               onchange="updateCustomerPosition(${customer.id}, this.value)"
                               onclick="event.stopPropagation()">
                    </div>
                `;
            }).join('');

            updateSelectedCount();
        }

        function searchCustomers() {
            renderCustomers();
        }

        function toggleCustomer(customerId) {
            if (!selectedCustomersData[customerId]) {
                selectedCustomersData[customerId] = { selected: false, position: '' };
            }
            
            selectedCustomersData[customerId].selected = !selectedCustomersData[customerId].selected;
            
            // ì§í•¨ì´ ì—†ìœ¼ë©´ ì›ë³¸ ê³ ê° ì§í•¨ ì‚¬ìš©
            if (!selectedCustomersData[customerId].position) {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    selectedCustomersData[customerId].position = customer.position || '';
                }
            }
            
            updateSelectedCount();
        }

        function updateCustomerPosition(customerId, position) {
            if (!selectedCustomersData[customerId]) {
                selectedCustomersData[customerId] = { selected: false, position: position };
            } else {
                selectedCustomersData[customerId].position = position;
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            
            if (selectAll.checked) {
                customers.forEach(customer => {
                    selectedCustomersData[customer.id] = {
                        selected: true,
                        position: customer.position || ''
                    };
                });
            } else {
                selectedCustomersData = {};
            }
            
            renderCustomers();
        }

        function updateSelectedCount() {
            const count = Object.values(selectedCustomersData).filter(data => data.selected).length;
            document.getElementById('selectedCount').textContent = count + 'ëª… ì„ íƒë¨';
        }

        // ===== ê¸°ë…ì¼ ë Œë”ë§ =====
        function renderAnniversaries() {
            const anniversaryList = document.getElementById('anniversaryList');
            
            if (customers.length === 0) {
                anniversaryList.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            const anniversaries = [];
            const today = new Date();
            const currentYear = today.getFullYear();

            customers.forEach(customer => {
                // ìƒì¼
                if (customer.birth) {
                    const birthDate = new Date(customer.birth);
                    const nextBirthday = new Date(currentYear, birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(currentYear + 1);
                    }
                    
                    anniversaries.push({
                        customer: customer,
                        type: 'birthday',
                        date: nextBirthday,
                        label: 'ìƒì¼'
                    });
                }
                
                // ê¸°ë…ì¼
                if (customer.anniversary) {
                    const anniversaryDate = new Date(customer.anniversary);
                    const nextAnniversary = new Date(currentYear, anniversaryDate.getMonth(), anniversaryDate.getDate());
                    if (nextAnniversary < today) {
                        nextAnniversary.setFullYear(currentYear + 1);
                    }
                    
                    anniversaries.push({
                        customer: customer,
                        type: 'anniversary',
                        date: nextAnniversary,
                        label: 'ê¸°ë…ì¼'
                    });
                }
            });

            // ë‚ ì§œìˆœ ì •ë ¬
            anniversaries.sort((a, b) => a.date - b.date);

            anniversaryList.innerHTML = anniversaries.map(item => {
                const daysUntil = Math.ceil((item.date - today) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="anniversary-item ${item.type}" onclick="openAnniversaryModal('${item.type}', ${item.customer.id})">
                        <div class="anniversary-header">
                            <div class="anniversary-name">
                                ${item.type === 'birthday' ? 'ğŸ‚' : 'ğŸ‰'} ${item.customer.name} ${item.customer.position || ''}
                            </div>
                            <div class="anniversary-date">
                                ${formatDate(item.date)} (D-${daysUntil})
                            </div>
                        </div>
                        <div class="anniversary-type">
                            ${item.label} | ${item.customer.company || ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== ë©”ì‹œì§€ ë°œì†¡ =====
        function sendMessage(e) {
            e.preventDefault();

            const selectedCustomers = Object.keys(selectedCustomersData).filter(id => selectedCustomersData[id].selected);
            
            if (selectedCustomers.length === 0) {
                alert('ë°œì†¡ ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const title = document.getElementById('messageTitle').value;
            const body = document.getElementById('messageBody').value;
            const usePosition = document.getElementById('usePosition').checked;
            const sendType = document.getElementById('sendType').value;
            const scheduleTime = document.getElementById('scheduleTime').value;

            let sentCount = 0;

            // ê° ê³ ê°ì—ê²Œ ê°œì¸í™”ëœ ë©”ì‹œì§€ ë°œì†¡
            selectedCustomers.forEach(customerId => {
                const customer = customers.find(c => c.id == customerId);
                if (!customer) return;

                // ìˆ˜ì •ëœ ì§í•¨ ìš°ì„  ì‚¬ìš©
                const position = selectedCustomersData[customerId].position || customer.position || '';
                
                let personalizedBody = body
                    .replace(/{name}/g, customer.name)
                    .replace(/{position}/g, usePosition && position ? position + 'ë‹˜' : 'ë‹˜');

                const message = {
                    id: Date.now() + Math.random(),
                    customerId: customer.id,
                    customerName: customer.name,
                    title: title,
                    body: personalizedBody,
                    originalBody: body,
                    position: position,
                    sendType: sendType,
                    scheduleTime: sendType === 'scheduled' ? scheduleTime : null,
                    status: sendType === 'scheduled' ? 'scheduled' : 'success',
                    sentAt: sendType === 'immediate' ? new Date().toISOString() : null,
                    createdAt: new Date().toISOString()
                };

                messages.unshift(message);
                sentCount++;
            });

            saveMessagesToDrive();
            resetSendForm();
            selectedCustomersData = {};
            renderCustomers();
            
            alert(`âœ… ${sentCount}ëª…ì˜ ê³ ê°ì—ê²Œ ë©”ì‹œì§€ê°€ ${sendType === 'scheduled' ? 'ì˜ˆì•½' : 'ë°œì†¡'}ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            
            switchTab('log');
        }

        function resetSendForm() {
            document.getElementById('sendForm').reset();
            document.getElementById('scheduleGroup').classList.add('hidden');
        }

        function toggleSchedule() {
            const sendType = document.getElementById('sendType').value;
            const scheduleGroup = document.getElementById('scheduleGroup');
            
            if (sendType === 'scheduled') {
                scheduleGroup.classList.remove('hidden');
            } else {
                scheduleGroup.classList.add('hidden');
            }
        }

        // ===== ê¸°ë…ì¼ ìë™ë°œì†¡ =====
        function openAnniversaryModal(type, customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            currentAnniversaryCustomer = customer;

            const modal = document.getElementById('anniversaryModal');
            const title = document.getElementById('anniversaryModalTitle');
            const customerInput = document.getElementById('anniversaryCustomer');
            const dateInput = document.getElementById('anniversaryDate');
            const titleInput = document.getElementById('anniversaryTitle');
            const bodyInput = document.getElementById('anniversaryBody');

            title.textContent = type === 'birthday' ? 'ğŸ‚ ìƒì¼ ìë™ë°œì†¡ ì„¤ì •' : 'ğŸ‰ ê¸°ë…ì¼ ìë™ë°œì†¡ ì„¤ì •';
            customerInput.value = `${customer.name} ${customer.position || ''}`;
            dateInput.value = type === 'birthday' ? formatBirthDate(customer.birth) : formatBirthDate(customer.anniversary);

            if (type === 'birthday') {
                titleInput.value = 'ìƒì¼ ì¶•í•˜ ë©”ì‹œì§€';
                bodyInput.value = `{name} {position}ë‹˜,\n\nìƒì¼ì„ ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!\nê±´ê°•í•˜ê³  í–‰ë³µí•œ í•œ í•´ ë˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.`;
            } else {
                titleInput.value = 'ê¸°ë…ì¼ ì¶•í•˜ ë©”ì‹œì§€';
                bodyInput.value = `{name} {position}ë‹˜,\n\nì†Œì¤‘í•œ ê¸°ë…ì¼ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!`;
            }

            modal.classList.add('active');
        }

        function closeAnniversaryModal() {
            document.getElementById('anniversaryModal').classList.remove('active');
            currentAnniversaryCustomer = null;
        }

        function toggleRepeatOptions() {
            const repeatCycle = document.getElementById('repeatCycle').value;
            const repeatOptions = document.getElementById('repeatOptions');
            
            if (repeatCycle !== 'once') {
                repeatOptions.classList.remove('hidden');
            } else {
                repeatOptions.classList.add('hidden');
            }
        }

        function saveAnniversarySchedule(e) {
            e.preventDefault();

            if (!currentAnniversaryCustomer) return;

            const schedule = {
                id: Date.now(),
                customerId: currentAnniversaryCustomer.id,
                customerName: currentAnniversaryCustomer.name,
                anniversaryDate: document.getElementById('anniversaryDate').value,
                title: document.getElementById('anniversaryTitle').value,
                body: document.getElementById('anniversaryBody').value,
                sendTime: document.getElementById('anniversarySendTime').value,
                repeatCycle: document.getElementById('repeatCycle').value,
                repeatCount: document.getElementById('repeatCount').value || null,
                repeatEndDate: document.getElementById('repeatEndDate').value || null,
                status: 'active',
                createdAt: new Date().toISOString()
            };

            anniversarySchedules.push(schedule);
            saveMessagesToDrive();
            closeAnniversaryModal();
            
            alert('âœ… ê¸°ë…ì¼ ìë™ë°œì†¡ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ===== í…œí”Œë¦¿ =====
        function openTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        function saveTemplate(e) {
            e.preventDefault();

            const template = {
                id: Date.now(),
                name: document.getElementById('templateName').value,
                title: document.getElementById('templateTitle').value,
                body: document.getElementById('templateBody').value,
                createdAt: new Date().toISOString()
            };

            templates.push(template);
            saveMessagesToDrive();
            closeTemplateModal();
            renderTemplates();
            
            alert('âœ… í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function renderTemplates() {
            const templateList = document.getElementById('templateList');
            
            if (templates.length === 0) {
                templateList.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">ë“±ë¡ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            templateList.innerHTML = templates.map(template => `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${template.name}</div>
                        <div style="font-size: 13px; opacity: 0.8;">${template.title}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="useTemplate(${template.id})">ì‚¬ìš©</button>
                        <button class="btn btn-danger" onclick="deleteTemplate(${template.id})">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
        }

        function useTemplate(id) {
            const template = templates.find(t => t.id === id);
            if (!template) return;

            switchTab('send');
            document.getElementById('messageTitle').value = template.title;
            document.getElementById('messageBody').value = template.body;
        }

        function deleteTemplate(id) {
            if (!confirm('ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            templates = templates.filter(t => t.id !== id);
            saveMessagesToDrive();
            renderTemplates();
        }

        // ===== ìœ í‹¸ë¦¬í‹° =====
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
        }

        function formatBirthDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
        }

        // ===== íƒ­ ì „í™˜ =====
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            event.target.classList.add('active');
            
            const tabMap = {
                'send': 'sendTab',
                'anniversary': 'anniversaryTab',
                'log': 'logTab',
                'template': 'templateTab'
            };
            
            document.getElementById(tabMap[tab]).classList.remove('hidden');
        }

        // ===== ë„¤ë¹„ê²Œì´ì…˜ =====
        function goBack() {
            if (confirm('ë°œì†¡ê´€ë¦¬ë¥¼ ì¢…ë£Œí•˜ê³  ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = 'index.html';
            }
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('googleAccessToken');
                window.location.href = 'login.html';
            }
        }

        // ===== ì´ˆê¸°í™” =====
        function init() {
            const savedToken = localStorage.getItem('googleAccessToken');
            if (savedToken) {
                accessToken = savedToken;
                isDriveConnected = true;
                document.getElementById('driveBtn').textContent = 'âœ… ì—°ë™ ì™„ë£Œ';
                loadAllData();
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>