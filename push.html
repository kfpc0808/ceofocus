<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì® Î∞úÏÜ°Í¥ÄÎ¶¨ - Send Management</title>
    
    <!-- Google OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .back-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .drive-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .drive-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }
        
        .logout-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4);
        }
        
        /* Ìó§Îçî */
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        /* ÌÉ≠ Î≤ÑÌäº */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }
        
        /* Ïπ¥Îìú */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .card h2 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Ìèº */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }
        
        /* Í≥†Í∞ù Î¶¨Ïä§Ìä∏ */
        .customer-search {
            margin-bottom: 15px;
        }
        
        .customer-search input {
            width: 100%;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 25px;
            color: #333;
            font-size: 14px;
        }
        
        .customer-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }
        
        .customer-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }
        
        .customer-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .customer-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .customer-info {
            flex: 1;
        }
        
        .customer-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 3px;
        }
        
        .customer-meta {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .position-input {
            width: 100px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: #333;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .position-label {
            font-size: 12px;
            opacity: 0.8;
            margin-right: 5px;
            flex-shrink: 0;
        }
        
        .select-all-container {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .select-all-container label {
            font-weight: bold;
            cursor: pointer;
        }
        
        .selected-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        
        /* Í∏∞ÎÖêÏùº Îã¨Î†• */
        .anniversary-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .anniversary-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .anniversary-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .anniversary-item.birthday {
            border-left-color: #ff6b9d;
        }
        
        .anniversary-item.anniversary {
            border-left-color: #ffd93d;
        }
        
        .anniversary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .anniversary-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .anniversary-date {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
        }
        
        .anniversary-type {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* Í∞úÏù∏Ìôî Î≥ÄÏàò ÏïàÎÇ¥ */
        .personalization-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .personalization-info strong {
            display: block;
            margin-bottom: 8px;
        }
        
        .variable-tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-family: monospace;
        }
        
        /* Î∞òÎ≥µ ÏÑ§Ï†ï */
        .repeat-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        /* ÌÜµÍ≥Ñ Ïπ¥Îìú */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            opacity: 0.9;
            font-size: 14px;
        }
        
        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* Ïä§ÌÅ¨Î°§Î∞î */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .hidden {
            display: none;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .checkbox-label input {
            width: auto;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .repeat-settings {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="top-nav">
            <button class="back-btn" onclick="goBack()">‚Üê Îí§Î°úÍ∞ÄÍ∏∞</button>
            <div class="nav-buttons">
                <button class="drive-btn" onclick="connectDrive()" id="driveBtn">üîó ÎìúÎùºÏù¥Î∏å Ïó∞Îèô</button>
                <button class="logout-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>
        </div>

        <!-- Ìó§Îçî -->
        <h1>üì® Î∞úÏÜ°Í¥ÄÎ¶¨</h1>
        <p class="subtitle">Í≥†Í∞ù Î©îÏãúÏßÄ Î∞úÏÜ° Î∞è Í∏∞ÎÖêÏùº ÏûêÎèô Î∞úÏÜ° Í¥ÄÎ¶¨</p>

        <!-- ÌÉ≠ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('send')">üì§ Î©îÏãúÏßÄ Î∞úÏÜ°</button>
            <button class="tab-btn" onclick="switchTab('anniversary')">üéÇ Í∏∞ÎÖêÏùº ÏûêÎèôÎ∞úÏÜ°</button>
            <button class="tab-btn" onclick="switchTab('log')">üìã Î∞úÏÜ° Î°úÍ∑∏</button>
            <button class="tab-btn" onclick="switchTab('template')">üìù ÌÖúÌîåÎ¶ø</button>
        </div>

        <!-- Î∞úÏÜ° ÌÉ≠ -->
        <div id="sendTab" class="tab-content">
            <div class="grid-2">
                <!-- Í≥†Í∞ù ÏÑ†ÌÉù -->
                <div class="card">
                    <h2>üë• Î∞úÏÜ° ÎåÄÏÉÅ ÏÑ†ÌÉù</h2>
                    
                    <div class="customer-search">
                        <input type="text" id="customerSearch" placeholder="üîç Í≥†Í∞ù Ïù¥Î¶Ñ, ÌöåÏÇ¨Î™ÖÏúºÎ°ú Í≤ÄÏÉâ..." onkeyup="searchCustomers()">
                    </div>
                    
                    <div class="select-all-container">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label for="selectAll">Ï†ÑÏ≤¥ ÏÑ†ÌÉù</label>
                        <div class="selected-count" id="selectedCount">0Î™Ö ÏÑ†ÌÉùÎê®</div>
                    </div>
                    
                    <div class="customer-list" id="customerList">
                        <p style="text-align: center; opacity: 0.7; padding: 20px;">
                            ÎìúÎùºÏù¥Î∏å Ïó∞Îèô ÌõÑ Í≥†Í∞ù Î™©Î°ùÏù¥ ÌëúÏãúÎê©ÎãàÎã§
                        </p>
                    </div>
                </div>
                
                <!-- Î©îÏãúÏßÄ ÏûëÏÑ± -->
                <div class="card">
                    <h2>‚úçÔ∏è Î©îÏãúÏßÄ ÏûëÏÑ±</h2>
                    
                    <div class="personalization-info">
                        <strong>üí° Í∞úÏù∏Ìôî Î≥ÄÏàò ÏÇ¨Ïö©ÌïòÍ∏∞:</strong>
                        <span class="variable-tag">{name}</span> = Í≥†Í∞ù Ïù¥Î¶Ñ<br>
                        <span class="variable-tag">{position}</span> = ÏßÅÌï®<br>
                        ÏòàÏãú: "{name} {position}Îãò ÏÉùÏùº Ï∂ïÌïòÎìúÎ¶ΩÎãàÎã§!"<br>
                        ‚Üí "ÌôçÍ∏∏Îèô Í≥ºÏû•Îãò ÏÉùÏùº Ï∂ïÌïòÎìúÎ¶ΩÎãàÎã§!"
                    </div>
                    
                    <form id="sendForm" onsubmit="sendMessage(event)">
                        <div class="form-group">
                            <label>Ï†úÎ™©</label>
                            <input type="text" id="messageTitle" required placeholder="Î©îÏãúÏßÄ Ï†úÎ™©">
                        </div>
                        
                        <div class="form-group">
                            <label>Î≥∏Î¨∏</label>
                            <textarea id="messageBody" required placeholder="{name} {position}Îãò, ÏïàÎÖïÌïòÏÑ∏Ïöî!"></textarea>
                        </div>
                        
                        <div class="checkbox-label">
                            <input type="checkbox" id="usePosition" checked>
                            <label for="usePosition">ÏßÅÌï® ÏÇ¨Ïö© ("{position}Îãò" ÌòïÏãù)</label>
                        </div>
                        
                        <div class="form-group">
                            <label>Î∞úÏÜ° Ïú†Ìòï</label>
                            <select id="sendType" onchange="toggleSchedule()">
                                <option value="immediate">Ï¶âÏãú Î∞úÏÜ°</option>
                                <option value="scheduled">ÏòàÏïΩ Î∞úÏÜ°</option>
                            </select>
                        </div>
                        
                        <div class="form-group hidden" id="scheduleGroup">
                            <label>ÏòàÏïΩ ÎÇ†Ïßú/ÏãúÍ∞Ñ</label>
                            <input type="datetime-local" id="scheduleTime">
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="resetSendForm()">Ï∑®ÏÜå</button>
                            <button type="submit" class="btn btn-primary">üöÄ Î∞úÏÜ°ÌïòÍ∏∞</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Í∏∞ÎÖêÏùº ÏûêÎèôÎ∞úÏÜ° ÌÉ≠ -->
        <div id="anniversaryTab" class="tab-content hidden">
            <div class="card">
                <h2>üéÇ Í∏∞ÎÖêÏùº Î™©Î°ù</h2>
                <p style="opacity: 0.8; margin-bottom: 20px;">
                    Í∏∞ÎÖêÏùºÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏûêÎèô Î∞úÏÜ°ÏùÑ ÏÑ§Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§
                </p>
                
                <div class="anniversary-list" id="anniversaryList">
                    <p style="text-align: center; opacity: 0.7; padding: 20px;">
                        ÎìúÎùºÏù¥Î∏å Ïó∞Îèô ÌõÑ Í∏∞ÎÖêÏùºÏù¥ ÌëúÏãúÎê©ÎãàÎã§
                    </p>
                </div>
            </div>
        </div>

        <!-- Î°úÍ∑∏ ÌÉ≠ -->
        <div id="logTab" class="tab-content hidden">
            <div class="card">
                <h2>üìã Î∞úÏÜ° Î°úÍ∑∏</h2>
                <div id="logList">
                    <p style="text-align: center; opacity: 0.7; padding: 20px;">
                        Î∞úÏÜ° ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§
                    </p>
                </div>
            </div>
        </div>

        <!-- ÌÖúÌîåÎ¶ø ÌÉ≠ -->
        <div id="templateTab" class="tab-content hidden">
            <div class="card">
                <h2>üìù Î©îÏãúÏßÄ ÌÖúÌîåÎ¶ø</h2>
                <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openTemplateModal()">‚ûï ÏÉà ÌÖúÌîåÎ¶ø Ï∂îÍ∞Ä</button>
                <div id="templateList">
                    <p style="text-align: center; opacity: 0.7; padding: 20px;">
                        Îì±Î°ùÎêú ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏäµÎãàÎã§
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Í∏∞ÎÖêÏùº ÏûêÎèôÎ∞úÏÜ° ÏÑ§Ï†ï Î™®Îã¨ -->
    <div id="anniversaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="anniversaryModalTitle">üéÇ ÏÉùÏùº ÏûêÎèôÎ∞úÏÜ° ÏÑ§Ï†ï</h2>
                <button class="close-modal" onclick="closeAnniversaryModal()">&times;</button>
            </div>
            <form id="anniversaryForm" onsubmit="saveAnniversarySchedule(event)">
                <div class="form-group">
                    <label>ÎåÄÏÉÅ Í≥†Í∞ù</label>
                    <input type="text" id="anniversaryCustomer" readonly>
                </div>
                
                <div class="form-group">
                    <label>Í∏∞ÎÖêÏùº ÎÇ†Ïßú</label>
                    <input type="text" id="anniversaryDate" readonly>
                </div>
                
                <div class="form-group">
                    <label>Ï†úÎ™©</label>
                    <input type="text" id="anniversaryTitle" required>
                </div>
                
                <div class="form-group">
                    <label>Î≥∏Î¨∏</label>
                    <textarea id="anniversaryBody" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Î∞úÏÜ° ÏãúÍ∞Å</label>
                    <input type="time" id="anniversarySendTime" value="09:00" required>
                </div>
                
                <div class="form-group">
                    <label>Î∞òÎ≥µ ÏÑ§Ï†ï</label>
                    <select id="repeatCycle" onchange="toggleRepeatOptions()">
                        <option value="once">1ÌöåÎßå Î∞úÏÜ°</option>
                        <option value="yearly">Îß§ÎÖÑ Î∞òÎ≥µ</option>
                        <option value="monthly">Îß§Ïõî Î∞òÎ≥µ</option>
                    </select>
                </div>
                
                <div id="repeatOptions" class="hidden">
                    <div class="repeat-settings">
                        <div class="form-group">
                            <label>Î∞úÏÜ° ÌöüÏàò</label>
                            <input type="number" id="repeatCount" min="1" placeholder="Î¨¥Ï†úÌïúÏùÄ ÎπÑÏõåÎëêÏÑ∏Ïöî">
                        </div>
                        
                        <div class="form-group">
                            <label>ÎßåÎ£åÏùº</label>
                            <input type="date" id="repeatEndDate">
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAnniversaryModal()">Ï∑®ÏÜå</button>
                    <button type="submit" class="btn btn-success">‚úÖ ÏûêÎèôÎ∞úÏÜ° ÏÑ§Ï†ï</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ÌÖúÌîåÎ¶ø Î™®Îã¨ -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù ÌÖúÌîåÎ¶ø Ï∂îÍ∞Ä</h2>
                <button class="close-modal" onclick="closeTemplateModal()">&times;</button>
            </div>
            <form id="templateForm" onsubmit="saveTemplate(event)">
                <div class="form-group">
                    <label>ÌÖúÌîåÎ¶ø Ïù¥Î¶Ñ</label>
                    <input type="text" id="templateName" required>
                </div>
                <div class="form-group">
                    <label>Ï†úÎ™©</label>
                    <input type="text" id="templateTitle" required>
                </div>
                <div class="form-group">
                    <label>Î≥∏Î¨∏</label>
                    <textarea id="templateBody" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">Ï∑®ÏÜå</button>
                    <button type="submit" class="btn btn-primary">Ï†ÄÏû•</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== Ï†ÑÏó≠ Î≥ÄÏàò =====
        let customers = [];
        let messages = [];
        let templates = [];
        let anniversarySchedules = [];
        let selectedCustomersData = {}; // { customerId: { selected: true, position: 'ÏàòÏ†ïÎêúÏßÅÌï®' } }
        let accessToken = null;
        let isDriveConnected = false;
        let currentAnniversaryCustomer = null;

        // ===== ÏïîÌò∏Ìôî/Î≥µÌò∏Ìôî =====
        const ENCRYPTION_KEY = 'ceofocus-secret-key-2025';

        function encryptData(data) {
            const jsonStr = JSON.stringify(data);
            let encrypted = '';
            for (let i = 0; i < jsonStr.length; i++) {
                encrypted += String.fromCharCode(
                    jsonStr.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length)
                );
            }
            return btoa(encrypted);
        }

        function decryptData(encrypted) {
            try {
                const decoded = atob(encrypted);
                let decrypted = '';
                for (let i = 0; i < decoded.length; i++) {
                    decrypted += String.fromCharCode(
                        decoded.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length)
                    );
                }
                return JSON.parse(decrypted);
            } catch (e) {
                console.error('Î≥µÌò∏Ìôî Ïã§Ìå®:', e);
                return null;
            }
        }

        // ===== Google Drive Ïó∞Îèô =====
        function connectDrive() {
            if (isDriveConnected) {
                alert('Ïù¥ÎØ∏ Google DriveÏóê Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
                return;
            }

            const client = google.accounts.oauth2.initTokenClient({
                client_id: '288996084140-0eo93heqd66hqhg0fh1rbum6scnt3757.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        isDriveConnected = true;
                        localStorage.setItem('googleAccessToken', accessToken);
                        document.getElementById('driveBtn').textContent = '‚úÖ Ïó∞Îèô ÏôÑÎ£å';
                        alert('‚úÖ Google Drive Ïó∞Îèô ÏôÑÎ£å!');
                        loadAllData();
                    }
                }
            });

            client.requestAccessToken();
        }

        async function loadAllData() {
            await loadCustomersFromDrive();
            await loadMessagesFromDrive();
            renderCustomers();
            renderAnniversaries();
        }

        async function loadCustomersFromDrive() {
            if (!isDriveConnected || !accessToken) return;

            try {
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='clients.fmd'&spaces=drive`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const searchResult = await searchResponse.json();
                const fileId = searchResult.files && searchResult.files[0]?.id;

                if (!fileId) {
                    console.log('Í≥†Í∞ù ÌååÏùº ÏóÜÏùå');
                    return;
                }

                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const encryptedData = await response.text();
                const data = decryptData(encryptedData);

                if (data && data.customers) {
                    customers = data.customers;
                    console.log('‚úÖ Í≥†Í∞ù Îç∞Ïù¥ÌÑ∞ Î°úÎìú:', customers.length + 'Î™Ö');
                }
            } catch (error) {
                console.error('Í≥†Í∞ù Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        async function loadMessagesFromDrive() {
            if (!isDriveConnected || !accessToken) return;

            try {
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='messages.fmd'&spaces=drive`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const searchResult = await searchResponse.json();
                const fileId = searchResult.files && searchResult.files[0]?.id;

                if (!fileId) {
                    console.log('Î©îÏãúÏßÄ ÌååÏùº ÏóÜÏùå');
                    return;
                }

                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const encryptedData = await response.text();
                const data = decryptData(encryptedData);

                if (data) {
                    messages = data.messages || [];
                    templates = data.templates || [];
                    anniversarySchedules = data.anniversarySchedules || [];
                    console.log('‚úÖ Î©îÏãúÏßÄ Îç∞Ïù¥ÌÑ∞ Î°úÎìú');
                }
            } catch (error) {
                console.error('Î©îÏãúÏßÄ Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        async function saveMessagesToDrive() {
            if (!isDriveConnected || !accessToken) return;

            try {
                const data = {
                    messages: messages,
                    templates: templates,
                    anniversarySchedules: anniversarySchedules,
                    lastUpdate: new Date().toISOString()
                };

                const encryptedData = encryptData(data);
                const blob = new Blob([encryptedData], { type: 'text/plain' });

                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='messages.fmd'&spaces=drive`,
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                const searchResult = await searchResponse.json();
                let fileId = searchResult.files && searchResult.files[0]?.id;

                const metadata = {
                    name: 'messages.fmd',
                    mimeType: 'text/plain'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                const url = fileId
                    ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`
                    : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

                const method = fileId ? 'PATCH' : 'POST';

                await fetch(url, {
                    method: method,
                    headers: { Authorization: `Bearer ${accessToken}` },
                    body: form
                });

                console.log('‚úÖ Drive Ï†ÄÏû• ÏôÑÎ£å');
            } catch (error) {
                console.error('Drive Ï†ÄÏû• Ïò§Î•ò:', error);
            }
        }

        // ===== Í≥†Í∞ù Î†åÎçîÎßÅ =====
        function renderCustomers() {
            const customerList = document.getElementById('customerList');
            
            if (customers.length === 0) {
                customerList.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">Îì±Î°ùÎêú Í≥†Í∞ùÏù¥ ÏóÜÏäµÎãàÎã§</p>';
                return;
            }

            const searchTerm = document.getElementById('customerSearch')?.value.toLowerCase() || '';
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || 
                (c.company && c.company.toLowerCase().includes(searchTerm))
            );

            customerList.innerHTML = filtered.map(customer => {
                const isSelected = selectedCustomersData[customer.id]?.selected || false;
                const currentPosition = selectedCustomersData[customer.id]?.position || customer.position || '';
                
                return `
                    <div class="customer-item">
                        <input type="checkbox" 
                               id="customer-${customer.id}" 
                               value="${customer.id}"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleCustomer(${customer.id})">
                        <div class="customer-info" style="cursor: pointer;" onclick="document.getElementById('customer-${customer.id}').click()">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-meta">
                                ${customer.company || ''} | 
                                ${customer.phone || ''} | 
                                ÏÉùÏùº: ${customer.birth ? formatBirthDate(customer.birth) : 'ÎØ∏Îì±Î°ù'}
                            </div>
                        </div>
                        <span class="position-label">ÏßÅÌï®:</span>
                        <input type="text" 
                               class="position-input" 
                               value="${currentPosition}" 
                               placeholder="ÏßÅÌï® ÏûÖÎ†•"
                               onchange="updateCustomerPosition(${customer.id}, this.value)"
                               onclick="event.stopPropagation()">
                    </div>
                `;
            }).join('');

            updateSelectedCount();
        }

        function searchCustomers() {
            renderCustomers();
        }

        function toggleCustomer(customerId) {
            if (!selectedCustomersData[customerId]) {
                selectedCustomersData[customerId] = { selected: false, position: '' };
            }
            
            selectedCustomersData[customerId].selected = !selectedCustomersData[customerId].selected;
            
            // ÏßÅÌï®Ïù¥ ÏóÜÏúºÎ©¥ ÏõêÎ≥∏ Í≥†Í∞ù ÏßÅÌï® ÏÇ¨Ïö©
            if (!selectedCustomersData[customerId].position) {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    selectedCustomersData[customerId].position = customer.position || '';
                }
            }
            
            updateSelectedCount();
        }

        function updateCustomerPosition(customerId, position) {
            if (!selectedCustomersData[customerId]) {
                selectedCustomersData[customerId] = { selected: false, position: position };
            } else {
                selectedCustomersData[customerId].position = position;
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            
            if (selectAll.checked) {
                customers.forEach(customer => {
                    selectedCustomersData[customer.id] = {
                        selected: true,
                        position: customer.position || ''
                    };
                });
            } else {
                selectedCustomersData = {};
            }
            
            renderCustomers();
        }

        function updateSelectedCount() {
            const count = Object.values(selectedCustomersData).filter(data => data.selected).length;
            document.getElementById('selectedCount').textContent = count + 'Î™Ö ÏÑ†ÌÉùÎê®';
        }

        // ===== Í∏∞ÎÖêÏùº Î†åÎçîÎßÅ =====
        function renderAnniversaries() {
            const anniversaryList = document.getElementById('anniversaryList');
            
            if (customers.length === 0) {
                anniversaryList.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">Îì±Î°ùÎêú Í≥†Í∞ùÏù¥ ÏóÜÏäµÎãàÎã§</p>';
                return;
            }

            const anniversaries = [];
            const today = new Date();
            const currentYear = today.getFullYear();

            customers.forEach(customer => {
                // ÏÉùÏùº
                if (customer.birth) {
                    const birthDate = new Date(customer.birth);
                    const nextBirthday = new Date(currentYear, birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(currentYear + 1);
                    }
                    
                    anniversaries.push({
                        customer: customer,
                        type: 'birthday',
                        date: nextBirthday,
                        label: 'ÏÉùÏùº'
                    });
                }
                
                // Í∏∞ÎÖêÏùº
                if (customer.anniversary) {
                    const anniversaryDate = new Date(customer.anniversary);
                    const nextAnniversary = new Date(currentYear, anniversaryDate.getMonth(), anniversaryDate.getDate());
                    if (nextAnniversary < today) {
                        nextAnniversary.setFullYear(currentYear + 1);
                    }
                    
                    anniversaries.push({
                        customer: customer,
                        type: 'anniversary',
                        date: nextAnniversary,
                        label: 'Í∏∞ÎÖêÏùº'
                    });
                }
            });

            // ÎÇ†ÏßúÏàú Ï†ïÎ†¨
            anniversaries.sort((a, b) => a.date - b.date);

            anniversaryList.innerHTML = anniversaries.map(item => {
                const daysUntil = Math.ceil((item.date - today) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="anniversary-item ${item.type}" onclick="openAnniversaryModal('${item.type}', ${item.customer.id})">
                        <div class="anniversary-header">
                            <div class="anniversary-name">
                                ${item.type === 'birthday' ? 'üéÇ' : 'üéâ'} ${item.customer.name} ${item.customer.position || ''}
                            </div>
                            <div class="anniversary-date">
                                ${formatDate(item.date)} (D-${daysUntil})
                            </div>
                        </div>
                        <div class="anniversary-type">
                            ${item.label} | ${item.customer.company || ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== Î©îÏãúÏßÄ Î∞úÏÜ° =====
        function sendMessage(e) {
            e.preventDefault();

            const selectedCustomers = Object.keys(selectedCustomersData).filter(id => selectedCustomersData[id].selected);
            
            if (selectedCustomers.length === 0) {
                alert('Î∞úÏÜ° ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            const title = document.getElementById('messageTitle').value;
            const body = document.getElementById('messageBody').value;
            const usePosition = document.getElementById('usePosition').checked;
            const sendType = document.getElementById('sendType').value;
            const scheduleTime = document.getElementById('scheduleTime').value;

            let sentCount = 0;

            // Í∞Å Í≥†Í∞ùÏóêÍ≤å Í∞úÏù∏ÌôîÎêú Î©îÏãúÏßÄ Î∞úÏÜ°
            selectedCustomers.forEach(customerId => {
                const customer = customers.find(c => c.id == customerId);
                if (!customer) return;

                // ÏàòÏ†ïÎêú ÏßÅÌï® Ïö∞ÏÑ† ÏÇ¨Ïö©
                const position = selectedCustomersData[customerId].position || customer.position || '';
                
                let personalizedBody = body
                    .replace(/{name}/g, customer.name)
                    .replace(/{position}/g, usePosition && position ? position + 'Îãò' : 'Îãò');

                const message = {
                    id: Date.now() + Math.random(),
                    customerId: customer.id,
                    customerName: customer.name,
                    title: title,
                    body: personalizedBody,
                    originalBody: body,
                    position: position,
                    sendType: sendType,
                    scheduleTime: sendType === 'scheduled' ? scheduleTime : null,
                    status: sendType === 'scheduled' ? 'scheduled' : 'success',
                    sentAt: sendType === 'immediate' ? new Date().toISOString() : null,
                    createdAt: new Date().toISOString()
                };

                messages.unshift(message);
                sentCount++;
            });

            saveMessagesToDrive();
            resetSendForm();
            selectedCustomersData = {};
            renderCustomers();
            
            alert(`‚úÖ ${sentCount}Î™ÖÏùò Í≥†Í∞ùÏóêÍ≤å Î©îÏãúÏßÄÍ∞Ä ${sendType === 'scheduled' ? 'ÏòàÏïΩ' : 'Î∞úÏÜ°'}ÎêòÏóàÏäµÎãàÎã§!`);
            
            switchTab('log');
        }

        function resetSendForm() {
            document.getElementById('sendForm').reset();
            document.getElementById('scheduleGroup').classList.add('hidden');
        }

        function toggleSchedule() {
            const sendType = document.getElementById('sendType').value;
            const scheduleGroup = document.getElementById('scheduleGroup');
            
            if (sendType === 'scheduled') {
                scheduleGroup.classList.remove('hidden');
            } else {
                scheduleGroup.classList.add('hidden');
            }
        }

        // ===== Í∏∞ÎÖêÏùº ÏûêÎèôÎ∞úÏÜ° =====
        function openAnniversaryModal(type, customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            currentAnniversaryCustomer = customer;

            const modal = document.getElementById('anniversaryModal');
            const title = document.getElementById('anniversaryModalTitle');
            const customerInput = document.getElementById('anniversaryCustomer');
            const dateInput = document.getElementById('anniversaryDate');
            const titleInput = document.getElementById('anniversaryTitle');
            const bodyInput = document.getElementById('anniversaryBody');

            title.textContent = type === 'birthday' ? 'üéÇ ÏÉùÏùº ÏûêÎèôÎ∞úÏÜ° ÏÑ§Ï†ï' : 'üéâ Í∏∞ÎÖêÏùº ÏûêÎèôÎ∞úÏÜ° ÏÑ§Ï†ï';
            customerInput.value = `${customer.name} ${customer.position || ''}`;
            dateInput.value = type === 'birthday' ? formatBirthDate(customer.birth) : formatBirthDate(customer.anniversary);

            if (type === 'birthday') {
                titleInput.value = 'ÏÉùÏùº Ï∂ïÌïò Î©îÏãúÏßÄ';
                bodyInput.value = `{name} {position}Îãò,\n\nÏÉùÏùºÏùÑ ÏßÑÏã¨ÏúºÎ°ú Ï∂ïÌïòÎìúÎ¶ΩÎãàÎã§!\nÍ±¥Í∞ïÌïòÍ≥† ÌñâÎ≥µÌïú Ìïú Ìï¥ ÎêòÏãúÍ∏∏ Î∞îÎûçÎãàÎã§.`;
            } else {
                titleInput.value = 'Í∏∞ÎÖêÏùº Ï∂ïÌïò Î©îÏãúÏßÄ';
                bodyInput.value = `{name} {position}Îãò,\n\nÏÜåÏ§ëÌïú Í∏∞ÎÖêÏùºÏùÑ Ï∂ïÌïòÎìúÎ¶ΩÎãàÎã§!`;
            }

            modal.classList.add('active');
        }

        function closeAnniversaryModal() {
            document.getElementById('anniversaryModal').classList.remove('active');
            currentAnniversaryCustomer = null;
        }

        function toggleRepeatOptions() {
            const repeatCycle = document.getElementById('repeatCycle').value;
            const repeatOptions = document.getElementById('repeatOptions');
            
            if (repeatCycle !== 'once') {
                repeatOptions.classList.remove('hidden');
            } else {
                repeatOptions.classList.add('hidden');
            }
        }

        function saveAnniversarySchedule(e) {
            e.preventDefault();

            if (!currentAnniversaryCustomer) return;

            const schedule = {
                id: Date.now(),
                customerId: currentAnniversaryCustomer.id,
                customerName: currentAnniversaryCustomer.name,
                anniversaryDate: document.getElementById('anniversaryDate').value,
                title: document.getElementById('anniversaryTitle').value,
                body: document.getElementById('anniversaryBody').value,
                sendTime: document.getElementById('anniversarySendTime').value,
                repeatCycle: document.getElementById('repeatCycle').value,
                repeatCount: document.getElementById('repeatCount').value || null,
                repeatEndDate: document.getElementById('repeatEndDate').value || null,
                status: 'active',
                createdAt: new Date().toISOString()
            };

            anniversarySchedules.push(schedule);
            saveMessagesToDrive();
            closeAnniversaryModal();
            
            alert('‚úÖ Í∏∞ÎÖêÏùº ÏûêÎèôÎ∞úÏÜ°Ïù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§!');
        }

        // ===== ÌÖúÌîåÎ¶ø =====
        function openTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        function saveTemplate(e) {
            e.preventDefault();

            const template = {
                id: Date.now(),
                name: document.getElementById('templateName').value,
                title: document.getElementById('templateTitle').value,
                body: document.getElementById('templateBody').value,
                createdAt: new Date().toISOString()
            };

            templates.push(template);
            saveMessagesToDrive();
            closeTemplateModal();
            renderTemplates();
            
            alert('‚úÖ ÌÖúÌîåÎ¶øÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
        }

        function renderTemplates() {
            const templateList = document.getElementById('templateList');
            
            if (templates.length === 0) {
                templateList.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">Îì±Î°ùÎêú ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏäµÎãàÎã§</p>';
                return;
            }

            templateList.innerHTML = templates.map(template => `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${template.name}</div>
                        <div style="font-size: 13px; opacity: 0.8;">${template.title}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="useTemplate(${template.id})">ÏÇ¨Ïö©</button>
                        <button class="btn btn-danger" onclick="deleteTemplate(${template.id})">ÏÇ≠Ï†ú</button>
                    </div>
                </div>
            `).join('');
        }

        function useTemplate(id) {
            const template = templates.find(t => t.id === id);
            if (!template) return;

            switchTab('send');
            document.getElementById('messageTitle').value = template.title;
            document.getElementById('messageBody').value = template.body;
        }

        function deleteTemplate(id) {
            if (!confirm('Ïù¥ ÌÖúÌîåÎ¶øÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            templates = templates.filter(t => t.id !== id);
            saveMessagesToDrive();
            renderTemplates();
        }

        // ===== Ïú†Ìã∏Î¶¨Ìã∞ =====
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº`;
        }

        function formatBirthDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº`;
        }

        // ===== ÌÉ≠ Ï†ÑÌôò =====
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            event.target.classList.add('active');
            
            const tabMap = {
                'send': 'sendTab',
                'anniversary': 'anniversaryTab',
                'log': 'logTab',
                'template': 'templateTab'
            };
            
            document.getElementById(tabMap[tab]).classList.remove('hidden');
        }

        // ===== ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò =====
        function goBack() {
            if (confirm('Î∞úÏÜ°Í¥ÄÎ¶¨Î•º Ï¢ÖÎ£åÌïòÍ≥† Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?')) {
                window.location.href = 'index.html';
            }
        }

        function logout() {
            if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                localStorage.removeItem('googleAccessToken');
                window.location.href = 'login.html';
            }
        }

        // ===== Ï¥àÍ∏∞Ìôî =====
        function init() {
            const savedToken = localStorage.getItem('googleAccessToken');
            if (savedToken) {
                accessToken = savedToken;
                isDriveConnected = true;
                document.getElementById('driveBtn').textContent = '‚úÖ Ïó∞Îèô ÏôÑÎ£å';
                loadAllData();
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>