<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>고객 관리 - Executive Consulting Solution</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <!-- CryptoJS for 암호화 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  
  <!-- 다음 주소 API -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      min-height: 100vh;
      padding: 1rem;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .header h1 {
      color: #fff;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      justify-content: center;
    }
    
    .btn {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      text-decoration: none;
      white-space: nowrap;
    }
    
    .btn-back {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .btn-back:hover {
      background: rgba(255,255,255,0.25);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FF8802 0%, #FF6B00 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(255,136,2,0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255,136,2,0.4);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.9);
      color: #0c2c54;
    }
    
    .btn-secondary:hover {
      background: #fff;
    }
    
    .btn-map {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: #fff;
    }
    
    .btn-map:hover {
      transform: translateY(-2px);
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 1.5rem;
      color: #fff;
    }
    
    .stat-card h3 {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 0.5rem;
    }
    
    .stat-card .number {
      font-size: 2rem;
      font-weight: 700;
    }
    
    .controls {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .controls-top {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 2.5rem;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.95rem;
    }
    
    .search-box input::placeholder {
      color: rgba(255,255,255,0.6);
    }
    
    .search-icon {
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
    }
    
    .controls-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .btn-google-drive {
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(66,133,244,0.3);
    }
    
    .btn-google-drive:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(66,133,244,0.4);
    }
    
    .btn-delete-selected {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      display: none;
    }
    
    .btn-delete-selected.show {
      display: inline-flex;
    }
    
    .btn-send-selected {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      display: none;
    }
    
    .btn-send-selected.show {
      display: inline-flex;
    }
    
    .table-container {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      overflow-x: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1500px;
    }
    
    thead {
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      color: #fff;
    }
    
    th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    
    th:first-child {
      width: 40px;
      text-align: center;
    }
    
    th:nth-child(2) {
      width: 50px;
      text-align: center;
    }
    
    td {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      color: #334155;
    }
    
    tbody tr:hover {
      background: #f8fafc;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .action-btns {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    
    .btn-icon {
      padding: 0.5rem 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.8rem;
      background: #f1f5f9;
      white-space: nowrap;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }
    
    .btn-icon:hover {
      transform: translateY(-2px);
    }
    
    .btn-view { background: #3b82f6; color: #fff; }
    .btn-edit { background: #10b981; color: #fff; }
    .btn-delete { background: #ef4444; color: #fff; }
    .btn-ceo { background: #FF8802; color: #fff; }
    .btn-fm { background: #8b5cf6; color: #fff; }
    .btn-call { background: #06b6d4; color: #fff; padding: 0.4rem 0.6rem; margin-left: 0.3rem; }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      padding: 2rem;
      overflow-y: auto;
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      color: #fff;
      border-radius: 16px 16px 0 0;
    }
    
    .modal-header h2 {
      font-size: 1.3rem;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: 0.2s;
    }
    
    .close-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1.2rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #334155;
      font-size: 0.9rem;
    }
    
    .required::after {
      content: ' *';
      color: #ef4444;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: 0.2s;
    }
    
    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: #94a3b8;
      font-size: 0.85rem;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #FF8802;
      box-shadow: 0 0 0 3px rgba(255,136,2,0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .phone-inputs {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .phone-prefix {
      padding: 0.7rem 1rem;
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-weight: 600;
      color: #475569;
    }
    
    .phone-inputs input {
      flex: 1;
      text-align: center;
    }
    
    .address-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .address-group input {
      flex: 1;
    }
    
    .btn-address {
      padding: 0.7rem 1.2rem;
      background: #475569;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn-address:hover {
      background: #334155;
    }
    
    .calendar-type {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .calendar-type label {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-weight: normal;
      cursor: pointer;
    }
    
    .anniversary-input {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .anniversary-input input[type="text"] {
      flex: 1;
    }
    
    .anniversary-input input[type="date"] {
      flex: 2;
    }
    
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }
    
    .btn-cancel {
      background: #e2e8f0;
      color: #475569;
    }
    
    .btn-cancel:hover {
      background: #cbd5e1;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .loading {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loading.hide { display: none; }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #fff;
      margin-top: 1rem;
      font-size: 1rem;
    }
    
    .spreadsheet-container {
      overflow-x: auto;
      margin: 1rem 0;
    }
    
    .spreadsheet {
      border-collapse: collapse;
      width: 100%;
      min-width: 1200px;
    }
    
    .spreadsheet th,
    .spreadsheet td {
      border: 1px solid #cbd5e1;
      padding: 0.5rem;
    }
    
    .spreadsheet th {
      background: #f1f5f9;
      font-weight: 600;
      color: #475569;
      position: sticky;
      top: 0;
      font-size: 0.85rem;
    }
    
    .spreadsheet th:nth-child(1), .spreadsheet td:nth-child(1) { min-width: 100px; }
    .spreadsheet th:nth-child(2), .spreadsheet td:nth-child(2) { min-width: 80px; }
    .spreadsheet th:nth-child(3), .spreadsheet td:nth-child(3) { min-width: 80px; }
    .spreadsheet th:nth-child(4), .spreadsheet td:nth-child(4) { min-width: 120px; }
    .spreadsheet th:nth-child(5), .spreadsheet td:nth-child(5) { min-width: 250px; }
    .spreadsheet th:nth-child(6), .spreadsheet td:nth-child(6) { min-width: 150px; }
    .spreadsheet th:nth-child(7), .spreadsheet td:nth-child(7) { min-width: 120px; }
    .spreadsheet th:nth-child(8), .spreadsheet td:nth-child(8) { min-width: 100px; }
    .spreadsheet th:nth-child(9), .spreadsheet td:nth-child(9) { min-width: 120px; }
    .spreadsheet th:nth-child(10), .spreadsheet td:nth-child(10) { min-width: 120px; }
    .spreadsheet th:nth-child(11), .spreadsheet td:nth-child(11) { min-width: 80px; }
    .spreadsheet th:nth-child(12), .spreadsheet td:nth-child(12) { min-width: 100px; }
    .spreadsheet th:nth-child(13), .spreadsheet td:nth-child(13) { min-width: 120px; }
    .spreadsheet th:nth-child(14), .spreadsheet td:nth-child(14) { min-width: 150px; }
    .spreadsheet th:nth-child(15), .spreadsheet td:nth-child(15) { min-width: 200px; }
    
    .spreadsheet input,
    .spreadsheet select {
      width: 100%;
      border: none;
      padding: 0.3rem;
      background: transparent;
    }
    
    .spreadsheet input::placeholder {
      color: #94a3b8;
      font-size: 0.8rem;
    }
    
    .spreadsheet input:focus,
    .spreadsheet select:focus {
      outline: 2px solid #FF8802;
      background: #fff;
    }

    .map-modal-content {
      max-width: 90%;
      max-height: 90vh;
    }

    #clientMap {
      width: 100%;
      height: 70vh;
      border-radius: 8px;
    }
    
    #addressLayer {
      display: none;
      position: fixed;
      overflow: hidden;
      z-index: 10000;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    
    #addressLayer.show {
      display: flex;
    }
    
    #addressWrap {
      position: relative;
      width: 90%;
      max-width: 500px;
      height: 500px;
      border: 5px solid #FF8802;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
    }
    
    #addressCloseBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10001;
      background: #FF8802;
      color: #fff;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    #addressCloseBtn:hover {
      background: #FF6B00;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .header {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }
      
      .header h1 {
        justify-content: center;
        font-size: 1.5rem;
      }
      
      .btn-back {
        position: static !important;
        width: 100%;
      }
      
      .stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      
      .stat-card {
        padding: 1rem;
      }
      
      .stat-card h3 {
        font-size: 0.8rem;
      }
      
      .stat-card .number {
        font-size: 1.5rem;
      }
      
      .controls {
        padding: 1rem;
      }
      
      .controls-top {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .search-box {
        min-width: 100%;
      }
      
      .controls-buttons {
        flex-wrap: wrap;
        gap: 0.4rem;
      }
      
      .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        gap: 0.2rem;
      }
      
      .table-container {
        font-size: 0.85rem;
      }
      
      .modal-content {
        max-width: 95%;
        margin: 1rem;
      }
    }
    
    @media (min-width: 769px) and (max-width: 1024px) {
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.3rem;
      }
      
      .btn {
        padding: 0.45rem 0.6rem;
        font-size: 0.7rem;
      }
      
      .stat-card .number {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">구글 드라이브 연결 중...</div>
  </div>

  <div class="container">
    <div class="header">
      <a href="index.html" class="btn btn-back" style="position: absolute; left: 1.5rem;">← 돌아가기</a>
      <h1>🏢 고객 관리</h1>
    </div>

    <div class="stats">
      <div class="stat-card">
        <h3>총 고객</h3>
        <div class="number" id="totalClients">0</div>
      </div>
      <div class="stat-card">
        <h3>이번 달 추가</h3>
        <div class="number" id="monthlyClients">0</div>
      </div>
      <div class="stat-card">
        <h3>생일 예정</h3>
        <div class="number" id="upcomingBirthdays">0</div>
      </div>
      <div class="stat-card">
        <h3>기념일 예정</h3>
        <div class="number" id="upcomingAnniversaries">0</div>
      </div>
    </div>

    <div class="controls">
      <div class="controls-top">
        <div class="search-box">
          <span class="search-icon">🔍</span>
          <input type="text" id="searchInput" placeholder="이름, 회사명, 연락처로 검색...">
        </div>
      </div>
      <div class="controls-buttons">
        <button class="btn btn-google-drive" onclick="handleGoogleDriveConnect()">🔗 구글 드라이브 연동</button>
        <button class="btn btn-primary" onclick="openAddModal()">➕ 고객 추가</button>
        <button class="btn btn-secondary" onclick="openBulkUploadModal()">📥 단체 등록</button>
        <button class="btn btn-secondary" onclick="exportToExcel()">📤 엑셀 내보내기</button>
        <button class="btn btn-map" onclick="openMapModal()">🗺️ 지도에서 보기</button>
        <button class="btn btn-delete-selected" id="deleteSelectedBtn" onclick="deleteSelected()">🗑️ 선택 삭제</button>
        <button class="btn btn-send-selected" id="sendSelectedBtn" onclick="sendToSelected()">📧 선택 발송</button>
      </div>
    </div>

    <div class="table-container">
      <table id="clientsTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
            <th>No</th>
            <th>고객명</th>
            <th>직함</th>
            <th>호칭</th>
            <th>연락처</th>
            <th>회사명</th>
            <th>직업</th>
            <th>주소</th>
            <th>좌표</th>
            <th>생일</th>
            <th>등록일</th>
            <th style="min-width: 280px;">프로그램</th>
            <th>발송</th>
          </tr>
        </thead>
        <tbody id="clientsTableBody">
          <tr>
            <td colspan="14" class="empty-state">
              <div class="empty-state-icon">📋</div>
              <div>등록된 고객이 없습니다.<br/>고객을 추가해보세요!</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 고객 추가/수정 모달 -->
  <div class="modal" id="clientModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">➕ 고객 추가</h2>
        <button class="close-btn" onclick="closeModal('clientModal')">×</button>
      </div>
      <div class="modal-body">
        <form id="clientForm">
          <div class="form-group">
            <label class="required">고객명</label>
            <input type="text" id="clientName" required placeholder="홍길동">
          </div>
          
          <div class="form-group">
            <label>직함</label>
            <input type="text" id="clientTitle" placeholder="과장, 팀장, 대표이사 등">
          </div>
          
          <div class="form-group">
            <label>호칭</label>
            <input type="text" id="clientHonorific" value="님" placeholder="님">
          </div>
          
          <div class="form-group">
            <label class="required">연락처</label>
            <div class="phone-inputs">
              <span class="phone-prefix">010</span>
              <span>-</span>
              <input type="text" id="phone1" maxlength="4" required placeholder="1234" inputmode="numeric">
              <span>-</span>
              <input type="text" id="phone2" maxlength="4" required placeholder="5678" inputmode="numeric">
            </div>
          </div>
          
          <div class="form-group">
            <label class="required">주소</label>
            <div class="address-group">
              <input type="text" id="postcode" placeholder="우편번호" readonly>
              <button type="button" class="btn-address" onclick="findAddress()">🔍 주소찾기</button>
            </div>
            <input type="text" id="address" placeholder="기본주소" readonly style="margin-bottom:0.5rem;">
            <input type="text" id="detailAddress" placeholder="상세주소 (필수)" required>
          </div>
          
          <div class="form-group">
            <label>회사명</label>
            <input type="text" id="company" placeholder="(주)ABC">
          </div>
          
          <div class="form-group">
            <label>직업</label>
            <input type="text" id="job" placeholder="대표이사">
          </div>
          
          <div class="form-group">
            <label>생년월일</label>
            <input type="date" id="birthDate">
          </div>
          
          <div class="form-group">
            <label>생일</label>
            <input type="date" id="birthday">
            <div class="calendar-type">
              <label>
                <input type="radio" name="birthdayType" value="solar" checked> ☀️ 양력
              </label>
              <label>
                <input type="radio" name="birthdayType" value="lunar"> 🌙 음력
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label>기념일</label>
            <div class="anniversary-input">
              <input type="text" id="anniversaryName" placeholder="항목명 (예: 결혼기념일)">
              <input type="date" id="anniversary">
            </div>
          </div>
          
          <div class="form-group">
            <label>이메일</label>
            <input type="email" id="email" placeholder="example@email.com">
          </div>
          
          <div class="form-group">
            <label>메모</label>
            <textarea id="memo" placeholder="메모 사항"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeModal('clientModal')">취소</button>
        <button class="btn btn-primary" onclick="saveClient()">💾 저장</button>
      </div>
    </div>
  </div>

  <!-- 단체 등록 모달 -->
  <div class="modal" id="bulkUploadModal">
    <div class="modal-content" style="max-width: 95%; max-height: 95vh;">
      <div class="modal-header">
        <h2>📥 단체 고객 등록</h2>
        <button class="close-btn" onclick="closeModal('bulkUploadModal')">×</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 1rem;">
          <label class="btn btn-secondary" style="cursor: pointer;">
            📁 엑셀 파일 선택
            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handleFileUpload(event)">
          </label>
          <span style="margin: 0 1rem; color: #64748b;">또는</span>
          <button class="btn btn-secondary" onclick="initSpreadsheet()">📋 직접 입력</button>
        </div>
        
        <div id="spreadsheetContainer" style="display:none;">
          <div class="spreadsheet-container">
            <table class="spreadsheet" id="spreadsheet">
              <thead>
                <tr>
                  <th>고객명*</th>
                  <th>직함</th>
                  <th>호칭</th>
                  <th>연락처*</th>
                  <th>주소*</th>
                  <th>상세주소*</th>
                  <th>회사명</th>
                  <th>직업</th>
                  <th>생년월일</th>
                  <th>생일</th>
                  <th>양/음력</th>
                  <th>기념일명</th>
                  <th>기념일</th>
                  <th>이메일</th>
                  <th>메모</th>
                </tr>
              </thead>
              <tbody id="spreadsheetBody">
              </tbody>
            </table>
          </div>
          <div style="margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="addSpreadsheetRow()">➕ 행 추가</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeModal('bulkUploadModal')">취소</button>
        <button class="btn btn-primary" onclick="saveBulkClients()">💾 일괄 저장</button>
      </div>
    </div>
  </div>

  <!-- 상세보기 모달 -->
  <div class="modal" id="viewModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>👤 고객 상세정보</h2>
        <button class="close-btn" onclick="closeModal('viewModal')">×</button>
      </div>
      <div class="modal-body" id="viewModalBody">
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeModal('viewModal')">닫기</button>
      </div>
    </div>
  </div>

  <!-- 지도 모달 -->
  <div class="modal" id="mapModal">
    <div class="modal-content map-modal-content">
      <div class="modal-header">
        <h2>🗺️ 고객 지도</h2>
        <button class="close-btn" onclick="closeModal('mapModal')">×</button>
      </div>
      <div class="modal-body">
        <div id="clientMap"></div>
        <div id="mapInfo" style="margin-top: 1rem; padding: 1rem; background: #f1f5f9; border-radius: 8px; color: #334155;">
          <strong>📍 마커 정보:</strong>
          <span id="markerCount">로딩 중...</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeModal('mapModal')">닫기</button>
      </div>
    </div>
  </div>

  <!-- 주소 검색 레이어 -->
  <div id="addressLayer">
    <div id="addressWrap">
      <button id="addressCloseBtn" onclick="closeAddressLayer()">×</button>
      <div id="addressContent" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
      authDomain: "kfpc-company-support-project.firebaseapp.com",
      projectId: "kfpc-company-support-project"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    const CLIENT_ID = '288996084140-0eo93heqd66hqhg0fh1rbum6scnt3757.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const ENCRYPTION_KEY = 'KFPC-CEO-FOCUS-MASTER-KEY-2025';
    
    let clients = [];
    let currentEditId = null;
    let currentUser = null;
    let tokenClient;
    let accessToken = null;
    let gisInited = false;
    let kakaoMapLoaded = false;
    
    function encryptData(data) {
      const jsonString = JSON.stringify(data);
      const encrypted = CryptoJS.AES.encrypt(jsonString, ENCRYPTION_KEY);
      return encrypted.toString();
    }
    
    function decryptData(encryptedData) {
      try {
        const decrypted = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
        const jsonString = decrypted.toString(CryptoJS.enc.Utf8);
        return JSON.parse(jsonString);
      } catch (error) {
        console.error('복호화 오류:', error);
        return [];
      }
    }
    
    function saveLoginState() {
      if (accessToken) {
        localStorage.setItem('googleAccessToken', accessToken);
        localStorage.setItem('tokenExpiry', Date.now() + 3600000);
      }
    }
    
    function restoreLoginState() {
      const token = localStorage.getItem('googleAccessToken');
      const expiry = localStorage.getItem('tokenExpiry');
      
      if (token && expiry && Date.now() < parseInt(expiry)) {
        accessToken = token;
        return true;
      }
      
      localStorage.removeItem('googleAccessToken');
      localStorage.removeItem('tokenExpiry');
      return false;
    }
    
    function gisLoaded() {
      console.log('✅ Google Identity Services 로드');
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      console.log('✅ Google OAuth 준비 완료');
    }
    
    function initGoogleAPI() {
      let attempts = 0;
      const maxAttempts = 50;
      
      const checkGIS = setInterval(() => {
        attempts++;
        if (typeof google !== 'undefined' && google.accounts) {
          clearInterval(checkGIS);
          gisLoaded();
        } else if (attempts >= maxAttempts) {
          clearInterval(checkGIS);
          console.warn('⚠️ Google API 로드 지연');
        }
      }, 100);
    }
    
    async function init() {
      document.getElementById('loading').classList.add('hide');
      currentUser = { uid: 'user-' + Date.now() };
      checkDaumPostcode();
      initGoogleAPI();
      
      if (restoreLoginState()) {
        console.log('✅ 로그인 상태 복원 중...');
        loadClients().then(() => {
          updateStats();
          console.log('✅ 데이터 로드 완료');
        }).catch(err => {
          console.error('데이터 로드 오류:', err);
        });
      }
    }
    
    function checkDaumPostcode() {
      let attempts = 0;
      const maxAttempts = 50;
      
      const checkDaum = setInterval(() => {
        attempts++;
        if (typeof daum !== 'undefined' && daum.Postcode) {
          clearInterval(checkDaum);
          console.log('✅ 다음 주소 API 로드 완료');
        } else if (attempts >= maxAttempts) {
          clearInterval(checkDaum);
          console.warn('⚠️ 다음 주소 API 로드 실패');
        }
      }, 100);
    }
    
    function loadKakaoMapAPI() {
      return new Promise((resolve, reject) => {
        if (kakaoMapLoaded || (typeof kakao !== 'undefined' && kakao.maps)) {
          kakaoMapLoaded = true;
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = '//dapi.kakao.com/v2/maps/sdk.js?appkey=1ada66397913195f6a7512567faa5fac&libraries=services&autoload=false';
        script.onload = () => {
          kakao.maps.load(() => {
            kakaoMapLoaded = true;
            console.log('✅ 카카오 지도 로드 완료');
            resolve();
          });
        };
        script.onerror = () => {
          console.error('❌ 카카오 지도 API 로드 실패');
          reject(new Error('카카오 지도 API 로드 실패'));
        };
        document.head.appendChild(script);
      });
    }
    
    function handleGoogleDriveConnect() {
      if (!gisInited) {
        alert('Google API가 아직 로딩 중입니다. 잠시 후 다시 시도해주세요.');
        return;
      }
      
      showGoogleDriveInfo();
      
      setTimeout(() => {
        console.log('🔐 Google 로그인 시작...');
        
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            console.error('❌ 로그인 오류:', resp);
            alert('로그인에 실패했습니다: ' + resp.error);
            document.getElementById('loading').classList.add('hide');
            return;
          }
          
          accessToken = resp.access_token;
          saveLoginState();
          console.log('✅ Google 로그인 성공!');
          
          await loadClients();
          updateStats();
          document.getElementById('loading').classList.add('hide');
          alert('구글 드라이브 연동 완료! ✅');
        };
        
        if (accessToken === null) {
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          tokenClient.requestAccessToken({prompt: ''});
        }
      }, 2000);
    }
    
    async function findFile(fileName) {
      if (!accessToken) return null;
      
      try {
        const response = await fetch(
          `https://www.googleapis.com/drive/v3/files?q=name='${fileName}' and trashed=false&fields=files(id,name)`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          }
        );
        
        const data = await response.json();
        
        if (data.files && data.files.length > 0) {
          console.log('✅ 파일 발견:', data.files[0].id);
          return data.files[0];
        }
        
        console.log('ℹ️ 파일 없음');
        return null;
      } catch (error) {
        console.error('❌ 파일 검색 오류:', error);
        return null;
      }
    }
    
    async function downloadFile(fileId) {
      try {
        const response = await fetch(
          `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          }
        );
        
        return await response.text();
      } catch (error) {
        console.error('❌ 파일 다운로드 오류:', error);
        return null;
      }
    }
    
    async function uploadFile(fileName, content) {
      try {
        const metadata = {
          name: fileName,
          mimeType: 'application/octet-stream'
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([content], { type: 'application/octet-stream' }));
        
        const response = await fetch(
          'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            },
            body: form
          }
        );
        
        return await response.json();
      } catch (error) {
        console.error('❌ 파일 업로드 오류:', error);
        return null;
      }
    }
    
    async function updateFile(fileId, content) {
      try {
        const response = await fetch(
          `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
          {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/octet-stream'
            },
            body: content
          }
        );
        
        return await response.json();
      } catch (error) {
        console.error('❌ 파일 업데이트 오류:', error);
        return null;
      }
    }
    
    async function loadFromDrive() {
      try {
        const file = await findFile('고객목록.fmd');
        
        if (file) {
          const encryptedData = await downloadFile(file.id);
          if (encryptedData) {
            return decryptData(encryptedData);
          }
        }
        
        return [];
      } catch (error) {
        console.error('드라이브 로드 오류:', error);
        return [];
      }
    }
    
    async function saveToDrive() {
      try {
        const encrypted = encryptData(clients);
        const file = await findFile('고객목록.fmd');
        
        if (file) {
          await updateFile(file.id, encrypted);
        } else {
          await uploadFile('고객목록.fmd', encrypted);
        }
        
        return true;
      } catch (error) {
        console.error('드라이브 저장 오류:', error);
        return false;
      }
    }
    
    async function loadClients() {
      clients = await loadFromDrive();
      renderTable();
    }
    
    async function saveClients() {
      const success = await saveToDrive();
      if (success) {
        renderTable();
        updateStats();
      } else {
        alert('저장에 실패했습니다. 다시 시도해주세요.');
      }
    }
    
    function formatPhone(phone) {
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 11) {
        return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
      } else if (cleaned.length === 10) {
        return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
      }
      return phone;
    }
    
    function getFullName(client) {
      let fullName = client.name;
      if (client.title) {
        fullName += ' ' + client.title;
      }
      if (client.honorific) {
        fullName += client.honorific;
      }
      return fullName;
    }
    
    function renderTable() {
      const tbody = document.getElementById('clientsTableBody');
      
      if (clients.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="14" class="empty-state">
              <div class="empty-state-icon">📋</div>
              <div>등록된 고객이 없습니다.<br/>고객을 추가해보세요!</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = clients.map((client, index) => `
        <tr>
          <td style="text-align: center;">
            <input type="checkbox" class="client-checkbox" value="${index}" onchange="updateSelectedButtons()">
          </td>
          <td style="text-align: center;"><strong>${index + 1}</strong></td>
          <td><strong>${client.name}</strong></td>
          <td>${client.title || '-'}</td>
          <td>${client.honorific || '-'}</td>
          <td>
            ${formatPhone(client.phone)}
            <a href="tel:${client.phone}" class="btn-icon btn-call" title="전화걸기">📞</a>
          </td>
          <td>${client.company || '-'}</td>
          <td>${client.job || '-'}</td>
          <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${client.address}">${client.address}</td>
          <td style="font-size: 0.75rem; color: #64748b;">${client.latitude && client.longitude ? `${client.latitude.toFixed(4)}, ${client.longitude.toFixed(4)}` : '미등록'}</td>
          <td>${client.birthday ? new Date(client.birthday).toLocaleDateString() : '-'}</td>
          <td>${new Date(client.createdAt).toLocaleDateString()}</td>
          <td>
            <div class="action-btns">
              <button class="btn-icon btn-ceo" onclick="openCEOFocus(${index})" title="CEO Focus">CEO</button>
              <button class="btn-icon btn-fm" onclick="openFM(${index})" title="FM">FM</button>
              <button class="btn-icon btn-view" onclick="viewClient(${index})" title="상세보기">👁️</button>
              <button class="btn-icon btn-edit" onclick="editClient(${index})" title="수정">✏️</button>
              <button class="btn-icon btn-delete" onclick="deleteClient(${index})" title="삭제">🗑️</button>
            </div>
          </td>
          <td style="text-align: center;">
            <button class="btn-icon" onclick="sendToClient(${index})" style="background: #10b981; color: #fff;" title="발송">📧</button>
          </td>
        </tr>
      `).join('');
      
      document.getElementById('selectAll').checked = false;
      updateSelectedButtons();
    }
    
    function updateStats() {
      document.getElementById('totalClients').textContent = clients.length;
      
      const now = new Date();
      const thisMonth = clients.filter(c => {
        const created = new Date(c.createdAt);
        return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
      }).length;
      document.getElementById('monthlyClients').textContent = thisMonth;
      
      const today = new Date();
      const in30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
      
      const upcomingBirthdays = clients.filter(c => {
        if (!c.birthday) return false;
        const birthday = new Date(c.birthday);
        const thisYearBirthday = new Date(today.getFullYear(), birthday.getMonth(), birthday.getDate());
        return thisYearBirthday >= today && thisYearBirthday <= in30Days;
      }).length;
      
      const upcomingAnniversaries = clients.filter(c => {
        if (!c.anniversary) return false;
        const anniversary = new Date(c.anniversary);
        const thisYearAnniversary = new Date(today.getFullYear(), anniversary.getMonth(), anniversary.getDate());
        return thisYearAnniversary >= today && thisYearAnniversary <= in30Days;
      }).length;
      
      document.getElementById('upcomingBirthdays').textContent = upcomingBirthdays;
      document.getElementById('upcomingAnniversaries').textContent = upcomingAnniversaries;
    }
    
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
      if (modalId === 'clientModal') {
        document.getElementById('clientForm').reset();
        document.getElementById('clientHonorific').value = '님';
        currentEditId = null;
      }
    }
    
    function openAddModal() {
      currentEditId = null;
      document.getElementById('modalTitle').textContent = '➕ 고객 추가';
      document.getElementById('clientForm').reset();
      document.getElementById('clientHonorific').value = '님';
      openModal('clientModal');
    }
    
    async function getCoordinates(address) {
      try {
        if (!kakaoMapLoaded) {
          try {
            await loadKakaoMapAPI();
          } catch (error) {
            console.error('카카오 지도 API 로드 실패:', error);
            return { latitude: null, longitude: null };
          }
        }
        
        if (typeof kakao === 'undefined' || !kakao.maps || !kakao.maps.services) {
          console.warn('⚠️ 카카오 지도 API를 사용할 수 없습니다.');
          return { latitude: null, longitude: null };
        }
        
        const cleanAddress = address.split(' ').slice(0, 5).join(' ');
        
        console.log('🗺️ 좌표 변환 시도:', cleanAddress);
        
        return new Promise((resolve) => {
          const geocoder = new kakao.maps.services.Geocoder();
          geocoder.addressSearch(cleanAddress, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              console.log('✅ 좌표 변환 성공:', result[0].y, result[0].x);
              resolve({
                latitude: parseFloat(result[0].y),
                longitude: parseFloat(result[0].x)
              });
            } else {
              console.warn('❌ 좌표 변환 실패:', cleanAddress, 'Status:', status);
              resolve({ latitude: null, longitude: null });
            }
          });
        });
      } catch (error) {
        console.error('좌표 변환 오류:', error);
        return { latitude: null, longitude: null };
      }
    }
    
    function findAddress() {
      if (typeof daum === 'undefined') {
        alert('주소 검색 API를 불러오는 중입니다.\n페이지를 새로고침 해주세요.');
        console.error('Daum Postcode API not loaded');
        return;
      }
      
      if (!daum.Postcode) {
        alert('주소 검색 서비스를 초기화할 수 없습니다.\n페이지를 새로고침 해주세요.');
        console.error('Daum Postcode not available');
        return;
      }
      
      try {
        document.getElementById('addressLayer').classList.add('show');
        
        new daum.Postcode({
          oncomplete: function(data) {
            document.getElementById('postcode').value = data.zonecode;
            document.getElementById('address').value = data.address;
            closeAddressLayer();
            document.getElementById('detailAddress').focus();
          },
          width: '100%',
          height: '100%'
        }).embed(document.getElementById('addressContent'));
        
      } catch (error) {
        console.error('주소 검색 오류:', error);
        alert('주소 검색 중 오류가 발생했습니다.\n페이지를 새로고침 후 다시 시도해주세요.');
        closeAddressLayer();
      }
    }
    
    function closeAddressLayer() {
      const layer = document.getElementById('addressLayer');
      layer.classList.remove('show');
      document.getElementById('addressContent').innerHTML = '';
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const addressLayer = document.getElementById('addressLayer');
      addressLayer.addEventListener('click', function(e) {
        if (e.target === addressLayer) {
          closeAddressLayer();
        }
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && addressLayer.classList.contains('show')) {
          closeAddressLayer();
        }
      });
    });
    
    async function saveClient() {
      const name = document.getElementById('clientName').value.trim();
      const title = document.getElementById('clientTitle').value.trim();
      const honorific = document.getElementById('clientHonorific').value.trim();
      const phone1 = document.getElementById('phone1').value.trim();
      const phone2 = document.getElementById('phone2').value.trim();
      const postcode = document.getElementById('postcode').value.trim();
      const address = document.getElementById('address').value.trim();
      const detailAddress = document.getElementById('detailAddress').value.trim();
      
      if (!name || !phone1 || !phone2 || !address || !detailAddress) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
      }
      
      const phone = `010${phone1}${phone2}`;
      const fullAddress = `${address} ${detailAddress}`;
      const birthdayType = document.querySelector('input[name="birthdayType"]:checked').value;
      
      const loading = document.getElementById('loading');
      loading.classList.remove('hide');
      loading.querySelector('.loading-text').textContent = '주소를 좌표로 변환 중...';
      
      console.log('\n=== 고객 추가: ' + name + ' ===');
      console.log('기본주소:', address);
      console.log('상세주소:', detailAddress);
      console.log('전체주소:', fullAddress);
      
      const coordinates = await getCoordinates(address);
      
      if (!coordinates.latitude || !coordinates.longitude) {
        const continueAnyway = confirm(
          `⚠️ 좌표 변환 실패\n\n주소: ${address}\n\n원인:\n1. 카카오 지도 API 로드 실패\n2. 주소를 인식할 수 없음\n\n💡 해결 방법:\n1. 페이지 새로고침 (F5)\n2. "주소찾기" 버튼 사용 (권장)\n3. 정확한 도로명주소 입력\n4. 건물명이나 동/호수는 상세주소에 입력\n\n그래도 저장하시겠습니까?\n(좌표 없이 저장 후 나중에 수정 가능)`
        );
        
        if (!continueAnyway) {
          loading.classList.add('hide');
          return;
        }
      }
      
      const client = {
        name,
        title,
        honorific,
        phone,
        address: fullAddress,
        postcode,
        latitude: coordinates.latitude,
        longitude: coordinates.longitude,
        company: document.getElementById('company').value.trim(),
        job: document.getElementById('job').value.trim(),
        birthDate: document.getElementById('birthDate').value,
        birthday: document.getElementById('birthday').value,
        birthdayType,
        anniversaryName: document.getElementById('anniversaryName').value.trim(),
        anniversary: document.getElementById('anniversary').value,
        email: document.getElementById('email').value.trim(),
        memo: document.getElementById('memo').value.trim(),
        createdAt: currentEditId !== null ? clients[currentEditId].createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      if (currentEditId !== null) {
        clients[currentEditId] = client;
      } else {
        clients.push(client);
      }
      
      await saveClients();
      loading.classList.add('hide');
      closeModal('clientModal');
      
      if (coordinates.latitude && coordinates.longitude) {
        alert('✅ 저장되었습니다!');
      } else {
        alert('✅ 저장되었습니다!\n\n⚠️ 좌표는 "미등록" 상태입니다.\n\n수정 버튼을 눌러 다시 저장하면\n좌표가 자동으로 생성될 수 있습니다.');
      }
    }
    
    function editClient(index) {
      currentEditId = index;
      const client = clients[index];
      
      document.getElementById('modalTitle').textContent = '✏️ 고객 수정';
      document.getElementById('clientName').value = client.name;
      document.getElementById('clientTitle').value = client.title || '';
      document.getElementById('clientHonorific').value = client.honorific || '님';
      
      const cleaned = client.phone.replace(/\D/g, '');
      if (cleaned.length === 11) {
        document.getElementById('phone1').value = cleaned.substr(3, 4);
        document.getElementById('phone2').value = cleaned.substr(7, 4);
      }
      
      document.getElementById('postcode').value = client.postcode || '';
      const addressParts = client.address.split(' ');
      const detailAddr = addressParts.pop();
      document.getElementById('address').value = addressParts.join(' ');
      document.getElementById('detailAddress').value = detailAddr;
      
      document.getElementById('company').value = client.company || '';
      document.getElementById('job').value = client.job || '';
      document.getElementById('birthDate').value = client.birthDate || '';
      document.getElementById('birthday').value = client.birthday || '';
      
      const birthdayTypeRadio = document.querySelector(`input[name="birthdayType"][value="${client.birthdayType || 'solar'}"]`);
      if (birthdayTypeRadio) birthdayTypeRadio.checked = true;
      
      document.getElementById('anniversaryName').value = client.anniversaryName || '';
      document.getElementById('anniversary').value = client.anniversary || '';
      document.getElementById('email').value = client.email || '';
      document.getElementById('memo').value = client.memo || '';
      
      openModal('clientModal');
    }
    
    async function deleteClient(index) {
      if (confirm('정말 삭제하시겠습니까?')) {
        clients.splice(index, 1);
        await saveClients();
        alert('삭제되었습니다.');
      }
    }
    
    function toggleSelectAll(checkbox) {
      const checkboxes = document.querySelectorAll('.client-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
      updateSelectedButtons();
    }
    
    function updateSelectedButtons() {
      const checkboxes = document.querySelectorAll('.client-checkbox:checked');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const sendBtn = document.getElementById('sendSelectedBtn');
      
      if (checkboxes.length > 0) {
        deleteBtn.classList.add('show');
        sendBtn.classList.add('show');
      } else {
        deleteBtn.classList.remove('show');
        sendBtn.classList.remove('show');
      }
    }
    
    async function deleteSelected() {
      const checkboxes = document.querySelectorAll('.client-checkbox:checked');
      const count = checkboxes.length;
      
      if (count === 0) {
        alert('삭제할 고객을 선택해주세요.');
        return;
      }
      
      if (!confirm(`선택한 ${count}명의 고객 데이터를 정말 삭제하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
        return;
      }
      
      const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
      
      indicesToDelete.forEach(index => {
        clients.splice(index, 1);
      });
      
      await saveClients();
      alert(`${count}명의 고객이 삭제되었습니다.`);
    }
    
    function sendToClient(index) {
      const client = clients[index];
      const fullName = getFullName(client);
      alert(`${fullName}께 메시지 발송 기능은 준비 중입니다.\n\n연락처: ${formatPhone(client.phone)}\n이메일: ${client.email || '없음'}`);
    }
    
    function sendToSelected() {
      const checkboxes = document.querySelectorAll('.client-checkbox:checked');
      const count = checkboxes.length;
      
      if (count === 0) {
        alert('발송할 고객을 선택해주세요.');
        return;
      }
      
      const selectedClients = Array.from(checkboxes).map(cb => {
        const index = parseInt(cb.value);
        return clients[index];
      });
      
      const names = selectedClients.map(c => getFullName(c)).join(', ');
      alert(`${count}명의 고객에게 일괄 발송 기능은 준비 중입니다.\n\n선택된 고객: ${names}`);
    }
    
    function showGoogleDriveInfo() {
      const message = `🔗 구글 드라이브 연동 안내\n\n안녕하세요! 고객 데이터를 안전하게 보관하기 위해\n구글 드라이브 연동이 필요합니다.\n\n📋 연동 방법:\n1. 페이지를 처음 방문하시면 Google 로그인 팝업이 나타납니다.\n2. "이 앱이 Google Drive에 접근하도록 허용하시겠습니까?"\n   메시지가 표시됩니다.\n3. [허용] 버튼을 클릭해주세요.\n\n✅ 연동 후:\n• 모든 고객 데이터가 귀하의 구글 드라이브에 암호화되어 저장됩니다.\n• "고객목록.fmd" 파일이 자동으로 생성됩니다.\n• 다른 기기에서도 같은 데이터를 볼 수 있습니다.\n\n🔒 보안:\n• AES-256 암호화로 데이터 보호\n• 귀하의 드라이브에만 저장됨\n\n감사합니다! 😊`;
      
      alert(message);
    }
    
    function viewClient(index) {
      const client = clients[index];
      const body = document.getElementById('viewModalBody');
      
      body.innerHTML = `
        <div style="padding: 1rem 0;">
          <div style="margin-bottom: 1.5rem;">
            <h3 style="color: #0c2c54; margin-bottom: 0.5rem;">기본 정보</h3>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
              <p style="margin: 0.5rem 0;"><strong>고객명:</strong> ${getFullName(client)}</p>
              <p style="margin: 0.5rem 0;"><strong>연락처:</strong> ${formatPhone(client.phone)} <a href="tel:${client.phone}" style="color: #06b6d4;">📞 전화걸기</a></p>
              <p style="margin: 0.5rem 0;"><strong>주소:</strong> ${client.address}</p>
              ${client.latitude && client.longitude ? `<p style="margin: 0.5rem 0;"><strong>좌표:</strong> ${client.latitude.toFixed(6)}, ${client.longitude.toFixed(6)}</p>` : ''}
              ${client.company ? `<p style="margin: 0.5rem 0;"><strong>회사명:</strong> ${client.company}</p>` : ''}
              ${client.job ? `<p style="margin: 0.5rem 0;"><strong>직업:</strong> ${client.job}</p>` : ''}
            </div>
          </div>
          
          ${client.birthDate || client.birthday || client.anniversary ? `
          <div style="margin-bottom: 1.5rem;">
            <h3 style="color: #0c2c54; margin-bottom: 0.5rem;">기념일 정보</h3>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
              ${client.birthDate ? `<p style="margin: 0.5rem 0;"><strong>생년월일:</strong> ${client.birthDate}</p>` : ''}
              ${client.birthday ? `<p style="margin: 0.5rem 0;"><strong>생일:</strong> ${new Date(client.birthday).toLocaleDateString()} (${client.birthdayType === 'lunar' ? '🌙 음력' : '☀️ 양력'})</p>` : ''}
              ${client.anniversary ? `<p style="margin: 0.5rem 0;"><strong>${client.anniversaryName || '기념일'}:</strong> ${new Date(client.anniversary).toLocaleDateString()}</p>` : ''}
            </div>
          </div>
          ` : ''}
          
          ${client.email || client.memo ? `
          <div>
            <h3 style="color: #0c2c54; margin-bottom: 0.5rem;">기타 정보</h3>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
              ${client.email ? `<p style="margin: 0.5rem 0;"><strong>이메일:</strong> ${client.email}</p>` : ''}
              ${client.memo ? `<p style="margin: 0.5rem 0;"><strong>메모:</strong> ${client.memo}</p>` : ''}
            </div>
          </div>
          ` : ''}
        </div>
      `;
      
      openModal('viewModal');
    }
    
    function openCEOFocus(index) {
      const client = clients[index];
      const clientData = encryptData(client);
      const encoded = encodeURIComponent(clientData);
      window.open(`ceoFocus.html?client=${encoded}`, '_blank');
    }
    
    function openFM(index) {
      const client = clients[index];
      const clientData = encryptData(client);
      const encoded = encodeURIComponent(clientData);
      window.open(`financialMaster.html?client=${encoded}`, '_blank');
    }
    
    // ✅ 완전히 수정된 지도 함수
    async function openMapModal() {
      if (clients.length === 0) {
        alert('지도에 표시할 고객이 없습니다.');
        return;
      }
      
      const loading = document.getElementById('loading');
      loading.classList.remove('hide');
      loading.querySelector('.loading-text').textContent = '지도 로딩 중...';
      
      try {
        await loadKakaoMapAPI();
        openModal('mapModal');
        
        setTimeout(() => {
          initKakaoMap();
          loading.classList.add('hide');
        }, 300);
      } catch (error) {
        loading.classList.add('hide');
        alert(
          '⚠️ 카카오 지도를 불러올 수 없습니다.\n\n' +
          '원인:\n' +
          '1. 카카오 지도 API 키 문제\n' +
          '2. 네트워크 연결 오류\n' +
          '3. 브라우저 스크립트 차단\n\n' +
          '해결 방법:\n' +
          '1. 페이지 새로고침 (F5)\n' +
          '2. 네트워크 연결 확인\n' +
          '3. 브라우저 콘솔(F12)에서 오류 확인\n\n' +
          '※ 지도 기능 없이도 고객 관리는 가능합니다.'
        );
        console.error('지도 로드 오류:', error);
      }
    }
    
    // ✅ 완전히 수정된 카카오 지도 초기화
    function initKakaoMap() {
      if (typeof kakao === 'undefined' || !kakao.maps) {
        alert('카카오 지도 API를 불러오지 못했습니다.');
        return;
      }
      
      const container = document.getElementById('clientMap');
      const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 8
      };
      
      const map = new kakao.maps.Map(container, options);
      const bounds = new kakao.maps.LatLngBounds();
      let markerCount = 0;
      let noCoordCount = 0;
      
      // 좌표가 있는 고객들 먼저 표시
      clients.forEach((client, index) => {
        if (client.latitude && client.longitude) {
          const position = new kakao.maps.LatLng(client.latitude, client.longitude);
          
          // 마커 생성
          const marker = new kakao.maps.Marker({
            map: map,
            position: position,
            title: getFullName(client)
          });
          
          // 네비게이션 URL 생성
          const lat = client.latitude;
          const lng = client.longitude;
          const destName = encodeURIComponent(getFullName(client));
          const destAddress = encodeURIComponent(client.address);
          
          const kakaoNaviUrl = `kakaonavi://navigate?ep=${lng},${lat}&by=CAR`;
          const tmapUrl = `tmap://route?goalname=${destName}&goalx=${lng}&goaly=${lat}`;
          const naverMapUrl = `nmap://route/car?dlat=${lat}&dlng=${lng}&dname=${destName}&appname=고객관리`;
          
          // 인포윈도우 생성
          const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:15px;min-width:200px;font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',sans-serif;">
                        <div style="margin-bottom:10px;">
                          <strong style="font-size:15px;color:#0c2c54;">${getFullName(client)}</strong><br/>
                          <span style="font-size:12px;color:#666;">${client.company || '회사정보 없음'}</span><br/>
                          <span style="font-size:12px;color:#06b6d4;">${formatPhone(client.phone)}</span>
                        </div>
                        <div style="border-top:1px solid #e2e8f0;padding-top:10px;margin-top:10px;">
                          <div style="font-size:11px;color:#64748b;margin-bottom:5px;">🚗 길찾기</div>
                          <div style="display:flex;gap:5px;">
                            <a href="${kakaoNaviUrl}" style="flex:1;padding:6px 8px;background:#FEE500;color:#000;text-align:center;text-decoration:none;border-radius:4px;font-size:11px;font-weight:600;">카카오</a>
                            <a href="${tmapUrl}" style="flex:1;padding:6px 8px;background:#FF6B6B;color:#fff;text-align:center;text-decoration:none;border-radius:4px;font-size:11px;font-weight:600;">T맵</a>
                            <a href="${naverMapUrl}" style="flex:1;padding:6px 8px;background:#03C75A;color:#fff;text-align:center;text-decoration:none;border-radius:4px;font-size:11px;font-weight:600;">네이버</a>
                          </div>
                        </div>
                      </div>`,
            removable: true
          });
          
          // 마커 클릭 이벤트
          kakao.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
          });
          
          // 지도 범위에 좌표 추가
          bounds.extend(position);
          markerCount++;
          
          console.log(`✅ 마커 생성: ${client.name} (${client.latitude}, ${client.longitude})`);
        } else {
          noCoordCount++;
          console.log(`⚠️ 좌표 없음: ${client.name}`);
        }
      });
      
      // 마커가 있으면 지도 범위 조정
      if (markerCount > 0) {
        map.setBounds(bounds);
        console.log(`✅ 총 ${markerCount}개 마커 표시 완료`);
      }
      
      // 정보 표시
      const infoText = `✅ 지도에 표시됨: ${markerCount}명${noCoordCount > 0 ? ` | ⚠️ 좌표 없음: ${noCoordCount}명` : ''}`;
      document.getElementById('markerCount').textContent = infoText;
      
      if (noCoordCount > 0) {
        setTimeout(() => {
          if (confirm(`⚠️ ${noCoordCount}명의 고객이 좌표가 없어 지도에 표시되지 않습니다.\n\n해당 고객들을 수정하여 주소를 다시 입력하시겠습니까?`)) {
            closeModal('mapModal');
          }
        }, 1000);
      }
    }
    
    function exportToExcel() {
      if (clients.length === 0) {
        alert('내보낼 데이터가 없습니다.');
        return;
      }
      
      const data = clients.map(c => {
        const addressParts = c.address.split(' ');
        let baseAddress = '';
        let detailAddress = '';
        
        if (addressParts.length > 4) {
          detailAddress = addressParts.pop();
          baseAddress = addressParts.join(' ');
        } else {
          baseAddress = c.address;
        }
        
        return {
          '고객명': c.name,
          '직함': c.title || '',
          '호칭': c.honorific || '',
          '연락처': formatPhone(c.phone),
          '주소': baseAddress,
          '상세주소': detailAddress,
          '위도': c.latitude || '',
          '경도': c.longitude || '',
          '회사명': c.company || '',
          '직업': c.job || '',
          '생년월일': c.birthDate || '',
          '생일': c.birthday ? new Date(c.birthday).toLocaleDateString() : '',
          '양/음력': c.birthdayType === 'lunar' ? '음력' : '양력',
          '기념일명': c.anniversaryName || '',
          '기념일': c.anniversary ? new Date(c.anniversary).toLocaleDateString() : '',
          '이메일': c.email || '',
          '메모': c.memo || ''
        };
      });
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '고객목록');
      XLSX.writeFile(wb, `고객목록_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
    
    function openBulkUploadModal() {
      document.getElementById('spreadsheetContainer').style.display = 'none';
      openModal('bulkUploadModal');
    }
    
    function initSpreadsheet() {
      const container = document.getElementById('spreadsheetContainer');
      container.style.display = 'block';
      
      const tbody = document.getElementById('spreadsheetBody');
      tbody.innerHTML = '';
      
      for (let i = 0; i < 10; i++) {
        addSpreadsheetRow();
      }
    }
    
    function addSpreadsheetRow() {
      const tbody = document.getElementById('spreadsheetBody');
      const row = tbody.insertRow();
      
      const cells = [
        'text', 'text', 'text', 'text', 'text', 'text', 'text', 'text',
        'date', 'date', 'select', 'text', 'date', 'email', 'text'
      ];
      
      const placeholders = [
        '홍길동',
        '과장/팀장/대표 등',
        '님',
        '01012345678',
        '서울특별시 강남구 테헤란로 123',
        '아파트 101동 1001호',
        '(주)ABC',
        '대표이사',
        '',
        '',
        '',
        '결혼기념일',
        '',
        'example@email.com',
        '특이사항 메모'
      ];
      
      cells.forEach((type, i) => {
        const cell = row.insertCell();
        if (type === 'select') {
          cell.innerHTML = '<select><option value="solar">양력</option><option value="lunar">음력</option></select>';
        } else if (i === 2) {
          cell.innerHTML = '<input type="text" value="님" placeholder="님">';
        } else if (i === 3) {
          cell.innerHTML = `<input type="text" placeholder="${placeholders[i]}" inputmode="numeric">`;
        } else {
          cell.innerHTML = `<input type="${type}" placeholder="${placeholders[i] || ''}">`;
        }
      });
    }
    
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet);
        
        initSpreadsheet();
        const tbody = document.getElementById('spreadsheetBody');
        tbody.innerHTML = '';
        
        jsonData.forEach(row => {
          const tr = tbody.insertRow();
          
          let baseAddress = row['주소'] || '';
          let detailAddress = row['상세주소'] || '';
          
          if (!detailAddress && baseAddress) {
            const addressParts = baseAddress.split(' ');
            if (addressParts.length > 4) {
              detailAddress = addressParts.pop();
              baseAddress = addressParts.join(' ');
            }
          }
          
          const values = [
            row['고객명'] || '',
            row['직함'] || '',
            row['호칭'] || '님',
            row['연락처'] || '',
            baseAddress,
            detailAddress,
            row['회사명'] || '',
            row['직업'] || '',
            row['생년월일'] || '',
            row['생일'] || '',
            row['양/음력'] || 'solar',
            row['기념일명'] || '',
            row['기념일'] || '',
            row['이메일'] || '',
            row['메모'] || ''
          ];
          
          values.forEach((value, i) => {
            const td = tr.insertCell();
            if (i === 10) {
              td.innerHTML = `<select><option value="solar" ${value === '양력' || value === 'solar' ? 'selected' : ''}>양력</option><option value="lunar" ${value === '음력' || value === 'lunar' ? 'selected' : ''}>음력</option></select>`;
            } else if (i === 8 || i === 9 || i === 12) {
              td.innerHTML = `<input type="date" value="${value}">`;
            } else if (i === 13) {
              td.innerHTML = `<input type="email" value="${value}">`;
            } else if (i === 3) {
              td.innerHTML = `<input type="text" value="${value}" placeholder="'-' 빼고 숫자만 입력" inputmode="numeric">`;
            } else {
              td.innerHTML = `<input type="text" value="${value}" ${i === 4 ? 'placeholder="도로명주소"' : i === 5 ? 'placeholder="동/호수 등"' : ''}>`;
            }
          });
        });
        
        alert(`${jsonData.length}행의 데이터를 불러왔습니다.\n\n주소와 상세주소가 올바르게 분리되었는지 확인해주세요.`);
      };
      reader.readAsArrayBuffer(file);
    }
    
    async function saveBulkClients() {
      const tbody = document.getElementById('spreadsheetBody');
      const rows = tbody.querySelectorAll('tr');
      let added = 0;
      let failed = [];
      let skipped = 0;
      let noCoordinates = 0;
      
      const loading = document.getElementById('loading');
      loading.classList.remove('hide');
      loading.querySelector('.loading-text').textContent = '고객 데이터 저장 중...';
      
      let mapApiAvailable = true;
      try {
        if (!kakaoMapLoaded) {
          loading.querySelector('.loading-text').textContent = '카카오 지도 API 로딩 중...';
          await loadKakaoMapAPI();
        }
      } catch (error) {
        console.error('카카오 지도 API 로드 실패:', error);
        mapApiAvailable = false;
        
        const proceed = confirm(
          '⚠️ 카카오 지도 API를 사용할 수 없습니다.\n\n' +
          '좌표 없이 고객 데이터만 저장됩니다.\n' +
          '(나중에 개별 수정으로 좌표 추가 가능)\n\n' +
          '계속 진행하시겠습니까?'
        );
        
        if (!proceed) {
          loading.classList.add('hide');
          return;
        }
      }
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const inputs = row.querySelectorAll('input, select');
        const name = inputs[0].value.trim();
        const title = inputs[1].value.trim();
        const honorific = inputs[2].value.trim();
        const phone = inputs[3].value.trim().replace(/\D/g, '');
        let address = inputs[4].value.trim();
        let detailAddress = inputs[5].value.trim();
        
        if (!name && !phone && !address) {
          skipped++;
          continue;
        }
        
        if (name && phone && address && detailAddress) {
          const fullAddress = `${address} ${detailAddress}`;
          
          let coordinates = { latitude: null, longitude: null };
          
          if (mapApiAvailable) {
            loading.querySelector('.loading-text').textContent = `${added + 1}번째 고객 "${name}" 좌표 변환 중...`;
            console.log(`\n=== ${i + 1}행: ${name} ===`);
            console.log('기본주소:', address);
            console.log('상세주소:', detailAddress);
            console.log('전체주소:', fullAddress);
            
            coordinates = await getCoordinates(address);
            
            if (!coordinates.latitude || !coordinates.longitude) {
              noCoordinates++;
              failed.push({
                row: i + 1,
                name: name,
                address: address
              });
            }
          } else {
            noCoordinates++;
          }
          
          clients.push({
            name,
            title,
            honorific,
            phone,
            address: fullAddress,
            postcode: '',
            latitude: coordinates.latitude,
            longitude: coordinates.longitude,
            company: inputs[6].value.trim(),
            job: inputs[7].value.trim(),
            birthDate: inputs[8].value.trim(),
            birthday: inputs[9].value.trim(),
            birthdayType: inputs[10].value,
            anniversaryName: inputs[11].value.trim(),
            anniversary: inputs[12].value.trim(),
            email: inputs[13].value.trim(),
            memo: inputs[14].value.trim(),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
          added++;
        } else if (name || phone || address) {
          failed.push({
            row: i + 1,
            name: name || '(이름없음)',
            address: address || '(주소없음)',
            reason: '필수 항목 누락'
          });
        }
      }
      
      if (added > 0) {
        await saveClients();
        loading.classList.add('hide');
        closeModal('bulkUploadModal');
        
        let message = `✅ ${added}명의 고객이 추가되었습니다!`;
        
        if (skipped > 0) {
          message += `\n\n빈 행 ${skipped}개 건너뜀`;
        }
        
        if (!mapApiAvailable) {
          message += `\n\n⚠️ 카카오 지도 API 사용 불가\n→ 모든 고객이 좌표 없이 저장되었습니다.\n→ 개별 수정으로 좌표 추가 가능`;
        } else if (noCoordinates > 0) {
          message += `\n\n⚠️ 좌표 미등록: ${noCoordinates}명`;
          if (failed.length > 0) {
            message += `\n\n좌표 변환 실패 목록:\n`;
            failed.slice(0, 3).forEach(f => {
              if (!f.reason) {
                message += `\n${f.row}행: ${f.name}\n  주소: ${f.address}`;
              }
            });
            
            if (failed.length > 3) {
              message += `\n... 외 ${failed.length - 3}건`;
            }
          }
        }
        
        if (failed.some(f => f.reason)) {
          const reasonFailed = failed.filter(f => f.reason);
          message += `\n\n❌ 저장 실패: ${reasonFailed.length}건\n`;
          reasonFailed.slice(0, 3).forEach(f => {
            message += `\n${f.row}행: ${f.name} - ${f.reason}`;
          });
        }
        
        message += `\n\n💡 주소: 서울시 강남구 테헤란로 20길 27 ✅\n💡 상세주소: 101동 1001호`;
        
        alert(message);
      } else {
        loading.classList.add('hide');
        alert('저장할 데이터가 없습니다.\n\n필수 항목을 확인해주세요:\n- 고객명\n- 연락처\n- 주소\n- 상세주소');
      }
    }
    
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#clientsTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
      });
    });
    
    document.getElementById('phone1').addEventListener('input', function(e) {
      this.value = this.value.replace(/\D/g, '');
    });
    
    document.getElementById('phone2').addEventListener('input', function(e) {
      this.value = this.value.replace(/\D/g, '');
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('paste', function(e) {
        const activeElement = document.activeElement;
        if (activeElement && activeElement.closest('.spreadsheet')) {
          e.preventDefault();
          
          const clipboardData = e.clipboardData.getData('text');
          const rows = clipboardData.split('\n').map(row => row.split('\t'));
          
          let currentCell = activeElement.closest('td');
          if (!currentCell) return;
          
          const table = currentCell.closest('tbody');
          let rowIndex = currentCell.parentElement.rowIndex - 1;
          let cellIndex = currentCell.cellIndex;
          
          rows.forEach((rowData, i) => {
            let row = table.rows[rowIndex + i];
            if (!row) {
              addSpreadsheetRow();
              row = table.rows[rowIndex + i];
            }
            
            rowData.forEach((cellData, j) => {
              const cell = row.cells[cellIndex + j];
              if (cell) {
                const input = cell.querySelector('input, select');
                if (input) {
                  input.value = cellData.trim();
                }
              }
            });
          });
        }
      });
    });
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    window.addEventListener('load', function() {
      document.getElementById('searchInput').addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#clientsTableBody tr');
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });
      });
      
      document.getElementById('phone1').addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '');
      });
      
      document.getElementById('phone2').addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '');
      });
    });
  </script>
</body>
</html>