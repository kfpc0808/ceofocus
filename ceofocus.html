<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Consulting Solution - ì „ë¬¸ê°€íŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

:root {
    --bg-color: #f0f2f5;
    --card-bg: #ffffff;
    --primary-navy: #0c2c54;
    --secondary-blue: #2a5a8a;
    --accent-gold: #c5a05b;
    --text-primary: #212529;
    --text-secondary: #5a6169;
    --border-color: #dee2e6;
    --success-color: #1e8449;
    --warning-color: #d68910;
    --danger-color: #b03a2e;
    --opportunity-color: #2980b9;
    --info-color: #3498db;
}

/* âœ… ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
* { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
}

html {
    overflow-x: hidden;
    width: 100%;
}

body { 
    font-family: 'Noto Sans KR', sans-serif; 
    background-color: var(--bg-color); 
    color: var(--text-primary); 
    line-height: 1.6;
    overflow-x: hidden;
    width: 100%;
    margin: 0;
    padding: 0;
}

.container { 
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    overflow-x: hidden;
}

/* Progress Bar */
.progress-container { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 4px; 
    background: rgba(0,0,0,0.1); 
    z-index: 1000; 
}
.progress-bar { 
    height: 100%; 
    background: linear-gradient(90deg, var(--primary-navy), var(--accent-gold)); 
    width: 0%; 
    transition: width 0.3s ease; 
}

.save-status { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    background: var(--success-color); 
    color: white; 
    padding: 0.5rem 1rem; 
    border-radius: 20px; 
    font-size: 0.9rem; 
    z-index: 1000; 
    opacity: 0; 
    transition: opacity 0.3s ease; 
}
.save-status.show { opacity: 1; }
.save-status.saving { background: var(--warning-color); }
.save-status.danger { background: var(--danger-color); }

/* Header */
header { 
    text-align: center; 
    margin-bottom: 1.5rem; 
}
.header-content { 
    background: linear-gradient(135deg, var(--primary-navy), var(--secondary-blue)); 
    color: white; 
    padding: 1.5rem 1rem; 
    border-radius: 12px; 
    box-shadow: 0 8px 24px rgba(12, 44, 84, 0.15); 
}
header h1 { 
    font-size: 1.8rem; 
    font-weight: 700; 
    letter-spacing: -0.5px; 
    margin: 0 0 0.3rem 0; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    flex-wrap: wrap; 
}
header h1 i { 
    margin-right: 0.75rem; 
    color: var(--accent-gold); 
}
header .producer { 
    font-size: 0.85rem; 
    font-weight: 400; 
    opacity: 0.85; 
    margin: 0; 
}

/* Toolbar */
.toolbar { 
    background: white; 
    padding: 0.75rem 1rem; 
    border-radius: 10px; 
    margin-bottom: 1rem; 
    box-shadow: 0 3px 12px rgba(0,0,0,0.08); 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    flex-wrap: wrap; 
    gap: 0.75rem; 
}
.toolbar-left { 
    display: flex; 
    align-items: center; 
    gap: 0.75rem; 
    font-size: 0.9rem; 
}
.toolbar-right { 
    display: flex; 
    gap: 0.5rem; 
    flex-wrap: wrap; 
}
.btn { 
    background: var(--primary-navy); 
    color: white; 
    border: none; 
    padding: 0.5rem 1rem; 
    border-radius: 6px; 
    font-size: 0.85rem; 
    font-weight: 500; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    display: inline-flex; 
    align-items: center; 
    gap: 0.4rem; 
    white-space: nowrap;
}
.btn:hover { 
    background: var(--secondary-blue); 
    transform: translateY(-1px); 
}
.btn.success { background: var(--success-color); }
.btn.warning { background: var(--warning-color); }
.btn.info { background: var(--info-color); }
.btn.danger { background: var(--danger-color); }
.btn.small { padding: 0.35rem 0.7rem; font-size: 0.8rem; }

/* âœ… Mobile Tabs - ê¸°ë³¸ ìˆ¨ê¹€ */
.mobile-tabs { 
    display: none;
    background: white; 
    padding: 0.4rem; 
    border-radius: 10px; 
    margin-bottom: 1rem; 
    box-shadow: 0 3px 12px rgba(0,0,0,0.08); 
}
.mobile-tabs button { 
    flex: 1; 
    padding: 0.7rem; 
    border: none; 
    background: transparent; 
    color: var(--text-secondary); 
    font-weight: 500; 
    cursor: pointer; 
    border-radius: 6px; 
    transition: all 0.2s; 
    font-size: 0.9rem;
}
.mobile-tabs button.active { 
    background: var(--primary-navy); 
    color: white; 
}

/* âœ… Main Grid - ê¸°ë³¸ 2ë‹¨ */
.main-grid { 
    display: grid; 
    grid-template-columns: 42% 58%; 
    gap: 1.5rem; 
    align-items: start;
}

/* âœ… í•µì‹¬: ì™¼í¸ ì˜ì—­ - ìŠ¤í¬ë¡¤ ìë™ ì²˜ë¦¬ */
.input-section { 
    height: auto;
    max-height: none;
    overflow-y: visible;
    overflow-x: hidden;
    position: relative;
    padding-right: 0.5rem;
}

/* âœ… í•µì‹¬: ì˜¤ë¥¸í¸ ì˜ì—­ */
.analysis-section { 
    height: auto;
    min-height: 100vh;
}

/* Card */
.card { 
    background: var(--card-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 12px; 
    padding: 1.5rem; 
    box-shadow: 0 4px 16px rgba(12, 44, 84, 0.06); 
    margin-bottom: 1.5rem; 
}
.card h2 { 
    font-size: 1.3rem; 
    font-weight: 700; 
    color: var(--primary-navy); 
    margin-top: 0; 
    margin-bottom: 1.25rem; 
    padding-bottom: 0.75rem; 
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    align-items: center; 
}
.card h2 i { 
    margin-right: 0.6rem; 
    color: var(--secondary-blue); 
}

/* Identity Section */
.identity-section { 
    background: linear-gradient(135deg, var(--accent-gold), #d4a574); 
    color: white; 
    padding: 1.25rem; 
    border-radius: 10px; 
    margin-bottom: 1.25rem; 
}
.identity-section h3 { 
    margin: 0 0 1rem 0; 
    font-size: 1.15rem; 
    font-weight: 700; 
    display: flex; 
    align-items: center; 
}
.identity-section h3 i { margin-right: 0.6rem; }
.identity-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 1rem; 
}

/* Input Groups */
.input-group { margin-bottom: 0.85rem; }
.input-group label { 
    display: block; 
    font-weight: 500; 
    margin-bottom: 0.4rem; 
    font-size: 0.9rem; 
    color: var(--text-secondary); 
}
.input-group.identity label { 
    color: white; 
    font-weight: 600; 
}
.input-field { display: flex; align-items: center; }
.input-field input, .input-field select, .input-field textarea { 
    width: 100%; 
    padding: 0.65rem 0.85rem; 
    border: 1px solid #ced4da; 
    border-radius: 6px; 
    font-size: 0.95rem; 
    font-weight: 500; 
    transition: border-color 0.2s ease; 
    font-family: 'Noto Sans KR', sans-serif; 
}
.input-field textarea { 
    min-height: 70px; 
    resize: vertical; 
}
.input-field input:focus, .input-field select:focus, .input-field textarea:focus { 
    outline: none; 
    border-color: var(--primary-navy); 
    box-shadow: 0 0 0 3px rgba(12, 44, 84, 0.1); 
}
.input-field input[type="text"]:not(.no-align-right),
.input-field input[inputmode="numeric"] { 
    text-align: right; 
}
.input-field span { 
    margin-left: 0.6rem; 
    font-weight: 500; 
    color: var(--text-secondary); 
    white-space: nowrap; 
}
.input-field .check-icon { 
    margin-left: 0.4rem; 
    color: var(--success-color); 
    opacity: 0; 
    transition: opacity 0.2s ease; 
}
.input-field .check-icon.show { opacity: 1; }

/* Info Icon & Tooltip */
.info-icon { 
    margin-left: 0.4rem; 
    color: var(--info-color); 
    cursor: help; 
    font-size: 0.85rem; 
}
.tooltip-container { 
    position: relative; 
    display: inline-block; 
}
.tooltip-text { 
    visibility: hidden; 
    width: 280px; 
    background-color: rgba(0,0,0,0.9); 
    color: white; 
    text-align: left; 
    border-radius: 6px; 
    padding: 0.85rem; 
    position: absolute; 
    z-index: 1000; 
    bottom: 125%; 
    left: 50%; 
    margin-left: -140px; 
    opacity: 0; 
    transition: opacity 0.2s; 
    font-size: 0.85rem; 
    line-height: 1.5; 
    box-shadow: 0 4px 16px rgba(0,0,0,0.3); 
}
.tooltip-text::after { 
    content: ""; 
    position: absolute; 
    top: 100%; 
    left: 50%; 
    margin-left: -5px; 
    border-width: 5px; 
    border-style: solid; 
    border-color: rgba(0,0,0,0.9) transparent transparent transparent; 
}
.tooltip-container:hover .tooltip-text { 
    visibility: visible; 
    opacity: 1; 
}

/* Stock Price Display */
.stock-price-display { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: white !important; 
    padding: 0.85rem; 
    border-radius: 8px; 
    margin: 0.85rem 0; 
    text-align: center; 
}
.stock-price-display * { color: white !important; }
.stock-price-display h4 { 
    margin: 0 0 0.4rem 0; 
    font-size: 0.85rem; 
    opacity: 0.9; 
}
.stock-price-display .price { 
    font-size: 1.6rem; 
    font-weight: 700; 
    color: #f1c40f !important; 
}

/* Input Divider */
h4.input-divider { 
    color: var(--primary-navy); 
    font-weight: 700; 
    margin: 1.75rem 0 1rem 0; 
    padding-bottom: 0.4rem; 
    border-bottom: 2px solid var(--accent-gold); 
    font-size: 1.05rem;
}

/* Dynamic Container */
.dynamic-container { 
    border: 1px solid var(--border-color); 
    padding: 0.85rem; 
    border-radius: 6px; 
    margin-bottom: 0.85rem; 
    background: #f8f9fa; 
    position: relative; 
}
.dynamic-item { 
    display: grid; 
    grid-template-columns: 2fr 1fr 1fr auto; 
    gap: 0.85rem; 
    align-items: end; 
    margin-bottom: 0.6rem; 
}
.dynamic-item:last-child { margin-bottom: 0; }
.btn-add { margin-top: 0.4rem; }
.btn-remove { 
    position: absolute; 
    top: 0.4rem; 
    right: 0.4rem; 
}

/* Score Dashboard */
.score-dashboard { 
    display: grid; 
    grid-template-columns: repeat(5, 1fr); 
    gap: 1rem; 
    margin: 1.5rem 0; 
}
.score-card { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: white; 
    padding: 1.25rem; 
    border-radius: 10px; 
    text-align: center; 
    box-shadow: 0 4px 16px rgba(0,0,0,0.1); 
}
.score-card.financial { background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%); }
.score-card.tax { background: linear-gradient(135deg, #d68910 0%, #e59400 100%); }
.score-card.inheritance { background: linear-gradient(135deg, #b03a2e 0%, #cb4335 100%); }
.score-card.succession { background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); }
.score-card.retirement { background: linear-gradient(135deg, #1e8449 0%, #27ae60 100%); }
.score-card h3 { 
    margin: 0 0 0.4rem 0; 
    font-size: 0.9rem; 
    font-weight: 500; 
    opacity: 0.9; 
}
.score-value { 
    font-size: 2.2rem; 
    font-weight: 700; 
    margin: 0.4rem 0; 
}
.score-grade { 
    font-size: 1rem; 
    font-weight: 600; 
    opacity: 0.95; 
}

/* Result Grid */
.result-grid { 
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 1rem; 
}
.result-box { 
    padding: 1rem; 
    border-radius: 10px; 
    text-align: center; 
    background: #fdfdff; 
    border: 1px solid var(--border-color); 
    display: flex; 
    flex-direction: column; 
    justify-content: space-between; 
    transition: transform 0.2s ease; 
}
.result-box:hover { transform: translateY(-2px); }
.result-box h3 { 
    margin: 0 0 0.4rem 0; 
    font-size: 0.95rem; 
    font-weight: 500; 
    color: var(--text-secondary); 
}
.result-value { 
    font-size: 1.6rem; 
    font-weight: 700; 
    margin-bottom: 0.4rem; 
    color: var(--primary-navy); 
    flex-grow: 1; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
}
.result-status { 
    font-size: 0.9rem; 
    font-weight: bold; 
    padding: 0.25rem 0.85rem; 
    border-radius: 16px; 
    color: white; 
}
.status-safe { background-color: var(--success-color); }
.status-good { background-color: #27ae60; }
.status-warning { background-color: var(--warning-color); }
.status-danger { background-color: var(--danger-color); }
.status-info { background-color: var(--info-color); }

/* Chart Container */
.chart-container { 
    min-height: 300px; 
    margin: 1.5rem 0; 
    background: white; 
    border-radius: 10px; 
    padding: 1.25rem; 
    box-shadow: 0 3px 12px rgba(0,0,0,0.05); 
}
.chart-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 1.5rem; 
    margin: 1.5rem 0; 
}
.chart-grid .chart-container { 
    height: 280px; 
    margin: 0; 
}
.chart-toggle { 
    margin-bottom: 0.85rem; 
    text-align: center; 
}

/* Consulting Topic */
.consulting-topic { 
    margin-bottom: 1.75rem; 
    padding: 1.5rem; 
    border-radius: 12px; 
    border-left: 6px solid; 
    background-color: var(--card-bg); 
    box-shadow: 0 3px 12px rgba(0,0,0,0.05); 
}
.consulting-topic:last-child { margin-bottom: 0; }
.topic-danger { border-color: var(--danger-color); }
.topic-warning { border-color: var(--warning-color); }
.topic-good { border-color: var(--success-color); }
.topic-opportunity { border-color: var(--opportunity-color); }
.topic-info { border-color: var(--info-color); }
.consulting-topic > h3 { 
    font-size: 1.3rem; 
    font-weight: 700; 
    margin:0 0 1.25rem 0; 
    display: flex; 
    align-items: center; 
}
.consulting-topic h3 i { margin-right: 0.7rem; }
.consulting-topic h3.danger { color: var(--danger-color); }
.consulting-topic h3.warning { color: var(--warning-color); }
.consulting-topic h3.good { color: var(--success-color); }
.consulting-topic h3.opportunity { color: var(--opportunity-color); }
.consulting-topic h3.info { color: var(--info-color); }
.consulting-topic h3 .topic-value { 
    color: var(--text-secondary); 
    font-weight: 500; 
    margin-left: 6px;
}
.consulting-section { 
    margin-top: 1.25rem; 
    border-top: 1px solid var(--border-color); 
    padding-top: 1.25rem; 
}
.consulting-section h4 { 
    display: flex; 
    align-items: center; 
    font-size: 1.1rem; 
    font-weight: 600; 
    color: var(--secondary-blue); 
    margin: 0 0 0.85rem 0; 
}
.consulting-section h4 i { margin-right: 0.4rem; }
.consulting-section ul { 
    list-style-type: none; 
    padding-left: 0; 
    margin: 0; 
}
.consulting-section li { 
    position: relative; 
    padding-left: 1.5rem; 
    margin-bottom: 0.4rem; 
    font-size: 1rem; 
}
.consulting-section li::before { 
    content: 'â€¢'; 
    position: absolute; 
    left: 0.25rem; 
    font-weight: bold; 
    color: var(--secondary-blue); 
    font-size: 1.3rem; 
    line-height: 1; 
    top: 0.15rem; 
}
.consulting-section li strong { 
    font-weight: 600; 
    color: #2c3e50; 
}

/* Calc Box */
.calc-box { 
    background: #f8f9fa; 
    border-left: 4px solid var(--info-color); 
    padding: 0.85rem; 
    margin: 0.85rem 0; 
    border-radius: 4px; 
    font-family: 'Courier New', monospace; 
    font-size: 0.9rem; 
}
.calc-box .calc-line { margin: 0.25rem 0; }
.calc-box .calc-result { 
    font-weight: 700; 
    color: var(--danger-color); 
    margin-top: 0.4rem; 
    padding-top: 0.4rem; 
    border-top: 1px solid #dee2e6; 
}

/* Proposal Table */
.proposal-table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 0.85rem; 
}
.proposal-table th, .proposal-table td { 
    border: 1px solid var(--border-color); 
    padding: 0.7rem; 
}
.proposal-table th { 
    background-color: #f8f9fa; 
    font-weight: 600; 
    text-align: center; 
}
.proposal-table td { 
    font-weight: 500; 
    text-align: right; 
}
.proposal-table .text-left { text-align: left !important; }
.proposal-table .highlight { 
    color: var(--danger-color); 
    font-weight: 700; 
}

/* Action Box */
.action-box { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: white; 
    padding: 1.25rem; 
    border-radius: 10px; 
    margin: 1.25rem 0; 
}
.action-box h5 { 
    margin: 0 0 0.85rem 0; 
    font-size: 1.1rem; 
}
.action-box ul { 
    margin: 0; 
    padding-left: 1.25rem; 
}
.action-box li { margin: 0.4rem 0; }

/* Consultant Summary */
#consultant_summary { 
    padding: 1.75rem; 
    background: linear-gradient(135deg, var(--primary-navy), var(--secondary-blue)); 
    color: white; 
    border-radius: 12px; 
}
#consultant_summary h2 { 
    color: var(--accent-gold); 
    border-bottom-color: rgba(255,255,255,0.3); 
}
#consultant_summary h2 i { color: var(--accent-gold); }
#consultant_summary p { 
    font-size: 1.05rem; 
    margin-bottom: 1.25rem; 
    line-height: 1.8; 
}
#consultant_summary .summary-point { 
    font-weight: 700; 
    color: #f1c40f; 
    background-color: rgba(255,255,255,0.1); 
    padding: 0.15rem 0.5rem; 
    border-radius: 4px; 
}

/* Footer */
footer { 
    margin-top: 3rem; 
    padding-top: 1.5rem; 
    border-top: 1px solid var(--border-color);
}
.disclaimer { 
    font-size: 0.85rem; 
    color: #6c757d; 
    background-color: #e9ecef; 
    padding: 1.5rem; 
    border-radius: 8px; 
    max-width: 900px; 
    margin: 0.85rem auto; 
    text-align: center; 
}
.disclaimer h3 { 
    margin: 0 0 0.85rem 0; 
    font-size: 1rem; 
    color: var(--text-primary); 
}
.disclaimer p { 
    margin: 0; 
    line-height: 1.6; 
}
.copyright { 
    text-align: center; 
    font-size: 0.85rem; 
    color: #6c757d; 
}

.file-input { display: none; }

.keyboard-help { 
    position: fixed; 
    bottom: 20px; 
    left: 20px; 
    background: rgba(0,0,0,0.8); 
    color: white; 
    padding: 0.85rem; 
    border-radius: 6px; 
    font-size: 0.8rem; 
    opacity: 0; 
    transition: opacity 0.2s ease; 
    z-index: 1000; 
}
.keyboard-help.show { opacity: 1; }

/* Memo Area */
#consultant-memo {
    width: 100%;
    min-height: 110px;
    padding: 1rem;
    border: 1px solid #ced4da;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
}
#consultant-memo:focus {
    outline: none;
    border-color: #2a5a8a;
    box-shadow: 0 0 0 3px rgba(42, 90, 138, 0.2);
}

/* ğŸ“± ===== ë°˜ì‘í˜• ë¯¸ë””ì–´ì¿¼ë¦¬ ===== */

/* âœ… 1. ëª¨ë°”ì¼ ì„¸ë¡œ (â‰¤ 640px Portrait) */
@media (max-width: 640px) and (orientation: portrait) {
    body { padding: 0; }
    
    .container { 
        padding: 0.75rem; 
    }
    
    /* íƒ­ í™œì„±í™” */
    .mobile-tabs { 
        display: flex; 
        position: sticky; 
        top: 0; 
        z-index: 100; 
    }
    
    /* 1ë‹¨ ë ˆì´ì•„ì›ƒ + íƒ­ ì „í™˜ */
    .main-grid { 
        display: block !important; 
    }
    
    .input-section, .analysis-section { 
        display: none; 
        width: 100%;
        height: auto;
        max-height: none;
        overflow-y: visible;
        position: relative;
        padding-right: 0;
    }
    
    .input-section.active, .analysis-section.active { 
        display: block; 
    }
    
    /* ì¶•ì†Œ */
    .header-content { padding: 1.25rem 0.85rem; }
    header h1 { 
        font-size: 1.5rem; 
        flex-direction: column; 
    }
    header h1 i { 
        margin-right: 0; 
        margin-bottom: 0.4rem; 
    }
    
    .card { padding: 1rem; }
    .card h2 { font-size: 1.1rem; }
    
    .result-grid { grid-template-columns: 1fr; gap: 0.6rem; }
    .score-dashboard { grid-template-columns: 1fr; gap: 0.85rem; }
    .chart-grid { grid-template-columns: 1fr; }
    .identity-grid { grid-template-columns: 1fr; gap: 0.85rem; }
    
    .toolbar { 
        flex-direction: column; 
        padding: 0.6rem; 
    }
    
    .chart-container { height: 220px; padding: 0.6rem; }
    .chart-grid .chart-container { height: 180px; }
    
    .dynamic-item { 
        grid-template-columns: 1fr; 
        gap: 0.4rem; 
    }
    
    .input-field input, .input-field select, .input-field textarea { 
        font-size: 16px !important; 
    }
    
    h4.input-divider { font-size: 0.95rem; }
    
    .consulting-topic { padding: 0.85rem; }
    .consulting-topic > h3 { font-size: 1.1rem; }
    
    .btn { padding: 0.45rem 0.85rem; font-size: 0.8rem; }
    
    #consultant-memo { 
        min-height: 100px !important; 
        font-size: 0.95rem !important; 
    }
}
/* âœ… 2. íƒœë¸”ë¦¿ ì„¸ë¡œ (641px ~ 900px Portrait) - ì™„ì „ ìµœì¢…íŒ */
@media (min-width: 641px) and (max-width: 900px) and (orientation: portrait) {
    body { padding: 0; }
    
    .container { 
        padding: 1rem; 
        max-width: 100%;
    }
    
    .mobile-tabs { 
        display: none !important; 
    }
    
    .main-grid {
        display: grid !important;
        grid-template-columns: 45% 55%;
        gap: 1rem;
    }
    
    .input-section {
        display: block !important;
        height: auto;
        max-height: none;
        overflow-y: visible;
        position: relative;
        padding-right: 0.5rem;
    }
    
    .analysis-section { 
        display: block !important;
        height: auto;
    }
    
    header h1 { font-size: 1.6rem; }
    
    .card { 
        padding: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .card h2 {
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }
    
    /* Identity Grid */
    .identity-section {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
@media (min-width:641px) and (max-width:900px) and (orientation:portrait){
  /* Tablet Portrait - êµì²´ */
  .identity-grid{
    grid-template-columns: 1fr 1fr !important;
    column-gap: .5rem !important;
    row-gap: .6rem !important;
  }
  .identity-grid .input-group{ margin-bottom: 0 !important; }
  .identity-grid .input-group label{
    margin-bottom: .2rem !important;
    font-size: .88rem !important;
    line-height: 1.2 !important;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .identity-grid .input-field{ min-width: 0; }
  .identity-grid .input-field input,
  .identity-grid .input-field select,
  .identity-grid .input-field textarea{
    padding: .55rem .6rem !important;
    font-size: .92rem !important;
    min-height: 44px !important;
    width: 100%;
  }
}
    
    .identity-grid .input-group {
        margin-bottom: 0;
    }
    
    .identity-grid .input-group label {
        margin-bottom: 0.3rem;
        font-size: 0.9rem;
    }
    
    .identity-grid .input-field {
        width: 100%;
    }
    
    .identity-grid .input-field input,
    .identity-grid .input-field select {
        min-width: 0;
        width: 100%;
    }
    
    .identity-grid select,
    .identity-grid input[type="date"] {
        font-size: 0.9rem;
        padding: 0.65rem 0.4rem;
        text-align: left;
    }
    
    .identity-grid input[type="text"] {
        font-size: 0.9rem;
        padding: 0.65rem 0.6rem;
    }
    
    /* ë™ì  ì»¨í…Œì´ë„ˆ ê³µí†µ */
    .dynamic-container {
        position: relative;
        border: 1px solid var(--border-color);
        padding: 2.5rem 0.8rem 0.8rem 0.8rem;
        border-radius: 6px;
        margin-bottom: 0.8rem;
        background: #f8f9fa;
    }
    
    .btn-remove {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
        z-index: 10;
    }
    
    /* ğŸ‘‡ ìë…€ ì •ë³´ ì „ìš© */
    #children-container .dynamic-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;  /* ì´ë¦„ ë„“ê²Œ */
        gap: 0.6rem;
        align-items: end;
        margin-bottom: 0;
    }
    
    /* ğŸ‘‡ íŠ¹ìˆ˜ê´€ê³„ì¸ ì „ìš© */
    #shareholders-container .dynamic-item {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1fr;  /* ì´ë¦„ ì ë‹¹íˆ */
        gap: 0.6rem;
        align-items: end;
        margin-bottom: 0;
    }
    
    /* ë™ì  í•­ëª© ê³µí†µ ìŠ¤íƒ€ì¼ */
    .dynamic-item .input-group {
        margin-bottom: 0;
    }
    
    .dynamic-item .input-group label {
        margin-bottom: 0.3rem;
        font-size: 0.85rem;
        display: block;
    }
    @media (min-width:641px) and (max-width:900px) and (orientation:portrait){
  /* ìë…€ ì •ë³´: ì´ë¦„/ì„±ë³„/ë‚˜ì´/ì‚­ì œ = 4ì¹¸ */
  #children-container .dynamic-item{
    display:grid;
    grid-template-columns: 2fr 1fr 1fr auto !important;
    gap:.6rem !important;
    align-items:end !important;
    margin-bottom:.6rem !important;
  }

  /* íŠ¹ìˆ˜ê´€ê³„ì¸: ì´ë¦„/ê´€ê³„/ì§€ë¶„ìœ¨/ì‚­ì œ = 4ì¹¸ */
  #shareholders-container .dynamic-item{
    display:grid;
    grid-template-columns: 1.5fr 1fr 1fr auto !important;
    gap:.6rem !important;
    align-items:end !important;
    margin-bottom:.6rem !important;
  }

  /* ì‚­ì œ ë²„íŠ¼: ê²¹ì¹˜ì§€ ì•Šê²Œ ì˜¤ë¥¸ìª½ ì¹¼ëŸ¼ */
  .dynamic-item .btn-remove{
    position: static !important;
    align-self: end;
    height: 44px;
    padding: .4rem .6rem;
    font-size: .95rem;
    line-height: 1;
    border-radius: .5rem;
  }

  /* ì…ë ¥ì°½ ë†’ì´ í†µì¼ */
  .dynamic-item input[type="text"],
  .dynamic-item input[type="number"],
  .dynamic-item select{
    min-height: 44px !important;
    height: 44px !important;
    padding: .55rem .5rem !important;
    font-size: .92rem !important;
    width: 100%;
  }
}
@media (min-width:641px) and (max-width:900px) and (orientation:portrait){
  /* === [ë¶„ì„ íŒ¨ë„ ì»´íŒ©íŠ¸ ë¦¬ë””ìì¸] === */

  /* ì¹´ë“œ íŒ¨ë”© ì¶•ì†Œ */
  .analysis-section .card{
    padding: 1rem !important;
  }

  /* ì ìˆ˜ ëŒ€ì‹œë³´ë“œ: ë” ì´˜ì´˜í•˜ê²Œ, ì‘ì€ í­ì—ì„œë„ ìë™ ì¤„ë°”ê¿ˆ */
  .score-dashboard{
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important;
    gap: .7rem !important;
    margin: .9rem 0 !important;
  }
  .score-card{
    padding: .85rem !important;
    min-height: 104px !important;
    border-radius: 12px;
  }
  .score-card h3{
    font-size: .8rem !important;
    margin: 0 0 .25rem !important;
    line-height: 1.25;
  }
  .score-value{
    font-size: 1.6rem !important;
    margin: .2rem 0 !important;
    font-weight: 700;
  }
  .score-grade{ font-size: .85rem !important; }

  /* ì¢…í•© ì§„ë‹¨(ì§€í‘œ) ë°•ìŠ¤: 2ì—´ë¡œ, ë†’ì´ ì¶•ì†Œ */
  .result-grid{
    grid-template-columns: 1fr 1fr !important;
    gap: .7rem !important;
  }
  .result-box{
    padding: .8rem !important;
    min-height: 92px !important;
  }
  .result-box h3{
    font-size: .82rem !important;
    margin: 0 0 .2rem !important;
  }
  .result-value{
    font-size: 1.25rem !important;
    font-weight: 600;
  }

  /* ì°¨íŠ¸: í•œ ì—´ë¡œ ìŒ“ê³  ë†’ì´ ì¶•ì†Œ */
  .chart-grid{
    grid-template-columns: 1fr !important;
    gap: .8rem !important;
  }
  .chart-container{
    min-height: 200px !important;
    height: 200px !important;
    padding: .85rem !important;
  }
}
    .dynamic-item input[type="text"],
    .dynamic-item input[type="number"],
    .dynamic-item select {
        width: 100%;
        padding: 0.65rem 0.5rem;
        font-size: 0.9rem;
        border: 1px solid #ced4da;
        border-radius: 6px;
        min-height: 42px;
        box-sizing: border-box;
    }
    
    .dynamic-item input[type="number"] {
        text-align: center;
    }
    
    .btn-add {
        margin-top: 0.6rem;
        width: 100%;
    }
    
    /* ì ìˆ˜ ëŒ€ì‹œë³´ë“œ */
    .score-dashboard { 
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.8rem;
    }
    
    .score-card {
        padding: 1rem;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .score-card h3 {
        font-size: 0.85rem;
        margin-bottom: 0.4rem;
        white-space: nowrap;
    }
    
    .score-value {
        font-size: 1.8rem;
        margin: 0.3rem 0;
        font-weight: 700;
    }
    
    .score-grade {
        font-size: 0.9rem;
    }
    
    /* ì¬ë¬´ìƒíƒœ ì§„ë‹¨ */
    .result-grid { 
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem;
    }
    
    .result-box {
        padding: 0.9rem;
        min-height: 100px;
    }
    
    .result-box h3 {
        font-size: 0.85rem;
        margin-bottom: 0.4rem;
    }
    
    .result-value {
        font-size: 1.4rem;
        margin-bottom: 0.4rem;
    }
    
    .result-status {
        font-size: 0.8rem;
        padding: 0.3rem 0.7rem;
    }
    
    .chart-container {
        min-height: 250px;
        padding: 1rem;
    }
    
    .chart-grid { 
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .chart-grid .chart-container {
        height: 200px;
    }
    
    .consulting-topic {
        padding: 1.2rem;
        margin-bottom: 1.2rem;
    }
    
    .consulting-topic > h3 {
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }
    
    .consulting-section h4 {
        font-size: 0.95rem;
        margin-bottom: 0.7rem;
    }
    
    .consulting-section li {
        font-size: 0.9rem;
        line-height: 1.6;
        margin-bottom: 0.5rem;
    }
}
/* âœ… 3. ëª¨ë°”ì¼ + íƒœë¸”ë¦¿ ê°€ë¡œ (â‰¤ 900px Landscape) */
@media (max-width: 900px) and (orientation: landscape) {
    body { padding: 0; }
    
    .container { 
        padding: 0.85rem 1rem; 
    }
    
    /* âœ… íƒ­ ìˆ¨ê¹€ - 2ë‹¨ ë ˆì´ì•„ì›ƒ */
    .mobile-tabs { 
        display: none !important; 
    }
    
    /* âœ… 2ë‹¨ ë ˆì´ì•„ì›ƒ + ì™¼í¸ í­ ì¦ê°€ */
    .main-grid {
        display: grid !important;
        grid-template-columns: 48% 52%;
        gap: 1rem;
    }
    
    .input-section {
        display: block !important;
        height: auto;
        max-height: none;
        overflow-y: visible;
        position: relative;
        padding-right: 0.5rem;
    }
    
    .analysis-section { 
        display: block !important;
        height: auto;
    }
    
    header h1 { font-size: 1.6rem; }
    
    .card { padding: 1rem; }
    
    .result-grid { grid-template-columns: repeat(2, 1fr); }
    .score-dashboard { grid-template-columns: repeat(3, 1fr); }
    .chart-grid { grid-template-columns: 1fr; }
}

/* âœ… 4. PC (â‰¥ 901px) */
@media (min-width: 901px) {
    body { padding: 0; }
    
    .container { 
        padding: 1.5rem 2rem 2rem 2rem;
        max-width: 1800px;
        margin: 0 auto;
    }
    
    /* âœ… íƒ­ ìˆ¨ê¹€ - 2ë‹¨ ë ˆì´ì•„ì›ƒ */
    .mobile-tabs { 
        display: none !important; 
    }
    
    /* âœ… 2ë‹¨ ë ˆì´ì•„ì›ƒ - ì™¼í¸ ìë™ ë†’ì´ */
    .main-grid {
        display: grid !important;
        grid-template-columns: 42% 58%;
        gap: 2rem;
    }
    
    .input-section {
        display: block !important;
        height: auto;
        max-height: none;
        overflow-y: visible;
        overflow-x: hidden;
        position: relative;
        padding-right: 0.5rem;
    }
    
    .analysis-section { 
        display: block !important;
        height: auto;
        min-height: 100vh;
    }
}
/* ë¹„ìƒì¥ì£¼ì‹ í‰ê°€ ì„¹ì…˜ ë‚´ë¶€ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê°œì„  */
.stock-price-display {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    padding: 1.5rem !important;
    border-radius: 8px !important;
    margin: 0.85rem 0 !important;
}

.stock-price-display * {
    color: white !important;
}

.stock-price-display h4 {
    color: white !important;
    font-weight: 700 !important;
    margin: 0 0 1rem 0 !important;
    font-size: 1rem !important;
}

.stock-price-display h5 {
    color: white !important;
    font-weight: 700 !important;
    background: rgba(255, 255, 255, 0.15) !important;
    padding: 0.6rem !important;
    border-radius: 6px !important;
    margin: 1rem 0 0.5rem 0 !important;
    font-size: 0.95rem !important;
}

/* í°ìƒ‰ ë°°ê²½ ë°•ìŠ¤ ì•ˆì˜ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
.stock-price-display > div[style*="background"] {
    background: white !important;
    padding: 1.5rem !important;
    border-radius: 8px !important;
}

.stock-price-display > div[style*="background"] * {
    color: #2c3e50 !important;
}

.stock-price-display > div[style*="background"] strong,
.stock-price-display > div[style*="background"] .calc-line {
    color: #2c3e50 !important;
}

.stock-price-display .price {
    color: #4169E1 !important;
    font-weight: 700 !important;
    font-size: 1.4rem !important;
}

/* ğŸ“Š ì£¼ì‹ ì •ë³´ í—¤ë” */
.stock-price-display > h4:first-child {
    color: white !important;
    background: transparent !important;
}

/* ë¹„ìƒì¥ì£¼ì‹ í‰ê°€ ìƒì„¸ í—¤ë” */
.stock-price-display div[style*="background"] > * {
    color: #2c3e50 !important;
}

/* ë…¸ë€ìƒ‰ í…ìŠ¤íŠ¸ë¥¼ ì§„í•œ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
.stock-price-display div[style*="background"] strong:first-child,
.stock-price-display div[style*="background"] > div > strong {
    color: #d68910 !important;
    font-weight: 700 !important;
}
/* ìƒë‹¨ ì£¼ì‹ ì •ë³´ (ë³´ë¼ìƒ‰ ë°°ê²½) */
.stock-price-display > div[style*="display:grid"] {
    color: white !important;
}

.stock-price-display > div[style*="display:grid"] > div {
    color: white !important;
}

.stock-price-display > div[style*="display:grid"] .price {
    color: #f1c40f !important;
    font-weight: 700 !important;
}
/* âœ… Print */
@media print {
    body { 
        background: white !important; 
        color: black !important; 
        font-size: 11px !important; 
    }
    .progress-container, .save-status, .toolbar, .keyboard-help, .mobile-tabs { 
        display: none !important; 
    }
    .main-grid { 
        grid-template-columns: 1fr !important; 
        gap: 0.5rem !important; 
    }
    .card { 
        page-break-inside: avoid; 
    }
}
/* === Inline Insight badge (ì…ë ¥ ì˜† ê²½ê³ /ë¶„ì„ ë°°ì§€) === */
.inline-insight {
  display: flex; align-items: center; gap: .5rem;
  margin-left: .5rem; white-space: nowrap;
  font-size: .85rem; line-height: 1;
}
.inline-insight .pill {
  display:inline-flex; align-items:center; gap:.35rem;
  padding:.35rem .6rem; border-radius:999px; font-weight:700;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
}
.inline-insight .pill i { font-size:.85rem }
.inline-insight.info   .pill { background:#e7f3ff; color:#1b73e8; }
.inline-insight.warn   .pill { background:#fff4d6; color:#a66a00; }
.inline-insight.danger .pill { background:#fde8e6; color:#b03a2e; }

/* ì…ë ¥ í•„ë“œì™€ ìì—°ìŠ¤ëŸ½ê²Œ í•œ ì¤„ ë°°ì¹˜ */
.input-field { display:flex; align-items:center; flex-wrap:wrap; }
.input-field > .inline-insight { margin-top:.35rem; }

/* íƒœë¸”ë¦¿ ì„¸ë¡œì—ì„œ ê³µê°„ì´ ì¢ì„ ë•Œ ì¤„ë°”ê¿ˆ */
@media (min-width:641px) and (max-width:900px) and (orientation:portrait){
  .inline-insight { margin-left:.25rem; }
}
/* === Inline Insight badge (ì…ë ¥ ì˜† ê²½ê³ /ë¶„ì„ ë°°ì§€) === */
.inline-insight {
  display: flex; align-items: center; gap: .5rem;
  margin-left: .5rem; white-space: nowrap;
  font-size: .85rem; line-height: 1;
}
.inline-insight .pill {
  display:inline-flex; align-items:center; gap:.35rem;
  padding:.35rem .6rem; border-radius:999px; font-weight:700;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
}
.inline-insight.info   .pill { background:#e7f3ff; color:#1b73e8; }
.inline-insight.warn   .pill { background:#fff4d6; color:#a66a00; }
.inline-insight.danger .pill { background:#fde8e6; color:#b03a2e; }

/* ì…ë ¥ í•„ë“œì™€ í•œ ì¤„ ë°°ì¹˜ */
.input-field { display:flex; align-items:center; flex-wrap:wrap; }
.input-field > .inline-insight { margin-top:.35rem; }

/* íƒœë¸”ë¦¿ ì„¸ë¡œ ìµœì í™” */
@media (min-width:641px) and (max-width:900px) and (orientation:portrait){
  .inline-insight { margin-left:.25rem; }
}

/* === ì˜¤ë¥¸ìª½ ìƒë‹¨ ì»¨í…ìŠ¤íŠ¸ íŒ¨ë„ === */
.context-panel {
  position: sticky; top: 12px; z-index: 30;
  display: none; background: #0b1f3a; color: #fff;
  border-radius: 12px; padding: 12px 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,.18);
}
.context-panel.visible { display: block; }
.context-panel h4 { margin: 0 0 6px; font-size: .95rem; font-weight: 800; }
.context-panel .meta { opacity:.8; font-size:.8rem; margin-bottom:6px; }
.context-panel .pill {
  display:inline-flex; align-items:center; gap:.4rem;
  padding:.4rem .65rem; border-radius:999px; font-weight:700;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
}
.context-panel .danger { background:#fde8e6; color:#b03a2e; }
.context-panel .warn   { background:#fff4d6; color:#a66a00; }
.context-panel .info   { background:#e7f3ff; color:#1b73e8; }
.context-panel .actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.context-panel .btn-mini {
  background:#f0f3f8; color:#0b1f3a; border:none; border-radius:8px;
  padding:.35rem .45rem; min-width:36px; font-size:.9rem; font-weight:700; cursor:pointer;
}
.context-panel .btn-mini:hover { background:#e5ebf3; }
.context-panel .btn-mini:focus { outline: 2px solid #ffd166; outline-offset: 2px; }

/* ì…ë ¥ì¹¸ìœ¼ë¡œ ëŒì•„ì™”ì„ ë•Œ ì ê¹ í•˜ì´ë¼ì´íŠ¸ */
.input-flash {
  outline: 2px solid #ffd166;
  box-shadow: 0 0 0 4px rgba(255,209,102,.35);
  transition: box-shadow .6s ease, outline-color .6s ease;
}
/* === ë‘ íŒ¨ë„ ë…ë¦½ ìŠ¤í¬ë¡¤ ë³µêµ¬ìš© ë§ì…íˆê¸° íŒ¨ì¹˜ === */
.main-grid {
  display: grid !important;
  grid-template-columns: 42% 58% !important;
  gap: var(--gap, 16px);
}
.input-section {
  position: sticky !important;
  top: 0 !important;
  max-height: 100vh !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
  align-self: start;
}
.analysis-section {
  max-height: 100vh !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
}
@media (max-width: 768px) {
  .main-grid { grid-template-columns: 1fr !important; }
  .input-section, .analysis-section {
    position: static !important;
    max-height: none !important;
    overflow: visible !important;
  }
}
html, body {
  height: auto !important;
  overflow: visible !important;
}
/* === ì»¨í…ìŠ¤íŠ¸ íŒ¨ë„ ìŠ¬ë¦¼ + ë©”ì‹œì§€/ë°°ì§€ ë…¸ì¶œ === */
#contextPanel.context-panel{
  position: sticky; top: 10px; z-index: 30;
  display: flex !important; align-items: center; justify-content: space-between; gap: 8px;

  /* ë©”ì‹œì§€ê°€ ìˆì„ ë• ìë™ ëŠ˜ì–´ë‚˜ê²Œ */
  min-height: 36px !important;
  height: auto !important;
  padding: 4px 10px !important;

  border-radius: 8px !important;
  box-shadow: 0 2px 8px rgba(0,0,0,.12) !important;
}

/* ì œëª© í•œ ì¤„ (ë„˜ì¹˜ë©´ â€¦) */
#contextPanel #cp-title{
  margin: 0 !important;
  font-size: .95rem !important;
  font-weight: 700 !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

/* ğŸ”” ë©”ì‹œì§€/ë°°ì§€: ë³´ì´ê²Œ + ì—†ìœ¼ë©´ ìë™ ìˆ¨ê¹€ */
#contextPanel .meta,
#contextPanel #cp-badges{
  display: flex !important;
  align-items: center;
  gap: 6px;
  margin: 0 8px;
  white-space: nowrap;
}
#contextPanel .meta:empty,
#contextPanel #cp-badges:empty{
  display: none !important;   /* ë‚´ìš©ì´ ì—†ìœ¼ë©´ ìˆ¨ê¹€ */
}

/* ë²„íŠ¼ ì˜ì—­ì€ ê·¸ëŒ€ë¡œ ìŠ¬ë¦¼ */
#contextPanel .actions{
  margin: 0 !important;
  display: flex !important; gap: 6px !important; flex-wrap: nowrap !important;
}
#contextPanel .btn-mini{
  min-width: auto !important;
  padding: 2px 6px !important;
  font-size: .85rem !important;
  line-height: 1.2 !important;
  border-radius: 6px !important;
}

/* ëª¨ë°”ì¼ì—ì„œ ë” ì–‡ê²Œ(ì„ íƒ) */
@media (max-width: 768px){
  #contextPanel.context-panel{
    min-height: 32px !important;
    padding: 3px 8px !important;
    top: 8px !important;
  }
  #contextPanel #cp-title{ font-size: .9rem !important; }
  #contextPanel .btn-mini{ font-size: .8rem !important; padding: 2px 5px !important; }
}
/* === [ì…ë ¥ íŒ¨ë„] 2ì—´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ë°ìŠ¤í¬í†±) === */
@media (min-width: 901px){
  .input-section .card{
    /* ì¹´ë“œ ë‚´ë¶€ë¥¼ 2ì—´ ê·¸ë¦¬ë“œë¡œ */
    display: grid !important;
    grid-template-columns: repeat(2, minmax(320px, 1fr)) !important;
    gap: 16px !important;
  }
  /* ì œëª©/íŠ¹ìˆ˜ ë¸”ë¡ì€ ì „ì²´ í­ ì‚¬ìš© */
  .input-section .card > h2,
  .input-section .card > .identity-section,
  .input-section .card > .chart-grid,
  .input-section .card > .score-dashboard,
  .input-section .card > #stock-price-container,
  .input-section .card > #tax-saving-alert{
    grid-column: 1 / -1 !important;
  }
  /* ì¼ë°˜ ì…ë ¥ ê·¸ë£¹ì€ 2ì—´ íƒ€ì¼ì²˜ëŸ¼ */
  .input-section .card > .input-group{ margin-bottom: 0 !important; }
}
/* í™”ë©´ì´ ì¢ì•„ì§€ë©´ ìë™ 1ì—´ */
@media (max-width: 900px){
  .input-section .card{ display: block !important; }
}

/* === [ì…ë ¥ í•„ë“œ] 'ì›' ë‹¨ìœ„ë¥¼ ì…ë ¥ì°½ ì˜¤ë¥¸ìª½ ì•ˆìª½ìœ¼ë¡œ === */
/* í•­ëª© ë˜í¼ë¥¼ ì ˆëŒ€ë°°ì¹˜ì˜ ê¸°ì¤€ì ìœ¼ë¡œ */
.input-section .input-group .input-field{ position: relative; flex-wrap: nowrap; }

/* 'ì›'ì´ ë¶™ëŠ” ìˆ«ì ì…ë ¥ë“¤ì˜ ì˜¤ë¥¸ìª½ íŒ¨ë”© í™•ë³´(í•„ìš”í•œ idë§Œ ë‚˜ì—´) */
.input-section .input-group:has(#capital)         .input-field input,
.input-section .input-group:has(#par_value)       .input-field input,
.input-section .input-group:has(#sales)           .input-field input,
.input-section .input-group:has(#previous_sales)  .input-field input,
.input-section .input-group:has(#op_profit)       .input-field input,
.input-section .input-group:has(#corporate_tax)   .input-field input{
  padding-right: 54px !important;  /* ë‹¨ìœ„ ë“¤ì–´ê°ˆ ìë¦¬ */
}

/* ë¶€ëª¨ì˜ ì˜ì‚¬ìš”ì†Œë¡œ 'ì›'ì„ ê·¸ë ¤ ë„£ì„ ìˆ˜ë„ ìˆì§€ë§Œ
   í˜„ì¬ HTMLì— <span>ì›</span>ì´ ìˆìœ¼ë¯€ë¡œ ê·¸ spanì„ ì˜¤ë¥¸ìª½ì— ê³ ì • */
.input-section .input-group:has(#capital)         .input-field > span:first-of-type,
.input-section .input-group:has(#par_value)       .input-field > span:first-of-type,
.input-section .input-group:has(#sales)           .input-field > span:first-of-type,
.input-section .input-group:has(#previous_sales)  .input-field > span:first-of-type,
.input-section .input-group:has(#op_profit)       .input-field > span:first-of-type,
.input-section .input-group:has(#corporate_tax)   .input-field > span:first-of-type{
  position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
  margin-left: 0 !important; color: #6b7280; pointer-events: none;
  font-weight: 600;
}

/* 'ì£¼', 'ì„¸' ë“± ë‹¤ë¥¸ ë‹¨ìœ„ëŠ” ê¸°ì¡´ì²˜ëŸ¼ í‘œì‹œë˜ë„ë¡ ë³€ê²½í•˜ì§€ ì•ŠìŒ */

/* === [ìš°ì¸¡ ê³ ì •ë°°ë„ˆ] ìŠ¬ë¦¼ + ë©”ì‹œì§€/ë°°ì§€ ë…¸ì¶œ(ì´ë¯¸ ìˆëŠ” ê²½ìš° ì¬í™•ì¸ ë®ì–´ì“°ê¸°) === */
#contextPanel.context-panel{
  min-height: 36px !important; height: auto !important;
  padding: 4px 10px !important; display:flex !important;
  align-items:center; justify-content:space-between; gap:8px;
  border-radius:8px !important; box-shadow:0 2px 8px rgba(0,0,0,.12) !important;
}
#contextPanel #cp-title{
  margin:0 !important; font-size:.95rem !important; font-weight:700 !important;
  white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important;
}
#contextPanel .meta, #contextPanel #cp-badges{
  display:flex !important; align-items:center; gap:6px; margin:0 8px; white-space:nowrap;
}
#contextPanel .meta:empty, #contextPanel #cp-badges:empty{ display:none !important; }
#contextPanel .actions{ margin:0 !important; display:flex !important; gap:6px !important; flex-wrap:nowrap !important; }
#contextPanel .btn-mini{ min-width:auto !important; padding:2px 6px !important; font-size:.85rem !important; line-height:1.2 !important; border-radius:6px !important; }

@media (max-width:768px){
  #contextPanel.context-panel{ min-height:32px !important; padding:3px 8px !important; top:8px !important; }
  #contextPanel #cp-title{ font-size:.9rem !important; }
  #contextPanel .btn-mini{ font-size:.8rem !important; padding:2px 5px !important; }
}
#shareholders-container input[type="text"] {
  width: 65% !important; /* ì´ë¦„ input í­ ì¶•ì†Œ */
}
/* ì„¹ì…˜ ì¹´ë“œ */
.section-card{
  background:#fff; border-radius:14px; padding:18px 18px 8px;
  box-shadow:0 6px 18px rgba(0,0,0,.06); margin:18px 0;
  border:1px solid rgba(10,20,40,.06);
}
/* ì„¹ì…˜ í—¤ë”(h4.input-divider) ìŠ¬ë¦¼/ê³ ì •ì¤„ ëŠë‚Œ */
.section-card > h4.input-divider{
  margin:-6px 0 14px; padding:10px 6px 8px;
  border-bottom:2px solid #e6e9f0; font-size:1.05rem; font-weight:800;
  display:flex; align-items:center; gap:8px; color:#0b1f3a;
}
/* ì¹´ë“œ ë‚´ë¶€ 2ì—´ (ëª¨ë°”ì¼ ìë™ 1ì—´) */
.section-card .input-group{ margin-bottom:12px; }
@media (min-width: 900px){
  .section-card{
    display:grid; grid-template-columns:repeat(2, minmax(320px,1fr)); gap:14px 18px;
  }
  .section-card > h4.input-divider{ grid-column:1 / -1; }
}
/* ë¼ë²¨/ì…ë ¥ ê°„ê²© ì‚´ì§ ì¶•ì†Œ */
.section-card .input-group > label{ margin-bottom:6px; display:block; }
/* â€˜ì›â€™ ë‹¨ìœ„ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ */

/* ì¹´ë“œ(ì„¹ì…˜) ê¸°ë³¸ */
.section-card{
  background:#fff;
  border:1px solid rgba(10,20,40,.08);
  border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,.05);
  padding:16px;
  margin:16px 0;
}

/* ì„¹ì…˜ ì œëª© */
.section-card > h4.input-divider{
  margin:0 0 12px;
  padding-bottom:10px;
  border-bottom:2px solid #e8ecf3;
  font-weight:800;
  color:#0b1f3a;
}

/* ì„¹ì…˜ ë‚´ë¶€ 2ì—´, ì…ë ¥ì¹¸ì€ ê½‰ ì±„ìš°ê¸° */
.section-card .input-group{ margin-bottom:12px; }
.section-card .input-group .input-field input,
.section-card .input-group .input-field select,
.section-card .input-group .input-field textarea{ width:100%; }

/* ë°ìŠ¤í¬í†±: 2ì—´, ëª¨ë°”ì¼: 1ì—´ */
@media (min-width: 900px){
  .section-card{ display:grid; grid-template-columns: repeat(2, minmax(320px,1fr)); gap:14px 18px; }
  .section-card > h4.input-divider{ grid-column:1 / -1; }
}
@media (max-width: 899.98px){
  .section-card{ display:block; }
}

/* ì¢Œì¸¡ ì…ë ¥ì˜ì—­ ì „ì²´ ê·¸ë¦¬ë“œì™€ ì¶©ëŒ ë°©ì§€(ê²¹ì¹¨/ì˜ë¦¼ ë°©ì§€) */
.input-section .card{ overflow: visible !important; }

/* íŠ¹ìˆ˜ê´€ê³„ì¸ ì´ë¦„ í­ ì¶•ì†ŒëŠ” ìœ ì§€ */
#shareholders-container input[type="text"]{ width:65% !important; }

/* 'ì›' ë‹¨ìœ„ ìœ„ì¹˜ íŒ¨ì¹˜ì™€ í•¨ê»˜ ì“°ëŠ” ê²½ìš°, ì…ë ¥ ìš°ì¸¡ íŒ¨ë”© ìœ ì§€ */
.input-section .input-group .input-field input{ box-sizing:border-box; }

/* ë°ìŠ¤í¬í†±ì—ì„œ ê°€ë¡œ ì „ì²´ë¡œ í¼ì¹  ì„¹ì…˜ */
@media (min-width:900px){
  .section-card.wide { 
    grid-column: 1 / -1 !important; 
    display: block !important;
  }
}
</style>
</head>
<body>
<div id="mobile-warning-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.95); color: white; z-index: 10001; display: none; align-items: center; justify-content: center; text-align: center; padding: 1rem;">
    <div style="background: white; color: #212529; padding: 2rem 1.5rem; border-radius: 12px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h2 style="color: #d68910; margin: 0 0 1rem 0; font-size: 1.5rem;"><i class="fas fa-mobile-alt"></i> ì•ˆë‚´</h2>
        <p style="font-size: 1.1rem; line-height: 1.6; margin: 0 0 1.5rem 0;"><strong>PC ë° íŒ¨ë“œ ì „ìš©í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.</strong></p>
        <button type="button" class="btn success" id="close-mobile-warning-btn" style="min-width: 100px;">í™•ì¸</button>
    </div>
</div>
<div class="progress-container">
    <div class="progress-bar" id="progress-bar"></div>
</div>
<div class="save-status" id="save-status">
    <i class="fas fa-save"></i> ìë™ ì €ì¥ë¨
</div>
<div class="keyboard-help" id="keyboard-help">
    <div><strong>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤:</strong></div>
    <div>Ctrl+S: ì €ì¥ | Ctrl+O: ë¶ˆëŸ¬ì˜¤ê¸° | Ctrl+P: ì¸ì‡„</div>
</div>
<div class="container">
    <header>
        <div class="header-content">
            <h1><i class="fas fa-chart-line"></i>Executive Consulting Solution</h1>
            <p class="producer">ì œì‘ : (ì£¼)í•œêµ­FPì„¼í„° ë¶€ì„¤ ì¤‘ì†Œê¸°ì—…ê²½ì˜ì—°êµ¬ì†Œ</p>
        </div>
    </header>
<div class="toolbar">
    <div class="toolbar-left">
        <div class="company-info" id="company-info-display">
            <strong>ë¶„ì„ ëŒ€ìƒ:</strong> <span id="display-name">ì •ë³´ ì—†ìŒ</span> | <span id="display-company">ì •ë³´ ì—†ìŒ</span>
        </div>
    </div>
    <div class="toolbar-right">
        <button class="btn success" id="save-btn"><i class="fas fa-save"></i> ì €ì¥</button>
        <button class="btn info" id="load-btn"><i class="fas fa-upload"></i> ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn warning" id="new-btn"><i class="fas fa-plus"></i> ìƒˆë¬¸ì„œ</button>

    <button class="btn" id="main-menu-btn" style="background-color: #8e44ad;"><i class="fas fa-home"></i> ë©”ì¸</button>
    <button class="btn danger" id="logout-btn"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<div class="mobile-tabs">
    <button class="active" data-tab="input"><i class="fas fa-edit"></i> ì…ë ¥</button>
    <button data-tab="analysis"><i class="fas fa-chart-bar"></i> ë¶„ì„</button>
</div>

<main class="main-grid">
    <section class="input-section active">
  <div class="input-body">
        <div class="card">
            <h2><i class="fas fa-edit"></i>Step 1. í•µì‹¬ ë°ì´í„° ì…ë ¥</h2>
            
            <div class="identity-section">
                <h3><i class="fas fa-building"></i> ê¸°ì—… ê¸°ë³¸ ì •ë³´</h3>
                <div class="identity-grid">
                    <div class="input-group identity">
                        <label for="company_name">ê¸°ì—…ëª…</label>
                        <div class="input-field">
                            <input type="text" id="company_name" class="no-align-right" placeholder="ê¸°ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="input-group identity">
                        <label for="company_type">ë²•ì¸í˜•íƒœ</label>
                        <div class="input-field">
                            <select id="company_type">
                                <option value="">ì„ íƒ</option>
                                <option value="ì£¼ì‹íšŒì‚¬">ì£¼ì‹íšŒì‚¬</option>
                                <option value="ìœ í•œíšŒì‚¬">ìœ í•œíšŒì‚¬</option>
                                <option value="í•©ìíšŒì‚¬">í•©ìíšŒì‚¬</option>
                                <option value="ê°œì¸ì‚¬ì—…ì">ê°œì¸ì‚¬ì—…ì</option>
                            </select>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="input-group identity">
                        <label for="industry">ì—…ì¢… ë¶„ë¥˜</label>
                        <div class="input-field">
                            <select id="industry">
                                <option value="">ì„ íƒ</option>
                                <option value="ì œì¡°ì—…">ì œì¡°ì—…</option>
                                <option value="ë„ì†Œë§¤ì—…">ë„ì†Œë§¤ì—…</option>
                                <option value="ì„œë¹„ìŠ¤ì—…">ì„œë¹„ìŠ¤ì—…</option>
                                <option value="ê±´ì„¤ì—…">ê±´ì„¤ì—…</option>
                                <option value="IT/ì†Œí”„íŠ¸ì›¨ì–´">IT/ì†Œí”„íŠ¸ì›¨ì–´</option>
                                <option value="ìŒì‹ìˆ™ë°•ì—…">ìŒì‹ìˆ™ë°•ì—…</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="input-group identity">
                        <label for="listing_status">ìƒì¥ ì—¬ë¶€</label>
                        <div class="input-field">
                            <select id="listing_status">
                                <option value="ë¹„ìƒì¥" selected>ë¹„ìƒì¥</option>
                                <option value="ì½”ìŠ¤í”¼">ì½”ìŠ¤í”¼</option>
                                <option value="ì½”ìŠ¤ë‹¥">ì½”ìŠ¤ë‹¥</option>
                                <option value="ì½”ë„¥ìŠ¤">ì½”ë„¥ìŠ¤</option>
                            </select>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="input-group identity">
                        <label for="valuation_date">ë¯¸íŒ…ì¼ì</label>
                        <div class="input-field">
                            <input type="date" id="valuation_date">
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="input-group identity">
                        <label for="fiscal_month">ê²°ì‚°ì›”</label>
                        <div class="input-field">
                            <select id="fiscal_month">
                                <option value="12" selected>12ì›”</option>
                                <option value="1">1ì›”</option>
                                <option value="2">2ì›”</option>
                                <option value="3">3ì›”</option>
                                <option value="4">4ì›”</option>
                                <option value="5">5ì›”</option>
                                <option value="6">6ì›”</option>
                                <option value="7">7ì›”</option>
                                <option value="8">8ì›”</option>
                                <option value="9">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                            </select>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
<div class="input-group identity">
    <label for="founding_year">ì°½ì—…ë…„ë„</label>
    <div class="input-field">
        <select id="founding_year">
            <option value="">ì„ íƒ</option>
        </select>
        <i class="fas fa-check check-icon"></i>
    </div>
</div>
                    <div class="input-group identity">
                        <label for="founding_date">ì°½ë¦½ê¸°ë…ì¼</label>
                        <div class="input-field">
                            <input type="date" id="founding_date">
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <div class="input-group identity">
                        <label for="business_description">ì£¼ìš” ì‚¬ì—…ë‚´ìš©</label>
                        <div class="input-field">
                            <textarea id="business_description" placeholder="ì£¼ìš” ì‚¬ì—…ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="identity-section" style="background: linear-gradient(135deg, #2a5a8a, #3d7cb5);">
                <h3><i class="fas fa-user"></i> CEO ê¸°ë³¸ ì •ë³´</h3>
                <div class="identity-grid">
                    <div class="input-group identity">
                        <label for="consultant_name">CEO ì„±ëª…</label>
                        <div class="input-field">
                            <input type="text" id="consultant_name" class="no-align-right" placeholder="ëŒ€í‘œì ì„±ëª…">
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="input-group identity">
                        <label for="ceo_birth">CEO ìƒë…„ì›”ì¼</label>
                        <div class="input-field">
                            <input type="date" id="ceo_birth">
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="input-group identity">
                        <label for="spouse_age">ë°°ìš°ì ì—°ë ¹</label>
                        <div class="input-field">
                            <input type="number" id="spouse_age" placeholder="" min="0" max="150">
                            <span>ì„¸</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="input-group identity">
                        <label for="retirement_age">í¬ë§ ì€í‡´ ì—°ë ¹</label>
                        <div class="input-field">
                            <input type="number" id="retirement_age" placeholder="" min="0" max="100">
                            <span>ì„¸</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <h4 class="input-divider">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ì •ë³´</h4>
            <div class="input-group">
                <label>ìë…€ ì •ë³´</label>
                <div id="children-container"></div>
                <button type="button" class="btn btn-add small" id="add-child-btn"><i class="fas fa-plus"></i> ìë…€ ì¶”ê°€</button>
            </div>
            
            <div class="input-group">
                <label for="successor">ìŠ¹ê³„ì˜ˆì • í›„ê³„ì ìœ ë¬´</label>
                <div class="input-field">
                    <select id="successor">
                        <option value="no">ì•„ë‹ˆì˜¤</option>
                        <option value="yes">ì˜ˆ</option>
                    </select>
                    <i class="fas fa-check check-icon"></i>
                </div>
            </div>
          <h4 class="input-divider">ğŸ“ˆ ì£¼ì‹ ê°€ì¹˜í‰ê°€ ì„¤ì •</h4>
            
            <div class="input-group">
                <label for="capital_return_rate">
                    ìë³¸í™˜ì›ìœ¨ (ìˆ˜ìµê°€ì¹˜ ê³„ì‚°ìš©)
                    <span class="tooltip-container">
                        <i class="fas fa-info-circle info-icon"></i>
                        <span class="tooltip-text">
                            <strong>ìë³¸í™˜ì›ìœ¨ì´ë€?</strong><br>
                            íˆ¬ììê°€ ê¸°ëŒ€í•˜ëŠ” ì—°ê°„ ìˆ˜ìµë¥ ì…ë‹ˆë‹¤.<br><br>
                            <strong>ë°°ìˆ˜ = 100 Ã· ìë³¸í™˜ì›ìœ¨</strong><br><br>
                            <strong>ì‹¤ë¬´ ê¸°ì¤€:</strong><br>
                            â€¢ ìƒì†ì„¸ë²•: 10% (ë°°ìˆ˜ 10ë°°)<br>
                            â€¢ ì¼ë°˜ ê¸°ì—…: 15% (ë°°ìˆ˜ 6.67ë°°)<br>
                            â€¢ ë³´ìˆ˜ì  í‰ê°€: 20% (ë°°ìˆ˜ 5ë°°)<br>
                            â€¢ M&A ì‹¤ì‚¬: 20~25%<br><br>
                            <strong>ì˜ˆì‹œ:</strong><br>
                            â€¢ 10% ì„ íƒ â†’ ìˆœì´ìµ Ã— 10ë°°<br>
                            â€¢ 20% ì„ íƒ â†’ ìˆœì´ìµ Ã— 5ë°°
                        </span>
                    </span>
                </label>
                <div class="input-field">
<select id="capital_return_rate" onchange="updateMultiplier(); updateAnalysis();">
                        <option value="5">5% (ë°°ìˆ˜ 20ë°° - ì´ˆì„±ì¥ê¸°ì—…)</option>
                        <option value="6">6% (ë°°ìˆ˜ 16.67ë°°)</option>
                        <option value="7">7% (ë°°ìˆ˜ 14.29ë°°)</option>
                        <option value="8">8% (ë°°ìˆ˜ 12.5ë°°)</option>
                        <option value="9">9% (ë°°ìˆ˜ 11.11ë°°)</option>
                        <option value="10" selected>10% (ë°°ìˆ˜ 10ë°° - ìƒì†ì„¸ë²• ê¸°ì¤€)</option>
                        <option value="11">11% (ë°°ìˆ˜ 9.09ë°°)</option>
                        <option value="12">12% (ë°°ìˆ˜ 8.33ë°°)</option>
                        <option value="13">13% (ë°°ìˆ˜ 7.69ë°°)</option>
                        <option value="14">14% (ë°°ìˆ˜ 7.14ë°°)</option>
                        <option value="15">15% (ë°°ìˆ˜ 6.67ë°° - ì¼ë°˜ê¸°ì—…)</option>
                        <option value="16">16% (ë°°ìˆ˜ 6.25ë°°)</option>
                        <option value="17">17% (ë°°ìˆ˜ 5.88ë°°)</option>
                        <option value="18">18% (ë°°ìˆ˜ 5.56ë°°)</option>
                        <option value="19">19% (ë°°ìˆ˜ 5.26ë°°)</option>
                        <option value="20">20% (ë°°ìˆ˜ 5ë°° - ë³´ìˆ˜ì )</option>
                        <option value="21">21% (ë°°ìˆ˜ 4.76ë°°)</option>
                        <option value="22">22% (ë°°ìˆ˜ 4.55ë°°)</option>
                        <option value="23">23% (ë°°ìˆ˜ 4.35ë°°)</option>
                        <option value="24">24% (ë°°ìˆ˜ 4.17ë°°)</option>
                        <option value="25">25% (ë°°ìˆ˜ 4ë°° - ë§¤ìš° ë³´ìˆ˜ì )</option>
                    </select>
                    <i class="fas fa-check check-icon"></i>
                </div>
            </div>

            <div class="input-group">
                <label>
                    <i class="fas fa-calculator"></i> ì ìš© ë°°ìˆ˜
                </label>
                <div class="input-field">
                    <input type="text" id="multiplier_display" readonly style="background: #f8f9fa; font-weight: 700; color: #2980b9; text-align: center;">
                    <span>ë°°</span>
                </div>
            </div>
            <h4 class="input-divider">ğŸ’° ì¬ë¬´ ê¸°ì´ˆ ë°ì´í„°</h4>
<div class="input-group"><label for="capital">ìë³¸ê¸ˆ (ì´ˆê¸° ì„¤ì • í›„ ë³€ê²½ ì£¼ì˜)</label><div class="input-field"><input type="text" id="capital" inputmode="numeric" data-initial=""><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="total_shares">ë°œí–‰ì£¼ì‹ ì´ìˆ˜</label><div class="input-field"><input type="text" id="total_shares" inputmode="numeric" readonly style="background-color: #f0f0f0; cursor: not-allowed;"><span>ì£¼</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group">
<label for="par_value">
    ì•¡ë©´ê°€ (ì´ˆê¸° ì„¤ì • í›„ ë³€ê²½ ì£¼ì˜)
    <span class="tooltip-container">
                        <i class="fas fa-info-circle info-icon"></i>
                        <span class="tooltip-text">
                            <strong>ì•¡ë©´ê°€ë€?</strong><br>
                            ì£¼ì‹ 1ì£¼ì˜ ê¸°ë³¸ ê°€ê²©ì…ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ 500ì› ë˜ëŠ” 5,000ì›ì´ë©°, ìë³¸ê¸ˆì„ ë°œí–‰ì£¼ì‹ìˆ˜ë¡œ ë‚˜ëˆˆ ê°’ì…ë‹ˆë‹¤.<br><br>
                            <strong>ì˜ˆì‹œ:</strong><br>
                            â€¢ ìë³¸ê¸ˆ 5ì²œë§Œì› Ã· 10ë§Œì£¼ = ì•¡ë©´ê°€ 500ì›<br><br>
                            ìë³¸ê¸ˆê³¼ ì£¼ì‹ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ ìë™ ê³„ì‚°ë˜ì§€ë§Œ, ì§ì ‘ ì…ë ¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
                        </span>
                    </span>
                </label>
                <div class="input-field"><input type="text" id="par_value" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div>
            </div>
            <div id="stock-price-container"></div>
            <div id="tax-saving-alert" style="margin-top: 1rem;"></div>
            <div class="input-group"><label for="sales">ë‹¹ê¸° ë§¤ì¶œì•¡</label><div class="input-field"><input type="text" id="sales" value="" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="previous_sales">ì „ê¸° ë§¤ì¶œì•¡</label><div class="input-field"><input type="text" id="previous_sales" value="" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="op_profit">ì˜ì—…ì´ìµ</label><div class="input-field"><input type="text" id="op_profit" value="" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group">
                <label for="ebt">ë²•ì¸ì„¸ì°¨ê°ì „ìˆœì´ìµ (ë‹¹ê¸°)</label>
                <div class="input-field">
                    <input type="text" id="ebt" value="0" inputmode="numeric">
                    <span>ì›</span>
                    <i class="fas fa-check check-icon"></i>
                </div>
            </div>

            <div class="input-group">
                <label for="tax_expense">ë²•ì¸ì„¸ (ì˜ˆìƒ)</label>
                <div class="input-field">
                    <input type="text" id="tax_expense" value="0" inputmode="numeric">
                    <span>ì›</span>
                    <i class="fas fa-check check-icon"></i>
                </div>
            </div>

            <div class="input-group">
                <label for="net_income">ë‹¹ê¸°ìˆœì´ìµ (ì˜ˆìƒ) 
                    <span class="tooltip-container">
                        <i class="fas fa-info-circle info-icon"></i>
                        <span class="tooltip-text">ë²•ì¸ì„¸ì°¨ê°ì „ìˆœì´ìµ - ë²•ì¸ì„¸(ì˜ˆìƒ)</span>
                    </span>
                </label>
                <div class="input-field">
                    <input type="text" id="net_income" value="0" inputmode="numeric" readonly style="background: #f0f0f0;">
                    <span>ì›</span>
                </div>
            </div>
            <div class="input-group">
                <label for="previous_net_income">ì „ê¸° ìˆœì´ìµ</label>
                <div class="input-field">
                    <input type="text" id="previous_net_income" value="0" inputmode="numeric">
                    <span>ì›</span>
                    <i class="fas fa-check check-icon"></i>
                </div>
            </div>
            
            <div class="input-group">
                <label for="previous_previous_net_income">ì „ì „ê¸° ìˆœì´ìµ</label>
                <div class="input-field">
                    <input type="text" id="previous_previous_net_income" value="0" inputmode="numeric">
                    <span>ì›</span>
                    <i class="fas fa-check check-icon"></i>
                </div>
            </div>
            <div class="input-group"><label for="total_assets">ìì‚° ì´ê³„</label><div class="input-field"><input type="text" id="total_assets" value="" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="liabilities">ë¶€ì±„ ì´ê³„</label><div class="input-field"><input type="text" id="liabilities" value="" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="equity">ìë³¸ ì´ê³„</label><div class="input-field"><input type="text" id="equity" value="" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="cash_assets">í˜„ê¸ˆ ë° í˜„ê¸ˆì„±ìì‚°</label><div class="input-field"><input type="text" id="cash_assets" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="short_debt">ë‹¨ê¸°ì°¨ì…ê¸ˆ</label><div class="input-field"><input type="text" id="short_debt" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="long_debt">ì¥ê¸°ì°¨ì…ê¸ˆ</label><div class="input-field"><input type="text" id="long_debt" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="interest_expense">ì´ìë¹„ìš© (ì—°)</label><div class="input-field"><input type="text" id="interest_expense" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group">
                <label for="operating_cashflow">
                    ì˜ì—…í™œë™ í˜„ê¸ˆíë¦„
                    <span class="tooltip-container">
                        <i class="fas fa-info-circle info-icon"></i>
                        <span class="tooltip-text">
                            <strong>ì˜ì—…í™œë™ í˜„ê¸ˆíë¦„ì´ë€?</strong><br>
                            ê¸°ì—…ì´ ë³¸ì—…(ì˜ì—…)ì—ì„œ ì‹¤ì œë¡œ ë²Œì–´ë“¤ì¸ í˜„ê¸ˆì…ë‹ˆë‹¤.<br><br>
                            <strong>ì˜ˆì‹œ:</strong><br>
                            â€¢ ìˆœì´ìµ 5ì–µì›ì¸ë° í˜„ê¸ˆíë¦„ -2ì–µì›?<br>
                            â†’ ì™¸ìƒ ë§¤ì¶œì´ ë§ì•„ í˜„ê¸ˆì´ ì•ˆ ë“¤ì–´ì˜´ (í‘ìë„ì‚° ìœ„í—˜!)<br><br>
                            <strong>ì–´ë””ì„œ ì°¾ë‚˜ìš”?</strong><br>
                            ì¬ë¬´ì œí‘œ ì¤‘ "í˜„ê¸ˆíë¦„í‘œ"ì˜ ì²« ë²ˆì§¸ í•­ëª©ì…ë‹ˆë‹¤.<br><br>
                            <strong>ì—†ìœ¼ë©´?</strong><br>
                            ëŒ€ëµ "ë‹¹ê¸°ìˆœì´ìµ + ê°ê°€ìƒê°ë¹„ - ì¬ê³ Â·ë§¤ì¶œì±„ê¶Œ ì¦ê°€ë¶„"ìœ¼ë¡œ ì¶”ì •í•˜ê±°ë‚˜ ì„¸ë¬´ì‚¬ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
                        </span>
                    </span>
                </label>
                <div class="input-field"><input type="text" id="operating_cashflow" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div>
            </div>
            
            <h4 class="input-divider">ğŸ¦ ì§€ë¶„ ë° ì¸ë ¥ êµ¬ì¡°</h4>
            <div class="input-group"><label for="ceo_share">ëŒ€í‘œì´ì‚¬ ì§€ë¶„ìœ¨</label><div class="input-field"><input type="number" id="ceo_share" placeholder="" min="0" max="100" step="0.1"><span>%</span><i class="fas fa-check check-icon"></i></div></div>
            
            <div class="input-group">
                <label>íŠ¹ìˆ˜ê´€ê³„ì¸ ì§€ë¶„ í˜„í™©</label>
                <div id="shareholders-container"></div>
                <button type="button" class="btn btn-add small" id="add-shareholder-btn"><i class="fas fa-plus"></i> íŠ¹ìˆ˜ê´€ê³„ì¸ ì¶”ê°€</button>
            </div>
            
            <div class="input-group"><label for="total_employees">ì´ ì„ì§ì› ìˆ˜</label><div class="input-field"><input type="number" id="total_employees" min="0"><span>ëª…</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="family_salary">ê°€ì¡± ì„ì§ì› ê¸‰ì—¬ ì´ì•¡ (ì—°)</label><div class="input-field"><input type="text" id="family_salary" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>

            <h4 class="input-divider">ğŸ¯ CEO ì»¨ì„¤íŒ… í•µì‹¬ í•­ëª©</h4>
            <div class="input-group"><label for="adv_payments">ê°€ì§€ê¸‰ê¸ˆ</label><div class="input-field"><input type="text" id="adv_payments" value="" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="retained_earnings">ë¯¸ì²˜ë¶„ì´ìµì‰ì—¬ê¸ˆ</label><div class="input-field"><input type="text" id="retained_earnings" value="" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="dividend_3years">ë°°ë‹¹ê¸ˆ ì§€ê¸‰ ë‚´ì—­ (ìµœê·¼ 3ë…„ í•©ê³„)</label><div class="input-field"><input type="text" id="dividend_3years" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="corporate_card">ë²•ì¸ì¹´ë“œ ì—°ê°„ ì‚¬ìš©ì•¡</label><div class="input-field"><input type="text" id="corporate_card" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="entertainment">ì ‘ëŒ€ë¹„ ì´ì•¡ (ì—°)</label><div class="input-field"><input type="text" id="entertainment" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            
            <h4 class="input-divider">ğŸ¢ ë¶€ë™ì‚° ë° ì§€ë°°êµ¬ì¡°</h4>
            <div class="input-group"><label for="corp_real_estate_value">ë²•ì¸ëª…ì˜ ë¶€ë™ì‚° í‰ê°€ì•¡</label><div class="input-field"><input type="text" id="corp_real_estate_value" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="personal_real_estate_value">ê°œì¸ëª…ì˜ ë¶€ë™ì‚° í‰ê°€ì•¡</label><div class="input-field"><input type="text" id="personal_real_estate_value" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="nominee_stock">ëª…ì˜ì‹ íƒì£¼ì‹ ë³´ìœ  ì—¬ë¶€</label><div class="input-field"><select id="nominee_stock"><option value="no">ì•„ë‹ˆì˜¤</option><option value="yes">ì˜ˆ</option></select><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="ip_ownership">ëŒ€í‘œì´ì‚¬/ì£¼ì£¼ ëª…ì˜ íŠ¹í—ˆê¶Œ ë“± ë³´ìœ  ì—¬ë¶€</label><div class="input-field"><select id="ip_ownership"><option value="no">ì•„ë‹ˆì˜¤</option><option value="yes">ì˜ˆ</option></select><i class="fas fa-check check-icon"></i></div></div>

            <h4 class="input-divider">ğŸ¦ ì„¸ë¬´ ë° ì ˆì„¸ ì „ëµ</h4>
            <div class="input-group"><label for="tax_return_review">ìµœê·¼ 5ë…„ê°„ ì„¸ë¬´ì‹ ê³  ì „ë¬¸ê°€ ê²€í†  ì—¬ë¶€</label><div class="input-field"><select id="tax_return_review"><option value="yes">ì˜ˆ</option><option value="no">ì•„ë‹ˆì˜¤</option></select><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="sme_benefit">ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€ ì ìš© ì—¬ë¶€</label><div class="input-field"><select id="sme_benefit"><option value="no">ì•„ë‹ˆì˜¤</option><option value="yes">ì˜ˆ</option></select><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="employment_credit">ê³ ìš©ì¦ëŒ€ ì„¸ì•¡ê³µì œ ìˆ˜í˜œ ì—¬ë¶€</label><div class="input-field"><select id="employment_credit"><option value="no">ì•„ë‹ˆì˜¤</option><option value="yes">ì˜ˆ</option></select><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="rnd_credit">R&D ì„¸ì•¡ê³µì œ ì‹ ì²­ ì´ë ¥</label><div class="input-field"><select id="rnd_credit"><option value="no">ì•„ë‹ˆì˜¤</option><option value="yes">ì˜ˆ</option></select><i class="fas fa-check check-icon"></i></div></div>

            <h4 class="input-divider">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ìƒì†ì¦ì—¬ ê³„íš</h4>
            <div class="input-group"><label for="personal_financial">ê°œì¸ ê¸ˆìœµìì‚° ê·œëª¨</label><div class="input-field"><input type="text" id="personal_financial" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="personal_debt">ê°œì¸ ë¶€ì±„ í˜„í™©</label><div class="input-field"><input type="text" id="personal_debt" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="life_insurance">ìƒëª…ë³´í—˜ ì‚¬ë§ë³´í—˜ê¸ˆ ì´ì•¡</label><div class="input-field"><input type="text" id="life_insurance" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="gift_history">ìë…€ ì¦ì—¬ ì´ë ¥ (ì´ì•¡)</label><div class="input-field"><input type="text" id="gift_history" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="spouse_assets">ë°°ìš°ì ì¬ì‚° ê·œëª¨</label><div class="input-field"><input type="text" id="spouse_assets" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="co_heirs">ê³µë™ìƒì†ì¸ ìˆ˜</label><div class="input-field"><input type="number" id="co_heirs" placeholder="" min="0"><span>ëª…</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="succession_plan">ê°€ì—…ìŠ¹ê³„ ê³„íš ìœ ë¬´</label><div class="input-field"><select id="succession_plan"><option value="no">ì•„ë‹ˆì˜¤</option><option value="yes">ì˜ˆ</option></select><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group">
                <label for="succession_qualify">
                    ê°€ì—…ìŠ¹ê³„ ìš”ê±´ ì¶©ì¡± ì—¬ë¶€
                    <span class="tooltip-container">
                        <i class="fas fa-info-circle info-icon"></i>
                        <span class="tooltip-text">
                            <strong>ê°€ì—…ìŠ¹ê³„ ê³µì œ ìš”ê±´:</strong><br>
                            âœ“ ì—…ë ¥ 10ë…„ ì´ìƒ<br>
                            âœ“ í”¼ìƒì†ì¸ì´ 10ë…„ ì´ìƒ ê²½ì˜<br>
                            âœ“ ìµœëŒ€ì£¼ì£¼ + ì§€ë¶„ 50% ì´ìƒ<br>
                            âœ“ í›„ê³„ì 2ë…„ ì´ìƒ ê·¼ë¬´<br>
                            âœ“ í›„ê³„ì ì„ì› ê²½ë ¥ ë³´ìœ <br>
                            âœ“ ìƒì† í›„ 7ë…„ê°„ ì—…ì¢…Â·ì •ê·œì§ ìœ ì§€
                        </span>
                    </span>
                </label>
                <div class="input-field"><select id="succession_qualify"><option value="no">ë¯¸ì¶©ì¡±</option><option value="yes">ì¶©ì¡±</option></select><i class="fas fa-check check-icon"></i></div>
            </div>

            <h4 class="input-divider">ğŸ–ï¸ CEO ì€í‡´ ì„¤ê³„</h4>
            <div class="input-group"><label for="monthly_living">ì›”í‰ê·  ê°œì¸ ìƒí™œë¹„</label><div class="input-field"><input type="text" id="monthly_living" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="retirement_living">ì€í‡´ í›„ ì›” ìƒí™œë¹„</label><div class="input-field"><input type="text" id="retirement_living" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="national_pension">êµ­ë¯¼ì—°ê¸ˆ ì˜ˆìƒ ìˆ˜ë ¹ì•¡ (ì›”)</label><div class="input-field"><input type="text" id="national_pension" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="private_pension_value">ê°œì¸ì—°ê¸ˆ ì ë¦½ì•¡ (í˜„ì¬ê°€ì¹˜)</label><div class="input-field"><input type="text" id="private_pension_value" inputmode="numeric"><span>ì›</span><i class="fas fa-check check-icon"></i></div></div>
            <div class="input-group"><label for="spouse_income">ë°°ìš°ì ì†Œë“ ìœ ë¬´</label><div class="input-field"><select id="spouse_income"><option value="no">ì—†ìŒ</option><option value="yes">ìˆìŒ</option></select><i class="fas fa-check check-icon"></i></div></div>

            <h4 class="input-divider">ğŸ›¡ï¸ CEO ëª©ì ìê¸ˆ í”Œëœ</h4>

            <div class="input-group"><label for="ceo_age">CEO í˜„ì¬ ì—°ë ¹ (ìë™ê³„ì‚°)</label><div class="input-field"><input type="number" id="ceo_age" readonly style="background:#f8f9fa;"><span>ì„¸</span></div></div>
<div class="input-group">
    <label for="insurance_target_amount">
        ëª©í‘œ ì¤€ë¹„ìê¸ˆ (í¬ë§ì•¡, ìƒì†ì„¸ ë“±)
        <span class="tooltip-container">
            <i class="fas fa-info-circle info-icon"></i>
            <span class="tooltip-text">
                <strong>ë³´í—˜ ì„¤ê³„ ê¸°ì¤€</strong><br>
                CEOê°€ ì¤€ë¹„í•˜ê³ ì í•˜ëŠ” ìê¸ˆ ê·œëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
                (ì˜ˆ: ìƒì†ì„¸ ëŒ€ë¹„ ìê¸ˆ, í‡´ì§ìê¸ˆ ë“±)
            </span>
        </span>
    </label>
    <div class="input-field">
        <input type="text" id="insurance_target_amount" value="" inputmode="numeric">
        <span>ì›</span>
        <i class="fas fa-check check-icon"></i>
    </div>
    
    <!-- âœ… ì•ˆë‚´ ë©”ì‹œì§€ (input-group ì•ˆì— ìœ„ì¹˜) -->
    <div id="insurance-guide-message" style="margin-top: 0.5rem; padding: 0.75rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.9em; color: #856404; display: flex; align-items: center;">
        <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
        <span><strong>ì•ˆë‚´:</strong> 'ì˜ì—…ì´ìµ' ê¸ˆì•¡ì„ ì…ë ¥í•˜ì…”ì•¼ <strong>'CEO ì†”ë£¨ì…˜'</strong>ì´ ì œê³µë©ë‹ˆë‹¤.</span>
    </div>
</div>
<!-- âœ… ë‹¤ìŒ input-group (í¬ë§ ë‚©ì…ê¸°ê°„) -->
<div class="input-group">
    <label for="insurance_payment_period">í¬ë§ ë‚©ì…ê¸°ê°„</label>
    <div class="input-field">
        <select id="insurance_payment_period">
            <option value="5">5ë…„</option>
            <option value="6">6ë…„</option>
            <option value="7">7ë…„</option>
            <option value="8">8ë…„</option>
            <option value="9">9ë…„</option>
            <option value="10" selected>10ë…„</option>
            <option value="11">11ë…„</option>
            <option value="12">12ë…„</option>
            <option value="13">13ë…„</option>
            <option value="14">14ë…„</option>
            <option value="15">15ë…„</option>
            <option value="16">16ë…„</option>
            <option value="17">17ë…„</option>
            <option value="18">18ë…„</option>
            <option value="19">19ë…„</option>
            <option value="20">20ë…„</option>
        </select>
        <i class="fas fa-check-icon"></i>
    </div>
</div>

<h4 class="input-divider">ğŸ“Š ê¸°ê°„ë³„ í™˜ê¸‰ë¥  ì„¤ì • (ì§ì ‘ ì¡°ì •)</h4>
<div id="surrender-rate-container">
    </div>
<button type="button" class="btn btn-add small" id="add-rate-btn">
    <i class="fas fa-plus"></i> í™˜ê¸‰ë¥  í•­ëª© ì¶”ê°€
</button>
            <div class="input-group"><label for="consolation_regulation">ì„ì› ìœ ì¡± ìœ„ë¡œê¸ˆ ê·œì • ìœ ë¬´</label><div class="input-field"><select id="consolation_regulation"><option value="yes">ìˆìŒ</option><option value="no">ì—†ìŒ</option></select><i class="fas fa-check check-icon"></i></div></div>
        </div>
        </div>
    </section>
<section class="analysis-section">
  <!-- âœ… ìŠ¤í‹°í‚¤ ì»¨í…ìŠ¤íŠ¸ íŒ¨ë„: analysis-body ë°”ê¹¥ -->
  <div id="contextPanel" class="context-panel" aria-live="polite">
    <h4 id="cp-title">í˜„ì¬ ì„ íƒ í•­ëª©</h4>
    <div class="meta" id="cp-meta"></div>
    <div id="cp-badges"></div>
    <div class="actions">
      <button type="button" class="btn-mini" id="cp-prev" aria-label="ì´ì „ ì…ë ¥">âˆ’</button>
      <button type="button" class="btn-mini" id="cp-back" aria-label="í˜„ì¬ ì…ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â†©</button>
      <button type="button" class="btn-mini" id="cp-next" aria-label="ë‹¤ìŒ ì…ë ¥">ï¼‹</button>
      <button type="button" class="btn-mini" id="cp-hide" aria-label="íŒ¨ë„ ë‹«ê¸°">âœ•</button>
    </div>
  </div>

  <!-- âœ… ë¶„ì„ ì¹´ë“œ ì „ì²´ë¥¼ analysis-bodyë¡œ ê°ìŒˆ -->
  <div class="analysis-body">
    <div class="card">
      <h2><i class="fas fa-tachometer-alt"></i>ì¢…í•© ê²½ì˜ ê±´ê°•ë„ ì ìˆ˜</h2>
      <div class="score-dashboard" id="score-dashboard"></div>
    </div>

    <div class="card">
      <h2><i class="fas fa-chart-bar"></i>Step 2. ì¬ë¬´ìƒíƒœ ë° ë¦¬ìŠ¤í¬ ì¢…í•© ì§„ë‹¨</h2>
      <div id="metrics_container"></div>
      <div class="chart-container">
        <canvas id="mainChart"></canvas>
      </div>
      <div class="chart-grid">
        <div class="chart-container">
          <div class="chart-toggle">
            <button class="btn small" id="ratio-toggle-btn" onclick="toggleRatioChart()">ê¶Œì¥ ì¬ë¬´ë¹„ìœ¨</button>
          </div>
          <canvas id="ratioChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="riskChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <h2><i class="fas fa-search"></i>Step 3. ì „ë¬¸ê°€ ì§„ë‹¨ ë° ë¶„ì„</h2>
      <div id="strategic_consulting"></div>
    </div>

    <div class="card" id="solution_proposal_card" style="display:none;">
      <h2><i class="fas fa-lightbulb"></i>Step 4. ë§ì¶¤í˜• ì†”ë£¨ì…˜ ìƒì„¸ ì œì•ˆ</h2>
      <div id="solution_proposal"></div>
    </div>

    <div id="consultant_summary" class="card"></div>
  </div><!-- /analysis-body -->
</section>    
</main>
<div style="max-width: 1700px; margin: 2rem auto; padding: 0 2rem;">
  <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 2rem;">
    <h3 style="margin: 0 0 1rem 0; color: #0c2c54;">
      <i class="fas fa-sticky-note"></i> ë©”ëª¨
    </h3>
    <textarea id="consultant-memo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." oninput="autoSave()" 
      style="width: 100%; min-height: 120px; padding: 1rem; border: 1px solid #ced4da; border-radius: 8px; 
      font-size: 1rem; font-family: inherit; resize: vertical;"></textarea>
    <div style="margin-top: 1rem; text-align: right;">
      <button class="btn danger" 
        onclick="if(confirm('ë©”ëª¨ ì „ì²´ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ë¡œ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
          document.getElementById('consultant-memo').value='';
          autoSave();
        }">
        <i class="fas fa-trash"></i> ì‚­ì œ
      </button>
    </div>
  </div>
</div>

<style>
@media (max-width: 768px) {
  #consultant-memo {
    width: 108% !important;          /* ê°€ë¡œí­ í™•ì¥ */
    margin-left: -4% !important;     /* ê°€ìš´ë° ì •ë ¬ ë³´ì • */
    min-height: 260px !important;    /* ë†’ì´ í™•ëŒ€ */
    font-size: 17px !important;      /* ê¸€ì”¨ í¬ê¸° í™•ëŒ€ */
    padding: 1rem !important;        /* ì—¬ë°± ê· í˜• ìœ ì§€ */
  }

  #consultant-memo:focus {
    outline: none;
    border-color: #2a5a8a;
    box-shadow: 0 0 0 3px rgba(42, 90, 138, 0.2);
  }

  /* ì™¸ê³½ ì¹´ë“œ ì—¬ë°± ì•½ê°„ ì¤„ì´ê¸° */
  [style*="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 2rem;"] {
    padding: 1.5rem !important;
  }
}
/* [ì¶”ê°€] ğŸ’» íƒœë¸”ë¦¿ ì„¸ë¡œ ëª¨ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
@media (min-width: 821px) and (max-width: 1200px) and (orientation: portrait) {
    .container {
        max-width: none; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ í•´ì œ */
    }
    body {
        padding: 1rem; /* í™”ë©´ ì¢Œìš° ì—¬ë°± ì¡°ì • */
    }
}
</style>
<footer>
    <div class="disclaimer" style="max-width: 1700px; margin: 1rem auto; padding: 0 2rem;">
        <div style="background: #e9ecef; padding: 2rem; border-radius: 8px;">
        <h3>â€» ë©´ì±… ì¡°í•­ (Disclaimer)</h3>
        <p>ë³¸ ì§„ë‹¨ ê²°ê³¼ ë° ë³´í—˜ ì„¤ê³„ì•ˆì€ ì œê³µëœ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ê°€ìƒ ì‹œë®¬ë ˆì´ì…˜ì´ë©°, ì‹¤ì œ ìƒí’ˆê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ì‚¬ì‹¤ê´€ê³„ ë° ìƒí’ˆ ì„¤ê³„ì— ë”°ë¼ ì‹¤ì œ ì„¸ë²• í•´ì„ ë° ì ìš© ê²°ê³¼ëŠ” ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì‹¤ì œ ì˜ì‚¬ê²°ì • ì‹œì—ëŠ” ë°˜ë“œì‹œ ì„¸ë¬´ì‚¬, íšŒê³„ì‚¬, ì¬ë¬´ ì»¨ì„¤í„´íŠ¸ ë“± ì „ë¬¸ê°€ì™€ ì§ì ‘ ìƒë‹´í•˜ì—¬ ì§„í–‰í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
    </div>
    </div>
    <p class="copyright">Copyright Â© 2025 (ì£¼)í•œêµ­FPì„¼í„°. All Rights Reserved.</p>
</footer>
</div>
<input type="file" id="file-input" class="file-input" accept=".json">
<script>
let savedData = null;
const analysisResult = { risks: new Set(), opportunities: new Set(), solutions: new Set(), insurancePlan: null, taxSavings: 0, estimatedInheritanceTax: 0 };
let charts = {};
let saveTimeout;
let childrenCount = 0;
let shareholdersCount = 0;
let ratioChartMode = 'current';
let currentInputs = {};

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

const debouncedUpdate = debounce(() => {
    updateIdentityDisplay();
    updateProgress();
    updateAnalysis();
    autoSave();
}, 300);

function validateNumber(value, min = 0, max = Infinity) {
    const num = parseFloat(unformat(value));
    if (isNaN(num)) return 0;
    return Math.max(min, Math.min(max, num));
}

const unformat = str => (str || '').toString().replace(/,/g, '');
const formatNumber = num => new Intl.NumberFormat('ko-KR').format(Math.round(Number(num) || 0));
const formatPercent = num => `${(Number(num) || 0).toFixed(1)}%`;
const formatTurnover = num => `${(Number(num) || 0).toFixed(2)}íšŒ`;

function showSaveStatus(message = 'ìë™ ì €ì¥ë¨', type = 'success') {
    const status = document.getElementById('save-status');
    status.innerHTML = `<i class="fas fa-${type === 'saving' ? 'spinner fa-spin' : type === 'danger' ? 'exclamation-triangle' : 'save'}"></i> ${message}`;
    status.className = `save-status ${type} show`;
    setTimeout(() => status.classList.remove('show'), 2000);
}

function updateProgress() {
    const inputs = document.querySelectorAll('input:not([readonly]), select, textarea');
    const filled = Array.from(inputs).filter(input => {
        if (input.type === 'text' || input.type === 'number' || input.type === 'date' || input.tagName === 'TEXTAREA') {
            return input.value.trim() !== '';
        }
        return input.value !== '';
    }).length;
    
    const percentage = Math.round((filled / inputs.length) * 100);
    document.getElementById('progress-bar').style.width = percentage + '%';
    
    inputs.forEach(input => {
        const checkIcon = input.parentElement.querySelector('.check-icon');
        if (checkIcon) {
            if (input.value.trim() !== '') {
                checkIcon.classList.add('show');
            } else {
                checkIcon.classList.remove('show');
            }
        }
    });
}

function updateIdentityDisplay() {
    const name = document.getElementById('consultant_name').value || 'ì •ë³´ ì—†ìŒ';
    const company = document.getElementById('company_name').value || 'ì •ë³´ ì—†ìŒ';
    document.getElementById('display-name').textContent = name;
    document.getElementById('display-company').textContent = company;
}

function autoSave() {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        savedData = collectFormData();
        showSaveStatus('ìë™ ì €ì¥ë¨', 'success');
    }, 1000);
}

function collectFormData() {
    const data = { children: [], shareholders: [] };
    document.querySelectorAll('input, select, textarea').forEach(element => {
        if (element && element.id && 
            !element.id.startsWith('child_') && 
            !element.id.startsWith('shareholder_') && 
            element.id !== 'ceo_age' &&
            element.id !== 'total_shares') {            
            try {
                if (element && element.id) {
                    data[element.id] = element.value || '';
                }
            } catch (e) {
                console.warn('Error reading element:', element.id, e);
            }
        }
    });    
    for (let i = 0; i < childrenCount; i++) {
        const name = document.getElementById(`child_name_${i}`)?.value;
        const gender = document.getElementById(`child_gender_${i}`)?.value;
        const age = document.getElementById(`child_age_${i}`)?.value;
        if (name || gender || age) {
            data.children.push({ name, gender, age });
        }
    }
    
    for (let i = 0; i < shareholdersCount; i++) {
        const name = document.getElementById(`shareholder_name_${i}`)?.value;
        const relation = document.getElementById(`shareholder_relation_${i}`)?.value;
        const share = document.getElementById(`shareholder_share_${i}`)?.value;
        if (name || relation || share) {
            data.shareholders.push({ name, relation, share });
        }
    }
        const memo = document.getElementById('consultant-memo');
    if (memo) data['consultant_memo'] = memo.value;

    data.timestamp = new Date().toISOString();
    return data;
}

function loadFormData(data) {
    Object.keys(data).forEach(key => {
        if (key === 'children' || key === 'shareholders') return;
        const element = document.getElementById(key);
        if (element && key !== 'ceo_age') {
            element.value = data[key];
            if (element.inputmode === 'numeric' && element.value) {
                element.value = formatNumber(unformat(element.value));
            }
        }
    });
    
    if (data.children) {
        document.getElementById('children-container').innerHTML = '';
        childrenCount = 0;
        data.children.forEach(child => {
            addChild();
            const idx = childrenCount - 1;
            document.getElementById(`child_name_${idx}`).value = child.name || '';
            document.getElementById(`child_gender_${idx}`).value = child.gender || '';
            document.getElementById(`child_age_${idx}`).value = child.age || '';
        });
    }
    
    if (data.shareholders) {
        document.getElementById('shareholders-container').innerHTML = '';
        shareholdersCount = 0;
        data.shareholders.forEach(sh => {
            addShareholder();
            const idx = shareholdersCount - 1;
            document.getElementById(`shareholder_name_${idx}`).value = sh.name || '';
            document.getElementById(`shareholder_relation_${idx}`).value = sh.relation || '';
            document.getElementById(`shareholder_share_${idx}`).value = sh.share || '';
        });
    }
    if (data['consultant_memo']) {
    const memo = document.getElementById('consultant-memo');
    if (memo) memo.value = data['consultant_memo'];
}
    updateIdentityDisplay();
    updateProgress();
    updateAnalysis();
}

function saveToFile() {
    const data = collectFormData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${data.company_name || 'ê¸°ì—…ëª…ì—†ìŒ'}_${data.consultant_name || 'ëŒ€í‘œì´ë¦„ì—†ìŒ'}_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showSaveStatus('íŒŒì¼ë¡œ ì €ì¥ë¨', 'success');
}

function loadFromFile() {
    document.getElementById('file-input').click();
}

function newDocument() {
    if (confirm('í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        document.querySelectorAll('input:not([readonly]), select, textarea').forEach(element => {
            if (element.type === 'text' || element.type === 'number' || element.type === 'date' || element.tagName === 'TEXTAREA') {
                element.value = '';
            } else if (element.type === 'select-one') {
                element.selectedIndex = 0;
            }
        });
        document.getElementById('children-container').innerHTML = '';
        document.getElementById('shareholders-container').innerHTML = '';
        childrenCount = 0;
        shareholdersCount = 0;
        savedData = null;
        updateIdentityDisplay();
        updateProgress();
        updateAnalysis();
        showSaveStatus('ìƒˆ ë¬¸ì„œ ìƒì„±ë¨', 'success');
    }
}

function addChild() {
    const container = document.getElementById('children-container');
    const idx = childrenCount++;
    const div = document.createElement('div');
    div.className = 'dynamic-container';
    div.dataset.index = idx;
    div.innerHTML = `
        <button type="button" class="btn danger small btn-remove" data-type="child" data-index="${idx}">
            <i class="fas fa-times"></i>
        </button>
        <div class="dynamic-item">
            <div class="input-group" style="margin-bottom:0;">
                <label>ì´ë¦„</label>
                <input type="text" id="child_name_${idx}" class="no-align-right" placeholder="ìë…€ ì´ë¦„" oninput="autoSave()">
            </div>
            <div class="input-group" style="margin-bottom:0;">
                <label>ì„±ë³„</label>
                <select id="child_gender_${idx}" onchange="autoSave()">
                    <option value="ë‚¨">ë‚¨</option>
                    <option value="ì—¬">ì—¬</option>
                </select>
            </div>
            <div class="input-group" style="margin-bottom:0;">
                <label>ë‚˜ì´</label>
                <input type="number" id="child_age_${idx}" placeholder="" min="0" max="100" onchange="autoSave()">
            </div>
        </div>
    `;
    container.appendChild(div);
    div.querySelector('.btn-remove').addEventListener('click', function() { removeChild(this); });
    updateProgress();
}

function removeChild(btn) {
    const container = btn.closest('.dynamic-container');
    if (container) {
        container.remove();
        const containers = document.querySelectorAll('#children-container .dynamic-container');
        childrenCount = containers.length;
        updateProgress();
        updateAnalysis();
        autoSave();
    }
}

function addShareholder() {
    const container = document.getElementById('shareholders-container');
    const idx = shareholdersCount++;
    const div = document.createElement('div');
    div.className = 'dynamic-container';
    div.dataset.index = idx;
    div.innerHTML = `
        <button type="button" class="btn danger small btn-remove" data-type="shareholder" data-index="${idx}">
            <i class="fas fa-times"></i>
        </button>
        <div class="dynamic-item">
            <div class="input-group" style="margin-bottom:0;">
                <label>ì´ë¦„</label>
                <input type="text" id="shareholder_name_${idx}" class="no-align-right" placeholder="íŠ¹ìˆ˜ê´€ê³„ì¸ ì´ë¦„" oninput="autoSave()">
            </div>
            <div class="input-group" style="margin-bottom:0;">
                <label>ê´€ê³„</label>
                <select id="shareholder_relation_${idx}" onchange="autoSave()">
                    <option value="ë°°ìš°ì">ë°°ìš°ì</option>
                    <option value="ìë…€">ìë…€</option>
                    <option value="ë¶€ëª¨">ë¶€ëª¨</option>
                    <option value="í˜•ì œìë§¤">í˜•ì œìë§¤</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>
            <div class="input-group" style="margin-bottom:0;">
                <label>ì§€ë¶„ìœ¨ (%)</label>
                <input type="number" id="shareholder_share_${idx}" placeholder="" min="0" max="100" step="0.1" onchange="autoSave()">
            </div>
        </div>
    `;
    container.appendChild(div);
    div.querySelector('.btn-remove').addEventListener('click', function() { removeShareholder(this); });
    updateProgress();
}

function removeShareholder(btn) {
    const container = btn.closest('.dynamic-container');
    if (container) {
        container.remove();
        const containers = document.querySelectorAll('#shareholders-container .dynamic-container');
        shareholdersCount = containers.length;
        updateProgress();
        updateAnalysis();
        autoSave();
    }
}

function formatInputWithCommas(element) {
    if (!element || !element.value) return;
    
    const numbers = element.value.replace(/[^\d]/g, '');
    if (!numbers) {
        element.value = '';
        return;
    }
    
    const formatted = formatNumber(numbers);
    
    if (element.value === formatted) return;
    
    element.value = formatted;
}    

function formatAndAnalyze(element) {
    if (!element) return;
    
    if (element.inputmode === 'numeric' || element.getAttribute('inputmode') === 'numeric') {
        formatInputWithCommas(element);
    }
    
    updateIdentityDisplay();
    updateProgress();
    debouncedUpdate();
    autoSave();
}

function calculateAge(birthDate) {
    if (!birthDate) return 0;
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) age--;
    return age;
}

function calculateStockValue(inputs) {
    if (inputs.listing_status !== 'ë¹„ìƒì¥') return 0;
    
    const netAssets = Math.max(0, inputs.total_assets - inputs.liabilities);
    
    const income3year = inputs.net_income || 0;
    const prevIncomeEl = document.getElementById('previous_net_income');
    const prevPrevIncomeEl = document.getElementById('previous_previous_net_income');
    const income2year = prevIncomeEl ? parseFloat(prevIncomeEl.value.replace(/,/g, '')) || 0 : 0;
    const income1year = prevPrevIncomeEl ? parseFloat(prevPrevIncomeEl.value.replace(/,/g, '')) || 0 : 0;
    
const weightedAvgIncome = (income3year * 3 + income2year * 2 + income1year * 1) / 6;

// ì‚¬ìš©ìê°€ ì„ íƒí•œ ìë³¸í™˜ì›ìœ¨ ì ìš©
const capitalReturnRateEl = document.getElementById('capital_return_rate');
const capitalReturnRate = capitalReturnRateEl ? parseFloat(capitalReturnRateEl.value) || 10 : 10;
const multiplier = 100 / capitalReturnRate;
const earningsValue = Math.max(0, weightedAvgIncome * multiplier);
    
    const sales = inputs.sales || 0;
    let stockValue = 0;
    let method = '';
    let calculation = {};
    
    if (sales < 300000000) {
        stockValue = netAssets;
        method = 'ì†Œê·œëª¨ íšŒì‚¬ (ë§¤ì¶œ 3ì–µ ë¯¸ë§Œ)';
        calculation = {
            method: 'ìˆœìì‚°ê°€ì¹˜ 100%',
            netAssets: netAssets,
            earningsValue: 0,
            capitalReturnRate: capitalReturnRate,
            multiplier: multiplier,
            formula: 'ìˆœìì‚°ê°€ì¹˜ë§Œ ì ìš©'
        };
    } else if (sales < 100000000000) {
        stockValue = (netAssets * 2 + earningsValue * 3) / 5;
        method = 'ì¤‘ì†Œê¸°ì—… (ë§¤ì¶œ 3ì–µ~1000ì–µ)';
        calculation = {
            method: '(ìˆœìì‚° Ã— 2 + ìˆ˜ìµ Ã— 3) Ã· 5',
            netAssets: netAssets,
            earningsValue: earningsValue,
            capitalReturnRate: capitalReturnRate,
            multiplier: multiplier,
            formula: `(${formatNumber(netAssets)} Ã— 2 + ${formatNumber(earningsValue)} Ã— 3) Ã· 5`,
            netAssetWeight: '40%',
            earningsWeight: '60%'
        };
    } else {
        stockValue = (netAssets * 3 + earningsValue * 2) / 5;
        method = 'ëŒ€ê¸°ì—… (ë§¤ì¶œ 1000ì–µ ì´ìƒ)';
        calculation = {
            method: '(ìˆœìì‚° Ã— 3 + ìˆ˜ìµ Ã— 2) Ã· 5',
            netAssets: netAssets,
            earningsValue: earningsValue,
            capitalReturnRate: capitalReturnRate,
            multiplier: multiplier,
            formula: `(${formatNumber(netAssets)} Ã— 3 + ${formatNumber(earningsValue)} Ã— 2) Ã· 5`,
            netAssetWeight: '60%',
            earningsWeight: '40%'
        };
    }
    
    inputs.stockValueCalculation = {
        totalValue: stockValue,
        method: method,
        sales: sales,
        calculation: calculation,
        avgIncome: weightedAvgIncome,
        incomeDetails: {
            current: income3year,
            previous: income2year,
            previousPrevious: income1year
        }
    };
    
    return stockValue;
}

function estimateInheritanceTax(totalAssets, coHeirs) {
    const spouseDeduction = Math.min(3000000000, totalAssets * 0.5);
    const childDeduction = Math.min(500000000, coHeirs * 50000000);
    const basicDeduction = 500000000;
    const taxableAmount = Math.max(0, totalAssets - spouseDeduction - childDeduction - basicDeduction);
    let tax = 0;
    if (taxableAmount <= 100000000) tax = taxableAmount * 0.1;
    else if (taxableAmount <= 500000000) tax = 10000000 + (taxableAmount - 100000000) * 0.2;
    else if (taxableAmount <= 1000000000) tax = 90000000 + (taxableAmount - 500000000) * 0.3;
    else if (taxableAmount <= 3000000000) tax = 240000000 + (taxableAmount - 1000000000) * 0.4;
    else tax = 1040000000 + (taxableAmount - 3000000000) * 0.5;
    return { tax, taxableAmount, spouseDeduction, childDeduction, basicDeduction };
}
function scrollToAnalysis() {
    if (window.innerWidth < 1024) return;
    
    const analysisSection = document.querySelector('.analysis-section');
    
    if (analysisSection) {
        setTimeout(() => {
            analysisSection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start',
                inline: 'nearest'
            });
            
            setTimeout(() => {
                window.scrollBy({ top: -80, behavior: 'smooth' });
            }, 600);
        }, 300);
    }
}

function updateTaxSavingAlert(inputs) {
    const alertDiv = document.getElementById('tax-saving-alert');
    
    // ë°©ì–´ ì½”ë“œ 1: ì—˜ë¦¬ë¨¼íŠ¸ ì²´í¬
    if (!alertDiv) {
        console.warn('[updateTaxSavingAlert] tax-saving-alert ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    try {
        // ë°©ì–´ ì½”ë“œ 2: ê¸°ë³¸ ì¡°ê±´ ì²´í¬
        if (inputs.listing_status !== 'ë¹„ìƒì¥' || !inputs.total_shares || inputs.total_shares === 0) {
            alertDiv.innerHTML = '';
            return;
        }
        
        // ë°©ì–´ ì½”ë“œ 3: ì£¼ì‹ ê°€ì¹˜ ê³„ì‚°
        const currentValue = calculateStockValue(inputs);
        if (!currentValue || currentValue <= 0) {
            alertDiv.innerHTML = '';
            return;
        }
        
        const valuePerShare = Math.round(currentValue / inputs.total_shares);
        
        // ë°©ì–´ ì½”ë“œ 4: ê³„ì‚° ê²°ê³¼ ê²€ì¦
        if (isNaN(valuePerShare) || valuePerShare < 0) {
            console.warn('[updateTaxSavingAlert] ë¹„ì •ìƒì ì¸ ì£¼ë‹¹ ê°€ê²©:', valuePerShare);
            alertDiv.innerHTML = '';
            return;
        }
        
        // ì‹œë®¬ë ˆì´ì…˜ ê³„ì‚°
        const targetNetIncome = Math.round((inputs.net_income || 0) * 0.8);
        const adjustment = (inputs.net_income || 0) - targetNetIncome;
        
        const simulatedInputs = {...inputs};
        simulatedInputs.net_income = targetNetIncome;
        const targetValue = calculateStockValue(simulatedInputs) || 0;
        
        const valueDiff = Math.max(0, currentValue - targetValue);
        const valueChangePercent = currentValue > 0 ? Math.round((valueDiff / currentValue) * 100) : 0;
        
        const giftTaxSavings = Math.round(valueDiff * 0.3);
        const inheritanceTaxSavings = Math.round(valueDiff * 0.4);
        const totalSavings = giftTaxSavings + inheritanceTaxSavings;
        
        const estimatedGiftTax = Math.round(currentValue * 0.3);
        const estimatedInheritanceTax = Math.round(currentValue * 0.4);
        
        let alertHTML = '';
        
        // â­ ë ˆë²¨ 1: 1 ~ 10,000ì› (ì•ˆì „ - ê¸ì • ë©”ì‹œì§€)
        if (valuePerShare <= 10000) {
            alertHTML = `<div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-left: 4px solid #28a745; padding: 1.5rem; border-radius: 8px;">
                <h4 style="margin: 0 0 1rem 0; color: #155724;">âœ… ì£¼ì‹ í‰ê°€ì•¡ ì•ˆì „ êµ¬ê°„</h4>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; color: #212529;">
                    <strong style="color: #28a745;">ğŸ“Š í˜„ì¬ í‰ê°€ ìƒíƒœ</strong><br>
                    ì£¼ì‹ í‰ê°€ì•¡ (1ì£¼ë‹¹): <strong style="color: #28a745;">${formatNumber(valuePerShare)}ì›</strong><br>
                    ì´ í‰ê°€ì•¡: <strong style="color: #28a745;">${formatNumber(currentValue)}ì›</strong><br>
                    <span style="color: #6c757d; font-size: 0.9em;">â€» ì¦ì—¬Â·ìƒì†ì„¸ ë¶€ë‹´ì´ ë§¤ìš° ë‚®ì€ ìˆ˜ì¤€ì…ë‹ˆë‹¤</span>
                </div>
                
                <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; border: 1px solid #ffc107; color: #212529;">
                    <strong style="color: #856404;">ğŸ’¡ ì§€ê¸ˆì´ ê¸°íšŒì…ë‹ˆë‹¤!</strong><br><br>
                    í˜„ì¬ëŠ” <strong>ì£¼ì‹ ì¦ì—¬ì˜ ê³¨ë“ íƒ€ì„</strong>ì…ë‹ˆë‹¤:<br><br>
                    âœ… ìë…€ 1ì¸ë‹¹ 10ë…„ ê³µì œ: 5ì²œë§Œì›<br>
                    âœ… ë°°ìš°ì 10ë…„ ê³µì œ: 6ì–µì›<br>
                    âœ… í˜„ì¬ ì£¼ì‹ê°€ì¹˜ê°€ ë‚®ì•„ <strong>ë” ë§ì€ ì£¼ì‹ì„ ë¬´ì„¸ë¡œ ì¦ì—¬ ê°€ëŠ¥</strong><br><br>
                    <strong style="font-size: 1.1em; color: #e67e22;">ğŸ¯ ì§€ê¸ˆ ì¦ì—¬ ì‹œ: í–¥í›„ ì£¼ê°€ ìƒìŠ¹ë¶„ê¹Œì§€ ì ˆì„¸ íš¨ê³¼</strong>
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 1rem; font-size: 0.9em; color: #212529;">
                    <strong style="color: #0c2c54;">ğŸ“‹ ì¶”ì²œ Action:</strong><br>
                    â€¢ 10ë…„ ì£¼ê¸° ì¦ì—¬ í”Œëœ ìˆ˜ë¦½<br>
                    â€¢ ê°€ì—…ìŠ¹ê³„ ìš”ê±´ ì‚¬ì „ ì ê²€ (7ë…„ ì‚¬í›„ê´€ë¦¬)<br>
                    â€¢ ë°°ìš°ìÂ·ìë…€ ì§€ë¶„ìœ¨ ìµœì í™” ì„¤ê³„<br>
                    â€¢ í–¥í›„ ì£¼ê°€ ìƒìŠ¹ ëŒ€ë¹„ ì„ ì œì  ì¦ì—¬ ì‹¤í–‰
                </div>
            </div>`;
        }
        
        // â­ ë ˆë²¨ 2: 10,001 ~ 20,000ì› (ì–‘í˜¸ - í˜„ìƒ ìœ ì§€ ê¶Œì¥)
        else if (valuePerShare > 10000 && valuePerShare <= 20000) {
            alertHTML = `<div style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border-left: 4px solid #17a2b8; padding: 1.5rem; border-radius: 8px;">
                <h4 style="margin: 0 0 1rem 0; color: #0c5460;">â„¹ï¸ ì£¼ì‹ í‰ê°€ì•¡ ì–‘í˜¸ êµ¬ê°„</h4>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; color: #212529;">
                    <strong style="color: #17a2b8;">ğŸ“Š í˜„ì¬ í‰ê°€ ìƒíƒœ</strong><br>
                    ì£¼ì‹ í‰ê°€ì•¡ (1ì£¼ë‹¹): <strong style="color: #17a2b8;">${formatNumber(valuePerShare)}ì›</strong><br>
                    ì´ í‰ê°€ì•¡: <strong style="color: #17a2b8;">${formatNumber(currentValue)}ì›</strong><br>
                    ì˜ˆìƒ ì¦ì—¬ì„¸: ì•½ ${formatNumber(estimatedGiftTax)}ì›<br>
                    <span style="color: #6c757d; font-size: 0.9em;">â€» ì ì • ìˆ˜ì¤€ì´ì§€ë§Œ, ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
                </div>
                
                <div style="background: #d4edda; padding: 1rem; border-radius: 6px; border: 1px solid #28a745; color: #212529;">
                    <strong style="color: #155724;">ğŸ’¡ í˜„ìƒ ìœ ì§€ ì „ëµ</strong><br><br>
                    <strong>í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ë©´ì„œ ì ˆì„¸ ìµœì í™”:</strong><br><br>
                    âœ… ì¦ì—¬ íƒ€ì´ë°: ì§€ê¸ˆì´ ì ê¸° (2ë§Œì› ì´í•˜ ìœ ì§€ ì¤‘)<br>
                    âœ… í–¥í›„ ê´€ë¦¬ í¬ì¸íŠ¸: ì—° ë§¤ì¶œÂ·ì´ìµ ê¸‰ì¦ ì‹œ ì£¼ì˜<br>
                    âœ… 10ë…„ ì£¼ê¸° ì¦ì—¬ë¡œ ëˆ„ì  ${formatNumber((50000000 * 2) * 3)}ì› ê³µì œ í™œìš©<br><br>
                    <strong style="font-size: 1.1em; color: #28a745;">ğŸ¯ ì•ˆì •ì  êµ¬ê°„, ê³„íšì  ì¦ì—¬ ì‹¤í–‰ ê¶Œì¥</strong>
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 1rem; font-size: 0.9em; color: #212529;">
                    <strong style="color: #0c2c54;">ğŸ“‹ ëª¨ë‹ˆí„°ë§ ì²´í¬ë¦¬ìŠ¤íŠ¸:</strong><br>
                    â€¢ ì—° 1íšŒ ì£¼ì‹ í‰ê°€ì•¡ ì¬ì‚°ì •<br>
                    â€¢ ë§¤ì¶œ 30% ì´ìƒ ì¦ê°€ ì‹œ ì¦‰ì‹œ ì¬í‰ê°€<br>
                    â€¢ ë°°ë‹¹ê¸ˆ ì§€ê¸‰ ì „ í‰ê°€ì•¡ ì˜í–¥ë„ ê²€í† <br>
                    â€¢ ê°€ì¡± ì§€ë¶„ìœ¨ í•©ì‚° 50% ì´ìƒ ìœ ì§€
                </div>
            </div>`;
        }
        
        // â­ ë ˆë²¨ 3: 20,001 ~ 35,000ì› (ì£¼ì˜ - ì¡°ì • ê¶Œì¥)
        else if (valuePerShare > 20000 && valuePerShare <= 35000) {
            alertHTML = `<div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-left: 4px solid #ffc107; padding: 1.5rem; border-radius: 8px;">
                <h4 style="margin: 0 0 1rem 0; color: #856404;">âš ï¸ ì£¼ì˜: ì£¼ì‹ í‰ê°€ì•¡ ì¡°ì • ê¶Œì¥</h4>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; color: #212529;">
                    <strong style="color: #e67e22;">ğŸ“Š í˜„ì¬ í‰ê°€ ìƒíƒœ</strong><br>
                    ì£¼ì‹ í‰ê°€ì•¡ (1ì£¼ë‹¹): <strong style="color: #e67e22;">${formatNumber(valuePerShare)}ì›</strong><br>
                    ì´ í‰ê°€ì•¡: <strong style="color: #e67e22;">${formatNumber(currentValue)}ì›</strong><br>
                    ì˜ˆìƒ ì¦ì—¬ì„¸: ì•½ <strong style="color: #e67e22;">${formatNumber(estimatedGiftTax)}ì›</strong><br>
                    <span style="color: #dc3545; font-size: 0.9em;">â€» ì¦ì—¬ì„¸ ë¶€ë‹´ì´ ì¦ê°€í•˜ëŠ” êµ¬ê°„ì…ë‹ˆë‹¤</span>
                </div>
                
                <div style="background: #d4edda; padding: 1rem; border-radius: 6px; border: 2px solid #28a745; color: #212529;">
                    <strong style="color: #155724; font-size: 1.1em;">ğŸ’¡ ì„ íƒì  ì ˆì„¸ ì „ëµ</strong><br><br>
                    <strong style="color: #212529;">ë²•ì¸ì„¸ì°¨ê°ì „ìˆœì´ìµì„ ${formatNumber(adjustment)}ì› ì¡°ì • ì‹œ:</strong><br><br>
                    âœ… ì£¼ì‹ í‰ê°€ì•¡: ${formatNumber(currentValue)}ì› â†’ ${formatNumber(targetValue)}ì› <strong style="color: #28a745;">(${valueChangePercent}% â†“)</strong><br>
                    âœ… ì¦ì—¬ì„¸ ì ˆê°: ì•½ ${formatNumber(giftTaxSavings)}ì›<br>
                    âœ… ìƒì†ì„¸ ì ˆê°: ì•½ ${formatNumber(inheritanceTaxSavings)}ì›<br><br>
                    <strong style="font-size: 1.15em; color: #28a745;">ğŸ’° ì´ ì ˆì„¸ íš¨ê³¼: ${formatNumber(totalSavings)}ì›</strong>
                </div>
                
                <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; border: 1px solid #ffc107; margin-top: 1rem; color: #212529;">
                    <strong style="color: #856404;">ğŸ¤” ëŒ€í‘œë‹˜ ì„ íƒì§€:</strong><br><br>
                    <strong>Aì•ˆ) ì§€ê¸ˆ ë°”ë¡œ ì¦ì—¬ (ì ê·¹ì )</strong><br>
                    â€¢ ì¥ì : í˜„ì¬ ê°€ì¹˜ë¡œ ì¦ì—¬ ì™„ë£Œ<br>
                    â€¢ ë‹¨ì : ì¦ì—¬ì„¸ ${formatNumber(estimatedGiftTax)}ì› ë‚©ë¶€<br><br>
                    
                    <strong>Bì•ˆ) í‰ê°€ì•¡ ì¡°ì • í›„ ì¦ì—¬ (ë³´ìˆ˜ì )</strong><br>
                    â€¢ ì¥ì : ì ˆì„¸ì•¡ ${formatNumber(totalSavings)}ì›<br>
                    â€¢ ë‹¨ì : ìˆœì´ìµ ì¡°ì • í•„ìš” (R&D íˆ¬ì ë“±)<br><br>
                    
                    <strong>Cì•ˆ) ë‚´ë…„ìœ¼ë¡œ ì—°ê¸° (ê´€ë§)</strong><br>
                    â€¢ ìœ„í—˜: í‰ê°€ì•¡ ì¶”ê°€ ìƒìŠ¹ ê°€ëŠ¥ì„±
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 1rem; font-size: 0.9em; color: #212529;">
                    <strong style="color: #0c2c54;">ğŸ“‹ ìˆœì´ìµ ì¡°ì • ë°©ë²• (í•©ë²•):</strong><br>
                    â€¢ R&D íˆ¬ì í™•ëŒ€ (ì„¸ì•¡ê³µì œ + ë¹„ìš© ì¦ê°€)<br>
                    â€¢ ì„ì§ì› ì„±ê³¼ê¸‰/ë³µë¦¬í›„ìƒ ì¦ì•¡<br>
                    â€¢ ì„¤ë¹„ íˆ¬ì ì„ ì§‘í–‰ (ê°ê°€ìƒê°ë¹„)<br>
                    â€¢ í‡´ì§ê¸ˆ ì¶”ê°€ ì ë¦½<br>
                    â€¢ ê´‘ê³ Â·ë§ˆì¼€íŒ… ë¹„ìš© í™•ëŒ€
                </div>
            </div>`;
        }
        
        // â­ ë ˆë²¨ 4: 35,001 ~ 50,000ì› (ê²½ê³  - ì¦‰ì‹œ ì¡°ì¹˜)
        else if (valuePerShare > 35000 && valuePerShare <= 50000) {
            alertHTML = `<div style="background: linear-gradient(135deg, #ffe5d0 0%, #ffd6ba 100%); border-left: 4px solid #ff6b35; padding: 1.5rem; border-radius: 8px;">
                <h4 style="margin: 0 0 1rem 0; color: #cc2936;">âš ï¸ ê²½ê³ : ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”</h4>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; color: #212529; border: 2px solid #ff6b35;">
                    <strong style="color: #ff6b35;">ğŸš¨ í˜„ì¬ ìœ„í—˜ ìˆ˜ì¤€</strong><br>
                    ì£¼ì‹ í‰ê°€ì•¡ (1ì£¼ë‹¹): <strong style="color: #dc3545;">${formatNumber(valuePerShare)}ì›</strong><br>
                    ì´ í‰ê°€ì•¡: <strong style="color: #dc3545;">${formatNumber(currentValue)}ì›</strong><br>
                    ì˜ˆìƒ ì¦ì—¬ì„¸: ì•½ <strong style="color: #dc3545;">${formatNumber(estimatedGiftTax)}ì›</strong><br>
                    ì˜ˆìƒ ìƒì†ì„¸: ì•½ <strong style="color: #dc3545;">${formatNumber(estimatedInheritanceTax)}ì›</strong><br>
                    <span style="color: #dc3545; font-size: 0.95em; font-weight: 600;">â€» ì„¸ê¸ˆ í­íƒ„ ìœ„í—˜ êµ¬ê°„! ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”</span>
                </div>
                
                <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; border: 2px solid #dc3545; color: #212529; margin-bottom: 1rem;">
                    <strong style="color: #dc3545; font-size: 1.1em;">â° íƒ€ì„ì–´íƒ: 3ê°œì›” ë‚´ ì‹¤í–‰ í•„ìˆ˜</strong><br><br>
                    <strong>ì§€ê¸ˆ ì¡°ì¹˜í•˜ì§€ ì•Šìœ¼ë©´:</strong><br>
                    â€¢ ë‚´ë…„ ì¦ì—¬ ì‹œ ì„¸ê¸ˆ ${formatNumber(Math.round(estimatedGiftTax * 0.15))}ì› ì¶”ê°€ ë¶€ë‹´ ê°€ëŠ¥<br>
                    â€¢ ìƒì† ë°œìƒ ì‹œ ê°€ì¡± ì¬ì • ìœ„ê¸°<br>
                    â€¢ ê¸‰ë§¤ê°ìœ¼ë¡œ ìì‚° ì†ì‹¤ ë°œìƒ ê°€ëŠ¥<br><br>
                    <strong style="color: #dc3545;">í˜„ì¬ ìƒí™©: 1ë…„ ëŠ¦ì„ìˆ˜ë¡ ìˆ˜ì–µì› ì†ì‹¤</strong>
                </div>
                
                <div style="background: #d4edda; padding: 1rem; border-radius: 6px; border: 2px solid #28a745; color: #212529;">
                    <strong style="color: #155724; font-size: 1.1em;">ğŸ¯ ê¸´ê¸‰ ì ˆì„¸ í”Œëœ (ì‹¤í–‰ ì¦‰ì‹œ)</strong><br><br>
                    <strong style="color: #212529;">ë²•ì¸ì„¸ì°¨ê°ì „ìˆœì´ìµ ${formatNumber(adjustment)}ì› ì¡°ì • ì‹œ:</strong><br><br>
                    âœ… ì£¼ì‹ í‰ê°€ì•¡: ${formatNumber(currentValue)}ì› â†’ ${formatNumber(targetValue)}ì› <strong style="color: #28a745;">(${valueChangePercent}% â†“)</strong><br>
                    âœ… ì¦ì—¬ì„¸ ì ˆê°: ì•½ <strong style="color: #28a745;">${formatNumber(giftTaxSavings)}ì›</strong><br>
                    âœ… ìƒì†ì„¸ ì ˆê°: ì•½ <strong style="color: #28a745;">${formatNumber(inheritanceTaxSavings)}ì›</strong><br><br>
                    <strong style="font-size: 1.3em; color: #28a745;">ğŸ’° ì´ ì ˆì„¸ íš¨ê³¼: ${formatNumber(totalSavings)}ì›</strong><br>
                    <span style="color: #6c757d; font-size: 0.9em;">â€» ì´ë²ˆ ê²°ì‚° ì „ê¹Œì§€ë§Œ ê°€ëŠ¥í•œ ì ˆì„¸ì•¡ì…ë‹ˆë‹¤</span>
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 1rem; font-size: 0.9em; color: #212529;">
                    <strong style="color: #dc3545;">ğŸ“‹ ì¦‰ì‹œ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ìš°ì„ ìˆœìœ„):</strong><br><br>
                    <strong>1ì£¼ì°¨:</strong><br>
                    â€¢ ì„¸ë¬´ì‚¬ ê¸´ê¸‰ ë¯¸íŒ… (í‰ê°€ì•¡ ê²€ì¦)<br>
                    â€¢ ìˆœì´ìµ ì¡°ì • ê°€ëŠ¥ í•­ëª© ë¦¬ìŠ¤íŠ¸ì—…<br><br>
                    
                    <strong>2~4ì£¼ì°¨:</strong><br>
                    â€¢ R&D íˆ¬ì ${formatNumber(Math.round(adjustment * 0.3))}ì› ì§‘í–‰<br>
                    â€¢ ì„ì§ì› ì„±ê³¼ê¸‰ ${formatNumber(Math.round(adjustment * 0.2))}ì› ì§€ê¸‰<br>
                    â€¢ ì„¤ë¹„ íˆ¬ì ${formatNumber(Math.round(adjustment * 0.3))}ì› ì„ ì§‘í–‰<br>
                    â€¢ ê´‘ê³ Â·ë§ˆì¼€íŒ… ${formatNumber(Math.round(adjustment * 0.2))}ì› í™•ëŒ€<br><br>
                    
                    <strong>ê²°ì‚° ì „:</strong><br>
                    â€¢ ì¬í‰ê°€ í›„ ì¦ì—¬ ì‹¤í–‰<br>
                    â€¢ 10ë…„ ì¦ì—¬ í”Œëœ ìˆ˜ë¦½
                </div>
            </div>`;
        }
        
        // â­ ë ˆë²¨ 5: 50,001ì› ì´ìƒ (ê¸´ê¸‰ - ìœ„ê¸° ìƒí™©)
        else if (valuePerShare > 50000) {
            const crisis5Year = Math.round(estimatedGiftTax * 0.5);
            
            alertHTML = `<div style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-left: 6px solid #dc3545; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);">
                <h4 style="margin: 0 0 1rem 0; color: #721c24; font-size: 1.3em;">ğŸš¨ ê¸´ê¸‰! ì„¸ê¸ˆ í­íƒ„ ìœ„ê¸° ìƒí™©</h4>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; color: #212529; border: 3px solid #dc3545;">
                    <strong style="color: #dc3545; font-size: 1.2em;">ğŸ’£ í˜„ì¬ ìœ„ê¸° ìˆ˜ì¤€</strong><br><br>
                    ì£¼ì‹ í‰ê°€ì•¡ (1ì£¼ë‹¹): <strong style="color: #dc3545; font-size: 1.3em;">${formatNumber(valuePerShare)}ì›</strong><br>
                    ì´ í‰ê°€ì•¡: <strong style="color: #dc3545; font-size: 1.3em;">${formatNumber(currentValue)}ì›</strong><br><br>
                    
                    <div style="background: #fff3cd; padding: 0.8rem; border-radius: 6px; margin: 0.5rem 0;">
                        <strong style="color: #856404;">ì§€ê¸ˆ ì¦ì—¬ ì‹œ:</strong><br>
                        ì¦ì—¬ì„¸: <strong style="color: #dc3545;">${formatNumber(estimatedGiftTax)}ì›</strong>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 0.8rem; border-radius: 6px; margin: 0.5rem 0;">
                        <strong style="color: #856404;">ìƒì† ë°œìƒ ì‹œ:</strong><br>
                        ìƒì†ì„¸: <strong style="color: #dc3545;">${formatNumber(estimatedInheritanceTax)}ì›</strong>
                    </div>
                    
                    <div style="background: #f8d7da; padding: 0.8rem; border-radius: 6px; margin: 0.5rem 0; border: 1px solid #dc3545;">
                        <strong style="color: #721c24;">5ë…„ ë°©ì¹˜ ì‹œ ì¶”ê°€ ë¶€ë‹´:</strong><br>
                        ì•½ <strong style="color: #dc3545; font-size: 1.2em;">+${formatNumber(crisis5Year)}ì›</strong>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 1.2rem; border-radius: 6px; border: 2px solid #dc3545; color: #212529; margin-bottom: 1rem;">
                    <strong style="color: #dc3545; font-size: 1.2em;">â° ê³¨ë“ íƒ€ì„: ì´ë²ˆ ê²°ì‚°ì´ ë§ˆì§€ë§‰ ê¸°íšŒ</strong><br><br>
                    <strong>ìµœì•…ì˜ ì‹œë‚˜ë¦¬ì˜¤:</strong><br><br>
                    <div style="display: grid; gap: 0.5rem;">
                        <div>ğŸ“‰ 1ë…„ í›„: ì£¼ê°€ 10% ìƒìŠ¹ â†’ ì„¸ê¸ˆ ${formatNumber(Math.round(estimatedGiftTax * 0.1))}ì› ì¦ê°€</div>
                        <div>ğŸ“‰ 3ë…„ í›„: ì£¼ê°€ 30% ìƒìŠ¹ â†’ ì„¸ê¸ˆ ${formatNumber(Math.round(estimatedGiftTax * 0.3))}ì› ì¦ê°€</div>
                        <div>ğŸ“‰ 5ë…„ í›„: ëˆ„ì  ë¶€ë‹´ <strong style="color: #dc3545;">${formatNumber(estimatedGiftTax + crisis5Year)}ì›</strong></div>
                        <div>ğŸ’€ ìƒì† ë°œìƒ: ê¸‰ë§¤ê°ìœ¼ë¡œ ì‹œì„¸ ëŒ€ë¹„ 30% ì†ì‹¤ ê°€ëŠ¥</div>
                    </div>
                </div>
                
                <div style="background: #d4edda; padding: 1.2rem; border-radius: 6px; border: 3px solid #28a745; color: #212529;">
                    <strong style="color: #155724; font-size: 1.2em;">ğŸ†˜ ê¸´ê¸‰ êµ¬ì¡° í”Œëœ (72ì‹œê°„ ë‚´ ì‹¤í–‰)</strong><br><br>
                    <strong style="color: #212529; font-size: 1.1em;">ë²•ì¸ì„¸ì°¨ê°ì „ìˆœì´ìµ ${formatNumber(adjustment)}ì› ì¡°ì • ì‹œ:</strong><br><br>
                    
                    <div style="background: white; padding: 1rem; border-radius: 6px; margin: 0.8rem 0;">
                        âœ… ì£¼ì‹ í‰ê°€ì•¡: ${formatNumber(currentValue)}ì› â†’ ${formatNumber(targetValue)}ì›<br>
                        <strong style="color: #28a745; font-size: 1.1em;">(${valueChangePercent}% í•˜ë½ = ìœ„ê¸° íƒˆì¶œ)</strong>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 6px; margin: 0.8rem 0;">
                        ğŸ’° <strong>ì¦ì—¬ì„¸ ì ˆê°:</strong> <strong style="color: #28a745; font-size: 1.2em;">${formatNumber(giftTaxSavings)}ì›</strong><br>
                        ğŸ’° <strong>ìƒì†ì„¸ ì ˆê°:</strong> <strong style="color: #28a745; font-size: 1.2em;">${formatNumber(inheritanceTaxSavings)}ì›</strong>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; margin: 0.8rem 0; text-align: center;">
                        <strong style="font-size: 1.4em; color: #28a745;">ğŸ’ ì´ ì ˆì„¸ íš¨ê³¼</strong><br>
                        <strong style="font-size: 1.8em; color: #28a745;">${formatNumber(totalSavings)}ì›</strong><br>
                        <span style="color: #856404; font-size: 0.95em;">â€» ëŒ€í‘œë‹˜ ê°€ì¡±ì˜ ë¯¸ë˜ë¥¼ ì§€í‚¤ëŠ” ê¸ˆì•¡ì…ë‹ˆë‹¤</span>
                    </div>
                </div>
                
                <div style="background: white; padding: 1.2rem; border-radius: 6px; margin-top: 1rem; color: #212529; border: 2px solid #dc3545;">
                    <strong style="color: #dc3545; font-size: 1.1em;">ğŸ”¥ 72ì‹œê°„ ê¸´ê¸‰ ì•¡ì…˜í”Œëœ</strong><br><br>
                    
                    <div style="background: #f8d7da; padding: 0.8rem; border-radius: 6px; margin: 0.5rem 0;">
                        <strong>Day 1 (ì˜¤ëŠ˜):</strong><br>
                        â€¢ ì˜¤í›„: ì„¸ë¬´ì‚¬ ê¸´ê¸‰ í™”ìƒíšŒì˜<br>
                        â€¢ ì €ë…: CFO ì†Œì§‘ - ë¹„ìƒ ì¬ë¬´íšŒì˜<br>
                        â€¢ ë°¤: ìˆœì´ìµ ì¡°ì • ê°€ëŠ¥ í•­ëª© ìµœì¢… í™•ì •
                    </div>
                    
                    <div style="background: #fff3cd; padding: 0.8rem; border-radius: 6px; margin: 0.5rem 0;">
                        <strong>Day 2-3 (ë‚´ì¼~ëª¨ë ˆ):</strong><br>
                        â€¢ R&D íˆ¬ì ${formatNumber(Math.round(adjustment * 0.25))}ì› ê¸´ê¸‰ ì§‘í–‰<br>
                        â€¢ ì„ì§ì› íŠ¹ë³„ ì„±ê³¼ê¸‰ ${formatNumber(Math.round(adjustment * 0.25))}ì› ê²°ì˜<br>
                        â€¢ ì„¤ë¹„ êµ¬ë§¤ ê³„ì•½ ${formatNumber(Math.round(adjustment * 0.3))}ì› ì²´ê²°<br>
                        â€¢ ê´‘ê³  ëŒ€í–‰ì‚¬ ì¶”ê°€ ë°œì£¼ ${formatNumber(Math.round(adjustment * 0.2))}ì›
                    </div>
                    
                    <div style="background: #d4edda; padding: 0.8rem; border-radius: 6px; margin: 0.5rem 0;">
                        <strong>ê²°ì‚° ì „ (1ì£¼ì¼ ë‚´):</strong><br>
                        â€¢ ì¬í‰ê°€ í›„ ì£¼ì‹ê°€ì¹˜ ì¬í™•ì¸<br>
                        â€¢ ì¦ì—¬ ì‹¤í–‰ (ìë…€Â·ë°°ìš°ì)<br>
                        â€¢ 10ë…„ ì¦ì—¬ í”Œëœ ìµœì¢… ìˆ˜ë¦½<br>
                        â€¢ ê°€ì—…ìŠ¹ê³„ ìš”ê±´ ì¬ì ê²€
                    </div>
                </div>
                
                <div style="background: #212529; color: white; padding: 1rem; border-radius: 6px; margin-top: 1rem; text-align: center;">
                    <strong style="font-size: 1.1em;">âš ï¸ ëŒ€í‘œë‹˜, ì´ ê¸ˆì•¡ì€ ìˆ«ìê°€ ì•„ë‹™ë‹ˆë‹¤</strong><br><br>
                    <span style="font-size: 1.05em;">
                    ${formatNumber(totalSavings)}ì›ì€<br>
                    â€¢ ìë…€ì˜ í•™ìê¸ˆ ${Math.round(totalSavings / 50000000)}ë…„ì¹˜<br>
                    â€¢ ì„ì§ì› ê¸‰ì—¬ ${Math.round(totalSavings / 5000000)}ê°œì›”ì¹˜<br>
                    â€¢ ì‹ ê·œ ì„¤ë¹„ íˆ¬ì ${Math.round(totalSavings / 100000000)}ê±´<br><br>
                    <strong style="color: #f1c40f; font-size: 1.2em;">ì§€ê¸ˆ ì‹¤í–‰í•˜ë©´ ëª¨ë‘ ì§€í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤</strong>
                    </span>
                </div>
            </div>`;
        }
        
        // ìµœì¢… ë Œë”ë§
        alertDiv.innerHTML = alertHTML;
        
    } catch (error) {
        console.error('[updateTaxSavingAlert] ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        console.error('ì…ë ¥ê°’:', inputs);
        alertDiv.innerHTML = ''; // ì—ëŸ¬ ì‹œ ì¡°ìš©íˆ ë¹„ìš°ê¸°
    }
}
function scrollToAnalysis() {
    try {
        const strategicSection = document.getElementById('strategic_consulting');
        if (!strategicSection) return;
        if (!strategicSection.innerHTML.trim()) return;
        
        console.log('ìŠ¤í¬ë¡¤ ì‹œì‘!');  // â† ë””ë²„ê¹… ë©”ì‹œì§€
        
        // ì§ì ‘ ìŠ¤í¬ë¡¤ (ì¹´ë“œ ì•ˆ ì°¾ìŒ)
        strategicSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center'  // â† í™”ë©´ ì¤‘ì•™
        });
        
        // ë…¸ë€ìƒ‰ í‘œì‹œ
        strategicSection.style.backgroundColor = '#fff9e6';
        setTimeout(() => {
            strategicSection.style.backgroundColor = '';
        }, 2000);
        
    } catch (e) {
        console.error('ìŠ¤í¬ë¡¤ ì—ëŸ¬:', e);  // â† ì—ëŸ¬ í™•ì¸
    }
}
function parseValue(id) {
    const element = document.getElementById(id);
    if (!element) return 0;
    const value = element.value.replace(/,/g, '');
    return parseFloat(value) || 0;
}

function getInputs() {
    return {
        ceo_name: document.getElementById('ceo_name')?.value || '',
        company_name: document.getElementById('company_name')?.value || '',
        ceo_age: parseInt(document.getElementById('ceo_age')?.value) || 0,
        ceo_birth: document.getElementById('ceo_birth')?.value || '',
        
        capital: parseValue('capital'),
        par_value: parseValue('par_value'),
        total_shares: parseValue('total_shares'),
        total_assets: parseValue('total_assets'),
        liabilities: parseValue('liabilities'),
        equity: parseValue('equity'),
        sales: parseValue('sales'),
        op_profit: parseValue('op_profit'),
        net_income: parseValue('net_income'),
        
        adv_payments: parseValue('adv_payments'),
        retained_earnings: parseValue('retained_earnings'),
        corporate_card: parseValue('corporate_card'),
        entertainment: parseValue('entertainment'),
        
        corp_real_estate_value: parseValue('corp_real_estate_value'),
        personal_real_estate_value: parseValue('personal_real_estate_value'),
        
        listing_status: document.getElementById('listing_status')?.value || 'ë¹„ìƒì¥',
        nominee_stock: document.getElementById('nominee_stock')?.value || 'no',
        ceo_share: parseFloat(document.getElementById('ceo_share')?.value) || 0,
        family_share: parseFloat(document.getElementById('family_share')?.value) || 0,
        
        short_debt: parseValue('short_debt'),
        long_debt: parseValue('long_debt'),
        interest_expense: parseValue('interest_expense'),
        
        tax_expense: parseValue('tax_expense'),
        operating_cashflow: parseValue('operating_cashflow'),
        
        insurance_target_amount: parseValue('insurance_target_amount'),
        current_insurance: parseValue('current_insurance'),
        
        dividend_3years: parseValue('dividend_3years'),
        
        total_employees: parseInt(document.getElementById('total_employees')?.value) || 0,
        family_salary: parseValue('family_salary'),
        
        previous_sales: parseValue('previous_sales'),
    };
}

function updateAnalysis() {
    Object.values(analysisResult).forEach(val => { if (val instanceof Set) val.clear(); });
    analysisResult.insurancePlan = null;
    analysisResult.taxSavings = 0;
    analysisResult.estimatedInheritanceTax = 0;

    try {
        const ebtEl = document.getElementById('ebt');
        const taxExpenseEl = document.getElementById('tax_expense');
        const netIncomeEl = document.getElementById('net_income');
        
        if (ebtEl && taxExpenseEl && netIncomeEl) {
            const ebt = parseFloat(ebtEl.value.replace(/,/g, '')) || 0;
            const taxExpense = parseFloat(taxExpenseEl.value.replace(/,/g, '')) || 0;
            const calculatedNetIncome = Math.max(0, ebt - taxExpense);
            netIncomeEl.value = formatNumber(calculatedNetIncome);
        }
        
        const ceoBirth = document.getElementById('ceo_birth').value;
        const ceoAgeFromBirth = calculateAge(ceoBirth);
        if (ceoAgeFromBirth > 0) document.getElementById('ceo_age').value = ceoAgeFromBirth;

        const inputs = {
            sales: validateNumber(document.getElementById('sales').value),
            previous_sales: validateNumber(document.getElementById('previous_sales').value),
            op_profit: validateNumber(document.getElementById('op_profit').value, -Infinity),
            ebt: validateNumber(document.getElementById('ebt')?.value || 0, -Infinity),
            tax_expense: validateNumber(document.getElementById('tax_expense')?.value || 0),
            net_income: validateNumber(document.getElementById('net_income')?.value || 0, -Infinity),            
            total_assets: validateNumber(document.getElementById('total_assets').value),
            liabilities: validateNumber(document.getElementById('liabilities').value),
            equity: validateNumber(document.getElementById('equity').value, -Infinity),
            adv_payments: validateNumber(document.getElementById('adv_payments').value),
            retained_earnings: validateNumber(document.getElementById('retained_earnings').value, -Infinity),
            cash_assets: validateNumber(document.getElementById('cash_assets').value),
            short_debt: validateNumber(document.getElementById('short_debt').value),
            long_debt: validateNumber(document.getElementById('long_debt').value),
            interest_expense: validateNumber(document.getElementById('interest_expense').value),
            operating_cashflow: validateNumber(document.getElementById('operating_cashflow').value, -Infinity),
            ceo_share: validateNumber(document.getElementById('ceo_share').value, 0, 100),
            total_employees: parseInt(document.getElementById('total_employees').value) || 0,
            family_salary: validateNumber(document.getElementById('family_salary').value),
            dividend_3years: validateNumber(document.getElementById('dividend_3years').value),
            corporate_card: validateNumber(document.getElementById('corporate_card').value),
            entertainment: validateNumber(document.getElementById('entertainment').value),
            personal_financial: validateNumber(document.getElementById('personal_financial').value),
            personal_debt: validateNumber(document.getElementById('personal_debt').value),
            life_insurance: validateNumber(document.getElementById('life_insurance').value),
            spouse_assets: validateNumber(document.getElementById('spouse_assets').value),
            co_heirs: parseInt(document.getElementById('co_heirs').value) || 0,
            retirement_age: parseInt(document.getElementById('retirement_age').value) || 65,
            monthly_living: validateNumber(document.getElementById('monthly_living').value),
            retirement_living: validateNumber(document.getElementById('retirement_living').value),
            national_pension: validateNumber(document.getElementById('national_pension').value),
            private_pension_value: validateNumber(document.getElementById('private_pension_value').value),
            gift_history: validateNumber(document.getElementById('gift_history').value),
            corp_real_estate_value: validateNumber(document.getElementById('corp_real_estate_value').value),
            personal_real_estate_value: validateNumber(document.getElementById('personal_real_estate_value').value),
            capital: validateNumber(document.getElementById('capital').value),
            total_shares: (() => {
                const cap = validateNumber(document.getElementById('capital').value);
                const par = validateNumber(document.getElementById('par_value').value);
                return (cap > 0 && par > 0) ? Math.round(cap / par) : 0;
            })(),            
            par_value: validateNumber(document.getElementById('par_value').value),
            ceo_age: ceoAgeFromBirth || 50,
            insurance_target_amount: validateNumber(document.getElementById('insurance_target_amount').value),
            insurance_payment_period: parseInt(document.getElementById('insurance_payment_period').value) || 10,
            consolation_regulation: document.getElementById('consolation_regulation').value,
            nominee_stock: document.getElementById('nominee_stock').value,
            ip_ownership: document.getElementById('ip_ownership').value,
            tax_return_review: document.getElementById('tax_return_review').value,
            succession_plan: document.getElementById('succession_plan').value,
            successor: document.getElementById('successor').value,
            sme_benefit: document.getElementById('sme_benefit').value,
            employment_credit: document.getElementById('employment_credit').value,
            rnd_credit: document.getElementById('rnd_credit').value,
            succession_qualify: document.getElementById('succession_qualify').value,
            spouse_income: document.getElementById('spouse_income')?.value || 'no',
            existing_insurance: document.getElementById('existing_insurance')?.value || '', 
            listing_status: document.getElementById('listing_status').value,
            valuation_date: document.getElementById('valuation_date')?.value || '',
            industry: document.getElementById('industry').value,
        };
        
        const stockValue = calculateStockValue(inputs);
        const inheritanceAssets = inputs.personal_financial + inputs.personal_real_estate_value + stockValue * (inputs.ceo_share / 100) + inputs.life_insurance - inputs.personal_debt;
        inputs.inheritance_assets = Math.max(0, inheritanceAssets);
        inputs.severance_est = inputs.insurance_target_amount;
        
        currentInputs = inputs;
        
        updateStockPrice(inputs);
        generateScoreDashboard(inputs);
        generateMetrics(inputs);
        generateCharts(inputs);
        generateStrategicConsulting(inputs);
        generateInsuranceProposal(inputs);
        generateConsultantSummary(inputs);

        const strategicSection = document.getElementById('strategic_consulting');
        if (strategicSection && strategicSection.innerHTML.trim() !== '') {
            strategicSection.style.transition = 'background-color 0.3s ease';
            strategicSection.style.backgroundColor = '#fff3cd';
            
            setTimeout(() => {
                strategicSection.style.backgroundColor = '';
            }, 500);
            
        }
    } catch (e) { 
        console.error("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e); 
        showSaveStatus('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'danger');
    }
}

function updateStockPrice(inputs) {
    const container = document.getElementById('stock-price-container');
    
    if (inputs.capital > 0 && inputs.par_value > 0) {
        const calculatedShares = Math.round(inputs.capital / inputs.par_value);
        const sharesInput = document.getElementById('total_shares');
        if (sharesInput && sharesInput.value === '') {
            sharesInput.value = formatNumber(calculatedShares);
            inputs.total_shares = calculatedShares;
        }
    }
    
    let pricePerShare = inputs.par_value;
    if (!pricePerShare && inputs.capital && inputs.total_shares && inputs.total_shares > 0) {
        pricePerShare = Math.round(inputs.capital / inputs.total_shares);
        const parValueInput = document.getElementById('par_value');
        if (parValueInput && !parValueInput.value) {
            parValueInput.value = formatNumber(pricePerShare);
        }
    }
    
    if (!pricePerShare || !inputs.total_shares || inputs.total_shares === 0) {
        container.innerHTML = '';
        return;
    }
    
    const stockValue = calculateStockValue(inputs);
    const valuePerShare = inputs.total_shares > 0 ? Math.round(stockValue / inputs.total_shares) : 0;
    
    let detailHTML = '';
    if (inputs.stockValueCalculation && inputs.listing_status === 'ë¹„ìƒì¥') {
        const calc = inputs.stockValueCalculation;
        
        detailHTML = `
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
            <h5 style="margin: 0 0 1rem 0; color: #0c2c54; font-size: 1.1rem;">
                ğŸ“‹ ë¹„ìƒì¥ì£¼ì‹ í‰ê°€ ìƒì„¸
            </h5>
            
            <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div><strong>íšŒì‚¬ ê·œëª¨:</strong></div>
                    <div style="color: #2980b9; font-weight: 600;">${calc.method}</div>
                    
                    <div><strong>ë§¤ì¶œì•¡:</strong></div>
                    <div>${formatNumber(calc.sales)}ì›</div>
                    
                    ${calc.calculation.capitalReturnRate > 0 ? `
                    <div><strong>ìë³¸í™˜ì›ìœ¨:</strong></div>
                    <div style="color: #e67e22; font-weight: 600;">${calc.calculation.capitalReturnRate}%</div>
                    
                    <div><strong>ì ìš© ë°°ìˆ˜:</strong></div>
                    <div style="color: #e67e22; font-weight: 600;">${calc.calculation.multiplier}ë°°</div>
                    ` : ''}
                </div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #27ae60;">
                <div style="font-weight: 600; color: #27ae60; margin-bottom: 0.5rem;">ğŸ“Œ ìˆœìì‚°ê°€ì¹˜</div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; font-size: 0.95rem;">
                    <div>ì´ìì‚°:</div>
                    <div style="text-align: right;">${formatNumber(inputs.total_assets)}ì›</div>
                    
                    <div>(-) ë¶€ì±„:</div>
                    <div style="text-align: right;">${formatNumber(inputs.liabilities)}ì›</div>
                    
                    <div style="border-top: 2px solid #dee2e6; padding-top: 0.5rem; font-weight: 600;">ìˆœìì‚°ê°€ì¹˜:</div>
                    <div style="border-top: 2px solid #dee2e6; padding-top: 0.5rem; text-align: right; font-weight: 700; color: #27ae60;">
                        ${formatNumber(calc.calculation.netAssets)}ì›
                    </div>
                </div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #3498db;">
                <div style="font-weight: 600; color: #3498db; margin-bottom: 0.5rem;">ğŸ’° ìˆ˜ìµê°€ì¹˜ (3ê°œë…„ ê°€ì¤‘í‰ê· )</div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; font-size: 0.95rem;">
                    <div>ë‹¹ê¸° ìˆœì´ìµ (Ã—3):</div>
                    <div style="text-align: right;">${formatNumber(calc.incomeDetails.current)}ì›</div>
                    
                    <div>ì „ê¸° ìˆœì´ìµ (Ã—2):</div>
                    <div style="text-align: right;">${formatNumber(calc.incomeDetails.previous)}ì›</div>
                    
                    <div>ì „ì „ê¸° ìˆœì´ìµ (Ã—1):</div>
                    <div style="text-align: right;">${formatNumber(calc.incomeDetails.previousPrevious)}ì›</div>
                    
                    <div style="border-top: 1px solid #dee2e6; padding-top: 0.5rem;">ê°€ì¤‘í‰ê·  ìˆœì´ìµ:</div>
                    <div style="border-top: 1px solid #dee2e6; padding-top: 0.5rem; text-align: right;">${formatNumber(calc.avgIncome)}ì›</div>
                    
                    ${calc.calculation.multiplier > 0 ? `
                    <div style="font-weight: 600;">ìˆ˜ìµê°€ì¹˜ (Ã—${calc.calculation.multiplier}ë°°):</div>
                    <div style="text-align: right; font-weight: 700; color: #3498db;">
                        ${formatNumber(calc.calculation.earningsValue)}ì›
                    </div>
                    ` : `
                    <div style="font-weight: 600;">ìˆ˜ìµê°€ì¹˜:</div>
                    <div style="text-align: right; font-weight: 700; color: #95a5a6;">
                        ì ìš© ì•ˆ ë¨
                    </div>
                    `}
                </div>
            </div>
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 8px;">
    <div style="font-weight: 700; margin-bottom: 1rem; font-size: 1.2rem; color: #FFFFFF; text-align: center;">ğŸ¯ ìµœì¢… í‰ê°€ì•¡ ê³„ì‚°</div>
    <div style="background: rgba(200, 200, 255, 0.4); padding: 1rem; border-radius: 6px; font-family: 'Courier New', monospace; margin-bottom: 1rem; color: #FFFFFF; font-weight: 700; font-size: 1.05rem; text-align: center;">
        ${calc.calculation.formula}
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem;">
        ${calc.calculation.netAssetWeight ? `
        <div style="color: #FFFFFF; font-weight: 600;">ìˆœìì‚° ë¹„ì¤‘:</div>
        <div style="text-align: right; font-weight: 600; color: #FFFFFF;">${calc.calculation.netAssetWeight}</div>
        
        <div style="color: #FFFFFF; font-weight: 600;">ìˆ˜ìµ ë¹„ì¤‘:</div>
        <div style="text-align: right; font-weight: 600; color: #FFFFFF;">${calc.calculation.earningsWeight}</div>
        ` : ''}
        
        <div style="border-top: 2px solid rgba(255,255,255,0.5); padding-top: 0.5rem; font-size: 1.2rem; font-weight: 700; color: #FFFFFF;">
            ì´ í‰ê°€ì•¡:
        </div>
        <div style="border-top: 2px solid rgba(255,255,255,0.5); padding-top: 0.5rem; text-align: right; font-size: 1.8rem; font-weight: 700; color: #FFFFFF;">
            ${formatNumber(calc.totalValue)}ì›
        </div>
    </div>
</div>
        </div>`;
    }
    
    container.innerHTML = `
    <div class="stock-price-display">
        <h4>ğŸ“Š ì£¼ì‹ ì •ë³´</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; text-align:center;">
            <div>
                <div style="font-size:0.85rem; opacity:0.8;">ì•¡ë©´ê°€ (1ì£¼ë‹¹)</div>
                <div class="price">${formatNumber(pricePerShare)}ì›</div>
            </div>
            <div>
                <div style="font-size:0.85rem; opacity:0.8;">í‰ê°€ì•¡ (1ì£¼ë‹¹)</div>
                <div class="price" style="color: #f1c40f;">${formatNumber(valuePerShare)}ì›</div>
            </div>
        </div>
        ${detailHTML}
    </div>`;
}
function toggleRatioChart() {
    const btn = document.getElementById('ratio-toggle-btn');
    if (ratioChartMode === 'current') {
        ratioChartMode = 'ideal';
        btn.textContent = 'í˜„ì¬';
        btn.classList.add('success');
        generateCharts(currentInputs);
    } else {
        ratioChartMode = 'current';
        btn.textContent = 'ê¶Œì¥ ì¬ë¬´ë¹„ìœ¨';
        btn.classList.remove('success');
        generateCharts(currentInputs);
    }
}
function generateScoreDashboard(inputs) {
    const container = document.getElementById('score-dashboard');
    const financialScore = calculateFinancialScore(inputs);
    const taxGrade = calculateTaxGrade(inputs);
    const inheritanceScore = calculateInheritanceScore(inputs);
    const successionScore = calculateSuccessionScore(inputs);
    const retirementScore = calculateRetirementScore(inputs);
    container.innerHTML = `<div class="score-card financial"><h3>ì¬ë¬´ê±´ì „ì„±</h3><div class="score-value">${financialScore}</div><div class="score-grade">ì </div></div><div class="score-card tax"><h3>ì„¸ë¬´ë¦¬ìŠ¤í¬</h3><div class="score-value">${taxGrade}</div><div class="score-grade">ë“±ê¸‰</div></div><div class="score-card inheritance"><h3>ìƒì†ì¤€ë¹„ë„</h3><div class="score-value">${inheritanceScore}</div><div class="score-grade">ì </div></div><div class="score-card succession"><h3>ìŠ¹ê³„ì¤€ë¹„ë„</h3><div class="score-value">${successionScore}</div><div class="score-grade">ì </div></div><div class="score-card retirement"><h3>ì€í‡´ì¤€ë¹„ë„</h3><div class="score-value">${retirementScore}</div><div class="score-grade">ì </div></div>`;
}

function calculateFinancialScore(inputs) {
    let score = 50;
    const debtRatio = inputs.equity > 0 ? (inputs.liabilities / inputs.equity) * 100 : 999;
    if (debtRatio < 100) score += 20;
    else if (debtRatio < 200) score += 10;
    else if (debtRatio > 400) score -= 20;
    if (inputs.operating_cashflow > 0) score += 15;
    else if (inputs.operating_cashflow < 0 && inputs.net_income > 0) score -= 20;
    const interestCoverage = inputs.interest_expense > 0 ? inputs.op_profit / inputs.interest_expense : 99;
    if (interestCoverage >= 3) score += 15;
    else if (interestCoverage < 1) score -= 15;
    return Math.max(0, Math.min(100, score));
}

function calculateTaxGrade(inputs) {
    let penalty = 0;
    if (inputs.corporate_card > inputs.sales * 0.02) penalty += 2;
    if (inputs.entertainment > inputs.sales * 0.03) penalty += 2;
    if (inputs.family_salary > inputs.op_profit * 0.3 && inputs.family_salary > 50000000) penalty += 1;
    if (inputs.sme_benefit === 'no') penalty += 1;
    if (inputs.employment_credit === 'no' && inputs.total_employees >= 10) penalty += 1;
    if (inputs.rnd_credit === 'no') penalty += 1;
    const grades = ['A', 'B', 'C', 'D', 'F'];
    return grades[Math.min(penalty, 4)];
}

function calculateInheritanceScore(inputs) {
    if (inputs.inheritance_assets === 0) return 50;
    const taxInfo = estimateInheritanceTax(inputs.inheritance_assets, inputs.co_heirs);
    const liquidAssets = inputs.personal_financial + inputs.life_insurance;
    const paymentCapacity = taxInfo.tax > 0 ? liquidAssets / taxInfo.tax : 1;
    let score = Math.min(100, paymentCapacity * 100);
    if (inputs.spouse_assets < 500000000) score -= 10;
    if (inputs.life_insurance < taxInfo.tax * 0.5) score -= 10;
    return Math.max(0, Math.round(score));
}

function calculateSuccessionScore(inputs) {
    let score = 50;
    if (inputs.ceo_share >= 50) score += 20;
    else if (inputs.ceo_share < 30) score -= 20;
    if (inputs.successor === 'yes') score += 20;
    else score -= 10;
    if (inputs.succession_plan === 'yes') score += 10;
    if (inputs.succession_qualify === 'yes') score += 10;
    if (inputs.nominee_stock === 'yes') score -= 20;
    return Math.max(0, Math.min(100, score));
}

function calculateRetirementScore(inputs) {
    if (inputs.retirement_living === 0) return 50;
    const yearsToRetirement = Math.max(1, inputs.retirement_age - inputs.ceo_age);
    const lifeExpectancy = 85;
    const retirementYears = lifeExpectancy - inputs.retirement_age;
    const totalNeeded = inputs.retirement_living * 12 * retirementYears;
    const currentAssets = inputs.personal_financial + inputs.life_insurance + inputs.private_pension_value;
    const pensionIncome = (inputs.national_pension * 12 * retirementYears);
    const gap = totalNeeded - currentAssets - pensionIncome;
    let score = 100;
    if (gap > 0) {
        const gapRatio = gap / totalNeeded;
        score -= gapRatio * 50;
    }
    if (inputs.spouse_income === 'no' && inputs.spouse_assets < 200000000) score -= 10;
    if (inputs.existing_insurance === 'no') score -= 10;
    return Math.max(0, Math.round(score));
}

function generateMetrics(inputs) {
    const container = document.getElementById('metrics_container');
    let html = '<div class="result-grid">';
    
    const debtRatioRaw = inputs.equity > 0 ? (inputs.liabilities / inputs.equity) * 100 : 999;
    const debtRatio = Math.min(999, debtRatioRaw);
    
    const metrics_row1 = [
        { title: 'ì•ˆì •ì„± (ë¶€ì±„ë¹„ìœ¨)', tooltip: 'ë¶€ì±„ì´ê³„ Ã· ìë³¸ì´ê³„ Ã— 100', value: debtRatio, formatter: formatPercent, getStatus: v => (v > 400) ? { text: 'ìœ„í—˜', class: 'status-danger', risk: 'ì¬ë¬´êµ¬ì¡° ì•…í™”' } : (v > 200) ? { text: 'ì£¼ì˜', class: 'status-warning', risk: 'ë†’ì€ ë¶€ì±„ë¹„ìœ¨' } : { text: 'ì–‘í˜¸', class: 'status-good' } },
        { title: 'ìˆ˜ìµì„± (ì˜ì—…ì´ìµë¥ )', tooltip: 'ì˜ì—…ì´ìµ Ã· ë§¤ì¶œì•¡ Ã— 100', value: inputs.sales > 0 ? (inputs.op_profit / inputs.sales) * 100 : 0, formatter: formatPercent, getStatus: v => v < 5 ? { text: 'ê°œì„  í•„ìš”', class: 'status-warning' } : (v < 10 ? { text: 'ì–‘í˜¸', class: 'status-good' } : { text: 'ìš°ìˆ˜', class: 'status-safe' }) },
        { title: 'ì„±ì¥ì„± (ë§¤ì¶œì¦ê°€ìœ¨)', tooltip: '(ë‹¹ê¸°ë§¤ì¶œ - ì „ê¸°ë§¤ì¶œ) Ã· ì „ê¸°ë§¤ì¶œ Ã— 100', value: inputs.previous_sales > 0 ? ((inputs.sales - inputs.previous_sales) / inputs.previous_sales) * 100 : 0, formatter: formatPercent, getStatus: v => v < 5 ? { text: 'ì €ì„±ì¥', class: 'status-warning' } : (v < 15 ? { text: 'ì•ˆì • ì„±ì¥', class: 'status-good' } : { text: 'ê³ ì„±ì¥', class: 'status-safe' }) },
        { title: 'í™œë™ì„± (ì´ìì‚°íšŒì „ìœ¨)', tooltip: 'ë§¤ì¶œì•¡ Ã· ì´ìì‚°', value: inputs.total_assets > 0 ? inputs.sales / inputs.total_assets : 0, formatter: formatTurnover, getStatus: v => v < 1 ? { text: 'ê°œì„  í•„ìš”', class: 'status-warning' } : { text: 'ìš°ìˆ˜', class: 'status-safe' } }
    ];
    metrics_row1.forEach(m => { const status = m.getStatus(m.value); if (status.risk) analysisResult.risks.add(status.risk); html += `<div class="result-box"><h3>${m.title} <span class="tooltip-container"><i class="fas fa-info-circle info-icon" style="font-size:0.8rem;"></i><span class="tooltip-text">${m.tooltip}</span></span></h3><p class="result-value">${m.formatter(m.value)}</p><span class="result-status ${status.class}">${status.text}</span></div>`; });
    html += '</div><div class="result-grid" style="margin-top: 1.5rem;">';
    const metrics_row2 = [
        { title: 'ì„¸ìœ¨ ë¦¬ìŠ¤í¬', value: inputs.net_income > 0 ? (inputs.tax_expense / inputs.net_income) * 100 : 0, formatter: formatPercent, getStatus: v => v > 20 ? { text: 'ì ˆì„¸ í•„ìš”', class: 'status-warning', opportunity: 'ë²•ì¸ì„¸ ì ˆê°' } : { text: 'ì ˆì„¸ ì–‘í˜¸', class: 'status-good' } },
        { title: 'ê°€ì§€ê¸‰ê¸ˆ ë¦¬ìŠ¤í¬', value: inputs.adv_payments, formatter: formatNumber, getStatus: v => (v > 50000000) ? { text: 'ì‹œê¸‰', class: 'status-danger', risk: 'ê³ ì•¡ ê°€ì§€ê¸‰ê¸ˆ' } : (v > 1000000) ? { text: 'ì£¼ì˜', class: 'status-warning', risk: 'ê°€ì§€ê¸‰ê¸ˆ' } : { text: 'ì—†ìŒ', class: 'status-safe' } },
        { title: 'ì‰ì—¬ê¸ˆ ë¦¬ìŠ¤í¬', value: inputs.retained_earnings, formatter: formatNumber, getStatus: v => (v > inputs.equity) ? { text: 'ì „ëµ ì‹œê¸‰', class: 'status-danger', risk: 'ê³¼ë‹¤ ì´ìµì‰ì—¬ê¸ˆ' } : (v > inputs.equity * 0.5) ? { text: 'ê´€ë¦¬ í•„ìš”', class: 'status-warning', risk: 'ì´ìµì‰ì—¬ê¸ˆ' } : { text: 'ì ì •', class: 'status-good' } },
        { title: 'CEO í‡´ì§ê¸ˆ ì¬ì›', value: inputs.severance_est, formatter: formatNumber, getStatus: v => (v > inputs.equity * 2 && v > 100000000) ? { text: 'ì„¤ì • ê³¼ë‹¤', class: 'status-danger' } : v > 0 ? { text: 'ì¬ì› ë§ˆë ¨', class: 'status-warning' } : { text: 'í•´ë‹¹ ì—†ìŒ', class: 'status-safe' } }
    ];
    metrics_row2.forEach(m => { const status = m.getStatus(m.value); if (status.risk) analysisResult.risks.add(status.risk); if (status.opportunity) analysisResult.opportunities.add(status.opportunity); html += `<div class="result-box"><h3>${m.title}</h3><p class="result-value">${m.formatter(m.value)}</p><span class="result-status ${status.class}">${status.text}</span></div>`; });
    html += `</div>`; 
    container.innerHTML = html;
}

function generateCharts(inputs) {
    try {
        Object.keys(charts).forEach(key => {
            if (charts[key] && typeof charts[key].destroy === 'function') {
                charts[key].destroy();
            }
        });
        charts = {};

        const mainCtx = document.getElementById('mainChart')?.getContext('2d');
        if (mainCtx) {
            charts.main = new Chart(mainCtx, {
                type: 'bar',
                data: {
                    labels: ['ë§¤ì¶œì•¡', 'ì˜ì—…ì´ìµ', 'ìˆœì´ìµ', 'ìì‚°ì´ê³„', 'ë¶€ì±„ì´ê³„', 'ìë³¸ì´ê³„'],
                    datasets: [{
                        label: 'ê¸ˆì•¡ (ë°±ë§Œì›)',
                        data: [inputs.sales / 1000000, inputs.op_profit / 1000000, inputs.net_income / 1000000, inputs.total_assets / 1000000, inputs.liabilities / 1000000, inputs.equity / 1000000],
                        backgroundColor: ['rgba(12, 44, 84, 0.8)', 'rgba(42, 90, 138, 0.8)', 'rgba(197, 160, 91, 0.8)', 'rgba(30, 132, 73, 0.8)', 'rgba(214, 137, 16, 0.8)', 'rgba(176, 58, 46, 0.8)'],
                        borderColor: ['rgba(12, 44, 84, 1)', 'rgba(42, 90, 138, 1)', 'rgba(197, 160, 91, 1)', 'rgba(30, 132, 73, 1)', 'rgba(214, 137, 16, 1)', 'rgba(176, 58, 46, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'ì¬ë¬´ í˜„í™© ì¢…í•©' }, legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString() + 'ë°±ë§Œì›'; } } } }
                }
            });
        }

        const ratioCtx = document.getElementById('ratioChart')?.getContext('2d');
        if (ratioCtx) {
            const debtRatio = inputs.equity > 0 ? Math.min(999, (inputs.liabilities / inputs.equity) * 100) : 0;
            const profitMargin = inputs.sales > 0 ? (inputs.op_profit / inputs.sales) * 100 : 0;
            const growthRate = inputs.previous_sales > 0 ? ((inputs.sales - inputs.previous_sales) / inputs.previous_sales) * 100 : 0;
            const assetTurnover = inputs.total_assets > 0 ? (inputs.sales / inputs.total_assets) * 100 : 0;
            const datasets = [];
            if (ratioChartMode === 'ideal') {
                datasets.push({ label: 'ê¶Œì¥ ì¬ë¬´ë¹„ìœ¨', data: [10, 15, 10, 100], backgroundColor: 'rgba(30, 132, 73, 0.2)', borderColor: 'rgba(30, 132, 73, 1)', borderWidth: 2 });
            }
            datasets.push({ label: 'í˜„ì¬ ìˆ˜ì¹˜', data: [Math.min(debtRatio / 10, 50), profitMargin, Math.max(0, growthRate), assetTurnover], backgroundColor: 'rgba(42, 90, 138, 0.2)', borderColor: 'rgba(42, 90, 138, 1)', borderWidth: 2 });
            charts.ratio = new Chart(ratioCtx, {
                type: 'radar',
                data: { labels: ['ë¶€ì±„ë¹„ìœ¨', 'ì˜ì—…ì´ìµë¥ ', 'ë§¤ì¶œì„±ì¥ë¥ ', 'ìì‚°íšŒì „ìœ¨'], datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'ì¬ë¬´ë¹„ìœ¨ ë¶„ì„' }, legend: { display: ratioChartMode === 'ideal', position: 'bottom' } }, scales: { r: { beginAtZero: true, max: 50 } } }
            });
        }

        const riskCtx = document.getElementById('riskChart')?.getContext('2d');
        if (riskCtx) {
            charts.risk = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ê°€ì§€ê¸‰ê¸ˆ', 'ì´ìµì‰ì—¬ê¸ˆ', 'í‡´ì§ê¸ˆì¬ì›', 'ê¸°íƒ€'],
                    datasets: [{ data: [inputs.adv_payments / 1000000, inputs.retained_earnings / 1000000, inputs.insurance_target_amount / 1000000, 0], backgroundColor: ['rgba(176, 58, 46, 0.8)', 'rgba(214, 137, 16, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(155, 89, 182, 0.8)'], borderColor: ['rgba(176, 58, 46, 1)', 'rgba(214, 137, 16, 1)', 'rgba(52, 152, 219, 1)', 'rgba(155, 89, 182, 1)'], borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'ë¦¬ìŠ¤í¬ êµ¬ì„± (ë°±ë§Œì›)' }, legend: { position: 'bottom' } } }
            });
        }
    } catch (e) {
        console.error('ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', e);
    }
    
    try {
        updateTaxSavingAlert(inputs);
    } catch (e) {
        console.error('ì ˆì„¸ ì•Œë¦¼ ìƒì„± ì¤‘ ì˜¤ë¥˜:', e);
    }
}

function generateStrategicConsulting(inputs) {
    const container = document.getElementById('strategic_consulting');
    let html = '';
    let totalTaxSavings = 0;
    
    // ğŸ“Š 1. ë‹¨ê¸°ì°¨ì…ê¸ˆ ë¦¬ìŠ¤í¬
    if (inputs.short_debt > inputs.sales * 0.3) {
        const excessDebt = inputs.short_debt - (inputs.sales * 0.3);
        analysisResult.risks.add('ê³¼ë„í•œ ë‹¨ê¸°ì°¨ì…ê¸ˆ');
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-exclamation-circle"></i>ë‹¨ê¸°ì°¨ì…ê¸ˆ ê³¼ë‹¤ (${formatNumber(inputs.short_debt)}ì›)</h3>
            
            <div class="calc-box">
                <div class="calc-line">ë‹¨ê¸°ì°¨ì…ê¸ˆ: ${formatNumber(inputs.short_debt)}ì›</div>
                <div class="calc-line">ì—°ë§¤ì¶œ ëŒ€ë¹„: ${((inputs.short_debt/inputs.sales)*100).toFixed(1)}%</div>
                <div class="calc-line">ì ì • ìˆ˜ì¤€: ë§¤ì¶œì˜ 30% ì´í•˜ (${formatNumber(inputs.sales * 0.3)}ì›)</div>
                <div class="calc-result">âš ï¸ ì´ˆê³¼ì•¡: ${formatNumber(excessDebt)}ì› - ìœ ë™ì„± ìœ„í—˜</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ’¡ ìœ ë™ì„± ê°œì„  ì „ëµ</h5>
                <ul>
                    <li><strong>ë‹¨ê¸° ì „ëµ:</strong> ë§¤ì¶œì±„ê¶Œ íšŒìˆ˜ ê°•í™” + ì¬ê³  ìì‚° ê°ì¶•</li>
                    <li><strong>ì¤‘ê¸° ì „ëµ:</strong> ë‹¨ê¸°ì°¨ì… ${formatNumber(excessDebt * 0.5)}ì›ì„ ì¥ê¸°ëŒ€ì¶œë¡œ ì „í™˜</li>
                    <li><strong>ì¥ê¸° ì „ëµ:</strong> ì˜ì—…í˜„ê¸ˆíë¦„ ê°œì„ ìœ¼ë¡œ ì°¨ì…ê¸ˆ ìƒí™˜</li>
                </ul>
            </div>
        </div>`;
    }
    
    // ğŸ“Š 2. ì¥ê¸°ì°¨ì…ê¸ˆ & ì´ìë¹„ìš© - ì´ìë³´ìƒë°°ìœ¨ ë¶„ì„
    if (inputs.long_debt > 0 && inputs.interest_expense > 0) {
        const interestCoverage = inputs.op_profit > 0 ? inputs.op_profit / inputs.interest_expense : 0;
        const totalDebt = inputs.short_debt + inputs.long_debt;
        
        if (interestCoverage < 2) {
            analysisResult.risks.add('ë‚®ì€ ì´ìë³´ìƒë°°ìœ¨');
            
            html += `<div class="consulting-topic topic-danger">
                <h3 class="danger"><i class="fas fa-chart-line"></i>ì´ìë³´ìƒë°°ìœ¨ ìœ„í—˜ (${interestCoverage.toFixed(2)}ë°°)</h3>
                
                <div class="calc-box">
                    <div class="calc-line">ì´ ì°¨ì…ê¸ˆ: ${formatNumber(totalDebt)}ì›</div>
                    <div class="calc-line">- ë‹¨ê¸°ì°¨ì…ê¸ˆ: ${formatNumber(inputs.short_debt)}ì›</div>
                    <div class="calc-line">- ì¥ê¸°ì°¨ì…ê¸ˆ: ${formatNumber(inputs.long_debt)}ì›</div>
                    <div class="calc-line">ì—°ê°„ ì´ìë¹„ìš©: ${formatNumber(inputs.interest_expense)}ì›</div>
                    <div class="calc-line">ì˜ì—…ì´ìµ: ${formatNumber(inputs.op_profit)}ì›</div>
                    <div class="calc-result">âš ï¸ ì´ìë³´ìƒë°°ìœ¨: ${interestCoverage.toFixed(2)}ë°° (ì•ˆì „: 3ë°° ì´ìƒ)</div>
                </div>
                
                <p><strong>ìœ„í—˜ ì‹ í˜¸:</strong> ì˜ì—…ì´ìµìœ¼ë¡œ ì´ìë¥¼ ${interestCoverage.toFixed(1)}ë²ˆë°–ì— ëª» ê°šìŠµë‹ˆë‹¤. ê¸ˆë¦¬ ìƒìŠ¹ ì‹œ ë¶€ë„ ìœ„í—˜!</p>
                
                <div class="action-box">
                    <h5>ğŸš¨ ê¸´ê¸‰ ì¬ë¬´êµ¬ì¡° ê°œì„ ì•ˆ</h5>
                    <ul>
                        <li><strong>ì¦‰ì‹œ:</strong> ì´ììœ¨ì´ ë†’ì€ ëŒ€ì¶œë¶€í„° ìƒí™˜ (ì—° ${formatNumber(inputs.interest_expense * 0.2)}ì› ì ˆê°)</li>
                        <li><strong>1ê°œì›” ë‚´:</strong> ì •ì±…ìê¸ˆÂ·ì €ê¸ˆë¦¬ ëŒ€ì¶œë¡œ ëŒ€í™˜ ê²€í† </li>
                        <li><strong>3ê°œì›” ë‚´:</strong> ì˜ì—…ì´ìµë¥  5%p ê°œì„  ëª©í‘œ (ì´ìë³´ìƒë°°ìœ¨ ${(interestCoverage * 1.5).toFixed(1)}ë°°ë¡œ ìƒìŠ¹)</li>
                    </ul>
                </div>
            </div>`;
        }
    }
    
    // ğŸ“Š 3. ì˜ì—…í™œë™ í˜„ê¸ˆíë¦„ ì ì
    if (inputs.operating_cashflow < 0 && inputs.net_income > 0) {
        analysisResult.risks.add('í‘ìë„ì‚° ìœ„í—˜');
        
        html += `<div class="consulting-topic topic-danger">
            <h3 class="danger"><i class="fas fa-exclamation-triangle"></i>í‘ìë„ì‚° ìœ„í—˜ - í˜„ê¸ˆíë¦„ ì ì</h3>
            
            <div class="calc-box">
                <div class="calc-line">ë‹¹ê¸°ìˆœì´ìµ: ${formatNumber(inputs.net_income)}ì› (ì¥ë¶€ìƒ í‘ì)</div>
                <div class="calc-line">ì˜ì—…í™œë™ í˜„ê¸ˆíë¦„: ${formatNumber(inputs.operating_cashflow)}ì›</div>
                <div class="calc-result">ğŸ’£ ì‹¤ì œ í˜„ê¸ˆì€ ${formatNumber(Math.abs(inputs.operating_cashflow))}ì› ê°ì†Œ!</div>
            </div>
            
            <p><strong>í‘ìë„ì‚°ì´ë€?</strong> ì¥ë¶€ìƒ ì´ìµì´ ë‚˜ì§€ë§Œ ì‹¤ì œ í˜„ê¸ˆì´ ì—†ì–´ ë¶€ë„ë‚˜ëŠ” ìƒí™©ì…ë‹ˆë‹¤.</p>
            
            <div class="action-box">
                <h5>ğŸ†˜ í˜„ê¸ˆíë¦„ ê¸´ê¸‰ ì²˜ë°©</h5>
                <ul>
                    <li><strong>ë§¤ì¶œì±„ê¶Œ:</strong> íšŒìˆ˜ê¸°ê°„ ë‹¨ì¶• (30ì¼ â†’ 15ì¼ ëª©í‘œ)</li>
                    <li><strong>ì¬ê³ ìì‚°:</strong> íšŒì „ìœ¨ 2ë°° í–¥ìƒ (ë¬µì€ ì¬ê³  ì²˜ë¶„)</li>
                    <li><strong>ë§¤ì…ì±„ë¬´:</strong> ê²°ì œì¡°ê±´ í˜‘ìƒ (30ì¼ â†’ 45ì¼ ì—°ì¥)</li>
                    <li><strong>ëª©í‘œ:</strong> 3ê°œì›” ë‚´ ì˜ì—…í˜„ê¸ˆíë¦„ í”ŒëŸ¬ìŠ¤ ì „í™˜</li>
                </ul>
            </div>
        </div>`;
    }
        // ğŸ“Š 2-1. ì´ìµì‰ì—¬ê¸ˆ ê³¼ë‹¤ ì ë¦½ ë¦¬ìŠ¤í¬
    if (inputs.retained_earnings > inputs.equity && inputs.retained_earnings > 500000000) {
        const dividendOption = inputs.retained_earnings * 0.3;
        const dividendTax = dividendOption * 0.154;
        const corporateTaxIfKept = dividendOption * 0.21;
        
        analysisResult.risks.add('ê³¼ë‹¤ ì´ìµì‰ì—¬ê¸ˆ');
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-coins"></i>ì´ìµì‰ì—¬ê¸ˆ ê³¼ë‹¤ ì ë¦½ ë¦¬ìŠ¤í¬ (${formatNumber(inputs.retained_earnings)}ì›)</h3>
            
            <div class="calc-box">
                <div class="calc-line">ë¯¸ì²˜ë¶„ì´ìµì‰ì—¬ê¸ˆ: ${formatNumber(inputs.retained_earnings)}ì›</div>
                <div class="calc-line">ìë³¸ì´ê³„: ${formatNumber(inputs.equity)}ì›</div>
                <div class="calc-line">ë¹„ìœ¨: ${((inputs.retained_earnings/inputs.equity)*100).toFixed(1)}% (ì •ìƒ: 50% ì´í•˜)</div>
                <div class="calc-result">âš ï¸ ë²•ì¸ì„¸ vs ë°°ë‹¹ì„¸ ë¹„êµ í•„ìˆ˜!</div>
            </div>
            
            <div class="calc-box">
                <div class="calc-line"><strong>ì‹œë‚˜ë¦¬ì˜¤ A: ë²•ì¸ì— ê³„ì† ìŒ“ê¸°</strong></div>
                <div class="calc-line">ë²•ì¸ì„¸ (21%): ${formatNumber(corporateTaxIfKept)}ì›</div>
                <div class="calc-line">+ í–¥í›„ ë°°ë‹¹ ì‹œ ë°°ë‹¹ì†Œë“ì„¸ ì¶”ê°€</div>
                
                <div class="calc-line" style="margin-top:0.5rem;"><strong>ì‹œë‚˜ë¦¬ì˜¤ B: ì§€ê¸ˆ ë°°ë‹¹</strong></div>
                <div class="calc-line">ë°°ë‹¹ì†Œë“ì„¸ (15.4%): ${formatNumber(dividendTax)}ì›</div>
                <div class="calc-result">âœ… ì¦‰ì‹œ ë°°ë‹¹ ì‹œ ${formatNumber(corporateTaxIfKept - dividendTax)}ì› ì ˆì„¸</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ’ ì´ìµì‰ì—¬ê¸ˆ ì¶œêµ¬ì „ëµ (4ê°€ì§€)</h5>
                <ul>
                    <li><strong>ì „ëµ 1:</strong> ë°°ë‹¹ (ì¢…í•©ì†Œë“ 5ì–µ ì´í•˜ ì‹œ ìœ ë¦¬)</li>
                    <li><strong>ì „ëµ 2:</strong> íŠ¹í—ˆê¶Œ í˜„ë¬¼ì¶œìë¡œ ìë³¸ê¸ˆ ì¦ì•¡ (ì´ìµì‰ì—¬ê¸ˆ â†’ ìë³¸ê¸ˆ ì „í™˜)</li>
                    <li><strong>ì „ëµ 3:</strong> ì„ì§ì› ì„±ê³¼ê¸‰ ì§€ê¸‰ (ì†ê¸ˆì‚°ì…)</li>
                    <li><strong>ì „ëµ 4:</strong> ì¤€ë¹„ê¸ˆ ì„¤ì • (í‡´ì§ê¸‰ì—¬ì¶©ë‹¹ê¸ˆ, ëŒ€ì†ì¶©ë‹¹ê¸ˆ ë“±)</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += Math.max(0, corporateTaxIfKept - dividendTax);
    }
    
    // ğŸ“Š 3-1. ë²•ì¸ì¹´ë“œ ì‚¬ì ì‚¬ìš©
    if (inputs.corporate_card > inputs.sales * 0.02 && inputs.corporate_card > 50000000) {
        analysisResult.risks.add('ë²•ì¸ì¹´ë“œ ì‚¬ì ì‚¬ìš© ì˜ì‹¬');
        const excessAmount = inputs.corporate_card - (inputs.sales * 0.02);
        const penaltyRisk = excessAmount * 0.45;
        
        html += `<div class="consulting-topic topic-danger">
            <h3 class="danger"><i class="fas fa-credit-card"></i>ë²•ì¸ì¹´ë“œ ì„¸ë¬´ì¡°ì‚¬ ê³ ìœ„í—˜ (${formatNumber(inputs.corporate_card)}ì›)</h3>
            
            <div class="calc-box">
                <div class="calc-line">ë²•ì¸ì¹´ë“œ ì‚¬ìš©ì•¡: ${formatNumber(inputs.corporate_card)}ì›</div>
                <div class="calc-line">ë§¤ì¶œì•¡ ëŒ€ë¹„ ë¹„ìœ¨: ${((inputs.corporate_card/inputs.sales)*100).toFixed(2)}% (ì •ìƒ ë²”ìœ„: 2% ì´í•˜)</div>
                <div class="calc-line">ì´ˆê³¼ ì˜ì‹¬ì•¡: ${formatNumber(excessAmount)}ì›</div>
                <div class="calc-result">ğŸ’£ ì ë°œ ì‹œ ì˜ˆìƒ ì¶”ì§•ì„¸ì•¡: ì•½ ${formatNumber(penaltyRisk)}ì› (ì†Œë“ì„¸ 45% + ê°€ì‚°ì„¸)</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ›¡ï¸ ì¦‰ì‹œ ëŒ€ì‘ ë¡œë“œë§µ</h5>
                <ul>
                    <li><strong>ì§€ê¸ˆ:</strong> ìµœê·¼ 3ë…„ ë²•ì¸ì¹´ë“œ ì „ì²´ ë‚´ì—­ ì¦ë¹™ í™•ë³´ (ì˜ìˆ˜ì¦, ê³„ì•½ì„œ, íšŒì˜ë¡)</li>
                    <li><strong>1ì£¼ì¼ ë‚´:</strong> ê°œì¸ ì‚¬ìš© ì˜ì‹¬ ê±´ ${formatNumber(excessAmount * 0.3)}ì› ìì§„ ë°˜ë‚© ë° ì†Œë“ ì‹ ê³ </li>
                    <li><strong>ì¦‰ì‹œ:</strong> ê°œì¸ì¹´ë“œ ì™„ì „ ë¶„ë¦¬ ì‚¬ìš© ì›ì¹™ ìˆ˜ë¦½</li>
                    <li><strong>ì˜ˆìƒ ì ˆê°:</strong> ìì§„ì‹ ê³  ì‹œ ê°€ì‚°ì„¸ ë©´ì œë¡œ ì•½ ${formatNumber(penaltyRisk * 0.3)}ì› ì ˆê°</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += penaltyRisk * 0.3;
    }
    
    // ğŸ“Š 3-2. ì ‘ëŒ€ë¹„ ê³¼ë‹¤
    if (inputs.entertainment > inputs.sales * 0.03 && inputs.entertainment > 30000000) {
        analysisResult.risks.add('ì ‘ëŒ€ë¹„ ê³¼ë‹¤');
        const excessEntertainment = inputs.entertainment - (inputs.sales * 0.03);
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-utensils"></i>ì ‘ëŒ€ë¹„ í•œë„ ì´ˆê³¼ (${formatNumber(inputs.entertainment)}ì›)</h3>
            
            <div class="calc-box">
                <div class="calc-line">ì ‘ëŒ€ë¹„ ì´ì•¡: ${formatNumber(inputs.entertainment)}ì›</div>
                <div class="calc-line">ë§¤ì¶œì•¡ ëŒ€ë¹„: ${((inputs.entertainment/inputs.sales)*100).toFixed(2)}% (ì ì •: 3% ì´í•˜)</div>
                <div class="calc-line">ì´ˆê³¼ ì˜ì‹¬ì•¡: ${formatNumber(excessEntertainment)}ì›</div>
                <div class="calc-result">âš ï¸ ì†ê¸ˆë¶ˆì‚°ì… ì‹œ ë²•ì¸ì„¸ ${formatNumber(excessEntertainment * 0.21)}ì› ì¶”ê°€</div>
            </div>
            
            <p><strong>ì ‘ëŒ€ë¹„ í•œë„:</strong> ì¤‘ì†Œê¸°ì—…ì€ 1,200ë§Œì› + ë§¤ì¶œì•¡ì˜ 0.3% ë²”ìœ„ ë‚´ì—ì„œë§Œ ì†ê¸ˆì¸ì •</p>
            
            <div class="action-box">
                <h5>ğŸ“‹ ì ‘ëŒ€ë¹„ ì •ë¦¬ ë°©ì•ˆ</h5>
                <ul>
                    <li><strong>1ë‹¨ê³„:</strong> ì‹¤ì œ ì—…ë¬´ ê´€ë ¨ì„± ì¦ë¹™ ì¬í™•ì¸ (ê±°ë˜ì²˜, ê³„ì•½ ê´€ë ¨ ì—¬ë¶€)</li>
                    <li><strong>2ë‹¨ê³„:</strong> ì´ˆê³¼ë¶„ì€ ë³µë¦¬í›„ìƒë¹„ë‚˜ íšŒì˜ë¹„ë¡œ ì¬ë¶„ë¥˜ ê²€í† </li>
                    <li><strong>3ë‹¨ê³„:</strong> í–¥í›„ ì›”ë³„ ì ‘ëŒ€ë¹„ í•œë„ ê´€ë¦¬ (ì›” ${formatNumber(inputs.sales * 0.003 / 12)}ì›)</li>
                </ul>
            </div>
        </div>`;
    }
    // ğŸ“Š 4. CEO ì§€ë¶„ìœ¨ ë¦¬ìŠ¤í¬
    if (inputs.ceo_share < 30) {
        analysisResult.risks.add('ë‚®ì€ CEO ì§€ë¶„ìœ¨');
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-user-shield"></i>ê²½ì˜ê¶Œ ë¶ˆì•ˆì • - CEO ì§€ë¶„ ${inputs.ceo_share}%</h3>
            
            <p><strong>ìœ„í—˜:</strong> ì§€ë¶„ 30% ë¯¸ë§Œì€ ì ëŒ€ì  M&Aë‚˜ ì£¼ì£¼ë¶„ìŸì— ì·¨ì•½í•©ë‹ˆë‹¤.</p>
            
            <div class="calc-box">
                <div class="calc-line">í˜„ì¬ CEO ì§€ë¶„: ${inputs.ceo_share}%</div>
                <div class="calc-line">ì•ˆì „ ì§€ë¶„ìœ¨: 50% ì´ìƒ (ê²½ì˜ê¶Œ ë°©ì–´)</div>
                <div class="calc-line">ìµœì†Œ í•„ìš”: 30% ì´ìƒ (ê±°ë¶€ê¶Œ í™•ë³´)</div>
                <div class="calc-result">âš ï¸ ì¶”ê°€ í™•ë³´ í•„ìš”: ìµœì†Œ ${(30 - inputs.ceo_share).toFixed(1)}%p</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ›¡ï¸ ê²½ì˜ê¶Œ ë°©ì–´ ì „ëµ</h5>
                <ul>
                    <li><strong>1ë‹¨ê³„:</strong> ë°°ìš°ìÂ·ìë…€ì—ê²Œ 10ë…„ ì£¼ê¸° ì¦ì—¬ (5ì²œë§Œì›Ã—ì¸ì›ìˆ˜)</li>
                    <li><strong>2ë‹¨ê³„:</strong> ìš°í˜¸ì§€ë¶„ í™•ë³´ (ê°€ì¡±Â·ì„ì› ì§€ë¶„ í•©ì‚° 50% ëª©í‘œ)</li>
                    <li><strong>3ë‹¨ê³„:</strong> ì •ê´€ ê°œì • (ì¤‘ìš” ì˜ì‚¬ê²°ì • íŠ¹ë³„ê²°ì˜ ì¡°í•­)</li>
                    <li><strong>ì ˆì„¸ íš¨ê³¼:</strong> ì¦ì—¬ì„¸ ê³µì œë¡œ ìµœëŒ€ ìˆ˜ì–µì› ì ˆê°</li>
                </ul>
            </div>
        </div>`;
    } else if (inputs.ceo_share >= 30 && inputs.ceo_share < 50) {
        analysisResult.opportunities.add('ì§€ë¶„ìœ¨ ìµœì í™”');
        
        html += `<div class="consulting-topic topic-opportunity">
            <h3 class="opportunity"><i class="fas fa-chess-king"></i>ê²½ì˜ê¶Œ ê°•í™” ê¸°íšŒ - í˜„ì¬ ${inputs.ceo_share}%</h3>
            
            <p><strong>í˜„í™©:</strong> í˜„ì¬ ì§€ë¶„ìœ¨ì€ ì–‘í˜¸í•˜ë‚˜, 50% ì´ìƒ í™•ë³´ ì‹œ ì™„ì „í•œ ê²½ì˜ê¶Œì„ í–‰ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            
            <div class="action-box">
                <h5>ğŸ’ ì§€ë¶„ìœ¨ 50% ë‹¬ì„± ë¡œë“œë§µ</h5>
                <ul>
                    <li><strong>ëª©í‘œ:</strong> í˜„ì¬ ${inputs.ceo_share}% â†’ 50% (ì¶”ê°€ ${(50 - inputs.ceo_share).toFixed(1)}%p)</li>
                    <li><strong>ë°©ë²•:</strong> ìë…€Â·ë°°ìš°ì ì¦ì—¬ + ìš°í˜¸ì§€ë¶„ í•©ì‚°</li>
                    <li><strong>ê¸°ê°„:</strong> í–¥í›„ 5ë…„ ê³„íš</li>
                </ul>
            </div>
        </div>`;
    }
    
    // ğŸ“Š 5. ê°€ì¡±ì„ì§ì› ê¸‰ì—¬ ê³¼ë‹¤
    if (inputs.family_salary > inputs.op_profit * 0.3 && inputs.family_salary > 50000000) {
        analysisResult.risks.add('ê³¼ë‹¤ ê°€ì¡± ê¸‰ì—¬');
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-users"></i>ê°€ì¡± ê¸‰ì—¬ ì„¸ë¬´ë¦¬ìŠ¤í¬ (${formatNumber(inputs.family_salary)}ì›)</h3>
            
            <div class="calc-box">
                <div class="calc-line">ê°€ì¡± ì„ì§ì› ê¸‰ì—¬: ${formatNumber(inputs.family_salary)}ì›</div>
                <div class="calc-line">ì˜ì—…ì´ìµ ëŒ€ë¹„: ${((inputs.family_salary/inputs.op_profit)*100).toFixed(1)}%</div>
                <div class="calc-line">ì„¸ë¬´ì¡°ì‚¬ ê¸°ì¤€: ì˜ì—…ì´ìµì˜ 30% ì´ˆê³¼ ì‹œ ì£¼ì˜</div>
                <div class="calc-result">âš ï¸ ë¶€ë‹¹í–‰ìœ„ê³„ì‚°ë¶€ì¸ ìœ„í—˜</div>
            </div>
            
            <p><strong>ì„¸ë¬´ì¡°ì‚¬ ì‹œ:</strong> ê³¼ë‹¤ ê¸‰ì—¬ ì¸ì • ì•ˆ ë˜ë©´ ë²•ì¸ì„¸ ${formatNumber(inputs.family_salary * 0.21)}ì› ì¶”ê°€ ë‚©ë¶€!</p>
            
            <div class="action-box">
                <h5>ğŸ“‹ ì ì • ê¸‰ì—¬ ì¡°ì •ì•ˆ</h5>
                <ul>
                    <li><strong>ì›ì¹™:</strong> ë™ì¢…ì—…ê³„ ìœ ì‚¬ì§ê¸‰ ê¸‰ì—¬ ìˆ˜ì¤€ ë§ì¶¤</li>
                    <li><strong>ì¦ë¹™:</strong> ì§ë¬´ê¸°ìˆ ì„œÂ·ê·¼ë¬´ê¸°ë¡ í™•ë³´ í•„ìˆ˜</li>
                    <li><strong>ëŒ€ì•ˆ:</strong> ì´ˆê³¼ë¶„ì€ ë°°ë‹¹ìœ¼ë¡œ ì „í™˜ (ì„¸ìœ¨ 15.4%)</li>
                </ul>
            </div>
        </div>`;
    }
    
    // ğŸ“Š 6. ë°°ë‹¹ê¸ˆ ì „ëµ ë¶„ì„
    if (inputs.dividend_3years === 0 && inputs.retained_earnings > inputs.equity * 0.5) {
        analysisResult.opportunities.add('ë°°ë‹¹ ì „ëµ');
        
        html += `<div class="consulting-topic topic-opportunity">
            <h3 class="opportunity"><i class="fas fa-coins"></i>ë°°ë‹¹ ì ˆì„¸ ê¸°íšŒ - 3ë…„ê°„ ë¬´ë°°ë‹¹</h3>
            
            <p><strong>ë°œê²¬:</strong> ìµœê·¼ 3ë…„ê°„ ë°°ë‹¹ì„ í•˜ì§€ ì•Šì•˜ê³ , ì´ìµì‰ì—¬ê¸ˆì´ ${formatNumber(inputs.retained_earnings)}ì› ì ë¦½ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
            
            <div class="calc-box">
                <div class="calc-line">ë¯¸ì²˜ë¶„ì´ìµì‰ì—¬ê¸ˆ: ${formatNumber(inputs.retained_earnings)}ì›</div>
                <div class="calc-line">ê¶Œì¥ ë°°ë‹¹ì•¡: ${formatNumber(inputs.retained_earnings * 0.3)}ì›</div>
                <div class="calc-line">ë°°ë‹¹ì†Œë“ì„¸ (15.4%): ${formatNumber(inputs.retained_earnings * 0.3 * 0.154)}ì›</div>
                <div class="calc-line">ë²•ì¸ì— ë³´ìœ  ì‹œ í–¥í›„ ë²•ì¸ì„¸: ${formatNumber(inputs.retained_earnings * 0.3 * 0.21)}ì›</div>
                <div class="calc-result">âœ… ì§€ê¸ˆ ë°°ë‹¹ ì‹œ ${formatNumber(inputs.retained_earnings * 0.3 * 0.056)}ì› ì ˆì„¸</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ’° ë°°ë‹¹ vs ë‚´ë¶€ ìœ ë³´ ì‹œë®¬ë ˆì´ì…˜</h5>
                <ul>
                    <li><strong>ì‹œë‚˜ë¦¬ì˜¤ 1:</strong> ì—° ${formatNumber(inputs.retained_earnings * 0.1)}ì› ë°°ë‹¹ (10ë…„ ê³„íš)</li>
                    <li><strong>ì‹œë‚˜ë¦¬ì˜¤ 2:</strong> ì¢…í•©ì†Œë“ 5ì–µ ì´í•˜ êµ¬ê°„ í™œìš© ìµœëŒ€ ë°°ë‹¹</li>
                    <li><strong>ì¶”ì²œ:</strong> ì„¸ë¬´ì‚¬ì™€ ìµœì  ë°°ë‹¹ ì‹œê¸°Â·ê¸ˆì•¡ ì„¤ê³„</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += inputs.retained_earnings * 0.3 * 0.056;
    }
    
    // ğŸ“Š 7. ë¶€ë™ì‚° ëª…ì˜ ìµœì í™”
    if (inputs.corp_real_estate_value > 0 || inputs.personal_real_estate_value > 0) {
        const totalRealEstate = inputs.corp_real_estate_value + inputs.personal_real_estate_value;
        const corpRatio = totalRealEstate > 0 ? (inputs.corp_real_estate_value / totalRealEstate) * 100 : 0;
        
        if (corpRatio > 70) {
            analysisResult.risks.add('ë²•ì¸ ë¶€ë™ì‚° ì§‘ì¤‘');
            
            html += `<div class="consulting-topic topic-warning">
                <h3 class="warning"><i class="fas fa-building"></i>ë¶€ë™ì‚° ëª…ì˜ ë¶ˆê· í˜• - ë²•ì¸ ì§‘ì¤‘ ${corpRatio.toFixed(0)}%</h3>
                
                <div class="calc-box">
                    <div class="calc-line">ë²•ì¸ ë¶€ë™ì‚°: ${formatNumber(inputs.corp_real_estate_value)}ì› (${corpRatio.toFixed(0)}%)</div>
                    <div class="calc-line">ê°œì¸ ë¶€ë™ì‚°: ${formatNumber(inputs.personal_real_estate_value)}ì› (${(100-corpRatio).toFixed(0)}%)</div>
                    <div class="calc-result">âš ï¸ ë²•ì¸ ì²­ì‚° ì‹œ ì–‘ë„ì„¸ í­íƒ„ ìœ„í—˜</div>
                </div>
                
                <div class="action-box">
                    <h5>ğŸ¢ ë¶€ë™ì‚° ëª…ì˜ ì¬ë°°ì¹˜ ì „ëµ</h5>
                    <ul>
                        <li><strong>ì—…ë¬´ìš©:</strong> ë²•ì¸ ë³´ìœ  (ê°ê°€ìƒê° ì†ê¸ˆ ì¸ì •)</li>
                        <li><strong>íˆ¬ììš©:</strong> ê°œì¸ ë³´ìœ  (1ì„¸ëŒ€ 1ì£¼íƒ ë¹„ê³¼ì„¸ í™œìš©)</li>
                        <li><strong>ì£¼ì˜:</strong> ë²•ì¸â†’ê°œì¸ ì´ì „ ì‹œ ë¶€ë‹¹í–‰ìœ„ê³„ì‚° ê²€í†  í•„ìˆ˜</li>
                    </ul>
                </div>
            </div>`;
        } else if (corpRatio < 30 && inputs.corp_real_estate_value > 0) {
            analysisResult.opportunities.add('ë¶€ë™ì‚° ì „ëµ');
        }
    }
    
    // ğŸ“Š 8. íŠ¹í—ˆê¶Œ ë“± ì§€ì‹ì¬ì‚°ê¶Œ
    if (inputs.ip_ownership === 'yes') {
        analysisResult.risks.add('ê°œì¸ ë³´ìœ  ì§€ì¬ê¶Œ');
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-lightbulb"></i>ì§€ì‹ì¬ì‚°ê¶Œ ëª…ì˜ ë¦¬ìŠ¤í¬</h3>
            
            <p><strong>ë¬¸ì œ:</strong> íŠ¹í—ˆê¶ŒÂ·ìƒí‘œê¶Œì„ ê°œì¸ì´ ë³´ìœ í•˜ê³  ë²•ì¸ì´ ì‚¬ìš©í•˜ë©´ <span style="color:#b03a2e;">ë¡œì—´í‹° ì†Œë“ì„¸</span> ë°œìƒ!</p>
            
            <div class="calc-box">
                <div class="calc-line">ì˜ˆìƒ ë¡œì—´í‹°: ë§¤ì¶œì˜ 3~5% (${formatNumber(inputs.sales * 0.04)}ì›)</div>
                <div class="calc-line">ê°œì¸ ì†Œë“ì„¸ (ì¢…í•©ê³¼ì„¸): ìµœëŒ€ 45%</div>
                <div class="calc-result">âš ï¸ ì—°ê°„ ì„¸ê¸ˆ ë¶€ë‹´: ì•½ ${formatNumber(inputs.sales * 0.04 * 0.45)}ì›</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ’¡ ì§€ì¬ê¶Œ ì´ì „ ì „ëµ</h5>
                <ul>
                    <li><strong>ë°©ë²• 1:</strong> í˜„ë¬¼ì¶œìë¡œ ë²•ì¸ ì´ì „ (ì¦ì—¬ì„¸ ì ˆê°)</li>
                    <li><strong>ë°©ë²• 2:</strong> ë²•ì¸ì´ ë§¤ì… (ì¥ê¸° ë¶„í•  ì§€ê¸‰)</li>
                    <li><strong>íš¨ê³¼:</strong> ë¡œì—´í‹° ì†Œë“ì„¸ ${formatNumber(inputs.sales * 0.04 * 0.45)}ì› â†’ 0ì›</li>
                    <li><strong>ì£¼ì˜:</strong> ì‹œê°€ í‰ê°€ í•„ìˆ˜ (ì„¸ë¬´ì‚¬ ê°ì •)</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += inputs.sales * 0.04 * 0.45;
    }
    
    // ğŸ“Š 9. ê³ ìš©ì¦ëŒ€ ì„¸ì•¡ê³µì œ ë¯¸ì‹ ì²­
    if (inputs.employment_credit === 'no' && inputs.total_employees >= 10) {
        const estimatedCredit = Math.min(inputs.total_employees * 3000000, 50000000);
        analysisResult.opportunities.add('ê³ ìš©ì¦ëŒ€ ì„¸ì•¡ê³µì œ');
        
        html += `<div class="consulting-topic topic-opportunity">
            <h3 class="opportunity"><i class="fas fa-user-plus"></i>ê³ ìš©ì¦ëŒ€ ì„¸ì•¡ê³µì œ ë¯¸ì‹ ì²­ (${formatNumber(estimatedCredit)}ì› ì†ì‹¤)</h3>
            
            <div class="calc-box">
                <div class="calc-line">í˜„ì¬ ì„ì§ì›: ${inputs.total_employees}ëª…</div>
                <div class="calc-line">ê³ ìš©ì¦ëŒ€ 1ì¸ë‹¹ ê³µì œ: ìµœëŒ€ 300ë§Œì›</div>
                <div class="calc-result">ğŸ’° ì˜ˆìƒ í™˜ê¸‰ì•¡: ${formatNumber(estimatedCredit)}ì›</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ“ ì¦‰ì‹œ ì‹ ì²­ í”„ë¡œì„¸ìŠ¤</h5>
                <ul>
                    <li><strong>1ë‹¨ê³„:</strong> ì „ë…„ ëŒ€ë¹„ ê³ ìš© ì¦ê°€ ì¸ì› í™•ì¸</li>
                    <li><strong>2ë‹¨ê³„:</strong> ë²•ì¸ì„¸ ì‹ ê³  ì‹œ ì„¸ì•¡ê³µì œ ì‹ ì²­</li>
                    <li><strong>3ë‹¨ê³„:</strong> ìµœê·¼ 3ë…„ì¹˜ ê²½ì •ì²­êµ¬ ê°€ëŠ¥</li>
                    <li><strong>ì˜ˆìƒ í™˜ê¸‰:</strong> ${formatNumber(estimatedCredit * 3)}ì› (3ë…„ë¶„)</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += estimatedCredit * 3;
    }
    
    // ğŸ“Š 10. R&D ì„¸ì•¡ê³µì œ ë¯¸ì‹ ì²­
    if (inputs.rnd_credit === 'no' && (inputs.industry === 'IT/ì†Œí”„íŠ¸ì›¨ì–´' || inputs.industry === 'ì œì¡°ì—…')) {
        const estimatedRnD = inputs.sales * 0.02;
        const rnDCredit = estimatedRnD * 0.25;
        analysisResult.opportunities.add('R&D ì„¸ì•¡ê³µì œ');
        
        html += `<div class="consulting-topic topic-opportunity">
            <h3 class="opportunity"><i class="fas fa-flask"></i>R&D ì„¸ì•¡ê³µì œ ë¯¸ì‹ ì²­ - ${inputs.industry}</h3>
            
            <p><strong>${inputs.industry} ì—…ì¢…</strong>ì€ R&D ì„¸ì•¡ê³µì œ ëŒ€ìƒì…ë‹ˆë‹¤!</p>
            
            <div class="calc-box">
                <div class="calc-line">ì¶”ì • R&D ë¹„ìš©: ${formatNumber(estimatedRnD)}ì› (ë§¤ì¶œì˜ 2%)</div>
                <div class="calc-line">ì„¸ì•¡ê³µì œìœ¨: ì¼ë°˜ 25% / ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€ ìµœëŒ€ 40%</div>
                <div class="calc-result">ğŸ’° ì˜ˆìƒ ê³µì œì•¡: ${formatNumber(rnDCredit)}ì›</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ”¬ R&D ì„¸ì•¡ê³µì œ ëŒ€ìƒ</h5>
                <ul>
                    <li><strong>ì¸ê±´ë¹„:</strong> ì—°êµ¬ê°œë°œ ì¸ë ¥ ê¸‰ì—¬</li>
                    <li><strong>ì¬ë£Œë¹„:</strong> ì‹œì œí’ˆ ì œì‘ë¹„ìš©</li>
                    <li><strong>ìœ„íƒë¹„:</strong> ì™¸ë¶€ ì—°êµ¬ê¸°ê´€ ìš©ì—­</li>
                    <li><strong>ê°ê°€ìƒê°ë¹„:</strong> ì—°êµ¬ìš© ì¥ë¹„</li>
                    <li><strong>ì‹ ì²­:</strong> êµ­ì„¸ì²­ R&D ì„¸ì•¡ê³µì œ ì‹ ì²­ì„œ ì œì¶œ</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += rnDCredit;
    }
    
    // ğŸ“Š 11. ê°œì¸ ë¶€ì±„ ê³¼ë‹¤
    if (inputs.personal_debt > inputs.personal_financial) {
        analysisResult.risks.add('ê°œì¸ ë¶€ì±„ ê³¼ë‹¤');
        
        html += `<div class="consulting-topic topic-danger">
            <h3 class="danger"><i class="fas fa-exclamation-triangle"></i>ê°œì¸ ë¶€ì±„ ë¶€ì‹¤ ìœ„í—˜</h3>
            
            <div class="calc-box">
                <div class="calc-line">ê°œì¸ ë¶€ì±„: ${formatNumber(inputs.personal_debt)}ì›</div>
                <div class="calc-line">ê°œì¸ ê¸ˆìœµìì‚°: ${formatNumber(inputs.personal_financial)}ì›</div>
                <div class="calc-result">âš ï¸ ìˆœë¶€ì±„: ${formatNumber(inputs.personal_debt - inputs.personal_financial)}ì›</div>
            </div>
            
            <p><strong>ìœ„í—˜:</strong> ê°œì¸ ë¶€ì±„ê°€ ìì‚°ì„ ì´ˆê³¼í•˜ë©´ CEO ì‹ ìš©ë„ í•˜ë½ â†’ ë²•ì¸ ëŒ€ì¶œì—ë„ ì•…ì˜í–¥!</p>
            
            <div class="action-box">
                <h5>ğŸ’³ ê°œì¸ ë¶€ì±„ ì •ë¦¬ ì „ëµ</h5>
                <ul>
                    <li><strong>ë‹¨ê¸°:</strong> ê³ ê¸ˆë¦¬ ë¶€ì±„ë¶€í„° ìƒí™˜ (ì—° 10% ì´ìƒ ëŒ€ì¶œ)</li>
                    <li><strong>ì¤‘ê¸°:</strong> ë²•ì¸ ë°°ë‹¹ìœ¼ë¡œ ê°œì¸ ë¶€ì±„ ìƒí™˜</li>
                    <li><strong>ì¥ê¸°:</strong> ê°œì¸ ìì‚° ë§¤ê° ë˜ëŠ” ë²•ì¸ í‡´ì§ê¸ˆ í™œìš©</li>
                </ul>
            </div>
        </div>`;
    }
    
    // ğŸ“Š 12. ìë…€ ì¦ì—¬ ê³„íš
    if (inputs.gift_history === 0 && inputs.inheritance_assets > 1000000000) {
        analysisResult.opportunities.add('ì¦ì—¬ ì ˆì„¸');
        
        const childrenCount = document.querySelectorAll('#children-container .dynamic-container').length;
        const giftPotential = childrenCount * 50000000;
        
        html += `<div class="consulting-topic topic-opportunity">
            <h3 class="opportunity"><i class="fas fa-gift"></i>ìë…€ ì¦ì—¬ ì ˆì„¸ ê¸°íšŒ</h3>
            
            <p><strong>ë°œê²¬:</strong> ìë…€ì—ê²Œ ì¦ì—¬ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤. 10ë…„ ì£¼ê¸° ì¦ì—¬ë¡œ ìƒì†ì„¸ë¥¼ ëŒ€í­ ì ˆê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
            
            <div class="calc-box">
                <div class="calc-line">ìë…€ ìˆ˜: ${childrenCount}ëª…</div>
                <div class="calc-line">1ì¸ë‹¹ 10ë…„ ê³µì œ: 5ì²œë§Œì›</div>
                <div class="calc-line">ì´ ì¦ì—¬ ê°€ëŠ¥ì•¡ (ë¬´ì„¸): ${formatNumber(giftPotential)}ì›</div>
                <div class="calc-result">ğŸ’° ìƒì†ì„¸ ì ˆê° íš¨ê³¼: ì•½ ${formatNumber(giftPotential * 0.4)}ì›</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ 10ë…„ ì¦ì—¬ í”Œëœ</h5>
                <ul>
                    <li><strong>1ì°¨ ì¦ì—¬ (ì˜¬í•´):</strong> ìë…€ë‹¹ 5ì²œë§Œì› (ì´ ${formatNumber(giftPotential)}ì›)</li>
                    <li><strong>2ì°¨ ì¦ì—¬ (10ë…„ í›„):</strong> ìë…€ë‹¹ 5ì²œë§Œì›</li>
                    <li><strong>3ì°¨ ì¦ì—¬ (20ë…„ í›„):</strong> ìë…€ë‹¹ 5ì²œë§Œì›</li>
                    <li><strong>ì´ ì ˆì„¸ì•¡:</strong> 30ë…„ê°„ ì•½ ${formatNumber(giftPotential * 0.4 * 3)}ì›</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += giftPotential * 0.4;
    }
    
    // ğŸ“Š 13. ê°€ì—…ìŠ¹ê³„ ì¤€ë¹„ ìƒíƒœ
    if (inputs.successor === 'yes' && inputs.succession_plan === 'no') {
        analysisResult.risks.add('ê°€ì—…ìŠ¹ê³„ ë¯¸ì¤€ë¹„');
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-handshake"></i>í›„ê³„ìëŠ” ìˆì§€ë§Œ ìŠ¹ê³„ ê³„íš ì—†ìŒ</h3>
            
            <p><strong>ëª¨ìˆœ:</strong> ìŠ¹ê³„ ì˜ˆì • í›„ê³„ìê°€ ìˆì§€ë§Œ êµ¬ì²´ì  ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p>
            
            <div class="calc-box">
                <div class="calc-line">ê°€ì—…ìŠ¹ê³„ ê³µì œ í•œë„: ìµœëŒ€ 600ì–µì›</div>
                <div class="calc-line">ìƒì†ì„¸ ì ˆê°: ìµœëŒ€ 50% (300ì–µì›)</div>
                <div class="calc-result">âš ï¸ ê³„íš ì—†ìœ¼ë©´ ê³µì œ ëª» ë°›ìŒ!</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ“‹ ê°€ì—…ìŠ¹ê³„ 7ë…„ ì²´í¬ë¦¬ìŠ¤íŠ¸</h5>
                <ul>
                    <li><strong>ìš”ê±´ 1:</strong> ì—…ë ¥ 10ë…„ ì´ìƒ (í˜„ì¬: ${inputs.founding_year ? new Date().getFullYear() - inputs.founding_year : 0}ë…„)</li>
                    <li><strong>ìš”ê±´ 2:</strong> CEO 10ë…„ ì´ìƒ ê²½ì˜</li>
                    <li><strong>ìš”ê±´ 3:</strong> í›„ê³„ì 2ë…„ ì´ìƒ ê·¼ë¬´</li>
                    <li><strong>ìš”ê±´ 4:</strong> ìµœëŒ€ì£¼ì£¼ + ì§€ë¶„ 50% ì´ìƒ</li>
                    <li><strong>ìš”ê±´ 5:</strong> ìƒì† í›„ 7ë…„ê°„ ì—…ì¢…Â·ì •ê·œì§ ìœ ì§€</li>
                </ul>
            </div>
        </div>`;
    }
    
    // ê¸°ì¡´ ì»¨ì„¤íŒ… ë‚´ìš© ì¶”ê°€ (ê°€ì§€ê¸‰ê¸ˆ, ì´ìµì‰ì—¬ê¸ˆ ë“±)
if (inputs.adv_payments > 1000000) {
  const annualInterest = inputs.adv_payments * 0.046;
  const taxOnInterest = annualInterest * 0.45;
  const corporateTaxLoss = annualInterest * 0.21;
  const type = inputs.adv_payments > 50000000 ? 'danger' : 'warning';

  // --- [ ì—¬ê¸°ì— ìƒˆ ê³„ì‚° ë¡œì§ ì‚½ì… ] ---
  const annualLoss = taxOnInterest + corporateTaxLoss;
  const threeYearLoss = annualLoss * 3;
  const solutionGain = (taxOnInterest + corporateTaxLoss) * 10;

  // Setì—ëŠ” ë¬¸ìì—´ë§Œ ì¶”ê°€ (ìš”ì•½ ë¡œì§ê³¼ ì¼ì¹˜)
  analysisResult.risks.add('ê³ ì•¡ ê°€ì§€ê¸‰ê¸ˆ');

    // ---------------------------------
    
    html += `<div class="consulting-topic topic-${type}">
        <h3 class="${type}"><i class="fas fa-exclamation-triangle"></i>ê°€ì§€ê¸‰ê¸ˆ ì‹œí•œí­íƒ„ (${formatNumber(inputs.adv_payments)}ì›)</h3>
        
        <div class="calc-box">
            <div class="calc-line">ê°€ì§€ê¸‰ê¸ˆ: ${formatNumber(inputs.adv_payments)}ì›</div>
            <div class="calc-line">ì—°ê°„ ì¸ì •ì´ì (4.6%): ${formatNumber(annualInterest)}ì›</div>
            <div class="calc-line">ëŒ€í‘œì´ì‚¬ ì†Œë“ì„¸ (45%): ${formatNumber(taxOnInterest)}ì›</div>
            <div class="calc-line">ë²•ì¸ì„¸ ê°€ì‚° (ì´ìë¹„ìš© ë¶€ì¸): ${formatNumber(corporateTaxLoss)}ì›</div>
            <div class="calc-result">ğŸ’£ ë§¤ë…„ ì„¸ê¸ˆ ì†ì‹¤: ${formatNumber(taxOnInterest + corporateTaxLoss)}ì›</div>
        </div>
        
        <p><strong>ìƒì† ì‹œ ì¶©ê²©:</strong> ê°€ì§€ê¸‰ê¸ˆ ${formatNumber(inputs.adv_payments)}ì›ì€ ìƒì†ì¬ì‚°ì— í¬í•¨ë˜ì–´ ìƒì†ì„¸ ì•½ ${formatNumber(inputs.adv_payments * 0.4)}ì› ì¶”ê°€ ë°œìƒ!</p>
        
        <div class="action-box">
            <h5>ğŸ”¥ ê¸´ê¸‰ ì •ë¦¬ ì†”ë£¨ì…˜</h5>
            <ul>
                <li><strong>ë°©ë²• 1:</strong> ì¦‰ì‹œ í˜„ê¸ˆ ìƒí™˜ (ê°œì¸ ìê¸ˆ í™œìš©)</li>
                <li><strong>ë°©ë²• 2:</strong> í–¥í›„ ìƒì—¬/ë°°ë‹¹ìœ¼ë¡œ ìƒê³„ (ì—° ${formatNumber(inputs.adv_payments * 0.2)}ì›ì”© 5ë…„)</li>
                <li><strong>ë°©ë²• 3:</strong> ë²•ì¸ ë³´í—˜ í•´ì•½í™˜ê¸‰ê¸ˆìœ¼ë¡œ ìƒê³„ (10ë…„ í›„)</li>
                <li><strong>ì ˆì„¸ íš¨ê³¼:</strong> ì „ì•¡ ì •ë¦¬ ì‹œ ë§¤ë…„ ${formatNumber(taxOnInterest + corporateTaxLoss)}ì› Ã— 10ë…„ = <strong>${formatNumber((taxOnInterest + corporateTaxLoss) * 10)}ì› ì ˆê°</strong></li>
            </ul>
        </div>
    </div>`;
    totalTaxSavings += (taxOnInterest + corporateTaxLoss) * 10;
}    
    // 2. ì´ìµì‰ì—¬ê¸ˆ ê³¼ë‹¤ ì ë¦½ ë¦¬ìŠ¤í¬
    if (inputs.retained_earnings > inputs.equity && inputs.retained_earnings > 500000000) {
        const dividendOption = inputs.retained_earnings * 0.3;
        const dividendTax = dividendOption * 0.154;
        const corporateTaxIfKept = dividendOption * 0.21;
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-coins"></i>ì´ìµì‰ì—¬ê¸ˆ ê³¼ë‹¤ ì ë¦½ ë¦¬ìŠ¤í¬</h3>
            
            <div class="calc-box">
                <div class="calc-line">ë¯¸ì²˜ë¶„ì´ìµì‰ì—¬ê¸ˆ: ${formatNumber(inputs.retained_earnings)}ì›</div>
                <div class="calc-line">ìë³¸ì´ê³„: ${formatNumber(inputs.equity)}ì›</div>
                <div class="calc-line">ë¹„ìœ¨: ${((inputs.retained_earnings/inputs.equity)*100).toFixed(1)}% (ì •ìƒ: 50% ì´í•˜)</div>
                <div class="calc-result">âš ï¸ ë²•ì¸ì„¸ vs ë°°ë‹¹ì„¸ ë¹„êµ í•„ìˆ˜!</div>
            </div>
            
            <div class="calc-box">
                <div class="calc-line"><strong>ì‹œë‚˜ë¦¬ì˜¤ A: ë²•ì¸ì— ê³„ì† ìŒ“ê¸°</strong></div>
                <div class="calc-line">ë²•ì¸ì„¸ (21%): ${formatNumber(corporateTaxIfKept)}ì›</div>
                <div class="calc-line">+ í–¥í›„ ë°°ë‹¹ ì‹œ ë°°ë‹¹ì†Œë“ì„¸ ì¶”ê°€</div>
                
                <div class="calc-line" style="margin-top:0.5rem;"><strong>ì‹œë‚˜ë¦¬ì˜¤ B: ì§€ê¸ˆ ë°°ë‹¹</strong></div>
                <div class="calc-line">ë°°ë‹¹ì†Œë“ì„¸ (15.4%): ${formatNumber(dividendTax)}ì›</div>
                <div class="calc-result">âœ… ì¦‰ì‹œ ë°°ë‹¹ ì‹œ ${formatNumber(corporateTaxIfKept - dividendTax)}ì› ì ˆì„¸</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ’ ì´ìµì‰ì—¬ê¸ˆ ì¶œêµ¬ì „ëµ (4ê°€ì§€)</h5>
                <ul>
                    <li><strong>ì „ëµ 1:</strong> ë°°ë‹¹ (ì¢…í•©ì†Œë“ 5ì–µ ì´í•˜ ì‹œ ìœ ë¦¬)</li>
                    <li><strong>ì „ëµ 2:</strong> íŠ¹í—ˆê¶Œ í˜„ë¬¼ì¶œìë¡œ ìë³¸ê¸ˆ ì¦ì•¡ (ì´ìµì‰ì—¬ê¸ˆ â†’ ìë³¸ê¸ˆ ì „í™˜)</li>
                    <li><strong>ì „ëµ 3:</strong> ì„ì§ì› ì„±ê³¼ê¸‰ ì§€ê¸‰ (ì†ê¸ˆì‚°ì…)</li>
                    <li><strong>ì „ëµ 4:</strong> ì¤€ë¹„ê¸ˆ ì„¤ì • (í‡´ì§ê¸‰ì—¬ì¶©ë‹¹ê¸ˆ, ëŒ€ì†ì¶©ë‹¹ê¸ˆ ë“±)</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += Math.max(0, corporateTaxIfKept - dividendTax);
    }
    
    // 3. ë²•ì¸ì¹´ë“œ ì‚¬ì ì‚¬ìš©
    if (inputs.corporate_card > inputs.sales * 0.02 && inputs.corporate_card > 50000000) {
        analysisResult.risks.add('ë²•ì¸ì¹´ë“œ ì‚¬ì ì‚¬ìš© ì˜ì‹¬');
        const excessAmount = inputs.corporate_card - (inputs.sales * 0.02);
        const penaltyRisk = excessAmount * 0.45;
        
        html += `<div class="consulting-topic topic-danger">
            <h3 class="danger"><i class="fas fa-credit-card"></i>ë²•ì¸ì¹´ë“œ ì„¸ë¬´ì¡°ì‚¬ ê³ ìœ„í—˜ (1ìˆœìœ„ ê²€í† ëŒ€ìƒ)</h3>
            
            <div class="calc-box">
                <div class="calc-line">ë²•ì¸ì¹´ë“œ ì‚¬ìš©ì•¡: ${formatNumber(inputs.corporate_card)}ì›</div>
                <div class="calc-line">ë§¤ì¶œì•¡ ëŒ€ë¹„ ë¹„ìœ¨: ${((inputs.corporate_card/inputs.sales)*100).toFixed(2)}% (ì •ìƒ ë²”ìœ„: 2% ì´í•˜)</div>
                <div class="calc-line">ì´ˆê³¼ ì˜ì‹¬ì•¡: ${formatNumber(excessAmount)}ì›</div>
                <div class="calc-result">ğŸ’£ ì ë°œ ì‹œ ì˜ˆìƒ ì¶”ì§•ì„¸ì•¡: ì•½ ${formatNumber(penaltyRisk)}ì› (ì†Œë“ì„¸ 45% + ê°€ì‚°ì„¸)</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ›¡ï¸ ì¦‰ì‹œ ëŒ€ì‘ ë¡œë“œë§µ</h5>
                <ul>
                    <li><strong>ì§€ê¸ˆ:</strong> ìµœê·¼ 3ë…„ ë²•ì¸ì¹´ë“œ ì „ì²´ ë‚´ì—­ ì¦ë¹™ í™•ë³´ (ì˜ìˆ˜ì¦, ê³„ì•½ì„œ, íšŒì˜ë¡)</li>
                    <li><strong>1ì£¼ì¼ ë‚´:</strong> ê°œì¸ ì‚¬ìš© ì˜ì‹¬ ê±´ ${formatNumber(excessAmount * 0.3)}ì› ìì§„ ë°˜ë‚© ë° ì†Œë“ ì‹ ê³ </li>
                    <li><strong>ì¦‰ì‹œ:</strong> ê°œì¸ì¹´ë“œ ì™„ì „ ë¶„ë¦¬ ì‚¬ìš© ì›ì¹™ ìˆ˜ë¦½</li>
                    <li><strong>ì˜ˆìƒ ì ˆê°:</strong> ìì§„ì‹ ê³  ì‹œ ê°€ì‚°ì„¸ ë©´ì œë¡œ ì•½ ${formatNumber(penaltyRisk * 0.3)}ì› ì ˆê°</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += penaltyRisk * 0.3;
    }
    
    // 4. ëª…ì˜ì‹ íƒ
    if (inputs.nominee_stock === 'yes') {
        const stockValue = calculateStockValue(inputs);
        const giftTax = stockValue * 0.5;
        analysisResult.risks.add('ëª…ì˜ì‹ íƒ');
        
        html += `<div class="consulting-topic topic-danger">
            <h3 class="danger"><i class="fas fa-bomb"></i>ëª…ì˜ì‹ íƒì£¼ì‹ = ìµœì•…ì˜ ì‹œí•œí­íƒ„ (ì¦‰ì‹œ í•´ê²° í•„ìˆ˜)</h3>
            
            <div class="calc-box">
                <div class="calc-line">ì¶”ì • ì£¼ì‹ ê°€ì¹˜: ${formatNumber(stockValue)}ì›</div>
                <div class="calc-line">ì¦ì—¬ì„¸ (ìµœëŒ€ 50%): ${formatNumber(giftTax)}ì›</div>
                <div class="calc-line">+ ê³¼íƒœë£Œ (5ì–µ í•œë„)</div>
                <div class="calc-line">+ ì¡°ì„¸í¬íƒˆì£„ (5ë…„ ì´í•˜ ì§•ì—­ or í¬íƒˆì„¸ì•¡ì˜ 3ë°°)</div>
                <div class="calc-result">ğŸ’€ ì´ ì„¸ê¸ˆí­íƒ„: ìµœì†Œ ${formatNumber(giftTax * 1.2)}ì›</div>
            </div>
            
            <p><strong>ì‹¤ì œ íŒë¡€:</strong> Eì‚¬ ëŒ€í‘œëŠ” ëª…ì˜ì‹ íƒ ì ë°œë˜ì–´ ì¦ì—¬ì„¸ 18ì–µ + ê³¼íƒœë£Œ 3ì–µ + ì§•ì—­ 2ë…„ ì§‘í–‰ìœ ì˜ˆ ì„ ê³ </p>
            
            <div class="action-box">
                <h5>ğŸš¨ 72ì‹œê°„ ë‚´ ì‹¤í–‰í•  ê²ƒ (ì§„ì§œì…ë‹ˆë‹¤)</h5>
                <ul>
                    <li><strong>ì¦‰ì‹œ:</strong> ì„¸ë¬´ì‚¬ì™€ ê¸´ê¸‰ ë¯¸íŒ…</li>
                    <li><strong>3ì¼ ë‚´:</strong> ëª…ì˜ì‹ íƒì£¼ì‹ ì‹¤ì œì†Œìœ ì í™•ì¸ ì‹ ì²­ (êµ­ì„¸ì²­)</li>
                    <li><strong>íš¨ê³¼:</strong> í™•ì¸ ì‹ ì²­ ì‹œ ì¦ì—¬ì„¸ ë©´ì œ, ê³¼íƒœë£Œë§Œ ë‚©ë¶€ (ì•½ ${formatNumber(giftTax * 0.05)}ì›)</li>
                    <li><strong>ì ˆê°ì•¡:</strong> ${formatNumber(giftTax * 0.95)}ì› (ë‹¨, ì§€ê¸ˆ ë°”ë¡œ í•´ì•¼ í•¨!)</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += giftTax * 0.95;
    }
    
    // 5. 5ê°œë…„ ì„¸ê¸ˆí™˜ê¸‰ (ê²½ì •ì²­êµ¬) ê¸°íšŒ
    if (inputs.tax_return_review === 'no') {
        const potentialRefund = inputs.tax_expense * 0.15;
        analysisResult.opportunities.add('ê²½ì •ì²­êµ¬');
        
        html += `<div class="consulting-topic topic-opportunity">
            <h3 class="opportunity"><i class="fas fa-search-dollar"></i>5ê°œë…„ ì„¸ê¸ˆí™˜ê¸‰ (ê²½ì •ì²­êµ¬) ê¸°íšŒ</h3>
            
            <div class="calc-box">
                <div class="calc-line">ìµœê·¼ 5ë…„ ë‚©ë¶€ ì„¸ì•¡: ì•½ ${formatNumber(inputs.tax_expense * 5)}ì›</div>
                <div class="calc-line">ì¼ë°˜ì  ê³¼ì˜¤ë‚©ë¥ : 10~20%</div>
                <div class="calc-result">ğŸ’° ì˜ˆìƒ í™˜ê¸‰ì•¡: ${formatNumber(potentialRefund)}ì› ~ ${formatNumber(potentialRefund * 1.3)}ì›</div>
            </div>
            
            <p><strong>ì‹¤ì œ í™˜ê¸‰ ì‚¬ë¡€:</strong></p>
            <ul style="margin-left: 1.5rem;">
                <li>Bì œì¡°ì‚¬: í†µí•©íˆ¬ìì„¸ì•¡ê³µì œ ëˆ„ë½ â†’ <strong>1.8ì–µì› í™˜ê¸‰</strong></li>
                <li>Cìœ í†µì‚¬: ê³ ìš©ì¦ëŒ€ ì„¸ì•¡ê³µì œ ë¯¸ì‹ ì²­ â†’ <strong>9,500ë§Œì› í™˜ê¸‰</strong></li>
                <li>Dê±´ì„¤ì‚¬: ì¤€ë¹„ê¸ˆ ì„¤ì • ì˜¤ë¥˜ â†’ <strong>1.2ì–µì› í™˜ê¸‰</strong></li>
            </ul>
            
            <div class="action-box">
                <h5>ğŸ“‹ ê²½ì •ì²­êµ¬ í”„ë¡œì„¸ìŠ¤</h5>
                <ul>
                    <li><strong>1ë‹¨ê³„:</strong> ì „ë¬¸ ì„¸ë¬´ë²•ì¸ ì˜ë¢° (ë³´í†µ í™˜ê¸‰ì•¡ì˜ 20~30% ì„±ê³µë³´ìˆ˜)</li>
                    <li><strong>2ë‹¨ê³„:</strong> 5ë…„ì¹˜ ì„¸ë¬´ì‹ ê³  ì „ìˆ˜ ê²€í†  (ì†Œìš”ê¸°ê°„: 2~3ê°œì›”)</li>
                    <li><strong>3ë‹¨ê³„:</strong> ê²½ì •ì²­êµ¬ì„œ ì œì¶œ ë° í™˜ê¸‰ (3~6ê°œì›”)</li>
                    <li><strong>ë¹„ìš© ëŒ€ë¹„ íš¨ê³¼:</strong> ìˆ˜ìˆ˜ë£Œ ${formatNumber(potentialRefund * 0.25)}ì› ì§€ë¶ˆí•´ë„ ìˆœìˆ˜ìµ ${formatNumber(potentialRefund * 0.75)}ì›</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += potentialRefund * 0.75;
    }
    
    // 6. ì„ì› ìœ ì¡± ìœ„ë¡œê¸ˆ ê·œì • ë¯¸ë¹„
    if (inputs.consolation_regulation === 'no') {
        analysisResult.risks.add('ìœ ì¡± ë³´ìƒ ì¬ì›');
        const consolationAmount = inputs.op_profit * 3;
        
        html += `<div class="consulting-topic topic-warning">
            <h3 class="warning"><i class="fas fa-file-contract"></i>ì„ì› ìœ ì¡± ìœ„ë¡œê¸ˆ ê·œì • ë¯¸ë¹„</h3>
            
            <p><strong>ë¬¸ì œ:</strong> CEO ìœ ê³  ì‹œ ìœ ì¡±ì—ê²Œ ì§€ê¸‰í•˜ëŠ” ìœ„ë¡œê¸ˆì´ ê·œì • ì—†ì´ëŠ” ì†ê¸ˆ(ë¹„ìš©)ìœ¼ë¡œ ì¸ì •ë°›ì§€ ëª»í•©ë‹ˆë‹¤.</p>
            
            <div class="calc-box">
                <div class="calc-line">í†µìƒ ìœ„ë¡œê¸ˆ ê·œëª¨: í‰ê·  ë³´ìˆ˜ì˜ 3ë°°</div>
                <div class="calc-line">ì˜ˆìƒ ê¸ˆì•¡: ì•½ ${formatNumber(consolationAmount)}ì›</div>
                <div class="calc-result">ğŸ’¸ ê·œì • ì—†ì´ ì§€ê¸‰ ì‹œ ë²•ì¸ì„¸: ${formatNumber(consolationAmount * 0.21)}ì› ì¶”ê°€ ë¶€ë‹´</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ“ ì¦‰ì‹œ ì¡°ì¹˜ ì‚¬í•­</h5>
                <ul>
                    <li><strong>1ì£¼ì¼ ë‚´:</strong> ì„ì›ë³´ìˆ˜ê·œì •ì— ìœ ì¡±ìœ„ë¡œê¸ˆ ì¡°í•­ ì‹ ì„¤</li>
                    <li><strong>2ì£¼ì¼ ë‚´:</strong> ë²•ì¸ ëª…ì˜ ìƒëª…ë³´í—˜ìœ¼ë¡œ ì¬ì› í™•ë³´</li>
                    <li><strong>íš¨ê³¼:</strong> ë²•ì¸ì„¸ ${formatNumber(consolationAmount * 0.21)}ì› ì ˆê° + ìœ ì¡± ë³´í˜¸</li>
                </ul>
            </div>
        </div>`;
    }
    
    // 7. ìƒì†ì„¸
    if (inputs.inheritance_assets > 1000000000) {
        const taxInfo = estimateInheritanceTax(inputs.inheritance_assets, inputs.co_heirs);
        analysisResult.estimatedInheritanceTax = taxInfo.tax;
        const liquidAssets = inputs.personal_financial + inputs.life_insurance;
        const gap = taxInfo.tax - liquidAssets;
        
        if (gap > 0) {
            analysisResult.risks.add('ìƒì†ì„¸ í­íƒ„');
            
            html += `<div class="consulting-topic topic-danger">
                <h3 class="danger"><i class="fas fa-skull-crossbones"></i>ìƒì†ì„¸ í­íƒ„ (í˜„ê¸ˆ ë‚©ë¶€ ë¶ˆê°€ëŠ¥)</h3>
                
                <div class="calc-box">
                    <div class="calc-line"><strong>ìƒì†ì¬ì‚° êµ¬ì„±</strong></div>
                    <div class="calc-line">ê°œì¸ ê¸ˆìœµìì‚°: ${formatNumber(inputs.personal_financial)}ì›</div>
                    <div class="calc-line">ê°œì¸ ë¶€ë™ì‚°: ${formatNumber(inputs.personal_real_estate_value)}ì›</div>
                    <div class="calc-line">ë²•ì¸ ì£¼ì‹: ${formatNumber(calculateStockValue(inputs) * (inputs.ceo_share / 100))}ì›</div>
                    <div class="calc-line">ìƒëª…ë³´í—˜: ${formatNumber(inputs.life_insurance)}ì›</div>
                    <div class="calc-line">ê°œì¸ ë¶€ì±„: -${formatNumber(inputs.personal_debt)}ì›</div>
                    <div class="calc-line" style="border-top:1px solid #dee2e6; margin-top:0.5rem; padding-top:0.5rem;"><strong>ì´ ìƒì†ì¬ì‚°: ${formatNumber(inputs.inheritance_assets)}ì›</strong></div>
                </div>
                
                <div class="calc-box">
                    <div class="calc-line"><strong>ìƒì†ì„¸ ê³„ì‚°</strong></div>
                    <div class="calc-line">ë°°ìš°ì ê³µì œ: -${formatNumber(taxInfo.spouseDeduction)}ì›</div>
                    <div class="calc-line">ìë…€ ê³µì œ: -${formatNumber(taxInfo.childDeduction)}ì›</div>
                    <div class="calc-line">ê¸°ì´ˆ ê³µì œ: -${formatNumber(taxInfo.basicDeduction)}ì›</div>
                    <div class="calc-line" style="border-top:1px solid #dee2e6; margin-top:0.5rem; padding-top:0.5rem;">ê³¼ì„¸í‘œì¤€: ${formatNumber(taxInfo.taxableAmount)}ì›</div>
                    <div class="calc-result">ğŸ’€ ì¶”ì • ìƒì†ì„¸: ${formatNumber(taxInfo.tax)}ì›</div>
                </div>
                
                <div class="calc-box">
                    <div class="calc-line"><strong>ë‚©ë¶€ ëŠ¥ë ¥ ë¶„ì„</strong></div>
                    <div class="calc-line">í˜„ê¸ˆ + ë³´í—˜ê¸ˆ: ${formatNumber(liquidAssets)}ì›</div>
                    <div class="calc-line">ì¶”ì • ìƒì†ì„¸: ${formatNumber(taxInfo.tax)}ì›</div>
                    <div class="calc-result" style="color: #b03a2e;">âš ï¸ ë¶€ì¡±ì•¡: ${formatNumber(gap)}ì› (${((gap/taxInfo.tax)*100).toFixed(1)}%)</div>
                </div>
                
                <p><strong>ğŸ’€ ìµœì•…ì˜ ì‹œë‚˜ë¦¬ì˜¤:</strong> ìƒì†ì„¸ë¥¼ ë‚¼ ëˆì´ ì—†ì–´ ìƒì†ë°›ì€ ë¶€ë™ì‚°ì´ë‚˜ ì£¼ì‹ì„ ê¸‰ë§¤ê° â†’ ì‹œì„¸ë³´ë‹¤ ${formatNumber(gap * 0.3)}ì› ì†í•´</p>
                
                <div class="action-box">
                    <h5>ğŸš¨ 10ë…„ ë¡œë“œë§µ (ì§€ê¸ˆ ì‹œì‘ í•„ìˆ˜)</h5>
                    <ul>
                        <li><strong>1ë…„ì°¨:</strong> ë²•ì¸ ëª…ì˜ ìƒëª…ë³´í—˜ ${formatNumber(gap)}ì› ê°€ì…</li>
                        <li><strong>2~10ë…„ì°¨:</strong> ìë…€ì—ê²Œ 10ë…„ ì£¼ê¸° ì¦ì—¬ (ìë…€ë‹¹ 5ì–µ ê³µì œ)</li>
                        <li><strong>5ë…„ì°¨:</strong> ë°°ìš°ìì—ê²Œ 6ì–µ ì¦ì—¬ (ë°°ìš°ì ê³µì œ ê·¹ëŒ€í™”)</li>
                        <li><strong>7ë…„ì°¨:</strong> ê°€ì—…ìŠ¹ê³„ ìš”ê±´ ì¶©ì¡± í™•ì¸ (ìµœëŒ€ 500ì–µ ê³µì œ)</li>
                        <li><strong>ì˜ˆìƒ ì ˆê°:</strong> ìƒì†ì„¸ ${formatNumber(taxInfo.tax)}ì› â†’ ${formatNumber(taxInfo.tax * 0.3)}ì› (70% ì ˆê° = <strong>${formatNumber(taxInfo.tax * 0.7)}ì›</strong>)</li>
                    </ul>
                </div>
            </div>`;
        }
    }
    
    // 8. ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€ ë¯¸ì ìš©
    if (inputs.sme_benefit === 'no' && inputs.sales > 0 && inputs.sales < 40000000000) {
        const potentialCredit = inputs.tax_expense * 0.1;
        analysisResult.opportunities.add('ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€');
        
        html += `<div class="consulting-topic topic-opportunity">
            <h3 class="opportunity"><i class="fas fa-gift"></i>ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´ ë¯¸ì ìš© (${formatNumber(potentialCredit)}ì› ì†ì‹¤)</h3>
            
            <p><strong>ğŸ’° ì¦‰ì‹œ í™˜ê¸‰ ê¸°íšŒ:</strong> ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´ì„ ì ìš©ë°›ì§€ ì•Šì•„ ìµœëŒ€ <span style="color:#1e8449;font-weight:700;">${formatNumber(potentialCredit)}ì›</span>ì„ ë¶ˆí•„ìš”í•˜ê²Œ ë‚©ë¶€í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
            
            <div class="calc-box">
                <div class="calc-line">í˜„ì¬ ë²•ì¸ì„¸: ${formatNumber(inputs.tax_expense)}ì›</div>
                <div class="calc-line">ê°ë©´ìœ¨: ì—…ì¢…ì— ë”°ë¼ 5~20%</div>
                <div class="calc-result">âœ… ì˜ˆìƒ í™˜ê¸‰ì•¡: ${formatNumber(potentialCredit)}ì› (ê²½ì •ì²­êµ¬ 5ë…„ë¶„)</div>
            </div>
            
            <div class="action-box">
                <h5>ğŸ’ ì¦‰ì‹œ ì‹¤í–‰ Action</h5>
                <ul>
                    <li><strong>ì´ë²ˆ ë‹¬:</strong> ì„¸ë¬´ì‚¬ í†µí•´ ì ìš© ìš”ê±´ ê²€í†  ë° ê²½ì •ì²­êµ¬</li>
                    <li><strong>í–¥í›„:</strong> ë§¤ë…„ ìë™ ì ìš©ìœ¼ë¡œ ì—° ${formatNumber(potentialCredit / 5)}ì› ì ˆì„¸</li>
                </ul>
            </div>
        </div>`;
        totalTaxSavings += potentialCredit;
    }
    
    // ìµœì¢… ìš”ì•½ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€
    if (!html) {
        html = `<div class="consulting-topic topic-good">
            <h3 class="good"><i class="fas fa-check-circle"></i>ì£¼ìš” ë¦¬ìŠ¤í¬ ë¯¸ë°œê²¬</h3>
            <p>ì…ë ¥ëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì£¼ìš” ê²½ì˜ ë¦¬ìŠ¤í¬ëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ì§€ê¸ˆì²˜ëŸ¼ ì•ˆì •ì ì¼ ë•Œê°€ ì˜¤íˆë ¤ ë¯¸ë˜ ë¶ˆí™•ì‹¤ì„±ì— ëŒ€ë¹„í•  ìµœì ì˜ ì‹œê¸°ì„ì„ ê¸°ì–µí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
        </div>`;
    }
    
    // ì´ ì ˆì„¸ íš¨ê³¼ ìš”ì•½
    html += `<div class="summary-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin-top: 2rem;">
        <h3 style="color: white; border: none; margin: 0 0 1rem 0;"><i class="fas fa-trophy"></i> ì¢…í•© ì ˆì„¸ íš¨ê³¼</h3>
        <div class="total-savings" style="font-size: 2rem; font-weight: 700; text-align: center; margin: 1.5rem 0;">
            ì´ ì˜ˆìƒ ì ˆê°ì•¡: <span class="highlight" style="color: #f1c40f;">${formatNumber(totalTaxSavings)}ì›</span>
        </div>
        <p class="cta-text" style="text-align: center; font-size: 1.1rem; margin: 0;">ğŸ’¡ ì§€ê¸ˆ ë°”ë¡œ ì‹¤í–‰í•˜ë©´ ìœ„ ê¸ˆì•¡ì„ ì ˆê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
    </div>`;
    
    analysisResult.taxSavings = totalTaxSavings;
    container.innerHTML = html;
    }

function calculateInsurancePlan(inputs) {
    if (inputs.op_profit <= 0 || inputs.insurance_target_amount <= 0) return null;
    
    const periodInMonths = inputs.insurance_payment_period * 12;
    const ageFactor = 1 + (Math.max(0, inputs.ceo_age - 40) * 0.045);
    const monthlyPremium = (inputs.insurance_target_amount / periodInMonths) * 1.15 * ageFactor;
    const totalPremium = monthlyPremium * periodInMonths;
    const taxRate = (inputs.net_income > 200000000) ? 0.21 : 0.099;
    const taxSavings = (monthlyPremium * 12) * taxRate;
    
    const plan = { 
        coverage: inputs.insurance_target_amount, 
        monthlyPremium: monthlyPremium, 
        totalPremium: totalPremium, 
        paymentPeriod: inputs.insurance_payment_period, 
        taxSavings: taxSavings, 
        surrenderRates: [] 
    };
    
    // ================== í•µì‹¬ ë³€ê²½ ë¡œì§ ì‹œì‘ ==================
    const customRates = getCustomSurrenderRates(); // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

    if (customRates.length > 0) {
        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì´ ìˆìœ¼ë©´, ê·¸ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        plan.surrenderRates = customRates;
    } else {
        // ì…ë ¥í•œ ê°’ì´ ì—†ìœ¼ë©´, ê¸°ì¡´ì˜ ê³ ì •ëœ ê³µì‹ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤ (Fallback).
        for (let i = 5; i <= 20; i += 5) { 
            if(i <= inputs.insurance_payment_period) { 
                let rate = (i / inputs.insurance_payment_period) * 95 + (i > 5 ? (i-5) * 1.5 : 0); 
                plan.surrenderRates.push({ year: i, rate: Math.min(120, rate) }); 
            } 
        }
    }
    // ================== í•µì‹¬ ë³€ê²½ ë¡œì§ ë ====================
    
    return plan;
}
function generateInsuranceProposal(inputs) {
    const container = document.getElementById('solution_proposal');
    const card = document.getElementById('solution_proposal_card');
    analysisResult.insurancePlan = calculateInsurancePlan(inputs);
    const plan = analysisResult.insurancePlan;

    if (!plan) {
        card.style.display = 'none';
        return;
    }

    card.style.display = 'block';

    // ================== [ìˆ˜ì •] ê³„ì‚° ê¸°ì¤€ì•¡ í†µì¼ ==================
    // ì›” ë‚©ì…ì•¡ì„ ë¨¼ì € ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼í•˜ì—¬ ëª¨ë“  ê³„ì‚°ì˜ ê¸°ì¤€ìœ¼ë¡œ ì‚¼ìŠµë‹ˆë‹¤.
    const roundedMonthlyPremium = Math.round(plan.monthlyPremium); 
    // ë°˜ì˜¬ë¦¼ëœ ì›”ë‚©ì…ì•¡ ê¸°ì¤€ìœ¼ë¡œ ìµœì¢… ì´ ë‚©ë¶€ê¸ˆì•¡ì„ ë‹¤ì‹œ ê³„ì‚°í•©ë‹ˆë‹¤.
    const totalPremiums = roundedMonthlyPremium * plan.paymentPeriod * 12;
    // ========================================================

    let surrenderTableHtml = '';
    plan.surrenderRates.forEach(item => {
        // [ìˆ˜ì •] í•´ë‹¹ ì‹œì ê¹Œì§€ì˜ ì´ ë‚©ì… ì›ê¸ˆì„ 'ë°˜ì˜¬ë¦¼ëœ ì›”ë‚©ì…ì•¡' ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
        const totalPremiumsPaid = roundedMonthlyPremium * 12 * item.year;
        
        // ì´ ë‚©ì… ì›ê¸ˆ ëŒ€ë¹„ í™˜ê¸‰ë¥ ì„ ì ìš©í•˜ì—¬ ì‹¤ì œ í™˜ê¸‰ê¸ˆì„ ê³„ì‚°
        const surrenderValue = totalPremiumsPaid * (item.rate / 100);

        surrenderTableHtml += `<tr><td class="text-left">${item.year}ë…„ ê²½ê³¼</td><td class="text-right">${item.rate.toFixed(1)}%</td><td class="text-right">${formatNumber(surrenderValue)} ì›</td></tr>`;
    });

    container.innerHTML = `
        <div class="consulting-topic topic-good">
            <h3 class="good"><i class="fas fa-rocket"></i>CEO ì†”ë£¨ì…˜</h3>
            <table class="proposal-table">
                <tr><th colspan="2">ê¸°ë³¸ ì„¤ê³„</th></tr>
                <tr><td class="text-left">ë³´í—˜ê¸ˆ</td><td class="text-right">${formatNumber(plan.coverage)} ì›</td></tr>
                
                <tr><td class="text-left">ì›” ë‚©ì…</td><td class="text-right highlight">${formatNumber(roundedMonthlyPremium)} ì›</td></tr>
                
                <tr><td class="text-left">ì´ ë‚©ë¶€ê¸ˆì•¡ (${plan.paymentPeriod}ë…„)</td><td class="text-right">${formatNumber(totalPremiums)} ì›</td></tr>

            </table>
            <h4>ê¸°ê°„ë³„ í™˜ê¸‰ê¸ˆ (ì´ ë‚©ì…ì•¡ ê¸°ì¤€)</h4>
            <table class="proposal-table">
                <tr><th>ê¸°ê°„</th><th>í™˜ê¸‰ë¥ </th><th>í™˜ê¸‰ê¸ˆ</th></tr>
                ${surrenderTableHtml}
            </table>
        </div>`;
}
function generateConsultantSummary(inputs) {
    const container = document.getElementById('consultant_summary');
    const { risks, opportunities, solutions, insurancePlan, taxSavings, estimatedInheritanceTax } = analysisResult;
    
    const name = document.getElementById('consultant_name').value || 'ëŒ€í‘œë‹˜';
    const company = document.getElementById('company_name').value || 'ê·€í•˜ì˜ ê¸°ì—…';
    
    const riskArray = Array.from(risks);
    const opportunityArray = Array.from(opportunities);
    const riskCount = riskArray.length;
    const riskText = riskArray.slice(0, 3).map(r => `<span class="summary-point">${r}</span>`).join(', ');
    
    // ğŸ“Š í•µì‹¬ ë¦¬ìŠ¤í¬ ìš°ì„ ìˆœìœ„ ì„ ì •
    let criticalRisks = [];
    if (riskArray.includes('í‘ìë„ì‚° ìœ„í—˜')) criticalRisks.push('í‘ìë„ì‚° ìœ„í—˜');
    if (riskArray.includes('ê³ ì•¡ ê°€ì§€ê¸‰ê¸ˆ')) criticalRisks.push('ê³ ì•¡ ê°€ì§€ê¸‰ê¸ˆ');
    if (riskArray.includes('ëª…ì˜ì‹ íƒ')) criticalRisks.push('ëª…ì˜ì‹ íƒ');
    if (riskArray.includes('ìƒì†ì„¸ í­íƒ„')) criticalRisks.push('ìƒì†ì„¸ í­íƒ„');
    if (riskArray.includes('ë‚®ì€ ì´ìë³´ìƒë°°ìœ¨')) criticalRisks.push('ì´ìë³´ìƒë°°ìœ¨');
    
    // ğŸ“Š í•µì‹¬ ê¸°íšŒ ìš°ì„ ìˆœìœ„
    let topOpportunities = [];
    if (opportunityArray.includes('ê²½ì •ì²­êµ¬')) topOpportunities.push('ê²½ì •ì²­êµ¬');
    if (opportunityArray.includes('ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€')) topOpportunities.push('ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€');
    if (opportunityArray.includes('ì¦ì—¬ ì ˆì„¸')) topOpportunities.push('ì¦ì—¬ ì ˆì„¸');
    if (opportunityArray.includes('ë°°ë‹¹ ì „ëµ')) topOpportunities.push('ë°°ë‹¹ ì „ëµ');
    
    let summary = '';
    let actionItems = '';
    
    // ì‹œë‚˜ë¦¬ì˜¤ 1: ì‹¬ê°í•œ ìœ„ê¸° (ì¹˜ëª…ì  ë¦¬ìŠ¤í¬ 3ê°œ ì´ìƒ)
    if (criticalRisks.length >= 3) {
        summary = `${name} ëŒ€í‘œë‹˜, ${company}ì˜ í˜„ì¬ ìƒí™©ì„ í•œ ë‹¨ì–´ë¡œ í‘œí˜„í•˜ë©´ <span class="summary-point" style="color:#e74c3c;">"ë¹¨ê°„ë¶ˆ"</span>ì…ë‹ˆë‹¤.

</p><p>ë°œê²¬ëœ <strong style="color:#e74c3c;">${criticalRisks.length}ê°œì˜ ì¹˜ëª…ì  ë¦¬ìŠ¤í¬</strong> - ${criticalRisks.map(r => `<span class="summary-point">${r}</span>`).join(', ')} - ëŠ” ê°ê° ë‹¨ë…ìœ¼ë¡œë„ ê¸°ì—…ì„ ìœ„í˜‘í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ì…ë‹ˆë‹¤.

</p><p>íŠ¹íˆ ${criticalRisks[0]}ì€(ëŠ”) <strong>ì¦‰ì‹œ í•´ê²°í•˜ì§€ ì•Šìœ¼ë©´ 1ë…„ ë‚´ ì‹¬ê°í•œ ê²½ì˜ ìœ„ê¸°</strong>ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ${estimatedInheritanceTax > 1000000000 ? `ì¶”ì • ìƒì†ì„¸ ${formatNumber(estimatedInheritanceTax)}ì›ì€ ê°€ì¡±ì˜ ë¯¸ë˜ë¥¼ ìœ„í˜‘í•˜ëŠ” ì‹œí•œí­íƒ„ì´ë©°, ` : ''}${inputs.operating_cashflow < 0 ? 'í˜„ê¸ˆíë¦„ ì ìëŠ” í‘ìë„ì‚°ì˜ ì „ì¡° ì¦ìƒì…ë‹ˆë‹¤.' : ''}

</p><p>í•˜ì§€ë§Œ í¬ë§ì€ ìˆìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ ì œì‹œëœ ì „ëµë“¤ì„ <strong>72ì‹œê°„ ë‚´ ì‹¤í–‰</strong>í•˜ë©´ <span style="color:#27ae60;font-weight:700;">ì´ ${formatNumber(taxSavings)}ì›ì˜ ì ˆì„¸</span>ì™€ í•¨ê»˜ ìœ„ê¸°ë¥¼ ê¸°íšŒë¡œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;

        actionItems = `
        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 2rem; border-radius: 12px; margin-top: 2rem;">
            <h3 style="color: white; margin: 0 0 1rem 0; border: none;"><i class="fas fa-fire"></i> 72ì‹œê°„ ê¸´ê¸‰ ì•¡ì…˜ í”Œëœ</h3>
            <ol style="margin: 0; padding-left: 1.5rem; line-height: 2;">
                ${criticalRisks.includes('ëª…ì˜ì‹ íƒ') ? '<li><strong>ì¦‰ì‹œ:</strong> ì„¸ë¬´ì‚¬ ê¸´ê¸‰ ë¯¸íŒ… (ëª…ì˜ì‹ íƒ ì‹¤ì œì†Œìœ ì í™•ì¸ ì‹ ì²­)</li>' : ''}
                ${criticalRisks.includes('í‘ìë„ì‚° ìœ„í—˜') ? '<li><strong>24ì‹œê°„ ë‚´:</strong> CFO ì†Œì§‘ - í˜„ê¸ˆíë¦„ ê°œì„  ë¹„ìƒíšŒì˜</li>' : ''}
                ${criticalRisks.includes('ê³ ì•¡ ê°€ì§€ê¸‰ê¸ˆ') ? '<li><strong>1ì£¼ì¼ ë‚´:</strong> ê°€ì§€ê¸‰ê¸ˆ ' + formatNumber(inputs.adv_payments * 0.3) + 'ì› ìì§„ ìƒí™˜</li>' : ''}
                ${criticalRisks.includes('ë‚®ì€ ì´ìë³´ìƒë°°ìœ¨') ? '<li><strong>1ê°œì›” ë‚´:</strong> ê³ ê¸ˆë¦¬ ëŒ€ì¶œ ì €ê¸ˆë¦¬ ëŒ€í™˜ ì¶”ì§„</li>' : ''}
                ${insurancePlan ? '<li><strong>2ì£¼ì¼ ë‚´:</strong> CEO ë³´í—˜ 3ì‚¬ ê²¬ì  (ì›” ' + formatNumber(insurancePlan.monthlyPremium) + 'ì›)</li>' : ''}
                <li><strong>1ê°œì›” ë‚´:</strong> ì¬ë¬´êµ¬ì¡° ê°œì„  ë§ˆìŠ¤í„°í”Œëœ ìˆ˜ë¦½</li>
            </ol>
        </div>`;
    }
    // ì‹œë‚˜ë¦¬ì˜¤ 2: ì¤‘ëŒ€ ë¦¬ìŠ¤í¬ + í° ì ˆì„¸ ê¸°íšŒ
    else if (riskCount >= 3 && taxSavings > 100000000) {
        summary = `${name} ëŒ€í‘œë‹˜, ${company}ë¥¼ ì§„ë‹¨í•œ ê²°ê³¼ëŠ” <span class="summary-point">"ìœ„ê¸°ì´ì ê¸°íšŒ"</span>ì…ë‹ˆë‹¤.

</p><p>${riskCount}ê°œì˜ ë¦¬ìŠ¤í¬(${riskText})ê°€ ë°œê²¬ë˜ì—ˆìœ¼ë‚˜, ë™ì‹œì— <strong style="color:#27ae60;">í–¥í›„ 10ë…„ê°„ ${formatNumber(taxSavings)}ì›ì„ ì ˆê°</strong>í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ê¸°íšŒë„ í•¨ê»˜ ë³´ì…ë‹ˆë‹¤.

</p><p>${topOpportunities.length > 0 ? `íŠ¹íˆ ${topOpportunities.join(', ')} ë¶„ì•¼ì—ì„œ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì ˆì„¸ ì „ëµì´ ìˆìœ¼ë©°, ` : ''}${insurancePlan ? `ì›” ${formatNumber(insurancePlan.monthlyPremium)}ì›ì˜ CEO ë³´í—˜ í”Œëœìœ¼ë¡œ ì—° ${formatNumber(insurancePlan.taxSavings)}ì›ì„ ì¦‰ì‹œ ì ˆê°í•˜ë©´ì„œ ${insurancePlan.paymentPeriod}ë…„ í›„ ${formatNumber(insurancePlan.coverage)}ì›ì˜ ì¬ë¬´ ì•ˆì „ë§ì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.` : 'ì´ë¥¼ í†µí•´ ì¬ë¬´ êµ¬ì¡°ë¥¼ ê·¼ë³¸ì ìœ¼ë¡œ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'}

</p><p>${inputs.short_debt > inputs.sales * 0.3 ? 'ë‹¨ê¸°ì°¨ì…ê¸ˆ ê³¼ë‹¤ì™€ ' : ''}${inputs.family_salary > inputs.op_profit * 0.3 ? 'ê°€ì¡± ê¸‰ì—¬ êµ¬ì¡°ëŠ” ' : ''}ì¦‰ì‹œ ì¡°ì •ì´ í•„ìš”í•˜ì§€ë§Œ, ì´ëŠ” ì˜¤íˆë ¤ <strong>ì¬ë¬´ì œí‘œë¥¼ ê±´ê°•í•˜ê²Œ ë§Œë“œëŠ” ì „í™˜ì </strong>ì´ ë  ê²ƒì…ë‹ˆë‹¤.`;

        actionItems = `
        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 2rem; border-radius: 12px; margin-top: 2rem;">
            <h3 style="color: white; margin: 0 0 1rem 0; border: none;"><i class="fas fa-rocket"></i> ì´ë²ˆ ë‹¬ ì‹¤í–‰ ë¡œë“œë§µ</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <h4 style="color: #f1c40f; margin: 0 0 0.5rem 0; font-size: 1.1rem;">ğŸ”¥ ë¦¬ìŠ¤í¬ ì œê±°</h4>
                    <ul style="margin: 0; padding-left: 1rem;">
                        ${riskArray.slice(0, 3).map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
                <div>
                    <h4 style="color: #2ecc71; margin: 0 0 0.5rem 0; font-size: 1.1rem;">ğŸ’ ê¸°íšŒ í¬ì°©</h4>
                    <ul style="margin: 0; padding-left: 1rem;">
                        ${topOpportunities.slice(0, 3).map(o => `<li>${o}</li>`).join('')}
                    </ul>
                </div>
            </div>
            <p style="margin: 1rem 0 0 0; font-size: 0.95rem; opacity: 0.9;">
                <strong>ëª©í‘œ:</strong> 3ê°œì›” ë‚´ ì¬ë¬´ì œí‘œ ì •ìƒí™” + ì—° ${formatNumber(taxSavings / 10)}ì› ì ˆì„¸ êµ¬ì¡° í™•ë¦½
            </p>
        </div>`;
    }
    // ì‹œë‚˜ë¦¬ì˜¤ 3: ì†Œìˆ˜ ë¦¬ìŠ¤í¬ + ê°œì„  ê¸°íšŒ
    else if (riskCount > 0 && riskCount < 3) {
        const specificAdvice = [];
        if (inputs.ceo_share < 30) specificAdvice.push('CEO ì§€ë¶„ìœ¨ì„ 30% ì´ìƒìœ¼ë¡œ í™•ë³´í•˜ì—¬ ê²½ì˜ê¶Œì„ ì•ˆì •í™”');
        if (inputs.dividend_3years === 0 && inputs.retained_earnings > 500000000) specificAdvice.push('ì´ìµì‰ì—¬ê¸ˆ ë°°ë‹¹ìœ¼ë¡œ ë²•ì¸ì„¸ vs ë°°ë‹¹ì„¸ ì ˆì„¸ íš¨ê³¼');
        if (inputs.gift_history === 0) specificAdvice.push('ìë…€ ì¦ì—¬ë¡œ 10ë…„ ì£¼ê¸° ìƒì†ì„¸ ì ˆê° ì „ëµ');
        
        summary = `${name} ëŒ€í‘œë‹˜, ${company}ëŠ” <span class="summary-point">ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì </span>ì´ë‚˜ ${riskCount}ê°œì˜ ê°œì„  í¬ì¸íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.

</p><p>${riskText} ${riskCount === 1 ? 'ì€' : 'ë“±ì€'} ì§€ê¸ˆ í•´ê²°í•˜ë©´ ë¹„ìš©ë„ ì ê²Œ ë“¤ê³  íš¨ê³¼ë„ í½ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ ë°©ì¹˜í•˜ë©´ ${inputs.operating_cashflow < 0 ? 'í˜„ê¸ˆíë¦„ ì•…í™”ë‚˜ ' : ''}ì„¸ë¬´ì¡°ì‚¬ ì‹œ ì¹˜ëª…ì  ì•½ì ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

</p><p>${specificAdvice.length > 0 ? `êµ¬ì²´ì ìœ¼ë¡œ ${specificAdvice[0]}í•˜ê³ , ${specificAdvice.length > 1 ? specificAdvice[1] + 'ë¥¼ ê²€í† í•˜ë©´' : ''} ` : ''}${taxSavings > 0 ? `<strong>${formatNumber(taxSavings)}ì›ì˜ ì ˆì„¸ íš¨ê³¼</strong>ë¥¼ ì–»ì„ ìˆ˜ ìˆìœ¼ë‹ˆ, ì´ëŠ” ` : ''}ê·¸ì•¼ë§ë¡œ "ë°œê²¬ëœ ë³´ë¬¼"ì…ë‹ˆë‹¤.

</p><p>íŠ¹íˆ ${inputs.ceo_age}ì„¸ CEO ë‚˜ì´ë¥¼ ê³ ë ¤í•  ë•Œ, ${insurancePlan ? `ì›” ${formatNumber(insurancePlan.monthlyPremium)}ì›ì˜ ë³´í—˜ë£Œë¡œ ` : ''}ì§€ê¸ˆì´ ${inputs.successor === 'yes' ? 'ê°€ì—…ìŠ¹ê³„ì™€ ' : ''}ì€í‡´ ì¤€ë¹„ë¥¼ ì‹œì‘í•  ì ê¸°ì…ë‹ˆë‹¤.`;

        actionItems = `
        <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 2rem; border-radius: 12px; margin-top: 2rem;">
            <h3 style="color: white; margin: 0 0 1rem 0; border: none;"><i class="fas fa-check-circle"></i> ë¶„ê¸°ë³„ ê°œì„  í”Œëœ</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">Q1</div>
                    <div style="font-size: 0.9rem;">${riskArray[0] || 'í˜„í™© ìœ ì§€'} í•´ê²°</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">Q2</div>
                    <div style="font-size: 0.9rem;">${topOpportunities[0] || insurancePlan ? 'CEO ë³´í—˜ ê°€ì…' : 'ì ˆì„¸ ì „ëµ'} ì‹¤í–‰</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">Q3-4</div>
                    <div style="font-size: 0.9rem;">ì„ ìˆœí™˜ êµ¬ì¡° í™•ë¦½</div>
                </div>
            </div>
        </div>`;
    }
    // ì‹œë‚˜ë¦¬ì˜¤ 4: ìš°ìˆ˜ ê¸°ì—…
    else {
        summary = `${name} ëŒ€í‘œë‹˜, ì¶•í•˜ë“œë¦½ë‹ˆë‹¤! ${company}ëŠ” <span class="summary-point" style="color:#27ae60;">ì¬ë¬´ì ìœ¼ë¡œ ë§¤ìš° ê±´ê°•</span>í•©ë‹ˆë‹¤.

</p><p>ë°œê²¬ëœ ë¦¬ìŠ¤í¬ê°€ ${riskCount}ê°œì— ë¶ˆê³¼í•˜ë©°, ì´ëŠ” ëŒ€í‘œë‹˜ì˜ <strong>íƒì›”í•œ ê²½ì˜ ëŠ¥ë ¥</strong>ì„ ì¦ëª…í•©ë‹ˆë‹¤. ${inputs.operating_cashflow > 0 ? 'ì–‘í˜¸í•œ í˜„ê¸ˆíë¦„, ' : ''}${inputs.ceo_share >= 50 ? 'ì•ˆì •ì ì¸ ì§€ë°°êµ¬ì¡°, ' : ''}${inputs.op_profit > 0 ? 'ê±´ì „í•œ ìˆ˜ìµì„±' : ''}ì´ ì´ë¥¼ ë’·ë°›ì¹¨í•©ë‹ˆë‹¤.

</p><p>ë‹¤ë§Œ <strong>"ì¢‹ì„ ë•Œê°€ ë¯¸ë˜ë¥¼ ì¤€ë¹„í•  ë•Œ"</strong>ë¼ëŠ” ì ì„ ê°•ì¡°í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤. ${inputs.ceo_age}ì„¸ëŠ” ${insurancePlan ? `ë³´í—˜ë£Œê°€ ì €ë ´í•œ ê³¨ë“ íƒ€ì„ì´ë©°, ì›” ${formatNumber(insurancePlan.monthlyPremium)}ì›ìœ¼ë¡œ ${formatNumber(insurancePlan.coverage)}ì›ì˜ ì•ˆì „ë§ì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.` : 'ì€í‡´ ì¤€ë¹„ë¥¼ ì‹œì‘í•  ì ê¸°ì…ë‹ˆë‹¤.'}

</p><p>${inputs.successor === 'yes' ? 'í›„ê³„ìê°€ ìˆìœ¼ë‹ˆ ' : ''}ì§€ê¸ˆë¶€í„° ${inputs.founding_year && (new Date().getFullYear() - inputs.founding_year) >= 10 ? 'ê°€ì—…ìŠ¹ê³„ ê³µì œ(ìµœëŒ€ 600ì–µ), ' : ''}${inputs.gift_history === 0 ? '10ë…„ ì£¼ê¸° ì¦ì—¬ ì „ëµ, ' : ''}ë°°ìš°ìÂ·ìë…€ ì§€ë¶„ ì´ì „ì„ ì²´ê³„ì ìœ¼ë¡œ ì§„í–‰í•˜ë©´ <strong>ì„¸ëŒ€ë¥¼ ì´ì–´ê°€ëŠ” ì¥ìˆ˜ ê¸°ì—…</strong>ì˜ ê¸°ë°˜ì„ ë‹¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;

        actionItems = `
        <div style="background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%); color: white; padding: 2rem; border-radius: 12px; margin-top: 2rem;">
            <h3 style="color: white; margin: 0 0 1rem 0; border: none;"><i class="fas fa-crown"></i> í”„ë¦¬ë¯¸ì—„ ìµœì í™” ì „ëµ</h3>
            <div style="line-height: 2;">
                <p style="margin: 0 0 1rem 0;"><strong>ë‹¨ê¸°(1ë…„):</strong> ${insurancePlan ? `CEO ë³´í—˜ ${formatNumber(insurancePlan.coverage)}ì› ê°€ì…` : 'ì¬ë¬´ êµ¬ì¡° ìµœì í™”'}</p>
                <p style="margin: 0 0 1rem 0;"><strong>ì¤‘ê¸°(3~5ë…„):</strong> ${inputs.successor === 'yes' ? 'í›„ê³„ì ìœ¡ì„± + ' : ''}ê°€ì¡± ì§€ë¶„ ì¬ë°°ì¹˜ (ì¦ì—¬ì„¸ ìµœì†Œí™”)</p>
                <p style="margin: 0 0 1rem 0;"><strong>ì¥ê¸°(10ë…„):</strong> ${inputs.founding_year && (new Date().getFullYear() - inputs.founding_year) >= 10 ? 'ê°€ì—…ìŠ¹ê³„ ê³µì œ í™œìš© + ' : ''}100ì„¸ ê¸°ì—… ë¡œë“œë§µ</p>
            </div>
            <p style="margin: 1.5rem 0 0 0; font-size: 0.95rem; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 1rem;">
                ğŸ’¡ <strong>Insight:</strong> ìœ„ê¸° ë•Œ ëŒ€ì‘í•˜ëŠ” ê²ƒë³´ë‹¤, ì•ˆì •ì ì¼ ë•Œ ë¯¸ë˜ë¥¼ ì„¤ê³„í•˜ëŠ” ê²ƒì´ 10ë°° íš¨ìœ¨ì ì…ë‹ˆë‹¤.
            </p>
        </div>`;
    }
    
    container.innerHTML = `
        <h2 style="display: flex; justify-content: space-between; align-items: center; border-bottom: none; padding-bottom: 0;">
            <span><i class="fas fa-user-tie"></i>ì»¨ì„¤í„´íŠ¸ ìµœì¢… ì†Œê²¬</span>
            <button class="btn warning" id="premium-report-btn" style="font-size: 1rem; padding: 0.8rem 1.5rem; display: flex; align-items: center; justify-content: center;">
                íŠ¹ê¸‰ë³´ê³ ì„œ
            </button>
        </h2>
        <p>${summary}</p>
        
        ${actionItems}
        
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.3);">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div>
                    <h4 style="color: #f1c40f; margin: 0 0 1rem 0;"><i class="fas fa-exclamation-triangle"></i> ë°œê²¬ëœ ë¦¬ìŠ¤í¬ (${riskCount}ê°œ)</h4>
                    ${riskCount > 0 ? `<ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">${riskArray.map(r => `<li>${r}</li>`).join('')}</ul>` : '<p style="color: rgba(255,255,255,0.7);">ë¦¬ìŠ¤í¬ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>'}
                </div>
                <div>
                    <h4 style="color: #2ecc71; margin: 0 0 1rem 0;"><i class="fas fa-lightbulb"></i> ì ˆì„¸ ê¸°íšŒ (${opportunityArray.length}ê°œ)</h4>
                    ${opportunityArray.length > 0 ? `<ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">${opportunityArray.map(o => `<li>${o}</li>`).join('')}</ul>` : '<p style="color: rgba(255,255,255,0.7);">ì¶”ê°€ ê¸°íšŒë¥¼ íƒìƒ‰ì¤‘ì…ë‹ˆë‹¤.</p>'}
                </div>
            </div>
            
            ${taxSavings > 0 ? `
            <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;">ğŸ’° ì´ ì˜ˆìƒ ì ˆì„¸ì•¡</div>
                <div style="font-size: 2.5rem; font-weight: 700; color: #f1c40f;">${formatNumber(taxSavings)}ì›</div>
                <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem;">í–¥í›„ 10ë…„ ëˆ„ì  íš¨ê³¼</div>
            </div>
            ` : ''}
            
            <p style="font-size: 1rem; opacity: 0.9; font-style: italic; margin-top: 2rem; text-align: center;">
                "ê¸°ì—… ì»¨ì„¤íŒ…ì˜ í•µì‹¬ì€ ë¬¸ì œë¥¼ ë°œê²¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ê·¸ ë¬¸ì œë¥¼ <strong>ëˆìœ¼ë¡œ í™˜ì‚°</strong>í•˜ê³ , í•´ê²°ì±…ì„ <strong>êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœ</strong>ìœ¼ë¡œ ì œì‹œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤."
            </p>
        </div>
    `;
    
    // íŠ¹ê¸‰ë³´ê³ ì„œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const premiumBtn = document.getElementById('premium-report-btn');
    if (premiumBtn) {
        premiumBtn.addEventListener('click', function() {
            const reportData = {
                company: document.getElementById('company_name').value || 'ë¯¸ì…ë ¥',
                ceo: document.getElementById('consultant_name').value || 'ë¯¸ì…ë ¥',
                risks: riskArray,
                opportunities: opportunityArray,
                taxSavings: taxSavings,
                inputs: inputs
            };
            alert(`íŠ¹ê¸‰ë³´ê³ ì„œ ê¸°ëŠ¥ì€ AI ì—°ë™ í›„ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.\n\ní˜„ì¬ ë¶„ì„ ë°ì´í„°:\nâ€¢ ê¸°ì—…ëª…: ${reportData.company}\nâ€¢ CEO: ${reportData.ceo}\nâ€¢ ë¦¬ìŠ¤í¬: ${riskCount}ê°œ\nâ€¢ ê¸°íšŒ: ${opportunityArray.length}ê°œ\nâ€¢ ì˜ˆìƒ ì ˆì„¸: ${formatNumber(taxSavings)}ì›`);
            console.log('íŠ¹ê¸‰ë³´ê³ ì„œ ë°ì´í„°:', reportData);
        });
    }
}
document.addEventListener('DOMContentLoaded', function() {
    // ğŸ“± íœ´ëŒ€í° ì„¸ë¡œ ëª¨ë“œì¼ ë•Œë§Œ íƒ­ ê¸°ëŠ¥ì„ í™œì„±í™”í•©ë‹ˆë‹¤.
    if (window.innerWidth <= 820 && window.matchMedia('(orientation: portrait)').matches) {
        const mobileTabs = document.querySelectorAll('.mobile-tabs button');
        const inputSection = document.querySelector('.input-section');
        const analysisSection = document.querySelector('.analysis-section');
        
        mobileTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                mobileTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                const tabType = this.getAttribute('data-tab');
                if (tabType === 'input') {
                    inputSection.classList.add('active');
                    analysisSection.classList.remove('active');
                } else {
                    inputSection.classList.remove('active');
                    analysisSection.classList.add('active');
                }
            });
        });
    }
});

document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 's':
                e.preventDefault();
                saveToFile();
                break;
            case 'o':
                e.preventDefault();
                loadFromFile();
                break;
            case 'h':
                e.preventDefault();
                const keyboardHelp = document.getElementById('keyboard-help');
                if (keyboardHelp) {
                    keyboardHelp.classList.toggle('show');
                }
                break;
        }
    }
});
// 1. ë¡œê·¸ì¸ í™•ì¸ ë° í”„ë¡œê·¸ë¨ ì‹œì‘ì„ ë‹´ë‹¹í•˜ëŠ” ë¶€ë¶„
window.addEventListener('load', function() {
    if (typeof firebase === 'undefined') {
        alert('Firebase ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const auth = firebase.auth();
    auth.onAuthStateChanged((user) => {
        if (user) {
            // âœ… ë¡œê·¸ì¸ í™•ì¸! í”„ë¡œê·¸ë¨ ì‹¤í–‰
            initializeApp(); 
        } else {
            // âŒ ë¡œê·¸ì¸ ì•ˆ ë¨! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = 'login.html';
        }
    });
});

// 2. ì‹¤ì œ í”„ë¡œê·¸ë¨ì˜ ëª¨ë“  ê¸°ëŠ¥ì´ ë‹´ê¸´ ë¶€ë¶„
function initializeApp() {
 Â  function isMobile() {

Â  Â  Â  Â  return /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)Â 

Â  Â  Â  Â  Â  Â  && window.innerWidth < 768;

Â  Â  }

Â  Â Â 

Â  Â  if (isMobile()) {

Â  Â  Â  Â  const overlay = document.getElementById('mobile-warning-overlay');

Â  Â  Â  Â  if (overlay) {

Â  Â  Â  Â  Â  Â  overlay.style.display = 'flex';

Â  Â  Â  Â  Â  Â  const closeBtn = document.getElementById('close-mobile-warning-btn');

Â  Â  Â  Â  Â  Â  if (closeBtn) {

Â  Â  Â  Â  Â  Â  Â  Â  closeBtn.addEventListener('click', function() {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overlay.style.display = 'none';

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  const saveBtn = document.getElementById('save-btn');

Â  Â  const loadBtn = document.getElementById('load-btn');

Â  Â  const newBtn = document.getElementById('new-btn');

Â  Â Â 

Â  Â  if (saveBtn) saveBtn.addEventListener('click', saveToFile);

Â  Â  if (loadBtn) loadBtn.addEventListener('click', loadFromFile);

Â  Â  if (newBtn) newBtn.addEventListener('click', newDocument);

Â  Â Â 

Â  Â  const fileInput = document.getElementById('file-input');

Â  Â  if (fileInput) {

Â  Â  Â  Â  fileInput.addEventListener('change', function(e) {

Â  Â  Â  Â  Â  Â  const file = e.target.files[0];

Â  Â  Â  Â  Â  Â  if (file) {

Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();

Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = function(e) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = JSON.parse(e.target.result);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadFormData(data);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSaveStatus('íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜´', 'success');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsText(file);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });

Â  Â  }

Â  Â Â 

Â  Â  document.querySelectorAll('input[inputmode="numeric"]').forEach(element => {

Â  Â  Â  Â  if (element.value) {

Â  Â  Â  Â  Â  Â  element.value = formatNumber(unformat(element.value));

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  element.addEventListener('input', function(e) {

Â  Â  Â  Â  Â  Â  const input = e.target;

Â  Â  Â  Â  Â  Â  const cursorPos = input.selectionStart;

Â  Â  Â  Â  Â  Â  const oldValue = input.value;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const numbers = oldValue.replace(/[^\d]/g, '');

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  if (numbers === '') {

Â  Â  Â  Â  Â  Â  Â  Â  input.value = '';

Â  Â  Â  Â  Â  Â  Â  Â  debouncedUpdate();

Â  Â  Â  Â  Â  Â  Â  Â  autoSave();

Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const formatted = formatNumber(numbers);

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  if (oldValue !== formatted) {

Â  Â  Â  Â  Â  Â  Â  Â  input.value = formatted;

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  const diff = formatted.length - oldValue.length;

Â  Â  Â  Â  Â  Â  Â  Â  const newPos = Math.max(0, Math.min(formatted.length, cursorPos + diff));

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.setSelectionRange(newPos, newPos);

Â  Â  Â  Â  Â  Â  Â  Â  }, 0);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  debouncedUpdate();

Â  Â  Â  Â  Â  Â  autoSave();

Â  Â  Â  Â  });

Â  Â  Â  Â Â 

Â  Â  Â  Â  element.addEventListener('blur', function() {

Â  Â  Â  Â  Â  Â  if (this.value) {

Â  Â  Â  Â  Â  Â  Â  Â  this.value = formatNumber(unformat(this.value));

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });

Â  Â  });



Â  Â  document.querySelectorAll('input:not([inputmode="numeric"]):not([readonly]), select, textarea').forEach(element => {

Â  Â  Â  Â  element.addEventListener('input', function() {

Â  Â  Â  Â  Â  Â  updateIdentityDisplay();

Â  Â  Â  Â  Â  Â  updateProgress();

Â  Â  Â  Â  Â  Â  autoSave();

Â  Â  Â  Â  });

Â  Â  Â  Â Â 

Â  Â  Â  Â  element.addEventListener('change', function() {

Â  Â  Â  Â  Â  Â  updateIdentityDisplay();

Â  Â  Â  Â  Â  Â  updateProgress();

Â  Â  Â  Â  Â  Â  debouncedUpdate();

Â  Â  Â  Â  Â  Â  autoSave();

Â  Â  Â  Â  });

Â  Â  });



Â  Â  const ceoBirthInput = document.getElementById('ceo_birth');

Â  Â  if (ceoBirthInput) {

Â  Â  Â  Â  ceoBirthInput.addEventListener('change', function() {

Â  Â  Â  Â  Â  Â  debouncedUpdate();

Â  Â  Â  Â  });

Â  Â  }

Â  Â  const opProfitInput = document.getElementById('op_profit');

Â  Â  const ebtInput = document.getElementById('ebt');

Â  Â  const taxExpenseInput = document.getElementById('tax_expense');

Â  Â  const netIncomeInput = document.getElementById('net_income');

Â  Â Â 

Â  Â  function updateEbtAvailability() {

Â  Â  Â  Â  if (!opProfitInput || !ebtInput || !taxExpenseInput) return;

Â  Â  Â  Â Â 

Â  Â  Â  Â  const opProfit = parseFloat(unformat(opProfitInput.value)) || 0;

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (opProfit > 0) {

Â  Â  Â  Â  Â  Â  ebtInput.disabled = false;

Â  Â  Â  Â  Â  Â  ebtInput.style.backgroundColor = '#ffffff';

Â  Â  Â  Â  Â  Â  ebtInput.style.cursor = 'text';

Â  Â  Â  Â  Â  Â  ebtInput.readOnly = false;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  taxExpenseInput.disabled = false;

Â  Â  Â  Â  Â  Â  taxExpenseInput.style.backgroundColor = '#ffffff';

Â  Â  Â  Â  Â  Â  taxExpenseInput.style.cursor = 'text';

Â  Â  Â  Â  Â  Â  taxExpenseInput.readOnly = false;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const lockIcon = document.getElementById('ebt-lock-icon');

Â  Â  Â  Â  Â  Â  if (lockIcon) lockIcon.style.display = 'none';

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  ebtInput.disabled = true;

Â  Â  Â  Â  Â  Â  ebtInput.style.backgroundColor = '#e9ecef';

Â  Â  Â  Â  Â  Â  ebtInput.style.cursor = 'not-allowed';

Â  Â  Â  Â  Â  Â  ebtInput.readOnly = true;

Â  Â  Â  Â  Â  Â  ebtInput.value = '0';

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  taxExpenseInput.disabled = true;

Â  Â  Â  Â  Â  Â  taxExpenseInput.style.backgroundColor = '#e9ecef';

Â  Â  Â  Â  Â  Â  taxExpenseInput.style.cursor = 'not-allowed';

Â  Â  Â  Â  Â  Â  taxExpenseInput.readOnly = true;

Â  Â  Â  Â  Â  Â  taxExpenseInput.value = '0';

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  if (netIncomeInput) {

Â  Â  Â  Â  Â  Â  Â  Â  netIncomeInput.value = '0';

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const lockIcon = document.getElementById('ebt-lock-icon');

Â  Â  Â  Â  Â  Â  if (lockIcon) lockIcon.style.display = 'inline';

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  if (opProfitInput && ebtInput && taxExpenseInput) {

Â  Â  Â  Â  updateEbtAvailability();

Â  Â  Â  Â Â 

Â  Â  Â  Â  opProfitInput.addEventListener('input', function() {

Â  Â  Â  Â  Â  Â  updateEbtAvailability();

Â  Â  Â  Â  Â  Â  debouncedUpdate();

Â  Â  Â  Â  Â  Â  autoSave();

Â  Â  Â  Â  });

Â  Â  Â  Â Â 

Â  Â  Â  Â  opProfitInput.addEventListener('change', function() {

Â  Â  Â  Â  Â  Â  updateEbtAvailability();

Â  Â  Â  Â  Â  Â  debouncedUpdate();

Â  Â  Â  Â  Â  Â  autoSave();

Â  Â  Â  Â  });

Â  Â  }

// CEO ì†”ë£¨ì…˜ ì•ˆë‚´ ë©”ì‹œì§€ ë™ì  í‘œì‹œ

(function() {

Â  Â  // âœ… ìš”ì†Œ ì¡´ì¬ í™•ì¸ ê°•í™”

Â  Â  const insuranceGuideMessage = document.getElementById('insurance-guide-message');

Â  Â  const opProfitInputLocal = document.getElementById('op_profit');

Â  Â Â 

Â  Â  if (!insuranceGuideMessage) {

Â  Â  Â  Â  console.warn('[Insurance Guide] insurance-guide-message ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

Â  Â  Â  Â  return;

Â  Â  }

Â  Â Â 

Â  Â  function updateInsuranceGuide() {

Â  Â  Â  Â  let opProfit = 0;

Â  Â  Â  Â Â 

Â  Â  Â  Â  // âœ… opProfitInputLocal null ì²´í¬ ì¶”ê°€

Â  Â  Â  Â  if (opProfitInputLocal) {

Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  const value = opProfitInputLocal.value;

Â  Â  Â  Â  Â  Â  Â  Â  if (value) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // unformat í•¨ìˆ˜ê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì§ì ‘ ì²˜ë¦¬

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cleaned = value.replace(/,/g, '');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opProfit = parseFloat(cleaned) || 0;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch(e) {

Â  Â  Â  Â  Â  Â  Â  Â  console.error('[Insurance Guide] íŒŒì‹± ì˜¤ë¥˜:', e);

Â  Â  Â  Â  Â  Â  Â  Â  opProfit = 0;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (opProfit > 0) {

Â  Â  Â  Â  Â  Â  // âœ… ì˜ì—…ì´ìµ ìˆìœ¼ë©´ ì´ˆë¡ìƒ‰

Â  Â  Â  Â  Â  Â  insuranceGuideMessage.style.background = '#d4edda';

Â  Â  Â  Â  Â  Â  insuranceGuideMessage.style.borderColor = '#28a745';

Â  Â  Â  Â  Â  Â  insuranceGuideMessage.style.color = '#155724';

Â  Â  Â  Â  Â  Â  insuranceGuideMessage.innerHTML = '<i class="fas fa-check-circle" style="margin-right: 0.5rem; color: #28a745;"></i><span><strong>ì¤€ë¹„ ì™„ë£Œ:</strong> CEO ì†”ë£¨ì…˜ì´ ì œê³µë©ë‹ˆë‹¤.</span>';

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  // âš ï¸ ì˜ì—…ì´ìµ ì—†ìœ¼ë©´ ë…¸ë€ìƒ‰

Â  Â  Â  Â  Â  Â  insuranceGuideMessage.style.background = '#fff3cd';

Â  Â  Â  Â  Â  Â  insuranceGuideMessage.style.borderColor = '#ffc107';

Â  Â  Â  Â  Â  Â  insuranceGuideMessage.style.color = '#856404';

Â  Â  Â  Â  Â  Â  insuranceGuideMessage.innerHTML = '<i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i><span><strong>ì•ˆë‚´:</strong> \'ì˜ì—…ì´ìµ\' ê¸ˆì•¡ì„ ì…ë ¥í•˜ì…”ì•¼ <strong>\'CEO ì†”ë£¨ì…˜\'</strong>ì´ ì œê³µë©ë‹ˆë‹¤.</span>';

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  // âœ… ì´ˆê¸° ì‹¤í–‰ (ì•½ê°„ ì§€ì—°)

Â  Â  setTimeout(updateInsuranceGuide, 100);

Â  Â Â 

Â  Â  // âœ… ì´ë²¤íŠ¸ ë“±ë¡

Â  Â  if (opProfitInputLocal) {

Â  Â  Â  Â  opProfitInputLocal.addEventListener('input', updateInsuranceGuide);

Â  Â  Â  Â  opProfitInputLocal.addEventListener('change', updateInsuranceGuide);

Â  Â  }

})();



const valuationDateInput = document.getElementById('valuation_date');

if (valuationDateInput && !valuationDateInput.value) {

Â  Â  const today = new Date().toISOString().split('T')[0];

Â  Â  valuationDateInput.value = today;

}



for (let i = 0; i < 3; i++) {

Â  Â  addChild();

}

addShareholder();



const addChildBtn = document.getElementById('add-child-btn');

const addShareholderBtn = document.getElementById('add-shareholder-btn');



if (addChildBtn) addChildBtn.addEventListener('click', addChild);

if (addShareholderBtn) addShareholderBtn.addEventListener('click', addShareholder);



if (savedData) {

Â  Â  try {

Â  Â  Â  Â  loadFormData(savedData);

Â  Â  Â  Â  showSaveStatus('ì´ì „ ì‘ì—… ë³µì›ë¨', 'success');

Â  Â  } catch (error) {

Â  Â  Â  Â  console.error('ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);

Â  Â  }

} else {

Â  Â  updateIdentityDisplay();

Â  Â  updateProgress();

}



setTimeout(() => {

Â  Â  try {

Â  Â  Â  Â  if (typeof updateAnalysis === 'function') {

Â  Â  Â  Â  Â  Â  updateAnalysis();

Â  Â  Â  Â  }

Â  Â  } catch (e) {

Â  Â  Â  Â  console.error('ì´ˆê¸° ë¶„ì„ ì‹¤í–‰ ì˜¤ë¥˜:', e);

Â  Â  }

}, 200);



setTimeout(() => {

Â  Â  const keyboardHelp = document.getElementById('keyboard-help');

Â  Â  if (keyboardHelp) {

Â  Â  Â  Â  keyboardHelp.classList.add('show');

Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  Â  keyboardHelp.classList.remove('show');

Â  Â  Â  Â  }, 3000);

Â  Â  }

}, 1000);

Â  Â  // ìë³¸ê¸ˆ/ì•¡ë©´ê°€ ë³€ê²½ ì‹œ ì£¼ì‹ìˆ˜ ìë™ ê³„ì‚°

Â  Â  const capitalInput = document.getElementById('capital');

Â  Â  const parValueInput = document.getElementById('par_value');

Â  Â  const totalSharesInput = document.getElementById('total_shares');

Â  Â Â 

Â  Â  function calculateShares() {

Â  Â  Â  Â  const capital = parseFloat(unformat(capitalInput.value)) || 0;

Â  Â  Â  Â  const parValue = parseFloat(unformat(parValueInput.value)) || 0;

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (capital > 0 && parValue > 0) {

Â  Â  Â  Â  Â  Â  const shares = Math.round(capital / parValue);

Â  Â  Â  Â  Â  Â  totalSharesInput.value = formatNumber(shares);

Â  Â  Â  Â  Â  Â  currentInputs.total_shares = shares;

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  totalSharesInput.value = '';

Â  Â  Â  Â  Â  Â  currentInputs.total_shares = 0;

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  debouncedUpdate();

Â  Â  }

Â  Â Â 

Â  Â  if (capitalInput) {

Â  Â  Â  Â  capitalInput.addEventListener('input', calculateShares);

Â  Â  }

Â  Â Â 

Â  Â  if (parValueInput) {

Â  Â  Â  Â  parValueInput.addEventListener('input', calculateShares);

Â  Â  }

// ìë³¸ê¸ˆ/ì•¡ë©´ê°€ ë³€ê²½ ê²½ê³ 

function setupChangeWarning(input, fieldName) {

Â  Â  let originalValue = '';

Â  Â Â 

Â  Â  // í¬ì»¤ìŠ¤ ì‹œ ì´ˆê¸°ê°’ ì €ì¥

Â  Â  input.addEventListener('focus', function() {

Â  Â  Â  Â  originalValue = unformat(this.value) || '';

Â  Â  });

Â  Â Â 

Â  Â  // í¬ì»¤ìŠ¤ ë²—ì–´ë‚  ë•Œë§Œ ì²´í¬ (ì…ë ¥ ì™„ë£Œ í›„)

Â  Â  input.addEventListener('blur', function() {

Â  Â  Â  Â  const currentValue = unformat(this.value) || '';

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (originalValue && currentValue) {

Â  Â  Â  Â  Â  Â  const originalNum = parseFloat(originalValue) || 0;

Â  Â  Â  Â  Â  Â  const currentNum = parseFloat(currentValue) || 0;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  // ê°’ì´ ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸

Â  Â  Â  Â  Â  Â  if (originalNum !== currentNum) {

Â  Â  Â  Â  Â  Â  Â  Â  const userConfirmed = confirm(`âš ï¸ ${fieldName} ë³€ê²½ ê²½ê³ \n\n${fieldName}ì„(ë¥¼) ë³€ê²½í•˜ë©´ ì£¼ì‹ìˆ˜ê°€ ì¬ê³„ì‚°ë˜ì–´ 1ì£¼ë‹¹ í‰ê°€ì•¡ì´ ë³€ë™ë©ë‹ˆë‹¤.\n\nâ€¢ ì‹¤ì œ ì¦ì/ê°ì/ì•¡ë©´ë¶„í• ì´ ì•„ë‹ˆë¼ë©´ ë³€ê²½ì„ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nâ€¢ ì˜ëª» ì…ë ¥í•œ ê²½ìš° "ì·¨ì†Œ"ë¥¼ ëˆŒëŸ¬ ë˜ëŒë¦¬ì„¸ìš”.\n\nê³„ì† ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  if (!userConfirmed) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ì·¨ì†Œ â†’ ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.value = formatNumber(originalValue);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  calculateShares();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.focus();Â  // ë‹¤ì‹œ í¬ì»¤ìŠ¤

Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // í™•ì¸ â†’ ìƒˆ ê°’ ì ìš©

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalValue = currentValue;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  });

}



if (capitalInput) setupChangeWarning(capitalInput, 'ìë³¸ê¸ˆ');

if (parValueInput) setupChangeWarning(parValueInput, 'ì•¡ë©´ê°€');



Â  Â  // ì°½ì—…ì—°ë„ ë“œë¡­ë‹¤ìš´ ìë™ ìƒì„±

Â  Â  const foundingYearSelect = document.getElementById('founding_year');

Â  Â  if (foundingYearSelect) {

Â  Â  Â  Â  const currentYear = new Date().getFullYear();

Â  Â  Â  Â  const startYear = 1950;

Â  Â  Â  Â Â 

Â  Â  Â  Â  for (let year = currentYear; year >= startYear; year--) {

Â  Â  Â  Â  Â  Â  const option = document.createElement('option');

Â  Â  Â  Â  Â  Â  option.value = year;

Â  Â  Â  Â  Â  Â  option.textContent = year + 'ë…„';

Â  Â  Â  Â  Â  Â  foundingYearSelect.appendChild(option);

Â  Â  Â  Â  }

Â  Â  }

};

// ìë³¸í™˜ì›ìœ¨ ë°°ìˆ˜ ê³„ì‚°
function updateMultiplier() {  // â† ì „ì—­ í•¨ìˆ˜ë¡œ ì¦‰ì‹œ ì •ì˜
    const rate = parseFloat(document.getElementById('capital_return_rate').value) || 10;
    const multiplier = (100 / rate).toFixed(2);
    document.getElementById('multiplier_display').value = multiplier;
    setTimeout(() => {
        updateAnalysis();
    }, 100);
}
window.updateMultiplier = updateMultiplier;  // â† windowì—ë„ ë“±ë¡

document.addEventListener('DOMContentLoaded', function() {  // â† DOM ì¤€ë¹„ë˜ë©´ ì¦‰ì‹œ
    updateMultiplier();
});
// ìƒˆ DOM ìš”ì†Œë¥¼ ê¸°ë‹¤ë¦¬ê¸° ìœ„í•´ DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
document.addEventListener('DOMContentLoaded', function() {

    const rateContainer = document.getElementById('surrender-rate-container');
    const addRateBtn = document.getElementById('add-rate-btn');
    let rateRowCounter = 0;

    // í™˜ê¸‰ë¥  ì…ë ¥ í–‰(row)ì„ ë™ì ìœ¼ë¡œ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addRateRow(year = '', rate = '') {
        rateRowCounter++;
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.style.alignItems = 'center';
        div.innerHTML = `
            <div class="input-group" style="margin-bottom:0;">
                <label>ê²½ê³¼ ë…„ìˆ˜</label>
                <input type="number" class="rate-year" min="1" max="50" step="1" value="${year}" placeholder="ì˜ˆ: 5" style="text-align: center;">
                <span>ë…„</span>
            </div>
            <div class="input-group" style="margin-bottom:0;">
                <label>í™˜ê¸‰ë¥ </label>
                <input type="number" class="rate-percent" min="0" max="200" step="0.1" value="${rate}" placeholder="ì˜ˆ: 47.5" style="text-align: center;">
                <span>%</span>
            </div>
            <button type="button" class="btn danger small btn-remove-rate" title="ì‚­ì œ">
                <i class="fas fa-times"></i>
            </button>
        `;
        rateContainer.appendChild(div);
    }

    // 'í•­ëª© ì¶”ê°€' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if (addRateBtn) {
        addRateBtn.addEventListener('click', () => addRateRow());
    }

    // 'ì‚­ì œ' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹)
    if (rateContainer) {
        rateContainer.addEventListener('click', function(e) {
            if (e.target && (e.target.matches('.btn-remove-rate') || e.target.closest('.btn-remove-rate'))) {
                e.target.closest('.dynamic-item').remove();
            }
        });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ í•­ëª© 2ê°œ ì¶”ê°€
    addRateRow(5, 47.5);
    addRateRow(10, 102.5);
});

// ì‚¬ìš©ìê°€ ì…ë ¥í•œ ëª¨ë“  í™˜ê¸‰ë¥  ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” í•¨ìˆ˜
function getCustomSurrenderRates() {
    const rates = [];
    const rows = document.querySelectorAll('#surrender-rate-container .dynamic-item');
    rows.forEach(row => {
        const yearInput = row.querySelector('.rate-year');
        const rateInput = row.querySelector('.rate-percent');
        
        // ë‘ ì…ë ¥ í•„ë“œê°€ ëª¨ë‘ ì¡´ì¬í•˜ê³  ê°’ì´ ìˆì„ ë•Œë§Œ ì¶”ê°€
        if (yearInput && rateInput && yearInput.value && rateInput.value) {
            rates.push({
                year: parseInt(yearInput.value),
                rate: parseFloat(rateInput.value)
            });
        }
    });
    // ë…„ë„ ìˆœìœ¼ë¡œ ì •ë ¬
    return rates.sort((a, b) => a.year - b.year);
}
</script>
<script>
/* === Inline ë¶„ì„/ê²½ê³  ë°°ì¹˜ ìœ í‹¸ === */
(function(){
  // 1) í‰ê°€ ê·œì¹™ ì •ì˜: idë³„ ì„ê³„ì¹˜Â·ë©”ì‹œì§€
  // â€» ìˆ«ì(ì›, %)ëŠ” ì ˆëŒ€ê°’ ê¸°ì¤€. í•„ìš” ì‹œ ê°’ë§Œ ë°”ê¾¸ë©´ ë¨.
  const RULES = {
    // ì¬ë¬´/ë¦¬ìŠ¤í¬ í•µì‹¬
    adv_payments: {               // ê°€ì§€ê¸‰ê¸ˆ
      type:'number',
      thresholds:[
        {min:100000000, level:'warn',   text:'ê°€ì§€ê¸‰ê¸ˆ ê·œëª¨ê°€ ì»¤ì§€ê³  ìˆìŠµë‹ˆë‹¤.'},
        {min:200000000, level:'danger', text:'ê°€ì§€ê¸‰ê¸ˆ ê³¼ë‹¤! ì„¸ë¬´ ë¦¬ìŠ¤í¬ ê²€í†  ê¶Œì¥'}
      ]
    },
    retained_earnings: {          // ë¯¸ì²˜ë¶„ì´ìµì‰ì—¬ê¸ˆ
      type:'number',
      thresholds:[
        {min:500000000, level:'warn',   text:'ì´ìµì‰ì—¬ê¸ˆì´ ëˆ„ì  ì¤‘ì…ë‹ˆë‹¤.'},
        {min:1000000000,level:'danger', text:'ì´ìµì‰ì—¬ê¸ˆ ê³¼ë‹¤! ë°°ë‹¹/ìœ ë³´ì „ëµ ì ê²€'}
      ]
    },
    corporate_card: {             // ë²•ì¸ì¹´ë“œ ì‚¬ìš©ì•¡(ì—°)
      type:'number',
      thresholds:[
        {min:50000000, level:'warn',   text:'ë²•ì¸ì¹´ë“œ ì‚¬ìš©ì•¡ ì¦ê°€ ì¶”ì„¸'},
        {min:100000000,level:'danger', text:'ë²•ì¸ì¹´ë“œ ê³¼ë‹¤! ë¹„ìš© ê´€ë¦¬ í•„ìš”'}
      ]
    },
    entertainment: {              // ì ‘ëŒ€ë¹„(ì—°)
      type:'number',
      thresholds:[
        {min:30000000, level:'warn',   text:'ì ‘ëŒ€ë¹„ê°€ ë†’ì€ í¸ì…ë‹ˆë‹¤.'},
        {min:60000000, level:'danger', text:'ì ‘ëŒ€ë¹„ ê³¼ë‹¤! ì„¸ë¬´ ë¦¬ìŠ¤í¬ ì£¼ì˜'}
      ]
    },
    nominee_stock: {              // ëª…ì˜ì‹ íƒì£¼ì‹ ë³´ìœ  ì—¬ë¶€
      type:'select',
      map:{
        'yes': {level:'danger', text:'ëª…ì˜ì‹ íƒì£¼ì‹ ë³´ìœ ! ì„¸ë¬´/ë²•ë¥  ë¦¬ìŠ¤í¬'},
        'no' : null
      }
    },
    successor: {                  // ìŠ¹ê³„ì˜ˆì • í›„ê³„ì ìœ ë¬´
      type:'select',
      map:{
        'no' : {level:'warn',   text:'í›„ê³„ì ë¯¸ì§€ì •: ìŠ¹ê³„ ê³„íš ìˆ˜ë¦½ í•„ìš”'},
        'yes': null
      }
    },
    tax_return_review: {          // ìµœê·¼ 5ë…„ ì„¸ë¬´ì‹ ê³  ì „ë¬¸ê°€ ê²€í†  ì—¬ë¶€
      type:'select',
      map:{
        'no' : {level:'warn',   text:'ì„¸ë¬´ì‹ ê³  ì •ê¸° ì ê²€ ê¶Œì¥'},
        'yes': null
      }
    },
    rnd_credit: {                 // R&D ì„¸ì•¡ê³µì œ ì‹ ì²­ ì´ë ¥
      type:'select',
      map:{
        'no' : {level:'info',   text:'R&D ê³µì œ ê²€í†  ì—¬ì§€'},
        'yes': null
      }
    },
    sme_benefit: {                // ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€ ì ìš© ì—¬ë¶€
      type:'select',
      map:{
        'no' : {level:'info',   text:'íŠ¹ë¡€ ì ìš© ê°€ëŠ¥ì„± ê²€í† '},
        'yes': null
      }
    },
    employment_credit: {          // ê³ ìš©ì¦ëŒ€ ì„¸ì•¡ê³µì œ ìˆ˜í˜œ ì—¬ë¶€
      type:'select',
      map:{
        'no' : {level:'info',   text:'ê³ ìš© ê³µì œ ê²€í† '},
        'yes': null
      }
    }
  };

  // 2) ìˆ«ì íŒŒì„œ (ì‰¼í‘œ/ê³µë°± ì œê±°)
  function toNumber(val){
    if(val == null) return 0;
    const s = String(val).replace(/[^\d.-]/g,'').trim();
    const n = Number(s);
    return isNaN(n)?0:n;
  }

  // 3) ì¸ë¼ì¸ ì»¨í…Œì´ë„ˆ ë³´ì¥ (ì…ë ¥ì¹¸ ì˜†ì— ë™ì ìœ¼ë¡œ ìƒì„±)
  function ensureInlineBox(inputEl){
    const field = inputEl.closest('.input-field');
    if(!field) return null;
    let box = field.querySelector('.inline-insight');
    if(!box){
      box = document.createElement('div');
      box.className = 'inline-insight';
      field.appendChild(box);
    }
    return box;
  }

  // 4) í‰ê°€ í›„ DOM ë°˜ì˜
  function renderInline(id, result){
    const el = document.getElementById(id);
    if(!el) return;
    const box = ensureInlineBox(el);
    if(!box) return;

    if(!result){ box.innerHTML=''; box.className='inline-insight'; return; }

    box.className = 'inline-insight ' + result.level;
    const icon = result.level==='danger' ? 'fa-triangle-exclamation'
              : result.level==='warn'   ? 'fa-circle-exclamation'
              : 'fa-circle-info';
    box.innerHTML = `<span class="pill"><i class="fa-solid ${icon}"></i>${result.text}</span>`;
  }

  // 5) ê·œì¹™ í‰ê°€
  function evaluate(id){
    const rule = RULES[id];
    if(!rule) return null;
    const el = document.getElementById(id);
    if(!el) return null;

    if(rule.type==='number'){
      const v = toNumber(el.value);
      let hit = null;
      (rule.thresholds||[]).forEach(t=>{
        if(v >= t.min) hit = t; // ê°€ì¥ ë†’ì€ ì„ê³„ì¹˜ë¥¼ ìš°ì„ 
      });
      return hit ? {level:hit.level, text:hit.text} : null;
    }
    if(rule.type==='select'){
      const v = String(el.value||'');
      const mapped = rule.map[v];
      return mapped || null;
    }
    return null;
  }

  // 6) ë°”ì¸ë”© (ì…ë ¥/ì„ íƒ ì‹œ ì¦‰ì‹œ ë°˜ì˜ + ê¸°ì¡´ ë¶„ì„ ê°±ì‹ ë„ í˜¸ì¶œ)
  function bind(){
    Object.keys(RULES).forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const handler = ()=>{
        const res = evaluate(id);
        renderInline(id, res);
        // ê¸°ì¡´ ë¶„ì„ íŒ¨ë„ ê°±ì‹  í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ í˜¸ì¶œ
        try{ if(typeof updateAnalysis==='function') updateAnalysis(); }catch(e){}
      };
      el.addEventListener('input', handler);
      el.addEventListener('change', handler);
      // ì´ˆê¸° ë Œë”
      handler();
    });
  }

  // 7) DOM ì¤€ë¹„ë˜ë©´ ì‹œì‘
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
</script>
<script>
/* === Inline ë¶„ì„/ê²½ê³  + ì»¨í…ìŠ¤íŠ¸ íŒ¨ë„ + ë„¤ë¹„ê²Œì´ì…˜ (âˆ’/â†©/ï¼‹) === */
(function(){
  /* 1) ê·œì¹™: ì…ë ¥ idë³„ ì„ê³„ì¹˜/ë©”ì‹œì§€ (í•„ìš” ì‹œ ìˆ«ìÂ·ë¬¸êµ¬ë§Œ ìˆ˜ì •) */
  const RULES = {
    adv_payments: { // ê°€ì§€ê¸‰ê¸ˆ
      type:'number',
      thresholds:[
        {min:100000000, level:'warn',   text:'ê°€ì§€ê¸‰ê¸ˆ ê·œëª¨ê°€ ì»¤ì§€ê³  ìˆìŠµë‹ˆë‹¤.'},
        {min:200000000, level:'danger', text:'ê°€ì§€ê¸‰ê¸ˆ ê³¼ë‹¤! ì„¸ë¬´ ë¦¬ìŠ¤í¬ ê²€í†  ê¶Œì¥'}
      ]
    },
    retained_earnings: { // ë¯¸ì²˜ë¶„ì´ìµì‰ì—¬ê¸ˆ
      type:'number',
      thresholds:[
        {min:500000000,  level:'warn',   text:'ì´ìµì‰ì—¬ê¸ˆì´ ëˆ„ì  ì¤‘ì…ë‹ˆë‹¤.'},
        {min:1000000000, level:'danger', text:'ì´ìµì‰ì—¬ê¸ˆ ê³¼ë‹¤! ë°°ë‹¹/ìœ ë³´ì „ëµ ì ê²€'}
      ]
    },
    corporate_card: { // ë²•ì¸ì¹´ë“œ ì‚¬ìš©ì•¡(ì—°)
      type:'number',
      thresholds:[
        {min:50000000,  level:'warn',   text:'ë²•ì¸ì¹´ë“œ ì‚¬ìš©ì•¡ ì¦ê°€ ì¶”ì„¸'},
        {min:100000000, level:'danger', text:'ë²•ì¸ì¹´ë“œ ê³¼ë‹¤! ë¹„ìš© ê´€ë¦¬ í•„ìš”'}
      ]
    },
    entertainment: { // ì ‘ëŒ€ë¹„(ì—°)
      type:'number',
      thresholds:[
        {min:30000000,  level:'warn',   text:'ì ‘ëŒ€ë¹„ê°€ ë†’ì€ í¸ì…ë‹ˆë‹¤.'},
        {min:60000000,  level:'danger', text:'ì ‘ëŒ€ë¹„ ê³¼ë‹¤! ì„¸ë¬´ ë¦¬ìŠ¤í¬ ì£¼ì˜'}
      ]
    },
    nominee_stock: { // ëª…ì˜ì‹ íƒì£¼ì‹ ë³´ìœ 
      type:'select',
      map:{ 'yes': {level:'danger', text:'ëª…ì˜ì‹ íƒì£¼ì‹ ë³´ìœ ! ì„¸ë¬´/ë²•ë¥  ë¦¬ìŠ¤í¬'}, 'no': null }
    },
    successor: { // ìŠ¹ê³„ì˜ˆì • í›„ê³„ì
      type:'select',
      map:{ 'no': {level:'warn', text:'í›„ê³„ì ë¯¸ì§€ì •: ìŠ¹ê³„ ê³„íš ìˆ˜ë¦½ í•„ìš”'}, 'yes': null }
    },
    tax_return_review: { // ìµœê·¼ 5ë…„ ì„¸ë¬´ì‹ ê³  ì „ë¬¸ê°€ ê²€í† 
      type:'select',
      map:{ 'no': {level:'warn', text:'ì„¸ë¬´ì‹ ê³  ì •ê¸° ì ê²€ ê¶Œì¥'}, 'yes': null }
    },
    rnd_credit: { // R&D ì„¸ì•¡ê³µì œ
      type:'select',
      map:{ 'no': {level:'info', text:'R&D ê³µì œ ê²€í†  ì—¬ì§€'}, 'yes': null }
    },
    sme_benefit: { // ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€
      type:'select',
      map:{ 'no': {level:'info', text:'íŠ¹ë¡€ ì ìš© ê°€ëŠ¥ì„± ê²€í† '}, 'yes': null }
    },
    employment_credit: { // ê³ ìš©ì¦ëŒ€ ê³µì œ
      type:'select',
      map:{ 'no': {level:'info', text:'ê³ ìš© ê³µì œ ê²€í† '}, 'yes': null }
    }
  };

  /* 2) ìœ í‹¸ */
  function toNumber(val){
    if(val == null) return 0;
    const s = String(val).replace(/[^\d.-]/g,'').trim();
    const n = Number(s);
    return isNaN(n) ? 0 : n;
  }
  function ensureInlineBox(inputEl){
    const field = inputEl.closest('.input-field');
    if(!field) return null;
    let box = field.querySelector('.inline-insight');
    if(!box){
      box = document.createElement('div');
      box.className = 'inline-insight';
      field.appendChild(box);
    }
    return box;
  }

  /* 3) ì¸ë¼ì¸ ë Œë” */
  function renderInline(id, result){
    const el = document.getElementById(id);
    if(!el) return;
    const box = ensureInlineBox(el);
    if(!box) return;
    if(!result){ box.innerHTML=''; box.className='inline-insight'; return; }
    box.className = 'inline-insight ' + result.level;
    box.innerHTML = `<span class="pill">${result.text}</span>`;
  }

  /* 4) ê·œì¹™ í‰ê°€ */
  function evaluate(id){
    const rule = RULES[id]; if(!rule) return null;
    const el = document.getElementById(id); if(!el) return null;

    if(rule.type==='number'){
      const v = toNumber(el.value);
      let hit = null;
      (rule.thresholds||[]).forEach(t=>{ if(v >= t.min) hit = t; });
      return hit ? {level:hit.level, text:hit.text} : null;
    }
    if(rule.type==='select'){
      const v = String(el.value||'');
      const mapped = rule.map[v];
      return mapped || null;
    }
    return null;
  }

  /* 5) ì»¨í…ìŠ¤íŠ¸ íŒ¨ë„(ìŠ¤í‹°í‚¤) */
  const panel   = document.getElementById('contextPanel');
  const cpTitle = panel ? document.getElementById('cp-title') : null;
  const cpMeta  = panel ? document.getElementById('cp-meta')  : null;
  const cpBadges= panel ? document.getElementById('cp-badges'): null;
  const btnPrev = panel ? document.getElementById('cp-prev')  : null;
  const btnBack = panel ? document.getElementById('cp-back')  : null;
  const btnNext = panel ? document.getElementById('cp-next')  : null;
  const btnHide = panel ? document.getElementById('cp-hide')  : null;

  const MAP = {
    adv_payments:     { label:'ê°€ì§€ê¸‰ê¸ˆ',            card:'#card-tax-risk' },
    retained_earnings:{ label:'ë¯¸ì²˜ë¶„ì´ìµì‰ì—¬ê¸ˆ',    card:'#card-dividend' },
    corporate_card:   { label:'ë²•ì¸ì¹´ë“œ ì‚¬ìš©ì•¡',     card:'#card-expense' },
    entertainment:    { label:'ì ‘ëŒ€ë¹„',              card:'#card-expense' },
    nominee_stock:    { label:'ëª…ì˜ì‹ íƒì£¼ì‹',        card:'#card-nominee' },
    successor:        { label:'ìŠ¹ê³„ì˜ˆì • í›„ê³„ì',     card:'#card-succession' },
    tax_return_review:{ label:'ì„¸ë¬´ì‹ ê³  ê²€í† ',       card:'#card-tax-risk' },
    rnd_credit:       { label:'R&D ì„¸ì•¡ê³µì œ',        card:'#card-tax-benefit' },
    sme_benefit:      { label:'ì¤‘ì†Œê¸°ì—… íŠ¹ë¡€',       card:'#card-tax-benefit' },
    employment_credit:{ label:'ê³ ìš©ì¦ëŒ€ ê³µì œ',       card:'#card-tax-benefit' }
  };

  function collectOrder(){
    return Object.keys(MAP).filter(id => document.getElementById(id));
  }
  let ORDER = collectOrder();
  let lastInputId = null;

  // íŒ¨ë„ ë™ê¸°í™” í›…(ì „ì—­ ë…¸ì¶œ 1ê°œ)
  window.dispatchInlineInsight = function(id, level, text){
    lastInputId = id;
    if(!panel) return;

    if(!level || !text){
      panel.classList.remove('visible');
      cpBadges && (cpBadges.innerHTML='');
      cpMeta   && (cpMeta.textContent='');
      cpTitle  && (cpTitle.textContent='í˜„ì¬ ì„ íƒ í•­ëª©');
      return;
    }
    const meta = MAP[id] || {label:id};
    cpTitle && (cpTitle.textContent = meta.label);
    if(cpMeta){
      const now = new Date();
      cpMeta.textContent = `ì‹¤ì‹œê°„ ë¶„ì„ Â· ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    }
    cpBadges && (cpBadges.innerHTML = `<span class="pill ${level}">${text}</span>`);
    panel.classList.add('visible');
  };

  // ê³µí†µ ì´ë™/í¬ì»¤ìŠ¤
  function focusInputById(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.scrollIntoView({behavior:'smooth', block:'center'});
    setTimeout(()=>{
      el.focus?.({preventScroll:true});
      el.classList.add('input-flash');
      setTimeout(()=>el.classList.remove('input-flash'), 1200);
    }, 280);
  }
  function go(delta){
    if(!ORDER.length) ORDER = collectOrder();
    if(!lastInputId){ lastInputId = ORDER[0]; }
    const idx = ORDER.indexOf(lastInputId);
    let nextIdx = (idx === -1) ? 0 : idx + delta;
    if(nextIdx < 0) nextIdx = 0;
    if(nextIdx >= ORDER.length) nextIdx = ORDER.length - 1;
    lastInputId = ORDER[nextIdx];
    focusInputById(lastInputId);
  }

  btnPrev && (btnPrev.onclick = ()=> go(-1));     // âˆ’ ì´ì „
  btnNext && (btnNext.onclick = ()=> go(+1));     // ï¼‹ ë‹¤ìŒ
  btnBack && (btnBack.onclick = ()=> {            // â†© í˜„ì¬ë¡œ ë³µê·€
    if(!lastInputId){ ORDER.length && (lastInputId = ORDER[0]); }
    if(lastInputId) focusInputById(lastInputId);
  });
  btnHide && (btnHide.onclick = ()=> panel.classList.remove('visible'));
  document.addEventListener('DOMSubtreeModified', ()=>{ ORDER = collectOrder(); });

  /* 6) ì…ë ¥ ë°”ì¸ë”©: ê°’ì´ ë°”ë€Œë©´ ì¸ë¼ì¸ + íŒ¨ë„ ê°±ì‹  */
  function bind(){
    Object.keys(RULES).forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const handler = ()=>{
        const res = evaluate(id);
        renderInline(id, res);
        if(res){ window.dispatchInlineInsight(id, res.level, res.text); }
        else   { window.dispatchInlineInsight(id, null, null); }
      };
      el.addEventListener('input', handler);
      el.addEventListener('change', handler);
      handler(); // ì´ˆê¸° ë Œë”
    });
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const saveBtn = document.querySelector('#save-btn');
  const loadBtn = document.querySelector('#load-btn');
  const newBtn = document.querySelector('#new-btn');

  // íŒŒì¼ëª… í˜•ì‹: ê¸°ì—…ëª…_ê³ ê°ëª…_ë‚ ì§œ
  saveBtn.addEventListener('click', () => {
    const company = document.querySelector('#company_name')?.value.trim() || 'ë¬´ëª…ê¸°ì—…';
    const ceo = document.querySelector('#consultant_name')?.value.trim() || 'ë¬´ëª…ê³ ê°';
    const today = new Date().toISOString().slice(0, 10);
    const fileName = `${company}_${ceo}_${today}.json`;

    const inputs = document.querySelectorAll('input, select, textarea');
    const data = {};
    inputs.forEach(el => data[el.id] = el.value);

    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
  });

  // ë¶ˆëŸ¬ì˜¤ê¸° (JSON íŒŒì¼ ì½ê¸°)
  loadBtn.addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const data = JSON.parse(ev.target.result);
        for (let key in data) {
          const el = document.querySelector('#' + key);
          if (el) el.value = data[key];
        }
        alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
      };
      reader.readAsText(file);
    };
    input.click();
  });

  // ìƒˆë¬¸ì„œ (í™•ì¸ í›„ ìƒˆë¡œê³ ì¹¨)
  newBtn.addEventListener('click', () => {
    if (confirm('ëª¨ë“  ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      location.reload();
    }
  });
});
</script>
<script>
/* ===== ìˆ«ì ì½¤ë§ˆí¬ë§· + ìë³¸ê¸ˆ/ì•¡ë©´ê°€ â†’ ì£¼ì‹ìˆ˜ ìë™ê³„ì‚° (ì™„ì „ ì—°ë™) ===== */
(function () {
  /* ---------- ê³µí†µ ìœ í‹¸(ì „ì—­ì— ì´ë¯¸ ìˆìœ¼ë©´ ê±´ë„ˆëœ€) ---------- */
  const hasGlobalFormatters = (typeof window.unformat === 'function') && (typeof window.formatNumber === 'function');

  // ì½¤ë§ˆ ì œê±°(ì›ì‹œê°’ ì¶”ì¶œ). ì „ì—­ unformatì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©.
  function unfmt(v){
    if (hasGlobalFormatters) return window.unformat(v);
    return String(v||'').replace(/[^\d.-]/g,'');
  }
  // ì½¤ë§ˆ ì¶”ê°€. ì „ì—­ formatNumberê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©.
  function fmt(n){
    if (hasGlobalFormatters) return window.formatNumber(n);
    const s = String(n ?? '').replace(/[^\d.-]/g,'');
    if (s === '' || s === '-' || s === '.' || s === '-.') return s;
    const neg = s.startsWith('-') ? '-' : '';
    const [int, dec] = s.replace(/^-/, '').split('.');
    const intFmt = int.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return dec !== undefined ? neg + intFmt + '.' + dec : neg + intFmt;
  }

  /* ---------- ìˆ«ì ì…ë ¥ ì‹¤ì‹œê°„ ì½¤ë§ˆ í¬ë§·í„° ---------- */
  const NUM_SEL = 'input[inputmode="numeric"], input[data-numeric="true"]';

  function caretReposition(el, before, after){
    const start = el.selectionStart;
    const leftDigits = (before.slice(0, start).match(/\d/g)||[]).length;
    el.value = after;
    // ì™¼ìª½ì— ê°™ì€ ìˆ˜ì˜ ìˆ«ìê°€ ë‚˜ì˜¤ë„ë¡ ì»¤ì„œ ì´ë™
    let i=0, cnt=0, pos=0; 
    while (i < el.value.length && cnt < leftDigits){ if (/\d/.test(el.value[i])) cnt++; i++; pos=i; }
    el.setSelectionRange(pos, pos);
  }

  function mountNumeric(el){
    const onInput = () => {
      const before = el.value;
      // ì „ì—­ unformat ë˜ëŠ” ë¡œì»¬ unfmtë¥¼ ì‚¬ìš©
      const raw = unfmt(before);
      const parts = raw.split('.');
      // ì†Œìˆ˜ì  1ê°œë§Œ í—ˆìš©
      const cleaned = parts.length > 2 ? parts.shift() + '.' + parts.join('') : raw;
      const after = fmt(cleaned);
      caretReposition(el, before, after);
      el.dataset.raw = cleaned;
      el.dispatchEvent(new CustomEvent('numeric:change', { bubbles: true })); // ê³„ì‚° íŠ¸ë¦¬ê±°ìš©
    };
    const onBlur = () => {
      el.value = fmt(unfmt(el.value)); 
      el.dataset.raw = unfmt(el.value);
    };
    const onPaste = (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text') || '';
      const insert = fmt(unfmt(text));
      const before = el.value;
      const s = el.selectionStart, t = el.selectionEnd;
      caretReposition(el, before, before.slice(0, s) + insert + before.slice(t));
      el.dataset.raw = unfmt(el.value);
      el.dispatchEvent(new Event('input', { bubbles:true }));
    };

    el.addEventListener('input', onInput);
    el.addEventListener('blur', onBlur);
    el.addEventListener('paste', onPaste);

    // ì´ˆê¸° í¬ë§·
    el.value = fmt(unfmt(el.value));
    el.dataset.raw = unfmt(el.value);
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll(NUM_SEL).forEach(mountNumeric);
  });

  /* ---------- ìë³¸ê¸ˆ/ì•¡ë©´ê°€ â†’ ë°œí–‰ì£¼ì‹ ì´ìˆ˜ ìë™ ê³„ì‚° ---------- */
  function pick(selList){ for (const s of selList){ const el = document.querySelector(s); if (el) return el; } return null; }
  const capitalEl = pick(['#capital','[data-role="capital"]','#capital_amount','#paid_in_capital']);
  const parEl     = pick(['#par_value','[data-role="par"]','#face_value']);
  const sharesEl  = pick(['#total_shares','[data-role="shares"]','#issued_shares','#shares_total']);

  if (!capitalEl || !parEl || !sharesEl) return; // ìš”ì†Œ ëª» ì°¾ìœ¼ë©´ ì¢…ë£Œ

  function numRaw(el){
    // ì½¤ë§ˆ í¬ë§·í„°ê°€ ìˆìœ¼ë©´ dataset.raw, ì—†ìœ¼ë©´ valueì—ì„œ ì œê±°
    const s = (el.dataset && typeof el.dataset.raw === 'string') ? el.dataset.raw : el.value;
    const v = parseFloat(unfmt(s));
    return isFinite(v) ? v : NaN;
  }
  function recompute(){
    const capital = numRaw(capitalEl);
    const par     = numRaw(parEl);
    if (isFinite(capital) && isFinite(par) && par > 0){
      const shares = Math.floor(capital / par); // ì •ìˆ˜ ì£¼ì‹ìˆ˜
      sharesEl.value = fmt(shares);
      if (sharesEl.dataset) sharesEl.dataset.raw = String(shares);
    } else {
      sharesEl.value = '';
      if (sharesEl.dataset) sharesEl.dataset.raw = '';
    }
    // ì›ë³¸ í›„ì† ê³„ì‚°ì´ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ í˜¸ì¶œ
    try{ if (typeof window.debouncedUpdate === 'function') window.debouncedUpdate(); }catch(e){}
    try{ if (typeof window.updateAnalysis   === 'function') window.updateAnalysis();   }catch(e){}
    try{ if (typeof window.updateMultiplier === 'function') window.updateMultiplier(); }catch(e){}
  }

  // ì…ë ¥Â·ë³€ê²½Â·í¬ë§·í„° ì´ë²¤íŠ¸ ëª¨ë‘ ë°˜ì˜
  ['input','change','numeric:change','blur'].forEach(ev => {
    capitalEl.addEventListener(ev, recompute);
    parEl.addEventListener(ev, recompute);
  });

  // ì´ˆê¸° 1íšŒ ê³„ì‚°
  document.addEventListener('DOMContentLoaded', recompute);

  // ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ê°€ value/data-rawë¥¼ ì£¼ì…í•´ë„ ë°˜ì‘í•˜ë„ë¡ ê´€ì°°
  const mo = new MutationObserver(recompute);
  mo.observe(capitalEl, { attributes:true, attributeFilter:['value','data-raw'] });
  mo.observe(parEl,     { attributes:true, attributeFilter:['value','data-raw'] });
})();
</script>
<script>
/* ===== ECS í†µí•© íŒ¨ì¹˜ (ì¤‘ë³µ ë°©ì§€ ê°€ë“œ) ===== */
(function(){
  if (window.__ECS_PATCH_APPLIED__) return;
  window.__ECS_PATCH_APPLIED__ = true;

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  /* ---------- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°/ìƒˆë¬¸ì„œ ---------- */
  const saveBtn = $('#save-btn'), loadBtn = $('#load-btn'), newBtn = $('#new-btn');
  const progressBar = $('#progress-bar'), saveStatus = $('#save-status');

  function ymd(d=new Date()){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}${m}${dd}`;}
  function sanitize(s){return (s||'').trim().replace(/[\\/:*?"<>|]/g,'_').replace(/\s+/g,'');}
  function tick(p){ if(progressBar) progressBar.style.width = p+'%'; }
  function flash(msg,type='success',ms=1400){
    if(!saveStatus) return; saveStatus.textContent = msg;
    saveStatus.classList.remove('saving','danger','show');
    if(type==='saving') saveStatus.classList.add('saving');
    if(type==='danger') saveStatus.classList.add('danger');
    setTimeout(()=>saveStatus.classList.add('show'),0);
    setTimeout(()=>saveStatus.classList.remove('show'),ms);
  }

  function collect(){
    const data={};
    $$('input,select,textarea').forEach(el=>{
      if(!el.id) return;
      if(el.type==='checkbox') data[el.id]=el.checked;
      else if(el.type==='radio'){ if(el.checked) data[el.name||el.id]=el.value; }
      else data[el.id]=el.dataset && el.dataset.raw ? el.dataset.raw : el.value;
    });
    return data;
  }
  function apply(payload){
    if(!payload||typeof payload!=='object') return;
    Object.entries(payload).forEach(([k,v])=>{
      const radios = $$(`input[type="radio"][name="${k}"]`);
      if(radios.length){ radios.forEach(r=>r.checked=(r.value==v)); return; }
      const el = $('#'+k); if(!el) return;
      if(el.type==='checkbox') el.checked = !!v; else el.value = v ?? '';
      el.dataset && (el.dataset.raw = String(v ?? ''));
      el.dispatchEvent(new Event('input',{bubbles:true}));
      el.dispatchEvent(new Event('change',{bubbles:true}));
    });
    try{ if(typeof window.updateMultiplier==='function') window.updateMultiplier(); }catch(e){}
    try{ if(typeof window.updateAnalysis==='function')   window.updateAnalysis();   }catch(e){}
  }

  function handleSave(){
    try{
      flash('ì €ì¥ ì¤‘â€¦','saving',2200); tick(30);
      const data = collect(); tick(70);
      const company = sanitize($('#company_name')?.value || 'íšŒì‚¬');
      const client  = sanitize($('#consultant_name')?.value || 'ê³ ê°');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify({_ts:Date.now(), data}, null, 2)],{type:'application/json'}));
      a.download = `${company}_${client}_${ymd()}.json`; a.click();
      tick(100); setTimeout(()=>tick(0),600); flash('ì €ì¥ ì™„ë£Œ');
    }catch(e){ console.error(e); tick(0); flash('ì €ì¥ ì‹¤íŒ¨','danger',2200); }
  }

  let fileInput = $('#__file_input__');
  if(!fileInput){ fileInput=document.createElement('input'); fileInput.type='file'; fileInput.id='__file_input__'; fileInput.accept='application/json'; fileInput.style.display='none'; document.body.appendChild(fileInput); }
  function handleLoad(){ fileInput.value=''; fileInput.click(); }
  fileInput.addEventListener('change', async ()=>{
    const f=fileInput.files?.[0]; if(!f) return;
    flash('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦','saving',2500); tick(30);
    try{ const txt=await f.text(); tick(60); const parsed=JSON.parse(txt); apply(parsed?.data||parsed); tick(100); setTimeout(()=>tick(0),600); flash('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ'); }
    catch(e){ console.error(e); tick(0); flash('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨','danger',2200); }
  });

  function handleNew(){
    const ov=document.createElement('div');
    ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10002;';
    const box=document.createElement('div');
    box.style.cssText='background:#fff;color:#212529;width:min(92vw,420px);border-radius:12px;padding:20px 18px;box-shadow:0 10px 30px rgba(0,0,0,.25);text-align:center;';
    box.innerHTML=`<div style="font-size:1.05rem;line-height:1.6;margin-bottom:14px;">ëª¨ë“  ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤.</div>
      <button type="button" id="__ok" class="btn success" style="min-width:120px;">í™•ì¸</button>`;
    ov.appendChild(box); document.body.appendChild(ov);
    box.querySelector('#__ok').addEventListener('click',()=>{ ov.remove(); document.title='ìƒˆë¬¸ì„œ - Executive Consulting Solution'; location.reload(); });
  }

  saveBtn?.addEventListener('click', handleSave);
  loadBtn?.addEventListener('click', handleLoad);
  newBtn ?.addEventListener('click', handleNew);
  document.addEventListener('keydown',e=>{
    if(e.ctrlKey && (e.key==='s'||e.key==='S')){e.preventDefault();handleSave();}
    if(e.ctrlKey && (e.key==='o'||e.key==='O')){e.preventDefault();handleLoad();}
    if(e.ctrlKey && (e.key==='n'||e.key==='N')){e.preventDefault();handleNew();}
  });

  /* ---------- ìˆ«ì ì½¤ë§ˆ í¬ë§· + ìë™ê³„ì‚°(ìë³¸ê¸ˆ/ì•¡ë©´ê°€â†’ì£¼ì‹ìˆ˜) ---------- */
  function unfmt(v){ return String(v||'').replace(/[^\d.-]/g,''); }
  function fmt(n){
    const s=String(n??''); if(s===''||s==='-'||s==='.'||s==='-.') return s;
    const neg=s.startsWith('-')?'-':''; const [i,d]=s.replace(/^-/, '').split('.');
    const iFmt=i.replace(/\B(?=(\d{3})+(?!\d))/g, ','); return d!==undefined?neg+iFmt+'.'+d:neg+iFmt;
  }
  const NUM_SEL = 'input[inputmode="numeric"], input[data-numeric="true"]';
  function mountNumeric(el){
    const onInput=()=>{ const b=el.value, raw=unfmt(b); const parts=raw.split('.'); const clean=parts.length>2?parts.shift()+'.'+parts.join(''):raw; const a=fmt(clean);
      const start=el.selectionStart; const leftDigits=(b.slice(0,start).match(/\d/g)||[]).length;
      el.value=a; el.dataset.raw=clean;
      let i=0,c=0,pos=0; while(i<el.value.length && c<leftDigits){ if(/\d/.test(el.value[i])) c++; i++; pos=i; } el.setSelectionRange(pos,pos);
      el.dispatchEvent(new CustomEvent('numeric:change',{bubbles:true}));
    };
    const onBlur=()=>{ el.value=fmt(unfmt(el.value)); el.dataset.raw=unfmt(el.value); };
    const onPaste=(e)=>{ e.preventDefault(); const t=(e.clipboardData||window.clipboardData).getData('text')||''; const ins=fmt(unfmt(t));
      const b=el.value, s=el.selectionStart, t2=el.selectionEnd; const next=b.slice(0,s)+ins+b.slice(t2); el.value=next; el.dataset.raw=unfmt(next); el.dispatchEvent(new Event('input',{bubbles:true})); };
    el.addEventListener('input',onInput); el.addEventListener('blur',onBlur); el.addEventListener('paste',onPaste);
    el.value=fmt(unfmt(el.value)); el.dataset.raw=unfmt(el.value);
  }
  document.addEventListener('DOMContentLoaded', ()=>{ $$(NUM_SEL).forEach(mountNumeric); });

  function numRaw(el){ const s=(el.dataset&&typeof el.dataset.raw==='string')?el.dataset.raw:el.value; const v=parseFloat(unfmt(s)); return isFinite(v)?v:NaN; }
  const capitalEl = $('#capital'), parEl = $('#par_value'), sharesEl = $('#total_shares');
  function recomputeShares(){
    if(!capitalEl||!parEl||!sharesEl) return;
    const capital=numRaw(capitalEl), par=numRaw(parEl);
    if(isFinite(capital) && isFinite(par) && par>0){
      const shares=Math.floor(capital/par);
      sharesEl.value=fmt(shares); sharesEl.dataset && (sharesEl.dataset.raw=String(shares));
    }else{ sharesEl.value=''; sharesEl.dataset && (sharesEl.dataset.raw=''); }
    try{ if(typeof window.updateAnalysis==='function') window.updateAnalysis(); }catch(e){}
    try{ if(typeof window.updateMultiplier==='function') window.updateMultiplier(); }catch(e){}
  }
  ['input','change','numeric:change','blur'].forEach(ev=>{
    capitalEl && capitalEl.addEventListener(ev,recomputeShares);
    parEl && parEl.addEventListener(ev,recomputeShares);
  });
  document.addEventListener('DOMContentLoaded', recomputeShares);
})();
</script>
<script>
  // ë™ì  í•­ëª© ê°œìˆ˜ ì¹´ìš´í„°
childrenCount = 0;
shareholdersCount = 0;

  // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.addEventListener('DOMContentLoaded', () => {
    const addChildBtn = document.getElementById('add-child-btn');
    const addShareholderBtn = document.getElementById('add-shareholder-btn');

    if (addChildBtn) addChildBtn.addEventListener('click', addChild);
    if (addShareholderBtn) addShareholderBtn.addEventListener('click', addShareholder);
  });
</script>
<script>
// ë²„íŠ¼ì´ ì¬ë°°ì¹˜/ì¬ìƒì„±ë˜ì–´ë„ í•­ìƒ ë™ì‘í•˜ë„ë¡ ì „ì—­ ìœ„ì„
document.addEventListener('click', (e) => {
  if (e.target.closest('#add-child-btn')) {
    e.preventDefault();
    if (typeof addChild === 'function') addChild();
  }
  if (e.target.closest('#add-shareholder-btn')) {
    e.preventDefault();
    if (typeof addShareholder === 'function') addShareholder();
  }
});
</script>
<script>
/* ì•ˆì „ ë˜í•‘: ê° .input-section .card ì•ˆì—ì„œë§Œ, h4.input-divider ê¸°ì¤€ìœ¼ë¡œ ì„¹ì…˜ ë¬¶ê¸° */
(function(){
  document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.input-section .card');
    cards.forEach(card => {
      const headers = Array.from(card.querySelectorAll(':scope > h4.input-divider'));
      headers.forEach(h4 => {
        if (h4.parentElement.classList.contains('section-card')) return;

        const wrap = document.createElement('div');
        wrap.className = 'section-card';
        h4.before(wrap);
        wrap.appendChild(h4);

        // ê°™ì€ card ì•ˆì—ì„œ ë‹¤ìŒ h4 ì „ê¹Œì§€ ìˆ˜ì§‘
        let sib = wrap.nextElementSibling;
        while (sib && !(sib.matches('h4.input-divider'))) {
          const next = sib.nextElementSibling;
          wrap.appendChild(sib);
          sib = next;
        }
      });
    });
  });
})();
</script>
<script>
/* ì„¹ì…˜ ì œëª©ì— íŠ¹ì • í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ê·¸ ì„¹ì…˜ì„ ê°€ë¡œ ì „ì²´ë¡œ í™•ì¥ */
document.addEventListener('DOMContentLoaded', () => {
  const WIDE_KEYS = [
    'ìƒì„¸ ë¶„ì„', 'ì „ë¬¸ê°€ ì§„ë‹¨', 'ì£¼ì‹ í‰ê°€ì•¡ ì•ˆì „ êµ¬ê°„',
    'ê¸°ê°„ë³„ í™˜ê¸‰ë¥  ì„¤ì •', 'ë©”ëª¨'
  ];
  document.querySelectorAll('.section-card > h4.input-divider').forEach(h => {
    const txt = (h.textContent || '').trim();
    if (WIDE_KEYS.some(k => txt.includes(k))) {
      h.parentElement.classList.add('wide');
    }
  });
});
</script>
</body>
</html>