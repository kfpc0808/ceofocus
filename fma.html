<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMA - Financial Master Analysis (완전판)</title>
    
    <!-- External Libraries via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        /* 전역 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif, 'Noto Sans KR', 'Malgun Gothic';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--gray-50);
            color: var(--gray-900);
        }

        /* 앱 레이아웃 */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: white;
            padding: 0.75rem 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .header-left h1 {
            font-size: 1.35rem;
            color: var(--primary-color);
            margin: 0;
        }

        .customer-badge {
            background: var(--gray-100);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            color: var(--gray-700);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        /* 탭 네비게이션 */
        .tab-navigation {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            overflow-x: auto;
        }

        .tab-navigation button {
            padding: 0.75rem 1.25rem;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .tab-navigation button:hover {
            background: var(--gray-50);
        }

        .tab-navigation button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-navigation button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 메인 컨텐츠 */
        .app-main {
            flex: 1;
            padding: 1rem 1.25rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* 폼 스타일 - 공간 효율성 극대화 */
        .form-section {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .form-section:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .form-section h2 {
            margin-bottom: 1rem;
            color: var(--gray-900);
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.3px;
            padding-bottom: 0.625rem;
            border-bottom: 2px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-section h3 {
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--gray-800);
            font-size: 1.05rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 0.875rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.8125rem;
            letter-spacing: -0.1px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1.5px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: var(--gray-50);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--gray-300);
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        }

        /* 입력 필드 크기 조절 */
        .input-short {
            max-width: 120px;
        }

        .input-medium {
            max-width: 200px;
        }

        .input-long {
            max-width: 320px;
        }

        .input-number {
            max-width: 160px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            align-items: start;
        }

        /* 고객 정보 컴팩트 2행 레이아웃 */
        .customer-info-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: end;
        }

        .form-group.compact {
            margin-bottom: 0;
        }

        .form-group.compact.wide {
            grid-column: span 2;
        }

        .form-group.compact.checkbox-group {
            display: flex;
            align-items: center;
            padding-top: 1.625rem;
        }

        .form-group.compact.checkbox-group label {
            margin-bottom: 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .form-group.compact input,
        .form-group.compact select {
            width: 100%;
        }

        /* 버튼 - 컴팩트 디자인 */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            letter-spacing: -0.2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1.5px solid var(--gray-200);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            border-radius: 6px;
        }

        /* 보험 카드 - 공간 효율성 극대화 */
        .insurance-list {
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
        }

        .insurance-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            padding: 1rem;
            border-radius: 10px;
            border: 1.5px solid var(--gray-200);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
            transition: all 0.2s ease;
        }

        .insurance-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.08);
            transform: translateY(-1px);
        }

        .insurance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.625rem;
            border-bottom: 1.5px solid var(--gray-200);
        }

        .insurance-header h3 {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.3px;
            margin: 0;
        }

        .insurance-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .insurance-coverages {
            margin-top: 1rem;
            padding-top: 0.875rem;
            border-top: 1px solid var(--gray-200);
        }

        .coverages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .coverages-header h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        .coverage-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .coverage-list {
                grid-template-columns: 1fr;
            }
        }

        .coverage-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }

        .coverage-info {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            flex: 1;
            flex-wrap: wrap;
        }

        .coverage-index {
            font-weight: 500;
            color: var(--gray-600);
            min-width: 1rem;
            font-size: 0.8125rem;
        }

        .coverage-name {
            font-weight: 500;
            color: var(--gray-800);
            flex: 1;
            min-width: 110px;
            font-size: 0.875rem;
        }

        .coverage-amount {
            flex: 1;
            min-width: 140px;
        }

        .coverage-unit {
            color: var(--gray-600);
            white-space: nowrap;
            font-size: 0.875rem;
        }

        /* 모달 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h3 {
            font-size: 1.25rem;
            color: var(--gray-800);
            margin: 0;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            overflow-x: auto;
        }

        .modal-tabs button {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            color: var(--gray-600);
        }

        .modal-tabs button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .template-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .category-group h4 {
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .btn-template-checkbox {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-template-checkbox:hover {
            background: var(--gray-50);
        }

        .btn-template-checkbox.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 게이지 섹션 */
        .gauge-section {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: center;
            margin: 2rem 0;
        }

        .gauge-container {
            text-align: center;
            padding: 2rem;
            background: var(--gray-50);
            border-radius: 1rem;
            border: 2px solid var(--gray-200);
        }

        .vs-divider {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gray-400);
        }

        .gauge-value {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 1rem 0;
        }

        .gauge-label {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        .stats-summary {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .stat-value.success { color: var(--success-color); }
        .stat-value.warning { color: var(--warning-color); }
        .stat-value.danger { color: var(--danger-color); }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .chart-card {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
        }

        .chart-card h3 {
            margin-bottom: 1rem;
            color: var(--gray-700);
            font-size: 1rem;
        }

        /* Before & After 카드 */
        .before-after-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: center;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            color: white;
        }

        .before-after-card {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .before-after-label {
            font-size: 1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .before-after-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .before-after-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .arrow-divider {
            font-size: 2rem;
        }

        /* 분석 테이블 */
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .analysis-table th,
        .analysis-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .analysis-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
        }

        /* 리포트 편집 */
        .report-section {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .report-editor {
            margin-bottom: 2rem;
        }

        .report-editor h3 {
            margin-bottom: 1rem;
            color: var(--gray-700);
        }

        .report-editor textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
        }

        .opinion-card {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }

        .opinion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .opinion-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .opinion-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .opinion-content {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .opinion-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* 문구 라이브러리 */
        .phrase-library {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
        }

        .phrase-library h4 {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .phrase-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .phrase-buttons button {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .phrase-buttons button:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 컨설턴트 목록 */
        .customer-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .customer-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s;
        }

        .customer-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .customer-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .customer-card-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .customer-card-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        /* 액션 버튼 */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.625rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* 로딩 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay p {
            margin-top: 1rem;
            font-size: 1.1rem;
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 1.25rem 1rem;
            color: var(--gray-500);
        }

        .empty-state p:first-child {
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
        }

        .hint {
            color: var(--gray-500);
            font-size: 0.8125rem;
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        /* 반응형 - 컴팩트 최적화 */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.625rem 0.875rem;
                gap: 0.5rem;
            }

            .app-main {
                padding: 0.75rem;
            }

            .form-section {
                padding: 0.875rem;
                margin-bottom: 0.75rem;
                border-radius: 8px;
            }

            .form-section h2 {
                font-size: 1.125rem;
                margin-bottom: 0.875rem;
                padding-bottom: 0.5rem;
            }

            .customer-info-row {
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }

            .form-group.compact.checkbox-group {
                padding-top: 0.375rem;
            }

            .form-group.compact.wide {
                grid-column: span 1;
            }

            .form-group {
                margin-bottom: 0.625rem;
            }

            .form-group label {
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }

            .form-group input,
            .form-group select {
                padding: 0.5rem 0.625rem;
                font-size: 0.875rem;
            }

            .invite-link-box {
                padding: 0.875rem;
                border-radius: 8px;
                margin-bottom: 0.75rem;
            }

            .invite-link-box h3 {
                font-size: 1rem;
                margin-bottom: 0.625rem;
            }

            .invite-link-container {
                flex-direction: column;
                align-items: stretch;
            }

            .insurance-card {
                padding: 0.875rem;
                border-radius: 8px;
            }

            .insurance-header {
                margin-bottom: 0.625rem;
                padding-bottom: 0.5rem;
            }

            .insurance-header h3 {
                font-size: 0.9375rem;
            }

            .insurance-info {
                grid-template-columns: 1fr;
                gap: 0.625rem;
                margin-bottom: 0.625rem;
            }

            .insurance-coverages {
                margin-top: 1rem;
                padding-top: 0.875rem;
            }

            .coverages-header {
                margin-bottom: 0.75rem;
            }

            .coverage-list {
                gap: 0.5rem;
            }

            .coverage-item {
                padding: 0.5rem;
                gap: 0.5rem;
            }

            .coverage-info {
                gap: 0.5rem;
            }

            .coverage-name {
                min-width: 100px;
                font-size: 0.875rem;
            }

            .gauge-section {
                grid-template-columns: 1fr;
            }

            .vs-divider {
                transform: rotate(90deg);
                margin: 0.75rem 0;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .before-after-container {
                grid-template-columns: 1fr;
            }

            .arrow-divider {
                transform: rotate(90deg);
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .btn-sm {
                padding: 0.4375rem 0.875rem;
                font-size: 0.8125rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .app-main {
                padding: 1.5rem;
            }

            .form-section {
                padding: 1.25rem;
            }

            .customer-info-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.875rem;
            }

            .form-group.compact.wide {
                grid-column: span 2;
            }

            .insurance-card {
                padding: 1.25rem;
            }
        }

        @media (max-width: 480px) {
            .app-header {
                padding: 0.625rem;
            }

            .app-main {
                padding: 0.625rem;
            }

            .form-section {
                padding: 0.75rem;
                border-radius: 8px;
            }

            .form-section h2 {
                font-size: 1.0625rem;
                margin-bottom: 0.75rem;
            }

            .btn {
                padding: 0.4375rem 0.75rem;
                font-size: 0.8125rem;
            }

            .btn-sm {
                padding: 0.3125rem 0.625rem;
                font-size: 0.75rem;
            }

            .insurance-card {
                padding: 0.75rem;
            }

            .insurance-header h3 {
                font-size: 0.875rem;
            }

            .coverage-name {
                font-size: 0.8125rem;
            }

            .insurance-list {
                gap: 0.625rem;
            }
        }

        .hidden {
            display: none !important;
        }

        /* 고객 초대 링크 박스 - 컴팩트 디자인 */
        .invite-link-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .invite-link-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .invite-link-box:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(102, 126, 234, 0.3);
        }

        .invite-link-box h3 {
            margin-bottom: 1rem;
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
        }

        .invite-link-container {
            display: flex;
            gap: 0.75rem;
            align-items: stretch;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .invite-link-input {
            flex: 1;
            background: white;
            color: var(--gray-900);
            border: none;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: 'Consolas', 'Monaco', monospace;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
        }

        .invite-link-input:focus {
            outline: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .sync-indicator {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
        }

        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(0.95);
            }
        }

        /* 총납입보험료 표시 - 컴팩트 디자인 */
        .total-premium-display {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 0.875rem 1rem;
            border-radius: 8px;
            margin-top: 0.75rem;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 1px 4px rgba(37, 99, 235, 0.1);
            transition: all 0.2s ease;
        }

        .total-premium-display:hover {
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
            transform: translateX(1px);
        }

        .total-premium-display div:first-child {
            color: var(--gray-700);
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
        }

        .total-premium-display strong {
            color: var(--primary-color);
            font-size: 1.0625rem;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ===== 설정 =====
        const GOOGLE_CLIENT_ID = "288996084140-0eo93heqd66hqhg0fh1rbum6scnt3757.apps.googleusercontent.com";
        const GOOGLE_API_KEY = "AIzaSyAVtAzm9UjgGB1pqChvGvGKH7RpH0KCiVM";
        const ENCRYPTION_KEY = "K7mP9nR4sT2vX8wY3zA6bC1dE5fG0hJ9";

        // Firebase 설정 - KFPC Company Support Project
        const firebaseConfig = {
            apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
            authDomain: "kfpc-company-support-project.firebaseapp.com",
            databaseURL: "https://kfpc-company-support-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kfpc-company-support-project",
            storageBucket: "kfpc-company-support-project.firebasestorage.app",
            messagingSenderId: "1012609333373",
            appId: "1:1012609333373:web:ffba9039a7f9568356d914",
            measurementId: "G-Y757PLYBEE"
        };

        // Firebase 초기화
        let database = null;
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            }
        } catch (error) {
            console.warn('Firebase 초기화 실패 (데모 모드로 전환):', error);
        }

        // ===== 데이터 및 템플릿 =====
        const COVERAGE_TEMPLATES = [
            { name: '일반사망', recommended: 100000000, category: '사망' },
            { name: '재해사망', recommended: 100000000, category: '사망' },
            { name: '교통재해사망', recommended: 50000000, category: '사망' },
            { name: '일반암 진단금', recommended: 100000000, category: '암' },
            { name: '소액암 진단금', recommended: 5000000, category: '암' },
            { name: '고액암 진단금', recommended: 30000000, category: '암' },
            { name: '유사암 진단금', recommended: 2000000, category: '암' },
            { name: '암 직접치료비', recommended: 30000000, category: '암' },
            { name: '암입원비', recommended: 50000, category: '암' },
            { name: '암수술비', recommended: 2000000, category: '암' },
            { name: '뇌출혈 진단금', recommended: 50000000, category: '뇌/심장' },
            { name: '뇌경색 진단금', recommended: 50000000, category: '뇌/심장' },
            { name: '급성심근경색 진단금', recommended: 50000000, category: '뇌/심장' },
            { name: '허혈성심장질환', recommended: 30000000, category: '뇌/심장' },
            { name: '중대한질병(CI)', recommended: 50000000, category: 'CI' },
            { name: '입원일당(질병)', recommended: 50000, category: '일상생활' },
            { name: '입원일당(재해)', recommended: 50000, category: '일상생활' },
            { name: '수술비(질병)', recommended: 1000000, category: '일상생활' },
            { name: '수술비(재해)', recommended: 1000000, category: '일상생활' },
            { name: '수술종별 1종', recommended: 500000, category: '일상생활' },
            { name: '수술종별 2종', recommended: 250000, category: '일상생활' },
            { name: '수술종별 3종', recommended: 100000, category: '일상생활' },
            { name: '통원(외래)', recommended: 30000, category: '일상생활' },
            { name: '처방조제비', recommended: 20000, category: '일상생활' },
            { name: '실손의료비', recommended: 50000000, category: '일상생활' },
            { name: '골절진단금', recommended: 500000, category: '기타' },
            { name: '화상진단금', recommended: 1000000, category: '기타' },
            { name: '깁스치료비', recommended: 100000, category: '기타' },
            { name: '장해80% 보장', recommended: 50000000, category: '기타' },
            { name: '장해100% 보장', recommended: 100000000, category: '기타' }
        ];

        const CATEGORIES = ['사망', '암', '뇌/심장', 'CI', '일상생활', '기타'];
        
        const JOB_TITLES = ['지점장', '팀장', '부장', '과장', '대리', '컨설턴트', '직접입력'];

        const PHRASE_LIBRARY = {
            opening: [
                '고객님의 현재 보장 상태를 분석한 결과,',
                '종합적인 검토를 통해',
                '상세한 분석 결과,'
            ],
            adequate: [
                '적정한 수준의 보장이 마련되어 있습니다.',
                '충분한 보장 금액으로 안정적입니다.',
                '현재 보장이 권장 수준을 만족하고 있습니다.'
            ],
            recommend: [
                '추가 보장을 권장드립니다.',
                '보완이 필요한 상황입니다.',
                '단계적인 보장 확대를 고려해보시기 바랍니다.'
            ],
            insufficient: [
                '빠른 시일 내에 보장을 보완하시기를 강력히 권장드립니다.',
                '충분한 보장 마련이 시급합니다.',
                '위험 대비가 부족한 상태이므로 조속한 가입이 필요합니다.'
            ],
            closing: [
                '자세한 상담을 원하시면 언제든 연락 주시기 바랍니다.',
                '궁금하신 점이 있으시면 문의해 주세요.',
                '추가 상담이 필요하시면 말씀해 주시기 바랍니다.'
            ]
        };

        // ===== 유틸리티 함수 =====
        const formatNumber = (num) => {
            if (!num || num === 0 || num === '' || num === '0') return '';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        };

        const formatAmountKorean = (amount) => {
            if (amount >= 100000000) {
                const uk = Math.floor(amount / 100000000);
                const man = Math.floor((amount % 100000000) / 10000);
                if (man > 0) return `${uk}억 ${man.toLocaleString()}만원`;
                return `${uk}억원`;
            } else if (amount >= 10000) {
                const man = Math.floor(amount / 10000);
                return `${man.toLocaleString()}만원`;
            }
            return `${amount.toLocaleString()}원`;
        };

        const getCoverageStatus = (current, recommended) => {
            if (current === 0) return 'none';
            const rate = (current / recommended) * 100;
            if (rate >= 90) return 'adequate';
            if (rate >= 60) return 'recommend';
            return 'insufficient';
        };

        const getStatusText = (status) => {
            switch (status) {
                case 'adequate': return '✅ 적정';
                case 'recommend': return '🟡 보완권장';
                case 'insufficient': return '⚠️ 부족';
                case 'none': return '❌ 없음';
                default: return '';
            }
        };

        const getStatusColor = (status) => {
            switch (status) {
                case 'adequate': return '#10b981';
                case 'recommend': return '#f59e0b';
                case 'insufficient': return '#ef4444';
                case 'none': return '#6b7280';
                default: return '#6b7280';
            }
        };

        // 총납입보험료 계산 함수
        const calculateTotalPremium = (startDate, monthlyPremium) => {
            if (!startDate || !monthlyPremium) return 0;
            
            const start = new Date(startDate);
            const now = new Date();
            
            const months = (now.getFullYear() - start.getFullYear()) * 12 + 
                          (now.getMonth() - start.getMonth());
            
            return months > 0 ? months * monthlyPremium : 0;
        };

        // 경과 개월 수 계산
        const calculateMonthsElapsed = (startDate) => {
            if (!startDate) return 0;
            
            const start = new Date(startDate);
            const now = new Date();
            
            const months = (now.getFullYear() - start.getFullYear()) * 12 + 
                          (now.getMonth() - start.getMonth());
            
            return months > 0 ? months : 0;
        };

        // 의견 생성
        const generateOpinion = (result, customer, consultant) => {
            const { coverageItem, currentAmount, recommendedAmount, status } = result;
            const rate = Math.round((currentAmount / recommendedAmount) * 100);
            const title = consultant.jobTitle === '직접입력' ? consultant.customJobTitle : consultant.jobTitle;

            const header = `💬 ${consultant.name} ${title}의 보장분석 의견\n\n`;

            switch (status) {
                case 'adequate':
                    return header + `현재 ${coverageItem} 보장은 ${formatAmountKorean(currentAmount)}으로 적정 수준입니다. ${customer.name}님의 연령(${customer.age}세)과 연소득(${formatAmountKorean(customer.annualIncome)})을 고려할 때, 충분한 보장이 마련되어 있습니다.`;
                case 'recommend':
                    return header + `현재 ${coverageItem} 보장은 ${formatAmountKorean(currentAmount)}으로 권장 보장의 ${rate}% 수준입니다. 권장 보장액은 ${formatAmountKorean(recommendedAmount)}이며, ${formatAmountKorean(recommendedAmount - currentAmount)}의 추가 보장을 권장드립니다.`;
                case 'insufficient':
                    return header + `현재 ${coverageItem} 보장은 ${formatAmountKorean(currentAmount)}으로 권장 보장의 ${rate}% 수준으로 부족한 상태입니다. ${customer.age}세 연령대에서 해당 위험에 대한 충분한 대비가 중요하므로, 빠른 시일 내에 보장을 보완하시기를 강력히 권장드립니다.`;
                case 'none':
                    return header + `현재 ${coverageItem} 보장이 가입되어 있지 않습니다. 권장 보장액은 ${formatAmountKorean(recommendedAmount)}입니다. 조속한 가입을 권장드립니다.`;
                default:
                    return header + `${coverageItem}에 대한 분석 결과입니다.`;
            }
        };

        // 종합 총평 생성
        const generateSummary = (customer, adequateCount, recommendCount, insufficientCount, noneCount, totalPremium, consultant) => {
            const totalItems = adequateCount + recommendCount + insufficientCount + noneCount;
            const overallRate = Math.round((adequateCount / totalItems) * 100);
            const title = consultant.jobTitle === '직접입력' ? consultant.customJobTitle : consultant.jobTitle;

            let ratingText = '';
            if (overallRate >= 90) ratingText = '매우 우수';
            else if (overallRate >= 75) ratingText = '양호';
            else if (overallRate >= 60) ratingText = '보완 권장';
            else ratingText = '개선 필요';

            return `💬 ${consultant.name} ${title}의 종합 보장분석 의견

${customer.name}님의 전체 보장 분석 결과, 25개 주요 보장 항목 중 적정 보장은 ${adequateCount}건, 보완 권장은 ${recommendCount}건, 부족은 ${insufficientCount}건, 미가입은 ${noneCount}건으로 분석되었습니다.

전체 보장률은 ${overallRate}%로 "${ratingText}" 수준입니다. 현재 월 보험료는 ${formatAmountKorean(totalPremium)}이며, ${customer.annualIncome > 0 ? `연소득 대비 ${Math.round((totalPremium * 12 / customer.annualIncome) * 100)}%` : ''} 수준입니다.

${customer.age}세 연령대에서 특히 중요한 암, 뇌혈관, 심장질환에 대한 보장을 우선적으로 검토하시기를 권장드립니다. ${customer.hasSpouse || customer.numberOfChildren > 0 ? '가족의 경제적 안정을 위해 사망 보장도 중요하게 고려해야 합니다.' : ''}

보장 보완이 필요한 항목들은 고객님의 예산과 우선순위를 고려하여 단계적으로 가입하시는 것을 추천드립니다.`;
        };

        // 암호화
        const encryptData = (data) => {
            return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
        };

        const decryptData = (encryptedData) => {
            const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        };

        // Google Drive 초기화
        const initGoogleDrive = async () => {
            return new Promise((resolve, reject) => {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: GOOGLE_API_KEY,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                        });
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        };

        let tokenClient;
        const requestDriveAccess = async () => {
            return new Promise((resolve, reject) => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (response) => {
                        if (response.error) {
                            reject(response);
                        } else {
                            resolve(response.access_token);
                        }
                    }
                });
                tokenClient.requestAccessToken();
            });
        };

        const uploadToDrive = async (fileName, content) => {
            try {
                await requestDriveAccess();
                
                const metadata = {
                    name: fileName,
                    mimeType: 'application/octet-stream'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([content], { type: 'application/octet-stream' }));

                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                    {
                        method: 'POST',
                        headers: new Headers({ Authorization: `Bearer ${gapi.client.getToken().access_token}` }),
                        body: form,
                    }
                );

                const data = await response.json();
                return data.id;
            } catch (error) {
                console.error('Drive 업로드 실패:', error);
                throw error;
            }
        };

        const listDriveFiles = async () => {
            try {
                await requestDriveAccess();
                
                const response = await gapi.client.drive.files.list({
                    pageSize: 100,
                    fields: 'files(id, name, modifiedTime)',
                    q: "name contains 'FMA_' and name contains '.enc'"
                });
                
                return response.result.files || [];
            } catch (error) {
                console.error('파일 목록 조회 실패:', error);
                return [];
            }
        };

        const downloadFromDrive = async (fileId) => {
            try {
                await requestDriveAccess();
                
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    {
                        headers: new Headers({ Authorization: `Bearer ${gapi.client.getToken().access_token}` })
                    }
                );
                
                return await response.text();
            } catch (error) {
                console.error('파일 다운로드 실패:', error);
                throw error;
            }
        };

        // PDF 생성 (개선된 버전)
        const generatePDF = async (customer, consultant, insurances, analysisResults, summary, opinions) => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let currentPage = 1;

            // 페이지 추가 헬퍼
            const addNewPage = () => {
                pdf.addPage();
                currentPage++;
            };

            // 1. 표지
            pdf.setFillColor(37, 99, 235);
            pdf.rect(0, 0, pageWidth, pageHeight, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(40);
            pdf.text('FMA', pageWidth / 2, 70, { align: 'center' });
            pdf.setFontSize(28);
            pdf.text('Financial Master Analysis', pageWidth / 2, 95, { align: 'center' });
            pdf.setFontSize(22);
            pdf.text('보험 보장 분석 리포트', pageWidth / 2, 120, { align: 'center' });
            
            if (customer.name) {
                pdf.setFontSize(24);
                pdf.text(`${customer.name} 고객님`, pageWidth / 2, 150, { align: 'center' });
            }
            
            pdf.setFontSize(14);
            const today = new Date().toLocaleDateString('ko-KR');
            pdf.text(today, pageWidth / 2, pageHeight - 30, { align: 'center' });

            // 2. 목차
            addNewPage();
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(24);
            pdf.text('목차', 20, 30);
            
            pdf.setFontSize(12);
            const contents = [
                '1. 고객 프로필',
                '2. 보험 가입 현황',
                '3. 보장 분석 요약',
                '4. 항목별 상세 분석',
                '5. 종합 총평',
                '6. 컨설턴트 정보'
            ];
            contents.forEach((item, idx) => {
                pdf.text(item, 30, 50 + (idx * 10));
            });

            // 3. 고객 프로필
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('고객 프로필', 20, 30);
            
            pdf.setFontSize(12);
            let y = 50;
            pdf.text(`이름: ${customer.name}`, 30, y);
            pdf.text(`나이: ${customer.age}세`, 30, y + 10);
            pdf.text(`성별: ${customer.gender}`, 30, y + 20);
            pdf.text(`직업: ${customer.occupation || '-'}`, 30, y + 30);
            pdf.text(`연소득: ${formatAmountKorean(customer.annualIncome)}`, 30, y + 40);
            pdf.text(`배우자: ${customer.hasSpouse ? '있음' : '없음'}`, 30, y + 50);
            pdf.text(`자녀: ${customer.numberOfChildren}명`, 30, y + 60);

            // 4. 보험 가입 현황
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('보험 가입 현황', 20, 30);
            
            y = 50;
            insurances.forEach((insurance, idx) => {
                if (y > pageHeight - 40) {
                    addNewPage();
                    y = 30;
                }
                
                pdf.setFontSize(14);
                pdf.text(`${idx + 1}. ${insurance.company} - ${insurance.productName}`, 30, y);
                pdf.setFontSize(11);
                pdf.text(`월 보험료: ${formatAmountKorean(insurance.monthlyPremium)}`, 35, y + 8);
                if (insurance.startDate) {
                    pdf.text(`가입일: ${insurance.startDate}`, 35, y + 15);
                }
                
                y += 30;
            });

            // 5-6. 보장 분석 요약
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('보장 분석 요약', 20, 30);
            
            const adequate = analysisResults.filter(r => r.status === 'adequate').length;
            const recommend = analysisResults.filter(r => r.status === 'recommend').length;
            const insufficient = analysisResults.filter(r => r.status === 'insufficient').length;
            const none = analysisResults.filter(r => r.status === 'none').length;
            
            pdf.setFontSize(12);
            y = 50;
            pdf.text(`✅ 적정: ${adequate}건`, 30, y);
            pdf.text(`🟡 보완권장: ${recommend}건`, 30, y + 10);
            pdf.text(`⚠️ 부족: ${insufficient}건`, 30, y + 20);
            pdf.text(`❌ 없음: ${none}건`, 30, y + 30);

            // 7-15. 항목별 상세 분석 (주요 10개만)
            const topResults = analysisResults
                .filter(r => r.status !== 'adequate')
                .slice(0, 10);
            
            topResults.forEach((result, idx) => {
                addNewPage();
                pdf.setFontSize(18);
                pdf.text(`${idx + 1}. ${result.coverageItem}`, 20, 30);
                
                pdf.setFontSize(12);
                y = 50;
                pdf.text(`현재 보장: ${formatAmountKorean(result.currentAmount)}`, 30, y);
                pdf.text(`권장 보장: ${formatAmountKorean(result.recommendedAmount)}`, 30, y + 10);
                pdf.text(`보장률: ${Math.round(result.coverageRate)}%`, 30, y + 20);
                pdf.text(`진단: ${getStatusText(result.status)}`, 30, y + 30);
                
                // 의견
                const opinion = opinions[result.coverageItem] || result.opinion;
                const lines = pdf.splitTextToSize(opinion, pageWidth - 60);
                pdf.text(lines, 30, y + 50);
            });

            // 16. 종합 총평
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('종합 총평', 20, 30);
            
            pdf.setFontSize(11);
            const summaryLines = pdf.splitTextToSize(summary, pageWidth - 50);
            pdf.text(summaryLines, 25, 50);

            // 17. 컨설턴트 프로필
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('담당 컨설턴트', 20, 30);
            
            pdf.setFontSize(12);
            y = 50;
            const title = consultant.jobTitle === '직접입력' ? consultant.customJobTitle : consultant.jobTitle;
            pdf.text(`이름: ${consultant.name} ${title}`, 30, y);
            pdf.text(`소속: ${consultant.organization || '-'}`, 30, y + 10);
            pdf.text(`연락처: ${consultant.phone || '-'}`, 30, y + 20);
            pdf.text(`이메일: ${consultant.email || '-'}`, 30, y + 30);

            return pdf;
        };

        // ===== 컴포넌트 =====
        
        // 컨설턴트 프로필 모달
        function ConsultantProfileModal({ consultant, onSave, onClose }) {
            const [profile, setProfile] = useState(consultant || {
                name: '',
                jobTitle: '컨설턴트',
                customJobTitle: '',
                organization: '',
                phone: '',
                email: '',
                signature: null
            });

            const handleSave = () => {
                if (!profile.name) {
                    alert('이름을 입력해주세요.');
                    return;
                }
                onSave(profile);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>⚙️ 컨설턴트 프로필 설정</h3>
                            <button className="btn" onClick={onClose}>✕</button>
                        </div>

                        <div className="modal-body">
                            <div className="form-group">
                                <label>이름 *</label>
                                <input
                                    type="text"
                                    className="input-medium"
                                    value={profile.name}
                                    onChange={(e) => setProfile({...profile, name: e.target.value})}
                                    placeholder="예) 홍길동"
                                />
                            </div>

                            <div className="form-group">
                                <label>직책 *</label>
                                <select 
                                    className="input-medium"
                                    value={profile.jobTitle}
                                    onChange={(e) => setProfile({...profile, jobTitle: e.target.value})}
                                >
                                    {JOB_TITLES.map(title => (
                                        <option key={title} value={title}>{title}</option>
                                    ))}
                                </select>
                            </div>

                            {profile.jobTitle === '직접입력' && (
                                <div className="form-group">
                                    <label>직책 직접입력</label>
                                    <input
                                        type="text"
                                        className="input-medium"
                                        value={profile.customJobTitle}
                                        onChange={(e) => setProfile({...profile, customJobTitle: e.target.value})}
                                        placeholder="예) 선임 컨설턴트"
                                    />
                                </div>
                            )}

                            <div className="form-group">
                                <label>소속</label>
                                <input
                                    type="text"
                                    className="input-long"
                                    value={profile.organization}
                                    onChange={(e) => setProfile({...profile, organization: e.target.value})}
                                    placeholder="예) ○○ 재무설계 센터"
                                />
                            </div>

                            <div className="form-group">
                                <label>연락처</label>
                                <input
                                    type="tel"
                                    className="input-medium"
                                    value={profile.phone}
                                    onChange={(e) => setProfile({...profile, phone: e.target.value})}
                                    placeholder="010-1234-5678"
                                />
                            </div>

                            <div className="form-group">
                                <label>이메일</label>
                                <input
                                    type="email"
                                    className="input-long"
                                    value={profile.email}
                                    onChange={(e) => setProfile({...profile, email: e.target.value})}
                                    placeholder="hong@example.com"
                                />
                            </div>

                            <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'flex-end', marginTop: '1.5rem'}}>
                                <button className="btn btn-secondary" onClick={onClose}>
                                    취소
                                </button>
                                <button className="btn btn-primary" onClick={handleSave}>
                                    💾 저장
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // 보장 항목 추가 모달
        function CoverageAddModal({ onClose, onAdd }) {
            const [activeTab, setActiveTab] = useState('template');
            const [customName, setCustomName] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedItems, setSelectedItems] = useState([]);

            const filteredTemplates = COVERAGE_TEMPLATES.filter(t =>
                t.name.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const toggleSelection = (name) => {
                if (selectedItems.includes(name)) {
                    setSelectedItems(selectedItems.filter(item => item !== name));
                } else {
                    setSelectedItems([...selectedItems, name]);
                }
            };

            const handleAddSelected = () => {
                if (selectedItems.length > 0) {
                    onAdd(selectedItems);
                    onClose();
                }
            };

            const handleAddCustom = () => {
                if (customName.trim()) {
                    const items = customName.split(',').map(item => item.trim()).filter(item => item);
                    if (items.length > 0) {
                        onAdd(items);
                        onClose();
                    }
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>보장 항목 추가 {selectedItems.length > 0 && `(${selectedItems.length}개 선택)`}</h3>
                            <button className="btn" onClick={onClose}>✕</button>
                        </div>

                        <div className="modal-tabs">
                            <button className={activeTab === 'template' ? 'active' : ''} onClick={() => setActiveTab('template')}>
                                ⚡ 자주 쓰는 항목
                            </button>
                            <button className={activeTab === 'search' ? 'active' : ''} onClick={() => setActiveTab('search')}>
                                🔍 검색
                            </button>
                            <button className={activeTab === 'custom' ? 'active' : ''} onClick={() => setActiveTab('custom')}>
                                ✍️ 직접 입력
                            </button>
                        </div>

                        <div className="modal-body">
                            {activeTab === 'template' && (
                                <div className="template-section">
                                    <p className="hint">여러 개를 선택할 수 있습니다. 체크 후 하단의 추가 버튼을 클릭하세요.</p>
                                    {CATEGORIES.map(cat => (
                                        <div key={cat} className="category-group">
                                            <h4>{cat} 보장</h4>
                                            <div className="template-buttons">
                                                {COVERAGE_TEMPLATES.filter(t => t.category === cat).map(template => (
                                                    <label
                                                        key={template.name}
                                                        className={`btn-template-checkbox ${selectedItems.includes(template.name) ? 'selected' : ''}`}
                                                        style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedItems.includes(template.name)}
                                                            onChange={() => toggleSelection(template.name)}
                                                            style={{cursor: 'pointer'}}
                                                        />
                                                        <span>{template.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    <div style={{marginTop: '1.5rem', display: 'flex', gap: '0.5rem', justifyContent: 'flex-end'}}>
                                        <button className="btn btn-secondary" onClick={onClose}>
                                            취소
                                        </button>
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleAddSelected}
                                            disabled={selectedItems.length === 0}
                                        >
                                            {selectedItems.length}개 항목 추가
                                        </button>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'search' && (
                                <div>
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="예) 뇌, 암, 입원..."
                                        style={{width: '100%', padding: '0.75rem', border: '1px solid var(--gray-300)', borderRadius: '0.5rem', marginBottom: '1rem'}}
                                    />
                                    <p className="hint" style={{marginBottom: '1rem'}}>여러 개를 선택할 수 있습니다.</p>
                                    <div style={{maxHeight: '40vh', overflowY: 'auto', marginBottom: '1rem'}}>
                                        {filteredTemplates.map(template => (
                                            <label
                                                key={template.name}
                                                style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '0.75rem',
                                                    padding: '0.75rem',
                                                    borderBottom: '1px solid var(--gray-200)',
                                                    cursor: 'pointer',
                                                    backgroundColor: selectedItems.includes(template.name) ? 'var(--gray-50)' : 'transparent'
                                                }}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={selectedItems.includes(template.name)}
                                                    onChange={() => toggleSelection(template.name)}
                                                    style={{cursor: 'pointer'}}
                                                />
                                                <span>{template.name}</span>
                                            </label>
                                        ))}
                                    </div>
                                    <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'flex-end'}}>
                                        <button className="btn btn-secondary" onClick={onClose}>
                                            취소
                                        </button>
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleAddSelected}
                                            disabled={selectedItems.length === 0}
                                        >
                                            {selectedItems.length}개 항목 추가
                                        </button>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'custom' && (
                                <div>
                                    <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>보장 항목명 (여러 개는 쉼표로 구분)</label>
                                    <textarea
                                        value={customName}
                                        onChange={(e) => setCustomName(e.target.value)}
                                        placeholder="예) 특정 수술비, 당뇨합병증, 신부전증"
                                        style={{width: '100%', minHeight: '100px', padding: '0.75rem', border: '1px solid var(--gray-300)', borderRadius: '0.5rem', marginBottom: '1rem', fontFamily: 'inherit'}}
                                    />
                                    <p className="hint">여러 항목을 한 번에 추가하려면 쉼표(,)로 구분하세요.</p>
                                    <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'flex-end', marginTop: '1rem'}}>
                                        <button className="btn btn-secondary" onClick={onClose}>
                                            취소
                                        </button>
                                        <button
                                            className="btn btn-primary"
                                            onClick={handleAddCustom}
                                            disabled={!customName.trim()}
                                        >
                                            추가하기
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // 고객 목록 화면
        function CustomerListScreen({ savedSessions, onSelect, onNew, onRefresh }) {
            return (
                <div className="form-section">
                    <h2>📋 고객 목록</h2>
                    
                    <div style={{marginBottom: '2rem', display: 'flex', gap: '1rem'}}>
                        <button className="btn btn-primary" onClick={onNew}>
                            + 새 고객 분석 시작
                        </button>
                        <button className="btn btn-secondary" onClick={onRefresh}>
                            🔄 불러오기
                        </button>
                    </div>

                    {savedSessions.length === 0 ? (
                        <div className="empty-state">
                            <p>저장된 고객 데이터가 없습니다.</p>
                            <p className="hint">새 고객 분석을 시작하거나 Google Drive에서 불러오세요.</p>
                        </div>
                    ) : (
                        <div className="customer-list">
                            {savedSessions.map((session, idx) => (
                                <div key={idx} className="customer-card" onClick={() => onSelect(session)}>
                                    <div className="customer-card-header">
                                        <div className="customer-card-name">{session.customer.name}</div>
                                        <div className="status-badge" style={{backgroundColor: 'var(--primary-color)'}}>
                                            {session.customer.age}세
                                        </div>
                                    </div>
                                    <div className="customer-card-info">
                                        <div>{session.customer.gender} · {session.customer.occupation || '-'}</div>
                                        <div>연소득: {formatAmountKorean(session.customer.annualIncome)}</div>
                                        <div>보험: {session.insurances.length}건</div>
                                        <div className="hint">수정일: {session.modifiedTime}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // 메인 앱
        function App() {
            // URL 파라미터로 모드 확인
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            const isCustomerMode = !!sessionId;

            const [currentScreen, setCurrentScreen] = useState(isCustomerMode ? 'analysis' : 'customerList');
            const [currentTab, setCurrentTab] = useState('input');
            const [loading, setLoading] = useState(false);
            const [driveReady, setDriveReady] = useState(false);
            
            const [customer, setCustomer] = useState({
                name: '',
                age: '', // 빈 값으로 시작
                gender: '남성',
                occupation: '',
                annualIncome: '', // 빈 값으로 시작
                hasSpouse: false,
                spouse: {
                    name: '',
                    birthDate: ''
                },
                children: [
                    { id: 1, name: '', birthDate: '' },
                    { id: 2, name: '', birthDate: '' }
                ]
            });

            const [consultant, setConsultant] = useState(null);
            const [showConsultantModal, setShowConsultantModal] = useState(false);
            
            const [insurances, setInsurances] = useState([]);
            
            // localStorage에서 로그인한 사용자 정보 자동 로드
            useEffect(() => {
                const userName = localStorage.getItem('userName');
                const userPhone = localStorage.getItem('userPhone');
                const userCompany = localStorage.getItem('userCompany') || localStorage.getItem('userOrganization');
                const userEmail = localStorage.getItem('userEmail');
                const userJobTitle = localStorage.getItem('userJobTitle');
                
                // 로그인 정보가 있으면 자동으로 컨설턴트 설정
                if (userName) {
                    setConsultant({
                        name: userName || '컨설턴트',
                        company: userCompany || '보험설계사',
                        jobTitle: userJobTitle || '컨설턴트',
                        customJobTitle: '',
                        phone: userPhone || '',
                        email: userEmail || ''
                    });
                }
            }, []);
            const [analysisResults, setAnalysisResults] = useState([]);
            const [summary, setSummary] = useState('');
            const [opinions, setOpinions] = useState({});
            const [showCoverageModal, setShowCoverageModal] = useState(null);
            const [editingOpinion, setEditingOpinion] = useState(null);
            const [savedSessions, setSavedSessions] = useState([]);

            // 실시간 동기화 관련 State
            const [currentSessionId, setCurrentSessionId] = useState(sessionId || null);
            const [inviteLink, setInviteLink] = useState('');
            const [syncStatus, setSyncStatus] = useState('대기중');
            
            // 입력 중 체크 (타이핑 중에는 Firebase로부터 업데이트 받지 않음)
            const isTypingRef = useRef(false);
            const typingTimeoutRef = useRef(null);
            
            // Google Drive 저장 상태 추적
            const [isSavedToDrive, setIsSavedToDrive] = useState(false);
            const [lastSavedTime, setLastSavedTime] = useState(null);

            const chartsRef = useRef(null);
            const comparisonChartRef = useRef(null);
            const categoryChartRef = useRef(null);
            const radarChartRef = useRef(null);
            const premiumChartRef = useRef(null);
            const comparisonChartInstance = useRef(null);
            const categoryChartInstance = useRef(null);
            const radarChartInstance = useRef(null);
            const premiumChartInstance = useRef(null);

            useEffect(() => {
                if (!isCustomerMode) {
                    initGoogleDrive().then(() => {
                        setDriveReady(true);
                        loadSavedSessions();
                    }).catch(err => {
                        console.error('Drive 초기화 실패:', err);
                    });
                }
            }, [isCustomerMode]);
            
            // Session ID localStorage 저장/복원 (고객, 컨설턴트 모두)
            useEffect(() => {
                const urlSessionId = urlParams.get('session');
                
                if (urlSessionId) {
                    // URL에 session이 있으면 localStorage에 저장
                    localStorage.setItem('currentSessionId', urlSessionId);
                    setCurrentSessionId(urlSessionId);
                    
                    // URL도 업데이트 (새로고침 후에도 유지)
                    if (!isCustomerMode) {
                        window.history.replaceState({}, '', `?session=${urlSessionId}`);
                    }
                } else {
                    // URL에 없으면 localStorage에서 복원
                    const savedSessionId = localStorage.getItem('currentSessionId');
                    if (savedSessionId) {
                        setCurrentSessionId(savedSessionId);
                        
                        // URL도 업데이트 (새로고침 후에도 유지)
                        if (!isCustomerMode) {
                            window.history.replaceState({}, '', `?session=${savedSessionId}`);
                        }
                    }
                }
            }, []);

            // Firebase 실시간 동기화 설정
            useEffect(() => {
                if (!database || !currentSessionId) return;

                const sessionRef = database.ref(`sessions/${currentSessionId}`);
                
                // 실시간 리스너 설정
                const listener = sessionRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setSyncStatus('동기화됨');
                        
                        // 입력 중이 아닐 때만 업데이트 받기 (타이핑 방해 방지)
                        if (!isTypingRef.current) {
                            // 모든 데이터 동기화 (컨설턴트, 고객 모두)
                            if (data.customer) setCustomer(data.customer);
                            if (data.consultant) setConsultant(data.consultant);
                            if (data.summary) setSummary(data.summary);
                            if (data.opinions) setOpinions(data.opinions);
                            
                            // insurances와 analysisResults 동기화
                            if (data.insurances) {
                                const insurancesArray = Array.isArray(data.insurances) 
                                    ? data.insurances 
                                    : Object.values(data.insurances).filter(v => v && typeof v === 'object');
                                setInsurances(insurancesArray);
                            }
                            
                            if (data.analysisResults) {
                                const resultsArray = Array.isArray(data.analysisResults)
                                    ? data.analysisResults
                                    : Object.values(data.analysisResults).filter(v => v && typeof v === 'object');
                                setAnalysisResults(resultsArray);
                            }
                        }
                    }
                });

                return () => {
                    sessionRef.off('value', listener);
                };
            }, [currentSessionId, isCustomerMode]);

            // 데이터 변경 시 Firebase 업데이트 (디바운싱 적용)
            useEffect(() => {
                if (!database || !currentSessionId) return;

                // 타이핑 시작 표시
                isTypingRef.current = true;
                
                const timeoutId = setTimeout(() => {
                    const updateData = {
                        customer,
                        insurances,
                        consultant,
                        analysisResults,
                        summary,
                        opinions,
                        updatedAt: Date.now()
                    };

                    database.ref(`sessions/${currentSessionId}`).set(updateData).catch(err => {
                        console.error('Firebase 저장 실패:', err);
                        setSyncStatus('저장 실패');
                    });
                    
                    setSyncStatus('동기화됨');
                    
                    // 타이핑 종료 표시 (500ms 후)
                    isTypingRef.current = false;
                }, 500); // 500ms 디바운싱 (안정적인 실시간 동기화)

                return () => {
                    clearTimeout(timeoutId);
                    // cleanup 시에도 타이핑 플래그 해제
                    if (typingTimeoutRef.current) {
                        clearTimeout(typingTimeoutRef.current);
                    }
                    typingTimeoutRef.current = setTimeout(() => {
                        isTypingRef.current = false;
                    }, 100);
                };
            }, [customer, insurances, consultant, analysisResults, summary, opinions, currentSessionId]);
            
            // 즉시 Firebase 업데이트 (중요한 변경사항용)
            const immediateFirebaseUpdate = () => {
                if (!database || !currentSessionId) return;
                
                // 짧게 타이핑 플래그 설정
                isTypingRef.current = true;
                
                const updateData = {
                    customer,
                    insurances,
                    consultant,
                    analysisResults,
                    summary,
                    opinions,
                    updatedAt: Date.now()
                };

                database.ref(`sessions/${currentSessionId}`).set(updateData).catch(err => {
                    console.error('Firebase 즉시 저장 실패:', err);
                });
                
                setSyncStatus('동기화됨 ✓');
                
                // 200ms 후 타이핑 플래그 해제
                setTimeout(() => {
                    isTypingRef.current = false;
                }, 200);
            };
            
            // 분석 완료 시 자동 Google Drive 저장 (컨설턴트만)
            useEffect(() => {
                if (isCustomerMode || !currentSessionId || analysisResults.length === 0) return;
                
                // 이미 저장되었으면 스킵
                if (isSavedToDrive) return;
                
                // 3초 후 자동 저장 (사용자가 입력을 마칠 시간)
                const autoSaveTimer = setTimeout(async () => {
                    try {
                        console.log('🔄 분석 완료 - 자동 Google Drive 저장 시작...');
                        
                        const session = {
                            customer,
                            insurances,
                            consultant,
                            analysisResults,
                            summary,
                            opinions,
                            sessionId: currentSessionId,
                            savedAt: new Date().toISOString()
                        };

                        const fileName = `FMA_${customer.name || '고객'}_${new Date().toLocaleDateString('ko-KR').replace(/\. /g, '-').replace('.', '')}.json`;
                        const encryptedData = encryptData(session);
                        
                        await uploadToDrive(fileName, encryptedData);
                        
                        setIsSavedToDrive(true);
                        setLastSavedTime(new Date());
                        setSyncStatus('저장 완료');
                        
                        console.log('✅ Google Drive 자동 저장 완료:', fileName);
                    } catch (error) {
                        console.error('❌ Google Drive 자동 저장 실패:', error);
                    }
                }, 3000);

                return () => clearTimeout(autoSaveTimer);
            }, [analysisResults, customer, insurances, consultant, summary, opinions, currentSessionId, isSavedToDrive, isCustomerMode]);

            const loadSavedSessions = async () => {
                try {
                    const files = await listDriveFiles();
                    const sessions = [];
                    
                    for (const file of files.slice(0, 20)) { // 최대 20개만
                        try {
                            const encryptedData = await downloadFromDrive(file.id);
                            const session = decryptData(encryptedData);
                            session.fileId = file.id;
                            session.modifiedTime = new Date(file.modifiedTime).toLocaleString('ko-KR');
                            sessions.push(session);
                        } catch (err) {
                            console.error('파일 로드 실패:', file.name, err);
                        }
                    }
                    
                    setSavedSessions(sessions);
                } catch (error) {
                    console.error('세션 목록 로드 실패:', error);
                }
            };

            const loadSession = (session) => {
                setCustomer(session.customer);
                setConsultant(session.consultant);
                setInsurances(session.insurances);
                setAnalysisResults(session.analysisResults || []);
                setSummary(session.summary || '');
                setOpinions(session.opinions || {});
                setCurrentScreen('analysis');
                setCurrentTab('input');
            };

            const startNewAnalysis = () => {
                setCustomer({
                    name: '',
                    age: '', // 빈 값으로 시작
                    gender: '남성',
                    occupation: '',
                    annualIncome: '', // 빈 값으로 시작
                    hasSpouse: false,
                    spouse: {
                        name: '',
                        birthDate: ''
                    },
                    children: [
                        { id: 1, name: '', birthDate: '' },
                        { id: 2, name: '', birthDate: '' }
                    ]
                });
                setInsurances([]);
                setAnalysisResults([]);
                setSummary('');
                setOpinions({});
                setCurrentScreen('analysis');
                setCurrentTab('input');
                
                // 새 세션 ID 생성
                if (database) {
                    const newSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    setCurrentSessionId(newSessionId);
                    
                    // 초대 링크 생성
                    const baseUrl = window.location.origin + window.location.pathname;
                    const link = `${baseUrl}?session=${newSessionId}`;
                    setInviteLink(link);
                }
            };

            const generateInviteLink = () => {
                if (!database) {
                    alert('Firebase가 설정되지 않았습니다.');
                    return;
                }

                const newSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                setCurrentSessionId(newSessionId);
                
                const baseUrl = window.location.origin + window.location.pathname;
                const link = `${baseUrl}?session=${newSessionId}`;
                setInviteLink(link);
                
                // 초기 데이터 설정
                database.ref(`sessions/${newSessionId}`).set({
                    customer,
                    insurances,
                    consultant,
                    createdAt: Date.now()
                });
            };

            const copyInviteLink = () => {
                navigator.clipboard.writeText(inviteLink);
                alert('초대 링크가 복사되었습니다!');
            };

            const addInsurance = () => {
                const newInsurance = {
                    id: Date.now(),
                    company: '',
                    productName: '',
                    monthlyPremium: '', // 빈 값으로 시작
                    startDate: '',
                    endDate: '',
                    coverages: []
                };
                const updatedInsurances = [...insurances, newInsurance];
                setInsurances(updatedInsurances);
                
                // 즉시 Firebase 업데이트
                if (database && currentSessionId) {
                    // 짧게 타이핑 플래그 설정
                    isTypingRef.current = true;
                    
                    database.ref(`sessions/${currentSessionId}`).update({
                        customer,
                        insurances: updatedInsurances,
                        consultant,
                        analysisResults,
                        summary,
                        opinions,
                        updatedAt: Date.now()
                    });
                    setSyncStatus('보험 추가됨 ✓');
                    
                    // 200ms 후 타이핑 플래그 해제
                    setTimeout(() => {
                        isTypingRef.current = false;
                    }, 200);
                }
            };

            const updateInsurance = (id, field, value) => {
                setInsurances(insurances.map(ins =>
                    ins.id === id ? { ...ins, [field]: value } : ins
                ));
            };

            const removeInsurance = (id) => {
                if (confirm('이 보험을 삭제하시겠습니까?')) {
                    const updatedInsurances = insurances.filter(ins => ins.id !== id);
                    setInsurances(updatedInsurances);
                    
                    // 즉시 Firebase 업데이트
                    if (database && currentSessionId) {
                        // 짧게 타이핑 플래그 설정
                        isTypingRef.current = true;
                        
                        database.ref(`sessions/${currentSessionId}`).update({
                            customer,
                            insurances: updatedInsurances,
                            consultant,
                            analysisResults,
                            summary,
                            opinions,
                            updatedAt: Date.now()
                        });
                        setSyncStatus('보험 삭제됨 ✓');
                        
                        // 200ms 후 타이핑 플래그 해제
                        setTimeout(() => {
                            isTypingRef.current = false;
                        }, 200);
                    }
                }
            };

            const addCoverage = (insuranceId, coverageNames) => {
                const names = Array.isArray(coverageNames) ? coverageNames : [coverageNames];
                setInsurances(insurances.map(ins =>
                    ins.id === insuranceId
                        ? { 
                            ...ins, 
                            coverages: [
                                ...(ins.coverages || []), 
                                ...names.map(name => ({
                                    id: Date.now() + Math.random(),
                                    name: name,
                                    amount: '' // 빈 값으로 시작
                                }))
                            ]
                        }
                        : ins
                ));
            };

            const updateCoverage = (insuranceId, coverageId, amount) => {
                setInsurances(insurances.map(ins =>
                    ins.id === insuranceId
                        ? { ...ins, coverages: (ins.coverages || []).map(c => c.id === coverageId ? { ...c, amount } : c) }
                        : ins
                ));
            };

            const removeCoverage = (insuranceId, coverageId) => {
                setInsurances(insurances.map(ins =>
                    ins.id === insuranceId
                        ? { ...ins, coverages: (ins.coverages || []).filter(c => c.id !== coverageId) }
                        : ins
                ));
            };

            const handleStartAnalysis = () => {
                if (!customer.name) {
                    alert('고객 이름을 입력해주세요.');
                    return;
                }
                if (!customer.age || customer.age === '' || customer.age < 1 || customer.age > 120) {
                    alert('고객 나이를 올바르게 입력해주세요. (1~120세)');
                    return;
                }
                if (insurances.length === 0) {
                    alert('최소 하나의 보험을 추가해주세요.');
                    return;
                }
                
                // consultant가 없으면 기본값 설정 (로그인 정보 없는 경우)
                if (!consultant) {
                    setConsultant({
                        name: '컨설턴트',
                        company: '보험설계사',
                        jobTitle: '컨설턴트',
                        customJobTitle: '',
                        phone: '',
                        email: ''
                    });
                }

                // 분석 수행
                const coverageMap = new Map();
                insurances.forEach(insurance => {
                    insurance.coverages.forEach(coverage => {
                        const current = coverageMap.get(coverage.name) || 0;
                        const amount = typeof coverage.amount === 'number' ? coverage.amount : (parseInt(coverage.amount) || 0);
                        coverageMap.set(coverage.name, current + amount);
                    });
                });

                const results = COVERAGE_TEMPLATES.map(template => {
                    const currentAmount = coverageMap.get(template.name) || 0;
                    const recommendedAmount = template.recommended;
                    const coverageRate = recommendedAmount > 0 ? Math.min((currentAmount / recommendedAmount) * 100, 100) : 0;
                    const status = getCoverageStatus(currentAmount, recommendedAmount);

                    return {
                        coverageItem: template.name,
                        currentAmount,
                        recommendedAmount,
                        coverageRate,
                        status,
                        opinion: generateOpinion({coverageItem: template.name, currentAmount, recommendedAmount, status}, customer, consultant)
                    };
                });

                setAnalysisResults(results);

                // 의견 초기화
                const newOpinions = {};
                results.forEach(r => {
                    newOpinions[r.coverageItem] = r.opinion;
                });
                setOpinions(newOpinions);

                // 종합 의견 생성
                const adequate = results.filter(r => r.status === 'adequate').length;
                const recommend = results.filter(r => r.status === 'recommend').length;
                const insufficient = results.filter(r => r.status === 'insufficient').length;
                const none = results.filter(r => r.status === 'none').length;
                const totalPremium = insurances.reduce((sum, ins) => {
                    const premium = typeof ins.monthlyPremium === 'number' ? ins.monthlyPremium : (parseInt(ins.monthlyPremium) || 0);
                    return sum + premium;
                }, 0);
                const summaryText = generateSummary(customer, adequate, recommend, insufficient, none, totalPremium, consultant);
                setSummary(summaryText);

                setCurrentTab('analysis');
                
                setTimeout(() => {
                    createCharts(results);
                }, 100);
            };

            const createCharts = (results) => {
                // 기존 차트 제거
                if (comparisonChartInstance.current) comparisonChartInstance.current.destroy();
                if (categoryChartInstance.current) categoryChartInstance.current.destroy();
                if (radarChartInstance.current) radarChartInstance.current.destroy();
                if (premiumChartInstance.current) premiumChartInstance.current.destroy();

                // 1. 비교 막대 차트
                if (comparisonChartRef.current) {
                    const ctx = comparisonChartRef.current.getContext('2d');
                    const topItems = results
                        .filter(r => r.recommendedAmount > 0)
                        .sort((a, b) => b.recommendedAmount - a.recommendedAmount)
                        .slice(0, 8);

                    comparisonChartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: topItems.map(r => r.coverageItem),
                            datasets: [
                                {
                                    label: '현재 보장',
                                    data: topItems.map(r => r.currentAmount / 10000),
                                    backgroundColor: 'rgba(37, 99, 235, 0.7)',
                                    borderColor: 'rgba(37, 99, 235, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: '권장 보장',
                                    data: topItems.map(r => r.recommendedAmount / 10000),
                                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                    borderColor: 'rgba(16, 185, 129, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'top' }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '만원';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // 2. 상태 분포 도넛 차트
                if (categoryChartRef.current) {
                    const ctx = categoryChartRef.current.getContext('2d');
                    const adequate = results.filter(r => r.status === 'adequate').length;
                    const recommend = results.filter(r => r.status === 'recommend').length;
                    const insufficient = results.filter(r => r.status === 'insufficient').length;
                    const none = results.filter(r => r.status === 'none').length;

                    categoryChartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['적정', '보완권장', '부족', '미보장'],
                            datasets: [{
                                data: [adequate, recommend, insufficient, none],
                                backgroundColor: [
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(156, 163, 175, 0.8)'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'bottom' }
                            }
                        }
                    });
                }

                // 3. 레이더 차트 (카테고리별 균형도)
                if (radarChartRef.current) {
                    const ctx = radarChartRef.current.getContext('2d');
                    const categoryData = {};
                    CATEGORIES.forEach(cat => {
                        const items = results.filter(r => {
                            const template = COVERAGE_TEMPLATES.find(t => t.name === r.coverageItem);
                            return template && template.category === cat;
                        });
                        const avgRate = items.length > 0 
                            ? items.reduce((sum, r) => sum + r.coverageRate, 0) / items.length 
                            : 0;
                        categoryData[cat] = avgRate;
                    });

                    radarChartInstance.current = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: CATEGORIES,
                            datasets: [{
                                label: '보장률',
                                data: CATEGORIES.map(cat => categoryData[cat]),
                                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                                borderColor: 'rgba(37, 99, 235, 1)',
                                pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(37, 99, 235, 1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // 4. 보험료 분배 도넛 차트
                if (premiumChartRef.current) {
                    const ctx = premiumChartRef.current.getContext('2d');
                    const premiumData = insurances.map(ins => ({
                        name: ins.company,
                        amount: ins.monthlyPremium
                    }));

                    premiumChartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: premiumData.map(p => p.name),
                            datasets: [{
                                data: premiumData.map(p => p.amount),
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(139, 92, 246, 0.8)',
                                    'rgba(236, 72, 153, 0.8)'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.label + ': ' + formatAmountKorean(context.parsed);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            };

            const handleGeneratePDF = async () => {
                if (!customer.name || !analysisResults || analysisResults.length === 0) {
                    alert('분석 결과가 없습니다.');
                    return;
                }

                try {
                    setLoading(true);
                    
                    const pdf = await generatePDF(customer, consultant, insurances, analysisResults, summary, opinions);
                    pdf.save(`FMA_보장분석_${customer.name}_${new Date().toISOString().split('T')[0]}.pdf`);

                    alert('PDF가 성공적으로 생성되었습니다!');
                } catch (error) {
                    console.error('PDF 생성 실패:', error);
                    alert('PDF 생성에 실패했습니다.');
                } finally {
                    setLoading(false);
                }
            };

            const handleSaveToDrive = async (isAuto = false) => {
                if (!customer.name) {
                    if (!isAuto) alert('고객 이름을 먼저 입력해주세요.');
                    return;
                }
                
                if (!driveReady) {
                    if (!isAuto) alert('Google Drive API가 설정되지 않았습니다.\n\n코드 상단의 다음 값을 설정해주세요:\n- GOOGLE_CLIENT_ID\n- GOOGLE_API_KEY\n- ENCRYPTION_KEY\n\n설정 방법은 Google Cloud Console에서 확인하세요.');
                    return;
                }

                try {
                    if (!isAuto) setLoading(true);
                    
                    const session = {
                        customer,
                        consultant,
                        insurances,
                        analysisResults,
                        summary,
                        opinions,
                        sessionId: currentSessionId,
                        savedAt: new Date().toISOString()
                    };

                    const fileName = `FMA_${customer.name || '고객'}_${new Date().toLocaleDateString('ko-KR').replace(/\. /g, '-').replace('.', '')}.json`;
                    const encryptedData = encryptData(session);
                    
                    await uploadToDrive(fileName, encryptedData);
                    
                    setIsSavedToDrive(true);
                    setLastSavedTime(new Date());
                    setSyncStatus('저장 완료');
                    
                    if (!isAuto) {
                        alert('✅ Google Drive에 저장되었습니다!');
                    }
                    
                    console.log('✅ Google Drive 저장 완료:', fileName);
                    
                    // 목록 갱신
                    await loadSavedSessions();
                } catch (error) {
                    console.error('저장 실패:', error);
                    setSyncStatus('저장 실패');
                    if (!isAuto) alert('❌ 저장에 실패했습니다: ' + error.message);
                } finally {
                    if (!isAuto) setLoading(false);
                }
            };
            
            // 세션 종료 함수 (컨설턴트만 - 저장 확인 포함)
            const endSession = () => {
                if (!isSavedToDrive && analysisResults.length > 0) {
                    if (!confirm('⚠️ Google Drive에 저장하지 않았습니다!\n\n저장하지 않고 종료하시겠습니까?')) {
                        return;
                    }
                }
                
                if (confirm('현재 세션을 종료하시겠습니까?')) {
                    // Firebase 세션 데이터 삭제 (선택사항)
                    if (database && currentSessionId) {
                        database.ref(`sessions/${currentSessionId}`).remove();
                    }
                    
                    // localStorage 정리
                    localStorage.removeItem('currentSessionId');
                    
                    // 상태 초기화
                    setCurrentSessionId(null);
                    setInviteLink('');
                    setIsSavedToDrive(false);
                    setLastSavedTime(null);
                    
                    // 기본 화면으로 이동
                    window.location.href = window.location.pathname;
                }
            };

            const handleSaveOpinion = (coverageItem, newOpinion) => {
                setOpinions({
                    ...opinions,
                    [coverageItem]: newOpinion
                });
                setEditingOpinion(null);
            };

            const handleResetOpinion = (coverageItem) => {
                const result = analysisResults.find(r => r.coverageItem === coverageItem);
                if (result) {
                    setOpinions({
                        ...opinions,
                        [coverageItem]: result.opinion
                    });
                }
            };

            const insertPhrase = (phrase) => {
                if (editingOpinion) {
                    const currentText = opinions[editingOpinion] || '';
                    setOpinions({
                        ...opinions,
                        [editingOpinion]: currentText + '\n' + phrase
                    });
                }
            };

            const adequateCount = (analysisResults || []).filter(r => r.status === 'adequate').length;
            const recommendCount = (analysisResults || []).filter(r => r.status === 'recommend').length;
            const insufficientCount = (analysisResults || []).filter(r => r.status === 'insufficient').length;
            const noneCount = (analysisResults || []).filter(r => r.status === 'none').length;
            const overallRate = (analysisResults || []).length > 0 ? Math.round((analysisResults || []).reduce((sum, r) => sum + r.coverageRate, 0) / (analysisResults || []).length) : 0;

            // 고객 목록 화면
            if (currentScreen === 'customerList') {
                return (
                    <div className="app">
                        <div className="app-header">
                            <div className="header-left">
                                <h1>🏥 FMA System</h1>
                            </div>
                            <div className="header-right">
                                {consultant && (
                                    <span className="customer-badge">
                                        {consultant.name} {consultant.jobTitle === '직접입력' ? consultant.customJobTitle : consultant.jobTitle}
                                    </span>
                                )}
                                <button 
                                    className="btn btn-secondary btn-sm" 
                                    onClick={() => window.location.href = 'index.html'}
                                    style={{display: 'flex', alignItems: 'center', gap: '0.25rem'}}
                                >
                                    ← Main
                                </button>
                            </div>
                        </div>

                        <div className="app-main">
                            <CustomerListScreen 
                                savedSessions={savedSessions}
                                onSelect={loadSession}
                                onNew={startNewAnalysis}
                                onRefresh={loadSavedSessions}
                            />
                        </div>

                        {showConsultantModal && (
                            <ConsultantProfileModal
                                consultant={consultant}
                                onSave={(profile) => {
                                    setConsultant(profile);
                                    setShowConsultantModal(false);
                                }}
                                onClose={() => setShowConsultantModal(false)}
                            />
                        )}

                        {loading && (
                            <div className="loading-overlay">
                                <div className="loading-spinner"></div>
                                <p>처리 중...</p>
                            </div>
                        )}
                    </div>
                );
            }

            // 분석 화면
            return (
                <div className="app">
                    <div className="app-header">
                        <div className="header-left">
                            <h1>🏥 FMA System</h1>
                            {customer.name && (
                                <span className="customer-badge">
                                    고객: {customer.name} ({customer.age}세, {customer.gender})
                                </span>
                            )}
                        </div>
                        <div className="header-right">
                            {consultant && (
                                <span className="customer-badge">
                                    {consultant.name} {consultant.jobTitle === '직접입력' ? consultant.customJobTitle : consultant.jobTitle}
                                </span>
                            )}
                            {!isCustomerMode && currentSessionId && (
                                <span className="customer-badge" style={{ 
                                    background: isSavedToDrive ? '#10b981' : '#f59e0b',
                                    color: 'white'
                                }}>
                                    {isSavedToDrive ? '✅ 저장됨' : '⚠️ 미저장'}
                                    {lastSavedTime && (
                                        <span style={{ fontSize: '0.75rem', marginLeft: '0.5rem' }}>
                                            ({lastSavedTime.toLocaleTimeString('ko-KR')})
                                        </span>
                                    )}
                                </span>
                            )}
                            {!isCustomerMode && (
                                <>
                                    <button className="btn btn-secondary btn-sm" onClick={() => setCurrentScreen('customerList')}>
                                        📂 불러오기
                                    </button>
                                    {currentSessionId && (
                                        <button className="btn btn-danger btn-sm" onClick={endSession}>
                                            🚪 세션 종료
                                        </button>
                                    )}
                                    <button className="btn btn-secondary btn-sm" onClick={() => setCurrentScreen('customerList')}>
                                        ← 고객 목록
                                    </button>
                                    <button 
                                        className="btn btn-secondary btn-sm" 
                                        onClick={() => window.location.href = 'index.html'}
                                        style={{display: 'flex', alignItems: 'center', gap: '0.25rem'}}
                                    >
                                        ← Main
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="tab-navigation">
                        <button className={currentTab === 'input' ? 'active' : ''} onClick={() => setCurrentTab('input')}>
                            📝 보험 입력
                        </button>
                        {!isCustomerMode && (
                            <>
                                <button 
                                    className={currentTab === 'analysis' ? 'active' : ''} 
                                    onClick={() => setCurrentTab('analysis')}
                                    disabled={!analysisResults || analysisResults.length === 0}
                                >
                                    📊 분석 결과
                                </button>
                                <button 
                                    className={currentTab === 'report' ? 'active' : ''} 
                                    onClick={() => setCurrentTab('report')}
                                    disabled={!analysisResults || analysisResults.length === 0}
                                >
                                    📝 리포트 작성
                                </button>
                            </>
                        )}
                    </div>

                    <div className="app-main">
                        {currentTab === 'input' && (
                            <>
                                {/* 컨설턴트 전용: 고객 초대 링크 */}
                                {!isCustomerMode && database && (
                                    <div className="invite-link-box">
                                        <h3>🔗 고객 초대 링크</h3>
                                        {inviteLink ? (
                                            <>
                                                <div className="invite-link-container">
                                                    <input 
                                                        type="text" 
                                                        className="invite-link-input" 
                                                        value={inviteLink} 
                                                        readOnly 
                                                    />
                                                    <button className="btn btn-success btn-sm" onClick={copyInviteLink}>
                                                        📋 복사
                                                    </button>
                                                </div>
                                                <p style={{marginTop: '1rem', fontSize: '0.9rem'}}>
                                                    이 링크를 고객에게 전송하면 고객이 직접 보험 정보를 입력할 수 있습니다.
                                                </p>
                                                <div className="sync-indicator">
                                                    <div className="sync-dot"></div>
                                                    실시간 동기화 중
                                                </div>
                                            </>
                                        ) : (
                                            <button className="btn btn-primary" onClick={generateInviteLink}>
                                                초대 링크 생성
                                            </button>
                                        )}
                                    </div>
                                )}

                                {/* 고객 모드 안내 */}
                                {isCustomerMode && (
                                    <div className="invite-link-box">
                                        <h3>👋 환영합니다!</h3>
                                        <p>보험 정보를 입력하시면 컨설턴트에게 실시간으로 전송됩니다.</p>
                                        <div className="sync-indicator">
                                            <div className="sync-dot"></div>
                                            {syncStatus}
                                        </div>
                                    </div>
                                )}

                                <div className="form-section">
                                    <h2>👤 고객 정보 입력</h2>
                                    
                                    {/* 1행: 이름, 나이, 성별, 직업 */}
                                    <div className="customer-info-row">
                                        <div className="form-group compact">
                                            <label>이름 *</label>
                                            <input
                                                type="text"
                                                value={customer.name}
                                                onChange={(e) => setCustomer({...customer, name: e.target.value})}
                                                placeholder="예) 김영희"
                                            />
                                        </div>
                                        <div className="form-group compact">
                                            <label>나이 *</label>
                                            <input
                                                type="number"
                                                value={customer.age === '' ? '' : customer.age}
                                                onChange={(e) => {
                                                    const value = e.target.value;
                                                    setCustomer({
                                                        ...customer, 
                                                        age: value === '' ? '' : parseInt(value) || ''
                                                    });
                                                }}
                                                placeholder="나이 입력"
                                                min="1"
                                                max="120"
                                            />
                                        </div>
                                        <div className="form-group compact">
                                            <label>성별 *</label>
                                            <select value={customer.gender} onChange={(e) => setCustomer({...customer, gender: e.target.value})}>
                                                <option value="남성">남성</option>
                                                <option value="여성">여성</option>
                                            </select>
                                        </div>
                                        <div className="form-group compact">
                                            <label>직업</label>
                                            <input
                                                type="text"
                                                value={customer.occupation}
                                                onChange={(e) => setCustomer({...customer, occupation: e.target.value})}
                                                placeholder="예) 자영업"
                                            />
                                        </div>
                                    </div>

                                    {/* 2행: 연소득, 배우자 체크 */}
                                    <div className="customer-info-row">
                                        <div className="form-group compact wide">
                                            <label>연소득 (원)</label>
                                            <input
                                                type="text"
                                                value={formatNumber(customer.annualIncome)}
                                                onChange={(e) => {
                                                    const value = e.target.value.replace(/,/g, '');
                                                    setCustomer({
                                                        ...customer, 
                                                        annualIncome: value === '' ? '' : parseInt(value) || ''
                                                    });
                                                }}
                                                placeholder="연소득 입력 (예: 60,000,000)"
                                            />
                                        </div>
                                        <div className="form-group compact checkbox-group">
                                            <label>
                                                <input
                                                    type="checkbox"
                                                    checked={customer.hasSpouse}
                                                    onChange={(e) => {
                                                        const isChecked = e.target.checked;
                                                        const updatedCustomer = {
                                                            ...customer, 
                                                            hasSpouse: isChecked,
                                                            spouse: customer.spouse || { name: '', birthDate: '' },
                                                            children: customer.children || [
                                                                { id: 1, name: '', birthDate: '' },
                                                                { id: 2, name: '', birthDate: '' }
                                                            ]
                                                        };
                                                        setCustomer(updatedCustomer);
                                                        
                                                        // 즉시 Firebase 업데이트
                                                        if (database && currentSessionId) {
                                                            // 짧게 타이핑 플래그 설정 (즉시 업데이트 방해 방지)
                                                            isTypingRef.current = true;
                                                            
                                                            database.ref(`sessions/${currentSessionId}`).update({
                                                                customer: updatedCustomer,
                                                                insurances,
                                                                consultant,
                                                                analysisResults,
                                                                summary,
                                                                opinions,
                                                                updatedAt: Date.now()
                                                            });
                                                            setSyncStatus('동기화됨 ✓');
                                                            
                                                            // 200ms 후 타이핑 플래그 해제
                                                            setTimeout(() => {
                                                                isTypingRef.current = false;
                                                            }, 200);
                                                        }
                                                    }}
                                                    style={{marginRight: '0.5rem', flexShrink: 0}}
                                                />
                                                배우자
                                            </label>
                                        </div>
                                    </div>

                                    {/* 배우자 정보 입력란 (배우자 체크 시 표시) */}
                                    {customer.hasSpouse === true && (
                                        <div style={{marginTop: '1rem', padding: '1rem', background: 'var(--gray-50)', borderRadius: '8px', border: '1px solid var(--gray-200)'}}>
                                            <h3 style={{fontSize: '1rem', marginBottom: '0.75rem', color: 'var(--gray-800)'}}>💑 배우자 정보</h3>
                                            <div className="customer-info-row">
                                                <div className="form-group compact">
                                                    <label>성명</label>
                                                    <input
                                                        type="text"
                                                        value={customer.spouse?.name || ''}
                                                        onChange={(e) => setCustomer({
                                                            ...customer,
                                                            spouse: {...(customer.spouse || {}), name: e.target.value}
                                                        })}
                                                        placeholder="예) 이철수"
                                                    />
                                                </div>
                                                <div className="form-group compact">
                                                    <label>생년월일</label>
                                                    <input
                                                        type="date"
                                                        value={customer.spouse?.birthDate || ''}
                                                        onChange={(e) => setCustomer({
                                                            ...customer,
                                                            spouse: {...(customer.spouse || {}), birthDate: e.target.value}
                                                        })}
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* 자녀 정보 입력란 (배우자 체크 시 표시) */}
                                    {customer.hasSpouse === true && (
                                        <div style={{marginTop: '1rem', padding: '1rem', background: 'var(--gray-50)', borderRadius: '8px', border: '1px solid var(--gray-200)'}}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem'}}>
                                                <h3 style={{fontSize: '1rem', margin: 0, color: 'var(--gray-800)'}}>👶 자녀 정보</h3>
                                                <button 
                                                    className="btn btn-secondary btn-sm"
                                                    onClick={() => {
                                                        const newChild = {
                                                            id: Date.now(),
                                                            name: '',
                                                            birthDate: ''
                                                        };
                                                        setCustomer({
                                                            ...customer,
                                                            children: [...(customer.children || []), newChild]
                                                        });
                                                    }}
                                                >
                                                    + 자녀 추가
                                                </button>
                                            </div>
                                            {(customer.children || []).map((child, index) => (
                                                <div key={child.id} style={{marginBottom: '0.75rem'}}>
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem'}}>
                                                        <span style={{fontSize: '0.875rem', color: 'var(--gray-600)', fontWeight: '500'}}>
                                                            자녀 {index + 1}
                                                        </span>
                                                        {(customer.children || []).length > 2 && (
                                                            <button
                                                                onClick={() => {
                                                                    setCustomer({
                                                                        ...customer,
                                                                        children: (customer.children || []).filter(c => c.id !== child.id)
                                                                    });
                                                                }}
                                                                style={{
                                                                    background: 'none',
                                                                    border: 'none',
                                                                    cursor: 'pointer',
                                                                    color: 'var(--danger-color)',
                                                                    fontSize: '0.875rem'
                                                                }}
                                                            >
                                                                ❌ 삭제
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div className="customer-info-row">
                                                        <div className="form-group compact">
                                                            <label>성명</label>
                                                            <input
                                                                type="text"
                                                                value={child.name || ''}
                                                                onChange={(e) => {
                                                                    setCustomer({
                                                                        ...customer,
                                                                        children: (customer.children || []).map(c =>
                                                                            c.id === child.id ? {...c, name: e.target.value} : c
                                                                        )
                                                                    });
                                                                }}
                                                                placeholder="예) 김민준"
                                                            />
                                                        </div>
                                                        <div className="form-group compact">
                                                            <label>생년월일</label>
                                                            <input
                                                                type="date"
                                                                value={child.birthDate || ''}
                                                                onChange={(e) => {
                                                                    setCustomer({
                                                                        ...customer,
                                                                        children: (customer.children || []).map(c =>
                                                                            c.id === child.id ? {...c, birthDate: e.target.value} : c
                                                                        )
                                                                    });
                                                                }}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="form-section">
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
                                        <h2>📋 가입 보험 목록</h2>
                                        <button className="btn btn-primary" onClick={addInsurance}>
                                            + 보험 추가
                                        </button>
                                    </div>

                                    {!insurances || insurances.length === 0 ? (
                                        <div className="empty-state">
                                            <p>등록된 보험이 없습니다.</p>
                                            <p className="hint">위의 "보험 추가" 버튼을 클릭하여 시작하세요.</p>
                                        </div>
                                    ) : (
                                        <div className="insurance-list">
                                            {insurances.map((insurance, idx) => (
                                                <div key={insurance.id} className="insurance-card">
                                                    <div className="insurance-header">
                                                        <h3>보험 {idx + 1}</h3>
                                                        <button 
                                                            className="btn btn-danger btn-sm"
                                                            onClick={() => removeInsurance(insurance.id)}
                                                        >
                                                            삭제
                                                        </button>
                                                    </div>

                                                    <div className="insurance-info">
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>보험사 *</label>
                                                            <input
                                                                type="text"
                                                                className="input-medium"
                                                                value={insurance.company}
                                                                onChange={(e) => updateInsurance(insurance.id, 'company', e.target.value)}
                                                                placeholder="예) 삼성생명"
                                                            />
                                                        </div>
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>상품명 *</label>
                                                            <input
                                                                type="text"
                                                                className="input-long"
                                                                value={insurance.productName}
                                                                onChange={(e) => updateInsurance(insurance.id, 'productName', e.target.value)}
                                                                placeholder="예) 무배당 종신보험"
                                                            />
                                                        </div>
                                                    </div>

                                                    <div className="insurance-info">
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>월 보험료 (원)</label>
                                                            <input
                                                                type="text"
                                                                className="input-number"
                                                                value={formatNumber(insurance.monthlyPremium)}
                                                                onChange={(e) => {
                                                                    const value = e.target.value.replace(/,/g, '');
                                                                    updateInsurance(insurance.id, 'monthlyPremium', value === '' ? '' : parseInt(value) || '');
                                                                }}
                                                                placeholder="월 보험료 입력 (예: 150,000)"
                                                            />
                                                        </div>
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>가입일</label>
                                                            <input
                                                                type="date"
                                                                className="input-medium"
                                                                value={insurance.startDate}
                                                                onChange={(e) => updateInsurance(insurance.id, 'startDate', e.target.value)}
                                                            />
                                                        </div>
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>만기일</label>
                                                            <input
                                                                type="date"
                                                                className="input-medium"
                                                                value={insurance.endDate}
                                                                onChange={(e) => updateInsurance(insurance.id, 'endDate', e.target.value)}
                                                            />
                                                        </div>
                                                    </div>

                                                    {/* 총납입보험료 표시 */}
                                                    {insurance.startDate && insurance.monthlyPremium > 0 && (
                                                        <div className="total-premium-display">
                                                            <div>
                                                                📊 납입 정보: {calculateMonthsElapsed(insurance.startDate)}개월 경과
                                                            </div>
                                                            <div style={{marginTop: '0.5rem'}}>
                                                                <strong>총 납입보험료: {formatAmountKorean(calculateTotalPremium(insurance.startDate, insurance.monthlyPremium))}</strong>
                                                            </div>
                                                        </div>
                                                    )}

                                                    <div className="insurance-coverages">
                                                        <div className="coverages-header">
                                                            <h4 style={{margin: 0}}>💰 보장 내역</h4>
                                                            <button 
                                                                className="btn btn-secondary btn-sm"
                                                                onClick={() => setShowCoverageModal(insurance.id)}
                                                            >
                                                                + 보장 항목 추가
                                                            </button>
                                                        </div>

                                                        {!insurance.coverages || insurance.coverages.length === 0 ? (
                                                            <p className="hint">보장 항목을 추가하세요.</p>
                                                        ) : (
                                                            <div className="coverage-list">
                                                                {insurance.coverages.map((coverage, idx) => (
                                                                    <div key={coverage.id} className="coverage-item">
                                                                        <div className="coverage-info">
                                                                            <span className="coverage-index">{idx + 1}.</span>
                                                                            <span className="coverage-name">{coverage.name}</span>
                                                                            <input
                                                                                type="text"
                                                                                className="coverage-amount"
                                                                                value={formatNumber(coverage.amount)}
                                                                                onChange={(e) => {
                                                                                    const value = e.target.value.replace(/,/g, '');
                                                                                    updateCoverage(insurance.id, coverage.id, value === '' ? '' : parseInt(value) || '');
                                                                                }}
                                                                                placeholder="금액 입력"
                                                                                style={{padding: '0.5rem', border: '1px solid var(--gray-300)', borderRadius: '0.25rem'}}
                                                                            />
                                                                            <span className="coverage-unit">원 💡</span>
                                                                        </div>
                                                                        <button
                                                                            onClick={() => removeCoverage(insurance.id, coverage.id)}
                                                                            style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: '1rem'}}
                                                                        >
                                                                            ❌
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {!isCustomerMode && (
                                    <div className="action-buttons">
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleSaveToDrive} 
                                            disabled={loading}
                                            style={{
                                                background: isSavedToDrive ? 'var(--success-color)' : 'var(--warning-color)',
                                                borderColor: isSavedToDrive ? 'var(--success-color)' : 'var(--warning-color)'
                                            }}
                                        >
                                            {isSavedToDrive ? '✅ 저장완료' : '💾 Google Drive 저장'}
                                        </button>
                                        <button className="btn btn-primary" onClick={handleStartAnalysis} disabled={loading}>
                                            📊 분석 시작하기
                                        </button>
                                    </div>
                                )}
                            </>
                        )}

                        {currentTab === 'analysis' && (
                            <div className="form-section analysis-result">
                                <h2>📊 보장 분석 현황</h2>
                                
                                {/* Before & After 비교 카드 */}
                                <div className="before-after-container">
                                    <div className="before-after-card">
                                        <div className="before-after-label">현재 보장</div>
                                        <div className="before-after-value">{overallRate}%</div>
                                        <div className="before-after-desc">
                                            {overallRate >= 75 ? '양호' : overallRate >= 60 ? '보완 권장' : '개선 필요'}
                                        </div>
                                    </div>
                                    <div className="arrow-divider">→</div>
                                    <div className="before-after-card">
                                        <div className="before-after-label">목표 보장</div>
                                        <div className="before-after-value">95%</div>
                                        <div className="before-after-desc">권장 수준</div>
                                    </div>
                                </div>

                                <div className="stats-summary">
                                    <div className="stat-item">
                                        <div className="stat-label">✅ 적정</div>
                                        <div className="stat-value success">{adequateCount}건</div>
                                    </div>
                                    <div className="stat-item">
                                        <div className="stat-label">🟡 보완 권장</div>
                                        <div className="stat-value warning">{recommendCount}건</div>
                                    </div>
                                    <div className="stat-item">
                                        <div className="stat-label">⚠️ 부족</div>
                                        <div className="stat-value danger">{insufficientCount}건</div>
                                    </div>
                                    <div className="stat-item">
                                        <div className="stat-label">❌ 없음</div>
                                        <div className="stat-value">{noneCount}건</div>
                                    </div>
                                </div>

                                <hr style={{margin: '2rem 0', border: 'none', borderTop: '1px solid var(--gray-200)'}} />

                                <div className="charts-grid">
                                    <div className="chart-card">
                                        <h3>📊 현재 vs 권장 보장 비교</h3>
                                        <div style={{height: '300px'}}>
                                            <canvas ref={comparisonChartRef}></canvas>
                                        </div>
                                    </div>
                                    <div className="chart-card">
                                        <h3>📈 보장 상태 분포</h3>
                                        <div style={{height: '300px'}}>
                                            <canvas ref={categoryChartRef}></canvas>
                                        </div>
                                    </div>
                                    <div className="chart-card">
                                        <h3>🎯 보장 균형도 (레이더)</h3>
                                        <div style={{height: '300px'}}>
                                            <canvas ref={radarChartRef}></canvas>
                                        </div>
                                    </div>
                                    <div className="chart-card">
                                        <h3>💰 보험료 분배</h3>
                                        <div style={{height: '300px'}}>
                                            <canvas ref={premiumChartRef}></canvas>
                                        </div>
                                    </div>
                                </div>

                                <hr style={{margin: '2rem 0', border: 'none', borderTop: '1px solid var(--gray-200)'}} />

                                <h3 style={{marginBottom: '1rem'}}>📋 상세 보장 분석표</h3>
                                <div style={{overflowX: 'auto'}}>
                                    <table className="analysis-table">
                                        <thead>
                                            <tr>
                                                <th>항목</th>
                                                <th>현재 보장</th>
                                                <th>권장 보장</th>
                                                <th>보장률</th>
                                                <th>진단</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(analysisResults || []).map((result, idx) => (
                                                <tr key={idx}>
                                                    <td>{result.coverageItem}</td>
                                                    <td>{formatAmountKorean(result.currentAmount)}</td>
                                                    <td>{formatAmountKorean(result.recommendedAmount)}</td>
                                                    <td>{Math.round(result.coverageRate)}%</td>
                                                    <td>
                                                        <span 
                                                            className="status-badge"
                                                            style={{backgroundColor: getStatusColor(result.status)}}
                                                        >
                                                            {getStatusText(result.status)}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                <div className="action-buttons">
                                    <button className="btn btn-primary" onClick={() => setCurrentTab('report')}>
                                        다음: 리포트 작성 →
                                    </button>
                                </div>
                            </div>
                        )}

                        {currentTab === 'report' && (
                            <>
                                <div className="report-section">
                                    <h2>📝 항목별 보장분석 의견</h2>
                                    <p className="hint" style={{marginBottom: '2rem'}}>
                                        각 보장 항목에 대한 의견을 수정할 수 있습니다. 자동 생성된 템플릿을 고객 상황에 맞게 수정하세요.
                                    </p>

                                    {(analysisResults || []).filter(r => r.status !== 'adequate').slice(0, 10).map((result, idx) => (
                                        <div key={idx} className="opinion-card">
                                            <div className="opinion-header">
                                                <div>
                                                    <div className="opinion-title">
                                                        {result.coverageItem}
                                                        <span 
                                                            className="status-badge"
                                                            style={{backgroundColor: getStatusColor(result.status), marginLeft: '1rem'}}
                                                        >
                                                            {getStatusText(result.status)}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="opinion-stats">
                                                <div>현재: {formatAmountKorean(result.currentAmount)}</div>
                                                <div>권장: {formatAmountKorean(result.recommendedAmount)}</div>
                                                <div>보장률: {Math.round(result.coverageRate)}%</div>
                                            </div>

                                            {editingOpinion === result.coverageItem ? (
                                                <>
                                                    <textarea
                                                        value={opinions[result.coverageItem] || result.opinion}
                                                        onChange={(e) => setOpinions({
                                                            ...opinions,
                                                            [result.coverageItem]: e.target.value
                                                        })}
                                                        style={{
                                                            width: '100%',
                                                            minHeight: '150px',
                                                            padding: '1rem',
                                                            border: '1px solid var(--gray-300)',
                                                            borderRadius: '0.5rem',
                                                            fontFamily: 'inherit',
                                                            fontSize: '0.95rem',
                                                            lineHeight: '1.6',
                                                            marginBottom: '1rem'
                                                        }}
                                                    />
                                                    
                                                    <div className="phrase-library">
                                                        <h4>💬 자주 쓰는 문구 (클릭하여 추가)</h4>
                                                        <div className="phrase-buttons">
                                                            {Object.values(PHRASE_LIBRARY).flat().map((phrase, i) => (
                                                                <button key={i} onClick={() => insertPhrase(phrase)}>
                                                                    {phrase}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    <div className="opinion-actions">
                                                        <button 
                                                            className="btn btn-secondary btn-sm"
                                                            onClick={() => handleResetOpinion(result.coverageItem)}
                                                        >
                                                            🔄 기본 템플릿으로
                                                        </button>
                                                        <button 
                                                            className="btn btn-primary btn-sm"
                                                            onClick={() => handleSaveOpinion(result.coverageItem, opinions[result.coverageItem])}
                                                        >
                                                            💾 저장
                                                        </button>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="opinion-content">
                                                        {opinions[result.coverageItem] || result.opinion}
                                                    </div>
                                                    <div className="opinion-actions">
                                                        <button 
                                                            className="btn btn-secondary btn-sm"
                                                            onClick={() => setEditingOpinion(result.coverageItem)}
                                                        >
                                                            ✏️ 수정하기
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                <div className="report-section">
                                    <h2>📝 종합 총평</h2>
                                    <textarea
                                        value={summary}
                                        onChange={(e) => setSummary(e.target.value)}
                                        placeholder="종합 의견을 입력하세요..."
                                        style={{
                                            width: '100%',
                                            minHeight: '250px',
                                            padding: '1rem',
                                            border: '1px solid var(--gray-300)',
                                            borderRadius: '0.5rem',
                                            fontFamily: 'inherit',
                                            fontSize: '0.95rem',
                                            lineHeight: '1.6',
                                            marginBottom: '1rem'
                                        }}
                                    />
                                    <p className="hint">자동 생성된 종합 의견을 수정할 수 있습니다. 고객별로 맞춤화하세요.</p>

                                    <div className="action-buttons">
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleSaveToDrive} 
                                            disabled={loading}
                                            style={{
                                                background: isSavedToDrive ? 'var(--success-color)' : 'var(--warning-color)',
                                                borderColor: isSavedToDrive ? 'var(--success-color)' : 'var(--warning-color)'
                                            }}
                                        >
                                            {isSavedToDrive ? '✅ 저장완료' : '💾 Google Drive 저장'}
                                        </button>
                                        <button className="btn btn-success" onClick={handleGeneratePDF} disabled={loading}>
                                            📄 PDF 리포트 다운로드
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    {showCoverageModal && (
                        <CoverageAddModal
                            onClose={() => setShowCoverageModal(null)}
                            onAdd={(coverageName) => {
                                addCoverage(showCoverageModal, coverageName);
                                setShowCoverageModal(null);
                            }}
                        />
                    )}

                    {showConsultantModal && (
                        <ConsultantProfileModal
                            consultant={consultant}
                            onSave={(profile) => {
                                setConsultant(profile);
                                setShowConsultantModal(false);
                                if (!analysisResults.length) {
                                    setTimeout(handleStartAnalysis, 100);
                                }
                            }}
                            onClose={() => setShowConsultantModal(false)}
                        />
                    )}

                    {loading && (
                        <div className="loading-overlay">
                            <div className="loading-spinner"></div>
                            <p>처리 중...</p>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
