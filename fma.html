<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMA - Financial Master Analysis (ÏôÑÏ†ÑÌåê)</title>
    
    <!-- External Libraries via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        /* Ï†ÑÏó≠ Ïä§ÌÉÄÏùº */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif, 'Noto Sans KR', 'Malgun Gothic';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--gray-50);
            color: var(--gray-900);
        }

        /* Ïï± Î†àÏù¥ÏïÑÏõÉ */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: white;
            padding: 0.75rem 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .header-left h1 {
            font-size: 1.35rem;
            color: var(--primary-color);
            margin: 0;
        }

        .customer-badge {
            background: var(--gray-100);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            color: var(--gray-700);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .tab-navigation {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            overflow-x: auto;
        }

        .tab-navigation button {
            padding: 0.75rem 1.25rem;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .tab-navigation button:hover {
            background: var(--gray-50);
        }

        .tab-navigation button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-navigation button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Î©îÏù∏ Ïª®ÌÖêÏ∏† */
        .app-main {
            flex: 1;
            padding: 1rem 1.25rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Ìèº Ïä§ÌÉÄÏùº - Í≥µÍ∞Ñ Ìö®Ïú®ÏÑ± Í∑πÎåÄÌôî */
        .form-section {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .form-section:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .form-section h2 {
            margin-bottom: 1rem;
            color: var(--gray-900);
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.3px;
            padding-bottom: 0.625rem;
            border-bottom: 2px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-section h3 {
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--gray-800);
            font-size: 1.05rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 0.875rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.8125rem;
            letter-spacing: -0.1px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1.5px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: var(--gray-50);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--gray-300);
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        }

        /* ÏûÖÎ†• ÌïÑÎìú ÌÅ¨Í∏∞ Ï°∞Ï†à */
        .input-short {
            max-width: 120px;
        }

        .input-medium {
            max-width: 200px;
        }

        .input-long {
            max-width: 320px;
        }

        .input-number {
            max-width: 160px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            align-items: start;
        }

        /* Í≥†Í∞ù Ï†ïÎ≥¥ Ïª¥Ìå©Ìä∏ 2Ìñâ Î†àÏù¥ÏïÑÏõÉ */
        .customer-info-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: end;
        }

        .form-group.compact {
            margin-bottom: 0;
        }

        .form-group.compact.wide {
            grid-column: span 2;
        }

        .form-group.compact.checkbox-group {
            display: flex;
            align-items: center;
            padding-top: 1.625rem;
        }

        .form-group.compact.checkbox-group label {
            margin-bottom: 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .form-group.compact input,
        .form-group.compact select {
            width: 100%;
        }

        /* Î≤ÑÌäº - Ïª¥Ìå©Ìä∏ ÎîîÏûêÏù∏ */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            letter-spacing: -0.2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1.5px solid var(--gray-200);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            border-radius: 6px;
        }

        /* Î≥¥Ìóò Ïπ¥Îìú - Í≥µÍ∞Ñ Ìö®Ïú®ÏÑ± Í∑πÎåÄÌôî */
        .insurance-list {
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
        }

        .insurance-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            padding: 1rem;
            border-radius: 10px;
            border: 1.5px solid var(--gray-200);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
            transition: all 0.2s ease;
        }

        .insurance-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.08);
            transform: translateY(-1px);
        }

        .insurance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.625rem;
            border-bottom: 1.5px solid var(--gray-200);
        }

        .insurance-header h3 {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.3px;
            margin: 0;
        }

        .insurance-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .insurance-coverages {
            margin-top: 1rem;
            padding-top: 0.875rem;
            border-top: 1px solid var(--gray-200);
        }

        .coverages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .coverages-header h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        .coverage-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .coverage-list {
                grid-template-columns: 1fr;
            }
        }

        .coverage-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }

        .coverage-info {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            flex: 1;
            flex-wrap: wrap;
        }

        .coverage-index {
            font-weight: 500;
            color: var(--gray-600);
            min-width: 1rem;
            font-size: 0.8125rem;
        }

        .coverage-name {
            font-weight: 500;
            color: var(--gray-800);
            flex: 1;
            min-width: 110px;
            font-size: 0.875rem;
        }

        .coverage-amount {
            flex: 1;
            min-width: 140px;
        }

        .coverage-unit {
            color: var(--gray-600);
            white-space: nowrap;
            font-size: 0.875rem;
        }

        /* Î™®Îã¨ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h3 {
            font-size: 1.25rem;
            color: var(--gray-800);
            margin: 0;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            overflow-x: auto;
        }

        .modal-tabs button {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            color: var(--gray-600);
        }

        .modal-tabs button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .template-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .category-group h4 {
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .btn-template-checkbox {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-template-checkbox:hover {
            background: var(--gray-50);
        }

        .btn-template-checkbox.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Í≤åÏù¥ÏßÄ ÏÑπÏÖò */
        .gauge-section {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: center;
            margin: 2rem 0;
        }

        .gauge-container {
            text-align: center;
            padding: 2rem;
            background: var(--gray-50);
            border-radius: 1rem;
            border: 2px solid var(--gray-200);
        }

        .vs-divider {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gray-400);
        }

        .gauge-value {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 1rem 0;
        }

        .gauge-label {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        .stats-summary {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .stat-value.success { color: var(--success-color); }
        .stat-value.warning { color: var(--warning-color); }
        .stat-value.danger { color: var(--danger-color); }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .chart-card {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
        }

        .chart-card h3 {
            margin-bottom: 1rem;
            color: var(--gray-700);
            font-size: 1rem;
        }

        /* Before & After Ïπ¥Îìú */
        .before-after-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: center;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            color: white;
        }

        .before-after-card {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .before-after-label {
            font-size: 1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .before-after-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .before-after-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .arrow-divider {
            font-size: 2rem;
        }

        /* Î∂ÑÏÑù ÌÖåÏù¥Î∏î */
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .analysis-table th,
        .analysis-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .analysis-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
        }

        /* Î¶¨Ìè¨Ìä∏ Ìé∏Ïßë */
        .report-section {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .report-editor {
            margin-bottom: 2rem;
        }

        .report-editor h3 {
            margin-bottom: 1rem;
            color: var(--gray-700);
        }

        .report-editor textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
        }

        .opinion-card {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }

        .opinion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .opinion-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .opinion-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .opinion-content {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .opinion-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Î¨∏Íµ¨ ÎùºÏù¥Î∏åÎü¨Î¶¨ */
        .phrase-library {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
        }

        .phrase-library h4 {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .phrase-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .phrase-buttons button {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .phrase-buttons button:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Ïª®ÏÑ§ÌÑ¥Ìä∏ Î™©Î°ù */
        .customer-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .customer-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s;
        }

        .customer-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .customer-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .customer-card-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .customer-card-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        /* Ïï°ÏÖò Î≤ÑÌäº */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.625rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Î°úÎî© */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay p {
            margin-top: 1rem;
            font-size: 1.1rem;
        }

        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            text-align: center;
            padding: 1.25rem 1rem;
            color: var(--gray-500);
        }

        .empty-state p:first-child {
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
        }

        .hint {
            color: var(--gray-500);
            font-size: 0.8125rem;
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        /* Î∞òÏùëÌòï - Ïª¥Ìå©Ìä∏ ÏµúÏ†ÅÌôî */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.625rem 0.875rem;
                gap: 0.5rem;
            }

            .app-main {
                padding: 0.75rem;
            }

            .form-section {
                padding: 0.875rem;
                margin-bottom: 0.75rem;
                border-radius: 8px;
            }

            .form-section h2 {
                font-size: 1.125rem;
                margin-bottom: 0.875rem;
                padding-bottom: 0.5rem;
            }

            .customer-info-row {
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }

            .form-group.compact.checkbox-group {
                padding-top: 0.375rem;
            }

            .form-group.compact.wide {
                grid-column: span 1;
            }

            .form-group {
                margin-bottom: 0.625rem;
            }

            .form-group label {
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }

            .form-group input,
            .form-group select {
                padding: 0.5rem 0.625rem;
                font-size: 0.875rem;
            }

            .invite-link-box {
                padding: 0.875rem;
                border-radius: 8px;
                margin-bottom: 0.75rem;
            }

            .invite-link-box h3 {
                font-size: 1rem;
                margin-bottom: 0.625rem;
            }

            .invite-link-container {
                flex-direction: column;
                align-items: stretch;
            }

            .insurance-card {
                padding: 0.875rem;
                border-radius: 8px;
            }

            .insurance-header {
                margin-bottom: 0.625rem;
                padding-bottom: 0.5rem;
            }

            .insurance-header h3 {
                font-size: 0.9375rem;
            }

            .insurance-info {
                grid-template-columns: 1fr;
                gap: 0.625rem;
                margin-bottom: 0.625rem;
            }

            .insurance-coverages {
                margin-top: 1rem;
                padding-top: 0.875rem;
            }

            .coverages-header {
                margin-bottom: 0.75rem;
            }

            .coverage-list {
                gap: 0.5rem;
            }

            .coverage-item {
                padding: 0.5rem;
                gap: 0.5rem;
            }

            .coverage-info {
                gap: 0.5rem;
            }

            .coverage-name {
                min-width: 100px;
                font-size: 0.875rem;
            }

            .gauge-section {
                grid-template-columns: 1fr;
            }

            .vs-divider {
                transform: rotate(90deg);
                margin: 0.75rem 0;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .before-after-container {
                grid-template-columns: 1fr;
            }

            .arrow-divider {
                transform: rotate(90deg);
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .btn-sm {
                padding: 0.4375rem 0.875rem;
                font-size: 0.8125rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .app-main {
                padding: 1.5rem;
            }

            .form-section {
                padding: 1.25rem;
            }

            .customer-info-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.875rem;
            }

            .form-group.compact.wide {
                grid-column: span 2;
            }

            .insurance-card {
                padding: 1.25rem;
            }
        }

        @media (max-width: 480px) {
            .app-header {
                padding: 0.625rem;
            }

            .app-main {
                padding: 0.625rem;
            }

            .form-section {
                padding: 0.75rem;
                border-radius: 8px;
            }

            .form-section h2 {
                font-size: 1.0625rem;
                margin-bottom: 0.75rem;
            }

            .btn {
                padding: 0.4375rem 0.75rem;
                font-size: 0.8125rem;
            }

            .btn-sm {
                padding: 0.3125rem 0.625rem;
                font-size: 0.75rem;
            }

            .insurance-card {
                padding: 0.75rem;
            }

            .insurance-header h3 {
                font-size: 0.875rem;
            }

            .coverage-name {
                font-size: 0.8125rem;
            }

            .insurance-list {
                gap: 0.625rem;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Í≥†Í∞ù Ï¥àÎåÄ ÎßÅÌÅ¨ Î∞ïÏä§ - Ïª¥Ìå©Ìä∏ ÎîîÏûêÏù∏ */
        .invite-link-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .invite-link-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .invite-link-box:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(102, 126, 234, 0.3);
        }

        .invite-link-box h3 {
            margin-bottom: 1rem;
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
        }

        .invite-link-container {
            display: flex;
            gap: 0.75rem;
            align-items: stretch;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .invite-link-input {
            flex: 1;
            background: white;
            color: var(--gray-900);
            border: none;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: 'Consolas', 'Monaco', monospace;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
        }

        .invite-link-input:focus {
            outline: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .sync-indicator {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
        }

        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(0.95);
            }
        }

        /* Ï¥ùÎÇ©ÏûÖÎ≥¥ÌóòÎ£å ÌëúÏãú - Ïª¥Ìå©Ìä∏ ÎîîÏûêÏù∏ */
        .total-premium-display {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 0.875rem 1rem;
            border-radius: 8px;
            margin-top: 0.75rem;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 1px 4px rgba(37, 99, 235, 0.1);
            transition: all 0.2s ease;
        }

        .total-premium-display:hover {
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
            transform: translateX(1px);
        }

        .total-premium-display div:first-child {
            color: var(--gray-700);
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
        }

        .total-premium-display strong {
            color: var(--primary-color);
            font-size: 1.0625rem;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ===== ÏÑ§Ï†ï =====
        const GOOGLE_CLIENT_ID = "288996084140-0eo93heqd66hqhg0fh1rbum6scnt3757.apps.googleusercontent.com";
        const GOOGLE_API_KEY = "AIzaSyAVtAzm9UjgGB1pqChvGvGKH7RpH0KCiVM";
        const ENCRYPTION_KEY = "K7mP9nR4sT2vX8wY3zA6bC1dE5fG0hJ9";

        // Firebase ÏÑ§Ï†ï - KFPC Company Support Project
        const firebaseConfig = {
            apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
            authDomain: "kfpc-company-support-project.firebaseapp.com",
            databaseURL: "https://kfpc-company-support-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kfpc-company-support-project",
            storageBucket: "kfpc-company-support-project.firebasestorage.app",
            messagingSenderId: "1012609333373",
            appId: "1:1012609333373:web:ffba9039a7f9568356d914",
            measurementId: "G-Y757PLYBEE"
        };

        // Firebase Ï¥àÍ∏∞Ìôî
        let database = null;
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            }
        } catch (error) {
            console.warn('Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå® (Îç∞Î™® Î™®ÎìúÎ°ú Ï†ÑÌôò):', error);
        }

        // ===== Îç∞Ïù¥ÌÑ∞ Î∞è ÌÖúÌîåÎ¶ø =====
        const COVERAGE_TEMPLATES = [
            { name: 'ÏùºÎ∞òÏÇ¨Îßù', recommended: 100000000, category: 'ÏÇ¨Îßù' },
            { name: 'Ïû¨Ìï¥ÏÇ¨Îßù', recommended: 100000000, category: 'ÏÇ¨Îßù' },
            { name: 'ÍµêÌÜµÏû¨Ìï¥ÏÇ¨Îßù', recommended: 50000000, category: 'ÏÇ¨Îßù' },
            { name: 'ÏùºÎ∞òÏïî ÏßÑÎã®Í∏à', recommended: 100000000, category: 'Ïïî' },
            { name: 'ÏÜåÏï°Ïïî ÏßÑÎã®Í∏à', recommended: 5000000, category: 'Ïïî' },
            { name: 'Í≥†Ïï°Ïïî ÏßÑÎã®Í∏à', recommended: 30000000, category: 'Ïïî' },
            { name: 'Ïú†ÏÇ¨Ïïî ÏßÑÎã®Í∏à', recommended: 2000000, category: 'Ïïî' },
            { name: 'Ïïî ÏßÅÏ†ëÏπòÎ£åÎπÑ', recommended: 30000000, category: 'Ïïî' },
            { name: 'ÏïîÏûÖÏõêÎπÑ', recommended: 50000, category: 'Ïïî' },
            { name: 'ÏïîÏàòÏà†ÎπÑ', recommended: 2000000, category: 'Ïïî' },
            { name: 'ÎáåÏ∂úÌòà ÏßÑÎã®Í∏à', recommended: 50000000, category: 'Îáå/Ïã¨Ïû•' },
            { name: 'ÎáåÍ≤ΩÏÉâ ÏßÑÎã®Í∏à', recommended: 50000000, category: 'Îáå/Ïã¨Ïû•' },
            { name: 'Í∏âÏÑ±Ïã¨Í∑ºÍ≤ΩÏÉâ ÏßÑÎã®Í∏à', recommended: 50000000, category: 'Îáå/Ïã¨Ïû•' },
            { name: 'ÌóàÌòàÏÑ±Ïã¨Ïû•ÏßàÌôò', recommended: 30000000, category: 'Îáå/Ïã¨Ïû•' },
            { name: 'Ï§ëÎåÄÌïúÏßàÎ≥ë(CI)', recommended: 50000000, category: 'CI' },
            { name: 'ÏûÖÏõêÏùºÎãπ(ÏßàÎ≥ë)', recommended: 50000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'ÏûÖÏõêÏùºÎãπ(Ïû¨Ìï¥)', recommended: 50000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'ÏàòÏà†ÎπÑ(ÏßàÎ≥ë)', recommended: 1000000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'ÏàòÏà†ÎπÑ(Ïû¨Ìï¥)', recommended: 1000000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'ÏàòÏà†Ï¢ÖÎ≥Ñ 1Ï¢Ö', recommended: 500000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'ÏàòÏà†Ï¢ÖÎ≥Ñ 2Ï¢Ö', recommended: 250000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'ÏàòÏà†Ï¢ÖÎ≥Ñ 3Ï¢Ö', recommended: 100000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'ÌÜµÏõê(Ïô∏Îûò)', recommended: 30000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'Ï≤òÎ∞©Ï°∞Ï†úÎπÑ', recommended: 20000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'Ïã§ÏÜêÏùòÎ£åÎπÑ', recommended: 50000000, category: 'ÏùºÏÉÅÏÉùÌôú' },
            { name: 'Í≥®Ï†àÏßÑÎã®Í∏à', recommended: 500000, category: 'Í∏∞ÌÉÄ' },
            { name: 'ÌôîÏÉÅÏßÑÎã®Í∏à', recommended: 1000000, category: 'Í∏∞ÌÉÄ' },
            { name: 'ÍπÅÏä§ÏπòÎ£åÎπÑ', recommended: 100000, category: 'Í∏∞ÌÉÄ' },
            { name: 'Ïû•Ìï¥80% Î≥¥Ïû•', recommended: 50000000, category: 'Í∏∞ÌÉÄ' },
            { name: 'Ïû•Ìï¥100% Î≥¥Ïû•', recommended: 100000000, category: 'Í∏∞ÌÉÄ' }
        ];

        const CATEGORIES = ['ÏÇ¨Îßù', 'Ïïî', 'Îáå/Ïã¨Ïû•', 'CI', 'ÏùºÏÉÅÏÉùÌôú', 'Í∏∞ÌÉÄ'];
        
        const JOB_TITLES = ['ÏßÄÏ†êÏû•', 'ÌåÄÏû•', 'Î∂ÄÏû•', 'Í≥ºÏû•', 'ÎåÄÎ¶¨', 'Ïª®ÏÑ§ÌÑ¥Ìä∏', 'ÏßÅÏ†ëÏûÖÎ†•'];

        const PHRASE_LIBRARY = {
            opening: [
                'Í≥†Í∞ùÎãòÏùò ÌòÑÏû¨ Î≥¥Ïû• ÏÉÅÌÉúÎ•º Î∂ÑÏÑùÌïú Í≤∞Í≥º,',
                'Ï¢ÖÌï©Ï†ÅÏù∏ Í≤ÄÌÜ†Î•º ÌÜµÌï¥',
                'ÏÉÅÏÑ∏Ìïú Î∂ÑÏÑù Í≤∞Í≥º,'
            ],
            adequate: [
                'Ï†ÅÏ†ïÌïú ÏàòÏ§ÄÏùò Î≥¥Ïû•Ïù¥ ÎßàÎ†®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.',
                'Ï∂©Î∂ÑÌïú Î≥¥Ïû• Í∏àÏï°ÏúºÎ°ú ÏïàÏ†ïÏ†ÅÏûÖÎãàÎã§.',
                'ÌòÑÏû¨ Î≥¥Ïû•Ïù¥ Í∂åÏû• ÏàòÏ§ÄÏùÑ ÎßåÏ°±ÌïòÍ≥† ÏûàÏäµÎãàÎã§.'
            ],
            recommend: [
                'Ï∂îÍ∞Ä Î≥¥Ïû•ÏùÑ Í∂åÏû•ÎìúÎ¶ΩÎãàÎã§.',
                'Î≥¥ÏôÑÏù¥ ÌïÑÏöîÌïú ÏÉÅÌô©ÏûÖÎãàÎã§.',
                'Îã®Í≥ÑÏ†ÅÏù∏ Î≥¥Ïû• ÌôïÎåÄÎ•º Í≥†Î†§Ìï¥Î≥¥ÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.'
            ],
            insufficient: [
                'Îπ†Î•∏ ÏãúÏùº ÎÇ¥Ïóê Î≥¥Ïû•ÏùÑ Î≥¥ÏôÑÌïòÏãúÍ∏∞Î•º Í∞ïÎ†•Ìûà Í∂åÏû•ÎìúÎ¶ΩÎãàÎã§.',
                'Ï∂©Î∂ÑÌïú Î≥¥Ïû• ÎßàÎ†®Ïù¥ ÏãúÍ∏âÌï©ÎãàÎã§.',
                'ÏúÑÌóò ÎåÄÎπÑÍ∞Ä Î∂ÄÏ°±Ìïú ÏÉÅÌÉúÏù¥ÎØÄÎ°ú Ï°∞ÏÜçÌïú Í∞ÄÏûÖÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.'
            ],
            closing: [
                'ÏûêÏÑ∏Ìïú ÏÉÅÎã¥ÏùÑ ÏõêÌïòÏãúÎ©¥ Ïñ∏Ï†úÎì† Ïó∞ÎùΩ Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.',
                'Í∂ÅÍ∏àÌïòÏã† Ï†êÏù¥ ÏûàÏúºÏãúÎ©¥ Î¨∏ÏùòÌï¥ Ï£ºÏÑ∏Ïöî.',
                'Ï∂îÍ∞Ä ÏÉÅÎã¥Ïù¥ ÌïÑÏöîÌïòÏãúÎ©¥ ÎßêÏîÄÌï¥ Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.'
            ]
        };

        // ===== Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò =====
        const formatNumber = (num) => {
            if (!num || num === 0 || num === '' || num === '0') return '';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        };

        const formatAmountKorean = (amount) => {
            if (amount >= 100000000) {
                const uk = Math.floor(amount / 100000000);
                const man = Math.floor((amount % 100000000) / 10000);
                if (man > 0) return `${uk}Ïñµ ${man.toLocaleString()}ÎßåÏõê`;
                return `${uk}ÏñµÏõê`;
            } else if (amount >= 10000) {
                const man = Math.floor(amount / 10000);
                return `${man.toLocaleString()}ÎßåÏõê`;
            }
            return `${amount.toLocaleString()}Ïõê`;
        };

        const getCoverageStatus = (current, recommended) => {
            if (current === 0) return 'none';
            const rate = (current / recommended) * 100;
            if (rate >= 90) return 'adequate';
            if (rate >= 60) return 'recommend';
            return 'insufficient';
        };

        const getStatusText = (status) => {
            switch (status) {
                case 'adequate': return '‚úÖ Ï†ÅÏ†ï';
                case 'recommend': return 'üü° Î≥¥ÏôÑÍ∂åÏû•';
                case 'insufficient': return '‚ö†Ô∏è Î∂ÄÏ°±';
                case 'none': return '‚ùå ÏóÜÏùå';
                default: return '';
            }
        };

        const getStatusColor = (status) => {
            switch (status) {
                case 'adequate': return '#10b981';
                case 'recommend': return '#f59e0b';
                case 'insufficient': return '#ef4444';
                case 'none': return '#6b7280';
                default: return '#6b7280';
            }
        };

        // Ï¥ùÎÇ©ÏûÖÎ≥¥ÌóòÎ£å Í≥ÑÏÇ∞ Ìï®Ïàò
        const calculateTotalPremium = (startDate, monthlyPremium) => {
            if (!startDate || !monthlyPremium) return 0;
            
            const start = new Date(startDate);
            const now = new Date();
            
            const months = (now.getFullYear() - start.getFullYear()) * 12 + 
                          (now.getMonth() - start.getMonth());
            
            return months > 0 ? months * monthlyPremium : 0;
        };

        // Í≤ΩÍ≥º Í∞úÏõî Ïàò Í≥ÑÏÇ∞
        const calculateMonthsElapsed = (startDate) => {
            if (!startDate) return 0;
            
            const start = new Date(startDate);
            const now = new Date();
            
            const months = (now.getFullYear() - start.getFullYear()) * 12 + 
                          (now.getMonth() - start.getMonth());
            
            return months > 0 ? months : 0;
        };

        // ÏùòÍ≤¨ ÏÉùÏÑ±
        const generateOpinion = (result, customer, consultant) => {
            const { coverageItem, currentAmount, recommendedAmount, status } = result;
            const rate = Math.round((currentAmount / recommendedAmount) * 100);
            const title = consultant.jobTitle === 'ÏßÅÏ†ëÏûÖÎ†•' ? consultant.customJobTitle : consultant.jobTitle;

            const header = `üí¨ ${consultant.name} ${title}Ïùò Î≥¥Ïû•Î∂ÑÏÑù ÏùòÍ≤¨\n\n`;

            switch (status) {
                case 'adequate':
                    return header + `ÌòÑÏû¨ ${coverageItem} Î≥¥Ïû•ÏùÄ ${formatAmountKorean(currentAmount)}ÏúºÎ°ú Ï†ÅÏ†ï ÏàòÏ§ÄÏûÖÎãàÎã§. ${customer.name}ÎãòÏùò Ïó∞Î†π(${customer.age}ÏÑ∏)Í≥º Ïó∞ÏÜåÎìù(${formatAmountKorean(customer.annualIncome)})ÏùÑ Í≥†Î†§Ìï† Îïå, Ï∂©Î∂ÑÌïú Î≥¥Ïû•Ïù¥ ÎßàÎ†®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.`;
                case 'recommend':
                    return header + `ÌòÑÏû¨ ${coverageItem} Î≥¥Ïû•ÏùÄ ${formatAmountKorean(currentAmount)}ÏúºÎ°ú Í∂åÏû• Î≥¥Ïû•Ïùò ${rate}% ÏàòÏ§ÄÏûÖÎãàÎã§. Í∂åÏû• Î≥¥Ïû•Ïï°ÏùÄ ${formatAmountKorean(recommendedAmount)}Ïù¥Î©∞, ${formatAmountKorean(recommendedAmount - currentAmount)}Ïùò Ï∂îÍ∞Ä Î≥¥Ïû•ÏùÑ Í∂åÏû•ÎìúÎ¶ΩÎãàÎã§.`;
                case 'insufficient':
                    return header + `ÌòÑÏû¨ ${coverageItem} Î≥¥Ïû•ÏùÄ ${formatAmountKorean(currentAmount)}ÏúºÎ°ú Í∂åÏû• Î≥¥Ïû•Ïùò ${rate}% ÏàòÏ§ÄÏúºÎ°ú Î∂ÄÏ°±Ìïú ÏÉÅÌÉúÏûÖÎãàÎã§. ${customer.age}ÏÑ∏ Ïó∞Î†πÎåÄÏóêÏÑú Ìï¥Îãπ ÏúÑÌóòÏóê ÎåÄÌïú Ï∂©Î∂ÑÌïú ÎåÄÎπÑÍ∞Ä Ï§ëÏöîÌïòÎØÄÎ°ú, Îπ†Î•∏ ÏãúÏùº ÎÇ¥Ïóê Î≥¥Ïû•ÏùÑ Î≥¥ÏôÑÌïòÏãúÍ∏∞Î•º Í∞ïÎ†•Ìûà Í∂åÏû•ÎìúÎ¶ΩÎãàÎã§.`;
                case 'none':
                    return header + `ÌòÑÏû¨ ${coverageItem} Î≥¥Ïû•Ïù¥ Í∞ÄÏûÖÎêòÏñ¥ ÏûàÏßÄ ÏïäÏäµÎãàÎã§. Í∂åÏû• Î≥¥Ïû•Ïï°ÏùÄ ${formatAmountKorean(recommendedAmount)}ÏûÖÎãàÎã§. Ï°∞ÏÜçÌïú Í∞ÄÏûÖÏùÑ Í∂åÏû•ÎìúÎ¶ΩÎãàÎã§.`;
                default:
                    return header + `${coverageItem}Ïóê ÎåÄÌïú Î∂ÑÏÑù Í≤∞Í≥ºÏûÖÎãàÎã§.`;
            }
        };

        // Ï¢ÖÌï© Ï¥ùÌèâ ÏÉùÏÑ±
        const generateSummary = (customer, adequateCount, recommendCount, insufficientCount, noneCount, totalPremium, consultant) => {
            const totalItems = adequateCount + recommendCount + insufficientCount + noneCount;
            const overallRate = Math.round((adequateCount / totalItems) * 100);
            const title = consultant.jobTitle === 'ÏßÅÏ†ëÏûÖÎ†•' ? consultant.customJobTitle : consultant.jobTitle;

            let ratingText = '';
            if (overallRate >= 90) ratingText = 'Îß§Ïö∞ Ïö∞Ïàò';
            else if (overallRate >= 75) ratingText = 'ÏñëÌò∏';
            else if (overallRate >= 60) ratingText = 'Î≥¥ÏôÑ Í∂åÏû•';
            else ratingText = 'Í∞úÏÑ† ÌïÑÏöî';

            return `üí¨ ${consultant.name} ${title}Ïùò Ï¢ÖÌï© Î≥¥Ïû•Î∂ÑÏÑù ÏùòÍ≤¨

${customer.name}ÎãòÏùò Ï†ÑÏ≤¥ Î≥¥Ïû• Î∂ÑÏÑù Í≤∞Í≥º, 25Í∞ú Ï£ºÏöî Î≥¥Ïû• Ìï≠Î™© Ï§ë Ï†ÅÏ†ï Î≥¥Ïû•ÏùÄ ${adequateCount}Í±¥, Î≥¥ÏôÑ Í∂åÏû•ÏùÄ ${recommendCount}Í±¥, Î∂ÄÏ°±ÏùÄ ${insufficientCount}Í±¥, ÎØ∏Í∞ÄÏûÖÏùÄ ${noneCount}Í±¥ÏúºÎ°ú Î∂ÑÏÑùÎêòÏóàÏäµÎãàÎã§.

Ï†ÑÏ≤¥ Î≥¥Ïû•Î•†ÏùÄ ${overallRate}%Î°ú "${ratingText}" ÏàòÏ§ÄÏûÖÎãàÎã§. ÌòÑÏû¨ Ïõî Î≥¥ÌóòÎ£åÎäî ${formatAmountKorean(totalPremium)}Ïù¥Î©∞, ${customer.annualIncome > 0 ? `Ïó∞ÏÜåÎìù ÎåÄÎπÑ ${Math.round((totalPremium * 12 / customer.annualIncome) * 100)}%` : ''} ÏàòÏ§ÄÏûÖÎãàÎã§.

${customer.age}ÏÑ∏ Ïó∞Î†πÎåÄÏóêÏÑú ÌäπÌûà Ï§ëÏöîÌïú Ïïî, ÎáåÌòàÍ¥Ä, Ïã¨Ïû•ÏßàÌôòÏóê ÎåÄÌïú Î≥¥Ïû•ÏùÑ Ïö∞ÏÑ†Ï†ÅÏúºÎ°ú Í≤ÄÌÜ†ÌïòÏãúÍ∏∞Î•º Í∂åÏû•ÎìúÎ¶ΩÎãàÎã§. ${customer.hasSpouse || customer.numberOfChildren > 0 ? 'Í∞ÄÏ°±Ïùò Í≤ΩÏ†úÏ†Å ÏïàÏ†ïÏùÑ ÏúÑÌï¥ ÏÇ¨Îßù Î≥¥Ïû•ÎèÑ Ï§ëÏöîÌïòÍ≤å Í≥†Î†§Ìï¥Ïïº Ìï©ÎãàÎã§.' : ''}

Î≥¥Ïû• Î≥¥ÏôÑÏù¥ ÌïÑÏöîÌïú Ìï≠Î™©Îì§ÏùÄ Í≥†Í∞ùÎãòÏùò ÏòàÏÇ∞Í≥º Ïö∞ÏÑ†ÏàúÏúÑÎ•º Í≥†Î†§ÌïòÏó¨ Îã®Í≥ÑÏ†ÅÏúºÎ°ú Í∞ÄÏûÖÌïòÏãúÎäî Í≤ÉÏùÑ Ï∂îÏ≤úÎìúÎ¶ΩÎãàÎã§.`;
        };

        // ÏïîÌò∏Ìôî
        const encryptData = (data) => {
            return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
        };

        const decryptData = (encryptedData) => {
            const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        };

        // Google Drive Ï¥àÍ∏∞Ìôî
        const initGoogleDrive = async () => {
            return new Promise((resolve, reject) => {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: GOOGLE_API_KEY,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                        });
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        };

        let tokenClient;
        const requestDriveAccess = async () => {
            return new Promise((resolve, reject) => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (response) => {
                        if (response.error) {
                            reject(response);
                        } else {
                            resolve(response.access_token);
                        }
                    }
                });
                tokenClient.requestAccessToken();
            });
        };

        const uploadToDrive = async (fileName, content) => {
            try {
                await requestDriveAccess();
                
                const metadata = {
                    name: fileName,
                    mimeType: 'application/octet-stream'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([content], { type: 'application/octet-stream' }));

                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                    {
                        method: 'POST',
                        headers: new Headers({ Authorization: `Bearer ${gapi.client.getToken().access_token}` }),
                        body: form,
                    }
                );

                const data = await response.json();
                return data.id;
            } catch (error) {
                console.error('Drive ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
                throw error;
            }
        };

        const listDriveFiles = async () => {
            try {
                await requestDriveAccess();
                
                const response = await gapi.client.drive.files.list({
                    pageSize: 100,
                    fields: 'files(id, name, modifiedTime)',
                    q: "name contains 'FMA_' and name contains '.enc'"
                });
                
                return response.result.files || [];
            } catch (error) {
                console.error('ÌååÏùº Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:', error);
                return [];
            }
        };

        const downloadFromDrive = async (fileId) => {
            try {
                await requestDriveAccess();
                
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    {
                        headers: new Headers({ Authorization: `Bearer ${gapi.client.getToken().access_token}` })
                    }
                );
                
                return await response.text();
            } catch (error) {
                console.error('ÌååÏùº Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
                throw error;
            }
        };

        // PDF ÏÉùÏÑ± (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
        const generatePDF = async (customer, consultant, insurances, analysisResults, summary, opinions) => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let currentPage = 1;

            // ÌéòÏù¥ÏßÄ Ï∂îÍ∞Ä Ìó¨Ìçº
            const addNewPage = () => {
                pdf.addPage();
                currentPage++;
            };

            // 1. ÌëúÏßÄ
            pdf.setFillColor(37, 99, 235);
            pdf.rect(0, 0, pageWidth, pageHeight, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(40);
            pdf.text('FMA', pageWidth / 2, 70, { align: 'center' });
            pdf.setFontSize(28);
            pdf.text('Financial Master Analysis', pageWidth / 2, 95, { align: 'center' });
            pdf.setFontSize(22);
            pdf.text('Î≥¥Ìóò Î≥¥Ïû• Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏', pageWidth / 2, 120, { align: 'center' });
            
            if (customer.name) {
                pdf.setFontSize(24);
                pdf.text(`${customer.name} Í≥†Í∞ùÎãò`, pageWidth / 2, 150, { align: 'center' });
            }
            
            pdf.setFontSize(14);
            const today = new Date().toLocaleDateString('ko-KR');
            pdf.text(today, pageWidth / 2, pageHeight - 30, { align: 'center' });

            // 2. Î™©Ï∞®
            addNewPage();
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(24);
            pdf.text('Î™©Ï∞®', 20, 30);
            
            pdf.setFontSize(12);
            const contents = [
                '1. Í≥†Í∞ù ÌîÑÎ°úÌïÑ',
                '2. Î≥¥Ìóò Í∞ÄÏûÖ ÌòÑÌô©',
                '3. Î≥¥Ïû• Î∂ÑÏÑù ÏöîÏïΩ',
                '4. Ìï≠Î™©Î≥Ñ ÏÉÅÏÑ∏ Î∂ÑÏÑù',
                '5. Ï¢ÖÌï© Ï¥ùÌèâ',
                '6. Ïª®ÏÑ§ÌÑ¥Ìä∏ Ï†ïÎ≥¥'
            ];
            contents.forEach((item, idx) => {
                pdf.text(item, 30, 50 + (idx * 10));
            });

            // 3. Í≥†Í∞ù ÌîÑÎ°úÌïÑ
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('Í≥†Í∞ù ÌîÑÎ°úÌïÑ', 20, 30);
            
            pdf.setFontSize(12);
            let y = 50;
            pdf.text(`Ïù¥Î¶Ñ: ${customer.name}`, 30, y);
            pdf.text(`ÎÇòÏù¥: ${customer.age}ÏÑ∏`, 30, y + 10);
            pdf.text(`ÏÑ±Î≥Ñ: ${customer.gender}`, 30, y + 20);
            pdf.text(`ÏßÅÏóÖ: ${customer.occupation || '-'}`, 30, y + 30);
            pdf.text(`Ïó∞ÏÜåÎìù: ${formatAmountKorean(customer.annualIncome)}`, 30, y + 40);
            pdf.text(`Î∞∞Ïö∞Ïûê: ${customer.hasSpouse ? 'ÏûàÏùå' : 'ÏóÜÏùå'}`, 30, y + 50);
            pdf.text(`ÏûêÎÖÄ: ${customer.numberOfChildren}Î™Ö`, 30, y + 60);

            // 4. Î≥¥Ìóò Í∞ÄÏûÖ ÌòÑÌô©
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('Î≥¥Ìóò Í∞ÄÏûÖ ÌòÑÌô©', 20, 30);
            
            y = 50;
            insurances.forEach((insurance, idx) => {
                if (y > pageHeight - 40) {
                    addNewPage();
                    y = 30;
                }
                
                pdf.setFontSize(14);
                pdf.text(`${idx + 1}. ${insurance.company} - ${insurance.productName}`, 30, y);
                pdf.setFontSize(11);
                pdf.text(`Ïõî Î≥¥ÌóòÎ£å: ${formatAmountKorean(insurance.monthlyPremium)}`, 35, y + 8);
                if (insurance.startDate) {
                    pdf.text(`Í∞ÄÏûÖÏùº: ${insurance.startDate}`, 35, y + 15);
                }
                
                y += 30;
            });

            // 5-6. Î≥¥Ïû• Î∂ÑÏÑù ÏöîÏïΩ
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('Î≥¥Ïû• Î∂ÑÏÑù ÏöîÏïΩ', 20, 30);
            
            const adequate = analysisResults.filter(r => r.status === 'adequate').length;
            const recommend = analysisResults.filter(r => r.status === 'recommend').length;
            const insufficient = analysisResults.filter(r => r.status === 'insufficient').length;
            const none = analysisResults.filter(r => r.status === 'none').length;
            
            pdf.setFontSize(12);
            y = 50;
            pdf.text(`‚úÖ Ï†ÅÏ†ï: ${adequate}Í±¥`, 30, y);
            pdf.text(`üü° Î≥¥ÏôÑÍ∂åÏû•: ${recommend}Í±¥`, 30, y + 10);
            pdf.text(`‚ö†Ô∏è Î∂ÄÏ°±: ${insufficient}Í±¥`, 30, y + 20);
            pdf.text(`‚ùå ÏóÜÏùå: ${none}Í±¥`, 30, y + 30);

            // 7-15. Ìï≠Î™©Î≥Ñ ÏÉÅÏÑ∏ Î∂ÑÏÑù (Ï£ºÏöî 10Í∞úÎßå)
            const topResults = analysisResults
                .filter(r => r.status !== 'adequate')
                .slice(0, 10);
            
            topResults.forEach((result, idx) => {
                addNewPage();
                pdf.setFontSize(18);
                pdf.text(`${idx + 1}. ${result.coverageItem}`, 20, 30);
                
                pdf.setFontSize(12);
                y = 50;
                pdf.text(`ÌòÑÏû¨ Î≥¥Ïû•: ${formatAmountKorean(result.currentAmount)}`, 30, y);
                pdf.text(`Í∂åÏû• Î≥¥Ïû•: ${formatAmountKorean(result.recommendedAmount)}`, 30, y + 10);
                pdf.text(`Î≥¥Ïû•Î•†: ${Math.round(result.coverageRate)}%`, 30, y + 20);
                pdf.text(`ÏßÑÎã®: ${getStatusText(result.status)}`, 30, y + 30);
                
                // ÏùòÍ≤¨
                const opinion = opinions[result.coverageItem] || result.opinion;
                const lines = pdf.splitTextToSize(opinion, pageWidth - 60);
                pdf.text(lines, 30, y + 50);
            });

            // 16. Ï¢ÖÌï© Ï¥ùÌèâ
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('Ï¢ÖÌï© Ï¥ùÌèâ', 20, 30);
            
            pdf.setFontSize(11);
            const summaryLines = pdf.splitTextToSize(summary, pageWidth - 50);
            pdf.text(summaryLines, 25, 50);

            // 17. Ïª®ÏÑ§ÌÑ¥Ìä∏ ÌîÑÎ°úÌïÑ
            addNewPage();
            pdf.setFontSize(20);
            pdf.text('Îã¥Îãπ Ïª®ÏÑ§ÌÑ¥Ìä∏', 20, 30);
            
            pdf.setFontSize(12);
            y = 50;
            const title = consultant.jobTitle === 'ÏßÅÏ†ëÏûÖÎ†•' ? consultant.customJobTitle : consultant.jobTitle;
            pdf.text(`Ïù¥Î¶Ñ: ${consultant.name} ${title}`, 30, y);
            pdf.text(`ÏÜåÏÜç: ${consultant.organization || '-'}`, 30, y + 10);
            pdf.text(`Ïó∞ÎùΩÏ≤ò: ${consultant.phone || '-'}`, 30, y + 20);
            pdf.text(`Ïù¥Î©îÏùº: ${consultant.email || '-'}`, 30, y + 30);

            return pdf;
        };

        // ===== Ïª¥Ìè¨ÎÑåÌä∏ =====
        
        // Ïª®ÏÑ§ÌÑ¥Ìä∏ ÌîÑÎ°úÌïÑ Î™®Îã¨
        function ConsultantProfileModal({ consultant, onSave, onClose }) {
            const [profile, setProfile] = useState(consultant || {
                name: '',
                jobTitle: 'Ïª®ÏÑ§ÌÑ¥Ìä∏',
                customJobTitle: '',
                organization: '',
                phone: '',
                email: '',
                signature: null
            });

            const handleSave = () => {
                if (!profile.name) {
                    alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                onSave(profile);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>‚öôÔ∏è Ïª®ÏÑ§ÌÑ¥Ìä∏ ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</h3>
                            <button className="btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="modal-body">
                            <div className="form-group">
                                <label>Ïù¥Î¶Ñ *</label>
                                <input
                                    type="text"
                                    className="input-medium"
                                    value={profile.name}
                                    onChange={(e) => setProfile({...profile, name: e.target.value})}
                                    placeholder="Ïòà) ÌôçÍ∏∏Îèô"
                                />
                            </div>

                            <div className="form-group">
                                <label>ÏßÅÏ±Ö *</label>
                                <select 
                                    className="input-medium"
                                    value={profile.jobTitle}
                                    onChange={(e) => setProfile({...profile, jobTitle: e.target.value})}
                                >
                                    {JOB_TITLES.map(title => (
                                        <option key={title} value={title}>{title}</option>
                                    ))}
                                </select>
                            </div>

                            {profile.jobTitle === 'ÏßÅÏ†ëÏûÖÎ†•' && (
                                <div className="form-group">
                                    <label>ÏßÅÏ±Ö ÏßÅÏ†ëÏûÖÎ†•</label>
                                    <input
                                        type="text"
                                        className="input-medium"
                                        value={profile.customJobTitle}
                                        onChange={(e) => setProfile({...profile, customJobTitle: e.target.value})}
                                        placeholder="Ïòà) ÏÑ†ÏûÑ Ïª®ÏÑ§ÌÑ¥Ìä∏"
                                    />
                                </div>
                            )}

                            <div className="form-group">
                                <label>ÏÜåÏÜç</label>
                                <input
                                    type="text"
                                    className="input-long"
                                    value={profile.organization}
                                    onChange={(e) => setProfile({...profile, organization: e.target.value})}
                                    placeholder="Ïòà) ‚óã‚óã Ïû¨Î¨¥ÏÑ§Í≥Ñ ÏÑºÌÑ∞"
                                />
                            </div>

                            <div className="form-group">
                                <label>Ïó∞ÎùΩÏ≤ò</label>
                                <input
                                    type="tel"
                                    className="input-medium"
                                    value={profile.phone}
                                    onChange={(e) => setProfile({...profile, phone: e.target.value})}
                                    placeholder="010-1234-5678"
                                />
                            </div>

                            <div className="form-group">
                                <label>Ïù¥Î©îÏùº</label>
                                <input
                                    type="email"
                                    className="input-long"
                                    value={profile.email}
                                    onChange={(e) => setProfile({...profile, email: e.target.value})}
                                    placeholder="hong@example.com"
                                />
                            </div>

                            <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'flex-end', marginTop: '1.5rem'}}>
                                <button className="btn btn-secondary" onClick={onClose}>
                                    Ï∑®ÏÜå
                                </button>
                                <button className="btn btn-primary" onClick={handleSave}>
                                    üíæ Ï†ÄÏû•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Î≥¥Ïû• Ìï≠Î™© Ï∂îÍ∞Ä Î™®Îã¨
        function CoverageAddModal({ onClose, onAdd }) {
            const [activeTab, setActiveTab] = useState('template');
            const [customName, setCustomName] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedItems, setSelectedItems] = useState([]);

            const filteredTemplates = COVERAGE_TEMPLATES.filter(t =>
                t.name.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const toggleSelection = (name) => {
                if (selectedItems.includes(name)) {
                    setSelectedItems(selectedItems.filter(item => item !== name));
                } else {
                    setSelectedItems([...selectedItems, name]);
                }
            };

            const handleAddSelected = () => {
                if (selectedItems.length > 0) {
                    onAdd(selectedItems);
                    onClose();
                }
            };

            const handleAddCustom = () => {
                if (customName.trim()) {
                    const items = customName.split(',').map(item => item.trim()).filter(item => item);
                    if (items.length > 0) {
                        onAdd(items);
                        onClose();
                    }
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>Î≥¥Ïû• Ìï≠Î™© Ï∂îÍ∞Ä {selectedItems.length > 0 && `(${selectedItems.length}Í∞ú ÏÑ†ÌÉù)`}</h3>
                            <button className="btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="modal-tabs">
                            <button className={activeTab === 'template' ? 'active' : ''} onClick={() => setActiveTab('template')}>
                                ‚ö° ÏûêÏ£º Ïì∞Îäî Ìï≠Î™©
                            </button>
                            <button className={activeTab === 'search' ? 'active' : ''} onClick={() => setActiveTab('search')}>
                                üîç Í≤ÄÏÉâ
                            </button>
                            <button className={activeTab === 'custom' ? 'active' : ''} onClick={() => setActiveTab('custom')}>
                                ‚úçÔ∏è ÏßÅÏ†ë ÏûÖÎ†•
                            </button>
                        </div>

                        <div className="modal-body">
                            {activeTab === 'template' && (
                                <div className="template-section">
                                    <p className="hint">Ïó¨Îü¨ Í∞úÎ•º ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§. Ï≤¥ÌÅ¨ ÌõÑ ÌïòÎã®Ïùò Ï∂îÍ∞Ä Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.</p>
                                    {CATEGORIES.map(cat => (
                                        <div key={cat} className="category-group">
                                            <h4>{cat} Î≥¥Ïû•</h4>
                                            <div className="template-buttons">
                                                {COVERAGE_TEMPLATES.filter(t => t.category === cat).map(template => (
                                                    <label
                                                        key={template.name}
                                                        className={`btn-template-checkbox ${selectedItems.includes(template.name) ? 'selected' : ''}`}
                                                        style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedItems.includes(template.name)}
                                                            onChange={() => toggleSelection(template.name)}
                                                            style={{cursor: 'pointer'}}
                                                        />
                                                        <span>{template.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    <div style={{marginTop: '1.5rem', display: 'flex', gap: '0.5rem', justifyContent: 'flex-end'}}>
                                        <button className="btn btn-secondary" onClick={onClose}>
                                            Ï∑®ÏÜå
                                        </button>
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleAddSelected}
                                            disabled={selectedItems.length === 0}
                                        >
                                            {selectedItems.length}Í∞ú Ìï≠Î™© Ï∂îÍ∞Ä
                                        </button>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'search' && (
                                <div>
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="Ïòà) Îáå, Ïïî, ÏûÖÏõê..."
                                        style={{width: '100%', padding: '0.75rem', border: '1px solid var(--gray-300)', borderRadius: '0.5rem', marginBottom: '1rem'}}
                                    />
                                    <p className="hint" style={{marginBottom: '1rem'}}>Ïó¨Îü¨ Í∞úÎ•º ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                                    <div style={{maxHeight: '40vh', overflowY: 'auto', marginBottom: '1rem'}}>
                                        {filteredTemplates.map(template => (
                                            <label
                                                key={template.name}
                                                style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '0.75rem',
                                                    padding: '0.75rem',
                                                    borderBottom: '1px solid var(--gray-200)',
                                                    cursor: 'pointer',
                                                    backgroundColor: selectedItems.includes(template.name) ? 'var(--gray-50)' : 'transparent'
                                                }}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={selectedItems.includes(template.name)}
                                                    onChange={() => toggleSelection(template.name)}
                                                    style={{cursor: 'pointer'}}
                                                />
                                                <span>{template.name}</span>
                                            </label>
                                        ))}
                                    </div>
                                    <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'flex-end'}}>
                                        <button className="btn btn-secondary" onClick={onClose}>
                                            Ï∑®ÏÜå
                                        </button>
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleAddSelected}
                                            disabled={selectedItems.length === 0}
                                        >
                                            {selectedItems.length}Í∞ú Ìï≠Î™© Ï∂îÍ∞Ä
                                        </button>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'custom' && (
                                <div>
                                    <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>Î≥¥Ïû• Ìï≠Î™©Î™Ö (Ïó¨Îü¨ Í∞úÎäî ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)</label>
                                    <textarea
                                        value={customName}
                                        onChange={(e) => setCustomName(e.target.value)}
                                        placeholder="Ïòà) ÌäπÏ†ï ÏàòÏà†ÎπÑ, ÎãπÎá®Ìï©Î≥ëÏ¶ù, Ïã†Î∂ÄÏ†ÑÏ¶ù"
                                        style={{width: '100%', minHeight: '100px', padding: '0.75rem', border: '1px solid var(--gray-300)', borderRadius: '0.5rem', marginBottom: '1rem', fontFamily: 'inherit'}}
                                    />
                                    <p className="hint">Ïó¨Îü¨ Ìï≠Î™©ÏùÑ Ìïú Î≤àÏóê Ï∂îÍ∞ÄÌïòÎ†§Î©¥ ÏâºÌëú(,)Î°ú Íµ¨Î∂ÑÌïòÏÑ∏Ïöî.</p>
                                    <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'flex-end', marginTop: '1rem'}}>
                                        <button className="btn btn-secondary" onClick={onClose}>
                                            Ï∑®ÏÜå
                                        </button>
                                        <button
                                            className="btn btn-primary"
                                            onClick={handleAddCustom}
                                            disabled={!customName.trim()}
                                        >
                                            Ï∂îÍ∞ÄÌïòÍ∏∞
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Í≥†Í∞ù Î™©Î°ù ÌôîÎ©¥
        function CustomerListScreen({ savedSessions, onSelect, onNew, onRefresh }) {
            return (
                <div className="form-section">
                    <h2>üìã Í≥†Í∞ù Î™©Î°ù</h2>
                    
                    <div style={{marginBottom: '2rem', display: 'flex', gap: '1rem'}}>
                        <button className="btn btn-primary" onClick={onNew}>
                            + ÏÉà Í≥†Í∞ù Î∂ÑÏÑù ÏãúÏûë
                        </button>
                        <button className="btn btn-secondary" onClick={onRefresh}>
                            üîÑ Î∂àÎü¨Ïò§Í∏∞
                        </button>
                    </div>

                    {savedSessions.length === 0 ? (
                        <div className="empty-state">
                            <p>Ï†ÄÏû•Îêú Í≥†Í∞ù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            <p className="hint">ÏÉà Í≥†Í∞ù Î∂ÑÏÑùÏùÑ ÏãúÏûëÌïòÍ±∞ÎÇò Google DriveÏóêÏÑú Î∂àÎü¨Ïò§ÏÑ∏Ïöî.</p>
                        </div>
                    ) : (
                        <div className="customer-list">
                            {savedSessions.map((session, idx) => (
                                <div key={idx} className="customer-card" onClick={() => onSelect(session)}>
                                    <div className="customer-card-header">
                                        <div className="customer-card-name">{session.customer.name}</div>
                                        <div className="status-badge" style={{backgroundColor: 'var(--primary-color)'}}>
                                            {session.customer.age}ÏÑ∏
                                        </div>
                                    </div>
                                    <div className="customer-card-info">
                                        <div>{session.customer.gender} ¬∑ {session.customer.occupation || '-'}</div>
                                        <div>Ïó∞ÏÜåÎìù: {formatAmountKorean(session.customer.annualIncome)}</div>
                                        <div>Î≥¥Ìóò: {session.insurances.length}Í±¥</div>
                                        <div className="hint">ÏàòÏ†ïÏùº: {session.modifiedTime}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Î©îÏù∏ Ïï±
        function App() {
            // URL ÌååÎùºÎØ∏ÌÑ∞Î°ú Î™®Îìú ÌôïÏù∏
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            const isCustomerMode = !!sessionId;

            const [currentScreen, setCurrentScreen] = useState(isCustomerMode ? 'analysis' : 'customerList');
            const [currentTab, setCurrentTab] = useState('input');
            const [loading, setLoading] = useState(false);
            const [driveReady, setDriveReady] = useState(false);
            
            const [customer, setCustomer] = useState({
                name: '',
                age: '', // Îπà Í∞íÏúºÎ°ú ÏãúÏûë
                gender: 'ÎÇ®ÏÑ±',
                occupation: '',
                annualIncome: '', // Îπà Í∞íÏúºÎ°ú ÏãúÏûë
                hasSpouse: false,
                spouse: {
                    name: '',
                    birthDate: ''
                },
                children: [
                    { id: 1, name: '', birthDate: '' },
                    { id: 2, name: '', birthDate: '' }
                ]
            });

            const [consultant, setConsultant] = useState(null);
            const [showConsultantModal, setShowConsultantModal] = useState(false);
            
            const [insurances, setInsurances] = useState([]);
            
            // localStorageÏóêÏÑú Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏûêÎèô Î°úÎìú
            useEffect(() => {
                const userName = localStorage.getItem('userName');
                const userPhone = localStorage.getItem('userPhone');
                const userCompany = localStorage.getItem('userCompany') || localStorage.getItem('userOrganization');
                const userEmail = localStorage.getItem('userEmail');
                const userJobTitle = localStorage.getItem('userJobTitle');
                
                // Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥Í∞Ä ÏûàÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Ïª®ÏÑ§ÌÑ¥Ìä∏ ÏÑ§Ï†ï
                if (userName) {
                    setConsultant({
                        name: userName || 'Ïª®ÏÑ§ÌÑ¥Ìä∏',
                        company: userCompany || 'Î≥¥ÌóòÏÑ§Í≥ÑÏÇ¨',
                        jobTitle: userJobTitle || 'Ïª®ÏÑ§ÌÑ¥Ìä∏',
                        customJobTitle: '',
                        phone: userPhone || '',
                        email: userEmail || ''
                    });
                }
            }, []);
            const [analysisResults, setAnalysisResults] = useState([]);
            const [summary, setSummary] = useState('');
            const [opinions, setOpinions] = useState({});
            const [showCoverageModal, setShowCoverageModal] = useState(null);
            const [editingOpinion, setEditingOpinion] = useState(null);
            const [savedSessions, setSavedSessions] = useState([]);

            // Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Í¥ÄÎ†® State
            const [currentSessionId, setCurrentSessionId] = useState(sessionId || null);
            const [inviteLink, setInviteLink] = useState('');
            const [syncStatus, setSyncStatus] = useState('ÎåÄÍ∏∞Ï§ë');
            
            // ÏûÖÎ†• Ï§ë Ï≤¥ÌÅ¨ (ÌÉÄÏù¥Ìïë Ï§ëÏóêÎäî FirebaseÎ°úÎ∂ÄÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Î∞õÏßÄ ÏïäÏùå)
            const isTypingRef = useRef(false);
            const typingTimeoutRef = useRef(null);
            
            // Google Drive Ï†ÄÏû• ÏÉÅÌÉú Ï∂îÏ†Å
            const [isSavedToDrive, setIsSavedToDrive] = useState(false);
            const [lastSavedTime, setLastSavedTime] = useState(null);

            const chartsRef = useRef(null);
            const comparisonChartRef = useRef(null);
            const categoryChartRef = useRef(null);
            const radarChartRef = useRef(null);
            const premiumChartRef = useRef(null);
            const comparisonChartInstance = useRef(null);
            const categoryChartInstance = useRef(null);
            const radarChartInstance = useRef(null);
            const premiumChartInstance = useRef(null);

            useEffect(() => {
                if (!isCustomerMode) {
                    initGoogleDrive().then(() => {
                        setDriveReady(true);
                        loadSavedSessions();
                    }).catch(err => {
                        console.error('Drive Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', err);
                    });
                }
            }, [isCustomerMode]);
            
            // Session ID localStorage Ï†ÄÏû•/Î≥µÏõê (Í≥†Í∞ù, Ïª®ÏÑ§ÌÑ¥Ìä∏ Î™®Îëê)
            useEffect(() => {
                const urlSessionId = urlParams.get('session');
                
                if (urlSessionId) {
                    // URLÏóê sessionÏù¥ ÏûàÏúºÎ©¥ localStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('currentSessionId', urlSessionId);
                    setCurrentSessionId(urlSessionId);
                    
                    // URLÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉàÎ°úÍ≥†Ïπ® ÌõÑÏóêÎèÑ Ïú†ÏßÄ)
                    if (!isCustomerMode) {
                        window.history.replaceState({}, '', `?session=${urlSessionId}`);
                    }
                } else {
                    // URLÏóê ÏóÜÏúºÎ©¥ localStorageÏóêÏÑú Î≥µÏõê
                    const savedSessionId = localStorage.getItem('currentSessionId');
                    if (savedSessionId) {
                        setCurrentSessionId(savedSessionId);
                        
                        // URLÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉàÎ°úÍ≥†Ïπ® ÌõÑÏóêÎèÑ Ïú†ÏßÄ)
                        if (!isCustomerMode) {
                            window.history.replaceState({}, '', `?session=${savedSessionId}`);
                        }
                    }
                }
            }, []);

            // Firebase Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÏÑ§Ï†ï
            useEffect(() => {
                if (!database || !currentSessionId) return;

                const sessionRef = database.ref(`sessions/${currentSessionId}`);
                
                // Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                const listener = sessionRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setSyncStatus('ÎèôÍ∏∞ÌôîÎê®');
                        
                        // ÏûÖÎ†• Ï§ëÏù¥ ÏïÑÎãê ÎïåÎßå ÏóÖÎç∞Ïù¥Ìä∏ Î∞õÍ∏∞ (ÌÉÄÏù¥Ìïë Î∞©Ìï¥ Î∞©ÏßÄ)
                        if (!isTypingRef.current) {
                            // Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî (Ïª®ÏÑ§ÌÑ¥Ìä∏, Í≥†Í∞ù Î™®Îëê)
                            if (data.customer) setCustomer(data.customer);
                            if (data.consultant) setConsultant(data.consultant);
                            if (data.summary) setSummary(data.summary);
                            if (data.opinions) setOpinions(data.opinions);
                            
                            // insurancesÏôÄ analysisResults ÎèôÍ∏∞Ìôî
                            if (data.insurances) {
                                const insurancesArray = Array.isArray(data.insurances) 
                                    ? data.insurances 
                                    : Object.values(data.insurances).filter(v => v && typeof v === 'object');
                                setInsurances(insurancesArray);
                            }
                            
                            if (data.analysisResults) {
                                const resultsArray = Array.isArray(data.analysisResults)
                                    ? data.analysisResults
                                    : Object.values(data.analysisResults).filter(v => v && typeof v === 'object');
                                setAnalysisResults(resultsArray);
                            }
                        }
                    }
                });

                return () => {
                    sessionRef.off('value', listener);
                };
            }, [currentSessionId, isCustomerMode]);

            // Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïãú Firebase ÏóÖÎç∞Ïù¥Ìä∏ (ÎîîÎ∞îÏö¥Ïã± Ï†ÅÏö©)
            useEffect(() => {
                if (!database || !currentSessionId) return;

                // ÌÉÄÏù¥Ìïë ÏãúÏûë ÌëúÏãú
                isTypingRef.current = true;
                
                const timeoutId = setTimeout(() => {
                    const updateData = {
                        customer,
                        insurances,
                        consultant,
                        analysisResults,
                        summary,
                        opinions,
                        updatedAt: Date.now()
                    };

                    database.ref(`sessions/${currentSessionId}`).set(updateData).catch(err => {
                        console.error('Firebase Ï†ÄÏû• Ïã§Ìå®:', err);
                        setSyncStatus('Ï†ÄÏû• Ïã§Ìå®');
                    });
                    
                    setSyncStatus('ÎèôÍ∏∞ÌôîÎê®');
                    
                    // ÌÉÄÏù¥Ìïë Ï¢ÖÎ£å ÌëúÏãú (500ms ÌõÑ)
                    isTypingRef.current = false;
                }, 500); // 500ms ÎîîÎ∞îÏö¥Ïã± (ÏïàÏ†ïÏ†ÅÏù∏ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî)

                return () => {
                    clearTimeout(timeoutId);
                    // cleanup ÏãúÏóêÎèÑ ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                    if (typingTimeoutRef.current) {
                        clearTimeout(typingTimeoutRef.current);
                    }
                    typingTimeoutRef.current = setTimeout(() => {
                        isTypingRef.current = false;
                    }, 100);
                };
            }, [customer, insurances, consultant, analysisResults, summary, opinions, currentSessionId]);
            
            // Ï¶âÏãú Firebase ÏóÖÎç∞Ïù¥Ìä∏ (Ï§ëÏöîÌïú Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïö©)
            const immediateFirebaseUpdate = () => {
                if (!database || !currentSessionId) return;
                
                // ÏßßÍ≤å ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                isTypingRef.current = true;
                
                const updateData = {
                    customer,
                    insurances,
                    consultant,
                    analysisResults,
                    summary,
                    opinions,
                    updatedAt: Date.now()
                };

                database.ref(`sessions/${currentSessionId}`).set(updateData).catch(err => {
                    console.error('Firebase Ï¶âÏãú Ï†ÄÏû• Ïã§Ìå®:', err);
                });
                
                setSyncStatus('ÎèôÍ∏∞ÌôîÎê® ‚úì');
                
                // 200ms ÌõÑ ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                setTimeout(() => {
                    isTypingRef.current = false;
                }, 200);
            };
            
            // Î∂ÑÏÑù ÏôÑÎ£å Ïãú ÏûêÎèô Google Drive Ï†ÄÏû• (Ïª®ÏÑ§ÌÑ¥Ìä∏Îßå)
            useEffect(() => {
                if (isCustomerMode || !currentSessionId || analysisResults.length === 0) return;
                
                // Ïù¥ÎØ∏ Ï†ÄÏû•ÎêòÏóàÏúºÎ©¥ Ïä§ÌÇµ
                if (isSavedToDrive) return;
                
                // 3Ï¥à ÌõÑ ÏûêÎèô Ï†ÄÏû• (ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•ÏùÑ ÎßàÏπ† ÏãúÍ∞Ñ)
                const autoSaveTimer = setTimeout(async () => {
                    try {
                        console.log('üîÑ Î∂ÑÏÑù ÏôÑÎ£å - ÏûêÎèô Google Drive Ï†ÄÏû• ÏãúÏûë...');
                        
                        const session = {
                            customer,
                            insurances,
                            consultant,
                            analysisResults,
                            summary,
                            opinions,
                            sessionId: currentSessionId,
                            savedAt: new Date().toISOString()
                        };

                        const fileName = `FMA_${customer.name || 'Í≥†Í∞ù'}_${new Date().toLocaleDateString('ko-KR').replace(/\. /g, '-').replace('.', '')}.json`;
                        const encryptedData = encryptData(session);
                        
                        await uploadToDrive(fileName, encryptedData);
                        
                        setIsSavedToDrive(true);
                        setLastSavedTime(new Date());
                        setSyncStatus('Ï†ÄÏû• ÏôÑÎ£å');
                        
                        console.log('‚úÖ Google Drive ÏûêÎèô Ï†ÄÏû• ÏôÑÎ£å:', fileName);
                    } catch (error) {
                        console.error('‚ùå Google Drive ÏûêÎèô Ï†ÄÏû• Ïã§Ìå®:', error);
                    }
                }, 3000);

                return () => clearTimeout(autoSaveTimer);
            }, [analysisResults, customer, insurances, consultant, summary, opinions, currentSessionId, isSavedToDrive, isCustomerMode]);

            const loadSavedSessions = async () => {
                try {
                    const files = await listDriveFiles();
                    const sessions = [];
                    
                    for (const file of files.slice(0, 20)) { // ÏµúÎåÄ 20Í∞úÎßå
                        try {
                            const encryptedData = await downloadFromDrive(file.id);
                            const session = decryptData(encryptedData);
                            session.fileId = file.id;
                            session.modifiedTime = new Date(file.modifiedTime).toLocaleString('ko-KR');
                            sessions.push(session);
                        } catch (err) {
                            console.error('ÌååÏùº Î°úÎìú Ïã§Ìå®:', file.name, err);
                        }
                    }
                    
                    setSavedSessions(sessions);
                } catch (error) {
                    console.error('ÏÑ∏ÏÖò Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                }
            };

            const loadSession = (session) => {
                setCustomer(session.customer);
                setConsultant(session.consultant);
                setInsurances(session.insurances);
                setAnalysisResults(session.analysisResults || []);
                setSummary(session.summary || '');
                setOpinions(session.opinions || {});
                setCurrentScreen('analysis');
                setCurrentTab('input');
            };

            const startNewAnalysis = () => {
                setCustomer({
                    name: '',
                    age: '', // Îπà Í∞íÏúºÎ°ú ÏãúÏûë
                    gender: 'ÎÇ®ÏÑ±',
                    occupation: '',
                    annualIncome: '', // Îπà Í∞íÏúºÎ°ú ÏãúÏûë
                    hasSpouse: false,
                    spouse: {
                        name: '',
                        birthDate: ''
                    },
                    children: [
                        { id: 1, name: '', birthDate: '' },
                        { id: 2, name: '', birthDate: '' }
                    ]
                });
                setInsurances([]);
                setAnalysisResults([]);
                setSummary('');
                setOpinions({});
                setCurrentScreen('analysis');
                setCurrentTab('input');
                
                // ÏÉà ÏÑ∏ÏÖò ID ÏÉùÏÑ±
                if (database) {
                    const newSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    setCurrentSessionId(newSessionId);
                    
                    // Ï¥àÎåÄ ÎßÅÌÅ¨ ÏÉùÏÑ±
                    const baseUrl = window.location.origin + window.location.pathname;
                    const link = `${baseUrl}?session=${newSessionId}`;
                    setInviteLink(link);
                }
            };

            const generateInviteLink = () => {
                if (!database) {
                    alert('FirebaseÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    return;
                }

                const newSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                setCurrentSessionId(newSessionId);
                
                const baseUrl = window.location.origin + window.location.pathname;
                const link = `${baseUrl}?session=${newSessionId}`;
                setInviteLink(link);
                
                // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                database.ref(`sessions/${newSessionId}`).set({
                    customer,
                    insurances,
                    consultant,
                    createdAt: Date.now()
                });
            };

            const copyInviteLink = () => {
                navigator.clipboard.writeText(inviteLink);
                alert('Ï¥àÎåÄ ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
            };

            const addInsurance = () => {
                const newInsurance = {
                    id: Date.now(),
                    company: '',
                    productName: '',
                    monthlyPremium: '', // Îπà Í∞íÏúºÎ°ú ÏãúÏûë
                    startDate: '',
                    endDate: '',
                    coverages: []
                };
                const updatedInsurances = [...insurances, newInsurance];
                setInsurances(updatedInsurances);
                
                // Ï¶âÏãú Firebase ÏóÖÎç∞Ïù¥Ìä∏
                if (database && currentSessionId) {
                    // ÏßßÍ≤å ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                    isTypingRef.current = true;
                    
                    database.ref(`sessions/${currentSessionId}`).update({
                        customer,
                        insurances: updatedInsurances,
                        consultant,
                        analysisResults,
                        summary,
                        opinions,
                        updatedAt: Date.now()
                    });
                    setSyncStatus('Î≥¥Ìóò Ï∂îÍ∞ÄÎê® ‚úì');
                    
                    // 200ms ÌõÑ ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                    setTimeout(() => {
                        isTypingRef.current = false;
                    }, 200);
                }
            };

            const updateInsurance = (id, field, value) => {
                setInsurances(insurances.map(ins =>
                    ins.id === id ? { ...ins, [field]: value } : ins
                ));
            };

            const removeInsurance = (id) => {
                if (confirm('Ïù¥ Î≥¥ÌóòÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    const updatedInsurances = insurances.filter(ins => ins.id !== id);
                    setInsurances(updatedInsurances);
                    
                    // Ï¶âÏãú Firebase ÏóÖÎç∞Ïù¥Ìä∏
                    if (database && currentSessionId) {
                        // ÏßßÍ≤å ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                        isTypingRef.current = true;
                        
                        database.ref(`sessions/${currentSessionId}`).update({
                            customer,
                            insurances: updatedInsurances,
                            consultant,
                            analysisResults,
                            summary,
                            opinions,
                            updatedAt: Date.now()
                        });
                        setSyncStatus('Î≥¥Ìóò ÏÇ≠Ï†úÎê® ‚úì');
                        
                        // 200ms ÌõÑ ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                        setTimeout(() => {
                            isTypingRef.current = false;
                        }, 200);
                    }
                }
            };

            const addCoverage = (insuranceId, coverageNames) => {
                const names = Array.isArray(coverageNames) ? coverageNames : [coverageNames];
                setInsurances(insurances.map(ins =>
                    ins.id === insuranceId
                        ? { 
                            ...ins, 
                            coverages: [
                                ...(ins.coverages || []), 
                                ...names.map(name => ({
                                    id: Date.now() + Math.random(),
                                    name: name,
                                    amount: '' // Îπà Í∞íÏúºÎ°ú ÏãúÏûë
                                }))
                            ]
                        }
                        : ins
                ));
            };

            const updateCoverage = (insuranceId, coverageId, amount) => {
                setInsurances(insurances.map(ins =>
                    ins.id === insuranceId
                        ? { ...ins, coverages: (ins.coverages || []).map(c => c.id === coverageId ? { ...c, amount } : c) }
                        : ins
                ));
            };

            const removeCoverage = (insuranceId, coverageId) => {
                setInsurances(insurances.map(ins =>
                    ins.id === insuranceId
                        ? { ...ins, coverages: (ins.coverages || []).filter(c => c.id !== coverageId) }
                        : ins
                ));
            };

            const handleStartAnalysis = () => {
                if (!customer.name) {
                    alert('Í≥†Í∞ù Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                if (!customer.age || customer.age === '' || customer.age < 1 || customer.age > 120) {
                    alert('Í≥†Í∞ù ÎÇòÏù¥Î•º Ïò¨Î∞îÎ•¥Í≤å ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (1~120ÏÑ∏)');
                    return;
                }
                if (insurances.length === 0) {
                    alert('ÏµúÏÜå ÌïòÎÇòÏùò Î≥¥ÌóòÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                // consultantÍ∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï (Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏóÜÎäî Í≤ΩÏö∞)
                if (!consultant) {
                    setConsultant({
                        name: 'Ïª®ÏÑ§ÌÑ¥Ìä∏',
                        company: 'Î≥¥ÌóòÏÑ§Í≥ÑÏÇ¨',
                        jobTitle: 'Ïª®ÏÑ§ÌÑ¥Ìä∏',
                        customJobTitle: '',
                        phone: '',
                        email: ''
                    });
                }

                // Î∂ÑÏÑù ÏàòÌñâ
                const coverageMap = new Map();
                insurances.forEach(insurance => {
                    insurance.coverages.forEach(coverage => {
                        const current = coverageMap.get(coverage.name) || 0;
                        const amount = typeof coverage.amount === 'number' ? coverage.amount : (parseInt(coverage.amount) || 0);
                        coverageMap.set(coverage.name, current + amount);
                    });
                });

                const results = COVERAGE_TEMPLATES.map(template => {
                    const currentAmount = coverageMap.get(template.name) || 0;
                    const recommendedAmount = template.recommended;
                    const coverageRate = recommendedAmount > 0 ? Math.min((currentAmount / recommendedAmount) * 100, 100) : 0;
                    const status = getCoverageStatus(currentAmount, recommendedAmount);

                    return {
                        coverageItem: template.name,
                        currentAmount,
                        recommendedAmount,
                        coverageRate,
                        status,
                        opinion: generateOpinion({coverageItem: template.name, currentAmount, recommendedAmount, status}, customer, consultant)
                    };
                });

                setAnalysisResults(results);

                // ÏùòÍ≤¨ Ï¥àÍ∏∞Ìôî
                const newOpinions = {};
                results.forEach(r => {
                    newOpinions[r.coverageItem] = r.opinion;
                });
                setOpinions(newOpinions);

                // Ï¢ÖÌï© ÏùòÍ≤¨ ÏÉùÏÑ±
                const adequate = results.filter(r => r.status === 'adequate').length;
                const recommend = results.filter(r => r.status === 'recommend').length;
                const insufficient = results.filter(r => r.status === 'insufficient').length;
                const none = results.filter(r => r.status === 'none').length;
                const totalPremium = insurances.reduce((sum, ins) => {
                    const premium = typeof ins.monthlyPremium === 'number' ? ins.monthlyPremium : (parseInt(ins.monthlyPremium) || 0);
                    return sum + premium;
                }, 0);
                const summaryText = generateSummary(customer, adequate, recommend, insufficient, none, totalPremium, consultant);
                setSummary(summaryText);

                setCurrentTab('analysis');
                
                setTimeout(() => {
                    createCharts(results);
                }, 100);
            };

            const createCharts = (results) => {
                // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞
                if (comparisonChartInstance.current) comparisonChartInstance.current.destroy();
                if (categoryChartInstance.current) categoryChartInstance.current.destroy();
                if (radarChartInstance.current) radarChartInstance.current.destroy();
                if (premiumChartInstance.current) premiumChartInstance.current.destroy();

                // 1. ÎπÑÍµê ÎßâÎåÄ Ï∞®Ìä∏
                if (comparisonChartRef.current) {
                    const ctx = comparisonChartRef.current.getContext('2d');
                    const topItems = results
                        .filter(r => r.recommendedAmount > 0)
                        .sort((a, b) => b.recommendedAmount - a.recommendedAmount)
                        .slice(0, 8);

                    comparisonChartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: topItems.map(r => r.coverageItem),
                            datasets: [
                                {
                                    label: 'ÌòÑÏû¨ Î≥¥Ïû•',
                                    data: topItems.map(r => r.currentAmount / 10000),
                                    backgroundColor: 'rgba(37, 99, 235, 0.7)',
                                    borderColor: 'rgba(37, 99, 235, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Í∂åÏû• Î≥¥Ïû•',
                                    data: topItems.map(r => r.recommendedAmount / 10000),
                                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                    borderColor: 'rgba(16, 185, 129, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'top' }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value + 'ÎßåÏõê';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // 2. ÏÉÅÌÉú Î∂ÑÌè¨ ÎèÑÎÑõ Ï∞®Ìä∏
                if (categoryChartRef.current) {
                    const ctx = categoryChartRef.current.getContext('2d');
                    const adequate = results.filter(r => r.status === 'adequate').length;
                    const recommend = results.filter(r => r.status === 'recommend').length;
                    const insufficient = results.filter(r => r.status === 'insufficient').length;
                    const none = results.filter(r => r.status === 'none').length;

                    categoryChartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Ï†ÅÏ†ï', 'Î≥¥ÏôÑÍ∂åÏû•', 'Î∂ÄÏ°±', 'ÎØ∏Î≥¥Ïû•'],
                            datasets: [{
                                data: [adequate, recommend, insufficient, none],
                                backgroundColor: [
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(156, 163, 175, 0.8)'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'bottom' }
                            }
                        }
                    });
                }

                // 3. Î†àÏù¥Îçî Ï∞®Ìä∏ (Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í∑†ÌòïÎèÑ)
                if (radarChartRef.current) {
                    const ctx = radarChartRef.current.getContext('2d');
                    const categoryData = {};
                    CATEGORIES.forEach(cat => {
                        const items = results.filter(r => {
                            const template = COVERAGE_TEMPLATES.find(t => t.name === r.coverageItem);
                            return template && template.category === cat;
                        });
                        const avgRate = items.length > 0 
                            ? items.reduce((sum, r) => sum + r.coverageRate, 0) / items.length 
                            : 0;
                        categoryData[cat] = avgRate;
                    });

                    radarChartInstance.current = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: CATEGORIES,
                            datasets: [{
                                label: 'Î≥¥Ïû•Î•†',
                                data: CATEGORIES.map(cat => categoryData[cat]),
                                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                                borderColor: 'rgba(37, 99, 235, 1)',
                                pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(37, 99, 235, 1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // 4. Î≥¥ÌóòÎ£å Î∂ÑÎ∞∞ ÎèÑÎÑõ Ï∞®Ìä∏
                if (premiumChartRef.current) {
                    const ctx = premiumChartRef.current.getContext('2d');
                    const premiumData = insurances.map(ins => ({
                        name: ins.company,
                        amount: ins.monthlyPremium
                    }));

                    premiumChartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: premiumData.map(p => p.name),
                            datasets: [{
                                data: premiumData.map(p => p.amount),
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(139, 92, 246, 0.8)',
                                    'rgba(236, 72, 153, 0.8)'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.label + ': ' + formatAmountKorean(context.parsed);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            };

            const handleGeneratePDF = async () => {
                if (!customer.name || !analysisResults || analysisResults.length === 0) {
                    alert('Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                try {
                    setLoading(true);
                    
                    const pdf = await generatePDF(customer, consultant, insurances, analysisResults, summary, opinions);
                    pdf.save(`FMA_Î≥¥Ïû•Î∂ÑÏÑù_${customer.name}_${new Date().toISOString().split('T')[0]}.pdf`);

                    alert('PDFÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
                } catch (error) {
                    console.error('PDF ÏÉùÏÑ± Ïã§Ìå®:', error);
                    alert('PDF ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                } finally {
                    setLoading(false);
                }
            };

            const handleSaveToDrive = async (isAuto = false) => {
                if (!customer.name) {
                    if (!isAuto) alert('Í≥†Í∞ù Ïù¥Î¶ÑÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                if (!driveReady) {
                    if (!isAuto) alert('Google Drive APIÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\n\nÏΩîÎìú ÏÉÅÎã®Ïùò Îã§Ïùå Í∞íÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî:\n- GOOGLE_CLIENT_ID\n- GOOGLE_API_KEY\n- ENCRYPTION_KEY\n\nÏÑ§Ï†ï Î∞©Î≤ïÏùÄ Google Cloud ConsoleÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
                    return;
                }

                try {
                    if (!isAuto) setLoading(true);
                    
                    const session = {
                        customer,
                        consultant,
                        insurances,
                        analysisResults,
                        summary,
                        opinions,
                        sessionId: currentSessionId,
                        savedAt: new Date().toISOString()
                    };

                    const fileName = `FMA_${customer.name || 'Í≥†Í∞ù'}_${new Date().toLocaleDateString('ko-KR').replace(/\. /g, '-').replace('.', '')}.json`;
                    const encryptedData = encryptData(session);
                    
                    await uploadToDrive(fileName, encryptedData);
                    
                    setIsSavedToDrive(true);
                    setLastSavedTime(new Date());
                    setSyncStatus('Ï†ÄÏû• ÏôÑÎ£å');
                    
                    if (!isAuto) {
                        alert('‚úÖ Google DriveÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                    }
                    
                    console.log('‚úÖ Google Drive Ï†ÄÏû• ÏôÑÎ£å:', fileName);
                    
                    // Î™©Î°ù Í∞±Ïã†
                    await loadSavedSessions();
                } catch (error) {
                    console.error('Ï†ÄÏû• Ïã§Ìå®:', error);
                    setSyncStatus('Ï†ÄÏû• Ïã§Ìå®');
                    if (!isAuto) alert('‚ùå Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
                } finally {
                    if (!isAuto) setLoading(false);
                }
            };
            
            // ÏÑ∏ÏÖò Ï¢ÖÎ£å Ìï®Ïàò (Ïª®ÏÑ§ÌÑ¥Ìä∏Îßå - Ï†ÄÏû• ÌôïÏù∏ Ìè¨Ìï®)
            const endSession = () => {
                if (!isSavedToDrive && analysisResults.length > 0) {
                    if (!confirm('‚ö†Ô∏è Google DriveÏóê Ï†ÄÏû•ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§!\n\nÏ†ÄÏû•ÌïòÏßÄ ÏïäÍ≥† Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        return;
                    }
                }
                
                if (confirm('ÌòÑÏû¨ ÏÑ∏ÏÖòÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    // Firebase ÏÑ∏ÏÖò Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                    if (database && currentSessionId) {
                        database.ref(`sessions/${currentSessionId}`).remove();
                    }
                    
                    // localStorage Ï†ïÎ¶¨
                    localStorage.removeItem('currentSessionId');
                    
                    // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                    setCurrentSessionId(null);
                    setInviteLink('');
                    setIsSavedToDrive(false);
                    setLastSavedTime(null);
                    
                    // Í∏∞Î≥∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
                    window.location.href = window.location.pathname;
                }
            };

            const handleSaveOpinion = (coverageItem, newOpinion) => {
                setOpinions({
                    ...opinions,
                    [coverageItem]: newOpinion
                });
                setEditingOpinion(null);
            };

            const handleResetOpinion = (coverageItem) => {
                const result = analysisResults.find(r => r.coverageItem === coverageItem);
                if (result) {
                    setOpinions({
                        ...opinions,
                        [coverageItem]: result.opinion
                    });
                }
            };

            const insertPhrase = (phrase) => {
                if (editingOpinion) {
                    const currentText = opinions[editingOpinion] || '';
                    setOpinions({
                        ...opinions,
                        [editingOpinion]: currentText + '\n' + phrase
                    });
                }
            };

            const adequateCount = (analysisResults || []).filter(r => r.status === 'adequate').length;
            const recommendCount = (analysisResults || []).filter(r => r.status === 'recommend').length;
            const insufficientCount = (analysisResults || []).filter(r => r.status === 'insufficient').length;
            const noneCount = (analysisResults || []).filter(r => r.status === 'none').length;
            const overallRate = (analysisResults || []).length > 0 ? Math.round((analysisResults || []).reduce((sum, r) => sum + r.coverageRate, 0) / (analysisResults || []).length) : 0;

            // Í≥†Í∞ù Î™©Î°ù ÌôîÎ©¥
            if (currentScreen === 'customerList') {
                return (
                    <div className="app">
                        <div className="app-header">
                            <div className="header-left">
                                <h1>üè• FMA System</h1>
                            </div>
                            <div className="header-right">
                                {consultant && (
                                    <span className="customer-badge">
                                        {consultant.name} {consultant.jobTitle === 'ÏßÅÏ†ëÏûÖÎ†•' ? consultant.customJobTitle : consultant.jobTitle}
                                    </span>
                                )}
                                <button 
                                    className="btn btn-secondary btn-sm" 
                                    onClick={() => window.location.href = 'index.html'}
                                    style={{display: 'flex', alignItems: 'center', gap: '0.25rem'}}
                                >
                                    ‚Üê Main
                                </button>
                            </div>
                        </div>

                        <div className="app-main">
                            <CustomerListScreen 
                                savedSessions={savedSessions}
                                onSelect={loadSession}
                                onNew={startNewAnalysis}
                                onRefresh={loadSavedSessions}
                            />
                        </div>

                        {showConsultantModal && (
                            <ConsultantProfileModal
                                consultant={consultant}
                                onSave={(profile) => {
                                    setConsultant(profile);
                                    setShowConsultantModal(false);
                                }}
                                onClose={() => setShowConsultantModal(false)}
                            />
                        )}

                        {loading && (
                            <div className="loading-overlay">
                                <div className="loading-spinner"></div>
                                <p>Ï≤òÎ¶¨ Ï§ë...</p>
                            </div>
                        )}
                    </div>
                );
            }

            // Î∂ÑÏÑù ÌôîÎ©¥
            return (
                <div className="app">
                    <div className="app-header">
                        <div className="header-left">
                            <h1>üè• FMA System</h1>
                            {customer.name && (
                                <span className="customer-badge">
                                    Í≥†Í∞ù: {customer.name} ({customer.age}ÏÑ∏, {customer.gender})
                                </span>
                            )}
                        </div>
                        <div className="header-right">
                            {consultant && (
                                <span className="customer-badge">
                                    {consultant.name} {consultant.jobTitle === 'ÏßÅÏ†ëÏûÖÎ†•' ? consultant.customJobTitle : consultant.jobTitle}
                                </span>
                            )}
                            {!isCustomerMode && currentSessionId && (
                                <span className="customer-badge" style={{ 
                                    background: isSavedToDrive ? '#10b981' : '#f59e0b',
                                    color: 'white'
                                }}>
                                    {isSavedToDrive ? '‚úÖ Ï†ÄÏû•Îê®' : '‚ö†Ô∏è ÎØ∏Ï†ÄÏû•'}
                                    {lastSavedTime && (
                                        <span style={{ fontSize: '0.75rem', marginLeft: '0.5rem' }}>
                                            ({lastSavedTime.toLocaleTimeString('ko-KR')})
                                        </span>
                                    )}
                                </span>
                            )}
                            {!isCustomerMode && (
                                <>
                                    <button className="btn btn-secondary btn-sm" onClick={() => setCurrentScreen('customerList')}>
                                        üìÇ Î∂àÎü¨Ïò§Í∏∞
                                    </button>
                                    {currentSessionId && (
                                        <button className="btn btn-danger btn-sm" onClick={endSession}>
                                            üö™ ÏÑ∏ÏÖò Ï¢ÖÎ£å
                                        </button>
                                    )}
                                    <button className="btn btn-secondary btn-sm" onClick={() => setCurrentScreen('customerList')}>
                                        ‚Üê Í≥†Í∞ù Î™©Î°ù
                                    </button>
                                    <button 
                                        className="btn btn-secondary btn-sm" 
                                        onClick={() => window.location.href = 'index.html'}
                                        style={{display: 'flex', alignItems: 'center', gap: '0.25rem'}}
                                    >
                                        ‚Üê Main
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="tab-navigation">
                        <button className={currentTab === 'input' ? 'active' : ''} onClick={() => setCurrentTab('input')}>
                            üìù Î≥¥Ìóò ÏûÖÎ†•
                        </button>
                        {!isCustomerMode && (
                            <>
                                <button 
                                    className={currentTab === 'analysis' ? 'active' : ''} 
                                    onClick={() => setCurrentTab('analysis')}
                                    disabled={!analysisResults || analysisResults.length === 0}
                                >
                                    üìä Î∂ÑÏÑù Í≤∞Í≥º
                                </button>
                                <button 
                                    className={currentTab === 'report' ? 'active' : ''} 
                                    onClick={() => setCurrentTab('report')}
                                    disabled={!analysisResults || analysisResults.length === 0}
                                >
                                    üìù Î¶¨Ìè¨Ìä∏ ÏûëÏÑ±
                                </button>
                            </>
                        )}
                    </div>

                    <div className="app-main">
                        {currentTab === 'input' && (
                            <>
                                {/* Ïª®ÏÑ§ÌÑ¥Ìä∏ Ï†ÑÏö©: Í≥†Í∞ù Ï¥àÎåÄ ÎßÅÌÅ¨ */}
                                {!isCustomerMode && database && (
                                    <div className="invite-link-box">
                                        <h3>üîó Í≥†Í∞ù Ï¥àÎåÄ ÎßÅÌÅ¨</h3>
                                        {inviteLink ? (
                                            <>
                                                <div className="invite-link-container">
                                                    <input 
                                                        type="text" 
                                                        className="invite-link-input" 
                                                        value={inviteLink} 
                                                        readOnly 
                                                    />
                                                    <button className="btn btn-success btn-sm" onClick={copyInviteLink}>
                                                        üìã Î≥µÏÇ¨
                                                    </button>
                                                </div>
                                                <p style={{marginTop: '1rem', fontSize: '0.9rem'}}>
                                                    Ïù¥ ÎßÅÌÅ¨Î•º Í≥†Í∞ùÏóêÍ≤å Ï†ÑÏÜ°ÌïòÎ©¥ Í≥†Í∞ùÏù¥ ÏßÅÏ†ë Î≥¥Ìóò Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                                                </p>
                                                <div className="sync-indicator">
                                                    <div className="sync-dot"></div>
                                                    Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Ï§ë
                                                </div>
                                            </>
                                        ) : (
                                            <button className="btn btn-primary" onClick={generateInviteLink}>
                                                Ï¥àÎåÄ ÎßÅÌÅ¨ ÏÉùÏÑ±
                                            </button>
                                        )}
                                    </div>
                                )}

                                {/* Í≥†Í∞ù Î™®Îìú ÏïàÎÇ¥ */}
                                {isCustomerMode && (
                                    <div className="invite-link-box">
                                        <h3>üëã ÌôòÏòÅÌï©ÎãàÎã§!</h3>
                                        <p>Î≥¥Ìóò Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÏãúÎ©¥ Ïª®ÏÑ§ÌÑ¥Ìä∏ÏóêÍ≤å Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ï†ÑÏÜ°Îê©ÎãàÎã§.</p>
                                        <div className="sync-indicator">
                                            <div className="sync-dot"></div>
                                            {syncStatus}
                                        </div>
                                    </div>
                                )}

                                <div className="form-section">
                                    <h2>üë§ Í≥†Í∞ù Ï†ïÎ≥¥ ÏûÖÎ†•</h2>
                                    
                                    {/* 1Ìñâ: Ïù¥Î¶Ñ, ÎÇòÏù¥, ÏÑ±Î≥Ñ, ÏßÅÏóÖ */}
                                    <div className="customer-info-row">
                                        <div className="form-group compact">
                                            <label>Ïù¥Î¶Ñ *</label>
                                            <input
                                                type="text"
                                                value={customer.name}
                                                onChange={(e) => setCustomer({...customer, name: e.target.value})}
                                                placeholder="Ïòà) ÍπÄÏòÅÌù¨"
                                            />
                                        </div>
                                        <div className="form-group compact">
                                            <label>ÎÇòÏù¥ *</label>
                                            <input
                                                type="number"
                                                value={customer.age === '' ? '' : customer.age}
                                                onChange={(e) => {
                                                    const value = e.target.value;
                                                    setCustomer({
                                                        ...customer, 
                                                        age: value === '' ? '' : parseInt(value) || ''
                                                    });
                                                }}
                                                placeholder="ÎÇòÏù¥ ÏûÖÎ†•"
                                                min="1"
                                                max="120"
                                            />
                                        </div>
                                        <div className="form-group compact">
                                            <label>ÏÑ±Î≥Ñ *</label>
                                            <select value={customer.gender} onChange={(e) => setCustomer({...customer, gender: e.target.value})}>
                                                <option value="ÎÇ®ÏÑ±">ÎÇ®ÏÑ±</option>
                                                <option value="Ïó¨ÏÑ±">Ïó¨ÏÑ±</option>
                                            </select>
                                        </div>
                                        <div className="form-group compact">
                                            <label>ÏßÅÏóÖ</label>
                                            <input
                                                type="text"
                                                value={customer.occupation}
                                                onChange={(e) => setCustomer({...customer, occupation: e.target.value})}
                                                placeholder="Ïòà) ÏûêÏòÅÏóÖ"
                                            />
                                        </div>
                                    </div>

                                    {/* 2Ìñâ: Ïó∞ÏÜåÎìù, Î∞∞Ïö∞Ïûê Ï≤¥ÌÅ¨ */}
                                    <div className="customer-info-row">
                                        <div className="form-group compact wide">
                                            <label>Ïó∞ÏÜåÎìù (Ïõê)</label>
                                            <input
                                                type="text"
                                                value={formatNumber(customer.annualIncome)}
                                                onChange={(e) => {
                                                    const value = e.target.value.replace(/,/g, '');
                                                    setCustomer({
                                                        ...customer, 
                                                        annualIncome: value === '' ? '' : parseInt(value) || ''
                                                    });
                                                }}
                                                placeholder="Ïó∞ÏÜåÎìù ÏûÖÎ†• (Ïòà: 60,000,000)"
                                            />
                                        </div>
                                        <div className="form-group compact checkbox-group">
                                            <label>
                                                <input
                                                    type="checkbox"
                                                    checked={customer.hasSpouse}
                                                    onChange={(e) => {
                                                        const isChecked = e.target.checked;
                                                        const updatedCustomer = {
                                                            ...customer, 
                                                            hasSpouse: isChecked,
                                                            spouse: customer.spouse || { name: '', birthDate: '' },
                                                            children: customer.children || [
                                                                { id: 1, name: '', birthDate: '' },
                                                                { id: 2, name: '', birthDate: '' }
                                                            ]
                                                        };
                                                        setCustomer(updatedCustomer);
                                                        
                                                        // Ï¶âÏãú Firebase ÏóÖÎç∞Ïù¥Ìä∏
                                                        if (database && currentSessionId) {
                                                            // ÏßßÍ≤å ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï (Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏ Î∞©Ìï¥ Î∞©ÏßÄ)
                                                            isTypingRef.current = true;
                                                            
                                                            database.ref(`sessions/${currentSessionId}`).update({
                                                                customer: updatedCustomer,
                                                                insurances,
                                                                consultant,
                                                                analysisResults,
                                                                summary,
                                                                opinions,
                                                                updatedAt: Date.now()
                                                            });
                                                            setSyncStatus('ÎèôÍ∏∞ÌôîÎê® ‚úì');
                                                            
                                                            // 200ms ÌõÑ ÌÉÄÏù¥Ìïë ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                                                            setTimeout(() => {
                                                                isTypingRef.current = false;
                                                            }, 200);
                                                        }
                                                    }}
                                                    style={{marginRight: '0.5rem', flexShrink: 0}}
                                                />
                                                Î∞∞Ïö∞Ïûê
                                            </label>
                                        </div>
                                    </div>

                                    {/* Î∞∞Ïö∞Ïûê Ï†ïÎ≥¥ ÏûÖÎ†•ÎûÄ (Î∞∞Ïö∞Ïûê Ï≤¥ÌÅ¨ Ïãú ÌëúÏãú) */}
                                    {customer.hasSpouse === true && (
                                        <div style={{marginTop: '1rem', padding: '1rem', background: 'var(--gray-50)', borderRadius: '8px', border: '1px solid var(--gray-200)'}}>
                                            <h3 style={{fontSize: '1rem', marginBottom: '0.75rem', color: 'var(--gray-800)'}}>üíë Î∞∞Ïö∞Ïûê Ï†ïÎ≥¥</h3>
                                            <div className="customer-info-row">
                                                <div className="form-group compact">
                                                    <label>ÏÑ±Î™Ö</label>
                                                    <input
                                                        type="text"
                                                        value={customer.spouse?.name || ''}
                                                        onChange={(e) => setCustomer({
                                                            ...customer,
                                                            spouse: {...(customer.spouse || {}), name: e.target.value}
                                                        })}
                                                        placeholder="Ïòà) Ïù¥Ï≤†Ïàò"
                                                    />
                                                </div>
                                                <div className="form-group compact">
                                                    <label>ÏÉùÎÖÑÏõîÏùº</label>
                                                    <input
                                                        type="date"
                                                        value={customer.spouse?.birthDate || ''}
                                                        onChange={(e) => setCustomer({
                                                            ...customer,
                                                            spouse: {...(customer.spouse || {}), birthDate: e.target.value}
                                                        })}
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* ÏûêÎÖÄ Ï†ïÎ≥¥ ÏûÖÎ†•ÎûÄ (Î∞∞Ïö∞Ïûê Ï≤¥ÌÅ¨ Ïãú ÌëúÏãú) */}
                                    {customer.hasSpouse === true && (
                                        <div style={{marginTop: '1rem', padding: '1rem', background: 'var(--gray-50)', borderRadius: '8px', border: '1px solid var(--gray-200)'}}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem'}}>
                                                <h3 style={{fontSize: '1rem', margin: 0, color: 'var(--gray-800)'}}>üë∂ ÏûêÎÖÄ Ï†ïÎ≥¥</h3>
                                                <button 
                                                    className="btn btn-secondary btn-sm"
                                                    onClick={() => {
                                                        const newChild = {
                                                            id: Date.now(),
                                                            name: '',
                                                            birthDate: ''
                                                        };
                                                        setCustomer({
                                                            ...customer,
                                                            children: [...(customer.children || []), newChild]
                                                        });
                                                    }}
                                                >
                                                    + ÏûêÎÖÄ Ï∂îÍ∞Ä
                                                </button>
                                            </div>
                                            {(customer.children || []).map((child, index) => (
                                                <div key={child.id} style={{marginBottom: '0.75rem'}}>
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem'}}>
                                                        <span style={{fontSize: '0.875rem', color: 'var(--gray-600)', fontWeight: '500'}}>
                                                            ÏûêÎÖÄ {index + 1}
                                                        </span>
                                                        {(customer.children || []).length > 2 && (
                                                            <button
                                                                onClick={() => {
                                                                    setCustomer({
                                                                        ...customer,
                                                                        children: (customer.children || []).filter(c => c.id !== child.id)
                                                                    });
                                                                }}
                                                                style={{
                                                                    background: 'none',
                                                                    border: 'none',
                                                                    cursor: 'pointer',
                                                                    color: 'var(--danger-color)',
                                                                    fontSize: '0.875rem'
                                                                }}
                                                            >
                                                                ‚ùå ÏÇ≠Ï†ú
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div className="customer-info-row">
                                                        <div className="form-group compact">
                                                            <label>ÏÑ±Î™Ö</label>
                                                            <input
                                                                type="text"
                                                                value={child.name || ''}
                                                                onChange={(e) => {
                                                                    setCustomer({
                                                                        ...customer,
                                                                        children: (customer.children || []).map(c =>
                                                                            c.id === child.id ? {...c, name: e.target.value} : c
                                                                        )
                                                                    });
                                                                }}
                                                                placeholder="Ïòà) ÍπÄÎØºÏ§Ä"
                                                            />
                                                        </div>
                                                        <div className="form-group compact">
                                                            <label>ÏÉùÎÖÑÏõîÏùº</label>
                                                            <input
                                                                type="date"
                                                                value={child.birthDate || ''}
                                                                onChange={(e) => {
                                                                    setCustomer({
                                                                        ...customer,
                                                                        children: (customer.children || []).map(c =>
                                                                            c.id === child.id ? {...c, birthDate: e.target.value} : c
                                                                        )
                                                                    });
                                                                }}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="form-section">
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
                                        <h2>üìã Í∞ÄÏûÖ Î≥¥Ìóò Î™©Î°ù</h2>
                                        <button className="btn btn-primary" onClick={addInsurance}>
                                            + Î≥¥Ìóò Ï∂îÍ∞Ä
                                        </button>
                                    </div>

                                    {!insurances || insurances.length === 0 ? (
                                        <div className="empty-state">
                                            <p>Îì±Î°ùÎêú Î≥¥ÌóòÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                                            <p className="hint">ÏúÑÏùò "Î≥¥Ìóò Ï∂îÍ∞Ä" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî.</p>
                                        </div>
                                    ) : (
                                        <div className="insurance-list">
                                            {insurances.map((insurance, idx) => (
                                                <div key={insurance.id} className="insurance-card">
                                                    <div className="insurance-header">
                                                        <h3>Î≥¥Ìóò {idx + 1}</h3>
                                                        <button 
                                                            className="btn btn-danger btn-sm"
                                                            onClick={() => removeInsurance(insurance.id)}
                                                        >
                                                            ÏÇ≠Ï†ú
                                                        </button>
                                                    </div>

                                                    <div className="insurance-info">
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>Î≥¥ÌóòÏÇ¨ *</label>
                                                            <input
                                                                type="text"
                                                                className="input-medium"
                                                                value={insurance.company}
                                                                onChange={(e) => updateInsurance(insurance.id, 'company', e.target.value)}
                                                                placeholder="Ïòà) ÏÇºÏÑ±ÏÉùÎ™Ö"
                                                            />
                                                        </div>
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>ÏÉÅÌíàÎ™Ö *</label>
                                                            <input
                                                                type="text"
                                                                className="input-long"
                                                                value={insurance.productName}
                                                                onChange={(e) => updateInsurance(insurance.id, 'productName', e.target.value)}
                                                                placeholder="Ïòà) Î¨¥Î∞∞Îãπ Ï¢ÖÏã†Î≥¥Ìóò"
                                                            />
                                                        </div>
                                                    </div>

                                                    <div className="insurance-info">
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>Ïõî Î≥¥ÌóòÎ£å (Ïõê)</label>
                                                            <input
                                                                type="text"
                                                                className="input-number"
                                                                value={formatNumber(insurance.monthlyPremium)}
                                                                onChange={(e) => {
                                                                    const value = e.target.value.replace(/,/g, '');
                                                                    updateInsurance(insurance.id, 'monthlyPremium', value === '' ? '' : parseInt(value) || '');
                                                                }}
                                                                placeholder="Ïõî Î≥¥ÌóòÎ£å ÏûÖÎ†• (Ïòà: 150,000)"
                                                            />
                                                        </div>
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>Í∞ÄÏûÖÏùº</label>
                                                            <input
                                                                type="date"
                                                                className="input-medium"
                                                                value={insurance.startDate}
                                                                onChange={(e) => updateInsurance(insurance.id, 'startDate', e.target.value)}
                                                            />
                                                        </div>
                                                        <div className="form-group" style={{margin: 0}}>
                                                            <label>ÎßåÍ∏∞Ïùº</label>
                                                            <input
                                                                type="date"
                                                                className="input-medium"
                                                                value={insurance.endDate}
                                                                onChange={(e) => updateInsurance(insurance.id, 'endDate', e.target.value)}
                                                            />
                                                        </div>
                                                    </div>

                                                    {/* Ï¥ùÎÇ©ÏûÖÎ≥¥ÌóòÎ£å ÌëúÏãú */}
                                                    {insurance.startDate && insurance.monthlyPremium > 0 && (
                                                        <div className="total-premium-display">
                                                            <div>
                                                                üìä ÎÇ©ÏûÖ Ï†ïÎ≥¥: {calculateMonthsElapsed(insurance.startDate)}Í∞úÏõî Í≤ΩÍ≥º
                                                            </div>
                                                            <div style={{marginTop: '0.5rem'}}>
                                                                <strong>Ï¥ù ÎÇ©ÏûÖÎ≥¥ÌóòÎ£å: {formatAmountKorean(calculateTotalPremium(insurance.startDate, insurance.monthlyPremium))}</strong>
                                                            </div>
                                                        </div>
                                                    )}

                                                    <div className="insurance-coverages">
                                                        <div className="coverages-header">
                                                            <h4 style={{margin: 0}}>üí∞ Î≥¥Ïû• ÎÇ¥Ïó≠</h4>
                                                            <button 
                                                                className="btn btn-secondary btn-sm"
                                                                onClick={() => setShowCoverageModal(insurance.id)}
                                                            >
                                                                + Î≥¥Ïû• Ìï≠Î™© Ï∂îÍ∞Ä
                                                            </button>
                                                        </div>

                                                        {!insurance.coverages || insurance.coverages.length === 0 ? (
                                                            <p className="hint">Î≥¥Ïû• Ìï≠Î™©ÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.</p>
                                                        ) : (
                                                            <div className="coverage-list">
                                                                {insurance.coverages.map((coverage, idx) => (
                                                                    <div key={coverage.id} className="coverage-item">
                                                                        <div className="coverage-info">
                                                                            <span className="coverage-index">{idx + 1}.</span>
                                                                            <span className="coverage-name">{coverage.name}</span>
                                                                            <input
                                                                                type="text"
                                                                                className="coverage-amount"
                                                                                value={formatNumber(coverage.amount)}
                                                                                onChange={(e) => {
                                                                                    const value = e.target.value.replace(/,/g, '');
                                                                                    updateCoverage(insurance.id, coverage.id, value === '' ? '' : parseInt(value) || '');
                                                                                }}
                                                                                placeholder="Í∏àÏï° ÏûÖÎ†•"
                                                                                style={{padding: '0.5rem', border: '1px solid var(--gray-300)', borderRadius: '0.25rem'}}
                                                                            />
                                                                            <span className="coverage-unit">Ïõê üí°</span>
                                                                        </div>
                                                                        <button
                                                                            onClick={() => removeCoverage(insurance.id, coverage.id)}
                                                                            style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: '1rem'}}
                                                                        >
                                                                            ‚ùå
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {!isCustomerMode && (
                                    <div className="action-buttons">
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleSaveToDrive} 
                                            disabled={loading}
                                            style={{
                                                background: isSavedToDrive ? 'var(--success-color)' : 'var(--warning-color)',
                                                borderColor: isSavedToDrive ? 'var(--success-color)' : 'var(--warning-color)'
                                            }}
                                        >
                                            {isSavedToDrive ? '‚úÖ Ï†ÄÏû•ÏôÑÎ£å' : 'üíæ Google Drive Ï†ÄÏû•'}
                                        </button>
                                        <button className="btn btn-primary" onClick={handleStartAnalysis} disabled={loading}>
                                            üìä Î∂ÑÏÑù ÏãúÏûëÌïòÍ∏∞
                                        </button>
                                    </div>
                                )}
                            </>
                        )}

                        {currentTab === 'analysis' && (
                            <div className="form-section analysis-result">
                                <h2>üìä Î≥¥Ïû• Î∂ÑÏÑù ÌòÑÌô©</h2>
                                
                                {/* Before & After ÎπÑÍµê Ïπ¥Îìú */}
                                <div className="before-after-container">
                                    <div className="before-after-card">
                                        <div className="before-after-label">ÌòÑÏû¨ Î≥¥Ïû•</div>
                                        <div className="before-after-value">{overallRate}%</div>
                                        <div className="before-after-desc">
                                            {overallRate >= 75 ? 'ÏñëÌò∏' : overallRate >= 60 ? 'Î≥¥ÏôÑ Í∂åÏû•' : 'Í∞úÏÑ† ÌïÑÏöî'}
                                        </div>
                                    </div>
                                    <div className="arrow-divider">‚Üí</div>
                                    <div className="before-after-card">
                                        <div className="before-after-label">Î™©Ìëú Î≥¥Ïû•</div>
                                        <div className="before-after-value">95%</div>
                                        <div className="before-after-desc">Í∂åÏû• ÏàòÏ§Ä</div>
                                    </div>
                                </div>

                                <div className="stats-summary">
                                    <div className="stat-item">
                                        <div className="stat-label">‚úÖ Ï†ÅÏ†ï</div>
                                        <div className="stat-value success">{adequateCount}Í±¥</div>
                                    </div>
                                    <div className="stat-item">
                                        <div className="stat-label">üü° Î≥¥ÏôÑ Í∂åÏû•</div>
                                        <div className="stat-value warning">{recommendCount}Í±¥</div>
                                    </div>
                                    <div className="stat-item">
                                        <div className="stat-label">‚ö†Ô∏è Î∂ÄÏ°±</div>
                                        <div className="stat-value danger">{insufficientCount}Í±¥</div>
                                    </div>
                                    <div className="stat-item">
                                        <div className="stat-label">‚ùå ÏóÜÏùå</div>
                                        <div className="stat-value">{noneCount}Í±¥</div>
                                    </div>
                                </div>

                                <hr style={{margin: '2rem 0', border: 'none', borderTop: '1px solid var(--gray-200)'}} />

                                <div className="charts-grid">
                                    <div className="chart-card">
                                        <h3>üìä ÌòÑÏû¨ vs Í∂åÏû• Î≥¥Ïû• ÎπÑÍµê</h3>
                                        <div style={{height: '300px'}}>
                                            <canvas ref={comparisonChartRef}></canvas>
                                        </div>
                                    </div>
                                    <div className="chart-card">
                                        <h3>üìà Î≥¥Ïû• ÏÉÅÌÉú Î∂ÑÌè¨</h3>
                                        <div style={{height: '300px'}}>
                                            <canvas ref={categoryChartRef}></canvas>
                                        </div>
                                    </div>
                                    <div className="chart-card">
                                        <h3>üéØ Î≥¥Ïû• Í∑†ÌòïÎèÑ (Î†àÏù¥Îçî)</h3>
                                        <div style={{height: '300px'}}>
                                            <canvas ref={radarChartRef}></canvas>
                                        </div>
                                    </div>
                                    <div className="chart-card">
                                        <h3>üí∞ Î≥¥ÌóòÎ£å Î∂ÑÎ∞∞</h3>
                                        <div style={{height: '300px'}}>
                                            <canvas ref={premiumChartRef}></canvas>
                                        </div>
                                    </div>
                                </div>

                                <hr style={{margin: '2rem 0', border: 'none', borderTop: '1px solid var(--gray-200)'}} />

                                <h3 style={{marginBottom: '1rem'}}>üìã ÏÉÅÏÑ∏ Î≥¥Ïû• Î∂ÑÏÑùÌëú</h3>
                                <div style={{overflowX: 'auto'}}>
                                    <table className="analysis-table">
                                        <thead>
                                            <tr>
                                                <th>Ìï≠Î™©</th>
                                                <th>ÌòÑÏû¨ Î≥¥Ïû•</th>
                                                <th>Í∂åÏû• Î≥¥Ïû•</th>
                                                <th>Î≥¥Ïû•Î•†</th>
                                                <th>ÏßÑÎã®</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(analysisResults || []).map((result, idx) => (
                                                <tr key={idx}>
                                                    <td>{result.coverageItem}</td>
                                                    <td>{formatAmountKorean(result.currentAmount)}</td>
                                                    <td>{formatAmountKorean(result.recommendedAmount)}</td>
                                                    <td>{Math.round(result.coverageRate)}%</td>
                                                    <td>
                                                        <span 
                                                            className="status-badge"
                                                            style={{backgroundColor: getStatusColor(result.status)}}
                                                        >
                                                            {getStatusText(result.status)}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                <div className="action-buttons">
                                    <button className="btn btn-primary" onClick={() => setCurrentTab('report')}>
                                        Îã§Ïùå: Î¶¨Ìè¨Ìä∏ ÏûëÏÑ± ‚Üí
                                    </button>
                                </div>
                            </div>
                        )}

                        {currentTab === 'report' && (
                            <>
                                <div className="report-section">
                                    <h2>üìù Ìï≠Î™©Î≥Ñ Î≥¥Ïû•Î∂ÑÏÑù ÏùòÍ≤¨</h2>
                                    <p className="hint" style={{marginBottom: '2rem'}}>
                                        Í∞Å Î≥¥Ïû• Ìï≠Î™©Ïóê ÎåÄÌïú ÏùòÍ≤¨ÏùÑ ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§. ÏûêÎèô ÏÉùÏÑ±Îêú ÌÖúÌîåÎ¶øÏùÑ Í≥†Í∞ù ÏÉÅÌô©Ïóê ÎßûÍ≤å ÏàòÏ†ïÌïòÏÑ∏Ïöî.
                                    </p>

                                    {(analysisResults || []).filter(r => r.status !== 'adequate').slice(0, 10).map((result, idx) => (
                                        <div key={idx} className="opinion-card">
                                            <div className="opinion-header">
                                                <div>
                                                    <div className="opinion-title">
                                                        {result.coverageItem}
                                                        <span 
                                                            className="status-badge"
                                                            style={{backgroundColor: getStatusColor(result.status), marginLeft: '1rem'}}
                                                        >
                                                            {getStatusText(result.status)}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="opinion-stats">
                                                <div>ÌòÑÏû¨: {formatAmountKorean(result.currentAmount)}</div>
                                                <div>Í∂åÏû•: {formatAmountKorean(result.recommendedAmount)}</div>
                                                <div>Î≥¥Ïû•Î•†: {Math.round(result.coverageRate)}%</div>
                                            </div>

                                            {editingOpinion === result.coverageItem ? (
                                                <>
                                                    <textarea
                                                        value={opinions[result.coverageItem] || result.opinion}
                                                        onChange={(e) => setOpinions({
                                                            ...opinions,
                                                            [result.coverageItem]: e.target.value
                                                        })}
                                                        style={{
                                                            width: '100%',
                                                            minHeight: '150px',
                                                            padding: '1rem',
                                                            border: '1px solid var(--gray-300)',
                                                            borderRadius: '0.5rem',
                                                            fontFamily: 'inherit',
                                                            fontSize: '0.95rem',
                                                            lineHeight: '1.6',
                                                            marginBottom: '1rem'
                                                        }}
                                                    />
                                                    
                                                    <div className="phrase-library">
                                                        <h4>üí¨ ÏûêÏ£º Ïì∞Îäî Î¨∏Íµ¨ (ÌÅ¥Î¶≠ÌïòÏó¨ Ï∂îÍ∞Ä)</h4>
                                                        <div className="phrase-buttons">
                                                            {Object.values(PHRASE_LIBRARY).flat().map((phrase, i) => (
                                                                <button key={i} onClick={() => insertPhrase(phrase)}>
                                                                    {phrase}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    <div className="opinion-actions">
                                                        <button 
                                                            className="btn btn-secondary btn-sm"
                                                            onClick={() => handleResetOpinion(result.coverageItem)}
                                                        >
                                                            üîÑ Í∏∞Î≥∏ ÌÖúÌîåÎ¶øÏúºÎ°ú
                                                        </button>
                                                        <button 
                                                            className="btn btn-primary btn-sm"
                                                            onClick={() => handleSaveOpinion(result.coverageItem, opinions[result.coverageItem])}
                                                        >
                                                            üíæ Ï†ÄÏû•
                                                        </button>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="opinion-content">
                                                        {opinions[result.coverageItem] || result.opinion}
                                                    </div>
                                                    <div className="opinion-actions">
                                                        <button 
                                                            className="btn btn-secondary btn-sm"
                                                            onClick={() => setEditingOpinion(result.coverageItem)}
                                                        >
                                                            ‚úèÔ∏è ÏàòÏ†ïÌïòÍ∏∞
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                <div className="report-section">
                                    <h2>üìù Ï¢ÖÌï© Ï¥ùÌèâ</h2>
                                    <textarea
                                        value={summary}
                                        onChange={(e) => setSummary(e.target.value)}
                                        placeholder="Ï¢ÖÌï© ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                        style={{
                                            width: '100%',
                                            minHeight: '250px',
                                            padding: '1rem',
                                            border: '1px solid var(--gray-300)',
                                            borderRadius: '0.5rem',
                                            fontFamily: 'inherit',
                                            fontSize: '0.95rem',
                                            lineHeight: '1.6',
                                            marginBottom: '1rem'
                                        }}
                                    />
                                    <p className="hint">ÏûêÎèô ÏÉùÏÑ±Îêú Ï¢ÖÌï© ÏùòÍ≤¨ÏùÑ ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§. Í≥†Í∞ùÎ≥ÑÎ°ú ÎßûÏ∂§ÌôîÌïòÏÑ∏Ïöî.</p>

                                    <div className="action-buttons">
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleSaveToDrive} 
                                            disabled={loading}
                                            style={{
                                                background: isSavedToDrive ? 'var(--success-color)' : 'var(--warning-color)',
                                                borderColor: isSavedToDrive ? 'var(--success-color)' : 'var(--warning-color)'
                                            }}
                                        >
                                            {isSavedToDrive ? '‚úÖ Ï†ÄÏû•ÏôÑÎ£å' : 'üíæ Google Drive Ï†ÄÏû•'}
                                        </button>
                                        <button className="btn btn-success" onClick={handleGeneratePDF} disabled={loading}>
                                            üìÑ PDF Î¶¨Ìè¨Ìä∏ Îã§Ïö¥Î°úÎìú
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    {showCoverageModal && (
                        <CoverageAddModal
                            onClose={() => setShowCoverageModal(null)}
                            onAdd={(coverageName) => {
                                addCoverage(showCoverageModal, coverageName);
                                setShowCoverageModal(null);
                            }}
                        />
                    )}

                    {showConsultantModal && (
                        <ConsultantProfileModal
                            consultant={consultant}
                            onSave={(profile) => {
                                setConsultant(profile);
                                setShowConsultantModal(false);
                                if (!analysisResults.length) {
                                    setTimeout(handleStartAnalysis, 100);
                                }
                            }}
                            onClose={() => setShowConsultantModal(false)}
                        />
                    )}

                    {loading && (
                        <div className="loading-overlay">
                            <div className="loading-spinner"></div>
                            <p>Ï≤òÎ¶¨ Ï§ë...</p>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
