<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê¸°ì—… ì§€ì›ì‚¬ì—… AI ë§¤ì¹­ - KFPC</title>
  
  <!-- CryptoJS for AES-256 encryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
  
  <!-- INNOPAY PG SDK -->
  <script src="https://pg.innopay.co.kr/ipay/js/jquery-2.1.4.min.js"></script>
  <script src="https://pg.innopay.co.kr/ipay/js/innopay-2.0.js"></script>
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      color: #fff;
      min-height: 100vh;
      -webkit-overflow-scrolling: touch;
      font-size: 14px;
    }
    
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s;
    }
    
    .loading-screen.hide {
      opacity: 0;
      pointer-events: none;
    }
    
    .loader {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #FF8802;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 0.75rem;
      font-size: 0.95rem;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0.75rem;
    }
    
    .btn-main {
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .btn-main.btn-small {
      padding: 0.35rem 0.5rem;
      font-size: 0.6rem;
    }
    
    .btn-main:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .header-left {
      position: static;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    
    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding: 0.8rem 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .header h1 {
      font-size: 1.1rem;
      margin: 0;
      flex: 1;
      text-align: center;
      min-width: 200px;
    }
    
    .header .btn-main {
      flex-shrink: 0;
    }
    
    /* ëª¨ë°”ì¼ í—¤ë” */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .header-left {
        order: 2;
        justify-content: center;
        width: 100%;
      }
      
      .header h1 {
        order: 1;
        font-size: 1rem;
        text-align: center;
      }
      
      .header > .btn-main {
        order: 3;
        width: 100%;
        text-align: center;
      }
    }
    
    /* ì£¼ë ¥ì œí’ˆ ê·¸ë¦¬ë“œ */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.3rem;
    }
    
    .product-grid input {
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.95);
      color: #333;
      font-size: 12px;
    }
    
    @media (min-width: 600px) {
      .product-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* ë¯¸ë‹ˆ ë²„íŠ¼ */
    .btn-mini {
      padding: 0.4rem 0.5rem;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.15);
      color: white;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn-mini:hover {
      background: rgba(255,255,255,0.25);
    }
    
    /* ì†ì‹¤ ì²´í¬ë°•ìŠ¤ */
    .loss-checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      cursor: pointer;
      user-select: none;
    }
    
    .loss-checkbox-label input {
      display: none;
    }
    
    .loss-checkbox-box {
      width: 20px;
      height: 20px;
      border: 2px solid #ff6b6b;
      border-radius: 4px;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: transparent;
      transition: all 0.2s;
    }
    
    .loss-checkbox-label input:checked + .loss-checkbox-box {
      background: #ff6b6b;
      color: white;
    }
    
    .loss-checkbox-text {
      font-size: 0.7rem;
      color: #ff6b6b;
      font-weight: 600;
    }
    
    .required-notice {
      background: rgba(255, 136, 2, 0.2);
      border: 1px solid #FF8802;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.75rem;
      text-align: center;
      font-size: 0.8rem;
    }
    
    .required-notice strong {
      color: #FFD700;
      font-size: 0.85rem;
    }
    
    .btn {
      padding: 0.6rem 1rem;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 40px;
      user-select: none;
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FF9933 0%, #FF8020 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(255,136,2,0.25);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.15);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    /* ì»´íŒ©íŠ¸ ì¹´ë“œ */
    .card {
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .card h2 {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      color: #ffd27f;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .section-info-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: rgba(255, 210, 127, 0.2);
      border: 1px solid #ffd27f;
      border-radius: 50%;
      font-size: 0.7rem;
      font-weight: 700;
      color: #ffd27f;
      cursor: help;
      flex-shrink: 0;
    }
    
    .section-info-tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      left: 25px;
      top: -8px;
      background: rgba(20, 40, 70, 0.98);
      color: #fff;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 400;
      line-height: 1.4;
      white-space: nowrap;
      z-index: 1000;
      border: 1px solid rgba(255, 210, 127, 0.3);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      pointer-events: none;
    }
    
    .section-info-tooltip::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: transparent rgba(20, 40, 70, 0.98) transparent transparent;
    }
    
    .section-info-icon:hover .section-info-tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    .card h3 {
      font-size: 0.85rem;
      margin: 0.6rem 0 0.4rem 0;
      color: #ffd27f;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    /* ì»´íŒ©íŠ¸ í¼ ê·¸ë¦¬ë“œ - ëª¨ë°”ì¼ì—ì„œë„ 2ì—´ */
    .form-grid {
      display: grid;
      gap: 0.4rem;
      grid-template-columns: repeat(2, 1fr);
    }
    
    .form-grid .full-width {
      grid-column: 1 / -1;
    }
    
    @media (min-width: 600px) {
      .form-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (min-width: 900px) {
      .form-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (min-width: 1200px) {
      .form-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }
    
    /* ì»´íŒ©íŠ¸ í¼ ê·¸ë£¹ */
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-size: 0.72rem;
      font-weight: 600;
      margin-bottom: 0.15rem;
      color: #ffd27f;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .required {
      color: #FF8802;
      font-weight: 700;
    }
    
    /* ì»´íŒ©íŠ¸ ì¸í’‹ */
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.45rem 0.5rem;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.95);
      color: #333;
      font-size: 13px;
      -webkit-appearance: none;
      appearance: none;
      min-height: 32px;
    }
    
    .form-group select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      padding-right: 1.8rem;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #FF8802;
      box-shadow: 0 0 0 2px rgba(255, 136, 2, 0.2);
    }
    
    .form-group textarea {
      min-height: 50px;
      resize: vertical;
      font-family: inherit;
    }
    
    /* ì»´íŒ©íŠ¸ ì²´í¬ë°•ìŠ¤ ê·¸ë¦¬ë“œ */
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.3rem;
    }
    
    @media (min-width: 480px) {
      .checkbox-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (min-width: 768px) {
      .checkbox-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 0.35rem 0.5rem;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 32px;
    }
    
    .checkbox-item:active {
      background: rgba(255,255,255,0.2);
    }
    
    .checkbox-item input[type="checkbox"],
    .checkbox-item input[type="radio"] {
      width: 16px;
      height: 16px;
      margin-right: 0.35rem;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255,255,255,0.9);
      border: 1.5px solid rgba(255,255,255,0.5);
      border-radius: 3px;
      position: relative;
      flex-shrink: 0;
    }
    
    .checkbox-item input[type="radio"] {
      border-radius: 50%;
    }
    
    .checkbox-item input:checked {
      background: #FF8802;
      border-color: #FF8802;
    }
    
    .checkbox-item input:checked::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 11px;
      font-weight: bold;
    }
    
    .checkbox-item label {
      font-size: 0.72rem;
      cursor: pointer;
      margin: 0;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(12, 44, 84, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .loading-overlay .loader {
      width: 50px;
      height: 50px;
    }
    
    .loading-overlay h2 {
      margin-top: 1rem;
      font-size: 1.1rem;
    }
    
    .loading-overlay p {
      margin-top: 0.3rem;
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    .result-card {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 10px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .result-card .rank {
      display: inline-block;
      background: linear-gradient(135deg, #FF8802 0%, #FF6B00 100%);
      color: white;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-bottom: 0.4rem;
    }
    
    .result-card h3 {
      font-size: 1rem;
      color: #0c2c54;
      margin-bottom: 0.3rem;
      line-height: 1.3;
      border: none;
      padding: 0;
    }
    
    .match-score {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }
    
    /* ì»´íŒ©íŠ¸ info-text */
    .info-text {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.6);
      margin-top: 0.1rem;
      font-style: italic;
      line-height: 1.2;
    }
    
    /* ëª¨ë°”ì¼ ì¶”ê°€ ìµœì í™” */
    @media (max-width: 479px) {
      .container {
        padding: 0.5rem;
      }
      .header h1 {
        font-size: 1.1rem;
        padding-right: 70px;
      }
      .card {
        padding: 0.5rem;
        border-radius: 8px;
      }
      .card h2 {
        font-size: 0.9rem;
      }
    }
    
    /* PC ìµœì í™” */
    @media (min-width: 1024px) {
      .container {
        padding: 1rem;
      }
      .card {
        padding: 0.85rem;
      }
      .form-grid {
        gap: 0.5rem;
      }
      .form-group label {
        font-size: 0.78rem;
      }
      .form-group input,
      .form-group select {
        padding: 0.5rem 0.6rem;
        font-size: 14px;
        min-height: 36px;
      }
      .checkbox-item {
        padding: 0.45rem 0.6rem;
        min-height: 36px;
      }
      .checkbox-item label {
        font-size: 0.78rem;
      }
    }
    
    /* ë²„íŠ¼ 1í–‰ ê³ ì • */
    button, .btn-primary, .btn-secondary {
      white-space: nowrap !important;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ê³ ê°ì‚¬ ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .company-list-controls {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .search-box input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.95);
      color: #333;
      font-size: 13px;
    }
    
    .sort-buttons {
      display: flex;
      gap: 0.3rem;
    }
    
    .sort-btn {
      flex: 1;
      padding: 0.4rem 0.5rem;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: #fff;
      border-radius: 6px;
      font-size: 0.72rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .sort-btn.active {
      background: #FF8802;
      border-color: #FF8802;
    }
    
    .company-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      background: rgba(0,0,0,0.1);
    }
    
    .company-list-empty {
      padding: 1rem;
      text-align: center;
      color: rgba(255,255,255,0.5);
      font-size: 0.8rem;
    }
    
    .company-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .company-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .company-item.selected {
      background: rgba(255,136,2,0.3);
      border-left: 3px solid #FF8802;
    }
    
    .company-item:last-child {
      border-bottom: none;
    }
    
    .company-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .company-item-name {
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .company-item-meta {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.6);
      margin-top: 0.1rem;
    }
    
    .company-item-date {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.4);
      white-space: nowrap;
    }
    
    .company-action-buttons {
      display: flex;
      gap: 0.3rem;
    }
    
    .company-action-buttons .btn {
      flex: 1;
      font-size: 0.8rem;
      padding: 0.5rem;
    }
    
    @media (min-width: 480px) {
      .company-list-controls {
        flex-direction: row;
        align-items: center;
      }
      .search-box {
        flex: 1;
      }
      .sort-buttons {
        flex: 0 0 auto;
      }
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loading-screen">
    <div class="loader"></div>
    <div class="loading-text" id="loading-text">ì•± ë¡œë”© ì¤‘...</div>
  </div>

  <!-- ì¸ì¦ í™•ì¸ìš© ë¡œë”© í™”ë©´ (ë¡œê·¸ì¸ í™”ë©´ ëŒ€ì‹ ) -->
  <div id="auth-loading-screen" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%); z-index: 9999; align-items: center; justify-content: center; flex-direction: column;">
    <div style="text-align: center;">
      <div style="font-size: 4rem; margin-bottom: 1.5rem; animation: pulse 1.5s infinite;">ğŸ¢</div>
      <h2 style="color: white; margin-bottom: 1rem; font-size: 1.8rem;">ê¸°ì—… ì§€ì›ì‚¬ì—… AI ë§¤ì¹­</h2>
      <div id="auth-status-text" style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 2rem;">
        ì¸ì¦ í™•ì¸ ì¤‘...
      </div>
      <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
    </div>
  </div>
  
  <style>
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- ë¡œê·¸ì¸ í•„ìš” ì‹œ ë¦¬ë””ë ‰ì…˜ ì•ˆë‚´ í™”ë©´ -->
  <div id="login-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 90%;">
      <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ”</div>
      <h2 style="color: #0c2c54; margin-bottom: 0.5rem; font-size: 1.8rem;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
      <p style="color: #666; margin-bottom: 2rem; font-size: 0.95rem;">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
      
      <div style="margin-top: 1rem;">
        <div class="spinner" style="margin: 0 auto 1rem; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0c2c54; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      </div>
      
      <button onclick="window.location.href='login.html'" style="
        margin-top: 1rem;
        padding: 0.8rem 2rem;
        background: #0c2c54;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        color: white;
        cursor: pointer;
      ">
        ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
      </button>
      
      <style>
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    </div>
  </div>

  <!-- ë°ì´í„° ì €ì¥ ì•ˆë‚´ íŒì—… -->
  <div id="storage-notice-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); text-align: center; max-width: 420px; width: 90%; margin: 1rem;">
      <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
      <h2 style="color: #0c2c54; margin-bottom: 1rem; font-size: 1.4rem;">ë°ì´í„° ì €ì¥ ì•ˆë‚´</h2>
      
      <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; text-align: left;">
        <div style="color: #856404; font-size: 0.95rem; line-height: 1.7;">
          <div style="margin-bottom: 0.8rem;">
            <strong>ğŸ“± ê¸°ê¸°ë³„ ì €ì¥</strong><br>
            ë°ì´í„°ëŠ” <u>í˜„ì¬ ê¸°ê¸°/ë¸Œë¼ìš°ì €</u>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
          </div>
          <div style="margin-bottom: 0.8rem;">
            <strong>ğŸ”„ ë‹¤ë¥¸ ê¸°ê¸°</strong><br>
            PC â†” ìŠ¤ë§ˆíŠ¸í° ê°„ ë°ì´í„°ê°€ <u>ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</u>.
          </div>
          <div>
            <strong>ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ ì£¼ì˜</strong><br>
            ë¸Œë¼ìš°ì € ë°ì´í„°/ìºì‹œ ì‚­ì œ ì‹œ <u>ì €ì¥ëœ ì •ë³´ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤</u>.
          </div>
        </div>
      </div>
      
      <button id="storage-notice-confirm" style="
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #0c2c54, #2a5a8a);
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: transform 0.2s;
      " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
        í™•ì¸
      </button>
    </div>
  </div>

  <div class="container" id="main-content" style="display: none;">
    <div class="header">
      <div class="header-left">
        <button id="connection-status-btn" class="btn-main btn-small" style="background: #28a745;">
          <span style="font-size: 0.9rem;">âœ“</span> ë¡œì»¬ì €ì¥
        </button>
        <button class="btn-main btn-small" onclick="signOut()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <h1 style="flex: 1; text-align: center;">ğŸ¢ ê¸°ì—… ì§€ì›ì‚¬ì—… AI ë§¤ì¹­</h1>
      <button class="btn-main btn-small" onclick="goHome()">ë©”ì¸</button>
    </div>

    <div class="required-notice">
      <strong>* í‘œì‹œ í•­ëª©ì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤</strong>
    </div>

    <!-- 1. ê³ ê°ì‚¬ ì„ íƒ -->
    <div class="card">
      <h2>1. ê³ ê°ì‚¬ ê´€ë¦¬</h2>
      
      <div style="background: rgba(255,210,127,0.15); border: 1px solid rgba(255,210,127,0.3); border-radius: 8px; padding: 0.6rem; margin-bottom: 0.6rem;">
        <p style="margin: 0; font-size: 0.8rem; color: rgba(255,255,255,0.9);">
          ğŸ’¡ <strong>ì•ˆë‚´:</strong> ì•„ë˜ì— ì €ì¥ëœ ê³ ê°ì‚¬ëª…ì„ ì„ íƒí•˜ê±°ë‚˜, "ìƒˆë¡œ ì…ë ¥" ë²„íŠ¼ìœ¼ë¡œ ì‹ ê·œ ê³ ê°ì‚¬ë¥¼ ë“±ë¡í•˜ì„¸ìš”.
        </p>
      </div>
      
      <!-- íšŒì‚¬ëª… ì…ë ¥ ë° ë²„íŠ¼ -->
      <div style="display: flex; gap: 0.5rem; margin-bottom: 0.6rem; align-items: center;">
        <input type="text" id="company-name-search" placeholder="íšŒì‚¬ëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ..." style="flex: 1; padding: 0.6rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 0.85rem;">
        <button class="btn btn-secondary" onclick="searchCompany()" style="padding: 0.6rem 1rem; white-space: nowrap;">
          ğŸ” ì¡°íšŒ
        </button>
        <button class="btn btn-secondary" onclick="openCompanyListModal()" style="padding: 0.6rem 1rem; white-space: nowrap;">
          ğŸ“‹ ëª©ë¡
        </button>
      </div>
      
      <!-- ìˆ¨ê¹€ ë“œë¡­ë‹¤ìš´ (í˜¸í™˜ì„±) -->
      <select id="company-select" style="display:none;" onchange="loadSelectedCompany()">
        <option value="">-- ìƒˆë¡œ ì…ë ¥ --</option>
      </select>
      
      <div class="company-action-buttons">
        <button class="btn btn-secondary" onclick="clearForm()">
          â• ìƒˆë¡œ ì…ë ¥
        </button>
      </div>
    </div>

    <!-- ê³ ê°ì‚¬ ëª©ë¡ ëª¨ë‹¬ -->
    <div id="company-list-modal" onclick="event.target.id === 'company-list-modal' && closeCompanyListModal()" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; padding: 1rem; overflow-y: auto;">
      <div style="max-width: 800px; margin: 2rem auto; background: linear-gradient(135deg, #1a3a5c 0%, #2a5a8a 100%); border-radius: 15px; padding: 1.5rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
        
        <!-- ëª¨ë‹¬ í—¤ë” -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.2);">
          <h3 style="margin: 0; color: #ffd27f; font-size: 1.3rem;">ğŸ“‹ ì €ì¥ëœ ê³ ê°ì‚¬ ëª©ë¡</h3>
          <button onclick="closeCompanyListModal()" style="background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; padding: 0; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">Ã—</button>
        </div>
        
        <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
        <div style="background: rgba(255,210,127,0.15); border: 1px solid rgba(255,210,127,0.3); border-radius: 8px; padding: 0.6rem 0.8rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1rem;">ğŸ’¡</span>
          <span style="color: #ffd27f; font-size: 0.8rem; line-height: 1.4;">ê³ ê°ì‚¬ê°€ ë¦¬ìŠ¤íŠ¸ì— ì—†ì„ ê²½ìš° <strong>ìƒˆë¡œê³ ì¹¨</strong>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</span>
        </div>
        
        <!-- ê²€ìƒ‰ ë° ì •ë ¬ -->
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
          <input type="text" id="modal-company-search" placeholder="ğŸ” íšŒì‚¬ëª… ê²€ìƒ‰..." oninput="filterModalList()" style="flex: 1; min-width: 120px; padding: 0.6rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 0.85rem;">
          <button class="sort-btn active" onclick="sortModalList('name')" id="modal-sort-name" style="padding: 0.6rem 0.8rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; cursor: pointer; font-size: 0.8rem; white-space: nowrap;">ê°€ë‚˜ë‹¤ìˆœ</button>
          <button class="sort-btn" onclick="sortModalList('date')" id="modal-sort-date" style="padding: 0.6rem 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; cursor: pointer; font-size: 0.8rem; white-space: nowrap;">ìµœì‹ ìˆœ</button>
          <button onclick="refreshDriveConnection()" style="padding: 0.6rem 0.8rem; background: linear-gradient(135deg, #28a745, #20c997); border: none; color: white; border-radius: 6px; cursor: pointer; font-size: 0.8rem; white-space: nowrap; display: flex; align-items: center; gap: 0.3rem; font-weight: 600; box-shadow: 0 2px 8px rgba(40,167,69,0.3);" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <!-- ê³ ê°ì‚¬ ë¦¬ìŠ¤íŠ¸ -->
        <div id="modal-company-list" style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 0.5rem;">
          <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">ì €ì¥ëœ ê³ ê°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
        
      </div>
    </div>

    <!-- Section 1: ê¸°ì—… ê¸°ë³¸ì •ë³´ -->
    <div class="card">
      <h2>Section 1. ê¸°ì—… ê¸°ë³¸ì •ë³´</h2>
      
      <h3>1-1. ê¸°ì—… ì‹ë³„ì •ë³´</h3>
      <div class="form-grid">
        <div class="form-group full-width">
          <label>ê¸°ì—…ëª… <span class="required">*</span></label>
          <input type="text" id="company-name" placeholder="ìƒí˜¸ëª…ì„ ì •í™•íˆ ì…ë ¥" required style="width: 100%; max-width: 100%; box-sizing: border-box;">
        </div>
        
        <div class="form-group">
          <label>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ <span class="required">*</span></label>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="text" id="business-number-1" placeholder="000" maxlength="3" style="width: 80px;" inputmode="numeric" required oninput="allowOnlyNumbers(this); moveFocusOnMaxLength(this, 'business-number-2', 3)">
            <span style="color: #ddd;">-</span>
            <input type="text" id="business-number-2" placeholder="00" maxlength="2" style="width: 60px;" inputmode="numeric" required oninput="allowOnlyNumbers(this); moveFocusOnMaxLength(this, 'business-number-3', 2)">
            <span style="color: #ddd;">-</span>
            <input type="text" id="business-number-3" placeholder="00000" maxlength="5" style="width: 100px;" inputmode="numeric" required oninput="allowOnlyNumbers(this)">
          </div>
        </div>
        
        <div class="form-group">
          <label>ê°œì—…ì—°ì›”ì¼(ì‚¬ì—…ìë“±ë¡ì¦) <span class="required">*</span></label>
          <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
            <input type="date" id="establish-date" required onchange="calculateBusinessAge()" style="flex: 1; min-width: 150px;">
            <span id="business-age-display" style="font-size: 0.75rem; color: #ffd27f; white-space: nowrap;"></span>
          </div>
        </div>
      </div>
      
      <h3>1-2. ê¸°ì—… ë¶„ë¥˜</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>ê¸°ì—… ê·œëª¨ <span class="required">*</span></label>
          <select id="company-size" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ì˜ˆë¹„ì°½ì—…ì">ì˜ˆë¹„ì°½ì—…ì</option>
            <option value="ì†Œìƒê³µì¸">ì†Œìƒê³µì¸</option>
            <option value="ì†Œê¸°ì—…">ì†Œê¸°ì—…</option>
            <option value="ì¤‘ê¸°ì—…">ì¤‘ê¸°ì—…</option>
            <option value="ì¤‘ê²¬ê¸°ì—…">ì¤‘ê²¬ê¸°ì—…</option>
            <option value="ëŒ€ê¸°ì—…">ëŒ€ê¸°ì—…</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ê¸°ì—… í˜•íƒœ <span class="required">*</span></label>
          <select id="company-type" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ê°œì¸ì‚¬ì—…ì">ê°œì¸ì‚¬ì—…ì</option>
            <option value="ë²•ì¸(ì£¼ì‹)">ë²•ì¸(ì£¼ì‹íšŒì‚¬)</option>
            <option value="ë²•ì¸(ìœ í•œ)">ë²•ì¸(ìœ í•œíšŒì‚¬)</option>
            <option value="í˜‘ë™ì¡°í•©">í˜‘ë™ì¡°í•©</option>
            <option value="ì‚¬íšŒì ê¸°ì—…">ì‚¬íšŒì ê¸°ì—…</option>
            <option value="ì†Œì…œë²¤ì²˜">ì†Œì…œë²¤ì²˜</option>
            <option value="ë¹„ì˜ë¦¬">ë¹„ì˜ë¦¬ë²•ì¸</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì‚¬ì—… ìƒíƒœ <span class="required">*</span></label>
          <select id="business-status" required>
            <option value="ìš´ì˜ì¤‘">ìš´ì˜ì¤‘</option>
            <option value="íœ´ì—…">íœ´ì—…</option>
            <option value="íì—…">íì—…</option>
          </select>
        </div>
        
        <div class="form-group full-width">
          <label>ì—…ì¢…(KSIC ì½”ë“œ_11ì°¨) <span class="required">*</span></label>
          <div style="display: flex; gap: 0.3rem; align-items: flex-start; flex-wrap: wrap;">
            <!-- ê³„ì¸µí˜• KSIC ì„ íƒ -->
            <select id="ksic-level-2" onchange="onKsicLevel2Change()" style="flex: 1; min-width: 150px;">
              <option value="">ì¤‘ë¶„ë¥˜(2ìë¦¬) ì„ íƒ</option>
            </select>
            <select id="ksic-level-3" onchange="onKsicLevel3Change()" style="flex: 1; min-width: 150px;" disabled>
              <option value="">ì†Œë¶„ë¥˜(3ìë¦¬) ì„ íƒ</option>
            </select>
            <select id="ksic-level-4" onchange="onKsicLevel4Change()" style="flex: 1; min-width: 150px;" disabled>
              <option value="">ì„¸ë¶„ë¥˜(4ìë¦¬) ì„ íƒ</option>
            </select>
            <select id="ksic-level-5" onchange="onKsicLevel5Change()" style="flex: 1; min-width: 150px;" disabled>
              <option value="">ì„¸ì„¸ë¶„ë¥˜(5ìë¦¬) ì„ íƒ</option>
            </select>
          </div>
          <div style="display: flex; gap: 0.3rem; align-items: center; margin-top: 0.5rem;">
            <span style="font-weight: bold; color: #4a90d9;">ì„ íƒëœ ì½”ë“œ:</span>
            <input type="text" id="ksic-display" readonly style="width: 80px; text-align: center; padding: 0.4rem; font-size: 1rem; font-weight: bold; background: #1a2a3a; border: 2px solid #4a90d9; color: #fff;" placeholder="00000">
            <span id="ksic-name-display" style="color: #8ab4f8; font-size: 0.9rem;"></span>
            <input type="hidden" id="ksic-code">
            <button type="button" onclick="openKsicSearch()" class="btn-mini" title="í†µê³„ì²­ ê³µì‹ KSIC ê²€ìƒ‰ ì‚¬ì´íŠ¸">ğŸ” í†µê³„ì²­ ê²€ìƒ‰</button>
          </div>
          <span class="info-text" style="color: #ff9999; font-weight: bold;">âš ï¸ KSIC ì½”ë“œ 5ìë¦¬ê¹Œì§€ ì„ íƒí•´ì£¼ì„¸ìš”. ì´ ì½”ë“œê°€ AI ë¶„ì„ì— ê°€ì¥ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤!</span>
        </div>
        
        <div class="form-group full-width">
          <label>ì£¼ë ¥ ì œí’ˆ/ì„œë¹„ìŠ¤ (ìµœëŒ€ 4ê°œ)</label>
          <div class="product-grid">
            <input type="text" id="product-1" placeholder="ì£¼ë ¥ì œí’ˆ 1">
            <input type="text" id="product-2" placeholder="ì£¼ë ¥ì œí’ˆ 2">
            <input type="text" id="product-3" placeholder="ì£¼ë ¥ì œí’ˆ 3">
            <input type="text" id="product-4" placeholder="ì£¼ë ¥ì œí’ˆ 4">
          </div>
        </div>
      </div>
      
      <h3>1-3. ì‚¬ì—…ì¥ ì •ë³´</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>ë³¸ì  ì†Œì¬ì§€ (ì‹œë„) <span class="required">*</span></label>
          <select id="location-sido" required onchange="updateSigunguOptions()">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ì„œìš¸">ì„œìš¸</option>
            <option value="ê²½ê¸°">ê²½ê¸°</option>
            <option value="ì¸ì²œ">ì¸ì²œ</option>
            <option value="ë¶€ì‚°">ë¶€ì‚°</option>
            <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
            <option value="ëŒ€ì „">ëŒ€ì „</option>
            <option value="ê´‘ì£¼">ê´‘ì£¼</option>
            <option value="ìš¸ì‚°">ìš¸ì‚°</option>
            <option value="ì„¸ì¢…">ì„¸ì¢…</option>
            <option value="ê°•ì›">ê°•ì›</option>
            <option value="ì¶©ë¶">ì¶©ë¶</option>
            <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
            <option value="ì „ë¶">ì „ë¶</option>
            <option value="ì „ë‚¨">ì „ë‚¨</option>
            <option value="ê²½ë¶">ê²½ë¶</option>
            <option value="ê²½ë‚¨">ê²½ë‚¨</option>
            <option value="ì œì£¼">ì œì£¼</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì‹œêµ°êµ¬</label>
          <select id="location-sigungu">
            <option value="">ì‹œë„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì‚°ì—…ë‹¨ì§€ ì…ì£¼</label>
          <select id="industrial-complex">
            <option value="ë¯¸ì…ì£¼">ë¯¸ì…ì£¼</option>
            <option value="ì¼ë°˜ì‚°ë‹¨">ì¼ë°˜ì‚°ë‹¨</option>
            <option value="êµ­ê°€ì‚°ë‹¨">êµ­ê°€ì‚°ë‹¨</option>
            <option value="ì§€ë°©ì‚°ë‹¨">ì§€ë°©ì‚°ë‹¨</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ìˆ˜ë„ê¶Œ ì—¬ë¶€ <span class="required">*</span></label>
          <select id="capital-area" required disabled>
            <option value="">ìë™ ì„¤ì •ë¨</option>
            <option value="Y">ì˜ˆ (ì„œìš¸/ê²½ê¸°/ì¸ì²œ)</option>
            <option value="N">ì•„ë‹ˆì˜¤ (ì§€ë°©)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Section 2: ëŒ€í‘œì ì •ë³´ -->
    <div class="card">
      <h2>Section 2. ëŒ€í‘œì ì •ë³´</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>ìƒë…„ì›”ì¼</label>
          <input type="date" id="ceo-birth">
          <span class="info-text">ì²­ë…„(ë§Œ39ì„¸â†“) íŒì •</span>
        </div>
        
        <div class="form-group">
          <label>ì„±ë³„ <span class="required">*</span></label>
          <select id="ceo-gender" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ë‚¨">ë‚¨</option>
            <option value="ì—¬">ì—¬</option>
          </select>
          <span class="info-text">ì—¬ì„±ê¸°ì—… ì „ìš© íŠ¸ë™</span>
        </div>
      </div>
    </div>

    <!-- Section 3: ì¬ë¬´ ë° ì‹ ìš©ì •ë³´ -->
    <div class="card">
      <h2>Section 3. ì¬ë¬´ ë° ì‹ ìš©ì •ë³´</h2>
      
      <h3>3-1. ì¬ë¬´ í˜„í™©</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>ë§¤ì¶œì•¡ - ìµœê·¼ë…„ë„ (ì›) <span class="required">*</span></label>
          <input type="text" id="revenue-recent" placeholder="ì˜ˆ: 1500000000" required>
        </div>
        
        <div class="form-group">
          <label>ì˜ì—…ì´ìµ - ìµœê·¼ë…„ë„ (ì›)</label>
          <div style="display: flex; align-items: center; gap: 0.3rem;">
            <label class="loss-checkbox-label">
              <input type="checkbox" id="profit-loss" onchange="toggleProfitSign()">
              <span class="loss-checkbox-box">âœ“</span>
              <span class="loss-checkbox-text">ì†ì‹¤</span>
            </label>
            <input type="text" id="profit-recent" placeholder="ì˜ˆ: 200000000" inputmode="numeric" style="flex: 1;" oninput="formatProfitInput(this)">
          </div>
        </div>
        
        <div class="form-group">
          <label>ë¶€ì±„ë¹„ìœ¨ (%)</label>
          <input type="text" id="debt-ratio" placeholder="ì˜ˆ: 87.5" inputmode="decimal" oninput="formatDecimalInput(this)">
        </div>
      </div>
      
      <h3>3-2. ê²°ê²©ì‚¬ìœ  ì²´í¬</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>êµ­ì„¸ ì²´ë‚© <span class="required">*</span></label>
          <select id="tax-arrears" required>
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì§€ë°©ì„¸ ì²´ë‚© <span class="required">*</span></label>
          <select id="local-tax-arrears" required>
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>4ëŒ€ë³´í—˜ ë¯¸ë‚©/ì²´ë‚©</label>
          <select id="insurance-arrears">
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì™„ì „ìë³¸ì ì‹</label>
          <select id="capital-erosion">
            <option value="N">ì•„ë‹ˆì˜¤</option>
            <option value="Y">ì˜ˆ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ë¶€ë„/íšŒìƒ/íŒŒì‚° ì´ë ¥</label>
          <select id="bankruptcy-history">
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
      </div>
      
      <h3>3-3. ì‹ ìš©ì •ë³´</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>ê¸°ìˆ ì‹ ìš©í‰ê°€(TCB) ë“±ê¸‰</label>
          <select id="tcb-rating">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="T-1">T-1</option>
            <option value="T-2">T-2</option>
            <option value="T-3">T-3</option>
            <option value="T-4">T-4</option>
            <option value="T-5">T-5</option>
            <option value="T-6">T-6</option>
            <option value="T-7">T-7</option>
            <option value="T-8">T-8</option>
            <option value="T-9">T-9</option>
            <option value="T-10">T-10</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Section 4: ê³ ìš© ì •ë³´ -->
    <div class="card">
      <h2>Section 4. ê³ ìš© ì •ë³´</h2>
      
      <h3>4-1. ì¸ë ¥ í˜„í™©</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>ìƒì‹œê·¼ë¡œì ìˆ˜ (ëª…) <span class="required">*</span></label>
          <input type="number" id="employees-total" placeholder="ëŒ€í‘œì ì œì™¸" required>
        </div>
        
        <div class="form-group">
          <label>ì²­ë…„ ê³ ìš© (ë§Œ15~34ì„¸)</label>
          <input type="number" id="employees-youth" placeholder="ì²­ë…„ ì¸ì›">
          <span class="info-text">ì²­ë…„ê³ ìš© ê°€ì </span>
        </div>
        
        <div class="form-group">
          <label>ì—¬ì„± ê³ ìš©</label>
          <input type="number" id="employees-female" placeholder="ì—¬ì„± ì¸ì›">
          <span class="info-text">ì—¬ì„±ê³ ìš© ê°€ì </span>
        </div>
        
        <div class="form-group">
          <label>ì¥ì• ì¸ ê³ ìš©</label>
          <input type="number" id="employees-disabled" placeholder="ì¥ì• ì¸ ì¸ì›">
        </div>
        
        <div class="form-group">
          <label>ê³ ìš© ì¦ê°€ìœ¨ (%)</label>
          <input type="number" id="employment-growth" placeholder="ì „ë…„ ëŒ€ë¹„ ì¦ê°€ìœ¨" step="0.1">
          <span class="info-text">ê³ ìš©ì°½ì¶œ ìš°ëŒ€</span>
        </div>
      </div>
    </div>

    <!-- Section 5: ê¸°ìˆ  ë° ì¸ì¦ ì •ë³´ -->
    <div class="card">
      <h2>Section 5. ê¸°ìˆ  ë° ì¸ì¦ ì •ë³´</h2>
      
      <h3>5-1. ê¸°ì—… ì¸ì¦</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>ë²¤ì²˜ê¸°ì—… ì¸ì¦</label>
          <select id="cert-venture">
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì´ë…¸ë¹„ì¦ˆ(ê¸°ìˆ í˜ì‹ )</label>
          <select id="cert-innobiz">
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ë©”ì¸ë¹„ì¦ˆ(ê²½ì˜í˜ì‹ )</label>
          <select id="cert-mainbiz">
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì—¬ì„±ê¸°ì—… ì¸ì¦</label>
          <select id="cert-woman">
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
          <span class="info-text">ì—¬ì„±ê¸°ì—… ì „ìš© ì§€ì›</span>
        </div>
        
        <div class="form-group">
          <label>ì¥ì• ì¸ê¸°ì—… ì¸ì¦</label>
          <select id="cert-disabled">
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ì‚¬íšŒì ê¸°ì—… ì¸ì¦</label>
          <select id="cert-social">
            <option value="N">ì—†ìŒ</option>
            <option value="Y">ìˆìŒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ESG ì¶”ì§„ ì—¬ë¶€</label>
          <select id="esg-status">
            <option value="N">ì•„ë‹ˆì˜¤</option>
            <option value="Y">ì˜ˆ</option>
          </select>
          <span class="info-text">ESG ê´€ë ¨ ì‚¬ì—… ê°€ì </span>
        </div>
      </div>
      
      <h3>5-2. ì—°êµ¬ê°œë°œ ì—­ëŸ‰</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>ì—°êµ¬ì¡°ì§</label>
          <select id="research-org">
            <option value="ì—†ìŒ">ì—†ìŒ</option>
            <option value="ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ">ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ</option>
            <option value="ì—°êµ¬ê°œë°œì „ë‹´ë¶€ì„œ">ì—°êµ¬ê°œë°œì „ë‹´ë¶€ì„œ</option>
          </select>
          <span class="info-text">ê¸°ìˆ ê°œë°œì‚¬ì—… í•„ìˆ˜</span>
        </div>
        
        <div class="form-group">
          <label>íŠ¹í—ˆ ë“±ë¡ (ê±´)</label>
          <input type="number" id="patents-registered" placeholder="ë“±ë¡">
        </div>
      </div>
    </div>

    <!-- Section 6: ìˆ˜ì¶œ ë° í•´ì™¸ì§„ì¶œ -->
    <div class="card">
      <h2>Section 6. ìˆ˜ì¶œ ë° í•´ì™¸ì§„ì¶œ</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>ìˆ˜ì¶œ ì‹¤ì  - ìµœê·¼ë…„ë„ ($)</label>
          <input type="number" id="export-recent" placeholder="ì˜ˆ: 100000">
        </div>
        
        <div class="form-group full-width">
          <label>ì£¼ìš” ìˆ˜ì¶œêµ­</label>
          <input type="text" id="export-countries" placeholder="ë§¤ì¶œë¹„ì¤‘ ìƒìœ„ 3ê°œêµ­ (ì˜ˆ: ë¯¸êµ­, ì¤‘êµ­, ì¼ë³¸)">
        </div>
      </div>
    </div>

    <!-- Section 7: í¬ë§ ì§€ì›ë¶„ì•¼ -->
    <div class="card">
      <h2>Section 7. í¬ë§ ì§€ì›ë¶„ì•¼ <span class="required">*</span></h2>
      
      <style>
        .support-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 0.8rem;
        }
        @media (max-width: 1024px) {
          .support-grid {
            grid-template-columns: repeat(3, 1fr);
          }
        }
        @media (max-width: 768px) {
          .support-grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }
        .support-item {
          background: rgba(255,255,255,0.05);
          border: 1px solid rgba(255,255,255,0.15);
          border-radius: 8px;
          padding: 0.7rem;
          display: flex;
          flex-direction: column;
          gap: 0.3rem;
        }
        .support-item:hover {
          background: rgba(255,255,255,0.1);
          border-color: rgba(255,255,255,0.25);
        }
        .support-item label {
          font-weight: 600;
          font-size: 0.9rem;
          cursor: pointer;
        }
        .support-item .support-desc {
          font-size: 0.7rem;
          color: rgba(255,255,255,0.6);
          line-height: 1.3;
          margin-left: 1.4rem;
        }
      </style>
      
      <h3>7-1. ì§€ì› í•„ìš” ë¶„ì•¼ (ì¤‘ë³µì„ íƒ ê°€ëŠ¥)</h3>
      <div class="support-grid">
        <div class="support-item">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-finance" name="desiredSupport" value="ê¸ˆìœµ">
            <label for="support-finance">ê¸ˆìœµ</label>
          </div>
          <span class="support-desc">ì •ì±…ìê¸ˆ, ìœµì, ë³´ì¦, íˆ¬ì</span>
        </div>
        <div class="support-item">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-tech" name="desiredSupport" value="ê¸°ìˆ ">
            <label for="support-tech">ê¸°ìˆ </label>
          </div>
          <span class="support-desc">R&D, ê¸°ìˆ ê°œë°œ, íŠ¹í—ˆ, ì¸ì¦</span>
        </div>
        <div class="support-item">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-manpower" name="desiredSupport" value="ì¸ë ¥">
            <label for="support-manpower">ì¸ë ¥</label>
          </div>
          <span class="support-desc">ê³ ìš©ì§€ì›, ì±„ìš©, êµìœ¡, ì¸ê±´ë¹„</span>
        </div>
        <div class="support-item">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-export" name="desiredSupport" value="ìˆ˜ì¶œ">
            <label for="support-export">ìˆ˜ì¶œ</label>
          </div>
          <span class="support-desc">í•´ì™¸ì§„ì¶œ, ìˆ˜ì¶œë°”ìš°ì²˜, ë¬´ì—­</span>
        </div>
        <div class="support-item">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-domestic" name="desiredSupport" value="ë‚´ìˆ˜">
            <label for="support-domestic">ë‚´ìˆ˜</label>
          </div>
          <span class="support-desc">íŒë¡œê°œì²™, ë§ˆì¼€íŒ…, í™ë³´</span>
        </div>
        <div class="support-item">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-startup" name="desiredSupport" value="ì°½ì—…">
            <label for="support-startup">ì°½ì—…</label>
          </div>
          <span class="support-desc">ì°½ì—…ì§€ì›, ì•¡ì…€ëŸ¬ë ˆì´íŒ…</span>
        </div>
        <div class="support-item">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-management" name="desiredSupport" value="ê²½ì˜">
            <label for="support-management">ê²½ì˜</label>
          </div>
          <span class="support-desc">ì»¨ì„¤íŒ…, í˜ì‹ , ìŠ¤ë§ˆíŠ¸ê³µì¥</span>
        </div>
        <div class="support-item">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-etc" name="desiredSupport" value="ê¸°íƒ€">
            <label for="support-etc">ê¸°íƒ€</label>
          </div>
          <span class="support-desc">ESG, íƒ„ì†Œì¤‘ë¦½, ì‹œì„¤, ê³µê°„</span>
        </div>
        <div class="support-item" style="grid-column: span 2; background: rgba(255,210,127,0.1); border-color: rgba(255,210,127,0.3);">
          <div style="display: flex; align-items: center; gap: 0.4rem;">
            <input type="checkbox" id="support-all" name="desiredSupport" value="ì „ì²´" onchange="toggleAllSupport(this.checked)">
            <label for="support-all" style="color: #ffd27f;">ì „ì²´</label>
          </div>
          <span class="support-desc" style="color: rgba(255,210,127,0.8);">ë¶„ì•¼ ë¬´ê´€, ëª¨ë“  ì§€ì›ì‚¬ì—…</span>
        </div>
      </div>
    </div>

    <!-- ì‹¤í–‰ ë²„íŠ¼ -->
    <div class="card">
      <style>
        .action-btn-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 0.5rem;
          margin-bottom: 0.5rem;
        }
        @media (max-width: 768px) {
          .action-btn-grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }
        .btn-action-primary {
          background: linear-gradient(135deg, #FF8802 0%, #FF6B00 100%);
          color: white;
          border: none;
          padding: 0.9rem 0.5rem;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.85rem;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
          text-align: center;
          white-space: nowrap;
        }
        .btn-action-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(255,136,2,0.4);
        }
        .btn-action-secondary {
          background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
          color: white;
          border: none;
          padding: 0.9rem 0.5rem;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.85rem;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
          text-align: center;
          white-space: nowrap;
        }
        .btn-action-secondary:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(74,85,104,0.4);
        }
      </style>
      
      <!-- ë²„íŠ¼ ê·¸ë¦¬ë“œ (PC: 4ê°œì”©, ëª¨ë°”ì¼: 2ê°œì”©) -->
      <div class="action-btn-grid">
        <button class="btn-action-primary" onclick="findAndAnalyzePrograms()">
          ğŸ” ì§€ì›ì‚¬ì—…+ë¶„ì„
        </button>
        <button class="btn-action-primary" onclick="analyzeProgramsDetail()">
          ğŸ“Š ìƒì„¸ë¶„ì„(ìµœëŒ€10ê°œ)
        </button>
        <button class="btn-action-secondary" onclick="saveCompany()">
          ğŸ’¾ ê¸°ì—…ì •ë³´ ì €ì¥
        </button>
        <button class="btn-action-secondary" onclick="saveWithPrograms()">
          ğŸ’¾ ì €ì¥(ê¸°ì—…+ì§€ì›ì‚¬ì—…)
        </button>
      </div>
      
      <div class="action-btn-grid">
        <button class="btn-action-secondary" onclick="saveWithAIAnalysis()">
          ğŸ’¾ ì €ì¥(ìƒì„¸ë¶„ì„)
        </button>
        <button class="btn-action-secondary" onclick="showDetailSample()">
          ğŸ‘ï¸ ìƒì„¸ë¶„ì„ ìƒ˜í”Œ
        </button>
        <button class="btn-action-secondary" onclick="showPointChargeModal()">
          ğŸ’° í¬ì¸íŠ¸ì¶©ì „/ì¡°íšŒ
        </button>
        <button class="btn-action-secondary" onclick="deleteCompany()" style="background: linear-gradient(135deg, #718096 0%, #4a5568 100%);" title="â€» ê¸°ì—…ì •ë³´ëŠ” ëª©ë¡ì—ì„œ ì‚­ì œ">
          ğŸ—‘ï¸ ì‚­ì œ(ì§€ì›ì •ë³´)
        </button>
      </div>
      <p style="text-align: right; font-size: 0.7rem; color: #aaa; margin: 0.3rem 0 0 0;">â€» ê¸°ì—…ì •ë³´ëŠ” ëª©ë¡ì—ì„œ ì‚­ì œ</p>
    </div>

    <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
    <div id="results-section" style="display: none;"></div>
    
    <!-- AI ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
    <div id="aiResultsSection" style="display: none; margin-top: 2rem;">
      <div class="card">
        <h3 style="color: #FFD700; margin-bottom: 1rem; font-size: 1.3rem;">
          ğŸ¯ AI ë¶„ì„ ê²°ê³¼ (ìƒìœ„ 20ê°œ)
        </h3>
        <div id="aiResultsList"></div>
      </div>
    </div>
    
    <!-- Footer -->
    <footer style="text-align: center; padding: 2rem 1rem; margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); font-size: 0.8rem;">
      <p style="margin: 0;">Â© 2025 (ì£¼)í•œêµ­FPì„¼í„°. All Rights Reserved.</p>
    </footer>
  </div>

  <script>
    // ==================== Firebase ì„¤ì • ====================
    
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
      authDomain: "kfpc-company-support-project.firebaseapp.com",
      databaseURL: "https://kfpc-company-support-project-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kfpc-company-support-project",
      storageBucket: "kfpc-company-support-project.firebasestorage.app",
      messagingSenderId: "101260933373",
      appId: "1:101260933373:web:3436176f9ca2560056d914"
    };
    
    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // Firebase Functions ì´ˆê¸°í™” (ì„œìš¸ ë¦¬ì „)
    const functions = firebase.app().functions('asia-northeast3');
    
    // ì‚¬ìš©ì ì •ë³´
    let currentUser = null;
    let hasCompletedSearch = false; // ë§ì¶¤ì°¾ê¸° ì™„ë£Œ í”Œë˜ê·¸
    
    // ==================== ê´€ë ¨ë„ ë“±ê¸‰ ë³€í™˜ ====================
    /**
     * ì ìˆ˜ë¥¼ ê´€ë ¨ë„ ë“±ê¸‰ìœ¼ë¡œ ë³€í™˜
     * @param {number} score - ì ìˆ˜ (0~100)
     * @returns {object} { text: 'ë§¤ìš°ë†’ìŒ', color: '#28a745', bgColor: '...' }
     */
    function getRelevanceGrade(score) {
      // 90~100: ë§¤ìš°ë†’ìŒ (ê°•ë ¥ ì¶”ì²œ)
      if (score >= 90) {
        return {
          text: 'ë§¤ìš°ë†’ìŒ',
          color: '#fff',
          bgColor: 'linear-gradient(135deg, #28a745, #20c997)',
          borderColor: '#28a745',
          headerBg: '#d4edda',
          headerText: '#155724',
          icon: 'ğŸŸ¢'
        };
      }
      // 80~89: ë†’ìŒ (ì¶”ì²œ)
      else if (score >= 80) {
        return {
          text: 'ë†’ìŒ',
          color: '#fff',
          bgColor: 'linear-gradient(135deg, #17a2b8, #20c997)',
          borderColor: '#17a2b8',
          headerBg: '#d1ecf1',
          headerText: '#0c5460',
          icon: 'ğŸ”µ'
        };
      }
      // 70~79: ë³´í†µ (ê²€í†  ê¶Œì¥)
      else if (score >= 70) {
        return {
          text: 'ë³´í†µ',
          color: '#fff',
          bgColor: 'linear-gradient(135deg, #6f42c1, #e83e8c)',
          borderColor: '#6f42c1',
          headerBg: '#e2d9f3',
          headerText: '#4a2c7c',
          icon: 'ğŸŸ£'
        };
      }
      // 60~69: ë‚®ìŒ (ì¡°ê±´ í™•ì¸ í•„ìš”)
      else if (score >= 60) {
        return {
          text: 'ë‚®ìŒ',
          color: '#333',
          bgColor: 'linear-gradient(135deg, #fd7e14, #ffc107)',
          borderColor: '#fd7e14',
          headerBg: '#fff3cd',
          headerText: '#856404',
          icon: 'ğŸŸ '
        };
      }
      // 60 ë¯¸ë§Œ: ì°¸ê³  (í˜‘ë ¥ì‚¬ ì¶”ì²œ)
      else {
        return {
          text: 'ì°¸ê³ ',
          color: '#333',
          bgColor: 'linear-gradient(135deg, #ffc107, #ffda6a)',
          borderColor: '#ffc107',
          headerBg: '#fff3cd',
          headerText: '#856404',
          icon: 'ğŸŸ¡'
        };
      }
    }
    
    // ==================== KSIC ë°ì´í„° ë° ê³„ì¸µí˜• ë“œë¡­ë‹¤ìš´ ====================
    let ksicData = [];
    
    // KSIC ë°ì´í„° ë¡œë“œ (Firebase Functions ì‚¬ìš©)
    async function loadKsicData() {
      try {
        const getKsicData = firebase.app().functions('asia-northeast3').httpsCallable('getKsicData');
        const result = await getKsicData();
        ksicData = result.data;
        console.log(`âœ… KSIC ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${ksicData.length}ê°œ`);
        initKsicLevel2();
      } catch (error) {
        console.error('KSIC ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        // ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
        ksicData = [];
      }
    }
    
    // ì½”ë“œ ê¸¸ì´ë¡œ ë ˆë²¨ íŒë‹¨
    function getCodeLevel(code) {
      return code.length;
    }
    
    // íŠ¹ì • ë ˆë²¨ì˜ ì½”ë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function getCodesByLevel(level) {
      return ksicData.filter(item => item.code.length === level);
    }
    
    // ë¶€ëª¨ ì½”ë“œì— í•´ë‹¹í•˜ëŠ” ìì‹ ì½”ë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function getChildCodes(parentCode) {
      const parentLevel = parentCode.length;
      const childLevel = parentLevel + 1;
      return ksicData.filter(item => 
        item.code.length === childLevel && item.code.startsWith(parentCode)
      );
    }
    
    // Level 2 (ì¤‘ë¶„ë¥˜) ì´ˆê¸°í™”
    function initKsicLevel2() {
      const select = document.getElementById('ksic-level-2');
      if (!select) return;
      
      select.innerHTML = '<option value="">ì¤‘ë¶„ë¥˜(2ìë¦¬) ì„ íƒ</option>';
      const level2Codes = getCodesByLevel(2);
      
      level2Codes.forEach(item => {
        const option = document.createElement('option');
        option.value = item.code;
        option.textContent = `${item.code} - ${item.name}`;
        select.appendChild(option);
      });
    }
    
    // Level 2 ì„ íƒ ì‹œ
    function onKsicLevel2Change() {
      const select2 = document.getElementById('ksic-level-2');
      const select3 = document.getElementById('ksic-level-3');
      const select4 = document.getElementById('ksic-level-4');
      const select5 = document.getElementById('ksic-level-5');
      
      const selectedCode = select2.value;
      
      // í•˜ìœ„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
      select3.innerHTML = '<option value="">ì†Œë¶„ë¥˜(3ìë¦¬) ì„ íƒ</option>';
      select4.innerHTML = '<option value="">ì„¸ë¶„ë¥˜(4ìë¦¬) ì„ íƒ</option>';
      select5.innerHTML = '<option value="">ì„¸ì„¸ë¶„ë¥˜(5ìë¦¬) ì„ íƒ</option>';
      select3.disabled = true;
      select4.disabled = true;
      select5.disabled = true;
      
      if (!selectedCode) {
        updateKsicDisplay('');
        return;
      }
      
      // Level 3 ì±„ìš°ê¸°
      const children = getChildCodes(selectedCode);
      if (children.length > 0) {
        children.forEach(item => {
          const option = document.createElement('option');
          option.value = item.code;
          option.textContent = `${item.code} - ${item.name}`;
          select3.appendChild(option);
        });
        select3.disabled = false;
      }
      
      updateKsicDisplay(selectedCode);
    }
    
    // Level 3 ì„ íƒ ì‹œ
    function onKsicLevel3Change() {
      const select3 = document.getElementById('ksic-level-3');
      const select4 = document.getElementById('ksic-level-4');
      const select5 = document.getElementById('ksic-level-5');
      
      const selectedCode = select3.value;
      
      // í•˜ìœ„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
      select4.innerHTML = '<option value="">ì„¸ë¶„ë¥˜(4ìë¦¬) ì„ íƒ</option>';
      select5.innerHTML = '<option value="">ì„¸ì„¸ë¶„ë¥˜(5ìë¦¬) ì„ íƒ</option>';
      select4.disabled = true;
      select5.disabled = true;
      
      if (!selectedCode) {
        const parentCode = document.getElementById('ksic-level-2').value;
        updateKsicDisplay(parentCode);
        return;
      }
      
      // Level 4 ì±„ìš°ê¸°
      const children = getChildCodes(selectedCode);
      if (children.length > 0) {
        children.forEach(item => {
          const option = document.createElement('option');
          option.value = item.code;
          option.textContent = `${item.code} - ${item.name}`;
          select4.appendChild(option);
        });
        select4.disabled = false;
      }
      
      updateKsicDisplay(selectedCode);
    }
    
    // Level 4 ì„ íƒ ì‹œ
    function onKsicLevel4Change() {
      const select4 = document.getElementById('ksic-level-4');
      const select5 = document.getElementById('ksic-level-5');
      
      const selectedCode = select4.value;
      
      // í•˜ìœ„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
      select5.innerHTML = '<option value="">ì„¸ì„¸ë¶„ë¥˜(5ìë¦¬) ì„ íƒ</option>';
      select5.disabled = true;
      
      if (!selectedCode) {
        const parentCode = document.getElementById('ksic-level-3').value;
        updateKsicDisplay(parentCode);
        return;
      }
      
      // Level 5 ì±„ìš°ê¸°
      const children = getChildCodes(selectedCode);
      if (children.length > 0) {
        children.forEach(item => {
          const option = document.createElement('option');
          option.value = item.code;
          option.textContent = `${item.code} - ${item.name}`;
          select5.appendChild(option);
        });
        select5.disabled = false;
      }
      
      updateKsicDisplay(selectedCode);
    }
    
    // Level 5 ì„ íƒ ì‹œ
    function onKsicLevel5Change() {
      const select5 = document.getElementById('ksic-level-5');
      const selectedCode = select5.value;
      
      if (!selectedCode) {
        const parentCode = document.getElementById('ksic-level-4').value;
        updateKsicDisplay(parentCode);
        return;
      }
      
      updateKsicDisplay(selectedCode);
    }
    
    // KSIC ì½”ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateKsicDisplay(code) {
      const display = document.getElementById('ksic-display');
      const nameDisplay = document.getElementById('ksic-name-display');
      const hiddenField = document.getElementById('ksic-code');
      
      if (!code) {
        display.value = '';
        nameDisplay.textContent = '';
        hiddenField.value = '';
        return;
      }
      
      // 5ìë¦¬ë¡œ íŒ¨ë”©
      const paddedCode = code.padEnd(5, '0');
      display.value = paddedCode;
      hiddenField.value = paddedCode;
      
      // ì—…ì¢…ëª… ì°¾ê¸°
      const item = ksicData.find(i => i.code === code);
      if (item) {
        nameDisplay.textContent = item.name;
      } else {
        nameDisplay.textContent = '';
      }
    }
    
    // ì €ì¥ëœ KSIC ì½”ë“œë¡œ ë“œë¡­ë‹¤ìš´ ì„¤ì •
    function setKsicFromCode(fullCode) {
      if (!fullCode || fullCode.length < 2) return;
      
      // 2ìë¦¬ ì½”ë“œ ì„¤ì •
      const code2 = fullCode.substring(0, 2);
      const select2 = document.getElementById('ksic-level-2');
      if (select2) {
        select2.value = code2;
        onKsicLevel2Change();
      }
      
      // 3ìë¦¬ ì½”ë“œ ì„¤ì •
      if (fullCode.length >= 3) {
        const code3 = fullCode.substring(0, 3);
        setTimeout(() => {
          const select3 = document.getElementById('ksic-level-3');
          if (select3 && !select3.disabled) {
            // code3ì´ ì˜µì…˜ì— ìˆëŠ”ì§€ í™•ì¸
            const hasOption = Array.from(select3.options).some(o => o.value === code3);
            if (hasOption) {
              select3.value = code3;
              onKsicLevel3Change();
            }
          }
          
          // 4ìë¦¬ ì½”ë“œ ì„¤ì •
          if (fullCode.length >= 4) {
            const code4 = fullCode.substring(0, 4);
            setTimeout(() => {
              const select4 = document.getElementById('ksic-level-4');
              if (select4 && !select4.disabled) {
                const hasOption = Array.from(select4.options).some(o => o.value === code4);
                if (hasOption) {
                  select4.value = code4;
                  onKsicLevel4Change();
                }
              }
              
              // 5ìë¦¬ ì½”ë“œ ì„¤ì •
              if (fullCode.length >= 5) {
                const code5 = fullCode.substring(0, 5);
                setTimeout(() => {
                  const select5 = document.getElementById('ksic-level-5');
                  if (select5 && !select5.disabled) {
                    const hasOption = Array.from(select5.options).some(o => o.value === code5);
                    if (hasOption) {
                      select5.value = code5;
                      onKsicLevel5Change();
                    }
                  }
                }, 100);
              }
            }, 100);
          }
        }, 100);
      }
    }
    let lastMatchedPrograms = []; // ë§ì¶¤ì°¾ê¸° ê²°ê³¼ ì €ì¥ (ìš”ì•½/ìƒì„¸ë¶„ì„ì— ì‚¬ìš©)
    let lastCompanyData = null; // ë§ˆì§€ë§‰ ê²€ìƒ‰ ê¸°ì—… ë°ì´í„°
    let lastDetailResults = []; // PDF ìƒì„¸ë¶„ì„ ê²°ê³¼ ì €ì¥ (programId ê¸°ë°˜)
    let lastSummaryResults = []; // AI ìš”ì•½ë¶„ì„ ê²°ê³¼ ì €ì¥ (programId ê¸°ë°˜)
    
    // ğŸ†• URLì—ì„œ ë³¸ì‚¬ ë°œí–‰ ID ì¶”ì¶œ (ì¼ì¼ ì‚¬ìš© ì œí•œìš©)
    const urlParams = new URLSearchParams(window.location.search);
    const agentId = urlParams.get('agentId') || 'unknown';
    console.log('ğŸ‘¤ ë³¸ì‚¬ ID:', agentId);
    
    // ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================
    
    /**
     * KSIC ëŒ€ë¶„ë¥˜ ì„ íƒ ì‹œ ì½”ë“œ ì—…ë°ì´íŠ¸
     */
    function updateKsicCode() {
      const select = document.getElementById('ksic-select');
      const ksic1 = document.getElementById('ksic-1');
      const ksic2 = document.getElementById('ksic-2');
      
      if (select && select.value && ksic1 && ksic2) {
        // ì„ íƒëœ ê°’ì„ ì²« 2ìë¦¬ì— ìë™ ì…ë ¥
        const code = select.value;
        ksic1.value = code[0] || '';
        ksic2.value = code[1] || '';
        
        // hidden í•„ë“œë„ ì—…ë°ì´íŠ¸
        updateKsicHiddenField();
        
        // 3ë²ˆì§¸ ì…ë ¥ì°½ìœ¼ë¡œ í¬ì»¤ìŠ¤
        document.getElementById('ksic-3').focus();
      }
    }
    
    /**
     * KSIC ì½”ë“œ 5ìë¦¬ ê°œë³„ ì…ë ¥ ì²˜ë¦¬
     */
    function handleKsicInput(input, position) {
      // ìˆ«ìë§Œ í—ˆìš©
      input.value = input.value.replace(/[^0-9]/g, '');
      
      // ê°’ì´ ì…ë ¥ë˜ë©´ ë‹¤ìŒ ì¹¸ìœ¼ë¡œ ìë™ ì´ë™
      if (input.value && position < 5) {
        const nextInput = document.getElementById(`ksic-${position + 1}`);
        if (nextInput) {
          nextInput.focus();
        }
      }
      
      // hidden í•„ë“œ ì—…ë°ì´íŠ¸
      updateKsicHiddenField();
    }
    
    /**
     * í¬ë§ ì§€ì›ë¶„ì•¼ "ì „ì²´" ì„ íƒ ì‹œ ëª¨ë“  í•­ëª© ì²´í¬/í•´ì œ
     */
    function toggleAllSupport(isChecked) {
      const supportIds = [
        'support-finance',
        'support-tech', 
        'support-manpower',
        'support-export',
        'support-domestic',
        'support-startup',
        'support-management',
        'support-etc'
      ];
      
      supportIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = isChecked;
      });
    }
    
    /**
     * KSIC ì²« ë²ˆì§¸ ì…ë ¥ì¹¸ í¬ì»¤ìŠ¤ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
     * (ê³ ê°ì‚¬ ë¡œë“œ ì¤‘ì—ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
     */
    let isLoadingCompany = false;
    
    function showKsicWarning() {
      // ê³ ê°ì‚¬ ë¡œë“œ ì¤‘ì´ë©´ ê²½ê³  í‘œì‹œ ì•ˆ í•¨
      if (isLoadingCompany) return;
      
      const hasShownWarning = sessionStorage.getItem('ksicWarningShown');
      if (!hasShownWarning) {
        alert('âš ï¸ KSIC ì½”ë“œëŠ” AI ë¶„ì„ì— ê°€ì¥ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤!\n\ní•´ë‹¹ ê¸°ì—…ì˜ ì •í™•í•œ ì—…ì¢… ì½”ë“œ 5ìë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\nì •í™•í•œ ì½”ë“œë¥¼ ëª¨ë¥´ì‹œë©´ ğŸ” ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”.');
        sessionStorage.setItem('ksicWarningShown', 'true');
      }
    }
    
    /**
     * KSIC ê²€ìƒ‰ ì‚¬ì´íŠ¸ ì—´ê¸° (í†µê³„ì²­ ê³µì‹)
     */
    function openKsicSearch() {
      // í†µê³„ì²­ í•œêµ­í‘œì¤€ì‚°ì—…ë¶„ë¥˜ ê²€ìƒ‰ í˜ì´ì§€ (ì§ì ‘ ì ‘ê·¼)
      window.open('https://kssc.kostat.go.kr:8443/ksscNew_web/kssc/common/ClassificationContent.do?gubun=1&strCategoryNameCode=001&categoryMenu=007&addGubun=no', '_blank');
    }
    
    /**
     * ìˆ«ìë§Œ ì…ë ¥ í—ˆìš©
     */
    function allowOnlyNumbers(input) {
      input.value = input.value.replace(/[^0-9]/g, '');
    }
    
    /**
     * ìµœëŒ€ ê¸¸ì´ ë„ë‹¬ ì‹œ ìë™ í¬ì»¤ìŠ¤ ì´ë™
     */
    function moveFocusOnMaxLength(current, nextId, maxLength) {
      if (current.value.length >= maxLength) {
        const nextElement = document.getElementById(nextId);
        if (nextElement) nextElement.focus();
      }
    }
    
    /**
     * ì—…ë ¥ ê³„ì‚° ë° í‘œì‹œ
     */
    function calculateBusinessAge() {
      const dateInput = document.getElementById('establish-date');
      const displaySpan = document.getElementById('business-age-display');
      
      if (!dateInput || !dateInput.value || !displaySpan) return;
      
      const foundedDate = new Date(dateInput.value);
      const today = new Date();
      
      let years = today.getFullYear() - foundedDate.getFullYear();
      let months = today.getMonth() - foundedDate.getMonth();
      
      if (months < 0) {
        years--;
        months += 12;
      }
      
      if (years < 0) {
        displaySpan.textContent = '';
        return;
      }
      
      if (years === 0) {
        displaySpan.textContent = `(${months}ê°œì›”)`;
      } else if (months === 0) {
        displaySpan.textContent = `(${years}ë…„)`;
      } else {
        displaySpan.textContent = `(${years}ë…„ ${months}ê°œì›”)`;
      }
    }
    
    /**
     * ì†ì‹¤ ì²´í¬ í† ê¸€
     */
    function toggleProfitSign() {
      const checkbox = document.getElementById('profit-loss');
      const input = document.getElementById('profit-recent');
      
      if (!input) return;
      
      // ìˆ«ìë§Œ ì¶”ì¶œ (ì½¤ë§ˆ, ë§ˆì´ë„ˆìŠ¤ ì œê±°)
      let value = input.value.replace(/[^0-9]/g, '');
      
      // ì½¤ë§ˆ í¬ë§·íŒ…
      if (value) {
        value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }
      
      // ì†ì‹¤ ì²´í¬ ì‹œ ë§ˆì´ë„ˆìŠ¤ ì¶”ê°€
      if (checkbox && checkbox.checked && value) {
        input.value = '-' + value;
        input.style.color = '#ff6b6b';
      } else if (value) {
        input.value = value;
        input.style.color = '#333';
      }
    }
    
    /**
     * ì˜ì—…ì´ìµ ì…ë ¥ í¬ë§·
     */
    function formatProfitInput(input) {
      const checkbox = document.getElementById('profit-loss');
      let value = input.value.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ì¶”ì¶œ
      
      // ì½¤ë§ˆ í¬ë§·íŒ…
      if (value) {
        value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }
      
      if (checkbox && checkbox.checked && value) {
        input.value = '-' + value;
        input.style.color = '#ff6b6b';
      } else {
        input.value = value;
        input.style.color = '#333';
      }
    }
    
    /**
     * ì†Œìˆ˜ì  ì…ë ¥ í¬ë§· (ë¶€ì±„ë¹„ìœ¨ ë“±)
     */
    function formatDecimalInput(input) {
      let value = input.value.replace(/[^0-9.]/g, '');
      
      // ì†Œìˆ˜ì  í•˜ë‚˜ë§Œ í—ˆìš©
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      
      input.value = value;
    }
    
    // ==================== í…ŒìŠ¤íŠ¸ ë°ì´í„° (Phase 1) ====================
    const MOCK_COMPANIES = [
      {
        name: 'ì‚¼ì„±ì „ì(ì£¼)',
        businessNumber: '124-81-00998',
        ceo: 'í•œì¢…í¬',
        openingDate: '1969-01-13',
        industryCode: 'C26',
        companySize: 'ëŒ€ê¸°ì—…',
        companyType: 'ë²•ì¸',
        locationSido: 'ê²½ê¸°',
        locationSigungu: 'ìˆ˜ì›ì‹œ',
        revenue: '300000000000',
        employeeCount: '120000'
      },
      {
        name: 'LGì „ì(ì£¼)',
        businessNumber: '107-86-14075',
        ceo: 'ì¡°ì£¼ì™„',
        openingDate: '1958-10-01',
        industryCode: 'C26',
        companySize: 'ëŒ€ê¸°ì—…',
        companyType: 'ë²•ì¸',
        locationSido: 'ì„œìš¸',
        locationSigungu: 'ì˜ë“±í¬êµ¬',
        revenue: '70000000000',
        employeeCount: '70000'
      },
      {
        name: 'í˜„ëŒ€ìë™ì°¨(ì£¼)',
        businessNumber: '101-81-42555',
        ceo: 'ì¥ì¬í›ˆ',
        openingDate: '1967-12-29',
        industryCode: 'C30',
        companySize: 'ëŒ€ê¸°ì—…',
        companyType: 'ë²•ì¸',
        locationSido: 'ì„œìš¸',
        locationSigungu: 'ì„œì´ˆêµ¬',
        revenue: '130000000000',
        employeeCount: '75000'
      },
      {
        name: 'SKí•˜ì´ë‹‰ìŠ¤(ì£¼)',
        businessNumber: '120-81-62902',
        ceo: 'ê³½ë…¸ì •',
        openingDate: '1983-02-15',
        industryCode: 'C26',
        companySize: 'ëŒ€ê¸°ì—…',
        companyType: 'ë²•ì¸',
        locationSido: 'ê²½ê¸°',
        locationSigungu: 'ì´ì²œì‹œ',
        revenue: '40000000000',
        employeeCount: '35000'
      },
      {
        name: 'ë„¤ì´ë²„(ì£¼)',
        businessNumber: '220-81-62517',
        ceo: 'ìµœìˆ˜ì—°',
        openingDate: '1999-06-02',
        industryCode: 'J63',
        companySize: 'ëŒ€ê¸°ì—…',
        companyType: 'ë²•ì¸',
        locationSido: 'ê²½ê¸°',
        locationSigungu: 'ì„±ë‚¨ì‹œ',
        revenue: '8000000000',
        employeeCount: '4000'
      },
      {
        name: 'ì¹´ì¹´ì˜¤(ì£¼)',
        businessNumber: '120-81-47521',
        ceo: 'í™ì€íƒ',
        openingDate: '2006-02-16',
        industryCode: 'J63',
        companySize: 'ëŒ€ê¸°ì—…',
        companyType: 'ë²•ì¸',
        locationSido: 'ê²½ê¸°',
        locationSigungu: 'ì„±ë‚¨ì‹œ',
        revenue: '6000000000',
        employeeCount: '3500'
      }
    ];
    
    // ==================== ê¸°ì—…ë§ˆë‹¹ API ì—°ë™ ====================
    /**
     * ì‹¤ì œ ì§€ì›ì‚¬ì—… ë°ì´í„°ë¥¼ ê¸°ì—…ë§ˆë‹¹ APIì—ì„œ ê°€ì ¸ì˜´
     */
    let bizInfoPrograms = []; // APIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ë°ì´í„°
    let bizInfoLoaded = false;
    
    /**
     * ê¸°ì—…ë§ˆë‹¹ APIì—ì„œ ì§€ì›ì‚¬ì—… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
     */
    async function fetchBizInfoPrograms() {
      if (bizInfoLoaded && bizInfoPrograms.length > 0) {
        console.log('ğŸ“¦ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©:', bizInfoPrograms.length, 'ê°œ');
        return bizInfoPrograms;
      }
      
      try {
        console.log('ğŸ“¡ Firestore ìºì‹œì—ì„œ ê³µê³  ì¡°íšŒ ì¤‘...');
        
        // Firestore ìºì‹œì—ì„œ ê³µê³  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (adminì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„°)
        const getCachedPrograms = functions.httpsCallable('getCachedPrograms');
        const result = await getCachedPrograms();
        const data = result.data;
        
        if (data.success && data.programs) {
          bizInfoPrograms = data.programs;
          bizInfoLoaded = true;
          console.log('âœ… ê¸°ì—…ë§ˆë‹¹ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', bizInfoPrograms.length, 'ê°œ ê³µê³ ');
          console.log('ğŸ“Š ë¶„ì•¼ë³„:', data.stats?.byCategory);
          return bizInfoPrograms;
        } else {
          throw new Error(data.error || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('âŒ ê¸°ì—…ë§ˆë‹¹ API ì˜¤ë¥˜:', error);
        throw error;
      }
    }
    
    // ==================== ì‚­ì œëœ MOCK_PROGRAMS ====================
    // ê¸°ì¡´ í•˜ë“œì½”ë”© ë°ì´í„°ëŠ” ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
    // ì´ì œ fetchBizInfoPrograms()ë¡œ ì‹¤ì œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    
    // ==================== ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ====================
    
    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ (ê¸°ì¡´ signInWithGoogle ëŒ€ì²´)
    function signInWithGoogle() {
      // ì´ë¯¸ login.htmlì—ì„œ ë¡œê·¸ì¸í•˜ê³  ì™”ì–´ì•¼ í•¨
      // ë§Œì•½ ì—¬ê¸° ë„ë‹¬í•˜ë©´ login.htmlë¡œ ë¦¬ë””ë ‰ì…˜
      console.log('ğŸ” ë¡œê·¸ì¸ í•„ìš” - login.htmlë¡œ ì´ë™');
      window.location.href = 'login.html';
    }
    
    // ë¡œê·¸ì•„ì›ƒ
    async function signOut() {
      try {
        // Firebase ë¡œê·¸ì•„ì›ƒ
        await auth.signOut();
        
        currentUser = null;
        savedCompanies = {};
        
        console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ - login.htmlë¡œ ì´ë™');
        window.location.href = 'login.html';
      } catch (error) {
        console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        // ì˜¤ë¥˜ê°€ ë‚˜ë„ login.htmlë¡œ ì´ë™
        window.location.href = 'login.html';
      }
    }
    
    // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ (ê¸°ì¡´ saveToDrive ëŒ€ì²´)
    async function saveToDrive(data) {
      try {
        console.log('ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ ì¤‘...');
        
        // ë°ì´í„° ì•”í˜¸í™”
        const encryptedData = encryptData(data);
        const fileContent = JSON.stringify({ 
          encryptedData, 
          timestamp: new Date().toISOString() 
        });
        
        // localStorageì— ì €ì¥
        localStorage.setItem('kfpc-bizinfo-data', fileContent);
        
        console.log('âœ… ë¡œì»¬ ì €ì¥ ì™„ë£Œ');
        return true;
      } catch (error) {
        console.error('âŒ ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨:', error);
        return false;
      }
    }
    
    // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ì¡´ loadFromDrive ëŒ€ì²´)
    async function loadFromDrive() {
      try {
        console.log('ğŸ“¥ ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        const fileContent = localStorage.getItem('kfpc-bizinfo-data');
        
        if (!fileContent) {
          console.log('ğŸ“ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (ìƒˆë¡œìš´ ì‚¬ìš©ì)');
          return false;
        }
        
        const fileData = JSON.parse(fileContent);
        const decryptedData = decryptData(fileData.encryptedData);
        
        if (decryptedData) {
          // í•˜ìœ„ í˜¸í™˜ì„±: ìƒˆ í˜•ì‹(companies í¬í•¨)ì´ë©´ companiesë§Œ ì¶”ì¶œ
          if (decryptedData.companies) {
            savedCompanies = decryptedData.companies;
          } else {
            savedCompanies = decryptedData;
          }
          
          updateCompanySelect();
          console.log('âœ… ë¡œì»¬ ë¡œë“œ ì™„ë£Œ:', Object.keys(savedCompanies).length, 'ê°œ ê³ ê°ì‚¬');
          return true;
        }
        
        return false;
      } catch (error) {
        console.error('âŒ ë¡œì»¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        return false;
      }
    }
    
    // ==================== AES-256 ì•”í˜¸í™” ====================
    
    // AES-256 ì•”í˜¸í™” í‚¤ (ì•± ê³ ìœ  í‚¤)
    const ENCRYPTION_KEY = 'KFPC-BizInfo-2025-AES256-SecureKey';
    
    let savedCompanies = {};

    // ì•”í˜¸í™” í•¨ìˆ˜
    function encryptData(data) {
      return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
    }
    
    // ë³µí˜¸í™” í•¨ìˆ˜
    function decryptData(encryptedData) {
      try {
        const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
        return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
      } catch (e) {
        console.error('ë³µí˜¸í™” ì‹¤íŒ¨:', e);
        return null;
      }
    }
    
    // ==================== ìˆ«ì í¬ë§·íŒ… ====================
    function formatNumber(value) {
      if (!value) return '';
      
      // ë§ˆì´ë„ˆìŠ¤ ë¶€í˜¸ í™•ì¸
      const isNegative = String(value).trim().startsWith('-');
      
      // ìˆ«ìë§Œ ì¶”ì¶œ
      const numStr = String(value).replace(/[^\d]/g, '');
      if (!numStr) return '';
      
      // ì½¤ë§ˆ ì¶”ê°€
      const formatted = numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      
      // ë§ˆì´ë„ˆìŠ¤ ë³µì›
      return isNegative ? '-' + formatted : formatted;
    }
    
    function unformatNumber(value) {
      if (!value) return '';
      // ì½¤ë§ˆ ì œê±°í•˜ê³  ìˆœìˆ˜ ìˆ«ìë§Œ ë°˜í™˜
      return String(value).replace(/,/g, '');
    }
    
    function attachNumberFormatting() {
      // ëª¨ë“  ìˆ«ì ì…ë ¥ í•„ë“œ ID ëª©ë¡ (ì†Œìˆ˜ì  í•„ë“œ ì œì™¸)
      const numberFields = [
        // Section 3: ì¬ë¬´ ì •ë³´
        'revenue-recent',
        // Section 4: ê³ ìš© ì •ë³´
        'employees-total', 'employees-youth', 
        'employees-female', 'employees-disabled', 'employment-growth',
        // Section 5: ê¸°ìˆ  ì •ë³´
        'patents-registered',
        // Section 6: ìˆ˜ì¶œ ì •ë³´
        'export-recent'
      ];
      
      numberFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          // typeì„ textë¡œ ë³€ê²½í•˜ê³  inputmode ì¶”ê°€
          field.type = 'text';
          field.setAttribute('inputmode', 'numeric');
          
          // input ì´ë²¤íŠ¸ë¡œ ì‹¤ì‹œê°„ í¬ë§·íŒ…
          field.addEventListener('input', function(e) {
            const cursorPos = this.selectionStart;
            const oldLength = this.value.length;
            
            // í¬ë§·íŒ… ì ìš©
            const formatted = formatNumber(this.value);
            this.value = formatted;
            
            // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
            const newLength = formatted.length;
            const lengthDiff = newLength - oldLength;
            
            // ìˆ«ì ì…ë ¥ ì¤‘ ì½¤ë§ˆê°€ ì¶”ê°€ë˜ë©´ ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
            if (lengthDiff > 0 && cursorPos < newLength) {
              this.setSelectionRange(cursorPos + lengthDiff, cursorPos + lengthDiff);
            } else {
              this.setSelectionRange(cursorPos, cursorPos);
            }
          });
          
          // blur ì´ë²¤íŠ¸ë¡œ ìµœì¢… í¬ë§·íŒ…
          field.addEventListener('blur', function() {
            this.value = formatNumber(this.value);
          });
        }
      });
      
      console.log('âœ… ìˆ«ì í•„ë“œ ì‹¤ì‹œê°„ ì½¤ë§ˆ í¬ë§·íŒ… í™œì„±í™” (' + numberFields.length + 'ê°œ í•„ë“œ)');
    }

    async function initializeApp() {
      try {
        console.log('ğŸš€ ì•± ì´ˆê¸°í™”');
        
        // ì—°ê²° ìƒíƒœ ë²„íŠ¼ ì´ˆê¸°í™”
        updateConnectionStatus('connecting');
        
        // KSIC ë°ì´í„° ë¡œë“œ
        loadKsicData();
        
        // Firebase ì¸ì¦ ìƒíƒœ í™•ì¸ (login.htmlì—ì„œ ì´ë¯¸ ë¡œê·¸ì¸ë¨)
        auth.onAuthStateChanged(async (user) => {
          const authLoadingScreen = document.getElementById('auth-loading-screen');
          const authStatusText = document.getElementById('auth-status-text');
          
          if (user) {
            // login.htmlì—ì„œ ë¡œê·¸ì¸ ì™„ë£Œëœ ìƒíƒœ
            const userId = user.email.split('@')[0]; // user123@system.local â†’ user123
            console.log('âœ… ë¡œê·¸ì¸ í™•ì¸:', userId);
            
            // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            if (authStatusText) {
              authStatusText.textContent = 'ë°ì´í„° ë¡œë”© ì¤‘...';
            }
            
            // ì‚¬ìš©ì ì •ë³´ ì €ì¥
            currentUser = { 
              email: user.email,
              userId: userId,
              uid: user.uid
            };
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
            if (authLoadingScreen) authLoadingScreen.style.display = 'none';
            document.getElementById('login-screen').style.display = 'none';
            hideLoading();
            
            // ì €ì¥ ì•ˆë‚´ íŒì—… í‘œì‹œ
            const storagePopup = document.getElementById('storage-notice-popup');
            storagePopup.style.display = 'flex';
            
            // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì¸ í™”ë©´ í‘œì‹œ
            document.getElementById('storage-notice-confirm').onclick = async function() {
              // íŒì—… ìˆ¨ê¸°ê¸°
              storagePopup.style.display = 'none';
              
              // ë©”ì¸ í™”ë©´ í‘œì‹œ
              document.getElementById('main-content').style.display = 'block';
              
              // ìˆ«ì í¬ë§·íŒ… í™œì„±í™”
              attachNumberFormatting();
              
              // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë°ì´í„° ë¡œë“œ
              try {
                await loadFromDrive();
                updateConnectionStatus('connected');
                console.log('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', Object.keys(savedCompanies).length, 'ê°œ ê¸°ì—…');
              } catch (error) {
                console.error('ë¡œì»¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                updateConnectionStatus('connected'); // ë°ì´í„° ì—†ì–´ë„ ì—°ê²°ë¨
              }
            };
          } else {
            // ë¡œê·¸ì¸ ì•ˆ ë¨ â†’ login.htmlë¡œ ì´ë™
            console.log('âš ï¸ ë¡œê·¸ì¸ í•„ìš” - login.htmlë¡œ ì´ë™');
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
            if (authLoadingScreen) authLoadingScreen.style.display = 'none';
            hideLoading();
            
            // ì ì‹œ ëŒ€ê¸° í›„ ë¦¬ë””ë ‰ì…˜ (ìŠ¤í”¼ë„ˆ ë³´ì—¬ì£¼ê¸°)
            document.getElementById('login-screen').style.display = 'flex';
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 1500);
          }
        });
        
      } catch (error) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        updateConnectionStatus('error');
        hideLoading();
      }
    }
    
    /**
     * ì—°ê²° ìƒíƒœ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ë¡œì»¬ ì €ì¥ì†Œìš©ìœ¼ë¡œ ë‹¨ìˆœí™”)
     */
    function updateConnectionStatus(status, autoReconnect = true) {
      const btn = document.getElementById('connection-status-btn');
      if (!btn) return;
      
      switch(status) {
        case 'connecting':
          btn.innerHTML = '<span style="font-size: 0.9rem;">â³</span> ë¡œë”© ì¤‘...';
          btn.style.background = '#6c757d';
          btn.style.color = '#fff';
          btn.style.cursor = 'default';
          break;
        case 'connected':
          btn.innerHTML = '<span style="font-size: 0.9rem;">âœ“</span> ë¡œì»¬ì €ì¥';
          btn.style.background = '#28a745';
          btn.style.color = '#fff';
          btn.style.cursor = 'default';
          break;
        case 'disconnected':
        case 'no-data':
        case 'error':
          btn.innerHTML = '<span style="font-size: 0.9rem;">â„¹</span> ë¡œì»¬ì €ì¥';
          btn.style.background = '#17a2b8';
          btn.style.color = '#fff';
          btn.style.cursor = 'default';
          break;
      }
    }
    
    /**
     * connectDrive (ë¡œì»¬ ì €ì¥ì†Œìš©ìœ¼ë¡œ ë‹¨ìˆœí™”)
     */
    async function connectDrive() {
      // ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš© - ë³„ë„ ì—°ê²° ë¶ˆí•„ìš”
      console.log('â„¹ï¸ ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš© ì¤‘');
    }
    
    function hideLoading() {
      const loading = document.getElementById('loading-screen');
      loading.classList.add('hide');
      setTimeout(() => loading.style.display = 'none', 300);
    }
    
    /**
     * ì €ì¥ ì¤‘ í‘œì‹œ (ì¦‰ì‹œ í”¼ë“œë°±)
     */
    function showSavingIndicator(message = 'ì €ì¥ ì¤‘...') {
      // ê¸°ì¡´ í‘œì‹œê°€ ìˆìœ¼ë©´ ì œê±°
      hideSavingIndicator();
      
      const indicator = document.createElement('div');
      indicator.id = 'saving-indicator';
      indicator.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 1.5rem 2.5rem;
        border-radius: 16px;
        z-index: 99999;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        font-size: 1rem;
        font-weight: 600;
      `;
      indicator.innerHTML = `
        <div style="width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
        <span>${message}</span>
      `;
      
      // ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
      if (!document.getElementById('saving-spinner-style')) {
        const style = document.createElement('style');
        style.id = 'saving-spinner-style';
        style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
        document.head.appendChild(style);
      }
      
      document.body.appendChild(indicator);
    }
    
    /**
     * ì €ì¥ ì¤‘ í‘œì‹œ ì œê±°
     */
    function hideSavingIndicator() {
      const indicator = document.getElementById('saving-indicator');
      if (indicator) {
        indicator.remove();
      }
    }
    
    function collectFormData() {
      // ì•ˆì „í•œ ê°’ ê°€ì ¸ì˜¤ê¸° í—¬í¼ í•¨ìˆ˜
      const getVal = (id) => document.getElementById(id)?.value || '';
      const getNumVal = (id) => unformatNumber(document.getElementById(id)?.value || '');
      const getChecked = (selector) => {
        const elements = document.querySelectorAll(selector);
        return elements ? Array.from(elements).filter(el => el.checked).map(el => el.value) : [];
      };
      
      // ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ 3ê°œ input í•©ì¹˜ê¸°
      const bizNum1 = getVal('business-number-1');
      const bizNum2 = getVal('business-number-2');
      const bizNum3 = getVal('business-number-3');
      const businessNumber = bizNum1 && bizNum2 && bizNum3 ? `${bizNum1}-${bizNum2}-${bizNum3}` : '';
      
      // ëª¨ë“  ì…ë ¥ í•„ë“œ ë°ì´í„° ìˆ˜ì§‘
      const data = {
        // Section 1: ê¸°ì—… ê¸°ë³¸ì •ë³´
        companyName: getVal('company-name'),
        businessNumber: businessNumber,
        establishDate: getVal('establish-date'),
        companySize: getVal('company-size'),
        companyType: getVal('company-type'),
        businessStatus: getVal('business-status'),
        ksicCode: getVal('ksic-code'),
        productKeywords: [getVal('product-1'), getVal('product-2'), getVal('product-3'), getVal('product-4')].filter(Boolean).join(', '),
        locationSido: getVal('location-sido'),
        locationSigungu: getVal('location-sigungu'),
        industrialComplex: getVal('industrial-complex'),
        capitalArea: getVal('capital-area'),
        
        // Section 2: ëŒ€í‘œì ì •ë³´
        ceoBirth: getVal('ceo-birth'),
        ceoGender: getVal('ceo-gender'),
        
        // Section 3: ì¬ë¬´ ë° ì‹ ìš©ì •ë³´
        revenueRecent: getNumVal('revenue-recent'),
        profitRecent: getNumVal('profit-recent'),
        debtRatio: getNumVal('debt-ratio'),
        taxArrears: getVal('tax-arrears'),
        localTaxArrears: getVal('local-tax-arrears'),
        insuranceArrears: getVal('insurance-arrears'),
        capitalErosion: getVal('capital-erosion'),
        bankruptcyHistory: getVal('bankruptcy-history'),
        tcbRating: getVal('tcb-rating'),
        
        // Section 4: ê³ ìš© ì •ë³´
        employeesTotal: getNumVal('employees-total'),
        employeesYouth: getNumVal('employees-youth'),
        employeesFemale: getNumVal('employees-female'),
        employeesDisabled: getNumVal('employees-disabled'),
        employmentGrowth: getNumVal('employment-growth'),
        
        // Section 5: ê¸°ìˆ  ë° ì¸ì¦ ì •ë³´
        certVenture: getVal('cert-venture'),
        certInnobiz: getVal('cert-innobiz'),
        certMainbiz: getVal('cert-mainbiz'),
        certWoman: getVal('cert-woman'),
        certDisabled: getVal('cert-disabled'),
        certSocial: getVal('cert-social'),
        esgStatus: getVal('esg-status'),
        researchOrg: getVal('research-org'),
        patentsRegistered: getNumVal('patents-registered'),
        
        // Section 6: ìˆ˜ì¶œ ì •ë³´
        exportRecent: getNumVal('export-recent'),
        exportCountries: getVal('export-countries'),
        
        // Section 7: í¬ë§ ì§€ì›ë¶„ì•¼
        supportNeeds: getChecked('#support-finance, #support-tech, #support-manpower, #support-export, #support-domestic, #support-startup, #support-management, #support-etc, #support-all')
      };
      
      return data;
    }
    
    // í˜„ì¬ ì •ë ¬ ìƒíƒœ
    let currentSortType = 'name';
    let currentModalSortType = 'name'; // ëª¨ë‹¬ ì •ë ¬ íƒ€ì…
    let selectedCompanyId = null;
    
    function updateCompanySelect() {
      const select = document.getElementById('company-select');
      select.innerHTML = '<option value="">-- ìƒˆë¡œ ì…ë ¥ --</option>';
      
      Object.keys(savedCompanies).forEach(id => {
        const company = savedCompanies[id];
        const option = document.createElement('option');
        option.value = id;
        option.textContent = `${company.companyName} (${company.companySize})`;
        select.appendChild(option);
      });
    }
    
    function formatDate(dateStr) {
      try {
        const date = new Date(dateStr);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month}.${day}`;
      } catch {
        return '';
      }
    }
    
    function selectCompanyFromList(companyId) {
      selectedCompanyId = companyId;
      
      // ë“œë¡­ë‹¤ìš´ë„ ë™ê¸°í™”
      document.getElementById('company-select').value = companyId;
      
      // í¼ì— ë°ì´í„° ë¡œë“œ
      loadSelectedCompany();
    }
    
    // ==================== ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ====================
    
    function openCompanyListModal() {
      const modal = document.getElementById('company-list-modal');
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
      
      // ESC í‚¤ ì´ë²¤íŠ¸ ì¶”ê°€
      const escHandler = (e) => {
        if (e.key === 'Escape') {
          closeCompanyListModal();
        }
      };
      document.addEventListener('keydown', escHandler);
      modal._escHandler = escHandler; // ë‚˜ì¤‘ì— ì œê±°í•˜ê¸° ìœ„í•´ ì €ì¥
      
      // ëª¨ë‹¬ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
      renderModalCompanyList();
    }
    
    function closeCompanyListModal() {
      const modal = document.getElementById('company-list-modal');
      modal.style.display = 'none';
      document.body.style.overflow = 'auto'; // ìŠ¤í¬ë¡¤ ë³µì›
      
      // ESC í‚¤ ì´ë²¤íŠ¸ ì œê±°
      if (modal._escHandler) {
        document.removeEventListener('keydown', modal._escHandler);
        modal._escHandler = null;
      }
      
      // ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
      document.getElementById('modal-company-search').value = '';
    }
    
    /**
     * ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ - ë¡œì»¬ ì €ì¥ì†Œ ë‹¤ì‹œ ë¡œë“œ
     */
    async function refreshDriveConnection() {
      try {
        // ë¡œë”© í‘œì‹œ
        const refreshBtn = event.target.closest('button');
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = 'â³ ë¡œë”© ì¤‘...';
        refreshBtn.disabled = true;
        
        // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë‹¤ì‹œ ë¡œë“œ
        try {
          await loadFromDrive();
          updateConnectionStatus('connected');
          renderModalCompanyList();
          
          // ì„±ê³µ ì•Œë¦¼
          alert('âœ… ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!\n\n' + Object.keys(savedCompanies).length + 'ê°œ ê³ ê°ì‚¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
        
        // ë²„íŠ¼ ë³µì›
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        
      } catch (error) {
        console.error('ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
        alert('âŒ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
      }
    }
    
    function renderModalCompanyList() {
      const listContainer = document.getElementById('modal-company-list');
      const searchTerm = document.getElementById('modal-company-search')?.value?.toLowerCase() || '';
      
      // ê¸°ì—… ëª©ë¡ ë°°ì—´ë¡œ ë³€í™˜
      let companies = Object.keys(savedCompanies).map(id => ({
        id: id,
        ...savedCompanies[id]
      }));
      
      // ê²€ìƒ‰ í•„í„°
      if (searchTerm) {
        companies = companies.filter(c => 
          c.companyName?.toLowerCase().includes(searchTerm)
        );
      }
      
      // ì •ë ¬
      if (currentModalSortType === 'name') {
        companies.sort((a, b) => (a.companyName || '').localeCompare(b.companyName || '', 'ko'));
      } else if (currentModalSortType === 'date') {
        companies.sort((a, b) => {
          const dateA = a.savedAt ? new Date(a.savedAt) : new Date(0);
          const dateB = b.savedAt ? new Date(b.savedAt) : new Date(0);
          return dateB - dateA;
        });
      }
      
      // ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´
      if (companies.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">' + 
          (searchTerm ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ì €ì¥ëœ ê³ ê°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤') + 
          '</div>';
        return;
      }
      
      // ëª©ë¡ ë Œë”ë§
      listContainer.innerHTML = companies.map(company => {
        const isSelected = selectedCompanyId === company.id;
        const savedDate = company.savedAt ? formatDateFull(company.savedAt) : '';
        const meta = [company.companySize, company.ksicCode].filter(Boolean).join(' Â· ');
        
        return `
          <div style="
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background: ${isSelected ? 'rgba(255,210,127,0.2)' : 'rgba(255,255,255,0.05)'};
            border: 1px solid ${isSelected ? 'rgba(255,210,127,0.5)' : 'rgba(255,255,255,0.1)'};
            border-radius: 8px;
            transition: all 0.2s;
          ">
            <div style="display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;">
              <div onclick="selectCompanyFromModal('${company.id}')" style="flex: 1; min-width: 0; cursor: pointer;" onmouseover="this.parentElement.parentElement.style.background='rgba(255,255,255,0.15)'" onmouseout="this.parentElement.parentElement.style.background='${isSelected ? 'rgba(255,210,127,0.2)' : 'rgba(255,255,255,0.05)'}'">
                <div style="font-weight: 600; font-size: 0.95rem; color: ${isSelected ? '#ffd27f' : 'white'}; margin-bottom: 0.3rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  ${company.companyName || '(ì´ë¦„ì—†ìŒ)'}
                </div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">
                  ${meta || 'ì •ë³´ ì—†ìŒ'} ${savedDate ? 'Â· ' + savedDate : ''}
                </div>
              </div>
              <button onclick="event.stopPropagation(); deleteCompanyFromModal('${company.id}', '${(company.companyName || '').replace(/'/g, "\\'")}');" style="
                padding: 0.4rem 0.6rem;
                background: rgba(255,100,100,0.2);
                border: 1px solid rgba(255,100,100,0.5);
                border-radius: 6px;
                color: #ffaaaa;
                font-size: 0.75rem;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(255,100,100,0.4)'" onmouseout="this.style.background='rgba(255,100,100,0.2)'">
                ğŸ—‘ï¸ ì‚­ì œ
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function formatDateFull(dateStr) {
      try {
        const date = new Date(dateStr);
        const year = date.getFullYear().toString().slice(2);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}.${month}.${day}`;
      } catch {
        return '';
      }
    }
    
    function selectCompanyFromModal(companyId) {
      selectedCompanyId = companyId;
      
      // íšŒì‚¬ëª… í‘œì‹œ
      const company = savedCompanies[companyId];
      if (company) {
        document.getElementById('company-name-search').value = company.companyName;
      }
      
      // ë“œë¡­ë‹¤ìš´ë„ ë™ê¸°í™”
      document.getElementById('company-select').value = companyId;
      
      // í¼ì— ë°ì´í„° ë¡œë“œ
      loadSelectedCompany();
      
      // ëª¨ë‹¬ ë‹«ê¸°
      closeCompanyListModal();
    }
    
    /**
     * ëª¨ë‹¬ì—ì„œ ê³ ê°ì‚¬ ì‚­ì œ
     */
    async function deleteCompanyFromModal(companyId, companyName) {
      if (!confirm(`"${companyName}" ê³ ê°ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
      }
      
      try {
        // ë¡œì»¬ ê°ì²´ì—ì„œ ì‚­ì œ
        delete savedCompanies[companyId];
        
        // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ (ì‚­ì œ ë°˜ì˜)
        const success = await saveToDrive(savedCompanies);
        
        if (!success) {
          throw new Error('ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨');
        }
        
        // í˜„ì¬ ì„ íƒëœ íšŒì‚¬ì¸ ê²½ìš° í¼ ì´ˆê¸°í™”
        if (selectedCompanyId === companyId) {
          selectedCompanyId = null;
          clearForm();
          document.getElementById('company-name-search').value = '';
        }
        
        // ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
        renderModalCompanyList();
        updateCompanySelect();
        
        // ì—°ê²° ìƒíƒœëŠ” í•­ìƒ connected (Drive ì—°ê²° ìœ ì§€)
        updateConnectionStatus('connected');
        
        console.log('âœ… ê³ ê°ì‚¬ ì‚­ì œ ì™„ë£Œ:', companyName);
      } catch (error) {
        console.error('âŒ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    function sortModalList(type) {
      currentModalSortType = type;
      
      // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
      const nameBtn = document.getElementById('modal-sort-name');
      const dateBtn = document.getElementById('modal-sort-date');
      
      if (type === 'name') {
        nameBtn.classList.add('active');
        dateBtn.classList.remove('active');
        nameBtn.style.background = 'rgba(255,255,255,0.2)';
        dateBtn.style.background = 'rgba(255,255,255,0.1)';
      } else {
        nameBtn.classList.remove('active');
        dateBtn.classList.add('active');
        nameBtn.style.background = 'rgba(255,255,255,0.1)';
        dateBtn.style.background = 'rgba(255,255,255,0.2)';
      }
      
      renderModalCompanyList();
    }
    
    function filterModalList() {
      renderModalCompanyList();
    }
    
    function searchCompany() {
      const searchInput = document.getElementById('company-name-search').value.trim();
      
      if (!searchInput) {
        alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì €ì¥ëœ ê³ ê°ì‚¬ ì¤‘ ê²€ìƒ‰
      const found = Object.keys(savedCompanies).find(id => 
        savedCompanies[id].companyName?.toLowerCase() === searchInput.toLowerCase()
      );
      
      if (found) {
        selectCompanyFromModal(found);
      } else {
        alert(`"${searchInput}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nëª©ë¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥ëœ ê³ ê°ì‚¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
      }
    }
    
    // ==================== ê¸°ì¡´ í•¨ìˆ˜ ====================
    
    function loadSelectedCompany() {
      const companyId = selectedCompanyId || document.getElementById('company-select').value;
      
      if (!companyId) {
        clearForm();
        return;
      }
      
      const company = savedCompanies[companyId];
      if (!company) return;
      
      // ë¡œë”© ì¤‘ í”Œë˜ê·¸ ì„¤ì • (KSIC ê²½ê³  ë°©ì§€)
      isLoadingCompany = true;
      
      // ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ë¶„ë¦¬ (123-45-67890 â†’ 3ê°œ input)
      if (company.businessNumber) {
        const bizParts = company.businessNumber.split('-');
        if (bizParts.length === 3) {
          document.getElementById('business-number-1').value = bizParts[0];
          document.getElementById('business-number-2').value = bizParts[1];
          document.getElementById('business-number-3').value = bizParts[2];
        }
      }
      
      // ìˆ«ì í•„ë“œ ëª©ë¡
      const numberFieldKeys = [
        'revenueRecent', 'profitRecent', 'debtRatio',
        'employeesTotal', 'employeesYouth', 
        'employeesFemale', 'employeesDisabled', 'employmentGrowth',
        'patentsRegistered', 'exportRecent'
      ];
      
      // ëª¨ë“  í•„ë“œì— ë°ì´í„° ë¡œë“œ
      Object.keys(company).forEach(key => {
        // businessNumberëŠ” ì´ë¯¸ ì²˜ë¦¬, corpNumberëŠ” ì‚­ì œëœ í•„ë“œì´ë¯€ë¡œ ìŠ¤í‚µ
        if (key === 'businessNumber' || key === 'corpNumber') return;
        
        const element = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
        if (element) {
          if (element.type === 'checkbox') {
            element.checked = company[key].includes(element.value);
          } else if (element.type === 'radio') {
            if (element.value === company[key]) element.checked = true;
          } else {
            // ìˆ«ì í•„ë“œëŠ” ì½¤ë§ˆ ì¶”ê°€
            if (numberFieldKeys.includes(key)) {
              element.value = formatNumber(company[key]);
            } else {
              element.value = company[key];
            }
          }
        }
      });
      
      // ì£¼ë ¥ì œí’ˆ ë¶„ë¦¬ ë¡œë“œ
      if (company.productKeywords) {
        const products = company.productKeywords.split(',').map(p => p.trim());
        for (let i = 0; i < 4; i++) {
          const el = document.getElementById('product-' + (i + 1));
          if (el) el.value = products[i] || '';
        }
      }
      
      // ì˜ì—…ì´ìµ ì†ì‹¤ ì²´í¬ë°•ìŠ¤ ì„¤ì •
      if (company.profitRecent) {
        const profitCheckbox = document.getElementById('profit-loss');
        const profitInput = document.getElementById('profit-recent');
        if (profitCheckbox && profitInput) {
          const isLoss = String(company.profitRecent).startsWith('-');
          profitCheckbox.checked = isLoss;
          if (isLoss) {
            profitInput.style.color = '#ff6b6b';
          } else {
            profitInput.style.color = '#333';
          }
        }
      }
      
      // ì—…ë ¥ ê³„ì‚° í‘œì‹œ
      if (company.establishDate) {
        calculateBusinessAge();
      }
      
      // KSIC ì½”ë“œ ê³„ì¸µí˜• ë“œë¡­ë‹¤ìš´ì— ë¡œë“œ
      if (company.ksicCode) {
        const code = String(company.ksicCode).padStart(5, '0');
        // ê³„ì¸µí˜• ë“œë¡­ë‹¤ìš´ ì„¤ì •
        setTimeout(() => {
          setKsicFromCode(code);
        }, 500); // KSIC ë°ì´í„° ë¡œë“œ í›„ ì„¤ì •
      }
      
      // ì‹œë„ ì„ íƒ í›„ ì‹œêµ°êµ¬ ì˜µì…˜ ì—…ë°ì´íŠ¸
      if (company.locationSido) {
        updateSigunguOptions();
        // ì‹œêµ°êµ¬ ê°’ ì„¤ì • (ì˜µì…˜ ìƒì„± í›„)
        if (company.locationSigungu) {
          document.getElementById('location-sigungu').value = company.locationSigungu;
        }
      }
      
      // í¬ë§ ì§€ì›ë¶„ì•¼ ì²´í¬ë°•ìŠ¤ ë¡œë“œ
      if (company.supportNeeds && Array.isArray(company.supportNeeds)) {
        const checkboxMap = {
          'ê¸ˆìœµ': 'support-finance',
          'ê¸°ìˆ ': 'support-tech',
          'ì¸ë ¥': 'support-manpower',
          'ìˆ˜ì¶œ': 'support-export',
          'ë‚´ìˆ˜': 'support-domestic',
          'ì°½ì—…': 'support-startup',
          'ê²½ì˜': 'support-management',
          'ê¸°íƒ€': 'support-etc',
          'ì „ì²´': 'support-all'
        };
        
        // ë¨¼ì € ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
        Object.values(checkboxMap).forEach(id => {
          const el = document.getElementById(id);
          if (el) el.checked = false;
        });
        
        // ì €ì¥ëœ ê°’ì— í•´ë‹¹í•˜ëŠ” ì²´í¬ë°•ìŠ¤ ì²´í¬
        company.supportNeeds.forEach(need => {
          const checkboxId = checkboxMap[need];
          if (checkboxId) {
            const el = document.getElementById(checkboxId);
            if (el) el.checked = true;
          }
        });
      }
      
      console.log('âœ… ê³ ê°ì‚¬ ì •ë³´ ë¡œë“œ:', company.companyName);
      
      // ë¡œë”© ì™„ë£Œ í”Œë˜ê·¸ í•´ì œ
      isLoadingCompany = false;
      
      // ì €ì¥ëœ ë§ì¶¤ì§€ì›ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
      if (company.matchedPrograms && company.matchedPrograms.length > 0) {
        lastMatchedPrograms = company.matchedPrograms;
        lastCompanyData = collectFormData(); // í˜„ì¬ í¼ ë°ì´í„°ë¡œ ì„¤ì •
        displayResults({ recommendations: company.matchedPrograms });
        hasCompletedSearch = true;
        console.log('âœ… ì €ì¥ëœ ë§ì¶¤ì§€ì›ì •ë³´ ë¡œë“œ:', company.matchedPrograms.length, 'ê°œ');
        
        // ì €ì¥ëœ AI ìš”ì•½ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë¡œë“œ
        if (company.aiSummary && company.aiSummary.length > 0) {
          lastSummaryResults = company.aiSummary;
          console.log('âœ… ì €ì¥ëœ ìš”ì•½ë¶„ì„ ë¡œë“œ:', company.aiSummary.length, 'ê°œ');
          // ìš”ì•½ë¶„ì„ ê²°ê³¼ í‘œì‹œ
          setTimeout(() => {
            updateResultsWithSummary(company.aiSummary);
          }, 200);
        } else {
          lastSummaryResults = [];
        }
        
        // ì €ì¥ëœ AI ìƒì„¸ë¶„ì„(ë§ì¶¤í˜•ë¶„ì„) ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
        if (company.aiDetail && company.aiDetail.length > 0) {
          lastDetailResults = company.aiDetail;
          // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ìƒì„¸ë¶„ì„ ê²°ê³¼ í‘œì‹œ (ì¹´ë“œ ë Œë”ë§ í›„)
          setTimeout(() => {
            updateResultsWithPDFDetail(company.aiDetail);
            console.log('âœ… ì €ì¥ëœ ë§ì¶¤í˜•ë¶„ì„ ë¡œë“œ:', company.aiDetail.length, 'ê°œ');
          }, 400);
        } else {
          lastDetailResults = [];
        }
      } else {
        // ë§ì¶¤ì§€ì›ì •ë³´ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        const resultsSection = document.getElementById('results-section');
        if (resultsSection) {
          resultsSection.innerHTML = '';
          resultsSection.style.display = 'none';
        }
        lastMatchedPrograms = [];
        lastSummaryResults = [];
        lastDetailResults = [];
        hasCompletedSearch = false;
      }
    }
    
    async function saveCompany() {
      const companyData = collectFormData();
      
      if (!companyData.companyName) {
        alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!companyData.businessNumber) {
        alert('ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ğŸ†• ì¦‰ì‹œ ì €ì¥ ì¤‘ í‘œì‹œ
      showSavingIndicator('ê¸°ì—…ì •ë³´ ì €ì¥ ì¤‘...');
      
      // ê¸°ì¡´ ê¸°ì—… ìˆ˜ì •ì¸ì§€ ì‹ ê·œì¸ì§€ í™•ì¸
      const companyId = selectedCompanyId || Date.now().toString();
      savedCompanies[companyId] = {
        ...companyData,
        savedAt: new Date().toISOString()
      };
      
      // ë¡œì»¬ ì €ì¥ì†Œì— ì•”í˜¸í™”í•˜ì—¬ ì €ì¥
      const success = await saveToDrive(savedCompanies);
      
      // ğŸ†• ì €ì¥ ì¤‘ í‘œì‹œ ì œê±°
      hideSavingIndicator();
      
      if (success) {
        selectedCompanyId = companyId;
        updateCompanySelect();
        
        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        updateConnectionStatus('connected');
        
        // íšŒì‚¬ëª… ì…ë ¥ì°½ ì—…ë°ì´íŠ¸
        document.getElementById('company-name-search').value = companyData.companyName;
        
        alert('âœ… ê¸°ì—…ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        console.log('ğŸ’¾ ê³ ê°ì‚¬ ì €ì¥ ì™„ë£Œ (ë¡œì»¬ ì €ì¥ì†Œ + ì•”í˜¸í™”)');
      } else {
        alert('âŒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }
    
    /**
     * ê¸°ì—…ì •ë³´ + ì§€ì›ì‚¬ì—… í•¨ê»˜ ì €ì¥
     */
    async function saveWithPrograms() {
      const companyData = collectFormData();
      
      if (!companyData.companyName) {
        alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!companyData.businessNumber) {
        alert('ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ë§ì¶¤ì°¾ê¸° ê²°ê³¼ í™•ì¸
      if (!lastMatchedPrograms || lastMatchedPrograms.length === 0) {
        alert('âš ï¸ ë¨¼ì € "ì§€ì›ì‚¬ì—…+ë¶„ì„"ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”!\n\nì§€ì›ì‚¬ì—…+ë¶„ì„ ê²°ê³¼ê°€ ìˆì–´ì•¼ ì§€ì›ì‚¬ì—…ì„ í•¨ê»˜ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ğŸ†• ì¦‰ì‹œ ì €ì¥ ì¤‘ í‘œì‹œ
      showSavingIndicator('ê¸°ì—…ì •ë³´+ì§€ì›ì‚¬ì—… ì €ì¥ ì¤‘...');
      
      // AI ë¶„ì„ ê²°ê³¼ëŠ” ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´ (HTML íŒŒì‹± ëŒ€ì‹  - ì •í™•í•œ ë°ì´í„° ë³´ì¡´)
      const summaryResultsToSave = lastSummaryResults.length > 0 ? lastSummaryResults : [];
      const detailResultsToSave = lastDetailResults.length > 0 ? lastDetailResults : [];
      
      // ê¸°ì¡´ ê¸°ì—… ìˆ˜ì •ì¸ì§€ ì‹ ê·œì¸ì§€ í™•ì¸
      const companyId = selectedCompanyId || Date.now().toString();
      savedCompanies[companyId] = {
        ...companyData,
        // ë§ì¶¤ì°¾ê¸° ê²°ê³¼ ì €ì¥ (ìƒìœ„ 15ê°œ)
        matchedPrograms: lastMatchedPrograms.slice(0, 15),
        // AI ë¶„ì„ ê²°ê³¼ ì €ì¥ (ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì™€ ì›ë³¸ ë³´ì¡´)
        aiSummary: summaryResultsToSave.length > 0 ? summaryResultsToSave : null,
        aiDetail: detailResultsToSave.length > 0 ? detailResultsToSave : null,
        savedAt: new Date().toISOString()
      };
      
      // ë¡œì»¬ ì €ì¥ì†Œì— ì•”í˜¸í™”í•˜ì—¬ ì €ì¥
      const success = await saveToDrive(savedCompanies);
      
      // ğŸ†• ì €ì¥ ì¤‘ í‘œì‹œ ì œê±°
      hideSavingIndicator();
      
      if (success) {
        selectedCompanyId = companyId;
        updateCompanySelect();
        
        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        updateConnectionStatus('connected');
        
        document.getElementById('company-name-search').value = companyData.companyName;
        
        const savedItems = [];
        savedItems.push('ê¸°ì—…ì •ë³´');
        savedItems.push(`ë§ì¶¤ ì§€ì›ì‚¬ì—… ${lastMatchedPrograms.length}ê±´`);
        if (summaryResultsToSave.length > 0) savedItems.push(`AI ìš”ì•½ë¶„ì„ ${summaryResultsToSave.length}ê±´`);
        if (detailResultsToSave.length > 0) savedItems.push(`AI ë§ì¶¤í˜•ë¶„ì„ ${detailResultsToSave.length}ê±´`);
        
        alert(`âœ… ì €ì¥ ì™„ë£Œ!\n\nì €ì¥ëœ í•­ëª©:\nâ€¢ ${savedItems.join('\nâ€¢ ')}`);
        console.log('ğŸ’¾ ê¸°ì—…ì •ë³´+ì§€ì›ì‚¬ì—… ì €ì¥ ì™„ë£Œ:', savedItems);
      } else {
        alert('âŒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }
    
    /**
     * AIë¶„ì„ í¬í•¨ ì €ì¥ (ìš”ì•½ë¶„ì„ ë˜ëŠ” ìƒì„¸ë¶„ì„ ê²°ê³¼ê°€ ìˆì–´ì•¼ ì €ì¥ ê°€ëŠ¥)
     */
    async function saveWithAIAnalysis() {
      const companyData = collectFormData();
      
      if (!companyData.companyName) {
        alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!companyData.businessNumber) {
        alert('ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ë§ì¶¤ì°¾ê¸° ê²°ê³¼ í™•ì¸
      if (!lastMatchedPrograms || lastMatchedPrograms.length === 0) {
        alert('âš ï¸ ë¨¼ì € "ì§€ì›ì‚¬ì—…+ë¶„ì„"ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      // AI ë¶„ì„ ê²°ê³¼ëŠ” ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´ (HTML íŒŒì‹± ëŒ€ì‹  - ì •í™•í•œ ë°ì´í„° ë³´ì¡´)
      const summaryResultsToSave = lastSummaryResults.length > 0 ? lastSummaryResults : [];
      const detailResultsToSave = lastDetailResults.length > 0 ? lastDetailResults : [];
      
      // AI ë¶„ì„ ê²°ê³¼ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì €ì¥ ë¶ˆê°€
      if (summaryResultsToSave.length === 0 && detailResultsToSave.length === 0) {
        alert('âš ï¸ AI ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤!\n\n"ì§€ì›ì‚¬ì—…+ë¶„ì„" ë˜ëŠ” "ë§ì¶¤í˜•ë¶„ì„"ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.\n\nAI ë¶„ì„ ê²°ê³¼ê°€ ìˆì–´ì•¼ ì´ ë²„íŠ¼ìœ¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ğŸ†• ì¦‰ì‹œ ì €ì¥ ì¤‘ í‘œì‹œ
      showSavingIndicator('ë¶„ì„ê²°ê³¼ í¬í•¨ ì €ì¥ ì¤‘...');
      
      // ê¸°ì¡´ ê¸°ì—… ìˆ˜ì •ì¸ì§€ ì‹ ê·œì¸ì§€ í™•ì¸
      const companyId = selectedCompanyId || Date.now().toString();
      savedCompanies[companyId] = {
        ...companyData,
        // ë§ì¶¤ì°¾ê¸° ê²°ê³¼ ì €ì¥ (ìƒìœ„ 15ê°œ)
        matchedPrograms: lastMatchedPrograms.slice(0, 15),
        // AI ë¶„ì„ ê²°ê³¼ ì €ì¥ (ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì™€ ì›ë³¸ ë³´ì¡´)
        aiSummary: summaryResultsToSave.length > 0 ? summaryResultsToSave : null,
        aiDetail: detailResultsToSave.length > 0 ? detailResultsToSave : null,
        savedAt: new Date().toISOString()
      };
      
      // ë¡œì»¬ ì €ì¥ì†Œì— ì•”í˜¸í™”í•˜ì—¬ ì €ì¥
      const success = await saveToDrive(savedCompanies);
      
      // ğŸ†• ì €ì¥ ì¤‘ í‘œì‹œ ì œê±°
      hideSavingIndicator();
      
      if (success) {
        selectedCompanyId = companyId;
        updateCompanySelect();
        
        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        updateConnectionStatus('connected');
        
        document.getElementById('company-name-search').value = companyData.companyName;
        
        const savedItems = [];
        savedItems.push('ê¸°ì—…ì •ë³´');
        savedItems.push(`ë§ì¶¤ ì§€ì›ì‚¬ì—… ${lastMatchedPrograms.length}ê±´`);
        if (summaryResultsToSave.length > 0) savedItems.push(`AI ìš”ì•½ë¶„ì„ ${summaryResultsToSave.length}ê±´`);
        if (detailResultsToSave.length > 0) savedItems.push(`AI ë§ì¶¤í˜•ë¶„ì„ ${detailResultsToSave.length}ê±´`);
        
        alert(`âœ… ë§ì¶¤í˜•ë¶„ì„ í¬í•¨ ì €ì¥ ì™„ë£Œ!\n\nì €ì¥ëœ í•­ëª©:\nâ€¢ ${savedItems.join('\nâ€¢ ')}`);
        console.log('ğŸ’¾ ë§ì¶¤í˜•ë¶„ì„ í¬í•¨ ì €ì¥ ì™„ë£Œ:', savedItems);
      } else {
        alert('âŒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }
    
    async function deleteCompany() {
      if (!selectedCompanyId) {
        alert('ì‚­ì œí•  ê¸°ì—…ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const company = savedCompanies[selectedCompanyId];
      if (!company) return;
      
      // ì§€ì›ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
      const hasMatchedPrograms = company.matchedPrograms && company.matchedPrograms.length > 0;
      const hasAiSummary = company.aiSummary && company.aiSummary.length > 0;
      const hasAiDetail = company.aiDetail && company.aiDetail.length > 0;
      
      if (!hasMatchedPrograms && !hasAiSummary && !hasAiDetail) {
        alert('ì‚­ì œí•  ì§€ì›ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (!confirm(`"${company.companyName}"ì˜ ì§€ì›ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œ í•­ëª©:\nâ€¢ ë§ì¶¤ ì§€ì›ì‚¬ì—… ${company.matchedPrograms?.length || 0}ê±´\nâ€¢ AI ìš”ì•½ë¶„ì„ ${company.aiSummary?.length || 0}ê±´\nâ€¢ AI ë§ì¶¤í˜•ë¶„ì„ ${company.aiDetail?.length || 0}ê±´\n\nâ€» ê¸°ì—…ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.`)) {
        return;
      }
      
      // ì§€ì›ì •ë³´ë§Œ ì‚­ì œ (ê¸°ì—…ì •ë³´ëŠ” ìœ ì§€)
      delete savedCompanies[selectedCompanyId].matchedPrograms;
      delete savedCompanies[selectedCompanyId].aiSummary;
      delete savedCompanies[selectedCompanyId].aiDetail;
      
      const success = await saveToDrive(savedCompanies);
      
      if (success) {
        // í™”ë©´ì—ì„œ ê²°ê³¼ ì„¹ì…˜ ì´ˆê¸°í™”
        const resultsSection = document.getElementById('results-section');
        if (resultsSection) {
          resultsSection.innerHTML = '';
          resultsSection.style.display = 'none';
        }
        lastMatchedPrograms = [];
        lastSummaryResults = [];
        lastDetailResults = [];
        hasCompletedSearch = false;
        
        alert('ğŸ—‘ï¸ ì§€ì›ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê¸°ì—…ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.');
      } else {
        alert('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    function clearForm() {
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox' || el.type === 'radio') {
          el.checked = false;
        } else if (el.id !== 'company-search' && el.id !== 'modal-company-search') {
          el.value = '';
        }
      });
      document.getElementById('company-select').value = '';
      document.getElementById('company-name-search').value = '';
      selectedCompanyId = null;
      
      // ë§ì¶¤ì§€ì›ì •ë³´ ê²°ê³¼ ì´ˆê¸°í™”
      const resultsSection = document.getElementById('results-section');
      if (resultsSection) {
        resultsSection.innerHTML = '';
        resultsSection.style.display = 'none';
      }
      lastMatchedPrograms = [];
      hasCompletedSearch = false;
    }
    
    // ==================== í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë§¤ì¹­ ì—”ì§„ ====================
    
    /**
     * ì—…ë ¥ ê³„ì‚° (ë…„) - AI ë¶„ì„ìš©
     */
    function getBusinessAgeYears(establishDate) {
      if (!establishDate) return 0;
      const today = new Date();
      const established = new Date(establishDate);
      const years = (today - established) / (365.25 * 24 * 60 * 60 * 1000);
      return Math.floor(years);
    }
    
    /**
     * ë‚˜ì´ ê³„ì‚°
     */
    function calculateAge(birthDate) {
      if (!birthDate) return 0;
      const today = new Date();
      const birth = new Date(birthDate);
      const age = (today - birth) / (365.25 * 24 * 60 * 60 * 1000);
      return Math.floor(age);
    }
    
    /**
     * í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë§¤ì¹­ ì—”ì§„
     * ê¸°ì—…ë§ˆë‹¹ API ë°ì´í„° ê¸°ë°˜ ì§€ì›ì‚¬ì—… ì¶”ì²œ
     */
    async function clientSideMatching(companyData) {
      console.log('ğŸ¯ ë§¤ì¹­ ì‹œì‘:', companyData.companyName);
      
      // 1. ê¸°ì—…ë§ˆë‹¹ APIì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const programs = await fetchBizInfoPrograms();
      
      if (!programs || programs.length === 0) {
        console.log('âš ï¸ ê°€ì ¸ì˜¨ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return [];
      }
      
      console.log(`ğŸ“¦ ${programs.length}ê°œ ê³µê³  ë¡œë“œ ì™„ë£Œ`);
      
      const businessAge = getBusinessAgeYears(companyData.establishDate);
      const ceoAge = calculateAge(companyData.ceoBirth);
      
      console.log(`ğŸ“Š ê¸°ì—… ì •ë³´ - ì—…ë ¥: ${businessAge}ë…„, CEO ë‚˜ì´: ${ceoAge}ì„¸`);
      
      // ========================================
      // ğŸ”¥ ì‚¬ì „ í•„í„°ë§ (AI í˜¸ì¶œ ì „ ë¶€ì í•© ê³µê³  ì œì™¸)
      // ========================================
      const filteredPrograms = programs.filter(program => {
        const programName = program.name || '';
        const organization = program.organization || '';
        const target = (program.target || '').toLowerCase();
        const description = (program.description || '').toLowerCase();
        const combinedText = (programName + ' ' + organization + ' ' + target + ' ' + description).toLowerCase();
        const hashTags = (program.hashTags || '').toLowerCase();
        
        // -----------------------------------------
        // í•„í„° 1: ì‹ ì²­ ë§ˆê° ê³µê³  ì œì™¸
        // -----------------------------------------
        if (program.isOpen === false) {
          console.log(`âŒ [ë§ˆê°] ${programName.substring(0, 30)}`);
          return false;
        }
        
        // -----------------------------------------
        // í•„í„° 2: ì§€ì—­ ë¶ˆì¼ì¹˜ ì œì™¸
        // -----------------------------------------
        const companyRegion = companyData.locationSido || '';
        const isCapitalArea = companyData.capitalArea === 'Y'; // ìˆ˜ë„ê¶Œ ì—¬ë¶€
        
        // ì§€ì—­ëª… ë§¤í•‘
        const regionMapping = {
          'ì„œìš¸': ['ì„œìš¸', 'ì„œìš¸ì‹œ', 'ì„œìš¸íŠ¹ë³„ì‹œ'],
          'ë¶€ì‚°': ['ë¶€ì‚°', 'ë¶€ì‚°ì‹œ', 'ë¶€ì‚°ê´‘ì—­ì‹œ'],
          'ëŒ€êµ¬': ['ëŒ€êµ¬', 'ëŒ€êµ¬ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ'],
          'ì¸ì²œ': ['ì¸ì²œ', 'ì¸ì²œì‹œ', 'ì¸ì²œê´‘ì—­ì‹œ'],
          'ê´‘ì£¼': ['ê´‘ì£¼', 'ê´‘ì£¼ì‹œ', 'ê´‘ì£¼ê´‘ì—­ì‹œ'],
          'ëŒ€ì „': ['ëŒ€ì „', 'ëŒ€ì „ì‹œ', 'ëŒ€ì „ê´‘ì—­ì‹œ'],
          'ìš¸ì‚°': ['ìš¸ì‚°', 'ìš¸ì‚°ì‹œ', 'ìš¸ì‚°ê´‘ì—­ì‹œ'],
          'ì„¸ì¢…': ['ì„¸ì¢…', 'ì„¸ì¢…ì‹œ', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ'],
          'ê²½ê¸°': ['ê²½ê¸°', 'ê²½ê¸°ë„'],
          'ê°•ì›': ['ê°•ì›', 'ê°•ì›ë„', 'ê°•ì›íŠ¹ë³„ìì¹˜ë„'],
          'ì¶©ë¶': ['ì¶©ë¶', 'ì¶©ì²­ë¶ë„'],
          'ì¶©ë‚¨': ['ì¶©ë‚¨', 'ì¶©ì²­ë‚¨ë„'],
          'ì „ë¶': ['ì „ë¶', 'ì „ë¼ë¶ë„', 'ì „ë¶íŠ¹ë³„ìì¹˜ë„'],
          'ì „ë‚¨': ['ì „ë‚¨', 'ì „ë¼ë‚¨ë„'],
          'ê²½ë¶': ['ê²½ë¶', 'ê²½ìƒë¶ë„'],
          'ê²½ë‚¨': ['ê²½ë‚¨', 'ê²½ìƒë‚¨ë„'],
          'ì œì£¼': ['ì œì£¼', 'ì œì£¼ë„', 'ì œì£¼íŠ¹ë³„ìì¹˜ë„']
        };
        
        // ìˆ˜ë„ê¶Œ ì§€ì—­
        const capitalAreaRegions = ['ì„œìš¸', 'ì¸ì²œ', 'ê²½ê¸°'];
        
        // ì „êµ­ ëŒ€ìƒ ê¸°ê´€
        const nationalOrgs = ['ì¤‘ì†Œë²¤ì²˜ê¸°ì—…ë¶€', 'ì‚°ì—…í†µìƒìì›ë¶€', 'ê³¼í•™ê¸°ìˆ ì •ë³´í†µì‹ ë¶€', 'ê³ ìš©ë…¸ë™ë¶€', 
                            'ì¤‘ì†Œê¸°ì—…ì§„í¥ê³µë‹¨', 'ì†Œìƒê³µì¸ì‹œì¥ì§„í¥ê³µë‹¨', 'í•œêµ­ì‚°ì—…ê¸°ìˆ ì§„í¥ì›',
                            'ì°½ì—…ì§„í¥ì›', 'ì •ë³´í†µì‹ ì‚°ì—…ì§„í¥ì›', 'í•œêµ­ë¬´ì—­í˜‘íšŒ', 'ì½”íŠ¸ë¼', 'KOTRA',
                            'í•œêµ­ì½˜í…ì¸ ì§„í¥ì›', 'í•œêµ­í™˜ê²½ì‚°ì—…ê¸°ìˆ ì›', 'í•œêµ­ì—ë„ˆì§€ê³µë‹¨'];
        const isNationalProgram = nationalOrgs.some(org => organization.includes(org));
        
        // ì „êµ­ í‚¤ì›Œë“œ í™•ì¸
        const hasNationalKeyword = combinedText.includes('ì „êµ­') || combinedText.includes('ì „ ì§€ì—­') || hashTags.includes('ì „êµ­');
        
        if (!isNationalProgram && !hasNationalKeyword) {
          // ê³µê³ ì—ì„œ ì§€ì—­ ì¶”ì¶œ
          let programRegion = null;
          const checkText = organization + ' ' + programName;
          
          for (const [region, keywords] of Object.entries(regionMapping)) {
            if (keywords.some(kw => checkText.includes(kw))) {
              programRegion = region;
              break;
            }
          }
          
          // ì‹œ/êµ° ë‹¨ìœ„ì—ì„œ ì§€ì—­ ì¶”ì¶œ
          const cityToRegion = {
            'ì§„ì£¼': 'ê²½ë‚¨', 'ì°½ì›': 'ê²½ë‚¨', 'ê¹€í•´': 'ê²½ë‚¨', 'ì–‘ì‚°': 'ê²½ë‚¨', 'ê±°ì œ': 'ê²½ë‚¨', 'í†µì˜': 'ê²½ë‚¨',
            'ì œì²œ': 'ì¶©ë¶', 'ì²­ì£¼': 'ì¶©ë¶', 'ì¶©ì£¼': 'ì¶©ë¶', 'ì˜¥ì²œ': 'ì¶©ë¶',
            'ì²œì•ˆ': 'ì¶©ë‚¨', 'ì•„ì‚°': 'ì¶©ë‚¨', 'ì„œì‚°': 'ì¶©ë‚¨', 'ë‹¹ì§„': 'ì¶©ë‚¨', 'ë…¼ì‚°': 'ì¶©ë‚¨',
            'í¬í•­': 'ê²½ë¶', 'êµ¬ë¯¸': 'ê²½ë¶', 'ê²½ì£¼': 'ê²½ë¶', 'ì•ˆë™': 'ê²½ë¶', 'ê¹€ì²œ': 'ê²½ë¶',
            'ì „ì£¼': 'ì „ë¶', 'ìµì‚°': 'ì „ë¶', 'êµ°ì‚°': 'ì „ë¶', 'ì •ì': 'ì „ë¶',
            'ëª©í¬': 'ì „ë‚¨', 'ì—¬ìˆ˜': 'ì „ë‚¨', 'ìˆœì²œ': 'ì „ë‚¨', 'ê´‘ì–‘': 'ì „ë‚¨', 'ë‚˜ì£¼': 'ì „ë‚¨',
            'ì¶˜ì²œ': 'ê°•ì›', 'ì›ì£¼': 'ê°•ì›', 'ê°•ë¦‰': 'ê°•ì›', 'ì†ì´ˆ': 'ê°•ì›', 'ë™í•´': 'ê°•ì›',
            'ìˆ˜ì›': 'ê²½ê¸°', 'ì„±ë‚¨': 'ê²½ê¸°', 'ê³ ì–‘': 'ê²½ê¸°', 'ìš©ì¸': 'ê²½ê¸°', 'ì•ˆì–‘': 'ê²½ê¸°', 
            'í™”ì„±': 'ê²½ê¸°', 'í‰íƒ': 'ê²½ê¸°', 'ì•ˆì‚°': 'ê²½ê¸°', 'ì‹œí¥': 'ê²½ê¸°', 'íŒŒì£¼': 'ê²½ê¸°',
            'ë¶€ì²œ': 'ê²½ê¸°', 'ê´‘ëª…': 'ê²½ê¸°', 'ê¹€í¬': 'ê²½ê¸°', 'ì´ì²œ': 'ê²½ê¸°', 'ì˜¤ì‚°': 'ê²½ê¸°'
          };
          
          for (const [city, region] of Object.entries(cityToRegion)) {
            if (checkText.includes(city)) {
              programRegion = region;
              break;
            }
          }
          
          // ì§€ì—­ì´ ëª…ì‹œëœ ê³µê³ ì¸ë°, ê¸°ì—… ì§€ì—­ê³¼ ë¶ˆì¼ì¹˜í•˜ë©´ ì œì™¸
          if (programRegion) {
            // ìˆ˜ë„ê¶Œ ê³µê³ ëŠ” ìˆ˜ë„ê¶Œ ê¸°ì—…ì—ê²Œ í—ˆìš©
            if (combinedText.includes('ìˆ˜ë„ê¶Œ') || checkText.includes('ìˆ˜ë„ê¶Œ')) {
              if (!capitalAreaRegions.includes(companyRegion)) {
                console.log(`âŒ [ì§€ì—­] ${programName.substring(0, 30)} - ìˆ˜ë„ê¶Œ í•œì •`);
                return false;
              }
            } else if (programRegion !== companyRegion) {
              console.log(`âŒ [ì§€ì—­] ${programName.substring(0, 30)} - ${programRegion} í•œì • (ê¸°ì—…: ${companyRegion})`);
              return false;
            }
          }
        }
        
        // -----------------------------------------
        // í•„í„° 3: ê¸°ì—… ê·œëª¨ ë¶ˆì¼ì¹˜ ì œì™¸
        // -----------------------------------------
        const companySize = companyData.companySize || '';
        
        // ëŒ€ê¸°ì—… ì „ìš© ê³µê³  ì œì™¸
        if ((combinedText.includes('ëŒ€ê¸°ì—…') || combinedText.includes('ëŒ€ê¸°ì—… ì „ìš©')) && 
            !combinedText.includes('ì¤‘ì†Œê¸°ì—…') && !combinedText.includes('ì¤‘ê²¬ê¸°ì—…')) {
          if (companySize === 'ì†Œê¸°ì—…' || companySize === 'ì¤‘ê¸°ì—…' || companySize === 'ì¤‘ì†Œê¸°ì—…') {
            console.log(`âŒ [ê·œëª¨] ${programName.substring(0, 30)} - ëŒ€ê¸°ì—… ì „ìš©`);
            return false;
          }
        }
        
        // ì¤‘ê²¬ê¸°ì—… ì „ìš© ê³µê³  ì œì™¸
        if (combinedText.includes('ì¤‘ê²¬ê¸°ì—… ì „ìš©') || combinedText.includes('ì¤‘ê²¬ê¸°ì—…ë§Œ')) {
          if (companySize !== 'ì¤‘ê²¬ê¸°ì—…') {
            console.log(`âŒ [ê·œëª¨] ${programName.substring(0, 30)} - ì¤‘ê²¬ê¸°ì—… ì „ìš©`);
            return false;
          }
        }
        
        // ì¤‘ê¸°ì—… ëŒ€ìƒ ê³µê³  - ì†Œê¸°ì—… ì œì™¸
        if ((combinedText.includes('ì¤‘ê¸°ì—…') || combinedText.includes('ì¤‘ê¸°ì—… ëŒ€ìƒ')) && 
            !combinedText.includes('ì†Œê¸°ì—…') && !combinedText.includes('ì¤‘ì†Œê¸°ì—…')) {
          if (companySize === 'ì†Œê¸°ì—…') {
            console.log(`âŒ [ê·œëª¨] ${programName.substring(0, 30)} - ì¤‘ê¸°ì—… ëŒ€ìƒ`);
            return false;
          }
        }
        
        // ì†Œê¸°ì—… ì „ìš© ê³µê³  - ì¤‘ê¸°ì—…/ì¤‘ê²¬ê¸°ì—… ì œì™¸
        if (combinedText.includes('ì†Œê¸°ì—… ì „ìš©') || combinedText.includes('ì†Œê¸°ì—…ë§Œ')) {
          if (companySize !== 'ì†Œê¸°ì—…') {
            console.log(`âŒ [ê·œëª¨] ${programName.substring(0, 30)} - ì†Œê¸°ì—… ì „ìš©`);
            return false;
          }
        }
        
        // ì¤‘ì†Œê¸°ì—… ì „ìš©ì¸ë° ì¤‘ê²¬ê¸°ì—…ì¸ ê²½ìš° ì œì™¸
        if ((combinedText.includes('ì¤‘ì†Œê¸°ì—…') || combinedText.includes('ì¤‘ì†Œê¸°ì—… ì „ìš©')) && 
            !combinedText.includes('ì¤‘ê²¬ê¸°ì—…')) {
          if (companySize === 'ì¤‘ê²¬ê¸°ì—…' || companySize === 'ëŒ€ê¸°ì—…') {
            console.log(`âŒ [ê·œëª¨] ${programName.substring(0, 30)} - ì¤‘ì†Œê¸°ì—… ì „ìš©`);
            return false;
          }
        }
        
        // -----------------------------------------
        // í•„í„° 4: ì—…ì¢… ë¶ˆì¼ì¹˜ ì œì™¸ (ê°•í™”ëœ í•„í„°ë§)
        // -----------------------------------------
        const ksicCategory = getKsicCategory(companyData.ksicCode);
        const ksicCode = companyData.ksicCode || '';
        
        // 4-1. íŠ¹ì • ì—…ì¢… ì „ìš© ê³µê³  (ëª…ì‹œì  í‚¤ì›Œë“œ)
        const industryExclusions = [
          { keywords: ['ë†ì—… ì „ìš©', 'ë†ì—…ë¶„ì•¼ë§Œ', 'ë†ì—…ì¸ë§Œ', 'ë†ì–´ì—…ì¸', 'ë†ì—…ê´€ë ¨'], industries: ['ë†ì—…', 'ì–´ì—…', 'ì„ì—…'] },
          { keywords: ['ì–´ì—… ì „ìš©', 'ìˆ˜ì‚°ì—… ì „ìš©', 'ì–´ì—…ì¸ë§Œ', 'ìˆ˜ì‚°ê´€ë ¨'], industries: ['ì–´ì—…', 'ìˆ˜ì‚°'] },
          { keywords: ['ì œì¡°ì—… ì „ìš©', 'ì œì¡°ì—…ì²´ë§Œ', 'ì œì¡°ê¸°ì—…ë§Œ'], industries: ['ì œì¡°', 'ì‹í’ˆ', 'í™”í•™', 'ê¸ˆì†', 'ì „ì', 'ê¸°ê³„', 'ìë™ì°¨'] },
          { keywords: ['ê±´ì„¤ì—… ì „ìš©', 'ê±´ì„¤ì—…ì²´ë§Œ', 'ê±´ì„¤ê¸°ì—…ë§Œ'], industries: ['ê±´ì„¤', 'í† ëª©'] },
          { keywords: ['ì˜ë£Œê¸°ê´€ ì „ìš©', 'ë³‘ì›ë§Œ', 'ì˜ë£Œê¸°ê´€ë§Œ'], industries: ['ë³´ê±´', 'ì˜ë£Œ'] },
          { keywords: ['ì‚¬íšŒì ê¸°ì—… ì „ìš©', 'ì‚¬íšŒì ê¸°ì—…ë§Œ'], industries: [] },
          { keywords: ['í˜‘ë™ì¡°í•© ì „ìš©', 'í˜‘ë™ì¡°í•©ë§Œ'], industries: [] }
        ];
        
        for (const exclusion of industryExclusions) {
          if (exclusion.keywords.some(kw => combinedText.includes(kw))) {
            if (exclusion.industries.length > 0 && !exclusion.industries.includes(ksicCategory)) {
              console.log(`âŒ [ì—…ì¢…] ${programName.substring(0, 30)} - ${exclusion.keywords[0]}`);
              return false;
            }
          }
        }
        
        // 4-2. íŠ¹ì • ë¶„ì•¼ í•œì • ê³µê³  (ë¶„ì•¼ëª… + ê¸°ì—…/ì—…ì²´ ì¡°í•©)
        const specificIndustryPatterns = [
          { patterns: ['ê¸°ê³„ë¶„ì•¼', 'ê¸°ê³„ê´€ë ¨', 'ê¸°ê³„ ê´€ë ¨', 'ê¸°ê³„ì—…ì²´', 'ê¸°ê³„ê¸°ì—…'], validKsic: ['29', '28', '30', '31'] },
          { patterns: ['ì¡°ëª…ê´€ë ¨', 'ì¡°ëª… ê´€ë ¨', 'ì¡°ëª…ê¸°ì—…', 'ì¡°ëª…ì—…ì²´', 'ì¡°ëª…ì‚°ì—…'], validKsic: ['26', '27', '28'] },
          { patterns: ['íƒ„ì†Œìœµë³µí•©', 'íƒ„ì†Œì‚°ì—…', 'íƒ„ì†Œì†Œì¬', 'íƒ„ì†Œì„¬ìœ '], validKsic: ['20', '22', '26'] },
          { patterns: ['ê´€ê´‘ì—…ê³„', 'ì—¬í–‰ì‚¬', 'ì¸ë°”ìš´ë“œì—¬í–‰', 'ê´€ê´‘ê¸°ê´€', 'DMC'], validKsic: ['79', '55', '56'] },
          { patterns: ['ì‹í’ˆê¸°ì—…', 'ì‹í’ˆì—…ì²´', 'ì‹í’ˆê´€ë ¨', 'ì‹í’ˆì‚°ì—…', 'ê³ ë ¹ì¹œí™”ì‹í’ˆ'], validKsic: ['10', '11', '56'] },
          { patterns: ['ì„¬ìœ ê´€ë ¨', 'ì„¬ìœ ê¸°ì—…', 'ì„¬ìœ ì—…ì²´', 'ì˜ë¥˜ê¸°ì—…'], validKsic: ['13', '14'] },
          { patterns: ['í™”ì¥í’ˆê¸°ì—…', 'í™”ì¥í’ˆì—…ì²´', 'ë·°í‹°ì‚°ì—…'], validKsic: ['20', '47'] },
          { patterns: ['ë°”ì´ì˜¤ê¸°ì—…', 'ë°”ì´ì˜¤ì—…ì²´', 'ì œì•½ê¸°ì—…', 'ì˜ì•½í’ˆ'], validKsic: ['21', '72'] },
          { patterns: ['ë¬¼ë¥˜ê¸°ì—…', 'ë¬¼ë¥˜ì—…ì²´', 'ìš´ì†¡ê¸°ì—…', 'ìš´ì†¡ì—…ì²´'], validKsic: ['49', '52'] },
          { patterns: ['ì½˜í…ì¸ ê¸°ì—…', 'ê²Œì„ê¸°ì—…', 'ì˜ìƒê¸°ì—…', 'ë¯¸ë””ì–´ê¸°ì—…'], validKsic: ['58', '59', '60', '63'] }
        ];
        
        const ksicPrefix = ksicCode.substring(0, 2);
        for (const { patterns, validKsic } of specificIndustryPatterns) {
          if (patterns.some(p => combinedText.includes(p))) {
            if (!validKsic.includes(ksicPrefix)) {
              console.log(`âŒ [ì—…ì¢…] ${programName.substring(0, 30)} - ${patterns[0]} ëŒ€ìƒ (ê¸°ì—…: ${ksicCategory})`);
              return false;
            }
          }
        }
        
        // 4-3. ì „ì‹œíšŒ/ë°•ëŒíšŒ ë¶„ì•¼ ì²´í¬ (ë¶„ì•¼ íŠ¹í™” ì „ì‹œíšŒ)
        const exhibitionPatterns = [
          { keywords: ['êµ­ì œê´€ê´‘ë°•ëŒíšŒ', 'ì—¬í–‰ë°•ëŒíšŒ', 'ê´€ê´‘í™ë³´ê´€'], validKsic: ['79', '55', '56'] },
          { keywords: ['ì‚°ì—…ì „ì‹œíšŒ', 'ê¸°ê³„ì „ì‹œíšŒ', 'hannover'], validKsic: ['28', '29', '30', '31', '26', '27'] },
          { keywords: ['ê±´ì¶•ì¡°ëª…', 'ì¡°ëª…ì „ì‹œíšŒ', 'ì¡°ëª…ë°•ëŒíšŒ'], validKsic: ['26', '27', '28', '41'] },
          { keywords: ['ì‹í’ˆë°•ëŒíšŒ', 'ì‹í’ˆì „ì‹œíšŒ', 'í‘¸ë“œì‡¼'], validKsic: ['10', '11', '56'] },
          { keywords: ['ë·°í‹°ë°•ëŒíšŒ', 'í™”ì¥í’ˆì „ì‹œíšŒ', 'ì½”ìŠ¤ë©”í‹±'], validKsic: ['20', '47'] },
          { keywords: ['ì˜ë£Œê¸°ê¸°ì „ì‹œíšŒ', 'í—¬ìŠ¤ì¼€ì–´ë°•ëŒíšŒ'], validKsic: ['21', '27', '86'] }
        ];
        
        for (const { keywords, validKsic } of exhibitionPatterns) {
          if (keywords.some(kw => combinedText.includes(kw.toLowerCase()))) {
            if (!validKsic.includes(ksicPrefix)) {
              console.log(`âŒ [ì „ì‹œíšŒ] ${programName.substring(0, 30)} - ì—…ì¢… ë¶ˆì¼ì¹˜ (ê¸°ì—…: ${ksicCategory})`);
              return false;
            }
          }
        }
        
        // -----------------------------------------
        // í•„í„° 5: ì—…ë ¥ ì¡°ê±´ ë¶ˆì¼ì¹˜ ì œì™¸
        // -----------------------------------------
        // "ì°½ì—… 3ë…„ ì´ë‚´", "7ë…„ ì´ë‚´", "ì—…ë ¥ 7ë…„ ì´ìƒ" ë“± ì¶”ì¶œ
        const yearPatterns = [
          { pattern: /ì°½ì—…\s*(\d+)\s*ë…„\s*ì´ë‚´/, type: 'max' },
          { pattern: /(\d+)\s*ë…„\s*ì´ë‚´\s*(ì°½ì—…|ê¸°ì—…)/, type: 'max' },
          { pattern: /(\d+)\s*ë…„\s*ì´ìƒ\s*(ì˜|ì¸)?\s*(ì¤‘ê¸°ì—…|ê¸°ì—…|ì—…ì²´)/, type: 'min' },
          { pattern: /ì—…ë ¥\s*(\d+)\s*ë…„\s*ì´ìƒ/, type: 'min' },
          { pattern: /ì—…ë ¥\s*(\d+)\s*ë…„\s*ì´ë‚´/, type: 'max' },
          { pattern: /(\d+)\s*ë…„\s*ë¯¸ë§Œ/, type: 'max' },
          { pattern: /(\d+)\s*ë…„\s*ì´ìƒ\s*ì—…ë ¥/, type: 'min' },
          { pattern: /ì„¤ë¦½\s*(\d+)\s*ë…„\s*ì´ìƒ/, type: 'min' },
          { pattern: /ì„¤ë¦½\s*(\d+)\s*ë…„\s*ì´ë‚´/, type: 'max' }
        ];
        
        for (const { pattern, type } of yearPatterns) {
          const match = combinedText.match(pattern);
          if (match) {
            const years = parseInt(match[1]);
            if (type === 'max' && businessAge > years) {
              console.log(`âŒ [ì—…ë ¥] ${programName.substring(0, 30)} - ${years}ë…„ ì´ë‚´ ì¡°ê±´ (ê¸°ì—…: ${businessAge}ë…„)`);
              return false;
            }
            if (type === 'min' && businessAge < years) {
              console.log(`âŒ [ì—…ë ¥] ${programName.substring(0, 30)} - ${years}ë…„ ì´ìƒ ì¡°ê±´ (ê¸°ì—…: ${businessAge}ë…„)`);
              return false;
            }
          }
        }
        
        // -----------------------------------------
        // í•„í„° 6: í•„ìˆ˜ ì¸ì¦ ì¡°ê±´ ë¶ˆì¼ì¹˜ ì œì™¸
        // -----------------------------------------
        // ë²¤ì²˜ê¸°ì—… í•„ìˆ˜
        if ((combinedText.includes('ë²¤ì²˜ê¸°ì—… í•„ìˆ˜') || combinedText.includes('ë²¤ì²˜ê¸°ì—…ë§Œ') || 
             combinedText.includes('ë²¤ì²˜ê¸°ì—…ì— í•œ')) && companyData.hasVenture !== 'Y') {
          console.log(`âŒ [ì¸ì¦] ${programName.substring(0, 30)} - ë²¤ì²˜ê¸°ì—… í•„ìˆ˜`);
          return false;
        }
        
        // ì´ë…¸ë¹„ì¦ˆ í•„ìˆ˜
        if ((combinedText.includes('ì´ë…¸ë¹„ì¦ˆ í•„ìˆ˜') || combinedText.includes('ì´ë…¸ë¹„ì¦ˆë§Œ') ||
             combinedText.includes('ì´ë…¸ë¹„ì¦ˆ ê¸°ì—…ì— í•œ')) && companyData.hasInnobiz !== 'Y') {
          console.log(`âŒ [ì¸ì¦] ${programName.substring(0, 30)} - ì´ë…¸ë¹„ì¦ˆ í•„ìˆ˜`);
          return false;
        }
        
        // ë©”ì¸ë¹„ì¦ˆ í•„ìˆ˜
        if ((combinedText.includes('ë©”ì¸ë¹„ì¦ˆ í•„ìˆ˜') || combinedText.includes('ë©”ì¸ë¹„ì¦ˆë§Œ') ||
             combinedText.includes('ë©”ì¸ë¹„ì¦ˆ ê¸°ì—…ì— í•œ')) && companyData.hasMainbiz !== 'Y') {
          console.log(`âŒ [ì¸ì¦] ${programName.substring(0, 30)} - ë©”ì¸ë¹„ì¦ˆ í•„ìˆ˜`);
          return false;
        }
        
        // -----------------------------------------
        // í•„í„° 7: íŠ¹ìˆ˜ ëŒ€ìƒ ì œì™¸
        // -----------------------------------------
        const specialTargets = [
          { keywords: ['ì—¬ì„±ê¸°ì—… ì „ìš©', 'ì—¬ì„±ê¸°ì—…ë§Œ', 'ì—¬ì„±CEOë§Œ'], condition: companyData.ceoGender !== 'F' },
          { keywords: ['ì¥ì• ì¸ê¸°ì—… ì „ìš©', 'ì¥ì• ì¸ê¸°ì—…ë§Œ'], condition: companyData.hasDisabledOwner !== 'Y' },
          { keywords: ['ì²­ë…„ì°½ì—…', 'ì²­ë…„CEO', 'ë§Œ 39ì„¸ ì´í•˜'], condition: ceoAge > 39 },
          { keywords: ['ì‹œë‹ˆì–´', 'ì¤‘ì¥ë…„', 'ë§Œ 50ì„¸ ì´ìƒ'], condition: ceoAge < 50 },
          { keywords: ['1ì¸ ê¸°ì—…', '1ì¸ê¸°ì—…', '1ì¸ ì°½ì¡°ê¸°ì—…'], condition: (companyData.employeesTotal || 0) > 1 },
          { keywords: ['ìˆ˜ì¶œê¸°ì—… ì „ìš©', 'ìˆ˜ì¶œê¸°ì—…ë§Œ', 'ìˆ˜ì¶œì‹¤ì  ë³´ìœ '], condition: companyData.isExporting !== 'Y' },
          { keywords: ['ë¹„ì˜ë¦¬', 'ë¹„ì˜ë¦¬ë²•ì¸', 'ë¹„ì˜ë¦¬ë‹¨ì²´'], condition: companyData.companyType !== 'ë¹„ì˜ë¦¬ë²•ì¸' }
        ];
        
        for (const target of specialTargets) {
          if (target.keywords.some(kw => combinedText.includes(kw)) && target.condition) {
            console.log(`âŒ [ëŒ€ìƒ] ${programName.substring(0, 30)} - ${target.keywords[0]}`);
            return false;
          }
        }
        
        // -----------------------------------------
        // í•„í„° 8: ë¶„ì•¼ ë¶ˆì¼ì¹˜ ì œì™¸
        // -----------------------------------------
        const desiredCategories = companyData.supportNeeds || [];
        const hasAllCategory = desiredCategories.includes('ì „ì²´');
        
        if (!hasAllCategory && desiredCategories.length > 0) {
          const programCategory = program.category || '';
          
          // ë¶„ì•¼ ë§¤í•‘ (ìœ ì‚¬ ë¶„ì•¼ í¬í•¨)
          const categoryMapping = {
            'ê¸ˆìœµ': ['ê¸ˆìœµ', 'ìê¸ˆ', 'ìœµì', 'ë³´ì¦', 'íˆ¬ì'],
            'ê¸°ìˆ ': ['ê¸°ìˆ ', 'R&D', 'ì—°êµ¬ê°œë°œ', 'íŠ¹í—ˆ', 'ì¸ì¦', 'ê¸°ìˆ ê°œë°œ'],
            'ì¸ë ¥': ['ì¸ë ¥', 'ê³ ìš©', 'ì±„ìš©', 'êµìœ¡', 'í›ˆë ¨', 'ì¼ìë¦¬', 'ì¸ê±´ë¹„'],
            'ìˆ˜ì¶œ': ['ìˆ˜ì¶œ', 'í•´ì™¸', 'ë¬´ì—­', 'ë°”ìš°ì²˜', 'ê¸€ë¡œë²Œ', 'í•´ì™¸ì§„ì¶œ'],
            'ë‚´ìˆ˜': ['ë‚´ìˆ˜', 'íŒë¡œ', 'ë§ˆì¼€íŒ…', 'í™ë³´', 'ì „ì‹œ'],
            'ì°½ì—…': ['ì°½ì—…', 'ìŠ¤íƒ€íŠ¸ì—…', 'ì´ˆê¸°', 'ì—‘ì…€ëŸ¬ë ˆì´íŒ…', 'ì˜ˆë¹„ì°½ì—…'],
            'ê²½ì˜': ['ê²½ì˜', 'ì»¨ì„¤íŒ…', 'ìŠ¤ë§ˆíŠ¸ê³µì¥', 'í˜ì‹ ', 'ê²½ì˜í˜ì‹ '],
            'ê¸°íƒ€': ['ê¸°íƒ€', 'ESG', 'íƒ„ì†Œ', 'ì‹œì„¤', 'ê³µê°„', 'í™˜ê²½']
          };
          
          let categoryMatched = false;
          for (const desired of desiredCategories) {
            const relatedKeywords = categoryMapping[desired] || [desired];
            if (relatedKeywords.some(kw => programCategory.includes(kw) || combinedText.includes(kw))) {
              categoryMatched = true;
              break;
            }
          }
          
          if (!categoryMatched && programCategory) {
            // ì™„ì „íˆ ê´€ë ¨ ì—†ëŠ” ë¶„ì•¼ë©´ ì œì™¸
            const isUnrelated = !desiredCategories.some(cat => {
              const related = categoryMapping[cat] || [];
              return related.some(kw => combinedText.includes(kw));
            });
            
            if (isUnrelated) {
              console.log(`âŒ [ë¶„ì•¼] ${programName.substring(0, 30)} - ${programCategory} (í¬ë§: ${desiredCategories.join(',')})`);
              return false;
            }
          }
        }
        
        // ëª¨ë“  í•„í„° í†µê³¼
        return true;
      });
      
      console.log(`ğŸ” ì‚¬ì „ í•„í„°ë§ ê²°ê³¼: ${programs.length}ê°œ â†’ ${filteredPrograms.length}ê°œ`);
      
      // ========================================
      // ë§¤ì¹­ ì ìˆ˜ ê³„ì‚° (í•„í„°ë§ í†µê³¼í•œ ê³µê³ ë§Œ)
      // ========================================
      
      // 2. í¬ë§ ì§€ì›ë¶„ì•¼ì™€ ë§¤ì¹­
      const desiredCategories = companyData.supportNeeds || [];
      const hasAllCategory = desiredCategories.includes('ì „ì²´');
      
      // 3. ì§€ì—­ ë§¤ì¹­ ì¤€ë¹„
      const companyRegion = companyData.locationSido || '';
      
      // 4. ë§¤ì¹­ ì ìˆ˜ ê³„ì‚°
      const scoredPrograms = filteredPrograms.map(program => {
        let score = 50; // í•„í„° í†µê³¼í–ˆìœ¼ë¯€ë¡œ ê¸°ë³¸ ì ìˆ˜ 50ì 
        let reasons = [];
        
        // ë¶„ì•¼ ë§¤ì¹­ (+25ì )
        if (hasAllCategory) {
          score += 15;
          reasons.push('âœ… ì „ì²´ ë¶„ì•¼ ê´€ì‹¬');
        } else if (desiredCategories.length > 0) {
          const programCategory = program.category || '';
          if (desiredCategories.some(cat => programCategory.includes(cat))) {
            score += 25;
            reasons.push(`âœ… ${programCategory} ë¶„ì•¼ ì¼ì¹˜`);
          }
        }
        
        // ì§€ì—­ ë§¤ì¹­ ë¡œì§
        const organization = program.organization || '';
        const programName = program.name || '';
        
        // ì „êµ­ ëŒ€ìƒ ê¸°ê´€
        const nationalOrgs = ['ì¤‘ì†Œë²¤ì²˜ê¸°ì—…ë¶€', 'ì‚°ì—…í†µìƒìì›ë¶€', 'ê³¼í•™ê¸°ìˆ ì •ë³´í†µì‹ ë¶€', 'ê³ ìš©ë…¸ë™ë¶€', 
                            'ì¤‘ì†Œê¸°ì—…ì§„í¥ê³µë‹¨', 'ì†Œìƒê³µì¸ì‹œì¥ì§„í¥ê³µë‹¨', 'í•œêµ­ì‚°ì—…ê¸°ìˆ ì§„í¥ì›',
                            'ì°½ì—…ì§„í¥ì›', 'ì •ë³´í†µì‹ ì‚°ì—…ì§„í¥ì›', 'í•œêµ­ë¬´ì—­í˜‘íšŒ', 'ì½”íŠ¸ë¼', 'KOTRA'];
        const isNationalProgram = nationalOrgs.some(org => organization.includes(org));
        
        if (isNationalProgram) {
          score += 10;
          reasons.push('âœ… ì „êµ­ ëŒ€ìƒ ì‚¬ì—…');
        } else {
          score += 15;
          reasons.push(`âœ… ${companyRegion} ì§€ì—­ ê¸°ì—… ëŒ€ìƒ`);
        }
        
        // ì§€ì›ëŒ€ìƒ í‚¤ì›Œë“œ ë§¤ì¹­
        const target = (program.target || '').toLowerCase();
        const description = (program.description || '').toLowerCase();
        const combinedText = target + ' ' + description;
        
        // ê¸°ì—… ê·œëª¨ ë§¤ì¹­ (+10ì )
        if (combinedText.includes('ì¤‘ì†Œê¸°ì—…') || combinedText.includes('ì†Œê¸°ì—…')) {
          if (companyData.companySize === 'ì†Œê¸°ì—…' || companyData.companySize === 'ì¤‘ê¸°ì—…' || companyData.companySize === 'ì¤‘ì†Œê¸°ì—…') {
            score += 10;
            reasons.push('âœ… ì¤‘ì†Œê¸°ì—… ëŒ€ìƒ');
          }
        }
        
        // ë²¤ì²˜/ì´ë…¸ë¹„ì¦ˆ ìš°ëŒ€ (+5ì )
        if (combinedText.includes('ë²¤ì²˜') && companyData.hasVenture === 'Y') {
          score += 5;
          reasons.push('âœ… ë²¤ì²˜ê¸°ì—… ìš°ëŒ€');
        }
        if (combinedText.includes('ì´ë…¸ë¹„ì¦ˆ') && companyData.hasInnobiz === 'Y') {
          score += 5;
          reasons.push('âœ… ì´ë…¸ë¹„ì¦ˆ ìš°ëŒ€');
        }
        
        // ì‹ ì²­ ê°€ëŠ¥ ì—¬ë¶€ (+5ì )
        if (program.isOpen) {
          score += 5;
          reasons.push('âœ… í˜„ì¬ ì‹ ì²­ ê°€ëŠ¥');
        }
        
        // ì—…ì¢… í‚¤ì›Œë“œ ë§¤ì¹­ (+5ì )
        const ksicCategory = getKsicCategory(companyData.ksicCode);
        if (ksicCategory && combinedText.includes(ksicCategory)) {
          score += 5;
          reasons.push(`âœ… ${ksicCategory} ì—…ì¢… ê´€ë ¨`);
        }
        
        // ê¸°ë³¸ ì´ìœ  ì¶”ê°€
        if (reasons.length === 0) {
          reasons.push('ê¸°ë³¸ ìš”ê±´ ì¶©ì¡±');
        }
        
        return {
          ...program,
          matchScore: Math.min(score, 100),
          matchReasons: reasons
        };
      });
      
      // 5. ì ìˆ˜ìˆœ ì •ë ¬ ë° ìƒìœ„ 15ê°œ ë°˜í™˜
      const sortedPrograms = scoredPrograms
        .filter(p => p.matchScore >= 50) // 50ì  ë¯¸ë§Œ ì œì™¸
        .sort((a, b) => b.matchScore - a.matchScore)
        .slice(0, 15);
      
      console.log(`ğŸ¯ ìµœì¢… ì¶”ì²œ: ${sortedPrograms.length}ê°œ í”„ë¡œê·¸ë¨`);
      sortedPrograms.slice(0, 5).forEach((p, i) => {
        console.log(`  ${i + 1}ìœ„. ${p.name} (${p.matchScore}ì )`);
      });
      
      return sortedPrograms;
    }
    
    /**
     * KSIC ì½”ë“œë¡œ ì—…ì¢… ì¹´í…Œê³ ë¦¬ ë°˜í™˜
     */
    function getKsicCategory(ksicCode) {
      if (!ksicCode) return '';
      const code = ksicCode.substring(0, 2);
      const categories = {
        '01': 'ë†ì—…', '02': 'ì„ì—…', '03': 'ì–´ì—…',
        '10': 'ì‹í’ˆ', '11': 'ìŒë£Œ', '13': 'ì„¬ìœ ', '14': 'ì˜ë³µ',
        '20': 'í™”í•™', '21': 'ì˜ì•½í’ˆ', '22': 'ê³ ë¬´í”Œë¼ìŠ¤í‹±',
        '24': 'ê¸ˆì†', '25': 'ê¸ˆì†ê°€ê³µ', '26': 'ì „ì', '27': 'ì˜ë£Œê¸°ê¸°',
        '28': 'ì „ê¸°ì¥ë¹„', '29': 'ê¸°ê³„', '30': 'ìë™ì°¨', '31': 'ìš´ì†¡ì¥ë¹„',
        '41': 'ê±´ì„¤', '42': 'í† ëª©',
        '46': 'ë„ë§¤', '47': 'ì†Œë§¤',
        '49': 'ìš´ì†¡', '52': 'ë¬¼ë¥˜',
        '58': 'ì¶œíŒ', '59': 'ì˜ìƒ', '60': 'ë°©ì†¡', '61': 'í†µì‹ ', '62': 'IT', '63': 'ì •ë³´ì„œë¹„ìŠ¤',
        '64': 'ê¸ˆìœµ', '65': 'ë³´í—˜',
        '70': 'ì—°êµ¬ê°œë°œ', '71': 'ì „ë¬¸ì„œë¹„ìŠ¤', '72': 'ê±´ì¶•ì„¤ê³„',
        '73': 'ê´‘ê³ ', '74': 'ë””ìì¸',
        '85': 'êµìœ¡', '86': 'ë³´ê±´', '87': 'ë³µì§€'
      };
      return categories[code] || '';
    }
    
    /**
     * ìš”ì•½ë¶„ì„: í´ë¼ì´ì–¸íŠ¸ ë§¤ì¹­ë§Œ ìˆ˜í–‰
     */
    /**
     * ì§€ì›ì‚¬ì—…+ë¶„ì„: ë§ì¶¤ ì§€ì›ì‚¬ì—… ì°¾ê¸° + AI ìš”ì•½ë¶„ì„ ë™ì‹œ ì§„í–‰
     */
    async function findAndAnalyzePrograms() {
      const companyData = collectFormData();
      
      // KSIC ì½”ë“œ 5ìë¦¬ í•„ìˆ˜ ê²€ì¦
      if (!companyData.ksicCode || companyData.ksicCode.length !== 5) {
        alert('âš ï¸ KSIC ì½”ë“œ 5ìë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!\n\nKSIC ì½”ë“œëŠ” AI ë¶„ì„ì— ê°€ì¥ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.\nì •í™•í•œ ì—…ì¢… ì½”ë“œ 5ìë¦¬ë¥¼ ì…ë ¥í•´ì•¼ ì •í™•í•œ ë§¤ì¹­ ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nğŸ” ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì •í™•í•œ ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        document.getElementById('ksic-1').focus();
        return;
      }
      
      // í•„ìˆ˜ í•„ë“œ ê²€ì¦ (í•­ëª©ëª… í¬í•¨)
      const requiredFields = [
        { key: 'companyName', name: 'ê¸°ì—…ëª…' },
        { key: 'businessNumber', name: 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸' },
        { key: 'establishDate', name: 'ê°œì—…ì—°ì›”ì¼' },
        { key: 'companySize', name: 'ê¸°ì—… ê·œëª¨' },
        { key: 'companyType', name: 'ê¸°ì—… í˜•íƒœ' },
        { key: 'ksicCode', name: 'ì—…ì¢…(KSIC)' },
        { key: 'locationSido', name: 'ì†Œì¬ì§€(ì‹œë„)' },
        { key: 'capitalArea', name: 'ìˆ˜ë„ê¶Œ ì—¬ë¶€' },
        { key: 'revenueRecent', name: 'ìµœê·¼ ë§¤ì¶œì•¡' },
        { key: 'taxArrears', name: 'êµ­ì„¸ ì²´ë‚© ì—¬ë¶€' },
        { key: 'localTaxArrears', name: 'ì§€ë°©ì„¸ ì²´ë‚© ì—¬ë¶€' },
        { key: 'employeesTotal', name: 'ìƒì‹œê·¼ë¡œì ìˆ˜' }
      ];
      
      const missingFields = requiredFields.filter(f => {
        const val = companyData[f.key];
        return val === '' || val === null || val === undefined || val === 0;
      });
      
      // í¬ë§ ì§€ì›ë¶„ì•¼ ì²´í¬
      if (!companyData.supportNeeds || companyData.supportNeeds.length === 0) {
        missingFields.push({ key: 'supportNeeds', name: 'í¬ë§ ì§€ì›ë¶„ì•¼' });
      }
      
      if (missingFields.length > 0) {
        const fieldNames = missingFields.map(f => 'â€¢ ' + f.name).join('\n');
        alert('ë‹¤ìŒ í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n\n' + fieldNames);
        return;
      }
      
      try {
        // Step 1: ë§ì¶¤ ì§€ì›ì‚¬ì—… ì°¾ê¸°
        showLoadingOverlay('ğŸ” ì§€ì›ì‚¬ì—…+ë¶„ì„ ì§„í–‰ ì¤‘...', 'â‘  ê¸°ì—…ë§ˆë‹¹ì—ì„œ ë§ì¶¤ ê³µê³ ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...');
        
        const results = await clientSideMatching(companyData);
        
        // ê²°ê³¼ ì €ì¥
        lastMatchedPrograms = results;
        lastCompanyData = companyData;
        hasCompletedSearch = true;
        
        // ê²°ê³¼ í‘œì‹œ
        displayResults({ recommendations: results });
        
        console.log('âœ… ë§ì¶¤ì°¾ê¸° ì™„ë£Œ:', results.length, 'ê°œ ì¶”ì²œ');
        
        // Step 2: AI ìš”ì•½ë¶„ì„ ìë™ ì§„í–‰
        if (results.length > 0) {
          const allPrograms = results; // ê°€ì ¸ì˜¨ ëª¨ë“  ê³µê³ 
          
          // ê¸°ì¡´ ìš”ì•½ë¶„ì„ ê²°ê³¼ê°€ ìˆëŠ” ê³µê³ ëŠ” ì œì™¸ (ë¹„ìš© ì ˆê°)
          const existingSummaryIds = lastSummaryResults.map(s => s.programId || s.id);
          const newPrograms = allPrograms.filter(p => !existingSummaryIds.includes(p.id));
          
          console.log(`ğŸ“Š ìš”ì•½ë¶„ì„: ì „ì²´ ${allPrograms.length}ê°œ ì¤‘ ê¸°ì¡´ ${existingSummaryIds.length}ê°œ ì œì™¸, ì‹ ê·œ ${newPrograms.length}ê°œ ë¶„ì„`);
          
          // ğŸ†• 100% ë™ì¼í•˜ë©´ ì°¨ê° ì—†ì´ ê¸°ì¡´ ê²°ê³¼ í‘œì‹œ
          if (newPrograms.length === 0 && lastSummaryResults.length > 0) {
            hideLoadingOverlay();
            
            // ê¸°ì¡´ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
            const allSummaryResults = lastSummaryResults.filter(s => 
              allPrograms.some(p => p.id === s.programId || p.id === s.id)
            );
            updateResultsWithSummary(allSummaryResults);
            
            // ê¸°ì¡´ ìƒì„¸ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ í‘œì‹œ
            if (lastDetailResults && lastDetailResults.length > 0) {
              setTimeout(() => {
                updateResultsWithPDFDetail(lastDetailResults);
              }, 100);
            }
            
            alert(
              'âœ… ì§€ì›ì‚¬ì—…+ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
              `â€¢ ë§ì¶¤ ì§€ì›ì‚¬ì—…: ${results.length}ê°œ ì¶”ì²œ\n` +
              `â€¢ ê¸°ì¡´ ë¶„ì„ ê²°ê³¼: ${allSummaryResults.length}ê°œ (ë³€ê²½ ì—†ìŒ)\n\n` +
              'ğŸ’° í¬ë ˆë”§ì´ ì°¨ê°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
            );
            return;
          }
          
          // ğŸ†• í¬ë ˆë”§ í™•ì¸ (ì‹ ê·œ ê³µê³ ê°€ ìˆì„ ë•Œë§Œ)
          hideLoadingOverlay(); // ì¼ë‹¨ ë¡œë”© ìˆ¨ê¸°ê³ 
          const canProceed = await checkAndConfirmCredits('summary');
          if (!canProceed) return;
          
          // ë‹¤ì‹œ ë¡œë”© í‘œì‹œ
          showLoadingOverlay('ğŸ” ì§€ì›ì‚¬ì—…+ë¶„ì„ ì§„í–‰ ì¤‘...', 'â‘¡ AI ìš”ì•½ë¶„ì„ì„ ì§„í–‰í•©ë‹ˆë‹¤...');
          
          let newSummaryResults = [];
          
          // ì‹ ê·œ ê³µê³ ê°€ ìˆì„ ë•Œë§Œ API í˜¸ì¶œ
          if (newPrograms.length > 0) {
            // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const loadingText = document.getElementById('aiLoadingText');
            const loadingDetail = document.getElementById('aiLoadingDetail');
            if (loadingText) loadingText.textContent = 'ğŸ¤– AI ìš”ì•½ë¶„ì„ ì¤‘...';
            if (loadingDetail) loadingDetail.textContent = 'â‘¡ ' + newPrograms.length + 'ê°œ ì‹ ê·œ ì§€ì›ì‚¬ì—…ì„ Gemini AIê°€ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            
            // Firebase Functionsë¥¼ í†µí•´ Gemini API í˜¸ì¶œ (API í‚¤ ë³´í˜¸)
            const geminiSummary = functions.httpsCallable('geminiSummary');
            const result = await geminiSummary({
              companyData: lastCompanyData,
              programs: newPrograms,
              agentId: agentId  // ğŸ†• ë³¸ì‚¬ ID ì „ë‹¬
            });
            
            const data = result.data;
            
            if (!data.success) {
              throw new Error(data.error || 'AI ë¶„ì„ ì‹¤íŒ¨');
            }
            
            // ì‹ ê·œ ê²°ê³¼ì— programId ì¶”ê°€
            newSummaryResults = data.results.map(r => ({
              ...r,
              programId: r.id || newPrograms[r.index]?.id
            }));
            
            // ê¸°ì¡´ ê²°ê³¼ì™€ ë³‘í•©í•˜ì—¬ ì €ì¥
            lastSummaryResults = [...lastSummaryResults, ...newSummaryResults];
            
            console.log(`ğŸ“Š ë¶„ì„ ê²°ê³¼: ì í•© ${data.eligibleCount || 0}ê°œ, ë¶€ì í•© ${data.ineligibleCount || 0}ê°œ`);
          }
          
          // ì „ì²´ ê²°ê³¼ (ê¸°ì¡´ + ì‹ ê·œ)ë¥¼ í™”ë©´ì— í‘œì‹œ
          const allSummaryResults = lastSummaryResults.filter(s => 
            allPrograms.some(p => p.id === s.programId || p.id === s.id)
          );
          updateResultsWithSummary(allSummaryResults);
          
          // ê¸°ì¡´ ìƒì„¸ë¶„ì„(ë§ì¶¤í˜•ë¶„ì„) ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ í‘œì‹œ
          if (lastDetailResults && lastDetailResults.length > 0) {
            setTimeout(() => {
              updateResultsWithPDFDetail(lastDetailResults);
              console.log('âœ… ê¸°ì¡´ ë§ì¶¤í˜•ë¶„ì„ ê²°ê³¼ ë³µì›:', lastDetailResults.length, 'ê°œ');
            }, 100);
          }
          
          hideLoadingOverlay();
          
          // ì™„ë£Œ ë©”ì‹œì§€ (ë“±ê¸‰ë³„ êµ¬ë¶„)
          const veryHighCount = allSummaryResults.filter(r => (r.fitScore || 0) >= 90).length;
          const highCount = allSummaryResults.filter(r => (r.fitScore || 0) >= 80 && (r.fitScore || 0) < 90).length;
          const mediumCount = allSummaryResults.filter(r => (r.fitScore || 0) >= 70 && (r.fitScore || 0) < 80).length;
          const lowCount = allSummaryResults.filter(r => (r.fitScore || 0) >= 60 && (r.fitScore || 0) < 70).length;
          const refCount = allSummaryResults.filter(r => (r.fitScore || 0) < 60).length;
          
          let summaryMsg = 'â€¢ AI ìš”ì•½ë¶„ì„: ';
          const parts = [];
          if (veryHighCount > 0) parts.push(`ë§¤ìš°ë†’ìŒ ${veryHighCount}ê°œ`);
          if (highCount > 0) parts.push(`ë†’ìŒ ${highCount}ê°œ`);
          if (mediumCount > 0) parts.push(`ë³´í†µ ${mediumCount}ê°œ`);
          if (lowCount > 0) parts.push(`ë‚®ìŒ ${lowCount}ê°œ`);
          if (refCount > 0) parts.push(`ì°¸ê³  ${refCount}ê°œ`);
          summaryMsg += parts.join(' + ');
          
          alert(`âœ… ì§€ì›ì‚¬ì—…+ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâ€¢ ë§ì¶¤ ì§€ì›ì‚¬ì—…: ${results.length}ê°œ ì¶”ì²œ\n${summaryMsg}\n\nê° ê³µê³  ì¹´ë“œì— AI ë¶„ì„ ê²°ê³¼ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸŸ¢ ë§¤ìš°ë†’ìŒ/ğŸ”µ ë†’ìŒ: ì‹ ì²­ ê¶Œì¥\nğŸŸ£ ë³´í†µ/ğŸŸ  ë‚®ìŒ: ê²€í†  í•„ìš”\nğŸŸ¡ ì°¸ê³ : í˜‘ë ¥ì‚¬ ì¶”ì²œ`);
          
          // ğŸ†• í¬ë ˆë”§ ì°¨ê° (ì‹ ê·œ ë¶„ì„ì´ ìˆì—ˆì„ ë•Œë§Œ)
          if (newPrograms.length > 0) {
            await deductCredits('summary');
          }
        } else {
          hideLoadingOverlay();
          alert('ë§¤ì¹­ë˜ëŠ” ì§€ì›ì‚¬ì—…ì´ ì—†ìŠµë‹ˆë‹¤.\nì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•˜ì‹œê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.');
        }
        
      } catch (error) {
        hideLoadingOverlay();
        console.error('âŒ ì§€ì›ì‚¬ì—…+ë¶„ì„ ì˜¤ë¥˜:', error);
        
        // ğŸ†• í•œë„ ì´ˆê³¼ ì—ëŸ¬ì¸ ê²½ìš° êµ¬ë¶„ í‘œì‹œ
        if (error.message && error.message.includes('í•œë„')) {
          alert('âš ï¸ ' + error.message);
        } else {
          alert('ì§€ì›ì‚¬ì—…+ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }
    }
    
    /**
     * ë§ì¶¤ ì§€ì›ì‚¬ì—… ì°¾ê¸° (í´ë¼ì´ì–¸íŠ¸ ë§¤ì¹­) - ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€
     */
    async function findMatchingPrograms() {
      const companyData = collectFormData();
      
      // KSIC ì½”ë“œ 5ìë¦¬ í•„ìˆ˜ ê²€ì¦
      if (!companyData.ksicCode || companyData.ksicCode.length !== 5) {
        alert('âš ï¸ KSIC ì½”ë“œ 5ìë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!\n\nKSIC ì½”ë“œëŠ” AI ë¶„ì„ì— ê°€ì¥ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.\nì •í™•í•œ ì—…ì¢… ì½”ë“œ 5ìë¦¬ë¥¼ ì…ë ¥í•´ì•¼ ì •í™•í•œ ë§¤ì¹­ ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nğŸ” ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì •í™•í•œ ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        document.getElementById('ksic-1').focus();
        return;
      }
      
      // í•„ìˆ˜ í•„ë“œ ê²€ì¦ (í•­ëª©ëª… í¬í•¨)
      const requiredFields = [
        { key: 'companyName', name: 'ê¸°ì—…ëª…' },
        { key: 'businessNumber', name: 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸' },
        { key: 'establishDate', name: 'ê°œì—…ì—°ì›”ì¼' },
        { key: 'companySize', name: 'ê¸°ì—… ê·œëª¨' },
        { key: 'companyType', name: 'ê¸°ì—… í˜•íƒœ' },
        { key: 'ksicCode', name: 'ì—…ì¢…(KSIC)' },
        { key: 'locationSido', name: 'ì†Œì¬ì§€(ì‹œë„)' },
        { key: 'capitalArea', name: 'ìˆ˜ë„ê¶Œ ì—¬ë¶€' },
        { key: 'revenueRecent', name: 'ìµœê·¼ ë§¤ì¶œì•¡' },
        { key: 'taxArrears', name: 'êµ­ì„¸ ì²´ë‚© ì—¬ë¶€' },
        { key: 'localTaxArrears', name: 'ì§€ë°©ì„¸ ì²´ë‚© ì—¬ë¶€' },
        { key: 'employeesTotal', name: 'ìƒì‹œê·¼ë¡œì ìˆ˜' }
      ];
      
      const missingFields = requiredFields.filter(f => {
        const val = companyData[f.key];
        return val === '' || val === null || val === undefined || val === 0;
      });
      
      // í¬ë§ ì§€ì›ë¶„ì•¼ ì²´í¬
      if (!companyData.supportNeeds || companyData.supportNeeds.length === 0) {
        missingFields.push({ key: 'supportNeeds', name: 'í¬ë§ ì§€ì›ë¶„ì•¼' });
      }
      
      if (missingFields.length > 0) {
        const fieldNames = missingFields.map(f => 'â€¢ ' + f.name).join('\n');
        alert('ë‹¤ìŒ í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n\n' + fieldNames);
        return;
      }
      
      try {
        showLoadingOverlay('ë§ì¶¤ ì§€ì›ì‚¬ì—… ì°¾ëŠ” ì¤‘...', 'ê¸°ì—…ë§ˆë‹¹ì—ì„œ ê³µê³ ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...');
        
        // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë§¤ì¹­ ì‹¤í–‰
        const results = await clientSideMatching(companyData);
        
        // ì•½ê°„ì˜ ëŒ€ê¸° ì‹œê°„ (ë¡œë”© íš¨ê³¼)
        await new Promise(resolve => setTimeout(resolve, 300));
        
        hideLoadingOverlay();
        displayResults({ recommendations: results });
        
        // ë§ì¶¤ì°¾ê¸° ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì • (ìš”ì•½/ìƒì„¸ ë¶„ì„ ê°€ëŠ¥)
        hasCompletedSearch = true;
        
        // âœ… ê²°ê³¼ ì €ì¥ (ìš”ì•½/ìƒì„¸ë¶„ì„ì—ì„œ ì‚¬ìš©)
        lastMatchedPrograms = results;
        lastCompanyData = companyData;
        
        console.log('âœ… ë§ì¶¤ì°¾ê¸° ì™„ë£Œ:', results.length, 'ê°œ ì¶”ì²œ');
        
      } catch (error) {
        hideLoadingOverlay();
        console.error('âŒ ë§ì¶¤ì°¾ê¸° ì˜¤ë¥˜:', error);
        alert('ë§ì¶¤ì°¾ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    /**
     * ìš”ì•½ë¶„ì„: API ìš”ì•½ ì •ë³´ë¡œ AI ë¶„ì„
     */
    async function analyzeProgramsSummary() {
      // ë¨¼ì € ë§ì¶¤ì°¾ê¸°ê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (!hasCompletedSearch) {
        alert('âš ï¸ ë¨¼ì € "ì§€ì›ì‚¬ì—…+ë¶„ì„" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!\n\nì§€ì›ì‚¬ì—…+ë¶„ì„ìœ¼ë¡œ ì¶”ì²œëœ ê³µê³ ê°€ ìˆì–´ì•¼ ìš”ì•½ë¶„ì„ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (!lastMatchedPrograms || lastMatchedPrograms.length === 0) {
        alert('âš ï¸ ì§€ì›ì‚¬ì—…+ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì§€ì›ì‚¬ì—…+ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ê°€ì ¸ì˜¨ ëª¨ë“  í”„ë¡œê·¸ë¨
      const allPrograms = lastMatchedPrograms;
      
      // ğŸ†• ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ì™€ ë¹„êµí•˜ì—¬ ì‹ ê·œ ê³µê³  í™•ì¸
      const existingIds = lastSummaryResults.map(s => s.programId || s.id);
      const newPrograms = allPrograms.filter(p => !existingIds.includes(p.id));
      
      // 100% ë™ì¼í•˜ë©´ ì°¨ê° ì—†ì´ ê¸°ì¡´ ê²°ê³¼ í‘œì‹œ
      if (newPrograms.length === 0 && lastSummaryResults.length > 0) {
        alert(
          'âœ… ì´ë¯¸ ëª¨ë“  ê³µê³ ì˜ ìš”ì•½ë¶„ì„ì´ ì™„ë£Œë˜ì–´ ìˆìŠµë‹ˆë‹¤!\n\n' +
          `â€¢ ê¸°ì¡´ ë¶„ì„ ê²°ê³¼: ${lastSummaryResults.length}ê°œ\n\n` +
          'ğŸ’° í¬ë ˆë”§ì´ ì°¨ê°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
        );
        // ê¸°ì¡´ ê²°ê³¼ ë‹¤ì‹œ í‘œì‹œ
        updateResultsWithSummary(lastSummaryResults);
        return;
      }
      
      // ğŸ†• í¬ë ˆë”§ í™•ì¸ (ì‹ ê·œ ê³µê³ ê°€ ìˆì„ ë•Œë§Œ)
      const canProceed = await checkAndConfirmCredits('summary');
      if (!canProceed) return;
      
      try {
        showLoadingOverlay('ğŸ¤– AI ìš”ì•½ë¶„ì„ ì¤‘...', 'â­ ' + allPrograms.length + 'ê°œ ì§€ì›ì‚¬ì—…ì„ Gemini AIë¡œ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...', allPrograms.length);
        
        // ë¶„ì„ ì¤‘ ë©”ì‹œì§€ í‘œì‹œ
        const loadingDetail = document.getElementById('aiLoadingDetail');
        if (loadingDetail) {
          loadingDetail.textContent = 'ì„œë²„ì—ì„œ AI ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
        }
        
        // Firebase Functionsë¥¼ í†µí•´ Gemini API í˜¸ì¶œ (API í‚¤ ë³´í˜¸)
        const geminiSummary = functions.httpsCallable('geminiSummary');
        const result = await geminiSummary({
          companyData: lastCompanyData,
          programs: allPrograms,
          agentId: agentId  // ğŸ†• ë³¸ì‚¬ ID ì „ë‹¬
        });
        
        const data = result.data;
        
        if (!data.success) {
          throw new Error(data.error || 'AI ë¶„ì„ ì‹¤íŒ¨');
        }
        
        const summaryResults = data.results;
        
        // 100% ì™„ë£Œ í‘œì‹œ í›„ ë‹«ê¸°
        updateProgress(100, allPrograms.length, allPrograms.length);
        
        setTimeout(async () => {
          hideLoadingOverlay();
          
          // ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
          updateResultsWithSummary(summaryResults);
          
          // ğŸ†• í¬ë ˆë”§ ì°¨ê° (ì„œë²„ì—ì„œ ì²˜ë¦¬)
          await deductCredits('summary');
          
          // ğŸ†• ì™„ë£Œ ë©”ì‹œì§€ (ì”ì•¡ í¬í•¨)
          showCompletionWithCredits('summary', summaryResults.length);
        }, 500);
        
      } catch (error) {
        hideLoadingOverlay();
        console.error('âŒ ìš”ì•½ë¶„ì„ ì˜¤ë¥˜:', error);
        alert('ìš”ì•½ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message + '\n\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }
    
    /**
     * ìƒì„¸ë¶„ì„: PDF ì „ë¬¸ AI ë¶„ì„ ìˆ˜í–‰
     */
    async function analyzeProgramsDetail() {
      // ë¨¼ì € ì§€ì›ì‚¬ì—…+ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (!hasCompletedSearch) {
        alert('âš ï¸ ë¨¼ì € "ì§€ì›ì‚¬ì—…+ë¶„ì„" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!\n\nì§€ì›ì‚¬ì—…+ë¶„ì„ìœ¼ë¡œ ì¶”ì²œëœ ê³µê³ ê°€ ìˆì–´ì•¼ ìƒì„¸ë¶„ì„ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (!lastMatchedPrograms || lastMatchedPrograms.length === 0) {
        alert('âš ï¸ ì§€ì›ì‚¬ì—…+ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì§€ì›ì‚¬ì—…+ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // PDF URLì´ ìˆëŠ” í”„ë¡œê·¸ë¨ë§Œ í•„í„°ë§ í›„ ìƒìœ„ 10ê°œ
      console.log('ğŸ“‹ lastMatchedPrograms:', lastMatchedPrograms.length, 'ê°œ');
      console.log('ğŸ“‹ ì²«ë²ˆì§¸ í”„ë¡œê·¸ë¨ ìƒ˜í”Œ:', lastMatchedPrograms[0] ? {
        id: lastMatchedPrograms[0].id,
        name: lastMatchedPrograms[0].name?.substring(0, 30),
        printFileUrl: lastMatchedPrograms[0].printFileUrl || 'ì—†ìŒ',
        attachmentUrl: lastMatchedPrograms[0].attachmentUrl || 'ì—†ìŒ'
      } : 'ì—†ìŒ');
      
      const programsWithPDF = lastMatchedPrograms
        .filter(p => p.printFileUrl || p.attachmentUrl)
        .slice(0, 10);
      
      console.log('ğŸ“„ PDF URL ìˆëŠ” ê³µê³ :', programsWithPDF.length, 'ê°œ');
      
      if (programsWithPDF.length === 0) {
        alert('âš ï¸ PDF ê³µê³ ë¬¸ì´ ìˆëŠ” ì§€ì›ì‚¬ì—…ì´ ì—†ìŠµë‹ˆë‹¤.\n\nìš”ì•½ë¶„ì„ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ğŸ†• ê¸°ì¡´ ìƒì„¸ë¶„ì„ ê²°ê³¼ì™€ ë¹„êµí•˜ì—¬ ì‹ ê·œ ê³µê³  í™•ì¸
      const existingDetailIds = lastDetailResults.map(d => d.programId);
      const newProgramsToAnalyze = programsWithPDF.filter(p => !existingDetailIds.includes(p.id));
      const existingPrograms = programsWithPDF.filter(p => existingDetailIds.includes(p.id));
      
      console.log(`ğŸ“„ ìƒì„¸ë¶„ì„: ì „ì²´ ${programsWithPDF.length}ê°œ ì¤‘ ê¸°ì¡´ ${existingPrograms.length}ê°œ ì œì™¸, ì‹ ê·œ ${newProgramsToAnalyze.length}ê°œ ë¶„ì„`);
      
      // ğŸ†• 100% ë™ì¼í•˜ë©´ ì°¨ê° ì—†ì´ ê¸°ì¡´ ê²°ê³¼ í‘œì‹œ
      if (newProgramsToAnalyze.length === 0) {
        alert(
          'âœ… ì´ë¯¸ ëª¨ë“  ê³µê³ ì˜ ìƒì„¸ë¶„ì„ì´ ì™„ë£Œë˜ì–´ ìˆìŠµë‹ˆë‹¤!\n\n' +
          `â€¢ ê¸°ì¡´ ë¶„ì„ ê²°ê³¼: ${existingPrograms.length}ê°œ\n\n` +
          'ğŸ’° í¬ë ˆë”§ì´ ì°¨ê°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
        );
        // ê¸°ì¡´ ê²°ê³¼ ë‹¤ì‹œ í‘œì‹œ
        updateResultsWithPDFDetail(lastDetailResults);
        return;
      }
      
      // ğŸ†• í¬ë ˆë”§ í™•ì¸ (ì‹ ê·œ ê³µê³ ê°€ ìˆì„ ë•Œë§Œ - 2,000P í•„ìš”)
      const canProceed = await checkAndConfirmCredits('detail');
      if (!canProceed) return;
      
      try {
        showLoadingOverlay('ğŸ“„ AI PDF ìƒì„¸ë¶„ì„ ì¤‘...', `â­ ì‹ ê·œ ${newProgramsToAnalyze.length}ê°œ ê³µê³ ë¬¸ì„ Gemini AIê°€ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ê¸°ì¡´ ${existingPrograms.length}ê°œ ìœ ì§€)`, newProgramsToAnalyze.length);
        
        const newDetailResults = [];
        
        // ì‹ ê·œ í”„ë¡œê·¸ë¨ì˜ PDFë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ë¶„ì„
        for (let i = 0; i < newProgramsToAnalyze.length; i++) {
          const program = newProgramsToAnalyze[i];
          const pdfUrl = program.printFileUrl || program.attachmentUrl;
          
          console.log(`ğŸ“„ [${i + 1}/${newProgramsToAnalyze.length}] PDF ë¶„ì„ ì¤‘: ${program.name}`);
          console.log(`   â†’ PDF URL: ${pdfUrl || 'ì—†ìŒ'}`);
          
          // ğŸ”¥ pdfUrlì´ ì—†ìœ¼ë©´ ë°”ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
          if (!pdfUrl) {
            console.warn(`âš ï¸ PDF URL ì—†ìŒ - ì‹¤íŒ¨ ì²˜ë¦¬: ${program.name}`);
            newDetailResults.push({
              index: i,
              programId: program.id,
              programName: program.name,
              programSummary: 'ğŸ“Œ ê³µê³ ë¬¸ íŒŒì¼(PDF)ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„¸ë³´ê¸°ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
              eligibility: {
                companySize: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                businessAge: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                requiredCerts: [],
                regionLimit: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                otherRequirements: ['ê³µê³ ë¬¸ PDF íŒŒì¼ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'ìƒì„¸ë³´ê¸° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”']
              },
              budget: { totalBudget: '-', perCompany: '-', selectedCount: '-', supportDetails: '-' },
              documents: { required: ['ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸'], optional: [] },
              schedule: { applicationPeriod: 'ê³µê³ ë¬¸ í™•ì¸ í•„ìš”', applicationMethod: 'ê³µê³ ë¬¸ í™•ì¸ í•„ìš”' },
              evaluation: { stages: [], criteria: [], bonusPoints: [] },
              companyFit: {
                eligible: false,
                fitScore: 50,
                strengths: ['ê³µê³ ë¬¸ì„ ì§ì ‘ ê²€í† í•˜ì—¬ íŒë‹¨ í•„ìš”'],
                weaknesses: ['PDF ê³µê³ ë¬¸ ì—†ìŒ'],
                recommendation: 'âš ï¸ ê³µê³ ë¬¸ PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„¸ë³´ê¸°ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.'
              },
              analysisError: true,
              noPdfUrl: true
            });
            continue;
          }
          
          // ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸ - ì‹¤ì œ ì§„í–‰ë¥  í‘œì‹œ
          const percent = Math.round(((i + 1) / newProgramsToAnalyze.length) * 100);
          updateProgress(percent, i + 1, newProgramsToAnalyze.length);
          
          const loadingDetail = document.getElementById('aiLoadingDetail');
          if (loadingDetail) {
            loadingDetail.textContent = `ë¶„ì„ ì¤‘: ${program.name.substring(0, 30)}...`;
          }
          
          try {
            // Firebase Functionsë¥¼ í†µí•´ PDF ë¶„ì„ (API í‚¤ ë³´í˜¸)
            const analyzeProgramPDF = functions.httpsCallable('analyzeProgramPDF');
            
            // ğŸ”¥ ìµœëŒ€ 2íšŒ ì¬ì‹œë„
            let data = null;
            let lastError = null;
            
            for (let retry = 0; retry < 2; retry++) {
              try {
                const result = await analyzeProgramPDF({
                  pdfUrl: pdfUrl,
                  companyData: lastCompanyData,
                  agentId: agentId
                });
                data = result.data;
                if (data.success && data.analysis) {
                  break; // ì„±ê³µí•˜ë©´ ë°˜ë³µ ì¢…ë£Œ
                }
              } catch (retryError) {
                lastError = retryError;
                console.log(`âš ï¸ [${retry + 1}/2] ì¬ì‹œë„ ì¤‘: ${program.name}`);
                await new Promise(r => setTimeout(r, 1000)); // 1ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„
              }
            }
            
            if (data && data.success && data.analysis) {
              newDetailResults.push({
                index: i,
                programId: program.id,
                programName: program.name,
                ...data.analysis
              });
              console.log(`âœ… PDF ë¶„ì„ ì™„ë£Œ: ${program.name}`);
            } else {
              // ğŸ”¥ ë¶„ì„ ì‹¤íŒ¨í•´ë„ ê²°ê³¼ì— í¬í•¨ (ì°¸ê³ ìš©)
              console.warn(`âš ï¸ PDF ë¶„ì„ ì‹¤íŒ¨ (ê²°ê³¼ í¬í•¨): ${program.name}`);
              newDetailResults.push({
                index: i,
                programId: program.id,
                programName: program.name,
                programSummary: 'ğŸ“Œ PDF ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³µê³ ë¬¸ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                eligibility: {
                  companySize: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                  businessAge: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                  requiredCerts: [],
                  regionLimit: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                  otherRequirements: ['PDF ë¶„ì„ ì˜¤ë¥˜ë¡œ ìë™ ë¶„ì„ì´ ë¶ˆê°€í•©ë‹ˆë‹¤', 'ê³µê³ ë¬¸ PDFë¥¼ ì§ì ‘ ë‹¤ìš´ë¡œë“œí•˜ì—¬ í™•ì¸í•´ì£¼ì„¸ìš”']
                },
                budget: {
                  totalBudget: 'ê³µê³ ë¬¸ í™•ì¸ í•„ìš”',
                  perCompany: 'ê³µê³ ë¬¸ í™•ì¸ í•„ìš”',
                  selectedCount: 'ê³µê³ ë¬¸ í™•ì¸ í•„ìš”',
                  supportDetails: 'ê³µê³ ë¬¸ í™•ì¸ í•„ìš”'
                },
                documents: { required: ['ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸'], optional: [] },
                schedule: { applicationPeriod: 'ê³µê³ ë¬¸ í™•ì¸ í•„ìš”', applicationMethod: 'ê³µê³ ë¬¸ í™•ì¸ í•„ìš”' },
                evaluation: { stages: [], criteria: [], bonusPoints: [] },
                companyFit: {
                  eligible: false,
                  fitScore: 50,
                  strengths: ['ê³µê³ ë¬¸ì„ ì§ì ‘ ê²€í† í•˜ì—¬ íŒë‹¨ í•„ìš”'],
                  weaknesses: ['ìë™ ë¶„ì„ ì‹¤íŒ¨'],
                  recommendation: 'âš ï¸ PDF ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³µê³ ë¬¸ì„ ì§ì ‘ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ìê²©ìš”ê±´ê³¼ ì§€ì›ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
                },
                analysisError: true
              });
            }
            
          } catch (pdfError) {
            // ğŸ”¥ ìµœì¢… ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê²°ê³¼ì— í¬í•¨
            console.error(`âŒ PDF ì²˜ë¦¬ ì˜¤ë¥˜ (${program.name}):`, pdfError);
            newDetailResults.push({
              index: i,
              programId: program.id,
              programName: program.name,
              programSummary: 'ğŸ“Œ PDF ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³µê³ ë¬¸ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
              eligibility: {
                companySize: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                businessAge: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                requiredCerts: [],
                regionLimit: 'ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”',
                otherRequirements: ['PDF ë¶„ì„ ì˜¤ë¥˜: ' + (pdfError.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')]
              },
              budget: { totalBudget: '-', perCompany: '-', selectedCount: '-', supportDetails: '-' },
              documents: { required: ['ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸'], optional: [] },
              schedule: { applicationPeriod: '-', applicationMethod: '-' },
              evaluation: { stages: [], criteria: [], bonusPoints: [] },
              companyFit: {
                eligible: false,
                fitScore: 50,
                strengths: ['ê³µê³ ë¬¸ì„ ì§ì ‘ ê²€í† í•˜ì—¬ íŒë‹¨ í•„ìš”'],
                weaknesses: ['ìë™ ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ'],
                recommendation: 'âš ï¸ ' + (pdfError.message || 'PDF ë¶„ì„ ì˜¤ë¥˜') + ' - ê³µê³ ë¬¸ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.'
              },
              analysisError: true
            });
          }
        }
        
        hideLoadingOverlay();
        
        // ê¸°ì¡´ ê²°ê³¼ì™€ ì‹ ê·œ ê²°ê³¼ ë³‘í•©
        lastDetailResults = [...lastDetailResults.filter(d => !newDetailResults.some(n => n.programId === d.programId)), ...newDetailResults];
        
        // ì „ì²´ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
        updateResultsWithPDFDetail(lastDetailResults);
        
        // ğŸ”¥ ì„±ê³µ/ì‹¤íŒ¨ ê°œìˆ˜ ê³„ì‚°
        const successCount = newDetailResults.filter(r => !r.analysisError).length;
        const failCount = newDetailResults.filter(r => r.analysisError).length;
        
        // ì™„ë£Œ ë©”ì‹œì§€ (ì‹ ê·œ ë¶„ì„ vs ê¸°ì¡´ ê²°ê³¼ êµ¬ë¶„)
        const existingCount = existingPrograms.length;
        const newCount = newDetailResults.length;
        let detailMsg = '';
        if (existingCount > 0 && newCount > 0) {
          detailMsg = `ê¸°ì¡´ ${existingCount}ê°œ ìœ ì§€ + ì‹ ê·œ ${newCount}ê°œ ë¶„ì„`;
        } else {
          detailMsg = `${newCount}ê°œ ë¶„ì„ ì™„ë£Œ`;
        }
        
        // ğŸ”¥ ì‹¤íŒ¨í•œ ê²ƒì´ ìˆìœ¼ë©´ ì•ˆë‚´
        if (failCount > 0) {
          detailMsg += `\n(âœ… ì„±ê³µ ${successCount}ê°œ / âš ï¸ ì‹¤íŒ¨ ${failCount}ê°œ)`;
        }
        
        // ğŸ†• ì‹ ê·œ ë¶„ì„ì´ ìˆì—ˆì„ ë•Œë§Œ í¬ë ˆë”§ ì°¨ê°
        if (newCount > 0) {
          await deductCredits('detail');
          
          alert(
            `âœ… AI PDF ìƒì„¸ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
            `${detailMsg}\n` +
            `ì´ ${lastDetailResults.length}ê°œ ê³µê³ ì˜ ìƒì„¸ ë¶„ì„ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\n` +
            (failCount > 0 ? `âš ï¸ ì‹¤íŒ¨í•œ ${failCount}ê°œëŠ” ê³µê³ ë¬¸ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.\n\n` : '') +
            `ğŸ’³ ì°¨ê° í¬ì¸íŠ¸: 2,000P\n` +
            `ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: ${(userCredits?.paidBalance || 0).toLocaleString()}P`
          );
        } else {
          alert(`âœ… AI PDF ìƒì„¸ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${detailMsg}\nì´ ${lastDetailResults.length}ê°œ ê³µê³ ì˜ ìƒì„¸ ë¶„ì„ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
        }
        
      } catch (error) {
        hideLoadingOverlay();
        console.error('âŒ PDF ìƒì„¸ë¶„ì„ ì˜¤ë¥˜:', error);
        
        // ğŸ†• í•œë„ ì´ˆê³¼ ì—ëŸ¬ì¸ ê²½ìš° êµ¬ë¶„ í‘œì‹œ
        if (error.message && error.message.includes('í•œë„')) {
          alert('âš ï¸ ' + error.message);
        } else {
          alert('PDF ìƒì„¸ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message + '\n\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }
    }
    
    // ë¡œë”© ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateLoadingProgress(current, total, programName) {
      const loadingDetail = document.getElementById('aiLoadingDetail');
      if (loadingDetail) {
        loadingDetail.textContent = `ğŸ“„ ${current}/${total}ê°œ ê³µê³  ë¶„ì„ ì™„ë£Œ - ${programName}`;
      }
    }
    
    /**
     * PDF ìƒì„¸ë¶„ì„ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
     */
    function updateResultsWithPDFDetail(pdfResults) {
      const resultCards = document.querySelectorAll('.result-card');
      
      // requestAnimationFrameìœ¼ë¡œ ê¹œë¹¡ì„ ë°©ì§€
      requestAnimationFrame(() => {
        pdfResults.forEach((result) => {
          // í•´ë‹¹ í”„ë¡œê·¸ë¨ì˜ ì¹´ë“œ ì°¾ê¸° (programIdë¡œ ë§¤ì¹­)
          let targetCard = null;
          resultCards.forEach((card) => {
            const cardProgramId = card.getAttribute('data-program-id');
            if (cardProgramId && cardProgramId === result.programId) {
              targetCard = card;
            }
          });
          
          // programIdë¡œ ëª» ì°¾ìœ¼ë©´ indexë¡œ í´ë°±
          if (!targetCard) {
            resultCards.forEach((card, idx) => {
              if (idx === result.index) {
                targetCard = card;
              }
            });
          }
          
          if (!targetCard) return;
        
        // ê¸°ì¡´ ìƒì„¸ë¶„ì„ ì œê±°
        const existingDetail = targetCard.querySelector('.ai-detail-box');
        if (existingDetail) {
          existingDetail.remove();
        }
        
        // PDF ìƒì„¸ë¶„ì„ ê²°ê³¼ ë°•ìŠ¤ ìƒì„±
        const detailBox = document.createElement('div');
        detailBox.className = 'ai-detail-box';
        
        // ğŸ”¥ ë¶„ì„ ì˜¤ë¥˜ ì—¬ë¶€ì— ë”°ë¼ ìŠ¤íƒ€ì¼ ë³€ê²½
        const hasError = result.analysisError === true;
        const borderColor = hasError ? '#ffc107' : '#28a745';
        
        detailBox.style.cssText = `
          margin-top: 1.5rem;
          padding: 1.5rem;
          background: #ffffff;
          border-radius: 12px;
          box-shadow: 0 6px 12px rgba(0,0,0,0.1);
          border: 2px solid ${borderColor};
        `;
        
        // ì ìˆ˜ì— ë”°ë¥¸ ë“±ê¸‰ ë° ìƒ‰ìƒ
        const isEligibleDetail = result.companyFit?.eligible === true;
        const rawScoreDetail = result.companyFit?.fitScore || 0;
        // ğŸ”¥ ë¶€ì í•©ì´ë©´ ê´€ë ¨ë„ë¥¼ "ì°¸ê³ "(60ì  ë¯¸ë§Œ)ë¡œ ê°•ì œ í‘œì‹œ
        const fitScore = isEligibleDetail ? rawScoreDetail : Math.min(rawScoreDetail, 59);
        const grade = getRelevanceGrade(fitScore);
        
        // ğŸ”¥ ì˜¤ë¥˜ ì‹œ ì œëª© ë³€ê²½
        const headerTitle = hasError ? 'âš ï¸ PDF ë¶„ì„ ì‹¤íŒ¨ (ê³µê³ ë¬¸ ì§ì ‘ í™•ì¸ í•„ìš”)' : 'AI PDF ìƒì„¸ë¶„ì„';
        const headerColor = hasError ? '#856404' : '#28a745';
        
        detailBox.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.8rem; border-bottom: 2px solid #eee;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1.5rem;">${hasError ? 'âš ï¸' : 'ğŸ“„'}</span>
              <h5 style="color: ${headerColor}; margin: 0; font-size: 1.1rem; font-weight: 700;">${headerTitle}</h5>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: ${grade.headerBg}; color: ${grade.headerText}; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                ${grade.icon} ê´€ë ¨ë„: ${grade.text}
              </span>
              <span style="background: ${grade.bgColor}; color: ${grade.color}; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                ${hasError ? 'ì§ì ‘í™•ì¸' : fitScore + 'ì '}
              </span>
            </div>
          </div>
          
          <!-- ì‚¬ì—… ìš”ì•½ -->
          <div style="background: ${hasError ? '#fff8e6' : '#f0fff4'}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid ${hasError ? '#ffc107' : '#28a745'};">
            <h6 style="color: ${hasError ? '#856404' : '#155724'}; margin: 0 0 0.5rem 0; font-size: 0.95rem; font-weight: 700;">ğŸ“‹ ì‚¬ì—… ìš”ì•½</h6>
            <p style="color: #333; margin: 0; line-height: 1.6; font-size: 0.95rem;">${result.programSummary || 'ì •ë³´ ì—†ìŒ'}</p>
          </div>
          
          <!-- ìê²©ìš”ê±´ -->
          <div style="background: #fff8e6; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
            <h6 style="color: #856404; margin: 0 0 0.5rem 0; font-size: 0.95rem; font-weight: 700;">ğŸ¯ ìê²©ìš”ê±´</h6>
            <ul style="color: #333; margin: 0; padding-left: 1.2rem; line-height: 1.8; font-size: 0.9rem;">
              <li><strong>ê¸°ì—…ê·œëª¨:</strong> ${result.eligibility?.companySize || 'í™•ì¸ í•„ìš”'}</li>
              <li><strong>ì—…ë ¥:</strong> ${result.eligibility?.businessAge || 'í™•ì¸ í•„ìš”'}</li>
              <li><strong>í•„ìˆ˜ì¸ì¦:</strong> ${result.eligibility?.requiredCerts?.join(', ') || 'ì—†ìŒ'}</li>
              <li><strong>ì§€ì—­ì œí•œ:</strong> ${result.eligibility?.regionLimit || 'ì „êµ­'}</li>
              ${result.eligibility?.otherRequirements?.map(r => `<li>${r}</li>`).join('') || ''}
            </ul>
          </div>
          
          <!-- ì§€ì›ê·œëª¨ -->
          <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #2196f3;">
            <h6 style="color: #0d47a1; margin: 0 0 0.5rem 0; font-size: 0.95rem; font-weight: 700;">ğŸ’° ì§€ì›ê·œëª¨</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
              <div><strong>ì´ ì˜ˆì‚°:</strong> ${result.budget?.totalBudget || 'í™•ì¸ í•„ìš”'}</div>
              <div><strong>ê¸°ì—…ë‹¹:</strong> ${result.budget?.perCompany || 'í™•ì¸ í•„ìš”'}</div>
              <div><strong>ì„ ì •ê·œëª¨:</strong> ${result.budget?.selectedCount || 'í™•ì¸ í•„ìš”'}</div>
              <div><strong>ì§€ì›ë‚´ìš©:</strong> ${result.budget?.supportDetails || 'í™•ì¸ í•„ìš”'}</div>
            </div>
          </div>
          
          <!-- ì œì¶œì„œë¥˜ -->
          <div style="background: #f3e5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #9c27b0;">
            <h6 style="color: #6a1b9a; margin: 0 0 0.5rem 0; font-size: 0.95rem; font-weight: 700;">ğŸ“ ì œì¶œì„œë¥˜</h6>
            <div style="font-size: 0.85rem; color: #333;">
              <p style="margin: 0 0 0.3rem 0;"><strong>í•„ìˆ˜:</strong> ${result.documents?.required?.slice(0, 5).join(', ') || 'í™•ì¸ í•„ìš”'}${result.documents?.required?.length > 5 ? ' ì™¸ ' + (result.documents.required.length - 5) + 'ê±´' : ''}</p>
              ${result.documents?.optional?.length > 0 ? `<p style="margin: 0;"><strong>ì„ íƒ:</strong> ${result.documents.optional.slice(0, 3).join(', ')}</p>` : ''}
            </div>
          </div>
          
          <!-- ì¼ì • -->
          <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #4caf50;">
            <h6 style="color: #2e7d32; margin: 0 0 0.5rem 0; font-size: 0.95rem; font-weight: 700;">ğŸ“… ì£¼ìš” ì¼ì •</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem; color: #333;">
              <div><strong>ì‹ ì²­ê¸°ê°„:</strong> ${result.schedule?.applicationPeriod || 'í™•ì¸ í•„ìš”'}</div>
              <div><strong>ì‹¬ì‚¬ê¸°ê°„:</strong> ${result.schedule?.reviewPeriod || 'í™•ì¸ í•„ìš”'}</div>
              <div><strong>ì„ ì •ë°œí‘œ:</strong> ${result.schedule?.selectionDate || 'í™•ì¸ í•„ìš”'}</div>
              <div><strong>ìˆ˜í–‰ê¸°ê°„:</strong> ${result.schedule?.executionPeriod || 'í™•ì¸ í•„ìš”'}</div>
            </div>
          </div>
          
          <!-- ê·€ì‚¬ ë¶„ì„ -->
          <div style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); padding: 1.2rem; border-radius: 10px; border: 2px solid #667eea;">
            <h6 style="color: #667eea; margin: 0 0 0.8rem 0; font-size: 1rem; font-weight: 700;">ğŸ¢ ${lastCompanyData.companyName} ë§ì¶¤ ë¶„ì„</h6>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <p style="color: #28a745; font-weight: 600; margin: 0 0 0.3rem 0; font-size: 0.9rem;">ğŸ’ª ê°•ì </p>
                <ul style="color: #333; margin: 0; padding-left: 1.2rem; font-size: 0.85rem; line-height: 1.6;">
                  ${result.companyFit?.strengths?.map(s => `<li>${s}</li>`).join('') || '<li>ë¶„ì„ ì¤‘</li>'}
                </ul>
              </div>
              <div>
                <p style="color: #dc3545; font-weight: 600; margin: 0 0 0.3rem 0; font-size: 0.9rem;">âš ï¸ ë³´ì™„ì </p>
                <ul style="color: #333; margin: 0; padding-left: 1.2rem; font-size: 0.85rem; line-height: 1.6;">
                  ${result.companyFit?.weaknesses?.map(w => `<li>${w}</li>`).join('') || '<li>ì—†ìŒ</li>'}
                </ul>
              </div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem;">
              <p style="color: #333; margin: 0; line-height: 1.7; font-size: 0.95rem;">
                <strong style="color: #667eea;">ğŸ’¡ ì¶”ì²œ ì˜ê²¬:</strong> ${result.companyFit?.recommendation || 'ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}
              </p>
            </div>
            
            <div style="background: #fff8e6; padding: 0.8rem; border-radius: 8px;">
              <p style="color: #856404; font-weight: 600; margin: 0 0 0.3rem 0; font-size: 0.85rem;">ğŸ“Œ ì„ ì • ê°€ëŠ¥ì„± ë†’ì´ëŠ” íŒ</p>
              <ul style="color: #333; margin: 0; padding-left: 1.2rem; font-size: 0.85rem; line-height: 1.6;">
                ${result.companyFit?.preparationTips?.map(t => `<li>${t}</li>`).join('') || '<li>ê³µê³ ë¬¸ì„ ìƒì„¸íˆ í™•ì¸í•˜ì„¸ìš”</li>'}
              </ul>
            </div>
          </div>
        `;
        
        targetCard.appendChild(detailBox);
        
        // ê´€ë ¨ë„ ë±ƒì§€ë¥¼ ìƒì„¸ë¶„ì„ ì ìˆ˜ë¡œ ì—…ë°ì´íŠ¸
        const scoreSpan = targetCard.querySelector('.match-score');
        if (scoreSpan) {
          const grade = getRelevanceGrade(fitScore);
          scoreSpan.style.background = grade.bgColor;
          scoreSpan.style.color = grade.color;
          scoreSpan.textContent = `ê´€ë ¨ë„: ${grade.text}`;
        }
        
        // ìš”ì•½ë¶„ì„ ë°•ìŠ¤ ìƒíƒœë„ ì ìˆ˜ì— ë§ê²Œ ë³€ê²½
        const summaryBox = targetCard.querySelector('.ai-summary-box');
        if (summaryBox) {
          const grade = getRelevanceGrade(fitScore);
          summaryBox.style.border = `2px solid ${grade.borderColor}`;
          const statusSpan = summaryBox.querySelector('span[style*="border-radius: 20px"]');
          if (statusSpan && !statusSpan.textContent.includes('ìƒì„¸ë¶„ì„')) {
            statusSpan.style.background = grade.headerBg;
            statusSpan.style.color = grade.headerText;
            statusSpan.innerHTML = `${grade.icon} ${grade.text} (ìƒì„¸ë¶„ì„)`;
          }
        }
        
        console.log(`âœ… ìƒì„¸ë¶„ì„ ì™„ë£Œ: ${result.programId} â†’ ì í•©ë„ ${fitScore}ì `);
        });
        
        // ğŸ†• ìƒì„¸ë¶„ì„ ì™„ë£Œ í›„ ì¹´ë“œ ìˆœì„œ ì¬ì •ë ¬ (ì ìˆ˜ìˆœ)
        reorderCardsAfterDetailAnalysis(pdfResults);
      });
    }
    
    /**
     * ìƒì„¸ë¶„ì„ í›„ ì¹´ë“œ ìˆœì„œ ì¬ì •ë ¬ (ì ìˆ˜ ë†’ì€ ìˆœ)
     */
    function reorderCardsAfterDetailAnalysis(pdfResults) {
      const resultsSection = document.getElementById('results-section');
      if (!resultsSection) return;
      
      const headerCard = resultsSection.querySelector('.card:not(.result-card)');
      const resultCards = Array.from(resultsSection.querySelectorAll('.result-card'));
      
      if (resultCards.length === 0) return;
      
      // ëª¨ë“  ì¹´ë“œë¥¼ ì ìˆ˜ì™€ í•¨ê»˜ ìˆ˜ì§‘
      const scoredCards = resultCards.map(card => {
        const cardId = card.getAttribute('data-program-id');
        const detailResult = pdfResults.find(r => r.programId === cardId);
        
        // ìƒì„¸ë¶„ì„ ì ìˆ˜ ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ë³¸ ë§¤ì¹­ ì ìˆ˜
        const fitScore = detailResult?.companyFit?.fitScore || parseInt(card.getAttribute('data-match-score') || '0');
        
        return { card, score: fitScore };
      });
      
      // ì ìˆ˜ìˆœ ì •ë ¬ (ë†’ì€ ì ìˆ˜ â†’ ë‚®ì€ ì ìˆ˜)
      scoredCards.sort((a, b) => b.score - a.score);
      
      // DOM ì¬ë°°ì¹˜ ë° ìˆœìœ„ ì—…ë°ì´íŠ¸
      scoredCards.forEach(({ card, score }, index) => {
        resultsSection.appendChild(card);
        
        // ìˆœìœ„ ì—…ë°ì´íŠ¸
        const rankSpan = card.querySelector('.rank');
        if (rankSpan) {
          const rank = index + 1;
          const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
          rankSpan.innerHTML = `${rankEmoji} ${rank}ìœ„`;
        }
        
        // ê´€ë ¨ë„ ì—…ë°ì´íŠ¸
        const scoreSpan = card.querySelector('.match-score');
        if (scoreSpan) {
          const grade = getRelevanceGrade(score);
          scoreSpan.style.background = grade.bgColor;
          scoreSpan.style.color = grade.color;
          scoreSpan.textContent = `ê´€ë ¨ë„: ${grade.text}`;
        }
        
        // rank í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
        card.classList.remove('rank-1', 'rank-2', 'rank-3');
        if (index === 0) card.classList.add('rank-1');
        else if (index === 1) card.classList.add('rank-2');
        else if (index === 2) card.classList.add('rank-3');
      });
      
      console.log(`âœ… ìƒì„¸ë¶„ì„ í›„ ì¹´ë“œ ì¬ì •ë ¬ (ì ìˆ˜ìˆœ): ${scoredCards.length}ê°œ`);
    }
    
    function showLoadingOverlay(title, subtitle, analysisCount = null) {
      // AI ë¶„ì„ ì‹œì—ëŠ” analysisCount ì‚¬ìš©, ì•„ë‹ˆë©´ ì „ì²´ ê³µê³ ìˆ˜
      const isAIAnalysis = analysisCount !== null;
      const totalPrograms = isAIAnalysis ? analysisCount : (bizInfoPrograms.length || 500);
      
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loading-overlay';
      overlay.dataset.isAiAnalysis = isAIAnalysis;
      overlay.dataset.totalCount = totalPrograms;
      
      overlay.innerHTML = `
        <div class="loader"></div>
        <h2>${title}</h2>
        <p>${subtitle}</p>
        <p id="program-count" style="font-size: 0.85rem; color: #ffd27f; margin-top: 0.5rem;">
          ${isAIAnalysis ? `ğŸ“‹ 0/${totalPrograms}ê°œ ê³µê³  ë¶„ì„ ì™„ë£Œ` : `ğŸ“‹ ${totalPrograms}ê°œ ê³µê³  ë¶„ì„ ì¤‘...`}
        </p>
        <div style="width: 200px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
          <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #FF8802, #FFB347); border-radius: 4px; transition: width 0.3s;"></div>
        </div>
        <p id="progress-text" style="font-size: 0.9rem; margin-top: 0.5rem; font-weight: bold;">0%</p>
        <p id="aiLoadingDetail" style="font-size: 0.75rem; color: #aaa; margin-top: 0.3rem;"></p>
      `;
      document.body.appendChild(overlay);
      
      // AI ë¶„ì„ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìë™ ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜
      if (!isAIAnalysis) {
        let progress = 0;
        let analyzed = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          analyzed = Math.min(Math.floor(progress / 100 * totalPrograms), totalPrograms);
          if (progress > 90) progress = 90;
          updateProgress(progress, analyzed, totalPrograms);
          if (progress >= 90) clearInterval(progressInterval);
        }, 200);
        
        overlay.progressInterval = progressInterval;
      }
    }
    
    function updateProgress(percent, analyzed, total) {
      const bar = document.getElementById('progress-bar');
      const text = document.getElementById('progress-text');
      const countText = document.getElementById('program-count');
      if (bar) bar.style.width = percent + '%';
      if (text) text.textContent = Math.round(percent) + '%';
      if (countText && analyzed !== undefined) {
        countText.textContent = `ğŸ“‹ ${analyzed || 0}/${total || 0}ê°œ ê³µê³  ë¶„ì„ ì™„ë£Œ`;
      }
    }
    
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) {
        if (overlay.progressInterval) clearInterval(overlay.progressInterval);
        
        // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
        const scrollY = window.scrollY;
        
        // AI ë¶„ì„ì¸ ê²½ìš° 100% í‘œì‹œ í›„ ë‹«ê¸°
        const isAIAnalysis = overlay.dataset.isAiAnalysis === 'true';
        const totalCount = parseInt(overlay.dataset.totalCount) || 10;
        
        if (isAIAnalysis) {
          updateProgress(100, totalCount, totalCount);
        } else {
          const totalPrograms = bizInfoPrograms.length || 500;
          updateProgress(100, totalPrograms, totalPrograms);
        }
        
        setTimeout(() => {
          overlay.remove();
          // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
          window.scrollTo(0, scrollY);
        }, 500);
      }
    }
    
    function displayResults(result) {
      const section = document.getElementById('results-section');
      
      if (!result.recommendations || result.recommendations.length === 0) {
        section.innerHTML = `
          <div class="card">
            <h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
            <div style="text-align: center; padding: 3rem; color: #666;">
              <p style="font-size: 1.2rem; margin-bottom: 1rem;">í˜„ì¬ ì¡°ê±´ì— ë§ëŠ” ì§€ì›ì‚¬ì—…ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
              <p>â€¢ ì…ë ¥ ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”</p>
              <p>â€¢ ë˜ëŠ” ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš” (1357-1357)</p>
            </div>
          </div>
        `;
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
        return;
      }
      
      let html = `
        <div class="card">
          <h2>ğŸ“Š ë§ì¶¤í˜• ì§€ì›ì‚¬ì—… ì¶”ì²œ ê²°ê³¼</h2>
          <p style="color: #666; margin-top: 0.5rem;">
            ì´ <strong style="color: #FF8802;">${result.recommendations.length}ê°œ</strong>ì˜ ì§€ì›ì‚¬ì—…ì´ ê·€ì‚¬ì— ì í•©í•©ë‹ˆë‹¤.
          </p>
        </div>
      `;
      
      result.recommendations.forEach((rec, index) => {
        const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
        const rankEmoji = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
        const initialGrade = getRelevanceGrade(rec.matchScore);
        
        html += `
          <div class="result-card ${rankClass}" data-program-id="${rec.id || ''}" data-match-score="${rec.matchScore || 0}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <span class="rank">${rankEmoji} ${index + 1}ìœ„</span>
              <span class="match-score" style="font-size: 1rem; font-weight: bold; background: ${initialGrade.bgColor}; color: ${initialGrade.color}; padding: 0.3rem 0.8rem; border-radius: 20px;">ê´€ë ¨ë„: ${initialGrade.text}</span>
            </div>
            
            <h3 style="color: #0c2c54; margin-bottom: 0.5rem;">${rec.name}</h3>
            <p style="color:#666;font-size:0.9rem;margin-bottom:0.75rem;">
              <strong>ì£¼ê´€:</strong> ${rec.organization} | 
              <strong>ë¶„ì•¼:</strong> ${rec.category}
            </p>
            
            <div style="margin-top:1rem;padding-top:1rem;border-top:2px solid #e0e0e0;">
              <h4 style="color:#0c2c54;margin-bottom:0.75rem;font-size:1.05rem;">ğŸ¯ ì¶”ì²œ ì´ìœ </h4>
              <ul style="color:#555;line-height:1.8;padding-left:1.5rem;margin-bottom:1.5rem;">
                ${rec.matchReasons.map(reason => `<li>${reason}</li>`).join('')}
              </ul>
              
              <h4 style="color:#0c2c54;margin-bottom:0.75rem;font-size:1.05rem;">ğŸ’° ì§€ì› ë‚´ìš©</h4>
              <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <p style="color:#333;margin-bottom:0.5rem;"><strong>ì§€ì› ê·œëª¨:</strong> ${rec.budget}</p>
                <p style="color:#555;line-height:1.6;margin:0;">${rec.description}</p>
              </div>
              
              <div style="display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;">
                <a href="https://www.bizinfo.go.kr/web/lay1/bbs/S1T122C128/AS/74/view.do?pblancId=${rec.id}" target="_blank" 
                   style="display:inline-block;padding:0.7rem 1.5rem;background:#FF8802;color:white;text-decoration:none;border-radius:8px;font-weight:600;font-size:0.95rem;transition:all 0.3s;">
                  ğŸ“‹ ìƒì„¸ë³´ê¸° â†’
                </a>
                ${rec.applicationUrl ? `
                <a href="${rec.applicationUrl}" target="_blank" 
                   style="display:inline-block;padding:0.7rem 1.5rem;background:#4A90E2;color:white;text-decoration:none;border-radius:8px;font-weight:600;font-size:0.95rem;transition:all 0.3s;">
                  âœï¸ ì‹ ì²­í•˜ê¸° â†’
                </a>
                ` : ''}
                ${rec.attachmentUrl ? `
                <a href="${rec.attachmentUrl}" target="_blank" download
                   style="display:inline-block;padding:0.7rem 1.5rem;background:#28a745;color:white;text-decoration:none;border-radius:8px;font-weight:600;font-size:0.95rem;transition:all 0.3s;"
                   title="${rec.attachmentName || 'ì²¨ë¶€íŒŒì¼'}">
                  ğŸ“ ì²¨ë¶€íŒŒì¼ â†“
                </a>
                ` : ''}
                ${rec.printFileUrl ? `
                <a href="${rec.printFileUrl}" target="_blank" download
                   style="display:inline-block;padding:0.7rem 1.5rem;background:#dc3545;color:white;text-decoration:none;border-radius:8px;font-weight:600;font-size:0.95rem;transition:all 0.3s;"
                   title="${rec.printFileName || 'ê³µê³ ë¬¸ PDF'}">
                  ğŸ“„ ê³µê³ ë¬¸PDF â†“
                </a>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      });
      
      section.innerHTML = html;
      section.style.display = 'block';
      section.scrollIntoView({ behavior: 'smooth' });
    }
    
    /**
     * AI ìš”ì•½ë¶„ì„ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
     */
    function updateResultsWithSummary(summaryResults) {
      const resultCards = document.querySelectorAll('.result-card');
      
      summaryResults.forEach((result) => {
        // programIdë¡œ ë§¤ì¹­ ì‹œë„
        let targetCard = null;
        resultCards.forEach((card) => {
          const cardProgramId = card.getAttribute('data-program-id');
          if (cardProgramId && (cardProgramId === result.programId || cardProgramId === result.id)) {
            targetCard = card;
          }
        });
        
        // programIdë¡œ ëª» ì°¾ìœ¼ë©´ indexë¡œ í´ë°±
        if (!targetCard && result.index !== undefined && result.index < resultCards.length) {
          targetCard = resultCards[result.index];
        }
        
        if (!targetCard) return;
        
        // ê¸°ì¡´ AI ìš”ì•½ì´ ìˆìœ¼ë©´ ì œê±°
        const existingSummary = targetCard.querySelector('.ai-summary-box');
        if (existingSummary) {
          existingSummary.remove();
        }
        
        // ì í•©/ë¶€ì í•© ì—¬ë¶€ ë° ê´€ë ¨ë„ ë“±ê¸‰ ê²°ì •
        const isEligible = result.eligible === true;
        // ğŸ”¥ ë¶€ì í•©ì´ë©´ ê´€ë ¨ë„ë¥¼ "ì°¸ê³ "(60ì  ë¯¸ë§Œ)ë¡œ ê°•ì œ í‘œì‹œ
        const rawScore = result.fitScore || (isEligible ? 85 : 55);
        const fitScore = isEligible ? rawScore : Math.min(rawScore, 59);
        
        // ğŸ”¥ ìˆ˜ì •ëœ ì ìˆ˜ë¥¼ result ê°ì²´ì— ì €ì¥ (ì •ë ¬ì— ì‚¬ìš©)
        result.fitScore = fitScore;
        
        const grade = getRelevanceGrade(fitScore);
        
        // ê´€ë ¨ë„ ì—…ë°ì´íŠ¸ (ì¹´ë“œ í—¤ë”ì˜ ì ìˆ˜)
        const scoreSpan = targetCard.querySelector('.match-score');
        if (scoreSpan) {
          scoreSpan.style.background = grade.bgColor;
          scoreSpan.style.color = grade.color;
          scoreSpan.textContent = `ê´€ë ¨ë„: ${grade.text}`;
        }
        
        // AI ìš”ì•½ ë°•ìŠ¤ ìƒì„±
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'ai-summary-box';
        summaryDiv.style.cssText = `
          background: #ffffff;
          padding: 1.2rem;
          border-radius: 12px;
          margin-top: 1.5rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          border: 2px solid ${grade.borderColor};
          animation: slideIn 0.5s ease-out;
        `;
        
        // ë¶„ì„ ì´ìœ  HTML ìƒì„±
        let reasonHtml = '';
        if (isEligible && result.eligibleReason) {
          reasonHtml = `
            <div style="background: ${grade.headerBg}; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid ${grade.borderColor};">
              <p style="color: ${grade.headerText}; margin: 0; font-weight: 600; font-size: 0.9rem;">
                ${grade.icon} ë¶„ì„: <span style="font-weight: normal;">${result.eligibleReason}</span>
              </p>
            </div>
          `;
        } else if (!isEligible && result.ineligibleReason) {
          reasonHtml = `
            <div style="background: ${grade.headerBg}; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid ${grade.borderColor};">
              <p style="color: ${grade.headerText}; margin: 0; font-weight: 600; font-size: 0.9rem;">
                ${grade.icon} ë¶„ì„: <span style="font-weight: normal;">${result.ineligibleReason}</span>
              </p>
            </div>
          `;
        }
        
        // ìƒíƒœ í…ìŠ¤íŠ¸ = ê´€ë ¨ë„ ë“±ê¸‰
        const statusText = grade.text;
        
        summaryDiv.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.8rem; border-bottom: 2px solid #eee; flex-wrap: wrap; gap: 0.5rem;">
            <div style="display: flex; align-items: center;">
              <span style="font-size: 1.5rem; margin-right: 0.5rem;">ğŸ¤–</span>
              <h5 style="color: #667eea; margin: 0; font-size: 1.1rem; font-weight: 700;">AI ìš”ì•½ë¶„ì„</h5>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
              <span style="background: ${grade.headerBg}; color: ${grade.headerText}; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                ${grade.icon} ${statusText}
              </span>
              <button onclick="showDetailAnalysisConfirm()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.35rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.3rem; box-shadow: 0 2px 6px rgba(102,126,234,0.3); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 6px rgba(102,126,234,0.3)';">
                ğŸ“Š ìƒì„¸ë¶„ì„ë³´ê¸°
              </button>
            </div>
          </div>
          ${reasonHtml}
          <div style="background: #f8f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid #667eea;">
            <p style="color: #333; margin: 0; line-height: 1.7; font-size: 0.95rem;">
              ${result.summary || 'ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}
            </p>
          </div>
          <div style="background: #fff8e6; padding: 0.8rem; border-radius: 8px; border-left: 4px solid #ffc107;">
            <p style="color: #856404; margin: 0; font-weight: 600; font-size: 0.9rem;">
              ğŸ’¡ <span style="color: #0c2c54; font-weight: normal;">${result.recommendation || 'ì¶”ì²œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</span>
            </p>
          </div>
        `;
        
        // ì¹´ë“œì— ì¶”ê°€ (ê¸°ì¡´ ë‚´ìš© ë’¤ì—)
        targetCard.appendChild(summaryDiv);
      });
      
      // ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€ (í•œ ë²ˆë§Œ)
      if (!document.getElementById('ai-summary-animation')) {
        const style = document.createElement('style');
        style.id = 'ai-summary-animation';
        style.textContent = `
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translateY(20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      console.log('âœ… AI ìš”ì•½ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ:', summaryResults.length, 'ê°œ');
      
      // ì¹´ë“œ ìˆœì„œ ì¬ì •ë ¬ (ì ìˆ˜ ë†’ì€ ìˆœ)
      reorderResultCards(summaryResults);
    }
    
    /**
     * Gemini ë¶„ì„ ê²°ê³¼ì— ë”°ë¼ ì¹´ë“œ ìˆœì„œ ì¬ì •ë ¬ (ì ìˆ˜ ë†’ì€ ìˆœ)
     */
    function reorderResultCards(summaryResults) {
      const resultsSection = document.getElementById('results-section');
      const headerCard = resultsSection.querySelector('.card'); // í—¤ë” ì¹´ë“œ
      const resultCards = Array.from(resultsSection.querySelectorAll('.result-card'));
      
      if (resultCards.length === 0) return;
      
      // ğŸ”¥ ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ì ìˆ˜ â†’ ë‚®ì€ ì ìˆ˜)
      const sortedResults = [...summaryResults].sort((a, b) => {
        const scoreA = a.fitScore || 0;
        const scoreB = b.fitScore || 0;
        return scoreB - scoreA; // ë‚´ë¦¼ì°¨ìˆœ
      });
      
      // ì •ë ¬ëœ ìˆœì„œëŒ€ë¡œ ì¹´ë“œ ë°°ì¹˜
      const sortedCards = [];
      sortedResults.forEach(result => {
        const card = resultCards.find(c => {
          const cardId = c.getAttribute('data-program-id');
          return cardId === result.programId || cardId === result.id;
        });
        if (card) {
          sortedCards.push({ card, result });
        }
      });
      
      // ë¶„ì„ ê²°ê³¼ê°€ ì—†ëŠ” ì¹´ë“œëŠ” ë§¨ ë’¤ì— ì¶”ê°€
      resultCards.forEach(card => {
        const cardId = card.getAttribute('data-program-id');
        const hasResult = summaryResults.some(r => r.programId === cardId || r.id === cardId);
        if (!hasResult) {
          sortedCards.push({ card, result: null });
        }
      });
      
      // ì¹´ë“œ ì¬ë°°ì¹˜ ë° ìˆœìœ„ ì—…ë°ì´íŠ¸
      sortedCards.forEach(({ card, result }, index) => {
        // ìˆœìœ„ ì—…ë°ì´íŠ¸
        const rankSpan = card.querySelector('.rank');
        const scoreSpan = card.querySelector('.match-score');
        const fitScore = result?.fitScore || 0;
        
        if (rankSpan && result) {
          const rank = index + 1;
          const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
          rankSpan.innerHTML = `${rankEmoji} ${rank}ìœ„`;
          rankSpan.style.background = '';
          rankSpan.style.color = '';
          
          // ê´€ë ¨ë„ ë“±ê¸‰ ì—…ë°ì´íŠ¸
          if (scoreSpan) {
            const grade = getRelevanceGrade(fitScore);
            scoreSpan.style.background = grade.bgColor;
            scoreSpan.style.color = grade.color;
            scoreSpan.textContent = `ê´€ë ¨ë„: ${grade.text}`;
          }
        }
        
        // rank í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
        card.classList.remove('rank-1', 'rank-2', 'rank-3');
        if (result) {
          const rank = index + 1;
          if (rank === 1) card.classList.add('rank-1');
          else if (rank === 2) card.classList.add('rank-2');
          else if (rank === 3) card.classList.add('rank-3');
        }
        
        // DOMì—ì„œ ìˆœì„œ ë³€ê²½
        resultsSection.appendChild(card);
      });
      
      console.log('âœ… ì¹´ë“œ ìˆœì„œ ì¬ì •ë ¬ ì™„ë£Œ (ì ìˆ˜ìˆœ):', sortedCards.length, 'ê°œ');
      
      // í—¤ë” ì¹´ë“œ ë¬¸êµ¬ ì—…ë°ì´íŠ¸
      updateResultsHeader(summaryResults);
    }
    
    /**
     * ê²°ê³¼ í—¤ë” ë¬¸êµ¬ ì—…ë°ì´íŠ¸ (ë“±ê¸‰ë³„ ê°œìˆ˜ í‘œì‹œ)
     */
    function updateResultsHeader(summaryResults) {
      const headerCard = document.querySelector('#results-section .card');
      if (!headerCard) return;
      
      // ë“±ê¸‰ë³„ ê°œìˆ˜ ê³„ì‚°
      const veryHighCount = summaryResults.filter(r => (r.fitScore || 0) >= 90).length; // ë§¤ìš°ë†’ìŒ
      const highCount = summaryResults.filter(r => (r.fitScore || 0) >= 80 && (r.fitScore || 0) < 90).length; // ë†’ìŒ
      const mediumCount = summaryResults.filter(r => (r.fitScore || 0) >= 70 && (r.fitScore || 0) < 80).length; // ë³´í†µ
      const lowCount = summaryResults.filter(r => (r.fitScore || 0) >= 60 && (r.fitScore || 0) < 70).length; // ë‚®ìŒ
      const refCount = summaryResults.filter(r => (r.fitScore || 0) < 60).length; // ì°¸ê³ 
      
      let headerHtml = `<h2>ğŸ“Š ë§ì¶¤í˜• ì§€ì›ì‚¬ì—… ì¶”ì²œ ê²°ê³¼</h2>`;
      
      // ë“±ê¸‰ë³„ í‘œì‹œ
      const grades = [];
      if (veryHighCount > 0) grades.push(`ğŸŸ¢ ë§¤ìš°ë†’ìŒ ${veryHighCount}ê°œ`);
      if (highCount > 0) grades.push(`ğŸ”µ ë†’ìŒ ${highCount}ê°œ`);
      if (mediumCount > 0) grades.push(`ğŸŸ£ ë³´í†µ ${mediumCount}ê°œ`);
      if (lowCount > 0) grades.push(`ğŸŸ  ë‚®ìŒ ${lowCount}ê°œ`);
      if (refCount > 0) grades.push(`ğŸŸ¡ ì°¸ê³  ${refCount}ê°œ`);
      
      if (grades.length > 0) {
        headerHtml += `
          <p style="color: #666; margin-top: 0.5rem;">
            ${grades.join(' | ')} (ì´ ${summaryResults.length}ê°œ)
          </p>
        `;
      } else {
        headerHtml += `
          <p style="color: #666; margin-top: 0.5rem;">
            ì´ <strong style="color: #FF8802;">${summaryResults.length}ê°œ</strong>ì˜ ì§€ì›ì‚¬ì—…ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.
          </p>
        `;
      }
      
      headerCard.innerHTML = headerHtml;
    }
    
    /**
     * AI ìƒì„¸ë¶„ì„ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
     */
    function updateResultsWithDetail(detailResults) {
      const resultCards = document.querySelectorAll('.result-card');
      
      detailResults.forEach((result, index) => {
        if (index < resultCards.length) {
          const card = resultCards[index];
          
          // ê¸°ì¡´ AI ìƒì„¸ë¶„ì„ì´ ìˆìœ¼ë©´ ì œê±°
          const existingDetail = card.querySelector('.ai-detail-box');
          if (existingDetail) {
            existingDetail.remove();
          }
          
          // ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ ìƒ‰ìƒ
          const priorityColors = {
            'ìƒ': { bg: '#dc3545', border: '#dc3545', text: 'ìµœìš°ì„  ì‹ ì²­' },
            'ì¤‘': { bg: '#ffc107', border: '#ffc107', text: 'ìš°ì„  ê³ ë ¤' },
            'í•˜': { bg: '#17a2b8', border: '#17a2b8', text: 'ê²€í†  í•„ìš”' }
          };
          
          const priority = result.priority || 'ì¤‘';
          const colorInfo = priorityColors[priority] || priorityColors['ì¤‘'];
          
          // AI ìƒì„¸ë¶„ì„ ë°•ìŠ¤ ìƒì„± - í°ìƒ‰ ë°°ê²½ìœ¼ë¡œ ë³€ê²½
          const detailDiv = document.createElement('div');
          detailDiv.className = 'ai-detail-box';
          detailDiv.style.cssText = `
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            border: 2px solid #f093fb;
            animation: slideIn 0.5s ease-out;
          `;
          
          detailDiv.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.8rem; border-bottom: 2px solid #eee;">
              <div style="display: flex; align-items: center;">
                <span style="font-size: 1.5rem; margin-right: 0.5rem;">ğŸ¯</span>
                <h5 style="color: #f5576c; margin: 0; font-size: 1.1rem; font-weight: 700;">AI ìƒì„¸ë¶„ì„</h5>
              </div>
              <span style="background: ${colorInfo.bg}; color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                ${colorInfo.text}
              </span>
            </div>
            
            <div style="background: #fff5f5; padding: 1.2rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid #f5576c;">
              <div style="display: flex; align-items: start;">
                <span style="color: #f5576c; font-size: 1.2rem; margin-right: 0.5rem;">ğŸ“‹</span>
                <div>
                  <h6 style="color: #f5576c; margin: 0 0 0.5rem 0; font-size: 0.95rem; font-weight: 700;">ìƒì„¸ ë¶„ì„</h6>
                  <p style="color: #333; margin: 0; line-height: 1.7; font-size: 0.95rem;">
                    ${result.detailedAnalysis || 'ìƒì„¸ ë¶„ì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}
                  </p>
                </div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.1rem; margin-right: 0.4rem;">ğŸ’¡</span>
                  <h6 style="color: #856404; margin: 0; font-size: 0.9rem; font-weight: 700;">ì‹ ì²­ ì „ëµ</h6>
                </div>
                <p style="color: #333; margin: 0; line-height: 1.5; font-size: 0.85rem;">
                  ${result.applicationStrategy || 'ì „ëµ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}
                </p>
              </div>
              
              <div style="background: #f0fff4; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.1rem; margin-right: 0.4rem;">âœ¨</span>
                  <h6 style="color: #155724; margin: 0; font-size: 0.9rem; font-weight: 700;">ê¸°ëŒ€ íš¨ê³¼</h6>
                </div>
                <p style="color: #333; margin: 0; line-height: 1.5; font-size: 0.85rem;">
                  ${result.expectedBenefit || 'ê¸°ëŒ€ íš¨ê³¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}
                </p>
              </div>
            </div>
          `;
          
          // ì¹´ë“œì— ì¶”ê°€ (ê¸°ì¡´ ë‚´ìš© ë’¤ì—)
          card.appendChild(detailDiv);
        }
      });
      
      console.log('âœ… AI ìƒì„¸ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ:', detailResults.length, 'ê°œ');
    }
    
    function goHome() {
      window.location.href = 'index.html';
    }
    
    
    // ==================== ì‹œêµ°êµ¬ ë° ìˆ˜ë„ê¶Œ ìë™ ì„¤ì • ====================
    
    // ì‹œë„ë³„ ì‹œêµ°êµ¬ ë°ì´í„°
    const SIGUNGU_DATA = {
      'ì„œìš¸': ['ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ìš©ì‚°êµ¬', 'ì„±ë™êµ¬', 'ê´‘ì§„êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘ë‘êµ¬', 'ì„±ë¶êµ¬', 'ê°•ë¶êµ¬', 'ë„ë´‰êµ¬', 'ë…¸ì›êµ¬', 'ì€í‰êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ì„œì´ˆêµ¬', 'ê°•ë‚¨êµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬'],
      'ê²½ê¸°': ['ìˆ˜ì›ì‹œ', 'ì„±ë‚¨ì‹œ', 'ê³ ì–‘ì‹œ', 'ìš©ì¸ì‹œ', 'ë¶€ì²œì‹œ', 'ì•ˆì‚°ì‹œ', 'ì•ˆì–‘ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'í™”ì„±ì‹œ', 'í‰íƒì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ì‹œí¥ì‹œ', 'íŒŒì£¼ì‹œ', 'ê¹€í¬ì‹œ', 'ê´‘ëª…ì‹œ', 'ê´‘ì£¼ì‹œ', 'êµ°í¬ì‹œ', 'í•˜ë‚¨ì‹œ', 'ì˜¤ì‚°ì‹œ', 'ì–‘ì£¼ì‹œ', 'ì´ì²œì‹œ', 'êµ¬ë¦¬ì‹œ', 'ì•ˆì„±ì‹œ', 'í¬ì²œì‹œ', 'ì˜ì™•ì‹œ', 'ì–‘í‰êµ°', 'ì—¬ì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'ê³¼ì²œì‹œ', 'ê°€í‰êµ°', 'ì—°ì²œêµ°'],
      'ì¸ì²œ': ['ì¤‘êµ¬', 'ë™êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ì—°ìˆ˜êµ¬', 'ë‚¨ë™êµ¬', 'ë¶€í‰êµ¬', 'ê³„ì–‘êµ¬', 'ì„œêµ¬', 'ê°•í™”êµ°', 'ì˜¹ì§„êµ°'],
      'ë¶€ì‚°': ['ì¤‘êµ¬', 'ì„œêµ¬', 'ë™êµ¬', 'ì˜ë„êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë™ë˜êµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'í•´ìš´ëŒ€êµ¬', 'ì‚¬í•˜êµ¬', 'ê¸ˆì •êµ¬', 'ê°•ì„œêµ¬', 'ì—°ì œêµ¬', 'ìˆ˜ì˜êµ¬', 'ì‚¬ìƒêµ¬', 'ê¸°ì¥êµ°'],
      'ëŒ€êµ¬': ['ì¤‘êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ìˆ˜ì„±êµ¬', 'ë‹¬ì„œêµ¬', 'ë‹¬ì„±êµ°'],
      'ëŒ€ì „': ['ë™êµ¬', 'ì¤‘êµ¬', 'ì„œêµ¬', 'ìœ ì„±êµ¬', 'ëŒ€ë•êµ¬'],
      'ê´‘ì£¼': ['ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ê´‘ì‚°êµ¬'],
      'ìš¸ì‚°': ['ì¤‘êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ìš¸ì£¼êµ°'],
      'ì„¸ì¢…': ['ì„¸ì¢…ì‹œ'],
      'ê°•ì›': ['ì¶˜ì²œì‹œ', 'ì›ì£¼ì‹œ', 'ê°•ë¦‰ì‹œ', 'ë™í•´ì‹œ', 'íƒœë°±ì‹œ', 'ì†ì´ˆì‹œ', 'ì‚¼ì²™ì‹œ', 'í™ì²œêµ°', 'íš¡ì„±êµ°', 'ì˜ì›”êµ°', 'í‰ì°½êµ°', 'ì •ì„ êµ°', 'ì² ì›êµ°', 'í™”ì²œêµ°', 'ì–‘êµ¬êµ°', 'ì¸ì œêµ°', 'ê³ ì„±êµ°', 'ì–‘ì–‘êµ°'],
      'ì¶©ë¶': ['ì²­ì£¼ì‹œ', 'ì¶©ì£¼ì‹œ', 'ì œì²œì‹œ', 'ë³´ì€êµ°', 'ì˜¥ì²œêµ°', 'ì˜ë™êµ°', 'ì¦í‰êµ°', 'ì§„ì²œêµ°', 'ê´´ì‚°êµ°', 'ìŒì„±êµ°', 'ë‹¨ì–‘êµ°'],
      'ì¶©ë‚¨': ['ì²œì•ˆì‹œ', 'ê³µì£¼ì‹œ', 'ë³´ë ¹ì‹œ', 'ì•„ì‚°ì‹œ', 'ì„œì‚°ì‹œ', 'ë…¼ì‚°ì‹œ', 'ê³„ë£¡ì‹œ', 'ë‹¹ì§„ì‹œ', 'ê¸ˆì‚°êµ°', 'ë¶€ì—¬êµ°', 'ì„œì²œêµ°', 'ì²­ì–‘êµ°', 'í™ì„±êµ°', 'ì˜ˆì‚°êµ°', 'íƒœì•ˆêµ°'],
      'ì „ë¶': ['ì „ì£¼ì‹œ', 'êµ°ì‚°ì‹œ', 'ìµì‚°ì‹œ', 'ì •ìì‹œ', 'ë‚¨ì›ì‹œ', 'ê¹€ì œì‹œ', 'ì™„ì£¼êµ°', 'ì§„ì•ˆêµ°', 'ë¬´ì£¼êµ°', 'ì¥ìˆ˜êµ°', 'ì„ì‹¤êµ°', 'ìˆœì°½êµ°', 'ê³ ì°½êµ°', 'ë¶€ì•ˆêµ°'],
      'ì „ë‚¨': ['ëª©í¬ì‹œ', 'ì—¬ìˆ˜ì‹œ', 'ìˆœì²œì‹œ', 'ë‚˜ì£¼ì‹œ', 'ê´‘ì–‘ì‹œ', 'ë‹´ì–‘êµ°', 'ê³¡ì„±êµ°', 'êµ¬ë¡€êµ°', 'ê³ í¥êµ°', 'ë³´ì„±êµ°', 'í™”ìˆœêµ°', 'ì¥í¥êµ°', 'ê°•ì§„êµ°', 'í•´ë‚¨êµ°', 'ì˜ì•”êµ°', 'ë¬´ì•ˆêµ°', 'í•¨í‰êµ°', 'ì˜ê´‘êµ°', 'ì¥ì„±êµ°', 'ì™„ë„êµ°', 'ì§„ë„êµ°', 'ì‹ ì•ˆêµ°'],
      'ê²½ë¶': ['í¬í•­ì‹œ', 'ê²½ì£¼ì‹œ', 'ê¹€ì²œì‹œ', 'ì•ˆë™ì‹œ', 'êµ¬ë¯¸ì‹œ', 'ì˜ì£¼ì‹œ', 'ì˜ì²œì‹œ', 'ìƒì£¼ì‹œ', 'ë¬¸ê²½ì‹œ', 'ê²½ì‚°ì‹œ', 'êµ°ìœ„êµ°', 'ì˜ì„±êµ°', 'ì²­ì†¡êµ°', 'ì˜ì–‘êµ°', 'ì˜ë•êµ°', 'ì²­ë„êµ°', 'ê³ ë ¹êµ°', 'ì„±ì£¼êµ°', 'ì¹ ê³¡êµ°', 'ì˜ˆì²œêµ°', 'ë´‰í™”êµ°', 'ìš¸ì§„êµ°', 'ìš¸ë¦‰êµ°'],
      'ê²½ë‚¨': ['ì°½ì›ì‹œ', 'ì§„ì£¼ì‹œ', 'í†µì˜ì‹œ', 'ì‚¬ì²œì‹œ', 'ê¹€í•´ì‹œ', 'ë°€ì–‘ì‹œ', 'ê±°ì œì‹œ', 'ì–‘ì‚°ì‹œ', 'ì˜ë ¹êµ°', 'í•¨ì•ˆêµ°', 'ì°½ë…•êµ°', 'ê³ ì„±êµ°', 'ë‚¨í•´êµ°', 'í•˜ë™êµ°', 'ì‚°ì²­êµ°', 'í•¨ì–‘êµ°', 'ê±°ì°½êµ°', 'í•©ì²œêµ°'],
      'ì œì£¼': ['ì œì£¼ì‹œ', 'ì„œê·€í¬ì‹œ']
    };
    
    // ì‹œë„ ì„ íƒ ì‹œ ì‹œêµ°êµ¬ ì˜µì…˜ ì—…ë°ì´íŠ¸ ë° ìˆ˜ë„ê¶Œ ìë™ ì„¤ì •
    function updateSigunguOptions() {
      const sidoSelect = document.getElementById('location-sido');
      const sigunguSelect = document.getElementById('location-sigungu');
      const capitalAreaSelect = document.getElementById('capital-area');
      
      const selectedSido = sidoSelect.value;
      
      // ì‹œêµ°êµ¬ ì´ˆê¸°í™”
      sigunguSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
      
      if (selectedSido && SIGUNGU_DATA[selectedSido]) {
        // ì‹œêµ°êµ¬ ì˜µì…˜ ì¶”ê°€
        SIGUNGU_DATA[selectedSido].forEach(sigungu => {
          const option = document.createElement('option');
          option.value = sigungu;
          option.textContent = sigungu;
          sigunguSelect.appendChild(option);
        });
        sigunguSelect.disabled = false;
        
        // ìˆ˜ë„ê¶Œ ì—¬ë¶€ ìë™ ì„¤ì •
        if (selectedSido === 'ì„œìš¸' || selectedSido === 'ê²½ê¸°' || selectedSido === 'ì¸ì²œ') {
          capitalAreaSelect.value = 'Y';
        } else {
          capitalAreaSelect.value = 'N';
        }
        capitalAreaSelect.disabled = true; // ìë™ ì„¤ì •ì´ë¯€ë¡œ ë¹„í™œì„±í™”
      } else {
        sigunguSelect.innerHTML = '<option value="">ì‹œë„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
        sigunguSelect.disabled = true;
        capitalAreaSelect.value = '';
        capitalAreaSelect.disabled = true;
      }
    }
    
    // ì´ˆê¸°í™” í•¨ìˆ˜ ìˆ˜ì •
    const originalInit = window.addEventListener;
    window.addEventListener('load', function(event) {
      initializeApp();
    });
    
  </script>

  <script>
    // ============================================
    // AI ë¶„ì„ ë©”ì¸ í•¨ìˆ˜
    // ============================================
    /*
    // ==================== AI ë¶„ì„ ì‹œì‘ (ì‚¬ìš© ì•ˆí•¨) ====================
    async function startAIAnalysis() {
      try {
        const btn = document.getElementById('aiAnalyzeBtn');
        const loadingSection = document.getElementById('aiLoadingSection');
        const resultsSection = document.getElementById('aiResultsSection');
        
        // ì§€ì›ì‚¬ì—…+ë¶„ì„ ë¨¼ì € ì‹¤í–‰ ì—¬ë¶€ ì²´í¬
        if (!hasCompletedSearch) {
          alert('ë¨¼ì € "ì§€ì›ì‚¬ì—…+ë¶„ì„" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
          return;
        }
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        btn.disabled = true;
        btn.textContent = 'ë¶„ì„ ì¤‘...';
        
        // ë¡œë”© í‘œì‹œ
        loadingSection.style.display = 'block';
        resultsSection.style.display = 'none';
        
        // ê¸°ì—… ë°ì´í„° ìˆ˜ì§‘
        const companyData = collectCompanyDataForAI();
        
        // í•„ìˆ˜ í•„ë“œ ê²€ì¦
        if (!validateCompanyData(companyData)) {
          alert('í•„ìˆ˜ í•­ëª©(*)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\níŠ¹íˆ ë‹¤ìŒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”:\n- ê¸°ì—…ëª…\n- ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸\n- ê°œì—…ì—°ì›”ì¼\n- ê¸°ì—… ê·œëª¨\n- ìƒì‹œê·¼ë¡œì ìˆ˜\n- ìµœê·¼ ë§¤ì¶œì•¡');
          btn.disabled = false;
          btn.textContent = 'ğŸš€ AI ë¶„ì„ ì‹œì‘';
          loadingSection.style.display = 'none';
          return;
        }
        
        // ì§„í–‰ìœ¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updateAIProgress = (percent) => {
          document.getElementById('aiProgressBar').style.width = percent + '%';
          document.getElementById('aiProgressText').textContent = Math.round(percent) + '%';
        };
        
        updateAIProgress(10);
        updateAILoading('ê³µê³  ë°ì´í„° ì¡°íšŒ ì¤‘...', 'ìºì‹œì—ì„œ ê³µê³  ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        // Step 1: Firestore ìºì‹œì—ì„œ ê³µê³  ì¡°íšŒ (adminì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„°)
        const getCachedPrograms = functions.httpsCallable('getCachedPrograms');
        const result1 = await getCachedPrograms();
        const data1 = result1.data;
        
        if (!data1.success) {
          throw new Error('ê³µê³  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const programs = data1.programs || [];
        
        updateAIProgress(50);
        updateAILoading('Gemini AI ë¶„ì„ ì¤‘...', `${programs.length}ê°œ ê³µê³ ì™€ ê¸°ì—… ì •ë³´ ë§¤ì¹­ ì¤‘...`);
        
        // Step 2: AI ë§¤ì¹­ ë¶„ì„ (Firebase Functions ì‚¬ìš©)
        const analyzeCompanyMatch = functions.httpsCallable('analyzeCompanyMatch');
        const result2 = await analyzeCompanyMatch({
          companyData: companyData,
          programs: programs
        });
        
        const data2 = result2.data;
        
        if (!data2.success) {
          throw new Error('AI ë¶„ì„ ì‹¤íŒ¨');
        }
        
        const matchedPrograms = data2.matchedPrograms || [];
        
        updateAIProgress(100);
        
        // ê²°ê³¼ í‘œì‹œ
        displayAIResults(matchedPrograms);
        
        // ë³µêµ¬
        btn.disabled = false;
        btn.textContent = 'ğŸš€ AI ë¶„ì„ ì‹œì‘';
        loadingSection.style.display = 'none';
        
        // ì§„í–‰ìœ¨ ì´ˆê¸°í™”
        updateAIProgress(0);
        
        // ìŠ¤í¬ë¡¤
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
      } catch (error) {
        console.error('AI ë¶„ì„ ì˜¤ë¥˜:', error);
        alert('AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message + '\n\në„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        
        document.getElementById('aiAnalyzeBtn').disabled = false;
        document.getElementById('aiAnalyzeBtn').textContent = 'ğŸš€ AI ë¶„ì„ ì‹œì‘';
        document.getElementById('aiLoadingSection').style.display = 'none';
        
        // ì§„í–‰ìœ¨ ì´ˆê¸°í™”
        document.getElementById('aiProgressBar').style.width = '0%';
        document.getElementById('aiProgressText').textContent = '0%';
      }
    }
    
    // ============================================
    // ê¸°ì—… ë°ì´í„° ìˆ˜ì§‘ (ê¸°ì¡´ í¼ì˜ ëª¨ë“  í•„ë“œ)
    // ============================================
    function collectCompanyDataForAI() {
      // ê°œì—…ì—°ì›”ì¼ì—ì„œ ì—…ë ¥ ê³„ì‚°
      const foundedDateStr = document.getElementById('establish-date')?.value || '';
      let businessAge = 0;
      let foundedYear = 0;
      
      if (foundedDateStr) {
        const foundedDate = new Date(foundedDateStr);
        foundedYear = foundedDate.getFullYear();
        const today = new Date();
        businessAge = today.getFullYear() - foundedYear;
      }
      
      // ì§ì›ìˆ˜ ê³„ì‚°
      const employees = parseInt(unformatNumber(document.getElementById('employees-total')?.value)) || 0;
      const youthEmployees = parseInt(unformatNumber(document.getElementById('employees-youth')?.value)) || 0;
      const femaleEmployees = parseInt(unformatNumber(document.getElementById('employees-female')?.value)) || 0;
      
      const youthRatio = employees > 0 ? (youthEmployees / employees * 100).toFixed(1) : 0;
      const femaleRatio = employees > 0 ? (femaleEmployees / employees * 100).toFixed(1) : 0;
      
      // ë§¤ì¶œì•¡ (ì› ë‹¨ìœ„)
      const revenue = parseFloat(unformatNumber(document.getElementById('revenue-recent')?.value)) || 0;
      
      // ì‚¬ì—…ìë²ˆí˜¸ ì¡°í•©
      const bizNum1 = document.getElementById('business-number-1')?.value || '';
      const bizNum2 = document.getElementById('business-number-2')?.value || '';
      const bizNum3 = document.getElementById('business-number-3')?.value || '';
      const businessNumber = bizNum1 && bizNum2 && bizNum3 ? `${bizNum1}-${bizNum2}-${bizNum3}` : '';
      
      return {
        // ê¸°ë³¸ ì •ë³´
        companyName: document.getElementById('company-name')?.value || '',
        businessNumber: businessNumber,
        foundedYear: foundedYear,
        businessAge: businessAge,
        
        // ë¶„ë¥˜
        companySize: document.getElementById('company-size')?.value || '',
        companyType: document.getElementById('company-type')?.value || '',
        businessStatus: document.getElementById('business-status')?.value || 'ìš´ì˜ì¤‘',
        industry: document.getElementById('ksic-code')?.value || '',
        
        // ì†Œì¬ì§€
        region: document.getElementById('location-sido')?.value || '',
        sigungu: document.getElementById('location-sigungu')?.value || '',
        isMetro: document.getElementById('capital-area')?.value === 'Y',
        
        // ëŒ€í‘œì
        ceoGender: document.getElementById('ceo-gender')?.value || '',
        ceoBirthYear: document.getElementById('ceo-birth')?.value || '',
        
        // ì¬ë¬´
        revenue: revenue,
        debtRatio: parseFloat(document.getElementById('debt-ratio')?.value) || 0,
        
        // ê²°ê²©ì‚¬ìœ 
        hasTaxArrears: document.getElementById('tax-arrears')?.value === 'Y',
        hasLocalTaxArrears: document.getElementById('local-tax-arrears')?.value === 'Y',
        hasCapitalErosion: document.getElementById('capital-erosion')?.value === 'Y',
        
        // ê³ ìš©
        employees: employees,
        youthEmployees: youthEmployees,
        femaleEmployees: femaleEmployees,
        disabledEmployees: parseInt(unformatNumber(document.getElementById('employees-disabled')?.value)) || 0,
        youthRatio: parseFloat(youthRatio),
        femaleRatio: parseFloat(femaleRatio),
        employmentGrowth: parseFloat(unformatNumber(document.getElementById('employment-growth')?.value)) || 0,
        
        // ì¸ì¦
        hasVenture: document.getElementById('cert-venture')?.value === 'Y',
        hasInnobiz: document.getElementById('cert-innobiz')?.value === 'Y',
        hasMainbiz: document.getElementById('cert-mainbiz')?.value === 'Y',
        hasWomanCert: document.getElementById('cert-woman')?.value === 'Y',
        hasDisabledCert: document.getElementById('cert-disabled')?.value === 'Y',
        hasSocialCert: document.getElementById('cert-social')?.value === 'Y',
        hasESG: document.getElementById('esg-status')?.value === 'Y',
        
        // ê¸°ìˆ 
        patentCount: parseInt(unformatNumber(document.getElementById('patents-registered')?.value)) || 0,
        researchOrg: document.getElementById('research-org')?.value || '',
        tcbRating: document.getElementById('tcb-rating')?.value || '',
        
        // ìˆ˜ì¶œ
        exportAmount: parseFloat(unformatNumber(document.getElementById('export-recent')?.value)) || 0,
        exportCountries: document.getElementById('export-countries')?.value || '',
        
        // í¬ë§ ì§€ì›ë¶„ì•¼
        desiredSupports: getDesiredSupports()
      };
    }
    
    // ============================================
    // í¬ë§ ì§€ì›ë¶„ì•¼ ìˆ˜ì§‘
    // ============================================
    function getDesiredSupports() {
      const supports = [];
      const checkboxes = document.querySelectorAll('input[name="desiredSupport"]:checked');
      checkboxes.forEach(cb => {
        supports.push(cb.value);
      });
      return supports;
    }
    
    // ============================================
    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    // ============================================
    function validateCompanyData(data) {
      if (!data.companyName) return false;
      if (!data.businessNumber) return false;
      if (!data.foundedYear || data.foundedYear === 0) return false;
      if (!data.companySize) return false;
      if (!data.employees || data.employees === 0) return false;
      if (data.revenue === 0) return false;
      return true;
    }
    
    // ============================================
    // ë¡œë”© ì—…ë°ì´íŠ¸
    // ============================================
    function updateAILoading(text, detail) {
      document.getElementById('aiLoadingText').textContent = text;
      document.getElementById('aiLoadingDetail').textContent = detail;
    }
    
    // ============================================
    // ê²°ê³¼ í‘œì‹œ
    // ============================================
    function displayAIResults(programs) {
      const resultsSection = document.getElementById('aiResultsSection');
      const resultsList = document.getElementById('aiResultsList');
      
      resultsList.innerHTML = '';
      
      if (programs.length === 0) {
        resultsList.innerHTML = `
          <div style="text-align: center; padding: 3rem; background: rgba(255,255,255,0.1); border-radius: 12px;">
            <p style="font-size: 1.2rem; margin-bottom: 1rem;">ğŸ˜”</p>
            <p style="font-size: 1.1rem;">ë§¤ì¹­ë˜ëŠ” ì§€ì›ì‚¬ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem; color: rgba(255,255,255,0.7);">
              ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•˜ì‹œê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.
            </p>
          </div>
        `;
        resultsSection.style.display = 'block';
        return;
      }
      
      const top20 = programs.slice(0, 20);
      
      top20.forEach((program, index) => {
        const item = document.createElement('div');
        item.className = 'card';
        item.style.cssText = 'background: rgba(255,255,255,0.15); margin-bottom: 1rem; border-left: 5px solid #FF8802; transition: all 0.3s;';
        
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
            <div style="flex: 1; min-width: 200px;">
              <h4 style="color: #FFD700; font-size: 1.3rem; margin-bottom: 0.5rem;">
                ${index + 1}. ${program.name || 'ì œëª© ì—†ìŒ'}
              </h4>
              <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                <span>ğŸ¢ ${program.organization || 'ë¯¸ìƒ'}</span>
                <span>ğŸ“‚ ${program.category || 'ê¸°íƒ€'}</span>
                <span>ğŸ“… ${program.reqstPeriod || 'ìƒì‹œ'}</span>
              </div>
            </div>
            <div style="background: linear-gradient(135deg, #FF8802 0%, #FF6B00 100%); color: white; padding: 0.5rem 1.5rem; border-radius: 20px; font-weight: bold; font-size: 1.2rem; white-space: nowrap;">
              ${program.matchScore || 0}ì 
            </div>
          </div>
          
          ${program.description ? `
            <p style="margin-bottom: 1rem; line-height: 1.6; color: rgba(255,255,255,0.9);">
              ${program.description.substring(0, 200)}...
            </p>
          ` : ''}
          
          ${program.matchReasons && program.matchReasons.length > 0 ? `
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <strong style="color: #FFD700; display: block; margin-bottom: 0.5rem;">âœ… ë§¤ì¹­ ê·¼ê±°:</strong>
              <ul style="margin-left: 1.5rem; line-height: 1.8;">
                ${program.matchReasons.map(r => `<li>${r}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          
          ${program.strengths && program.strengths.length > 0 ? `
            <div style="background: rgba(52, 211, 153, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #34d399;">
              <strong style="color: #34d399; display: block; margin-bottom: 0.5rem;">ğŸ’ª ê°•ì :</strong>
              <ul style="margin-left: 1.5rem; line-height: 1.8;">
                ${program.strengths.map(s => `<li>${s}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          
          ${program.weaknesses && program.weaknesses.length > 0 ? `
            <div style="background: rgba(251, 191, 36, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #fbbf24;">
              <strong style="color: #fbbf24; display: block; margin-bottom: 0.5rem;">âš ï¸ ì•½ì /ì£¼ì˜ì‚¬í•­:</strong>
              <ul style="margin-left: 1.5rem; line-height: 1.8;">
                ${program.weaknesses.map(w => `<li>${w}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button 
              onclick="window.open('${program.website}', '_blank')" 
              class="btn btn-secondary"
              style="padding: 0.6rem 1.2rem; font-size: 0.9rem;">
              ğŸ“„ ê³µê³ ë¬¸ ë³´ê¸°
            </button>
            ${program.applicationUrl ? `
              <button 
                onclick="window.open('${program.applicationUrl}', '_blank')" 
                class="btn btn-secondary"
                style="padding: 0.6rem 1.2rem; font-size: 0.9rem;">
                âœï¸ ì‹ ì²­í•˜ê¸°
              </button>
            ` : ''}
          </div>
        `;
        
        // í˜¸ë²„ íš¨ê³¼
        item.addEventListener('mouseenter', function() {
          this.style.background = 'rgba(255,255,255,0.2)';
          this.style.transform = 'translateX(5px)';
        });
        item.addEventListener('mouseleave', function() {
          this.style.background = 'rgba(255,255,255,0.15)';
          this.style.transform = 'translateX(0)';
        });
        
        resultsList.appendChild(item);
      });
      
      resultsSection.style.display = 'block';
    }
    */
    // ==================== AI ë¶„ì„ ì¢…ë£Œ ====================
    
    // ==================== ìƒì„¸ë¶„ì„ ìƒ˜í”Œ ëª¨ë‹¬ ====================
    
    /**
     * ìƒì„¸ë¶„ì„ ìƒ˜í”Œ ëª¨ë‹¬ í‘œì‹œ
     */
    function showDetailSample() {
      const modal = document.getElementById('detail-sample-modal');
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }
    
    /**
     * ìƒì„¸ë¶„ì„ ìƒ˜í”Œ ëª¨ë‹¬ ë‹«ê¸°
     */
    function closeDetailSample() {
      const modal = document.getElementById('detail-sample-modal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }
    
    /**
     * ìƒì„¸ë¶„ì„ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ í™•ì¸ íŒì—…
     */
    function showDetailAnalysisConfirm() {
      // ìƒì„¸ë¶„ì„ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
      const modal = document.getElementById('detail-confirm-modal');
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }
    
    /**
     * ìƒì„¸ë¶„ì„ í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
     */
    function closeDetailConfirm() {
      const modal = document.getElementById('detail-confirm-modal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }
    
    /**
     * ìƒì„¸ë¶„ì„ í™•ì¸ í›„ ì§„í–‰
     */
    function proceedDetailAnalysis() {
      closeDetailConfirm();
      analyzeProgramsDetail();
    }
    
    // ==================== í¬ë ˆë”§ ì‹œìŠ¤í…œ (Firestore ê¸°ë°˜) ====================
    
    // ë¡œì»¬ ìºì‹œ (í™”ë©´ í‘œì‹œìš©, ì‹¤ì œ ë°ì´í„°ëŠ” Firestoreì—ì„œ ê´€ë¦¬)
    let userCredits = {
      freeRemaining: 10,
      paidBalance: 0,
      lastResetMonth: '',
      isLoaded: false,
      unlimited: false,        // ğŸ†• ë¬´ì œí•œ ì‚¬ìš©ì ì—¬ë¶€
      unlimitedReason: ''      // ğŸ†• ë¬´ì œí•œ ì‚¬ìœ 
    };
    
    /**
     * Firestoreì—ì„œ í¬ë ˆë”§ ì¡°íšŒ (Firebase Functions í†µí•´)
     */
    async function loadCreditsFromServer() {
      try {
        const getCredits = functions.httpsCallable('getCredits');
        const result = await getCredits();
        
        if (result.data.success) {
          userCredits = {
            ...result.data.credits,
            isLoaded: true,
            unlimited: result.data.unlimited || false,           // ğŸ†•
            unlimitedReason: result.data.unlimitedReason || ''   // ğŸ†•
          };
          console.log('ğŸ’° í¬ë ˆë”§ ë¡œë“œ:', userCredits);
          if (userCredits.unlimited) {
            console.log('ğŸ‘‘ ë¬´ì œí•œ ì‚¬ìš©ì:', userCredits.unlimitedReason);
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('âŒ í¬ë ˆë”§ ë¡œë“œ ì‹¤íŒ¨:', error);
        return false;
      }
    }
    
    /**
     * í¬ì¸íŠ¸ ì¡°íšŒ ë²„íŠ¼ í´ë¦­ (ê¸°ì¡´ í˜¸í™˜ìš©)
     */
    async function showMyPoints() {
      showPointChargeModal();
    }
    
    // ì„ íƒëœ ì¶©ì „ ê¸ˆì•¡
    let selectedChargeAmount = 0;
    
    /**
     * í¬ì¸íŠ¸ ì¶©ì „/ì¡°íšŒ ëª¨ë‹¬ ì—´ê¸°
     */
    async function showPointChargeModal() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\ní¬ì¸íŠ¸ ì¶©ì „/ì¡°íšŒë¥¼ ìœ„í•´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ëª¨ë‹¬ í‘œì‹œ
      const modal = document.getElementById('point-charge-modal');
      modal.style.display = 'flex';
      
      // ì´ˆê¸°í™”
      selectedChargeAmount = 0;
      document.getElementById('custom-charge-amount').value = '';
      updateChargeUI();
      
      // í¬ì¸íŠ¸ ì¡°íšŒ
      await refreshPoints();
    }
    
    /**
     * í¬ì¸íŠ¸ ì¶©ì „/ì¡°íšŒ ëª¨ë‹¬ ë‹«ê¸°
     */
    function closePointChargeModal() {
      document.getElementById('point-charge-modal').style.display = 'none';
      selectedChargeAmount = 0;
    }
    
    /**
     * í¬ì¸íŠ¸ ìƒˆë¡œê³ ì¹¨
     */
    async function refreshPoints() {
      try {
        await loadCreditsFromServer();
        
        // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        const pointsDisplay = document.getElementById('current-points-display');
        pointsDisplay.textContent = `${(userCredits?.paidBalance || 0).toLocaleString()} P`;
        
        // ë¬´ë£Œ ì‚¬ìš© í˜„í™© í‘œì‹œ
        const now = new Date();
        const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        const displayMonth = monthNames[now.getMonth()];
        const freeUsed = 10 - userCredits.freeRemaining;
        const freeStatus = userCredits.freeRemaining > 0 
          ? `âœ… ${freeUsed}/10íšŒ ì‚¬ìš© (ì”ì—¬ ${userCredits.freeRemaining}íšŒ)`
          : `âŒ 10/10íšŒ ì†Œì§„`;
        
        const freeDisplay = document.getElementById('free-usage-display');
        freeDisplay.innerHTML = `ğŸ“Š ${displayMonth} ë¬´ë£Œ ìš”ì•½ë¶„ì„: ${freeStatus}`;
        
      } catch (error) {
        console.error('âŒ í¬ì¸íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        alert('í¬ì¸íŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    /**
     * ì¶©ì „ ê¸ˆì•¡ ì„ íƒ
     */
    function selectChargeAmount(amount) {
      selectedChargeAmount = amount;
      document.getElementById('custom-charge-amount').value = '';
      updateChargeUI();
    }
    
    /**
     * ì§ì ‘ ì…ë ¥ ê¸ˆì•¡ ì²˜ë¦¬
     */
    function onCustomAmountInput() {
      const input = document.getElementById('custom-charge-amount');
      let value = parseInt(input.value) || 0;
      
      // 1000ì› ë‹¨ìœ„ë¡œ ì¡°ì •
      value = Math.floor(value / 1000) * 1000;
      
      // ë²”ìœ„ ì œí•œ
      if (value < 10000) value = 0;
      if (value > 1000000) value = 1000000;
      
      selectedChargeAmount = value;
      updateChargeUI();
    }
    
    /**
     * ì¶©ì „ UI ì—…ë°ì´íŠ¸
     */
    function updateChargeUI() {
      // ë²„íŠ¼ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.charge-amount-btn').forEach(btn => {
        const btnAmount = parseInt(btn.dataset.amount);
        if (btnAmount === selectedChargeAmount) {
          btn.style.background = 'linear-gradient(135deg, #FF8802, #FF6B00)';
          btn.style.borderColor = '#FF8802';
          btn.style.fontWeight = '700';
        } else {
          btn.style.background = 'rgba(255,255,255,0.1)';
          btn.style.borderColor = 'rgba(255,255,255,0.3)';
          btn.style.fontWeight = 'normal';
        }
      });
      
      // ì„ íƒëœ ê¸ˆì•¡ í‘œì‹œ
      const displayDiv = document.getElementById('selected-amount-display');
      const submitBtn = document.getElementById('charge-submit-btn');
      
      if (selectedChargeAmount >= 10000) {
        displayDiv.style.display = 'block';
        document.getElementById('selected-amount-text').textContent = `${selectedChargeAmount.toLocaleString()}ì›`;
        document.getElementById('selected-points-text').textContent = `+${selectedChargeAmount.toLocaleString()} P`;
        
        submitBtn.disabled = false;
        submitBtn.style.background = 'linear-gradient(135deg, #FF8802, #FF6B00)';
        submitBtn.style.color = 'white';
        submitBtn.style.cursor = 'pointer';
      } else {
        displayDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.style.background = 'linear-gradient(135deg, #666, #555)';
        submitBtn.style.color = '#999';
        submitBtn.style.cursor = 'not-allowed';
      }
    }
    
    /**
     * ê²°ì œ ìš”ì²­ (INNOPAY)
     */
    function requestPayment() {
      if (selectedChargeAmount < 10000) {
        alert('ì¶©ì „ ê¸ˆì•¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }
      
      // ì£¼ë¬¸ë²ˆí˜¸ ìƒì„±
      const moid = 'BIZINFO' + Date.now() + Math.random().toString(36).substr(2, 9);
      
      // INNOPAY ê²°ì œì°½ í˜¸ì¶œ
      if (typeof innopay === 'undefined') {
        alert('ê²°ì œ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      innopay.goPay({
        PayMethod: 'CARD',
        MID: 'pgkfpcen5m',
        MerchantKey: 'c/odh029sWya/US4LINs89lb/8PD0qlbZjEkckW5L3toSMCpD4TQ8IWquueuKFpZm8XY/mVuxrsygQD9P9CooQ==',
        GoodsName: 'í¬ì¸íŠ¸ ì¶©ì „ ' + selectedChargeAmount.toLocaleString() + 'P',
        Amt: parseInt(selectedChargeAmount),
        Moid: moid,
        BuyerName: user.displayName || user.email.split('@')[0],
        BuyerEmail: user.email,
        BuyerTel: '01000000000',
        ReturnURL: window.location.origin + '/payment-result.html',
        ResultYN: 'Y'
      });
    }
    
    /**
     * INNOPAY ê²°ì œ ê²°ê³¼ ì½œë°± (ì „ì—­ í•¨ìˆ˜ - SDKê°€ í˜¸ì¶œ)
     */
    function innopay_result(rtn) {
      console.log('ğŸ’³ INNOPAY ê²°ê³¼:', rtn);
      handlePaymentResult(rtn);
    }
    
    /**
     * ê²°ì œ ê²°ê³¼ ì²˜ë¦¬
     */
    async function handlePaymentResult(result) {
      console.log('ğŸ’³ ê²°ì œ ê²°ê³¼:', result);
      
      if (result.ResultCode === '0000' || result.ResultCode === '00') {
        // ê²°ì œ ì„±ê³µ - ì„œë²„ì— í¬ì¸íŠ¸ ì ë¦½ ìš”ì²­
        try {
          const chargePoints = firebase.app().functions('asia-northeast3').httpsCallable('chargePoints');
          const response = await chargePoints({
            amount: selectedChargeAmount,
            tid: result.TID || result.tid,
            moid: result.Moid || result.moid,
            authCode: result.AuthCode || result.authCode || ''
          });
          
          if (response.data.success) {
            // í¬ì¸íŠ¸ ìƒˆë¡œê³ ì¹¨
            await loadCreditsFromServer();
            
            // ì¶©ì „ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
            showChargeCompleteModal(selectedChargeAmount, response.data.newBalance);
            
            // ì¶©ì „ ëª¨ë‹¬ ë‹«ê¸°
            closePointChargeModal();
          } else {
            alert('í¬ì¸íŠ¸ ì ë¦½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nê³ ê°ì„¼í„°ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.\n\n' + (response.data.message || ''));
          }
        } catch (error) {
          console.error('âŒ í¬ì¸íŠ¸ ì ë¦½ ì˜¤ë¥˜:', error);
          alert('ê²°ì œëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ í¬ì¸íŠ¸ ì ë¦½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nê³ ê°ì„¼í„°ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
        }
      } else {
        // ê²°ì œ ì‹¤íŒ¨ ë˜ëŠ” ì·¨ì†Œ
        if (result.ResultCode !== 'U000') { // U000ì€ ì‚¬ìš©ì ì·¨ì†Œ
          alert('ê²°ì œê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n' + (result.ResultMsg || result.resultMsg || ''));
        }
      }
    }
    
    /**
     * ì¶©ì „ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
     */
    function showChargeCompleteModal(amount, newBalance) {
      document.getElementById('complete-amount').textContent = amount.toLocaleString() + 'ì›';
      document.getElementById('complete-points').textContent = '+' + amount.toLocaleString() + ' P';
      document.getElementById('complete-balance').textContent = (newBalance || userCredits?.paidBalance || 0).toLocaleString() + ' P';
      document.getElementById('charge-complete-modal').style.display = 'flex';
    }
    
    /**
     * ì¶©ì „ ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°
     */
    function closeChargeCompleteModal() {
      document.getElementById('charge-complete-modal').style.display = 'none';
    }
    
    /**
     * í¬ë ˆë”§ í™•ì¸ ë° í™•ì¸ íŒì—… í‘œì‹œ
     * @param {string} type - 'summary' | 'detail'
     * @returns {Promise<boolean>} - ì§„í–‰ ì—¬ë¶€
     */
    async function checkAndConfirmCredits(type) {
      // ê´€ë¦¬ì ID (ë¬´ì œí•œ ì‚¬ìš© ê°€ëŠ¥) - login.htmlì—ì„œ ë¡œê·¸ì¸í•œ userId ê¸°ì¤€
      const adminUserIds = ['admin', 'kfpcenter', 'polarislkh'];
      const user = firebase.auth().currentUser;
      
      // í˜„ì¬ ë¡œê·¸ì¸í•œ userId ì¶”ì¶œ (admin@system.local â†’ admin)
      const currentUserId = user ? user.email.split('@')[0] : '';
      
      // í¬ë ˆë”§ ì •ë³´ ë¡œë“œ (ì•„ì§ ì•ˆ ë˜ì—ˆìœ¼ë©´) - ğŸ†• ë¨¼ì € ë¡œë“œí•´ì„œ unlimited í™•ì¸
      if (!userCredits.isLoaded) {
        await loadCreditsFromServer();
      }
      
      // ğŸ†• ì„œë²„ì—ì„œ í™•ì¸ëœ ë¬´ì œí•œ ì‚¬ìš©ì (ê´€ë¦¬ì/ë¬´ë£Œì‚¬ìš©ì)
      if (userCredits.unlimited) {
        const confirmed = confirm(
          `ğŸ‘‘ ${userCredits.unlimitedReason || 'ë¬´ì œí•œ ì‚¬ìš©ì'}\n\n` +
          `${type === 'summary' ? 'ìš”ì•½ë¶„ì„' : 'ìƒì„¸ë¶„ì„'}ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n` +
          `(í¬ì¸íŠ¸ ì°¨ê° ì—†ìŒ)\n\n` +
          `ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        );
        return confirmed;
      }
      
      // í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ID ì²´í¬ (ë°±ì—…)
      if (user && adminUserIds.includes(currentUserId)) {
        const confirmed = confirm(
          `ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ\n\n` +
          `${type === 'summary' ? 'ìš”ì•½ë¶„ì„' : 'ìƒì„¸ë¶„ì„'}ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n` +
          `(í¬ì¸íŠ¸ ì°¨ê° ì—†ìŒ)\n\n` +
          `ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        );
        return confirmed;
      }
      
      if (type === 'summary') {
        // ìš”ì•½ë¶„ì„: ë¬´ë£Œ 10íšŒ, ì´í›„ 500P
        if (userCredits.freeRemaining > 0) {
          // ë¬´ë£Œ ì‚¬ìš© ê°€ëŠ¥
          const confirmed = confirm(
            `âœ… ìš”ì•½ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n\n` +
            `ğŸ“Š ì´ë²ˆ ë‹¬ ë¬´ë£Œ ì‚¬ìš©: ${10 - userCredits.freeRemaining + 1}/10íšŒ\n` +
            `ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: ${(userCredits?.paidBalance || 0).toLocaleString()}P\n\n` +
            `ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          );
          return confirmed;
        } else {
          // ë¬´ë£Œ ì†Œì§„, ìœ ë£Œ í•„ìš”
          if (userCredits.paidBalance >= 500) {
            const confirmed = confirm(
              `âš ï¸ ì´ë²ˆ ë‹¬ ë¬´ë£Œ 10íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\n\n` +
              `ğŸ’³ ì°¨ê° í¬ì¸íŠ¸: 500P\n` +
              `ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: ${(userCredits?.paidBalance || 0).toLocaleString()}P\n` +
              `    â†’ ì‚¬ìš© í›„: ${((userCredits?.paidBalance || 0) - 500).toLocaleString()}P\n\n` +
              `ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
            );
            return confirmed;
          } else {
            alert(
              `âŒ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\n\n` +
              `ğŸ“Š ë¬´ë£Œ ì‚¬ìš©: 10/10íšŒ (ì†Œì§„)\n` +
              `ğŸ’³ í•„ìš” í¬ì¸íŠ¸: 500P\n` +
              `ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: ${(userCredits?.paidBalance || 0).toLocaleString()}P\n\n` +
              `í¬ì¸íŠ¸ë¥¼ ì¶©ì „í•´ì£¼ì„¸ìš”.`
            );
            return false;
          }
        }
      } else if (type === 'detail') {
        // ìƒì„¸ë¶„ì„: í•­ìƒ 2,000P
        if (userCredits.paidBalance >= 2000) {
          const confirmed = confirm(
            `ğŸ’° ìƒì„¸ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n\n` +
            `PDF ê³µê³ ë¬¸ ìµœëŒ€ 10ê°œë¥¼ AIê°€ ìƒì„¸ ë¶„ì„í•©ë‹ˆë‹¤.\n\n` +
            `ğŸ’³ ì°¨ê° í¬ì¸íŠ¸: 2,000P\n` +
            `ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: ${(userCredits?.paidBalance || 0).toLocaleString()}P\n` +
            `    â†’ ë¶„ì„ í›„: ${((userCredits?.paidBalance || 0) - 2000).toLocaleString()}P\n\n` +
            `ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          );
          return confirmed;
        } else {
          // ìƒ˜í”Œ ë³´ê¸° ìœ ë„
          const showSample = confirm(
            `âŒ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\n\n` +
            `ğŸ’³ í•„ìš” í¬ì¸íŠ¸: 2,000P\n` +
            `ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: ${(userCredits?.paidBalance || 0).toLocaleString()}P\n\n` +
            `[í™•ì¸] ìƒì„¸ë¶„ì„ ìƒ˜í”Œ ë³´ê¸°\n` +
            `[ì·¨ì†Œ] ë‹«ê¸°`
          );
          if (showSample) {
            showDetailSample();
          }
          return false;
        }
      }
      
      return false;
    }
    
    /**
     * í¬ë ˆë”§ ì°¨ê° (Firebase Functions í†µí•´ Firestoreì—ì„œ ì°¨ê°)
     * @param {string} type - 'summary' | 'detail'
     * @returns {Promise<boolean>} - ì„±ê³µ ì—¬ë¶€
     */
    async function deductCredits(type) {
      // ğŸ†• ì„œë²„ì—ì„œ í™•ì¸ëœ ë¬´ì œí•œ ì‚¬ìš©ìëŠ” ì°¨ê° ì•ˆ í•¨
      if (userCredits.unlimited) {
        console.log('ğŸ‘‘ ë¬´ì œí•œ ì‚¬ìš©ì: í¬ì¸íŠ¸ ì°¨ê° ì—†ìŒ -', userCredits.unlimitedReason);
        return true;
      }
      
      // í•˜ë“œì½”ë”©ëœ ê´€ë¦¬ì ID ì²´í¬ (ë°±ì—…)
      const adminUserIds = ['admin', 'kfpcenter', 'polarislkh'];
      const user = firebase.auth().currentUser;
      const currentUserId = user ? user.email.split('@')[0] : '';
      
      if (user && adminUserIds.includes(currentUserId)) {
        console.log('ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ: í¬ì¸íŠ¸ ì°¨ê° ì—†ìŒ');
        return true;
      }
      
      try {
        const deductCreditsFunc = functions.httpsCallable('deductCredits');
        const result = await deductCreditsFunc({ type });
        
        if (result.data.success) {
          // ë¡œì»¬ ìºì‹œ ì—…ë°ì´íŠ¸
          userCredits = {
            ...result.data.credits,
            isLoaded: true,
            unlimited: userCredits.unlimited,           // ğŸ†• ê¸°ì¡´ ë¬´ì œí•œ ìƒíƒœ ìœ ì§€
            unlimitedReason: userCredits.unlimitedReason
          };
          console.log(`ğŸ’° í¬ë ˆë”§ ì°¨ê° ì™„ë£Œ:`, userCredits);
          return true;
        } else {
          console.error('âŒ í¬ë ˆë”§ ì°¨ê° ì‹¤íŒ¨:', result.data.error);
          alert('í¬ë ˆë”§ ì°¨ê°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.data.error);
          return false;
        }
      } catch (error) {
        console.error('âŒ í¬ë ˆë”§ ì°¨ê° ì˜¤ë¥˜:', error);
        return false;
      }
    }
    
    /**
     * ë¶„ì„ ì™„ë£Œ í›„ ì”ì•¡ í‘œì‹œ
     * @param {string} type - 'summary' | 'detail'
     */
    function showCompletionWithCredits(type, resultCount) {
      if (type === 'summary') {
        const freeMsg = userCredits.freeRemaining > 0 
          ? `ğŸ“Š ì´ë²ˆ ë‹¬ ë¬´ë£Œ ì”ì—¬: ${userCredits.freeRemaining}íšŒ`
          : `ğŸ“Š ë¬´ë£Œ ì‚¬ìš© ì†Œì§„ (ë‹¤ìŒ ë‹¬ ë¦¬ì…‹)`;
        
        alert(
          `âœ… ìš”ì•½ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
          `â€¢ ë¶„ì„ ì™„ë£Œ: ${resultCount}ê°œ ê³µê³ \n\n` +
          `${freeMsg}\n` +
          `ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: ${(userCredits?.paidBalance || 0).toLocaleString()}P`
        );
      } else if (type === 'detail') {
        alert(
          `âœ… ìƒì„¸ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
          `â€¢ ë¶„ì„ ì™„ë£Œ: ${resultCount}ê°œ ê³µê³ \n` +
          `â€¢ ì°¨ê° í¬ì¸íŠ¸: 2,000P\n\n` +
          `ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: ${(userCredits?.paidBalance || 0).toLocaleString()}P`
        );
      }
    }
    
    // ==================== í¬ë ˆë”§ ì‹œìŠ¤í…œ ì¢…ë£Œ ====================
    
  </script>

  <!-- ìƒì„¸ë¶„ì„ ìƒ˜í”Œ ëª¨ë‹¬ -->
  <div id="detail-sample-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; padding: 1rem; overflow-y: auto;">
    <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 95vh; overflow-y: auto; position: relative; margin: auto;">
      
      <!-- í—¤ë” -->
      <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 16px 16px 0 0; position: sticky; top: 0; z-index: 1;">
        <button onclick="closeDetailSample()" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem; cursor: pointer;">âœ•</button>
        <h2 style="margin: 0; font-size: 1.3rem;">ğŸ‘ï¸ ìƒì„¸ë¶„ì„ ìƒ˜í”Œ ë¯¸ë¦¬ë³´ê¸°</h2>
        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">ì‹¤ì œ AI PDF ìƒì„¸ë¶„ì„ ê²°ê³¼ì™€ ë™ì¼í•œ í˜•íƒœì…ë‹ˆë‹¤</p>
      </div>
      
      <!-- ìƒ˜í”Œ ë‚´ìš© (ì‹¤ì œ ë¶„ì„ í˜•íƒœ) -->
      <div style="padding: 1.5rem;">
        
        <!-- AI PDF ìƒì„¸ë¶„ì„ ë°•ìŠ¤ -->
        <div style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); border: 2px solid #667eea; border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 24px rgba(102,126,234,0.15);">
          
          <!-- í—¤ë” -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px dashed rgba(102,126,234,0.3);">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span style="font-size: 1.8rem;">ğŸ“„</span>
              <h3 style="color: #667eea; margin: 0; font-size: 1.2rem; font-weight: 700;">AI PDF ìƒì„¸ë¶„ì„</h3>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: linear-gradient(135deg, #6f42c1, #e83e8c); color: white; padding: 0.4rem 1rem; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">ğŸŸ£ ê´€ë ¨ë„: ë³´í†µ</span>
              <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.4rem 1rem; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">70ì </span>
            </div>
          </div>
          
          <!-- ì‚¬ì—… ìš”ì•½ -->
          <div style="background: white; padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color: #667eea; margin: 0 0 0.8rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ“‹</span> ì‚¬ì—… ìš”ì•½
            </h4>
            <p style="color: #333; margin: 0; line-height: 1.8; font-size: 0.95rem;">
              ë³¸ ì‚¬ì—…ì€ ìˆ˜ë„ê¶Œ ì†Œì¬ ì¤‘ì†Œê¸°ì—… ë° ì‚¬íšŒì Â·ì¥ì• ì¸ê¸°ì—…ì˜ ê³µê³µì¡°ë‹¬ì‹œì¥ ì§„ì¶œì„ ì§€ì›í•˜ê¸° ìœ„í•œ ë¬´ë£Œ 1:1 ë§ì¶¤í˜• ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ë‚˜ë¼ì¥í„° ì¡°ë‹¬ì—…ì²´ ë“±ë¡ë¶€í„° ë²¤ì²˜Â·í˜ì‹ ì œí’ˆ, MAS, ê²½ìŸì…ì°° ë“± ê³µê³µì¡°ë‹¬ ì œë„ ì „ë°˜ì— ëŒ€í•œ ì „ë¬¸ê°€ ì»¨ì„¤íŒ…ì„ ì œê³µí•˜ë©°, ì´ 50ê°œì‚¬ë¥¼ ì„ ì •í•©ë‹ˆë‹¤. íŠ¹íˆ ì‚¬íšŒì ê¸°ì—… ë° ì¥ì• ì¸ê¸°ì—…ì€ ìš°ì„  ëª¨ì§‘ëŒ€ìƒì…ë‹ˆë‹¤. ê³µê³µì¡°ë‹¬ ì‹œì¥ ì§„ì…ì„ í¬ë§í•˜ëŠ” ê¸°ì—…ì—ê²Œ ì‹¤ì§ˆì ì¸ ë„ì›€ì„ ì¤„ ìˆ˜ ìˆëŠ” ê¸°íšŒì…ë‹ˆë‹¤.
            </p>
          </div>
          
          <!-- ìê²©ìš”ê±´ -->
          <div style="background: white; padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #28a745; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color: #28a745; margin: 0 0 0.8rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ“Œ</span> ìê²©ìš”ê±´
            </h4>
            <ul style="margin: 0; padding-left: 1.2rem; color: #333; line-height: 1.9; font-size: 0.95rem;">
              <li><strong>ê¸°ì—…ê·œëª¨:</strong> ì¤‘ì†Œê¸°ì—… (ì†Œê¸°ì—… í¬í•¨)</li>
              <li><strong>ì—…ë ¥:</strong> ì œí•œ ì—†ìŒ</li>
              <li><strong>í•„ìˆ˜ì¸ì¦:</strong> ì—†ìŒ</li>
              <li><strong>ì§€ì—­ì œí•œ:</strong> ìˆ˜ë„ê¶Œ (ì„œìš¸, ê²½ê¸°, ì¸ì²œ)ì— ë³¸ì‚¬ ë˜ëŠ” ê³µì¥ì´ ì†Œì¬í•œ ê¸°ì—…</li>
              <li>ê³µê³µì¡°ë‹¬ì‹œì¥ ì§„ì¶œì— ê´€ì‹¬ ìˆëŠ” ê¸°ì—…</li>
            </ul>
          </div>
          
          <!-- ì§€ì›ê·œëª¨ -->
          <div style="background: white; padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #ffc107; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color: #f57c00; margin: 0 0 0.8rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ’°</span> ì§€ì›ê·œëª¨
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.85rem;">ì´ ì˜ˆì‚°</p>
                <p style="margin: 0; color: #333; font-weight: 600;">í™•ì¸ í•„ìš” (ì»¨ì„¤íŒ… ì„œë¹„ìŠ¤ ì œê³µ ì‚¬ì—…ìœ¼ë¡œ ì˜ˆì‚° ê·œëª¨ëŠ” ë³„ë„ ëª…ì‹œë˜ì§€ ì•ŠìŒ)</p>
              </div>
              <div>
                <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.85rem;">ê¸°ì—…ë‹¹</p>
                <p style="margin: 0; color: #333; font-weight: 600;">ë¬´ë£Œ 1:1 ë§ì¶¤í˜• ì»¨ì„¤íŒ… ì œê³µ (ê¸ˆì „ì  ì§€ì› ì—†ìŒ)</p>
              </div>
              <div>
                <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.85rem;">ì„ ì •ê·œëª¨</p>
                <p style="margin: 0; color: #333; font-weight: 600;">50ê°œì‚¬ (ì„ ì°©ìˆœ, ì‚¬íšŒì ê¸°ì—…/ì¥ì• ì¸ê¸°ì—… ìš°ì„  ëª¨ì§‘)</p>
              </div>
              <div>
                <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.85rem;">ì§€ì›ë‚´ìš©</p>
                <p style="margin: 0; color: #333; font-weight: 600;">ê³µê³µì¡°ë‹¬ ì œë„ ì „ë°˜ì— ëŒ€í•œ 1:1 ë§ì¶¤í˜• ì»¨ì„¤íŒ… (ë‚˜ë¼ì¥í„° ì¡°ë‹¬ì—…ì²´ ë“±ë¡, ë²¤ì²˜Â·ì°½ì—…ê¸°ì—…ì œí’ˆ, í˜ì‹ ì œí’ˆ, ìš°ìˆ˜ì¡°ë‹¬ë¬¼í’ˆ, ë‹¤ìˆ˜ê³µê¸‰ìê³„ì•½(MAS), ê²½ìŸì…ì°° ë“±)</p>
              </div>
            </div>
          </div>
          
          <!-- ì œì¶œì„œë¥˜ -->
          <div style="background: white; padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #17a2b8; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color: #17a2b8; margin: 0 0 0.8rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ“</span> ì œì¶œì„œë¥˜
            </h4>
            <ul style="margin: 0; padding-left: 1.2rem; color: #333; line-height: 1.9; font-size: 0.95rem;">
              <li><strong>í•„ìˆ˜:</strong> ì»¨ì„¤íŒ… ì‹ ì²­ì„œ (ë¶™ì„1), ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë™ì˜ì„œ (ë¶™ì„2)</li>
              <li><strong>ì„ íƒ:</strong> ì‚¬íšŒì ê¸°ì—…(ì˜ˆë¹„) ì¸ì¦ì„œ ë˜ëŠ” ì¥ì• ì¸ê¸°ì—… í™•ì¸ì„œ (í•´ë‹¹ ê¸°ì—…ë§Œ ì œì¶œ, ìš°ì„  ëª¨ì§‘ ëŒ€ìƒ)</li>
            </ul>
          </div>
          
          <!-- ì£¼ìš” ì¼ì • -->
          <div style="background: white; padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #6f42c1; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color: #6f42c1; margin: 0 0 0.8rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ“…</span> ì£¼ìš” ì¼ì •
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
              <div>
                <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.85rem;">ì‹ ì²­ê¸°ê°„</p>
                <p style="margin: 0; color: #333; font-weight: 600;">2025.11.27.(ëª©) ~ 2025.12.17.(ìˆ˜)</p>
              </div>
              <div>
                <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.85rem;">ì‹¬ì‚¬ê¸°ê°„</p>
                <p style="margin: 0; color: #333; font-weight: 600;">2025.12.17. ì´í›„ (ì‹ ì²­ì„œ ê²€í†  ë° ì»¨ì„¤íŒ… ëŒ€ìƒì—…ì²´ ì„ ì •)</p>
              </div>
              <div>
                <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.85rem;">ì„ ì •ë°œí‘œ</p>
                <p style="margin: 0; color: #333; font-weight: 600;">2026ë…„ 1ì›” ì´ˆìˆœ (ì»¨ì„¤íŒ… ëŒ€ìƒê¸°ì—… ìœ ì„  ì—°ë½)</p>
              </div>
              <div>
                <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.85rem;">ìˆ˜í–‰ê¸°ê°„</p>
                <p style="margin: 0; color: #333; font-weight: 600;">2026ë…„ 1ì›” ~ 2026ë…„ 3ì›” ì¤‘ìˆœ (ì—…ì²´ë³„ ì»¨ì„¤íŒ… ì§„í–‰)</p>
              </div>
            </div>
          </div>
          
          <!-- í•œêµ­ì—í”„í”¼ì„¼í„° ë§ì¶¤ ë¶„ì„ -->
          <div style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid #f59e0b;">
            <h4 style="color: #d97706; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ¢</span> í•œêµ­ì—í”„í”¼ì„¼í„° ë§ì¶¤ ë¶„ì„
            </h4>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <!-- ê°•ì  -->
              <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #22c55e;">
                <h5 style="color: #16a34a; margin: 0 0 0.5rem 0; font-size: 0.95rem;">ğŸ’ª ê°•ì </h5>
                <ul style="margin: 0; padding-left: 1rem; color: #333; font-size: 0.9rem; line-height: 1.7;">
                  <li>**ìˆ˜ë„ê¶Œ ì†Œì¬ ì¶©ì¡±:** ì„œìš¸ ì†¡íŒŒêµ¬ì— ì†Œì¬í•˜ì—¬ ë³¸ ì‚¬ì—…ì˜ ê°€ì¥ ê¸°ë³¸ì ì¸ ìê²©ìš”ê±´ì¸ 'ìˆ˜ë„ê¶Œ ì†Œì¬ ê¸°ì—…'ì„ ì™„ë²½í•˜ê²Œ ì¶©ì¡±í•©ë‹ˆë‹¤.</li>
                  <li>**ê¸°ì—… ê·œëª¨ ì í•©:** 'ì†Œê¸°ì—…'ìœ¼ë¡œì„œ ì¤‘ì†Œê¸°ì—… ë²”ì£¼ì— í•´ë‹¹í•˜ì—¬ ì§€ì› ëŒ€ìƒì— ë¶€í•©í•©ë‹ˆë‹¤. ì¤‘ì†Œê¸°ì—… ì§€ì› ì‚¬ì—…ì˜ ì·¨ì§€ì— ì í•©í•©ë‹ˆë‹¤.</li>
                  <li>**ê²½ìŸì‚¬ ìš°ëŒ€:** êµ­ë‚´ ë° ì§€ë°©ì¬ ì œë„ ì—†ì´ ì „êµ­ ë¬´ì—­ ì§€ì› ì‚¬ì—… ì°¸ì—¬ì— ëŒ€í•œ ê¸°ë³¸ì ì¸ ì‹ ë¢°ë„ë¥¼ í™•ë³´í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
                  <li>**ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ ë³´ìœ :** ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œë¥¼ ë³´ìœ í•˜ê³  ìˆì–´ ê¸°ìˆ  ê¸°ë°˜ì˜ ì „ë¬¸ ì„œë¹„ìŠ¤ ê¸°ì—…ì„ì„ ì–´í•„í•  ìˆ˜ ìˆìœ¼ë©°, í–¥í›„ ê³µê³µì¡°ë‹¬ ì‹œì¥ì—ì„œ ê¸°ìˆ ë ¥ ê¸°ë°˜ì˜ ì œí’ˆ/ì„œë¹„ìŠ¤ë¥¼ ì œì•ˆí•  ê°€ëŠ¥ì„±ì„ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                  <li>**ì¬ë¬´ ê±´ì „ì„±:** ë¶€ì±„ë¹„ìœ¨ 50%ë¡œ ì–‘í˜¸í•œ ì¬ë¬´ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ìˆì–´, ì‚¬ì—… ìˆ˜í–‰ ëŠ¥ë ¥ì— ëŒ€í•œ ìš°ë ¤ê°€ ì ìŠµë‹ˆë‹¤.</li>
                </ul>
              </div>
              
              <!-- ë³´ì™„ì  -->
              <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444;">
                <h5 style="color: #dc2626; margin: 0 0 0.5rem 0; font-size: 0.95rem;">âš ï¸ ë³´ì™„ì </h5>
                <ul style="margin: 0; padding-left: 1rem; color: #333; font-size: 0.9rem; line-height: 1.7;">
                  <li>**ìš°ì„  ëª¨ì§‘ ëŒ€ìƒ ë¯¸í•´ë‹¹:** ì‚¬íšŒì ê¸°ì—… ë˜ëŠ” ì¥ì• ì¸ê¸°ì—…ì´ ì•„ë‹ˆë¯€ë¡œ, 'ìš°ì„  ëª¨ì§‘' ëŒ€ìƒì—ì„œ ì œì™¸ë˜ì–´ ì„ ì°©ìˆœ ê²½ìŸì—ì„œ ë‹¤ì†Œ ë¶ˆë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ëŒ€ì‘ë°©ì•ˆ: ì‹ ì²­ ê¸°ê°„ ì‹œì‘ê³¼ ë™ì‹œì— ì‹ ì†í•˜ê²Œ ì ‘ìˆ˜í•˜ì—¬ ì„ ì°©ìˆœ ê¸°íšŒë¥¼ í™•ë³´í•´ì•¼ í•©ë‹ˆë‹¤.)</li>
                  <li>**ì£¼ë ¥ ì œí’ˆ/ì„œë¹„ìŠ¤ ì •ë³´ ë¶€ì¡±:** ê¸°ì—… í”„ë¡œí•„ì— ì£¼ë ¥ ì œí’ˆ/ì„œë¹„ìŠ¤ ë° ì„¸ë¶€ ì—…ì¢… ì •ë³´ê°€ ë¯¸ì…ë ¥ë˜ì–´ ìˆì–´, ê³µê³µì¡°ë‹¬ ì‹œì¥ ì í•©ì„±ì„ ì–´í•„í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ì‚¬ì—… ë‚´ìš© ë³´ì™„ì´ ì‹œê¸‰í•©ë‹ˆë‹¤. (ëŒ€ì‘ë°©ì•ˆ: ì»¨ì„¤íŒ… ì‹ ì²­ì„œì—ì„œ ê¸°ìˆ í•˜ì—¬ í•©ë‹ˆë‹¤.)</li>
                  <li>**ê¸°ìˆ /ì—°êµ¬ ì—­ëŸ‰ ì–´í•„ í•œê³„:** ë“±ë¡/ì¶œì› íŠ¹í—ˆê°€ ì—†ì–´ ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ ë³´ìœ ì—ë„ ë¶ˆêµ¬í•˜ê³  ê¸°ì‹œì ì¸ ê¸°ìˆ ì  ì„±ë¹™ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (ëŒ€ì‘ë°©ì•ˆ: ì—°êµ¬ì†Œì˜ í™œë™ ë‚´ìš©ê³¼ í–¥í›„ ê³µê³µì¡°ë‹¬ ì‹œì¥ì— ê¸°ì—¬í•  ìˆ˜ ìˆëŠ” ê¸°ìˆ  ê°œë°œ ê³„íšì„ ì‹ ì²­ì„œì—ì„œ ìƒì„¸íˆ ê¸°ìˆ í•˜ì—¬ ì ì¬ë ¥ì„ ì–´í•„í•´ì•¼ í•©ë‹ˆë‹¤.)</li>
                  <li>**ê³µê³µì¡°ë‹¬ ê²½í—˜ ë¶€ì¬:** 'ì¡°ë‹¬ì²­ ë‚˜ë¼ì¥í„° ë“±ë¡ ì—¬ë¶€' í•­ëª©ì´ ë¯¸ë“±ë¡ìœ¼ë¡œ ì˜ˆìƒë˜ë©°, ê³µê³µì¡°ë‹¬ ì‹œì¥ ì§„ì¶œ ê²½í—˜ì´ ì—†ëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. (ëŒ€ì‘ë°©ì•ˆ: ì»¨ì„¤íŒ… ìš”ì²­ ë‚´ìš©ì„ ë§¤ìš° êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì—¬, ë³¸ ì»¨ì„¤íŒ…ì„ í†µí•´ ê³µê³µì¡°ë‹¬ ì‹œì¥ì— ì„±ê³µì ìœ¼ë¡œ ì§„ì…í•˜ê² ë‹¤ëŠ” ê°•ë ¥í•œ ì˜ì§€ì™€ ê³„íš ë³´ì—¬ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.)</li>
                  <li>**ì„±ìˆ™ê¸° ê¸°ì—…ì˜ ëª…í™•í•œ ëª©ì  ì œì‹œ í•„ìš”:** ì—…ë ¥ 13ë…„ì°¨ì˜ ì„±ìˆ™ê¸° ê¸°ì—…ìœ¼ë¡œì„œ, ë‹¨ìˆœí•œ ì •ë³´ ìŠµë“ì„ ë„˜ì–´ ì»¨ì„¤íŒ…ì„ í†µí•´ ì–´ë–¤ êµ¬ì²´ì ì¸ ì„±ê³¼(ì˜ˆ: íŠ¹ì • ì¡°ë‹¬ ë“±ë¡, ê³„ì•½ ìˆ˜ì£¼ ëª©í‘œ ë“±)ë¥¼ ë‚¼ ê²ƒì¸ì§€ ëª…í™•í•œ ëª©í‘œë¥¼ ì œì‹œí•´ì•¼ í•©ë‹ˆë‹¤. (ëŒ€ì‘ë°©ì•ˆ: ì»¨ì„¤íŒ… ìš”ì²­ ë‚´ìš©ì— ê³µê³µì¡°ë‹¬ ì‹œì¥ ì§„ì¶œ ëª©í‘œë¥¼ í¬í•¨í•˜ì—¬ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.)</li>
                </ul>
              </div>
            </div>
          </div>
          
          <!-- AI ì¶”ì²œ ì˜ê²¬ -->
          <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid #10b981;">
            <h4 style="color: #059669; margin: 0 0 0.8rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ’¡</span> ì¶”ì²œ ì˜ê²¬
            </h4>
            <p style="color: #333; margin: 0; line-height: 1.9; font-size: 0.95rem;">
              ì¶”ì²œ. í•œêµ­ì—í”„í”¼ì„¼í„°ëŠ” ë³¸ ì‚¬ì—…ì˜ í•„ìˆ˜ ìê²©ìš”ê±´(ìˆ˜ë„ê¶Œ ì†Œì¬, ì¤‘ì†Œê¸°ì—…)ì„ ëª¨ë‘ ì¶©ì¡±í•˜ë©°, ì¬ë¬´ ìƒíƒœ ë° ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ ë³´ìœ  ë“± ê¸°ë³¸ì ì¸ ê°•ì ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ì‚¬íšŒì ê¸°ì—…ì´ë‚˜ ì¥ì• ì¸ê¸°ì—…ì´ ì•„ë‹ˆë¯€ë¡œ ìš°ì„  ëª¨ì§‘ ëŒ€ìƒì— í•´ë‹¹í•˜ì§€ ì•Šì•„ ì„ ì°©ìˆœ ê²½ìŸì—ì„œ ë¶ˆë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì‹ ì²­ ê¸°ê°„ ì‹œì‘ê³¼ ë™ì‹œì— ì‹ ì†í•˜ê²Œ ì ‘ìˆ˜í•˜ëŠ” ê²ƒì´ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. ë˜í•œ, ì»¨ì„¤íŒ… ì‹ ì²­ì„œì˜ 'ì»¨ì„¤íŒ… ìš”ì²­ë‚´ìš©'ì„ ë‹¹ì‚¬ì˜ ì „ë¬¸ ì„œë¹„ìŠ¤ì™€ ê³µê³µì¡°ë‹¬ ì‹œì¥ì˜ ì—°ê³„ì„±ì„ ëª…í™•íˆ ë³´ì—¬ì¤„ ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì´ê³  ì „ëµì ìœ¼ë¡œ ì‘ì„±í•˜ì—¬, ì»¨ì„¤íŒ…ì„ í†µí•´ ì–»ê³ ì í•˜ëŠ” ëª©í‘œì™€ ê¸°ëŒ€ íš¨ê³¼ë¥¼ ê°•ë ¥í•˜ê²Œ ì–´í•„í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¤€ë¹„ë¥¼ í†µí•´ ì¶©ë¶„íˆ ì„ ì • ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë©°, ë¬´ë£Œë¡œ ì œê³µë˜ëŠ” ê³µê³µì¡°ë‹¬ ì „ë¬¸ê°€ ì»¨ì„¤íŒ…ì€ ê¸°ì—…ì˜ ìƒˆë¡œìš´ ì„±ì¥ ë™ë ¥ì„ í™•ë³´í•˜ëŠ” ë° í° ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤.
            </p>
          </div>
          
          <!-- ì„ ì • ê°€ëŠ¥ì„± ë†’ì´ëŠ” íŒ -->
          <div style="background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); padding: 1.2rem; border-radius: 12px; border: 2px solid #ec4899;">
            <h4 style="color: #db2777; margin: 0 0 0.8rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>â­</span> ì„ ì • ê°€ëŠ¥ì„± ë†’ì´ëŠ” íŒ
            </h4>
            <ul style="margin: 0; padding-left: 1.2rem; color: #333; line-height: 1.9; font-size: 0.95rem;">
              <li>ê³µê³ ë¬¸ì„ ìƒì„¸íˆ í™•ì¸í•˜ì„¸ìš”</li>
              <li>ì‹ ì²­ ê¸°ê°„ ì´ˆë°˜ì— ì ‘ìˆ˜í•˜ì„¸ìš” (ì„ ì°©ìˆœ ìš°ì„ )</li>
              <li>ì»¨ì„¤íŒ… ìš”ì²­ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”</li>
              <li>ê¸°ì—…ì˜ ê³µê³µì¡°ë‹¬ ì‹œì¥ ì§„ì¶œ ì˜ì§€ë¥¼ ëª…í™•íˆ í‘œí˜„í•˜ì„¸ìš”</li>
            </ul>
          </div>
          
        </div>
        
      </div>
      
      <!-- í•˜ë‹¨ ë²„íŠ¼ -->
      <div style="padding: 1rem 1.5rem 1.5rem; border-top: 1px solid #eee; display: flex; gap: 0.75rem; flex-wrap: wrap;">
        <button onclick="closeDetailSample()" style="flex: 1; min-width: 100px; padding: 0.9rem; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
          ë‹«ê¸°
        </button>
        <button onclick="closeDetailSample(); analyzeProgramsDetail();" style="flex: 2; min-width: 200px; padding: 0.9rem; background: linear-gradient(135deg, #FF8802, #FF6B00); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
          ğŸ“Š ìƒì„¸ë¶„ì„ ì‹œì‘ (2,000P)
        </button>
      </div>
      
    </div>
  </div>

  <!-- í¬ì¸íŠ¸ ì¶©ì „/ì¡°íšŒ ëª¨ë‹¬ -->
  <div id="point-charge-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; justify-content: center; align-items: center; padding: 1rem; overflow-y: auto;">
    <div style="background: linear-gradient(135deg, #1a365d 0%, #2d4a77 100%); border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.4); max-height: 90vh; overflow-y: auto; margin: auto;">
      
      <!-- í—¤ë” -->
      <div style="background: linear-gradient(135deg, #FF8802, #FF6B00); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0;">
        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
          <span>ğŸ’°</span> í¬ì¸íŠ¸ ì¶©ì „/ì¡°íšŒ
        </h3>
        <button onclick="closePointChargeModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">âœ•</button>
      </div>
      
      <!-- ë‚´ìš© -->
      <div style="padding: 1.5rem;">
        
        <!-- í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸ -->
        <div style="background: rgba(255,255,255,0.1); padding: 1.2rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.2);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <p style="color: #aaa; font-size: 0.85rem; margin: 0 0 0.3rem 0;">í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸</p>
              <p id="current-points-display" style="color: #FFD700; font-size: 1.8rem; font-weight: 700; margin: 0;">0 P</p>
            </div>
            <button onclick="refreshPoints()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.3rem;">
              ğŸ”„ ì¡°íšŒ
            </button>
          </div>
          <div id="free-usage-display" style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; color: #aaa;"></div>
        </div>
        
        <!-- ì¶©ì „ ê¸ˆì•¡ ì„ íƒ -->
        <div style="margin-bottom: 1.5rem;">
          <p style="color: #ccc; font-size: 0.9rem; margin: 0 0 0.8rem 0; font-weight: 600;">ğŸ’³ ì¶©ì „ ê¸ˆì•¡ ì„ íƒ</p>
          
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 0.8rem;">
            <button class="charge-amount-btn" data-amount="10000" onclick="selectChargeAmount(10000)" style="padding: 0.7rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">1ë§Œì›</button>
            <button class="charge-amount-btn" data-amount="30000" onclick="selectChargeAmount(30000)" style="padding: 0.7rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">3ë§Œì›</button>
            <button class="charge-amount-btn" data-amount="50000" onclick="selectChargeAmount(50000)" style="padding: 0.7rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">5ë§Œì›</button>
            <button class="charge-amount-btn" data-amount="100000" onclick="selectChargeAmount(100000)" style="padding: 0.7rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">10ë§Œì›</button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
            <button class="charge-amount-btn" data-amount="300000" onclick="selectChargeAmount(300000)" style="padding: 0.7rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">30ë§Œì›</button>
            <button class="charge-amount-btn" data-amount="500000" onclick="selectChargeAmount(500000)" style="padding: 0.7rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">50ë§Œì›</button>
            <button class="charge-amount-btn" data-amount="1000000" onclick="selectChargeAmount(1000000)" style="padding: 0.7rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">100ë§Œì›</button>
          </div>
          
          <!-- ì§ì ‘ ì…ë ¥ -->
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span style="color: #aaa; font-size: 0.85rem; white-space: nowrap;">ì§ì ‘ì…ë ¥:</span>
            <input type="number" id="custom-charge-amount" placeholder="ê¸ˆì•¡ ì…ë ¥" min="10000" max="1000000" step="1000" oninput="onCustomAmountInput()" style="flex: 1; padding: 0.7rem; background: rgba(255,255,255,0.95); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.9rem; color: #333;">
            <span style="color: #aaa; font-size: 0.85rem;">ì›</span>
          </div>
          <p style="color: #888; font-size: 0.75rem; margin: 0.5rem 0 0 0; text-align: right;">â€» 1ë§Œì› ~ 100ë§Œì› (1,000ì› ë‹¨ìœ„)</p>
        </div>
        
        <!-- ì„ íƒëœ ê¸ˆì•¡ í‘œì‹œ -->
        <div id="selected-amount-display" style="background: rgba(255,136,2,0.2); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255,136,2,0.5); display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #ccc; font-size: 0.9rem;">ê²°ì œ ê¸ˆì•¡</span>
            <span id="selected-amount-text" style="color: #FF8802; font-size: 1.3rem; font-weight: 700;">0ì›</span>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
            <span style="color: #ccc; font-size: 0.9rem;">ì ë¦½ í¬ì¸íŠ¸</span>
            <span id="selected-points-text" style="color: #FFD700; font-size: 1.3rem; font-weight: 700;">+0 P</span>
          </div>
        </div>
        
        <!-- ì¶©ì „í•˜ê¸° ë²„íŠ¼ -->
        <button id="charge-submit-btn" onclick="requestPayment()" disabled style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #666, #555); color: #999; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: not-allowed; margin-bottom: 1rem; transition: all 0.3s;">
          ğŸ’³ ì¶©ì „í•˜ê¸°
        </button>
        
        <!-- ì•ˆë‚´ ì‚¬í•­ -->
        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; border-left: 3px solid #667eea;">
          <p style="color: #aaa; font-size: 0.8rem; margin: 0; line-height: 1.6;">
            ğŸ“Œ <strong style="color: #ccc;">í¬ì¸íŠ¸ ì•ˆë‚´</strong><br>
            â€¢ ìš”ì•½ë¶„ì„: ë¬´ë£Œ 10íšŒ/ì›”, ì´í›„ 500P/íšŒ<br>
            â€¢ ìƒì„¸ë¶„ì„: 2,000P/íšŒ<br>
            â€¢ ì¶©ì „ ê¸ˆì•¡ì€ 1:1ë¡œ í¬ì¸íŠ¸ ì ë¦½<br>
            â€¢ ê²°ì œ ì™„ë£Œ í›„ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥
          </p>
        </div>
        
      </div>
      
    </div>
  </div>

  <!-- ì¶©ì „ ì™„ë£Œ ëª¨ë‹¬ -->
  <div id="charge-complete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002; justify-content: center; align-items: center; padding: 1rem;">
    <div style="background: white; border-radius: 16px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.4); overflow: hidden;">
      
      <!-- í—¤ë” -->
      <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 2rem; text-align: center;">
        <span style="font-size: 4rem; display: block; margin-bottom: 0.5rem;">âœ…</span>
        <h3 style="margin: 0; font-size: 1.4rem;">ì¶©ì „ ì™„ë£Œ!</h3>
      </div>
      
      <!-- ë‚´ìš© -->
      <div style="padding: 1.5rem;">
        <div style="background: #f8f9fa; padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem;">
            <span style="color: #666;">ì¶©ì „ ê¸ˆì•¡</span>
            <span id="complete-amount" style="color: #333; font-weight: 600;">0ì›</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem;">
            <span style="color: #666;">ì ë¦½ í¬ì¸íŠ¸</span>
            <span id="complete-points" style="color: #10b981; font-weight: 600;">+0 P</span>
          </div>
          <div style="border-top: 1px solid #ddd; padding-top: 0.8rem; margin-top: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #333; font-weight: 600;">í˜„ì¬ ì”ì•¡</span>
              <span id="complete-balance" style="color: #FF8802; font-weight: 700; font-size: 1.2rem;">0 P</span>
            </div>
          </div>
        </div>
        
        <button onclick="closeChargeCompleteModal()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #FF8802, #FF6B00); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer;">
          í™•ì¸
        </button>
      </div>
      
    </div>
  </div>

  <!-- ìƒì„¸ë¶„ì„ í™•ì¸ ëª¨ë‹¬ (ìš”ì•½ë¶„ì„ ì¹´ë“œì—ì„œ ì§„ì…) -->
  <div id="detail-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; justify-content: center; align-items: center; padding: 1rem;">
    <div style="background: white; border-radius: 16px; max-width: 450px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;">
      
      <!-- í—¤ë” -->
      <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; text-align: center;">
        <span style="font-size: 3rem; display: block; margin-bottom: 0.5rem;">ğŸ“Š</span>
        <h3 style="margin: 0; font-size: 1.3rem;">ìƒì„¸ë¶„ì„ ì•ˆë‚´</h3>
      </div>
      
      <!-- ë‚´ìš© -->
      <div style="padding: 1.5rem;">
        <div style="background: #f8f9ff; padding: 1.2rem; border-radius: 12px; border-left: 4px solid #667eea; margin-bottom: 1rem;">
          <p style="color: #333; margin: 0; line-height: 1.8; font-size: 0.95rem;">
            ë³¸ ê³µê³ ë¬¸ì„ í¬í•¨í•˜ì—¬ <strong style="color: #667eea;">ìµœëŒ€ 10ê°œ</strong> ì§€ì›ì‚¬ì—…ì— ëŒ€í•˜ì—¬ ìƒì„¸í•œ ë¶„ì„ì„ ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
        
        <div style="background: #fff8e6; padding: 1rem; border-radius: 12px; border-left: 4px solid #ffc107;">
          <p style="color: #856404; margin: 0; font-size: 0.9rem; line-height: 1.6;">
            ğŸ’¡ <strong>ìƒì„¸ë¶„ì„ í¬í•¨ ë‚´ìš©:</strong><br>
            â€¢ ì‚¬ì—… ìš”ì•½ ë° ìê²©ìš”ê±´<br>
            â€¢ ì§€ì›ê·œëª¨ ë° ì œì¶œì„œë¥˜<br>
            â€¢ ì£¼ìš” ì¼ì •<br>
            â€¢ ê·€ì‚¬ ë§ì¶¤ ê°•ì /ë³´ì™„ì  ë¶„ì„<br>
            â€¢ AI ì¶”ì²œ ì˜ê²¬ ë° ì„ ì • íŒ
          </p>
        </div>
      </div>
      
      <!-- ë²„íŠ¼ -->
      <div style="padding: 1rem 1.5rem 1.5rem; display: flex; gap: 0.75rem;">
        <button onclick="closeDetailConfirm()" style="flex: 1; padding: 0.9rem; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
          ì·¨ì†Œ
        </button>
        <button onclick="proceedDetailAnalysis()" style="flex: 2; padding: 0.9rem; background: linear-gradient(135deg, #FF8802, #FF6B00); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(255,136,2,0.3);">
          ğŸ“Š ìƒì„¸ë¶„ì„ ì‹œì‘ (2,000P)
        </button>
      </div>
      
    </div>
  </div>

</body>
</html>
