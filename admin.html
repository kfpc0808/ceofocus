<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Master í†µí•© ê´€ë¦¬ì V24 (ë ˆì´ì•„ì›ƒ ë™ê¸°í™”)</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- SheetJS (ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš©) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #0c2c54;
            --secondary-color: #f5f6fa;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-bg: #fff3cd;
            --warning-text: #856404;
            --text-color: #2c3e50;
            --border-color: #dee2e6;
            --sidebar-width: 250px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            font-size: 0.9rem;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: white;
            position: fixed;
            height: 100vh;
            left: 0; top: 0;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            z-index: 100;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            text-decoration: none;
        }

        .nav-menu { list-style: none; flex: 1; }
        .nav-item { margin-bottom: 0.25rem; }
        .nav-link {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.6rem 1rem;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255, 255, 255, 0.1); color: white; }
        .admin-profile {
            padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; gap: 0.75rem;
        }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 1.5rem; }
        
        /* ê³ ì • ìƒë‹¨ ë°” */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            padding: 0.75rem 1.5rem;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        .top-bar-date { color: #666; font-size: 0.9rem; }
        .top-bar-buttons { display: flex; gap: 0.5rem; }
        .page-header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.5rem; color: var(--primary-color); font-weight: 700; }

        /* ìƒë‹¨ ë²„íŠ¼ ê·¸ë£¹ */
        .top-buttons { display: flex; gap: 0.5rem; align-items: center; }

        .card {
            background: white; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 1.2rem; margin-bottom: 1.2rem;
        }

        /* íƒ­ ì»¨í…ì¸  ì œì–´ */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ì„œë¸Œ íƒ­ */
        .sub-nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e9ecef; padding-bottom: 0; overflow-x: auto; }
        .sub-nav-item { padding: 0.5rem 0.8rem; cursor: pointer; font-weight: 600; color: #6c757d; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; white-space: nowrap; font-size: 0.9rem; }
        .sub-nav-item:hover { color: var(--primary-color); }
        .sub-nav-item.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        /* ë²„íŠ¼ */
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; text-decoration: none; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: var(--accent-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-color); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* í…Œì´ë¸” */
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; flex-wrap: wrap; gap: 0.8rem; }
        .table-controls h3 { font-size: 1.1rem; margin: 0; }
        .search-box { display: flex; gap: 0.4rem; align-items: center; }
        .search-box input { padding: 0.4rem; border: 1px solid #dee2e6; border-radius: 4px; min-width: 200px; font-size: 0.85rem; }
        
        .table-container { overflow-x: auto; min-height: 200px; }
        table { width: 100%; border-collapse: collapse; margin-top: 0.2rem; min-width: 800px; font-size: 0.85rem; }
        th { background: #f8f9fa; color: var(--primary-color); padding: 0.6rem 0.5rem; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border-color); white-space: nowrap; }
        td { padding: 0.5rem 0.5rem; border-bottom: 1px solid #eee; vertical-align: middle; white-space: nowrap; }
        .clickable-cell { cursor: pointer; color: var(--primary-color); font-weight: 600; text-decoration: underline; text-underline-offset: 2px; }
        
        .pagination { display: flex; justify-content: center; gap: 0.3rem; margin-top: 1rem; align-items: center; }
        .page-btn { padding: 0.3rem 0.6rem; border: 1px solid #dee2e6; background: white; border-radius: 4px; cursor: pointer; min-width: 28px; text-align: center; font-size: 0.85rem; }
        .page-btn:hover { background: #e9ecef; }
        .page-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* í¼ */
        .form-group { margin-bottom: 0.8rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 600; color: var(--primary-color); font-size: 0.9rem; }
        .form-control { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }

        /* ì—ë””í„° */
        .editor-container { border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; }
        .editor-toolbar { background: #f8f9fa; border-bottom: 1px solid var(--border-color); padding: 0.4rem; display: flex; gap: 0.4rem; align-items: center; }
        .editor-btn { background: white; border: 1px solid #dee2e6; border-radius: 3px; width: 26px; height: 26px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        .editor-content { min-height: 300px; padding: 0.8rem; outline: none; overflow-y: auto; background: white; font-size: 0.9rem; line-height: 1.5; }
        .color-picker { width: 26px; height: 26px; padding: 0; border: none; cursor: pointer; }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 800px; border-radius: 8px; padding: 1.5rem; max-height: 90vh; overflow-y: auto; }

        /* ë°°ì§€ ë° ê¸°íƒ€ */
        .tab-btn-group { display: flex; gap: 0.4rem; margin-bottom: 0.8rem; border-bottom: 1px solid #eee; padding-bottom: 0.8rem; }
        .badge { padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 3px; }
        .badge-blue { background: #e3f2fd; color: #1565c0; }
        .badge-green { background: #e8f5e9; color: #2e7d32; }
        .badge-red { background: #ffebee; color: #c62828; }
        .badge-gray { background: #f1f3f5; color: #495057; }
        .badge-warning { background: var(--warning-bg); color: var(--warning-text); }
        .badge-point { background: #fff8e1; color: #f57f17; border: 1px solid #ffecb3; }
        .badge-purple { background: #f3e5f5; color: #7b1fa2; }
        
        /* ì •ë ¬ ì•„ì´ì½˜ */
        .sort-icon { color: #999; font-size: 0.8rem; margin-left: 2px; transition: color 0.2s; }
        th[onclick]:hover { background: #f0f0f0; }
        th[onclick]:hover .sort-icon { color: var(--primary-color); }
        .password-display { font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 3px; border: 1px solid #dee2e6; color: #d63384; font-weight: bold; font-size: 0.85rem; }
        .status-card { display: flex; align-items: center; gap: 0.8rem; background: #fff; padding: 1.2rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .status-card div div:first-child { font-size: 0.85rem; }
        .status-card div div:last-child { font-size: 1.3rem; }
    </style>
</head>
<body>

    <!-- ì‚¬ì´ë“œë°” -->
    <nav class="sidebar">
        <a href="#" class="logo"><i class="ph ph-briefcase-metal"></i> Fin.Master</a>
        <ul class="nav-menu">
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link active" data-tab="dashboard" onclick="switchTab('dashboard')"><i class="ph ph-squares-four"></i> ëŒ€ì‹œë³´ë“œ</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="users" onclick="switchTab('users')"><i class="ph ph-users"></i> íšŒì› ê´€ë¦¬</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="payment" onclick="switchTab('payment')"><i class="ph ph-credit-card"></i> ê²°ì œÂ·í¬ì¸íŠ¸</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="prompts" onclick="switchTab('prompts')"><i class="ph ph-robot"></i> AI í”„ë¡¬í”„íŠ¸</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="suggestions" onclick="switchTab('suggestions')"><i class="ph ph-mailbox"></i> ì œíœ´/ê±´ì˜</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="notices" onclick="switchTab('notices')"><i class="ph ph-megaphone"></i> ê³µì§€ì‚¬í•­</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="admins" onclick="switchTab('admins')"><i class="ph ph-user-gear"></i> ê´€ë¦¬ì ê´€ë¦¬</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="terms" onclick="switchTab('terms')"><i class="ph ph-scroll"></i> ì•½ê´€ ë° ì •ì±…</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="bizinfo-cache" onclick="switchTab('bizinfo-cache')"><i class="ph ph-database"></i> ê¸°ì—…ë§ˆë‹¹ ìºì‹œ</a></li>
            <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-tab="api-usage" onclick="switchTab('api-usage')"><i class="ph ph-chart-line-up"></i> API ì‚¬ìš©í˜„í™©</a></li>
        </ul>
        <div class="admin-profile">
            <i class="ph ph-user-circle" style="font-size: 2rem;"></i>
            <div><div style="font-weight: 600;">ìµœê³ ê´€ë¦¬ì</div><div style="font-size: 0.8rem; opacity: 0.7;">Online</div></div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
        <!-- ê³ ì • ìƒë‹¨ ë°” -->
        <div class="top-bar">
            <div class="top-bar-date"><i class="ph ph-calendar"></i> <span id="topBarDate"></span></div>
            <div class="top-bar-buttons">
                <button class="btn btn-secondary" onclick="location.href='index.html'"><i class="ph ph-house"></i> ë©”ì¸</button>
                <button class="btn btn-danger" onclick="logout()"><i class="ph ph-sign-out"></i> ë¡œê·¸ì•„ì›ƒ</button>
                <a href="https://console.cloud.google.com/apis/api/generativelanguage.googleapis.com/metrics" target="_blank" class="btn btn-outline" style="color: #4285F4; border-color: #4285F4;"><i class="ph ph-google-logo"></i> API ì¡°íšŒ</a>
            </div>
        </div>

        <!-- 1. ëŒ€ì‹œë³´ë“œ -->
        <div id="dashboard" class="tab-content active">
            <div class="page-header">
                <h1 class="page-title">ëŒ€ì‹œë³´ë“œ</h1>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="status-card"><div class="status-icon" style="background: #e3f2fd; color: #1565c0;"><i class="ph ph-users"></i></div><div><div style="font-size: 0.85rem; color: #666;">ì „ì²´ íšŒì›</div><div style="font-size: 1.3rem; font-weight: 700;" id="statTotalUsers">0</div></div></div>
                <div class="status-card"><div class="status-icon" style="background: #ffebee; color: #c62828;"><i class="ph ph-warning-circle"></i></div><div><div style="font-size: 0.85rem; color: #666;">ì‹ ê·œ ì‹ ì²­ ëŒ€ê¸°</div><div style="font-size: 1.3rem; font-weight: 700; color: var(--danger-color);" id="statPending">0</div></div></div>
                <div class="status-card"><div class="status-icon" style="background: #e8f5e9; color: #2e7d32;"><i class="ph ph-credit-card"></i></div><div><div style="font-size: 0.85rem; color: #666;">ì´ë²ˆë‹¬ ê²°ì œì™„ë£Œ</div><div style="font-size: 1.3rem; font-weight: 700;">0ê±´</div></div></div>
                <div class="status-card"><div class="status-icon" style="background: #fff8e1; color: #f57f17;"><i class="ph ph-coins"></i></div><div><div style="font-size: 0.85rem; color: #666;">ì´ ë°œí–‰ í¬ì¸íŠ¸</div><div style="font-size: 1.3rem; font-weight: 700;">0 P</div></div></div>
            </div>
        </div>

        <!-- 2. íšŒì› ê´€ë¦¬ -->
        <div id="users" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">íšŒì› ê´€ë¦¬</h1>
                <div class="top-buttons">
                    <button class="btn btn-primary" onclick="openRegisterModal()"><i class="ph ph-user-plus"></i> ìˆ˜ë™ íšŒì› ë“±ë¡</button>
                </div>
            </div>

            <!-- ê°€ì… ì‹ ì²­ ë‚´ì—­ (Firebase ì—°ë™) -->
            <div class="card" style="border-left: 4px solid var(--accent-color);">
                <div class="table-controls">
                    <h3>ğŸ“ ê°€ì… ì‹ ì²­ ë‚´ì—­ (ìŠ¹ì¸ ëŒ€ê¸°) - ì‹¤ì‹œê°„ ì—°ë™</h3>
                    <div style="display:flex; gap:0.5rem;">
                        <div class="search-box"><input type="text" id="pendingSearch" placeholder="ì´ë¦„, ì§€ì—­, ì—°ë½ì²˜ ê²€ìƒ‰" onkeyup="renderUsers()"></div>
                        <button class="btn btn-success btn-sm" onclick="exportTableToExcel('pendingTable', 'ê°€ì…ì‹ ì²­ë‚´ì—­')"><i class="ph ph-file-xls"></i> ì—‘ì…€</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="pendingTable">
                        <thead>
                            <tr>
                                <th>ì‹ ì²­ì¼ì‹œ</th>
                                <th>ì„±ëª…</th>
                                <th>ì†Œì†/ì§í•¨</th>
                                <th>ì§€ì—­</th>
                                <th>ì—°ë½ì²˜</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ìœ í˜•</th>
                                <th>ê°€ì…ë¹„</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTableBody"></tbody>
                    </table>
                </div>
                <div id="pendingPagination" class="pagination"></div>
            </div>
            
            <!-- ì „ì²´ íšŒì› ëª©ë¡ -->
            <div class="card">
                <div class="table-controls">
                    <h3>ì „ì²´ íšŒì› ëª©ë¡</h3>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedUsers()"><i class="ph ph-trash"></i> ì„ íƒ ì‚­ì œ</button>
                        <div class="search-box"><input type="text" id="userSearch" placeholder="ì•„ì´ë””, ì´ë¦„ ê²€ìƒ‰" onkeyup="renderUsers()"></div>
                        <button class="btn btn-success btn-sm" onclick="exportTableToExcel('userTable', 'ì „ì²´íšŒì›ëª©ë¡')"><i class="ph ph-file-xls"></i> ì—‘ì…€</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="userTable">
                        <thead><tr><th style="width:40px;"><input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers()"></th><th>No</th><th>ì•„ì´ë””</th><th>ì„±ëª…</th><th>ë¹„ë°€ë²ˆí˜¸</th><th>ì†Œì†/ì§í•¨</th><th>ì§€ì—­</th><th>ìœ í˜•</th><th>ì—°ë½ì²˜/ë©”ì¼</th><th>ê°€ì…ë¹„</th><th>ì›” ê²°ì œì•¡</th><th>í¬ì¸íŠ¸</th><th>ë“±ë¡ì¼ì</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
                <div id="userPagination" class="pagination"></div>
            </div>
            
            <!-- íƒˆí‡´ ê´€ë¦¬ -->
            <div class="card" style="border-left: 4px solid #dc3545;">
                <div class="table-controls">
                    <h3>ğŸšª íƒˆí‡´ ìš”ì²­ íšŒì›</h3>
                    <div style="display:flex; gap:0.5rem; align-items: center;">
                        <span id="withdrawnCount" style="color: #dc3545; font-weight: 600;">0ëª…</span>
                        <button class="btn btn-success btn-sm" onclick="exportTableToExcel('withdrawnTable', 'íƒˆí‡´ìš”ì²­íšŒì›')" style="margin-left: 1rem;"><i class="ph ph-file-xls"></i> ì—‘ì…€</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="withdrawnTable">
                        <thead>
                            <tr>
                                <th>íƒˆí‡´ìš”ì²­ì¼</th>
                                <th>ì•„ì´ë””</th>
                                <th>ì„±ëª…</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ì”ì—¬í¬ì¸íŠ¸</th>
                                <th>ê°€ì…ì¼</th>
                                <th>ì²˜ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawnTableBody">
                            <tr><td colspan="7" style="text-align:center; color:#999; padding:2rem;">íƒˆí‡´ ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. ê²°ì œ ë° í¬ì¸íŠ¸ ê´€ë¦¬ -->
        <div id="payment" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">ê²°ì œ ë° í¬ì¸íŠ¸ ê´€ë¦¬</h1>
                <button class="btn btn-secondary" onclick="runBatchSimulation()"><i class="ph ph-play-circle"></i> ì •ê¸° ê²°ì œ ì¼ê´„ ì‹¤í–‰</button>
            </div>

            <div class="sub-nav">
                <div class="sub-nav-item active" onclick="switchSubTab(this, 'payment-status-view')">ê²°ì œ í˜„í™© ë° ì´ë ¥</div>
                <div class="sub-nav-item" onclick="switchSubTab(this, 'payment-points-view')">í¬ì¸íŠ¸ ì´ìš© ë‚´ì—­</div>
                <div class="sub-nav-item" onclick="switchSubTab(this, 'payment-daily-view')">ì¼ì¼ ì‚¬ìš©ëŸ‰ í˜„í™©</div>
                <div class="sub-nav-item" onclick="switchSubTab(this, 'payment-usage_analysis-view')">í¬ì¸íŠ¸ ì‚¬ìš© ë¶„ì„</div>
                <div class="sub-nav-item" onclick="switchSubTab(this, 'payment-expiration-view')">í¬ì¸íŠ¸ ì†Œë©¸ ê´€ë¦¬</div>
                <div class="sub-nav-item" onclick="switchSubTab(this, 'payment-unpaid-view')">ë¯¸ê²°ì œ/ì—°ì²´ ê´€ë¦¬</div>
            </div>

            <div id="payment-status-view" class="sub-tab-content active">
                <div class="card">
                    <div class="table-controls">
                        <h3>ğŸ’³ ì´ë²ˆë‹¬ ê²°ì œ í˜„í™©</h3>
                        <div style="display:flex; gap:0.5rem;">
                            <div class="search-box"><input type="text" id="paymentSearch" placeholder="ê²€ìƒ‰..." onkeyup="renderPaymentHistory()"></div>
                            <button class="btn btn-success btn-sm" onclick="exportTableToExcel('paymentTable', 'ê²°ì œí˜„í™©')"><i class="ph ph-file-xls"></i> ì—‘ì…€</button>
                        </div>
                    </div>
                    <div class="table-container"><table id="paymentTable"><thead><tr><th>ê²°ì œì¼ì‹œ</th><th>ì•„ì´ë””</th><th>ì„±ëª…</th><th>ê²°ì œ ê¸ˆì•¡</th><th>ìœ í˜•</th><th>ê²°ê³¼</th></tr></thead><tbody id="paymentHistoryBody"></tbody></table></div>
                    <div id="paymentPagination" class="pagination"></div>
                </div>
            </div>
            
            <div id="payment-points-view" class="sub-tab-content">
                <div class="card">
                    <div class="table-controls">
                        <h3>ğŸ“Š í¬ì¸íŠ¸ ë¡œê·¸</h3>
                        <div style="display:flex; gap:0.5rem;">
                            <div class="search-box"><input type="text" id="pointSearch" placeholder="ê²€ìƒ‰..." onkeyup="renderPointLogs()"></div>
                            <button class="btn btn-success btn-sm" onclick="exportTableToExcel('pointTable', 'í¬ì¸íŠ¸ë¡œê·¸')"><i class="ph ph-file-xls"></i> ì—‘ì…€</button>
                        </div>
                    </div>
                    <div class="table-container"><table id="pointTable"><thead><tr><th>ì¼ì‹œ</th><th>ì•„ì´ë””</th><th>ì„±ëª…</th><th>êµ¬ë¶„</th><th>ë‚´ìš©</th><th>ë³€ë™</th><th>ì”ì•¡</th></tr></thead><tbody id="pointLogsBody"></tbody></table></div>
                    <div id="pointPagination" class="pagination"></div>
                </div>
            </div>
            
            <div id="payment-daily-view" class="sub-tab-content">
                <div class="card">
                    <div class="table-controls">
                        <h3>ğŸ“… íšŒì›ë³„ ì‚¬ìš©ëŸ‰ í˜„í™©</h3>
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <input type="date" id="dailyUsageDateFilter" style="padding:0.4rem; border:1px solid #ddd; border-radius:4px;">
                            <button class="btn btn-primary btn-sm" onclick="loadDailyUsageByDate()"><i class="ph ph-magnifying-glass"></i> ì¡°íšŒ</button>
                            <button class="btn btn-sm" onclick="loadDailyUsageToday()" style="background:#6c757d;color:white;">ì˜¤ëŠ˜</button>
                            <div class="search-box"><input type="text" id="dailyUsageSearch" placeholder="ê²€ìƒ‰..." onkeyup="renderDailyUsage()"></div>
                            <button class="btn btn-success btn-sm" onclick="exportTableToExcel('dailyUsageTable', 'ì¼ì¼ì‚¬ìš©ëŸ‰')"><i class="ph ph-file-xls"></i> ì—‘ì…€</button>
                        </div>
                    </div>
                    <div class="table-container"><table id="dailyUsageTable"><thead><tr><th>ì•„ì´ë””</th><th>ì„±ëª…</th><th>ìš”ì•½ë¶„ì„ ì‚¬ìš©</th><th>ìš”ì•½ë¶„ì„ ì”ì—¬</th><th>ìƒì„¸ë¶„ì„ ì‚¬ìš©</th><th>ìƒì„¸ë¶„ì„ ì”ì—¬</th><th>ë§ˆì§€ë§‰ ì‚¬ìš©</th></tr></thead><tbody id="dailyUsageBody"></tbody></table></div>
                    <div id="dailyUsagePagination" class="pagination"></div>
                </div>
            </div>
            
            <div id="payment-usage_analysis-view" class="sub-tab-content">
                <div class="card">
                    <div class="table-controls">
                        <h3>ğŸ“ˆ í¬ì¸íŠ¸ ì‚¬ìš© ë¶„ì„</h3>
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <input type="month" id="usageStatsMonthFilter" style="padding:0.4rem; border:1px solid #ddd; border-radius:4px;">
                            <button class="btn btn-primary btn-sm" onclick="loadUsageStatsByMonth()"><i class="ph ph-magnifying-glass"></i> ì¡°íšŒ</button>
                            <button class="btn btn-sm" onclick="loadUsageStatsAll()" style="background:#6c757d;color:white;">ì „ì²´</button>
                            <button class="btn btn-success btn-sm" onclick="exportTableToExcel('usageTable', 'ì‚¬ìš©ë¶„ì„')"><i class="ph ph-file-xls"></i> ì—‘ì…€</button>
                        </div>
                    </div>
                    <div class="table-container"><table id="usageTable" style="text-align: center; table-layout: fixed; width: 100%;"><colgroup><col style="width:14%"><col style="width:8%"><col style="width:7%"><col style="width:7%"><col style="width:10%"><col style="width:7%"><col style="width:7%"><col style="width:10%"><col style="width:15%"><col style="width:15%"></colgroup><thead><tr><th rowspan="2">íšŒì›ì •ë³´</th><th rowspan="2">ëŒ€ìƒ ì›”</th><th colspan="3" style="background:#e3f2fd">ìš”ì•½ë¶„ì„(500P)</th><th colspan="3" style="background:#e8f5e9">ìƒì„¸ë¶„ì„(2000P)</th><th rowspan="2">ì´ ì°¨ê°</th><th rowspan="2">í¬ì¸íŠ¸ ì”ì•¡</th></tr><tr><th>ë¬´ë£Œ</th><th>ìœ ë£Œ</th><th>ì°¨ê°ì•¡</th><th>ë¬´ë£Œ</th><th>ìœ ë£Œ</th><th>ì°¨ê°ì•¡</th></tr></thead><tbody id="usageStatsBody"></tbody></table></div>
                </div>
            </div>
            <div id="payment-expiration-view" class="sub-tab-content"><div class="card"><p>ì†Œë©¸ ì˜ˆì • ëª©ë¡ (ì¤€ë¹„ì¤‘)</p></div></div>
            <div id="payment-unpaid-view" class="sub-tab-content"><div class="card"><p>ë¯¸ê²°ì œ íšŒì› ëª©ë¡ (ì¤€ë¹„ì¤‘)</p></div></div>
        </div>

        <!-- 4. í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ íƒ­ -->
        <div id="prompts" class="tab-content">
            <div class="page-header"><h1 class="page-title">AI í”„ë¡¬í”„íŠ¸ ê´€ë¦¬</h1></div>
            <div class="sub-nav">
                <div class="sub-nav-item active" onclick="switchSubTab(this, 'prompt-company')">ê¸°ì—…ë§ˆë‹¹</div>
                <div class="sub-nav-item" onclick="switchSubTab(this, 'prompt-ceo')">CEO Focus</div>
                <div class="sub-nav-item" onclick="switchSubTab(this, 'prompt-guarantee')">ë³´ì¥ë¶„ì„</div>
                <div class="sub-nav-item" onclick="switchSubTab(this, 'prompt-ff')">FF</div>
            </div>
            <div id="prompt-company" class="sub-tab-content active">
                <div class="card">
                    <h3>ğŸ­ ê¸°ì—…ë§ˆë‹¹</h3>
                    <div class="form-group">
                        <textarea id="promptCompanyText" class="form-control" style="min-height: 400px; font-family: monospace;" placeholder="ê¸°ì—…ë§ˆë‹¹ AI í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="savePrompt('company')"><i class="ph ph-floppy-disk"></i> ì €ì¥</button>
                </div>
            </div>
            <div id="prompt-ceo" class="sub-tab-content">
                <div class="card">
                    <h3>ğŸ‘” CEO Focus</h3>
                    <div class="form-group">
                        <textarea id="promptCeoText" class="form-control" style="min-height: 400px; font-family: monospace;" placeholder="CEO Focus AI í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="savePrompt('ceo')"><i class="ph ph-floppy-disk"></i> ì €ì¥</button>
                </div>
            </div>
            <div id="prompt-guarantee" class="sub-tab-content">
                <div class="card">
                    <h3>ğŸ›¡ï¸ ë³´ì¥ë¶„ì„</h3>
                    <div class="form-group">
                        <textarea id="promptGuaranteeText" class="form-control" style="min-height: 400px; font-family: monospace;" placeholder="ë³´ì¥ë¶„ì„ AI í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="savePrompt('guarantee')"><i class="ph ph-floppy-disk"></i> ì €ì¥</button>
                </div>
            </div>
            <div id="prompt-ff" class="sub-tab-content">
                <div class="card">
                    <h3>ğŸ“Š FF (Fact Finding)</h3>
                    <div class="form-group">
                        <textarea id="promptFfText" class="form-control" style="min-height: 400px; font-family: monospace;" placeholder="FF AI í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="savePrompt('ff')"><i class="ph ph-floppy-disk"></i> ì €ì¥</button>
                </div>
            </div>
        </div>

        <!-- 5. ì œíœ´/ê±´ì˜ -->
        <div id="suggestions" class="tab-content">
            <div class="page-header"><h1 class="page-title">ì œíœ´ / ê±´ì˜</h1></div>
            <div class="card">
                <div class="table-controls">
                    <h3>ëª©ë¡</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="suggestionStatusFilter" onchange="renderSuggestions()" style="padding: 0.4rem 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="ëŒ€ê¸°">ëŒ€ê¸°</option>
                            <option value="ê²€í† ì¤‘">ê²€í† ì¤‘</option>
                            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                        </select>
                        <button class="btn btn-success btn-sm" onclick="exportTableToExcel('suggestTable', 'ì œíœ´ê±´ì˜')">ì—‘ì…€</button>
                    </div>
                </div>
                <div class="table-container"><table id="suggestTable"><thead><tr><th>No</th><th>ìœ í˜•</th><th>ì œëª©</th><th>ì„±ëª…</th><th>íšŒì‚¬ëª…</th><th>ì—°ë½ì²˜</th><th>ì‘ì„±ì¼</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="suggestionTableBody"></tbody></table></div>
                <div id="suggestionPagination" class="pagination"></div>
            </div>
        </div>

        <!-- 6. ê³µì§€ì‚¬í•­ -->
        <div id="notices" class="tab-content">
            <div class="page-header"><h1 class="page-title">ê³µì§€ì‚¬í•­ ê´€ë¦¬</h1><button class="btn btn-primary" onclick="openNoticeModal()"><i class="ph ph-plus"></i> ìƒˆ ê³µì§€ ë“±ë¡</button></div>
            <div class="card">
                <div class="table-controls"><h3>ë“±ë¡ëœ ê³µì§€ì‚¬í•­</h3><div class="search-box"><input type="text" id="noticeSearch" placeholder="ì œëª© ê²€ìƒ‰" onkeyup="renderNotices()"></div></div>
                <div class="table-container"><table id="noticeTable"><thead><tr><th style="width: 50px;">No</th><th>ì œëª©</th><th>ë“±ë¡ì¼ì</th><th>ì²¨ë¶€íŒŒì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody id="noticeTableBody"></tbody></table></div>
                <div id="noticePagination" class="pagination"></div>
            </div>
        </div>

        <!-- 7. ê´€ë¦¬ì ê´€ë¦¬ -->
        <div id="admins" class="tab-content">
            <div class="page-header"><h1 class="page-title">ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</h1><button class="btn btn-primary" onclick="openAdminModal()"><i class="ph ph-plus"></i> ì¶”ê°€</button></div>
            <div class="card">
                <p style="margin-bottom:1rem; color:#666; font-size:0.9rem;">âš ï¸ ê´€ë¦¬ì ê³„ì •ì€ ëª¨ë“  í”„ë¡œê·¸ë¨ì„ ë¬´ë£Œ/ë¬´ì œí•œìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬´ë£Œì‚¬ìš©ìëŠ” ìœ íš¨ê¸°ê°„ ë‚´ ë¬´ì œí•œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                <div class="table-container"><table><thead><tr><th>ì•„ì´ë””</th><th>ì´ë¦„</th><th>ê¶Œí•œ</th><th>ìœ íš¨ê¸°ê°„</th><th>ë¹„ë°€ë²ˆí˜¸</th><th style="width:120px;">ê´€ë¦¬</th></tr></thead><tbody id="adminTableBody"></tbody></table></div>
            </div>
        </div>

        <!-- 8. ì•½ê´€ -->
        <div id="terms" class="tab-content">
            <div class="page-header"><h1 class="page-title">ì•½ê´€ ë° ì •ì±… ê´€ë¦¬</h1></div>
            <div class="card">
                <div class="tab-btn-group"><button class="btn btn-primary active" id="btn-term-service" onclick="loadTerm('service')">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</button><button class="btn btn-outline" id="btn-term-privacy" onclick="loadTerm('privacy')">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</button><button class="btn btn-outline" id="btn-term-marketing" onclick="loadTerm('marketing')">ë§ˆì¼€íŒ… ìˆ˜ì‹ ë™ì˜</button><button class="btn btn-outline" id="btn-term-guide" onclick="loadTerm('usageGuide')">ì´ìš©ê°€ì´ë“œ</button></div>
                <div class="form-group"><textarea class="form-control" id="termEditor" style="min-height: 500px; font-family: monospace; line-height: 1.6;"></textarea></div>
                <button class="btn btn-primary" onclick="saveTerms()">ì €ì¥</button>
            </div>
            
            <!-- ì˜ìƒìë£Œì‹¤ ê´€ë¦¬ -->
            <div class="card" style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="ph ph-video"></i> ì˜ìƒìë£Œì‹¤ ê´€ë¦¬</h3>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">ì‚¬ìš©ì ë©”ì¸í™”ë©´ì˜ 'ì˜ìƒìë£Œì‹¤' ë²„íŠ¼ í´ë¦­ ì‹œ í‘œì‹œë  ì˜ìƒ ë§í¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                
                <div id="videoLinksContainer" style="margin-bottom: 1rem;"></div>
                
                <button class="btn btn-outline" onclick="addVideoLink()" style="margin-bottom: 1rem;"><i class="ph ph-plus"></i> ì˜ìƒ ì¶”ê°€</button>
                <button class="btn btn-primary" onclick="saveVideoLinks()">ì˜ìƒìë£Œ ì €ì¥</button>
            </div>
        </div>

        <!-- ê¸°ì—…ë§ˆë‹¹ ìºì‹œ ê´€ë¦¬ -->
        <div id="bizinfo-cache" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">ê¸°ì—…ë§ˆë‹¹ ìºì‹œ ê´€ë¦¬</h1>
                <div class="top-buttons">
                    <button class="btn btn-outline" onclick="refreshCacheStatus()"><i class="ph ph-arrows-clockwise"></i> ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
            
            <!-- ìºì‹œ ìƒíƒœ ì¹´ë“œ -->
            <div class="card">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="ph ph-chart-bar"></i> ìºì‹œ í˜„í™©</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: #e8f5e9; padding: 1.2rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #27ae60;" id="cache-total-count">-</div>
                        <div style="font-size: 0.85rem; color: #666;">ì €ì¥ëœ ê³µê³  ìˆ˜</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 1.2rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1rem; font-weight: 600; color: #1976d2;" id="cache-last-updated">-</div>
                        <div style="font-size: 0.85rem; color: #666;">ë§ˆì§€ë§‰ ìˆ˜ì§‘ ì‹œê°„</div>
                    </div>
                    <div style="background: #fff3e0; padding: 1.2rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1rem; font-weight: 600; color: #f57c00;" id="cache-triggered-by">-</div>
                        <div style="font-size: 0.85rem; color: #666;">ìˆ˜ì§‘ ë°©ì‹</div>
                    </div>
                </div>
            </div>
            
            <!-- ì•¡ì…˜ ë²„íŠ¼ ì¹´ë“œ -->
            <div class="card">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="ph ph-gear"></i> ìºì‹œ ê´€ë¦¬</h3>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="manualFetchBizinfo()" id="btn-manual-fetch">
                        <i class="ph ph-cloud-arrow-down"></i> ìˆ˜ë™ ìˆ˜ì§‘ ì‹¤í–‰
                    </button>
                    <button class="btn btn-success" onclick="downloadCacheExcel()" id="btn-download-excel" style="background: #27ae60;">
                        <i class="ph ph-microsoft-excel-logo"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button class="btn" onclick="deleteClosedPrograms()" id="btn-delete-closed" style="background: #fd7e14; color: white;">
                        <i class="ph ph-trash"></i> ë§ˆê° ê³µê³  ì‚­ì œ
                    </button>
                    <button class="btn" onclick="deleteAllPrograms()" id="btn-delete-all" style="background: #e74c3c; color: white;">
                        <i class="ph ph-trash"></i> ì „ì²´ ê³µê³  ì‚­ì œ
                    </button>
                </div>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                    <i class="ph ph-info"></i> ìë™ ìˆ˜ì§‘ì€ 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ë©ë‹ˆë‹¤. ìˆ˜ë™ ìˆ˜ì§‘ì€ ì¦‰ì‹œ ê¸°ì—…ë§ˆë‹¹ì—ì„œ ìµœì‹  ê³µê³ ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                </p>
            </div>
            
            <!-- ìˆ˜ì§‘ ë¡œê·¸ -->
            <div class="card">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="ph ph-list-bullets"></i> ìµœê·¼ ì‘ì—… ë¡œê·¸</h3>
                <div id="cache-log" style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.85rem; max-height: 150px; overflow-y: auto;">
                    <div style="color: #666;">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ìˆ˜ì§‘ì„ ì‹¤í–‰í•´ë³´ì„¸ìš”.</div>
                </div>
            </div>
            
            <!-- ê³µê³  ëª©ë¡ -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; flex-wrap: wrap; gap: 0.5rem;">
                    <h3 style="color: var(--primary-color); margin: 0;"><i class="ph ph-list-dashes"></i> ê³µê³  ëª©ë¡</h3>
                    <button class="btn btn-outline" onclick="loadCachePrograms()" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;"><i class="ph ph-arrows-clockwise"></i> ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                
                <!-- ê²€ìƒ‰ í•„í„° ì˜ì—­ -->
                <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                        <input type="text" id="cache-search" placeholder="ğŸ” í†µí•©ê²€ìƒ‰ (ê³µê³ ëª…, ê¸°ê´€, ë‚´ìš©)" oninput="filterCachePrograms()" style="padding: 0.4rem 0.8rem; border-radius: 4px; border: 1px solid #ddd; font-size: 0.85rem; flex: 1; min-width: 200px;">
                        <select id="cache-category-filter" onchange="filterCachePrograms()" style="padding: 0.4rem; border-radius: 4px; border: 1px solid #ddd; font-size: 0.85rem;">
                            <option value="">ì „ì²´ ë¶„ì•¼</option>
                        </select>
                        <select id="cache-org-filter" onchange="filterCachePrograms()" style="padding: 0.4rem; border-radius: 4px; border: 1px solid #ddd; font-size: 0.85rem;">
                            <option value="">ì „ì²´ ê¸°ê´€</option>
                        </select>
                        <select id="cache-status-filter" onchange="filterCachePrograms()" style="padding: 0.4rem; border-radius: 4px; border: 1px solid #ddd; font-size: 0.85rem;">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="open">ì ‘ìˆ˜ì¤‘</option>
                            <option value="closed">ë§ˆê°</option>
                        </select>
                        <button class="btn btn-outline" onclick="resetCacheFilters()" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">ì´ˆê¸°í™”</button>
                    </div>
                    <div id="cache-filter-info" style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;"></div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="cache-programs-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">No</th>
                                <th style="min-width: 250px;">ê³µê³ ëª…</th>
                                <th style="width: 120px; cursor: pointer;" onclick="sortCachePrograms('organization')">ì£¼ê´€ê¸°ê´€ <span id="sort-organization" class="sort-icon">â†•</span></th>
                                <th style="width: 120px; cursor: pointer;" onclick="sortCachePrograms('executor')">ìˆ˜í–‰ê¸°ê´€ <span id="sort-executor" class="sort-icon">â†•</span></th>
                                <th style="width: 80px; cursor: pointer;" onclick="sortCachePrograms('category')">ì§€ì›ë¶„ì•¼ <span id="sort-category" class="sort-icon">â†•</span></th>
                                <th style="width: 130px; cursor: pointer;" onclick="sortCachePrograms('applicationPeriod')">ì‹ ì²­ê¸°ê°„ <span id="sort-applicationPeriod" class="sort-icon">â†•</span></th>
                                <th style="width: 90px; cursor: pointer;" onclick="sortCachePrograms('registeredDate')">ë“±ë¡ì¼ <span id="sort-registeredDate" class="sort-icon">â†•</span></th>
                                <th style="width: 50px;">ğŸ“„</th>
                                <th style="width: 70px; cursor: pointer;" onclick="sortCachePrograms('isOpen')">ìƒíƒœ <span id="sort-isOpen" class="sort-icon">â†•</span></th>
                            </tr>
                        </thead>
                        <tbody id="cache-programs-tbody">
                            <tr><td colspan="9" style="text-align: center; color: #999; padding: 2rem;">ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ìœ„ì˜ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="cache-pagination" style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; align-items: center;"></div>
            </div>
        </div>

        <!-- 10. API ì‚¬ìš©í˜„í™© íƒ­ -->
        <div id="api-usage" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">API ì‚¬ìš©í˜„í™© (ì •ë¶€ì§€ì›ìê¸ˆ)</h1>
                <div class="top-buttons">
                    <button class="btn btn-outline" onclick="loadApiUsage()"><i class="ph ph-arrows-clockwise"></i> ìƒˆë¡œê³ ì¹¨</button>
                    <button class="btn btn-success" onclick="exportApiUsageToExcel()" style="background: #27ae60;"><i class="ph ph-microsoft-excel-logo"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>
            
            <!-- ì˜¤ëŠ˜ ë‚ ì§œ ë° ìš”ì•½ -->
            <div class="card">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="ph ph-calendar-check"></i> ì˜¤ëŠ˜ì˜ ì‚¬ìš© í˜„í™©</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                    <div style="background: #e3f2fd; padding: 1.2rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">ì¡°íšŒ ê¸°ì¤€ì¼</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: #1976d2;" id="usage-date">-</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 1.2rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">ì˜¤ëŠ˜ ì‚¬ìš© íšŒì›</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #27ae60;" id="usage-user-count">-</div>
                    </div>
                    <div style="background: #fff3e0; padding: 1.2rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">ìš”ì•½ë¶„ì„ ì´ íšŸìˆ˜</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #f57c00;" id="usage-summary-total">-</div>
                    </div>
                    <div style="background: #fce4ec; padding: 1.2rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">ìƒì„¸ë¶„ì„ ì´ íšŸìˆ˜</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #e91e63;" id="usage-detail-total">-</div>
                    </div>
                </div>
            </div>
            
            <!-- ë‚ ì§œ ì„ íƒ -->
            <div class="card">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="ph ph-funnel"></i> ì¡°íšŒ ì¡°ê±´</h3>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.85rem;">ì¡°íšŒ ë‚ ì§œ</label>
                        <input type="date" id="usage-date-filter" class="form-control" style="width: 180px;">
                    </div>
                    <button class="btn btn-primary" onclick="loadApiUsageByDate()"><i class="ph ph-magnifying-glass"></i> ì¡°íšŒ</button>
                    <button class="btn btn-outline" onclick="loadApiUsage()">ì˜¤ëŠ˜ ë³´ê¸°</button>
                </div>
            </div>
            
            <!-- íšŒì›ë³„ ì‚¬ìš© í˜„í™© í…Œì´ë¸” -->
            <div class="card">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="ph ph-users"></i> íšŒì›ë³„ ì‚¬ìš© í˜„í™©</h3>
                <div class="table-container">
                    <table id="apiUsageTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">No</th>
                                <th>íšŒì›ëª…</th>
                                <th>ì´ë©”ì¼ (ID)</th>
                                <th style="width: 100px;">ìš”ì•½ë¶„ì„</th>
                                <th style="width: 100px;">ìƒì„¸ë¶„ì„</th>
                                <th style="width: 100px;">í•©ê³„</th>
                                <th style="width: 80px;">ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="apiUsageBody">
                            <tr><td colspan="7" style="text-align: center; color: #999; padding: 2rem;">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ëª¨ë‹¬: ê³µê³  ìƒì„¸ë³´ê¸° -->
    <div id="programDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: var(--primary-color);"><i class="ph ph-file-text"></i> ê³µê³  ìƒì„¸ì •ë³´</h3>
                <button onclick="document.getElementById('programDetailModal').style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
            </div>
            <div id="programDetailContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>
            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button class="btn btn-outline" onclick="document.getElementById('programDetailModal').style.display='none'">ë‹«ê¸°</button>
                <a id="programDetailLink" href="#" target="_blank" class="btn btn-primary"><i class="ph ph-arrow-square-out"></i> ìƒì„¸í˜ì´ì§€ ë°”ë¡œê°€ê¸°</a>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ID ë°œê¸‰ ë° ê°€ì… ìŠ¹ì¸ (ìˆ˜ì •ë¨) -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ‘¥ íšŒì› ìŠ¹ì¸ ë° ID ë°œê¸‰</h3>
            <p style="font-size:0.9rem; color:#666; margin-bottom:1rem;">ì‹ ì²­ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ID/ë¹„ë°€ë²ˆí˜¸ ë° ê¶Œí•œì„ ì„¤ì •í•˜ì„¸ìš”.</p>
            <form id="registerForm">
                <!-- ì‹ ì²­ ì •ë³´ (Read-Only: ë ˆì´ì•„ì›ƒ ë™ê¸°í™”) -->
                <div style="background:#f8f9fa; padding:1rem; border-radius:6px; margin-bottom:1rem; border:1px solid #eee;">
                    <h4 style="margin-bottom:0.5rem; font-size:0.9rem; color:var(--primary-color);">[ì‹ ì²­ì ì •ë³´]</h4>
                    <div class="form-row">
                        <div class="form-group"><label>ì„±ëª…</label><input type="text" id="newUserName" class="form-control" readonly style="background:white"></div>
                        <div class="form-group"><label>ì†Œì†ì‚¬</label><input type="text" id="newUserCompany" class="form-control" readonly style="background:white"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ì§í•¨</label><input type="text" id="newUserTitle" class="form-control" readonly style="background:white"></div>
                        <div class="form-group"><label>ì§€ì—­</label><input type="text" id="newUserRegion" class="form-control" readonly style="background:white"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ì—°ë½ì²˜</label><input type="text" id="newUserPhone" class="form-control" readonly style="background:white"></div>
                        <div class="form-group"><label>ì´ë©”ì¼</label><input type="text" id="newUserEmail" class="form-control" readonly style="background:white"></div>
                    </div>
                </div>

                <!-- ê´€ë¦¬ì ì„¤ì • -->
                <div style="padding:1rem; border:1px solid #dee2e6; border-radius:6px;">
                    <h4 style="margin-bottom:0.5rem; font-size:0.9rem; color:var(--accent-color);">[ê´€ë¦¬ì ì„¤ì •]</h4>
                    <div class="form-row"><div class="form-group"><label>ì•„ì´ë”” (ìƒì„±)</label><input type="text" id="newUserId" class="form-control" placeholder="ì˜ˆ: FP2025001" required></div><div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label><input type="text" id="newUserPw" class="form-control" value="123456" required minlength="6"></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>íšŒì› ìœ í˜•</label><select id="newUserType" class="form-control"><option value="inner">ì´ë„ˆ</option><option value="branch">ì§€ì‚¬ì¥</option><option value="consultant_home">ì»¨í™ˆ</option><option value="non_member">ë¹„íšŒì›</option><option value="freeuser">ë¬´ë£Œì‚¬ìš©ì (API ë¬´ì œí•œ)</option></select></div>
                        <div class="form-group"><label>ê°€ì…ë¹„</label><select id="regFeeStatus" class="form-control"><option value="unpaid" selected style="color:red;">ë¯¸ì…ê¸ˆ</option><option value="paid" style="color:green;">ì…ê¸ˆì™„ë£Œ</option></select></div>
                    </div>
                    <div class="form-group"><label>ì›” ê²°ì œì•¡</label><input type="number" id="newUserFee" class="form-control" value="10000"></div>
                </div>
                <div class="flex-between" style="margin-top:1rem;"><button type="button" class="btn btn-outline" onclick="document.getElementById('registerModal').style.display='none'">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ìŠ¹ì¸ ë° ìƒì„±</button></div>
            </form>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ê³µì§€ì‚¬í•­ ë“±ë¡/ìˆ˜ì • -->
    <div id="noticeModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="noticeModalTitle">ğŸ“¢ ìƒˆ ê³µì§€ ë“±ë¡</h3>
            <form id="noticeForm">
                <input type="hidden" id="noticeDocId">
                <div class="form-group">
                    <label>ì œëª© *</label>
                    <input type="text" id="noticeTitle" class="form-control" placeholder="ê³µì§€ì‚¬í•­ ì œëª©" required>
                </div>
                <div class="form-group">
                    <label>ë‚´ìš© *</label>
                    <textarea id="noticeContent" class="form-control" style="min-height: 200px;" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                </div>
                <div class="form-group">
                    <label>ì²¨ë¶€íŒŒì¼ URL (ì„ íƒ)</label>
                    <input type="text" id="noticeFileUrl" class="form-control" placeholder="https://...">
                </div>
                <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeNoticeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary"><i class="ph ph-floppy-disk"></i> ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ê´€ë¦¬ì ì¶”ê°€ -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>ğŸ” ê´€ë¦¬ì/ë¬´ë£Œì‚¬ìš©ì ì¶”ê°€</h3>
            <p style="font-size:0.85rem; color:#666; margin-bottom:1rem;">ê´€ë¦¬ìëŠ” ëª¨ë“  ê¸°ëŠ¥ ì‚¬ìš©, ë¬´ë£Œì‚¬ìš©ìëŠ” <b style="color:#27ae60;">1ì¼ ì œí•œ ì„¤ì • ê°€ëŠ¥</b></p>
            <form id="adminForm">
                <div class="form-group">
                    <label>ì•„ì´ë”” *</label>
                    <input type="text" id="adminUserId" class="form-control" placeholder="ì•„ì´ë”” ì…ë ¥" required>
                </div>
                <div class="form-group">
                    <label>ì´ë¦„ *</label>
                    <input type="text" id="adminUserName" class="form-control" placeholder="ì´ë¦„ ì…ë ¥" required>
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸ * (6ì ì´ìƒ)</label>
                    <input type="text" id="adminUserPw" class="form-control" value="admin123" required minlength="6">
                </div>
                <div class="form-group">
                    <label>ê¶Œí•œ *</label>
                    <select id="adminRole" class="form-control" onchange="toggleExpireDateField()">
                        <option value="super_admin">ìµœê³ ê´€ë¦¬ì (ëª¨ë“  ê¶Œí•œ + ë¬´ì œí•œ)</option>
                        <option value="admin">ì¼ë°˜ê´€ë¦¬ì (ê´€ë¦¬ ê¶Œí•œ + ë¬´ì œí•œ)</option>
                        <option value="freeuser">ë¬´ë£Œì‚¬ìš©ì (1ì¼ ì œí•œ ì„¤ì •)</option>
                    </select>
                </div>
                <div class="form-group" id="expireDateGroup" style="display: none;">
                    <label>ìœ íš¨ê¸°ê°„</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="date" id="adminExpireDate" class="form-control" style="flex: 1;">
                        <label style="display: flex; align-items: center; gap: 0.3rem; margin: 0; cursor: pointer;">
                            <input type="checkbox" id="adminNoExpire" onchange="toggleExpireDateInput()"> ë¬´ì œí•œ
                        </label>
                    </div>
                    <small style="color: #888; margin-top: 0.3rem; display: block;">ìœ íš¨ê¸°ê°„ì´ ì§€ë‚˜ë©´ ì¼ë°˜ íšŒì›ì²˜ëŸ¼ 10íšŒ/ì¼ ì œí•œì´ ì ìš©ë©ë‹ˆë‹¤.</small>
                </div>
                <!-- â˜… 1ì¼ ì‚¬ìš© ì œí•œ ì„¤ì • (ë¬´ë£Œì‚¬ìš©ììš©) -->
                <div class="form-group" id="dailyLimitGroup" style="display: none;">
                    <label>1ì¼ ì‚¬ìš© ì œí•œ</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <div style="flex: 1;">
                            <small style="color: #666;">ìš”ì•½ë¶„ì„</small>
                            <input type="number" id="adminSummaryLimit" class="form-control" placeholder="ë¬´ì œí•œ" min="0" max="999" style="margin-top: 0.2rem;">
                        </div>
                        <div style="flex: 1;">
                            <small style="color: #666;">ìƒì„¸ë¶„ì„</small>
                            <input type="number" id="adminDetailLimit" class="form-control" placeholder="ë¬´ì œí•œ" min="0" max="999" style="margin-top: 0.2rem;">
                        </div>
                    </div>
                    <small style="color: #888; margin-top: 0.3rem; display: block;">ë¹„ì›Œë‘ë©´ ë¬´ì œí•œ, ìˆ«ì ì…ë ¥ ì‹œ í•´ë‹¹ íšŸìˆ˜ë¡œ 1ì¼ ì œí•œ</small>
                </div>
                <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeAdminModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary"><i class="ph ph-user-plus"></i> ìƒì„±</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ê´€ë¦¬ì/ë¬´ë£Œì‚¬ìš©ì ìˆ˜ì • -->
    <div id="adminEditModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>âœï¸ ê´€ë¦¬ì/ë¬´ë£Œì‚¬ìš©ì ìˆ˜ì •</h3>
            <form id="adminEditForm" onsubmit="saveAdminEdit(event)">
                <input type="hidden" id="editAdminDocId">
                <div class="form-group">
                    <label>ì•„ì´ë””</label>
                    <input type="text" id="editAdminUserId" class="form-control" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>ì´ë¦„ *</label>
                    <input type="text" id="editAdminName" class="form-control" placeholder="ì´ë¦„ ì…ë ¥" required>
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                    <input type="text" id="editAdminPassword" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    <small style="color: #888;">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‘œì‹œë©ë‹ˆë‹¤. ìˆ˜ì • ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</small>
                </div>
                <div class="form-group">
                    <label>ê¶Œí•œ *</label>
                    <select id="editAdminRole" class="form-control" onchange="toggleEditExpireDateField()">
                        <option value="super_admin">ìµœê³ ê´€ë¦¬ì</option>
                        <option value="admin">ì¼ë°˜ê´€ë¦¬ì</option>
                        <option value="freeuser">ë¬´ë£Œì‚¬ìš©ì</option>
                    </select>
                </div>
                <div class="form-group" id="editExpireDateGroup" style="display: none;">
                    <label>ìœ íš¨ê¸°ê°„</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="date" id="editAdminExpireDate" class="form-control" style="flex: 1;">
                        <label style="display: flex; align-items: center; gap: 0.3rem; margin: 0; cursor: pointer;">
                            <input type="checkbox" id="editAdminNoExpire" onchange="toggleEditExpireDateInput()"> ë¬´ì œí•œ
                        </label>
                    </div>
                    <small style="color: #888; margin-top: 0.3rem; display: block;">ë¬´ë£Œì‚¬ìš©ì: ìœ íš¨ê¸°ê°„ì´ ì§€ë‚˜ë©´ 10íšŒ/ì¼ ì œí•œ ì ìš©</small>
                </div>
                <!-- â˜… 1ì¼ ì‚¬ìš© ì œí•œ ì„¤ì • (ë¬´ë£Œì‚¬ìš©ììš©) -->
                <div class="form-group" id="editDailyLimitGroup" style="display: none;">
                    <label>1ì¼ ì‚¬ìš© ì œí•œ</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <div style="flex: 1;">
                            <small style="color: #666;">ìš”ì•½ë¶„ì„</small>
                            <input type="number" id="editAdminSummaryLimit" class="form-control" placeholder="ë¬´ì œí•œ" min="0" max="999" style="margin-top: 0.2rem;">
                        </div>
                        <div style="flex: 1;">
                            <small style="color: #666;">ìƒì„¸ë¶„ì„</small>
                            <input type="number" id="editAdminDetailLimit" class="form-control" placeholder="ë¬´ì œí•œ" min="0" max="999" style="margin-top: 0.2rem;">
                        </div>
                    </div>
                    <small style="color: #888; margin-top: 0.3rem; display: block;">ë¹„ì›Œë‘ë©´ ë¬´ì œí•œ, ìˆ«ì ì…ë ¥ ì‹œ í•´ë‹¹ íšŸìˆ˜ë¡œ 1ì¼ ì œí•œ</small>
                </div>
                <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeAdminEditModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary"><i class="ph ph-floppy-disk"></i> ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ì•Œë¦¼/ìƒì„¸ë³´ê¸° -->
    <div id="alertModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="alertModalTitle" style="margin: 0;"></h3>
                <button onclick="closeAlertModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div id="alertModalBody"></div>
        </div>
    </div>

    <!-- â˜… íšŒì› ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="userEditModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3><i class="ph ph-user-gear"></i> íšŒì› ì •ë³´ ìˆ˜ì •</h3>
            <form id="userEditForm">
                <input type="hidden" id="editUserId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- ì™¼ìª½ ì»¬ëŸ¼ -->
                    <div>
                        <div class="form-group">
                            <label>ì•„ì´ë””</label>
                            <input type="text" id="editUserLoginId" class="form-control" readonly style="background:#f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label>ì´ë¦„ *</label>
                            <input type="text" id="editUserName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <div style="display:flex; gap:0.5rem;">
                                <input type="text" id="editUserPassword" class="form-control" placeholder="ë³€ê²½ ì‹œ ì…ë ¥ (6ì ì´ìƒ)">
                                <button type="button" class="btn btn-sm btn-outline" onclick="resetEditPassword()">ì´ˆê¸°í™”</button>
                            </div>
                            <small style="color:#888;">ë¹„ì›Œë‘ë©´ ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ìœ ì§€</small>
                        </div>
                        <div class="form-group">
                            <label>ì—°ë½ì²˜</label>
                            <input type="text" id="editUserPhone" class="form-control" placeholder="010-0000-0000">
                        </div>
                        <div class="form-group">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" id="editUserEmail" class="form-control" placeholder="email@example.com">
                        </div>
                    </div>
                    
                    <!-- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼ -->
                    <div>
                        <div class="form-group">
                            <label>ì†Œì†</label>
                            <input type="text" id="editUserCompany" class="form-control" placeholder="íšŒì‚¬/ì†Œì†">
                        </div>
                        <div class="form-group">
                            <label>ì§í•¨</label>
                            <input type="text" id="editUserJobTitle" class="form-control" placeholder="ì§í•¨/ì§ì±…">
                        </div>
                        <div class="form-group">
                            <label>ì§€ì—­</label>
                            <select id="editUserRegion" class="form-control">
                                <option value="">ì„ íƒ</option>
                                <option value="ì„œìš¸">ì„œìš¸</option>
                                <option value="ê²½ê¸°">ê²½ê¸°</option>
                                <option value="ì¸ì²œ">ì¸ì²œ</option>
                                <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                                <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                                <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                                <option value="ëŒ€ì „">ëŒ€ì „</option>
                                <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                                <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                                <option value="ê°•ì›">ê°•ì›</option>
                                <option value="ì¶©ë¶">ì¶©ë¶</option>
                                <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                                <option value="ì „ë¶">ì „ë¶</option>
                                <option value="ì „ë‚¨">ì „ë‚¨</option>
                                <option value="ê²½ë¶">ê²½ë¶</option>
                                <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                                <option value="ì œì£¼">ì œì£¼</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>íšŒì› ìœ í˜•</label>
                            <select id="editUserType" class="form-control">
                                <option value="ì§€ì‚¬">ì§€ì‚¬</option>
                                <option value="ì´ë„ˆ">ì´ë„ˆ</option>
                                <option value="ì»¨í™ˆ">ì»¨í™ˆ</option>
                                <option value="ë¹„íšŒì›">ë¹„íšŒì›</option>
                                <option value="ë¬´ë£Œì‚¬ìš©ì">ë¬´ë£Œì‚¬ìš©ì (API ë¬´ì œí•œ)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ìƒíƒœ</label>
                            <select id="editUserStatus" class="form-control">
                                <option value="active">í™œì„±</option>
                                <option value="inactive">ë¹„í™œì„±</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- í•˜ë‹¨ ê²°ì œ ì •ë³´ -->
                <div style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                    <h4 style="font-size: 0.95rem; margin-bottom: 0.8rem;"><i class="ph ph-credit-card"></i> ê²°ì œ ì •ë³´</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>ê°€ì…ë¹„ ìƒíƒœ</label>
                            <select id="editRegFeeStatus" class="form-control">
                                <option value="unpaid">ë¯¸ë‚©</option>
                                <option value="paid">ë‚©ë¶€</option>
                                <option value="exempt">ë©´ì œ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì›” ê²°ì œì•¡</label>
                            <input type="number" id="editMonthlyFee" class="form-control" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>ë³´ìœ  í¬ì¸íŠ¸</label>
                            <input type="number" id="editPoints" class="form-control" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1.5rem;">
                    <button type="button" class="btn btn-danger" onclick="deleteUserFromModal()" style="margin-right:auto;"><i class="ph ph-trash"></i> ì‚­ì œ</button>
                    <button type="button" class="btn btn-outline" onclick="closeUserEditModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary"><i class="ph ph-floppy-disk"></i> ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <script>
        // --- 1. Firebase ì´ˆê¸°í™” ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
            authDomain: "kfpc-company-support-project.firebaseapp.com",
            databaseURL: "https://kfpc-company-support-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kfpc-company-support-project",
            storageBucket: "kfpc-company-support-project.firebasestorage.app",
            messagingSenderId: "101260933373",
            appId: "1:101260933373:web:3436176f9ca2560056d914"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const functions = firebase.app().functions('asia-northeast3');  // â˜… Cloud Functions ì´ˆê¸°í™” (region ì§€ì •)
        const ADMIN_SECRET = 'finmaster-admin-2024';  // â˜… ê´€ë¦¬ì ë¹„ë°€í‚¤

        // --- 2. ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ---
        function exportTableToExcel(tableId, filename = '') {
            const table = document.getElementById(tableId);
            const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
            XLSX.writeFile(wb, filename ? `${filename}.xlsx` : 'data.xlsx');
        }

        // --- 3. ë„¤ë¹„ê²Œì´ì…˜ ë° ê³µí†µ ---
        function logout() { 
            localStorage.removeItem('adminLoggedIn');
            alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
            location.href='login.html'; 
        }

        function switchTab(tabId) {
            try {
                console.log('switchTab í˜¸ì¶œ:', tabId);
                // ëª¨ë“  nav-linkì—ì„œ active ì œê±°
                document.querySelectorAll('.nav-menu .nav-link').forEach(el => el.classList.remove('active'));
                // ëª¨ë“  tab-contentì—ì„œ active ì œê±°
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                // í´ë¦­í•œ ë©”ë‰´ì— active ì¶”ê°€
                const clickedLink = document.querySelector('.nav-link[data-tab="' + tabId + '"]');
                if (clickedLink) clickedLink.classList.add('active');
                // í•´ë‹¹ íƒ­ ì½˜í…ì¸  í‘œì‹œ
                const tabContent = document.getElementById(tabId);
                if (tabContent) tabContent.classList.add('active');
                
                // ê¸°ì—…ë§ˆë‹¹ ìºì‹œ íƒ­ ì§„ì… ì‹œ ìë™ ìƒíƒœ ì¡°íšŒ
                if (tabId === 'bizinfo-cache') {
                    refreshCacheStatus();
                }
            } catch(e) {
                console.error('switchTab ì˜¤ë¥˜:', e);
            }
        }
        function switchSubTab(element, viewId) {
            element.parentElement.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            element.parentElement.parentElement.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        // --- 4. ë°ì´í„° ë¡œì§ (Firebase ì—°ë™) ---
        let pendingApps = [];
        let users = [];
        // (ê²°ì œ/ë¡œê·¸ ë“±ì€ ì•„ì§ ë”ë¯¸ ìœ ì§€ - í•„ìš” ì‹œ DB ì—°ê²° ê°€ëŠ¥)
        let payments = [];
        let pointLogs = [];
        let dailyUsages = [];
        
        // â˜… ê´€ë¦¬ì ì¸ì¦ ì²´í¬ ë° Firebase ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
        function checkAdminAndInitialize() {
            try {
                // 1. localStorage ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
                if (localStorage.getItem('adminLoggedIn') !== 'true') {
                    alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    location.href = 'login.html';
                    return;
                }
                
                console.log('âœ… ê´€ë¦¬ì ì¸ì¦ í™•ì¸ë¨');
                
                // 2. Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                initializeFirebaseListeners();
            } catch(e) {
                console.error('checkAdminAndInitialize ì˜¤ë¥˜:', e);
            }
        }
        
        function initializeFirebaseListeners() {
            try {
                // [ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ] ê°€ì… ì‹ ì²­ ë‚´ì—­ (account_requests)
                db.collection('account_requests').orderBy('requestedAt', 'desc').onSnapshot((snapshot) => {
                    pendingApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsers();
                    const statPending = document.getElementById('statPending');
                    if (statPending) statPending.innerText = pendingApps.length;
                }, (error) => {
                    console.error('account_requests ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                });

                // [ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ] íšŒì› ëª©ë¡ (users)
                db.collection('users').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                    users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsers();
                    const statTotalUsers = document.getElementById('statTotalUsers');
                    if (statTotalUsers) statTotalUsers.innerText = users.length;
                }, (error) => {
                    console.error('users ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                });
                
                // â˜… ì¶”ê°€ ë¦¬ìŠ¤ë„ˆë“¤
                initNoticesListener();  // ê³µì§€ì‚¬í•­
                initSuggestionsListener(); // ì œíœ´/ê±´ì˜
                initAdminsListener();   // ê´€ë¦¬ì
                loadPrompts();          // AI í”„ë¡¬í”„íŠ¸ ë¡œë“œ
                initPaymentsListener(); // ê²°ì œ ë‚´ì—­
                initPointLogsListener(); // í¬ì¸íŠ¸ ë¡œê·¸
                initDailyUsageListener(); // ì¼ì¼ ì‚¬ìš©ëŸ‰
                initUsageStats(); // í¬ì¸íŠ¸ ì‚¬ìš© ë¶„ì„
            } catch(e) {
                console.error('initializeFirebaseListeners ì˜¤ë¥˜:', e);
            }
        }
        
        // â˜… ê²°ì œ ë‚´ì—­ ë¦¬ìŠ¤ë„ˆ
        function initPaymentsListener() {
            db.collection('payments').orderBy('createdAt', 'desc').limit(500).onSnapshot((snapshot) => {
                payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPaymentHistory();
                updatePaymentStats();
            }, (error) => {
                console.error('payments ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            });
        }
        
        // â˜… í¬ì¸íŠ¸ ë¡œê·¸ ë¦¬ìŠ¤ë„ˆ
        function initPointLogsListener() {
            db.collection('pointLogs').orderBy('createdAt', 'desc').limit(500).onSnapshot((snapshot) => {
                pointLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPointLogs();
                renderUsageStats();  // ì‚¬ìš© ë¶„ì„ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
            }, (error) => {
                console.error('pointLogs ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            });
        }
        
        // â˜… ì¼ì¼ ì‚¬ìš©ëŸ‰ ë¦¬ìŠ¤ë„ˆ
        function initDailyUsageListener() {
            // ì˜¤ëŠ˜ ë‚ ì§œ (í•œêµ­ ì‹œê°„) ê¸°ë³¸ ì„¤ì •
            const now = new Date();
            const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
            const today = koreaTime.toISOString().split('T')[0];
            
            // ë‚ ì§œ í•„í„° ê¸°ë³¸ê°’ ì„¤ì •
            const dateFilter = document.getElementById('dailyUsageDateFilter');
            if (dateFilter) dateFilter.value = today;
            
            // ì˜¤ëŠ˜ ë°ì´í„° ë¡œë“œ
            loadDailyUsageByDate();
        }
        
        // ì„ íƒí•œ ë‚ ì§œë¡œ ì¼ì¼ ì‚¬ìš©ëŸ‰ ì¡°íšŒ
        // â˜… ë¬´ë£Œì‚¬ìš©ì ì œí•œ ì •ë³´ ìºì‹œ
        let freeUserLimits = {};
        
        async function loadDailyUsageByDate() {
            const dateFilter = document.getElementById('dailyUsageDateFilter');
            const selectedDate = dateFilter?.value || new Date().toISOString().split('T')[0];
            
            try {
                // 1. ë¬´ë£Œì‚¬ìš©ì ì œí•œ ì •ë³´ ë¨¼ì € ë¡œë“œ
                const adminsSnapshot = await db.collection('admins').where('role', '==', 'freeuser').get();
                freeUserLimits = {};
                adminsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.userId) {
                        freeUserLimits[data.userId] = {
                            summaryLimit: data.summaryLimit !== undefined ? data.summaryLimit : 999,
                            detailLimit: data.detailLimit !== undefined ? data.detailLimit : 999,
                            expireDate: data.expireDate || null
                        };
                    }
                });
                console.log('ğŸ“‹ ë¬´ë£Œì‚¬ìš©ì ì œí•œ ì •ë³´:', freeUserLimits);
                
                // 2. ì¼ì¼ ì‚¬ìš©ëŸ‰ ë¡œë“œ
                const usageSnapshot = await db.collection('userUsage').where('date', '==', selectedDate).get();
                dailyUsages = usageSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderDailyUsage();
            } catch (error) {
                console.error('ì¼ì¼ ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¡°íšŒ
        function loadDailyUsageToday() {
            const now = new Date();
            const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
            const today = koreaTime.toISOString().split('T')[0];
            
            const dateFilter = document.getElementById('dailyUsageDateFilter');
            if (dateFilter) dateFilter.value = today;
            
            loadDailyUsageByDate();
        }
        
        // â˜… ê²°ì œ í†µê³„ ì—…ë°ì´íŠ¸
        function updatePaymentStats() {
            // ì´ë²ˆë‹¬ ê²°ì œ ê±´ìˆ˜
            const now = new Date();
            const thisMonth = now.toISOString().slice(0, 7);
            const thisMonthPayments = payments.filter(p => {
                if (!p.createdAt) return false;
                const payDate = p.createdAt.toDate ? p.createdAt.toDate() : new Date(p.createdAt);
                return payDate.toISOString().slice(0, 7) === thisMonth && p.status === 'success';
            });
            
            // ì´ ë°œí–‰ í¬ì¸íŠ¸
            const totalPoints = payments.reduce((sum, p) => {
                if (p.status === 'success') return sum + (p.points || 0);
                return sum;
            }, 0);
            
            // ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸
            const statPayments = document.querySelector('.status-card:nth-child(3) div:last-child div:last-child');
            const statPoints = document.querySelector('.status-card:nth-child(4) div:last-child div:last-child');
            if (statPayments) statPayments.textContent = thisMonthPayments.length + 'ê±´';
            if (statPoints) statPoints.textContent = totalPoints.toLocaleString() + ' P';
        }

        // --- ë Œë”ë§ í•¨ìˆ˜ (í˜ì´ì§•/ê²€ìƒ‰ í¬í•¨) ---
        const PAGE_SIZE = 15;
        const state = { users: {page:1, search:''}, pending: {page:1, search:''}, payments: {page:1, search:''}, points: {page:1, search:''}, dailyUsage: {page:1, search:''} };

        function filterAndPaginate(data, stateKey) {
            const s = state[stateKey];
            const filtered = data.filter(item => { if (!s.search) return true; return Object.values(item).some(val => String(val).toLowerCase().includes(s.search.toLowerCase())); });
            const totalPages = Math.ceil(filtered.length / PAGE_SIZE) || 1;
            if (s.page > totalPages) s.page = totalPages;
            const start = (s.page - 1) * PAGE_SIZE;
            const paged = filtered.slice(start, start + PAGE_SIZE);
            return { paged, totalPages, totalCount: filtered.length };
        }

        function renderPaginationControls(containerId, stateKey, totalPages, renderFn) {
            const container = document.getElementById(containerId);
            let html = `<button class="page-btn" onclick="changePage('${stateKey}',${state[stateKey].page-1})" ${state[stateKey].page===1?'disabled':''}>Prev</button>`;
            for(let i=1; i<=totalPages; i++) { html+=`<button class="page-btn ${i===state[stateKey].page?'active':''}" onclick="changePage('${stateKey}',${i})">${i}</button>`; }
            html+=`<button class="page-btn" onclick="changePage('${stateKey}',${state[stateKey].page+1})" ${state[stateKey].page===totalPages?'disabled':''}>Next</button>`;
            container.innerHTML=html;
            window.changePage=(key,p)=>{if(p<1||p>totalPages)return; state[key].page=p; renderFn();}
        }

        function renderUsers() {
            // ì—˜ë¦¬ë¨¼íŠ¸ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
            const pendingSearchEl = document.getElementById('pendingSearch');
            const userSearchEl = document.getElementById('userSearch');
            const pBody = document.getElementById('pendingTableBody');
            const uBody = document.getElementById('userTableBody');
            
            if (!pBody || !uBody) return; // ì—˜ë¦¬ë¨¼íŠ¸ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
            
            // 1. ëŒ€ê¸°ì ëª©ë¡
            state.pending.search = pendingSearchEl ? pendingSearchEl.value : '';
            const pRes = filterAndPaginate(pendingApps, 'pending');
            
            if(pRes.totalCount === 0) pBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">ëŒ€ê¸° ë‚´ì—­ ì—†ìŒ</td></tr>';
            else {
                pBody.innerHTML = pRes.paged.map(app => {
                    const dateStr = app.requestedAt ? new Date(app.requestedAt.seconds * 1000).toLocaleString() : '-';
                    return `<tr>
                        <td>${dateStr}</td>
                        <td>${app.name}</td>
                        <td>${app.company} ${app.position}</td>
                        <td>${app.region}</td>
                        <td>${app.phone}</td>
                        <td>${app.email}</td>
                        <td><span class="badge badge-gray">ë¯¸ì§€ì •</span></td>
                        <td><span class="badge badge-red">ë¯¸ì…ê¸ˆ</span></td>
                        <td><button class="btn btn-primary btn-sm" onclick="openIssueIdModal('${app.id}')">IDë°œê¸‰</button></td>
                    </tr>`;
                }).join('');
            }
            renderPaginationControls('pendingPagination', 'pending', pRes.totalPages, renderUsers);

            // 2. ì „ì²´ íšŒì› ëª©ë¡ (ê´€ë¦¬ì ì œì™¸)
            state.users.search = userSearchEl ? userSearchEl.value : '';
            
            // â˜… ê´€ë¦¬ì(admin)ë§Œ íšŒì› ëª©ë¡ì—ì„œ ì œì™¸ (íƒˆí‡´ íšŒì›ì€ í‘œì‹œ)
            const nonAdminUsers = users.filter(u => u.type !== 'admin' && u.role !== 'admin' && !u.isAdmin);
            const uRes = filterAndPaginate(nonAdminUsers, 'users');
            
            uBody.innerHTML = uRes.paged.map((u, idx) => {
                // â˜… ê°€ì…ë¹„ ìƒíƒœ (regFeeStatus ì‚¬ìš©)
                let feeBadge = '<span class="badge badge-red">ë¯¸ë‚©</span>';
                if (u.regFeeStatus === 'paid') {
                    feeBadge = '<span class="badge badge-green">ë‚©ë¶€</span>';
                } else if (u.regFeeStatus === 'exempt') {
                    feeBadge = '<span class="badge badge-gray">ë©´ì œ</span>';
                }
                
                // â˜… ìƒíƒœ í•œê¸€ í‘œì‹œ (í™œì„±, ë¹„í™œì„±, íƒˆí‡´)
                const statusMap = {'active': 'í™œì„±', 'inactive': 'ë¹„í™œì„±', 'withdrawn': 'íƒˆí‡´'};
                const statusText = statusMap[u.status] || u.status || '-';
                let statusBadge = '<span class="badge badge-green">' + statusText + '</span>';
                if (u.status === 'inactive') {
                    statusBadge = '<span class="badge badge-gray">' + statusText + '</span>';
                } else if (u.status === 'withdrawn') {
                    statusBadge = '<span class="badge" style="background:#333;color:#fff;">' + statusText + '</span>';
                }
                
                // â˜… ìœ í˜• í‘œì‹œ (í•œê¸€ ê·¸ëŒ€ë¡œ ë˜ëŠ” ë§¤í•‘)
                const typeDisplay = u.type || '-';
                
                const fee = u.monthlyFee ? u.monthlyFee.toLocaleString() : '0';
                
                // â˜… í¬ì¸íŠ¸ ì”ì•¡
                const pointBalance = u.paidBalance ? u.paidBalance.toLocaleString() : '0';
                
                // â˜… ë“±ë¡ì¼ì
                const createdDate = u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : '-';
                
                // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ: ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ ë˜ëŠ” "ë³€ê²½ë¨"
                let pwDisplay = '-';
                if (u.password) {
                    pwDisplay = `<span class="password-display">${u.password}</span>`;
                } else if (u.isPasswordChanged === false) {
                    pwDisplay = '<span class="password-display">123456</span>';
                } else {
                    pwDisplay = '<span style="color:#888; font-size:0.8rem;">ë³€ê²½ë¨</span>';
                }
                
                return `<tr>
                    <td><input type="checkbox" class="user-checkbox" value="${u.id}" data-userid="${u.userId}"></td>
                    <td>${idx+1}</td>
                    <td class="clickable-cell">${u.userId || '-'}</td>
                    <td>${u.name || '-'}</td>
                    <td>${pwDisplay}</td>
                    <td>${u.company || ''} ${u.jobTitle || ''}</td>
                    <td>${u.region || '-'}</td>
                    <td><span class="badge badge-gray">${typeDisplay}</span></td>
                    <td>${u.phone || '-'}<br><span style="color:#888;font-size:0.8rem">${u.email || '-'}</span></td>
                    <td>${feeBadge}</td>
                    <td style="font-weight:bold; color:var(--accent-color);">${fee}</td>
                    <td style="font-weight:bold; color:#2196F3;">${pointBalance} P</td>
                    <td style="font-size:0.85rem; color:#666;">${createdDate}</td>
                    <td>${statusBadge}</td>
                    <td><button class="btn btn-outline btn-sm" onclick="openUserEditModal('${u.id}')"><i class="ph ph-pencil-simple"></i> ìˆ˜ì •</button></td>
                </tr>`;
            }).join('');
            renderPaginationControls('userPagination', 'users', uRes.totalPages, renderUsers);
            
            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì´ˆê¸°í™”
            const selectAllEl = document.getElementById('selectAllUsers');
            if (selectAllEl) selectAllEl.checked = false;
            
            // ëŒ€ì‹œë³´ë“œ íšŒì› ìˆ˜ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ì ì œì™¸)
            document.getElementById('statTotalUsers').innerText = nonAdminUsers.length;
            
            // íƒˆí‡´ ìš”ì²­ íšŒì› ë Œë”ë§
            renderWithdrawnUsers();
        }
        
        // --- íƒˆí‡´ ìš”ì²­ íšŒì› ë Œë”ë§ ---
        function renderWithdrawnUsers() {
            const tbody = document.getElementById('withdrawnTableBody');
            if (!tbody) return;
            
            // íƒˆí‡´ ìš”ì²­ íšŒì› í•„í„° (status === 'withdrawn')
            const withdrawnUsers = users.filter(u => u.status === 'withdrawn');
            
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const countEl = document.getElementById('withdrawnCount');
            if (countEl) countEl.textContent = withdrawnUsers.length + 'ëª…';
            
            if (withdrawnUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999; padding:2rem;">íƒˆí‡´ ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = withdrawnUsers.map(u => {
                const withdrawnDate = u.withdrawnAt ? new Date(u.withdrawnAt.seconds * 1000).toLocaleDateString('ko-KR') : '-';
                const createdDate = u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : '-';
                const balance = u.paidBalance ? u.paidBalance.toLocaleString() : '0';
                
                return `<tr>
                    <td>${withdrawnDate}</td>
                    <td>${u.userId || '-'}</td>
                    <td>${u.name || '-'}</td>
                    <td>${u.withdrawnEmail || u.email || '-'}</td>
                    <td style="color:#dc3545; font-weight:600;">${balance} P</td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="confirmDeleteUser('${u.id}', '${u.userId}')" style="color:#dc3545; border-color:#dc3545;">
                            <i class="ph ph-trash"></i> ì™„ì „ì‚­ì œ
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        // --- íƒˆí‡´ íšŒì› ì™„ì „ ì‚­ì œ í™•ì¸ ---
        async function confirmDeleteUser(docId, userId) {
            if (!confirm(`ì •ë§ë¡œ "${userId}" íšŒì›ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì‚­ì œë˜ëŠ” ë°ì´í„°:\n- Firebase ê³„ì • (ë¡œê·¸ì¸ ì •ë³´)\n- íšŒì› ì •ë³´\n- í¬ì¸íŠ¸ ì´ìš© ë‚´ì—­\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                // Cloud Functions í˜¸ì¶œí•˜ì—¬ ì™„ì „ ì‚­ì œ (asia-northeast3 region ì‚¬ìš©)
                const deleteUserCompletely = functions.httpsCallable('deleteUserCompletely');
                const result = await deleteUserCompletely({ uid: docId, userId: userId });
                
                if (result.data.success) {
                    alert(`âœ… "${userId}" íšŒì›ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n- Firebase ê³„ì • ì‚­ì œ ì™„ë£Œ\n- íšŒì› ì •ë³´ ì‚­ì œ ì™„ë£Œ\n- í¬ì¸íŠ¸ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ`);
                    location.reload();
                }
                
            } catch (error) {
                console.error('íšŒì› ì‚­ì œ ì˜¤ë¥˜:', error);
                
                // Cloud Functions ë¯¸ë°°í¬ ì‹œ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
                if (error.code === 'functions/not-found' || error.message.includes('not found')) {
                    alert('âš ï¸ Cloud Functionsê°€ ë°°í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nFirestore ë°ì´í„°ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.\nFirebase Auth ê³„ì •ì€ Firebase Consoleì—ì„œ ìˆ˜ë™ ì‚­ì œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    
                    // ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ Firestoreë§Œ ì‚­ì œ
                    await db.collection('users').doc(docId).delete();
                    const logsSnapshot = await db.collection('pointLogs').where('uid', '==', docId).get();
                    const batch = db.batch();
                    logsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    
                    alert(`"${userId}" íšŒì›ì˜ Firestore ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                } else {
                    alert('íšŒì› ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || error));
                }
            }
        }

        // --- 5. ë¡œì§ í•¨ìˆ˜: ìŠ¹ì¸ ë° ë“±ë¡ ---
        function openIssueIdModal(docId) {
            const app = pendingApps.find(a => a.id === docId);
            if(!app) return;

            document.getElementById('newUserName').value = app.name;
            document.getElementById('newUserPhone').value = app.phone;
            document.getElementById('newUserEmail').value = app.email;
            document.getElementById('newUserRegion').value = app.region;
            document.getElementById('newUserCompany').value = app.company;
            document.getElementById('newUserTitle').value = app.position; // position -> title ë§¤í•‘
            
            document.getElementById('newUserId').value = ''; 
            document.getElementById('newUserPw').value = '123456';
            document.getElementById('newUserType').value = 'inner'; 
            document.getElementById('regFeeStatus').value = 'unpaid'; 
            
            document.getElementById('registerForm').dataset.docId = docId; // DB ë¬¸ì„œ ID ì €ì¥
            document.getElementById('registerModal').style.display = 'flex';
        }

        function openRegisterModal() {
            document.getElementById('registerForm').reset();
            document.querySelectorAll('#registerForm input[readonly]').forEach(el => {
                el.removeAttribute('readonly');
                el.style.background = 'white';
            });
            delete document.getElementById('registerForm').dataset.docId;
            document.getElementById('registerModal').style.display = 'flex';
        }

        document.getElementById('registerForm').addEventListener('submit', async function(e){
            e.preventDefault();
            const docId = this.dataset.docId;
            
            const userId = document.getElementById('newUserId').value.trim();
            const password = document.getElementById('newUserPw').value;
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!userId) {
                alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (password.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            try {
                // â˜… 1. Secondary Firebase Appìœ¼ë¡œ Auth ì‚¬ìš©ì ìƒì„± (ê´€ë¦¬ì ì„¸ì…˜ ìœ ì§€)
                const secondaryApp = firebase.initializeApp(firebaseConfig, 'Secondary');
                const secondaryAuth = secondaryApp.auth();
                
                // ì´ë©”ì¼ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (login.htmlê³¼ ë™ì¼í•œ ë°©ì‹)
                const authEmail = `${userId}@system.local`;
                
                // Firebase Authì— ì‚¬ìš©ì ìƒì„±
                const userCredential = await secondaryAuth.createUserWithEmailAndPassword(authEmail, password);
                const createdUser = userCredential.user;
                const uid = createdUser.uid;
                
                console.log('âœ… Firebase Auth ì‚¬ìš©ì ìƒì„± ì™„ë£Œ:', uid);
                
                // Secondary ì•± ë¡œê·¸ì•„ì›ƒ (ê´€ë¦¬ì ì„¸ì…˜ì— ì˜í–¥ ì—†ìŒ)
                await secondaryAuth.signOut();
                await secondaryApp.delete();
                
                // â˜… 2. Firestore users ì»¬ë ‰ì…˜ì— ì €ì¥ (UIDë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©)
                const newUser = {
                    userId: userId,
                    password: password,  // â˜… ë¹„ë°€ë²ˆí˜¸ ì €ì¥ (ê´€ë¦¬ì ì¡°íšŒìš©)
                    name: document.getElementById('newUserName').value, 
                    phone: document.getElementById('newUserPhone').value,
                    email: document.getElementById('newUserEmail').value,
                    region: document.getElementById('newUserRegion').value,
                    company: document.getElementById('newUserCompany').value, 
                    jobTitle: document.getElementById('newUserTitle').value,
                    type: document.getElementById('newUserType').value, 
                    monthlyFee: parseInt(document.getElementById('newUserFee').value) || 0,
                    regFeeStatus: document.getElementById('regFeeStatus').value, 
                    status: 'active',
                    pointBalance: 0,
                    isPasswordChanged: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // UIDë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©í•˜ì—¬ ì €ì¥ (login.htmlê³¼ ì—°ë™)
                await db.collection('users').doc(uid).set(newUser);
                console.log('âœ… Firestore users ì €ì¥ ì™„ë£Œ');
                
                // â˜… ë¬´ë£Œì‚¬ìš©ìë©´ admins ì»¬ë ‰ì…˜ì—ë„ ì¶”ê°€
                if (newUser.type === 'freeuser') {
                    const adminData = {
                        userId: userId,
                        name: newUser.name,
                        password: password,
                        role: 'freeuser',
                        isAdmin: false,
                        expireDate: null,  // ê´€ë¦¬ì ê´€ë¦¬ì—ì„œ ì„¤ì •
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('admins').doc(uid).set(adminData);
                    console.log('âœ… admins ì»¬ë ‰ì…˜ì— ë¬´ë£Œì‚¬ìš©ì ì¶”ê°€');
                }

                // â˜… 3. ìŠ¹ì¸ ê±´ì´ë©´ ìš”ì²­ ë‚´ì—­ ì‚­ì œ
                if(docId) {
                    await db.collection('account_requests').doc(docId).delete();
                    console.log('âœ… account_requests ì‚­ì œ ì™„ë£Œ');
                }

                document.getElementById('registerModal').style.display='none';
                alert('âœ… íšŒì› ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì•„ì´ë””: ' + userId + '\nì„ì‹œ ë¹„ë°€ë²ˆí˜¸: ' + password + '\n\níšŒì›ì—ê²Œ ì•ˆë‚´í•´ì£¼ì„¸ìš”.');
                
            } catch(err) {
                console.error('íšŒì› ìƒì„± ì˜¤ë¥˜:', err);
                
                // Secondary App ì •ë¦¬
                try {
                    const secondaryApp = firebase.app('Secondary');
                    if (secondaryApp) {
                        await secondaryApp.auth().signOut();
                        await secondaryApp.delete();
                    }
                } catch(e) {}
                
                // ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
                let errorMsg = 'ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
                if (err.code === 'auth/email-already-in-use') {
                    errorMsg = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';
                } else if (err.code === 'auth/weak-password') {
                    errorMsg = 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                }
                alert(errorMsg);
            }
        });

        // --- ê¸°íƒ€ ë¡œì§ (ê²°ì œ, í¬ì¸íŠ¸ Firestore ì—°ë™) ---
        function renderPaymentHistory() {
            const tbody = document.getElementById('paymentHistoryBody');
            if (!tbody) return;
            
            // ê²€ìƒ‰ í•„í„°
            const search = (document.getElementById('paymentSearch')?.value || '').toLowerCase();
            let filtered = payments;
            if (search) {
                filtered = payments.filter(p => {
                    const email = (p.email || '').toLowerCase();
                    const moid = (p.moid || '').toLowerCase();
                    return email.includes(search) || moid.includes(search);
                });
            }
            
            // í˜ì´ì§€ë„¤ì´ì…˜
            const page = state.payments.page || 1;
            const start = (page - 1) * PAGE_SIZE;
            const pageData = filtered.slice(start, start + PAGE_SIZE);
            
            tbody.innerHTML = pageData.map(p => {
                const date = p.createdAt ? (p.createdAt.toDate ? p.createdAt.toDate() : new Date(p.createdAt)) : new Date();
                const dateStr = date.toLocaleString('ko-KR');
                const userId = (p.email || '').split('@')[0];
                const userName = users.find(u => u.id === p.uid)?.name || userId;
                const amount = (p.amount || 0).toLocaleString() + 'ì›';
                const type = p.type === 'point_charge' ? 'í¬ì¸íŠ¸ì¶©ì „' : (p.type || '-');
                const status = p.status === 'success' ? '<span style="color:green">ì„±ê³µ</span>' : '<span style="color:red">ì‹¤íŒ¨</span>';
                
                return `<tr>
                    <td>${dateStr}</td>
                    <td>${userId}</td>
                    <td>${userName}</td>
                    <td>${amount}</td>
                    <td>${type}</td>
                    <td>${status}</td>
                </tr>`;
            }).join('');
            
            // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
            const totalPages = Math.ceil(filtered.length / PAGE_SIZE) || 1;
            renderPagination('paymentPagination', totalPages, page, 'payments');
        }
        
        function renderPointLogs() {
            const tbody = document.getElementById('pointLogsBody');
            if (!tbody) return;
            
            // ê²€ìƒ‰ í•„í„°
            const search = (document.getElementById('pointSearch')?.value || '').toLowerCase();
            let filtered = pointLogs;
            if (search) {
                filtered = pointLogs.filter(p => {
                    const email = (p.email || '').toLowerCase();
                    const desc = (p.description || '').toLowerCase();
                    return email.includes(search) || desc.includes(search);
                });
            }
            
            // í˜ì´ì§€ë„¤ì´ì…˜
            const page = state.points.page || 1;
            const start = (page - 1) * PAGE_SIZE;
            const pageData = filtered.slice(start, start + PAGE_SIZE);
            
            tbody.innerHTML = pageData.map(p => {
                const date = p.createdAt ? (p.createdAt.toDate ? p.createdAt.toDate() : new Date(p.createdAt)) : new Date();
                const dateStr = date.toLocaleString('ko-KR');
                const userId = (p.email || '').split('@')[0];
                const userName = users.find(u => u.id === p.uid)?.name || userId;
                const typeLabels = { 'charge': 'ì¶©ì „', 'summary_use': 'ìš”ì•½ë¶„ì„', 'detail_use': 'ìƒì„¸ë¶„ì„', 'use': 'ì‚¬ìš©' };
                const typeLabel = typeLabels[p.type] || p.type;
                const typeColor = p.type === 'charge' ? 'color:blue' : 'color:red';
                const change = p.amount >= 0 ? `+${Math.abs(p.amount || 0).toLocaleString()}` : `-${Math.abs(p.amount || 0).toLocaleString()}`;
                const balance = (p.balanceAfter || 0).toLocaleString() + 'P';
                
                return `<tr>
                    <td>${dateStr}</td>
                    <td>${userId}</td>
                    <td>${userName}</td>
                    <td><span style="${typeColor}">${typeLabel}</span></td>
                    <td>${p.description || '-'}</td>
                    <td style="${typeColor}">${change}P</td>
                    <td>${balance}</td>
                </tr>`;
            }).join('');
            
            // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
            const totalPages = Math.ceil(filtered.length / PAGE_SIZE) || 1;
            renderPagination('pointPagination', totalPages, page, 'points');
        }
        
        function renderDailyUsage() {
            const tbody = document.getElementById('dailyUsageBody');
            if (!tbody) return;
            
            // ê²€ìƒ‰ í•„í„°
            const search = (document.getElementById('dailyUsageSearch')?.value || '').toLowerCase();
            let filtered = dailyUsages;
            if (search) {
                filtered = dailyUsages.filter(u => {
                    const userInfo = users.find(user => user.id === u.id);
                    const userId = (userInfo?.userId || '').toLowerCase();
                    const userName = (userInfo?.name || '').toLowerCase();
                    return userId.includes(search) || userName.includes(search);
                });
            }
            
            // í˜ì´ì§€ë„¤ì´ì…˜
            const page = state.dailyUsage?.page || 1;
            const start = (page - 1) * PAGE_SIZE;
            const pageData = filtered.slice(start, start + PAGE_SIZE);
            
            const DEFAULT_DAILY_LIMIT = 10;  // ì¼ë°˜ ì‚¬ìš©ì ê¸°ë³¸ ì œí•œ
            
            tbody.innerHTML = pageData.map(u => {
                const oderId = u.id;
                const userInfo = users.find(user => user.id === oderId);
                const userName = userInfo?.name || 'ì‚­ì œíšŒì›';
                const displayId = userInfo?.userId || userInfo?.email?.split('@')[0] || '(ì‚­ì œë¨)';
                
                // â˜… ë¬´ë£Œì‚¬ìš©ì ê°œë³„ ì œí•œ í™•ì¸
                const freeLimit = freeUserLimits[displayId];
                let summaryLimit = DEFAULT_DAILY_LIMIT;
                let detailLimit = DEFAULT_DAILY_LIMIT;
                let isFreeUser = false;
                
                if (freeLimit) {
                    isFreeUser = true;
                    summaryLimit = freeLimit.summaryLimit !== 999 ? freeLimit.summaryLimit : DEFAULT_DAILY_LIMIT;
                    detailLimit = freeLimit.detailLimit !== 999 ? freeLimit.detailLimit : DEFAULT_DAILY_LIMIT;
                }
                
                const summaryUsed = u.summaryCount || 0;
                const summaryRemain = Math.max(0, summaryLimit - summaryUsed);
                const detailUsed = u.detailCount || 0;
                const detailRemain = Math.max(0, detailLimit - detailUsed);
                const lastUsed = u.date || '-';
                
                // â˜… ë¬´ë£Œì‚¬ìš©ìëŠ” ë±ƒì§€ í‘œì‹œ
                const userBadge = isFreeUser ? ' <span style="font-size:0.75rem;color:#e67e22;">[ë¬´ë£Œ]</span>' : '';
                
                // â˜… ì œí•œ í‘œì‹œ (ë¬´ë£Œì‚¬ìš©ìëŠ” ê°œë³„ ì œí•œ í‘œì‹œ)
                const summaryLimitText = isFreeUser && freeLimit.summaryLimit !== 999 ? `/${summaryLimit}` : `/${DEFAULT_DAILY_LIMIT}`;
                const detailLimitText = isFreeUser && freeLimit.detailLimit !== 999 ? `/${detailLimit}` : `/${DEFAULT_DAILY_LIMIT}`;
                
                return `<tr>
                    <td>${displayId}${userBadge}</td>
                    <td>${userName}</td>
                    <td><span style="color:${summaryUsed >= summaryLimit ? 'red' : 'blue'}">${summaryUsed}íšŒ</span></td>
                    <td><span style="color:${summaryRemain === 0 ? 'red' : 'inherit'}">${summaryRemain}íšŒ${summaryLimitText}</span></td>
                    <td><span style="color:${detailUsed >= detailLimit ? 'red' : 'blue'}">${detailUsed}íšŒ</span></td>
                    <td><span style="color:${detailRemain === 0 ? 'red' : 'inherit'}">${detailRemain}íšŒ${detailLimitText}</span></td>
                    <td>${lastUsed}</td>
                </tr>`;
            }).join('');
            
            // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
            const totalPages = Math.ceil(filtered.length / PAGE_SIZE) || 1;
            renderPagination('dailyUsagePagination', totalPages, page, 'dailyUsage');
        }
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§ í—¬í¼
        function renderPagination(containerId, totalPages, currentPage, stateKey) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                html += `<button class="page-btn ${activeClass}" onclick="goToPage('${stateKey}', ${i})">${i}</button>`;
            }
            container.innerHTML = html;
        }
        
        // â˜… í¬ì¸íŠ¸ ì‚¬ìš© ë¶„ì„ - ì›” ì„ íƒ ì´ˆê¸°í™”
        let usageStatsMonthFilter = null;
        
        function initUsageStats() {
            // ì´ë²ˆë‹¬ ê¸°ë³¸ê°’ ì„¤ì •
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthFilter = document.getElementById('usageStatsMonthFilter');
            if (monthFilter) monthFilter.value = thisMonth;
            
            loadUsageStatsAll();
        }
        
        // ì„ íƒí•œ ì›”ë¡œ ì¡°íšŒ
        async function loadUsageStatsByMonth() {
            const monthFilter = document.getElementById('usageStatsMonthFilter');
            usageStatsMonthFilter = monthFilter?.value || null;
            await loadUsageStatsData();
        }
        
        // ì „ì²´ ì¡°íšŒ
        async function loadUsageStatsAll() {
            usageStatsMonthFilter = null;
            const monthFilter = document.getElementById('usageStatsMonthFilter');
            if (monthFilter) monthFilter.value = '';
            await loadUsageStatsData();
        }
        
        // ì‚¬ìš© ë¶„ì„ ë°ì´í„° ë¡œë“œ
        async function loadUsageStatsData() {
            const tbody = document.getElementById('usageStatsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#888;">ë¡œë”© ì¤‘...</td></tr>';
            
            try {
                // userUsageì—ì„œ ëª¨ë“  ì‚¬ìš© ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
                const usageSnapshot = await db.collection('userUsage').get();
                
                const DAILY_FREE_LIMIT = 10; // ì¼ì¼ ë¬´ë£Œ í•œë„
                
                // ì›”ë³„, ì‚¬ìš©ìë³„ë¡œ ê·¸ë£¹í•‘
                const grouped = {};
                usageSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const uid = doc.id;
                    const date = data.date || '';
                    const month = date.substring(0, 7); // 'YYYY-MM'
                    
                    // ì›” í•„í„° ì ìš©
                    if (usageStatsMonthFilter && month !== usageStatsMonthFilter) return;
                    
                    const key = `${uid}_${month}`;
                    
                    if (!grouped[key]) {
                        grouped[key] = {
                            uid: uid,
                            month: month,
                            summaryFree: 0,
                            summaryPaid: 0,
                            detailFree: 0,
                            detailPaid: 0
                        };
                    }
                    
                    // ì¼ë³„ ë¬´ë£Œ/ìœ ë£Œ ê³„ì‚°
                    const dailySummary = data.summaryCount || 0;
                    const dailyDetail = data.detailCount || 0;
                    
                    grouped[key].summaryFree += Math.min(dailySummary, DAILY_FREE_LIMIT);
                    grouped[key].summaryPaid += Math.max(dailySummary - DAILY_FREE_LIMIT, 0);
                    grouped[key].detailFree += Math.min(dailyDetail, DAILY_FREE_LIMIT);
                    grouped[key].detailPaid += Math.max(dailyDetail - DAILY_FREE_LIMIT, 0);
                });
                
                // ì‚¬ìš© ê¸°ë¡ì´ ìˆëŠ” íšŒì› UID ìˆ˜ì§‘
                const usedUids = new Set(Object.values(grouped).map(g => g.uid));
                
                // í¬ì¸íŠ¸ ì”ì•¡ì´ ìˆëŠ” íšŒì›ë„ í¬í•¨ (ì‚¬ìš©ê¸°ë¡ ì—†ë”ë¼ë„)
                users.forEach(user => {
                    if (((user.paidBalance || 0) + (user.points || 0)) > 0 && !usedUids.has(user.id)) {
                        // ì´ë²ˆë‹¬ ê¸°ì¤€ìœ¼ë¡œ ì¶”ê°€
                        const now = new Date();
                        const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                        
                        // ì›” í•„í„°ê°€ ìˆê³  ì´ë²ˆë‹¬ì´ ì•„ë‹ˆë©´ ì œì™¸
                        if (usageStatsMonthFilter && usageStatsMonthFilter !== thisMonth) return;
                        
                        const key = `${user.id}_${thisMonth}`;
                        if (!grouped[key]) {
                            grouped[key] = {
                                uid: user.id,
                                month: thisMonth,
                                summaryFree: 0,
                                summaryPaid: 0,
                                detailFree: 0,
                                detailPaid: 0
                            };
                        }
                    }
                });
                
                // ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ì •ë ¬
                const data = Object.values(grouped).sort((a, b) => {
                    if (a.month !== b.month) return b.month.localeCompare(a.month);
                    return a.uid.localeCompare(b.uid);
                });
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#888;">ì‚¬ìš© ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(row => {
                    const userInfo = users.find(u => u.id === row.uid);
                    const userId = userInfo?.userId || userInfo?.email?.split('@')[0] || '(ì‚­ì œë¨)';
                    const userName = userInfo?.name || 'ì‚­ì œíšŒì›';
                    const points = (userInfo?.paidBalance || 0) + (userInfo?.points || 0);
                    const summaryAmount = row.summaryPaid * 500;  // ìœ ë£Œë¶„ë§Œ ì°¨ê°
                    const detailAmount = row.detailPaid * 2000;   // ìœ ë£Œë¶„ë§Œ ì°¨ê°
                    const total = summaryAmount + detailAmount;
                    
                    return `<tr>
                        <td>${userId}<br><small style="color:#666">${userName}</small></td>
                        <td>${row.month}</td>
                        <td style="text-align:center;color:#28a745">${row.summaryFree}íšŒ</td>
                        <td style="text-align:center;color:#dc3545">${row.summaryPaid}íšŒ</td>
                        <td style="text-align:right;color:red">${summaryAmount.toLocaleString()}P</td>
                        <td style="text-align:center;color:#28a745">${row.detailFree}íšŒ</td>
                        <td style="text-align:center;color:#dc3545">${row.detailPaid}íšŒ</td>
                        <td style="text-align:right;color:red">${detailAmount.toLocaleString()}P</td>
                        <td style="text-align:right;font-weight:bold;color:red">${total.toLocaleString()}P</td>
                        <td style="text-align:right;color:blue">${points.toLocaleString()}P</td>
                    </tr>`;
                }).join('');
                
            } catch (error) {
                console.error('ì‚¬ìš© ë¶„ì„ ë¡œë“œ ì˜¤ë¥˜:', error);
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>';
            }
        }
        
        function renderUsageStats() {
            // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ - ì‹¤ì œë¡œëŠ” loadUsageStatsData ì‚¬ìš©
            loadUsageStatsData();
        }
        
        function goToPage(stateKey, page) {
            state[stateKey].page = page;
            if (stateKey === 'payments') renderPaymentHistory();
            else if (stateKey === 'points') renderPointLogs();
            else if (stateKey === 'dailyUsage') renderDailyUsage();
        }
        function runBatchSimulation() { alert('ê²°ì œ ì‹œë®¬ë ˆì´ì…˜'); }
        let currentTermType = 'service';
        async function loadTerm(t) {
            currentTermType = t;
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.getElementById('btn-term-service').className = t === 'service' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('btn-term-privacy').className = t === 'privacy' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('btn-term-marketing').className = t === 'marketing' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('btn-term-guide').className = t === 'usageGuide' ? 'btn btn-primary' : 'btn btn-outline';
            
            try {
                const doc = await db.collection('settings').doc('terms').get();
                if (doc.exists && doc.data()[t]) {
                    document.getElementById('termEditor').value = doc.data()[t];
                } else {
                    document.getElementById('termEditor').value = '';
                }
            } catch (error) {
                console.error('ì•½ê´€ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('termEditor').value = 'ì•½ê´€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }
        async function saveTerms() {
            const content = document.getElementById('termEditor').value;
            try {
                await db.collection('settings').doc('terms').set({
                    [currentTermType]: content
                }, { merge: true });
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ì•½ê´€ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì˜ìƒìë£Œì‹¤ ê´€ë¦¬
        let videoLinks = [];
        
        async function loadVideoLinks() {
            try {
                const doc = await db.collection('settings').doc('videoLibrary').get();
                if (doc.exists && doc.data().links) {
                    videoLinks = doc.data().links;
                } else {
                    videoLinks = [];
                }
                renderVideoLinks();
            } catch (error) {
                console.error('ì˜ìƒìë£Œ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        function renderVideoLinks() {
            const container = document.getElementById('videoLinksContainer');
            if (videoLinks.length === 0) {
                container.innerHTML = '<p style="color:#999;font-size:0.9rem;">ë“±ë¡ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤. "ì˜ìƒ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                return;
            }
            container.innerHTML = videoLinks.map((link, index) => `
                <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;">
                    <input type="text" class="form-control" placeholder="ì˜ìƒ ì œëª©" value="${link.title || ''}" onchange="updateVideoLink(${index}, 'title', this.value)" style="flex:1;">
                    <input type="text" class="form-control" placeholder="YouTube/ì˜ìƒ URL" value="${link.url || ''}" onchange="updateVideoLink(${index}, 'url', this.value)" style="flex:2;">
                    <button class="btn btn-outline" onclick="removeVideoLink(${index})" style="padding:0.4rem 0.8rem;color:#e74c3c;border-color:#e74c3c;"><i class="ph ph-trash"></i></button>
                </div>
            `).join('');
        }
        
        function addVideoLink() {
            videoLinks.push({ title: '', url: '' });
            renderVideoLinks();
        }
        
        function updateVideoLink(index, field, value) {
            videoLinks[index][field] = value;
        }
        
        function removeVideoLink(index) {
            videoLinks.splice(index, 1);
            renderVideoLinks();
        }
        
        async function saveVideoLinks() {
            // ë¹ˆ í•­ëª© ì œê±°
            const validLinks = videoLinks.filter(link => link.title && link.url);
            try {
                await db.collection('settings').doc('videoLibrary').set({
                    links: validLinks,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                videoLinks = validLinks;
                renderVideoLinks();
                alert('ì˜ìƒìë£Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ì˜ìƒìë£Œ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // â˜… ì „ì²´ ì„ íƒ/í•´ì œ
        function toggleSelectAllUsers() {
            const selectAll = document.getElementById('selectAllUsers');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }
        
        // â˜… ì„ íƒëœ íšŒì› ì‚­ì œ
        async function deleteSelectedUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('ì‚­ì œí•  íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const userList = Array.from(checkboxes).map(cb => ({
                uid: cb.value,
                userId: cb.dataset.userid
            }));
            const userIds = userList.map(u => u.userId).join(', ');
            
            if (!confirm(`ì„ íƒí•œ ${checkboxes.length}ëª…ì˜ íšŒì›ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëŒ€ìƒ: ${userIds}\n\nâš ï¸ ì‚­ì œë˜ëŠ” ë°ì´í„°:\n- Firebase ê³„ì • (ë¡œê·¸ì¸ ì •ë³´)\n- íšŒì› ì •ë³´\n- í¬ì¸íŠ¸ ì´ìš© ë‚´ì—­`)) return;
            if (!confirm(`âš ï¸ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
            
            try {
                // Cloud Functions í˜¸ì¶œí•˜ì—¬ ì™„ì „ ì‚­ì œ (asia-northeast3 region ì‚¬ìš©)
                const deleteUsersCompletely = functions.httpsCallable('deleteUsersCompletely');
                const result = await deleteUsersCompletely({ users: userList });
                
                if (result.data.success) {
                    alert(`âœ… ${result.data.message}\n\nëª¨ë“  ë°ì´í„°ê°€ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                }
                
            } catch (error) {
                console.error('ì¼ê´„ ì‚­ì œ ì˜¤ë¥˜:', error);
                
                // Cloud Functions ë¯¸ë°°í¬ ì‹œ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
                if (error.code === 'functions/not-found' || error.message.includes('not found')) {
                    alert('âš ï¸ Cloud Functionsê°€ ë°°í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nFirestore ë°ì´í„°ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.\nFirebase Auth ê³„ì •ì€ Firebase Consoleì—ì„œ ìˆ˜ë™ ì‚­ì œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    
                    const batch = db.batch();
                    checkboxes.forEach(cb => {
                        const docRef = db.collection('users').doc(cb.value);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    
                    alert(`âœ… ${checkboxes.length}ëª…ì˜ Firestore ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                } else {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + (error.message || error));
                }
            }
        }
        
        // ==================== íšŒì› ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ====================
        let currentEditUserId = null;
        
        function openUserEditModal(docId) {
            const user = users.find(u => u.id === docId);
            if (!user) {
                alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            currentEditUserId = docId;
            
            // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('editUserId').value = docId;
            document.getElementById('editUserLoginId').value = user.userId || '';
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserPassword').value = ''; // ë¹„ë°€ë²ˆí˜¸ëŠ” ë¹„ì›Œë‘ 
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserCompany').value = user.company || '';
            document.getElementById('editUserJobTitle').value = user.jobTitle || '';
            document.getElementById('editUserRegion').value = user.region || '';
            document.getElementById('editUserType').value = user.type || 'ì´ë„ˆ';
            document.getElementById('editUserStatus').value = user.status || 'active';
            document.getElementById('editRegFeeStatus').value = user.regFeeStatus || 'unpaid';
            document.getElementById('editMonthlyFee').value = user.monthlyFee || 0;
            document.getElementById('editPoints').value = (user.paidBalance || 0) + (user.points || 0);
            
            // ë¹„ë°€ë²ˆí˜¸ íŒíŠ¸ í‘œì‹œ
            let pwHint = '';
            if (user.password) {
                pwHint = `í˜„ì¬: ${user.password}`;
            } else if (user.isPasswordChanged === false) {
                pwHint = 'í˜„ì¬: 123456 (ì´ˆê¸°ê°’)';
            } else {
                pwHint = 'í˜„ì¬: ë³€ê²½ë¨';
            }
            document.getElementById('editUserPassword').placeholder = pwHint;
            
            document.getElementById('userEditModal').style.display = 'flex';
        }
        
        function closeUserEditModal() {
            document.getElementById('userEditModal').style.display = 'none';
            currentEditUserId = null;
        }
        
        function resetEditPassword() {
            document.getElementById('editUserPassword').value = '123456';
        }
        
        async function deleteUserFromModal() {
            const user = users.find(u => u.id === currentEditUserId);
            if (!user) return;
            
            if (!confirm(`âš ï¸ [${user.name}] íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
            if (!confirm(`ë§ˆì§€ë§‰ í™•ì¸: [${user.userId}] ê³„ì •ì„ ì‚­ì œí•©ë‹ˆë‹¤.`)) return;
            
            try {
                const deleteUserFn = functions.httpsCallable('deleteUser');
                await deleteUserFn({ uid: currentEditUserId, adminSecret: ADMIN_SECRET });
                
                alert(`âœ… íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                closeUserEditModal();
            } catch (err) {
                console.error('íšŒì› ì‚­ì œ ì˜¤ë¥˜:', err);
                // í´ë°±: Firestoreë§Œ ì‚­ì œ
                try {
                    await db.collection('users').doc(currentEditUserId).delete();
                    alert(`âœ… íšŒì› ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    closeUserEditModal();
                } catch (e) {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
                }
            }
        }
        
        async function saveUserEdit(e) {
            e.preventDefault();
            
            const docId = document.getElementById('editUserId').value;
            const newPassword = document.getElementById('editUserPassword').value.trim();
            
            // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
            if (newPassword && newPassword.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            try {
                // ì—…ë°ì´íŠ¸í•  ë°ì´í„° ì¤€ë¹„
                const updateData = {
                    name: document.getElementById('editUserName').value.trim(),
                    phone: document.getElementById('editUserPhone').value.trim(),
                    email: document.getElementById('editUserEmail').value.trim(),
                    company: document.getElementById('editUserCompany').value.trim(),
                    jobTitle: document.getElementById('editUserJobTitle').value.trim(),
                    region: document.getElementById('editUserRegion').value,
                    type: document.getElementById('editUserType').value,
                    status: document.getElementById('editUserStatus').value,
                    regFeeStatus: document.getElementById('editRegFeeStatus').value,
                    monthlyFee: parseInt(document.getElementById('editMonthlyFee').value) || 0,
                    paidBalance: parseInt(document.getElementById('editPoints').value) || 0,
                    points: 0,  // paidBalanceë¡œ í†µì¼, ê¸°ì¡´ pointsëŠ” 0ìœ¼ë¡œ ì´ˆê¸°í™”
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì—ˆìœ¼ë©´ ë³€ê²½
                if (newPassword) {
                    try {
                        const changePassword = functions.httpsCallable('changeUserPassword');
                        await changePassword({ uid: docId, newPassword: newPassword, adminSecret: ADMIN_SECRET });
                        updateData.password = newPassword;
                        updateData.isPasswordChanged = true;
                    } catch (pwErr) {
                        console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', pwErr);
                        // í´ë°±: Firestoreë§Œ ì—…ë°ì´íŠ¸
                        updateData.password = newPassword;
                        updateData.isPasswordChanged = true;
                    }
                }
                
                // â˜… ë¬´ë£Œì‚¬ìš©ì ë™ê¸°í™”ë¥¼ ìœ„í•´ ì—…ë°ì´íŠ¸ ì „ì— oldType ì €ì¥
                const user = users.find(u => u.id === docId);
                const oldType = user ? user.type : '';
                
                // user ê°ì²´ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
                if (!user) {
                    console.error('users ë°°ì—´ì—ì„œ íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', docId);
                }
                
                // Firestore ì—…ë°ì´íŠ¸
                await db.collection('users').doc(docId).update(updateData);
                
                // â˜… ë¬´ë£Œì‚¬ìš©ì â†” admins ì»¬ë ‰ì…˜ ë™ê¸°í™”
                const newType = updateData.type;
                
                if (newType === 'ë¬´ë£Œì‚¬ìš©ì' && oldType !== 'ë¬´ë£Œì‚¬ìš©ì') {
                    // ë¬´ë£Œì‚¬ìš©ìë¡œ ë³€ê²½ë¨ â†’ adminsì— ì¶”ê°€
                    const adminData = {
                        userId: user ? user.userId : docId,
                        name: updateData.name,
                        password: updateData.password || (user ? user.password : '') || '',
                        role: 'freeuser',
                        isAdmin: false,
                        expireDate: null,  // ê´€ë¦¬ì ê´€ë¦¬ì—ì„œ ì„¤ì •
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('admins').doc(docId).set(adminData);
                    console.log('âœ… admins ì»¬ë ‰ì…˜ì— ë¬´ë£Œì‚¬ìš©ì ì¶”ê°€:', adminData.userId);
                } else if (newType !== 'ë¬´ë£Œì‚¬ìš©ì' && oldType === 'ë¬´ë£Œì‚¬ìš©ì') {
                    // ë¬´ë£Œì‚¬ìš©ìì—ì„œ ë‹¤ë¥¸ ìœ í˜•ìœ¼ë¡œ ë³€ê²½ë¨ â†’ adminsì—ì„œ ì œê±°
                    await db.collection('admins').doc(docId).delete().catch(() => {});
                    console.log('âœ… admins ì»¬ë ‰ì…˜ì—ì„œ ì œê±°:', user ? user.userId : docId);
                } else if (newType === 'ë¬´ë£Œì‚¬ìš©ì') {
                    // ë¬´ë£Œì‚¬ìš©ì ìœ ì§€ â†’ adminsì— ì—†ìœ¼ë©´ ì¶”ê°€, ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                    const adminDoc = await db.collection('admins').doc(docId).get();
                    if (adminDoc.exists) {
                        // ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸ (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
                        const adminUpdateData = {
                            name: updateData.name
                        };
                        // â˜… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì¶”ê°€
                        if (updateData.password) {
                            adminUpdateData.password = updateData.password;
                        }
                        await db.collection('admins').doc(docId).update(adminUpdateData);
                        console.log('âœ… admins ì»¬ë ‰ì…˜ ë™ê¸°í™” ì™„ë£Œ:', docId, adminUpdateData);
                    } else {
                        // ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
                        const adminData = {
                            userId: user ? user.userId : docId,
                            name: updateData.name,
                            password: updateData.password || (user ? user.password : '') || '',
                            role: 'freeuser',
                            isAdmin: false,
                            expireDate: null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        await db.collection('admins').doc(docId).set(adminData);
                        console.log('âœ… admins ì»¬ë ‰ì…˜ì— ëˆ„ë½ëœ ë¬´ë£Œì‚¬ìš©ì ì¶”ê°€:', adminData.userId);
                    }
                }
                
                alert('âœ… íšŒì› ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeUserEditModal();
                
            } catch (err) {
                console.error('íšŒì› ì •ë³´ ì €ì¥ ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        }
        
        // â˜… íšŒì› ê´€ë¦¬ ëª¨ë‹¬ (ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒ/ìˆ˜ì •, ì‚­ì œ ë“±) - ê¸°ì¡´ ìœ ì§€
        function openUserManageModal(docId) {
            const user = users.find(u => u.id === docId);
            if (!user) {
                alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
            let pwInfo = 'ë¯¸ì €ì¥';
            if (user.password) {
                pwInfo = user.password;
            } else if (user.isPasswordChanged === false) {
                pwInfo = '123456 (ì´ˆê¸°ê°’)';
            } else {
                pwInfo = 'ë³€ê²½ë¨ (í™•ì¸ë¶ˆê°€)';
            }
            
            const action = prompt(
                `[${user.name}] íšŒì› ê´€ë¦¬\n\n` +
                `ì•„ì´ë””: ${user.userId}\n` +
                `í˜„ì¬ ë¹„ë°€ë²ˆí˜¸: ${pwInfo}\n` +
                `ì—°ë½ì²˜: ${user.phone || '-'}\n` +
                `ì´ë©”ì¼: ${user.email || '-'}\n\n` +
                `ì‹¤í–‰í•  ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”:\n` +
                `1 = ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • (ì§ì ‘ ì…ë ¥)\n` +
                `2 = ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” (123456)\n` +
                `3 = íšŒì› ì‚­ì œ\n` +
                `4 = ì·¨ì†Œ`
            );
            
            if (action === '1') {
                changeUserPassword(docId, user);
            } else if (action === '2') {
                resetUserPassword(docId, user);
            } else if (action === '3') {
                deleteUser(docId, user);
            }
        }
        
        // â˜… ë¹„ë°€ë²ˆí˜¸ ì§ì ‘ ìˆ˜ì •
        async function changeUserPassword(docId, user) {
            const newPassword = prompt(
                `[${user.name}] ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥\n\n` +
                `í˜„ì¬ ì•„ì´ë””: ${user.userId}\n` +
                `í˜„ì¬ ë¹„ë°€ë²ˆí˜¸: ${user.password || 'ë¯¸ì €ì¥'}\n\n` +
                `ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (6ì ì´ìƒ):`
            );
            
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm(`ë¹„ë°€ë²ˆí˜¸ë¥¼ "${newPassword}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                // â˜… Cloud Function í˜¸ì¶œí•˜ì—¬ Firebase Auth + Firestore ë™ì‹œ ë³€ê²½
                const changePassword = functions.httpsCallable('changeUserPassword');
                const result = await changePassword({ uid: docId, newPassword: newPassword, adminSecret: ADMIN_SECRET });
                
                alert(`âœ… ë¹„ë°€ë²ˆí˜¸ê°€ "${newPassword}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì´ì œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                
            } catch (err) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', err);
                
                // Cloud Functionsê°€ ì—†ìœ¼ë©´ Firestoreë§Œ ì—…ë°ì´íŠ¸ (í´ë°±)
                if (err.code === 'functions/not-found' || err.message.includes('not found')) {
                    try {
                        await db.collection('users').doc(docId).update({
                            password: newPassword,
                            isPasswordChanged: true,
                            passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        alert(`âš ï¸ Cloud Functionsê°€ ë°°í¬ë˜ì§€ ì•Šì•„ Firestoreë§Œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
                              `ì‹¤ì œ ë¡œê·¸ì¸ì„ ìœ„í•´ Firebase Consoleì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ê±°ë‚˜,\n` +
                              `Cloud Functionsë¥¼ ë°°í¬í•´ì£¼ì„¸ìš”.`);
                    } catch (e) {
                        alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
                    }
                } else {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + (err.message || err));
                }
            }
        }
        
        // ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
        async function resetUserPassword(docId, user) {
            if (!confirm(`[${user.name}] íšŒì›ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ 123456ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                // â˜… Cloud Function í˜¸ì¶œ
                const changePassword = functions.httpsCallable('changeUserPassword');
                await changePassword({ uid: docId, newPassword: '123456', adminSecret: ADMIN_SECRET });
                
                // isPasswordChangedë¥¼ falseë¡œ ì„¤ì • (ì²« ë¡œê·¸ì¸ ì‹œ ë³€ê²½ ìœ ë„)
                await db.collection('users').doc(docId).update({
                    isPasswordChanged: false
                });
                
                alert(`âœ… ë¹„ë°€ë²ˆí˜¸ê°€ 123456ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\níšŒì›ì´ ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì„ ìš”ì²­ë°›ìŠµë‹ˆë‹¤.`);
                
            } catch (err) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
                
                // Cloud Functions ì—†ìœ¼ë©´ Firestoreë§Œ ì—…ë°ì´íŠ¸
                if (err.code === 'functions/not-found' || err.message.includes('not found')) {
                    try {
                        await db.collection('users').doc(docId).update({
                            password: '123456',
                            isPasswordChanged: false,
                            passwordResetAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert(`âš ï¸ Cloud Functionsê°€ ë°°í¬ë˜ì§€ ì•Šì•„ Firestoreë§Œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
                              `ì‹¤ì œ ë¡œê·¸ì¸ì„ ìœ„í•´ Firebase Consoleì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.`);
                    } catch (e) {
                        alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
                    }
                } else {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + (err.message || err));
                }
            }
        }
        
        // íšŒì› ì‚­ì œ
        async function deleteUser(docId, user) {
            if (!confirm(`âš ï¸ ì •ë§ë¡œ [${user.name}] íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
            if (!confirm(`ë§ˆì§€ë§‰ í™•ì¸: [${user.userId}] ê³„ì •ì„ ì‚­ì œí•©ë‹ˆë‹¤.`)) return;
            
            try {
                // â˜… Cloud Function í˜¸ì¶œ (Firebase Auth + Firestore ë™ì‹œ ì‚­ì œ)
                const deleteUserFn = functions.httpsCallable('deleteUser');
                await deleteUserFn({ uid: docId, adminSecret: ADMIN_SECRET });
                
                alert(`âœ… íšŒì›ì´ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                      
            } catch (err) {
                console.error('íšŒì› ì‚­ì œ ì˜¤ë¥˜:', err);
                
                // Cloud Functions ì—†ìœ¼ë©´ Firestoreë§Œ ì‚­ì œ
                if (err.code === 'functions/not-found' || err.message.includes('not found')) {
                    try {
                        await db.collection('users').doc(docId).delete();
                        alert(`âš ï¸ Cloud Functionsê°€ ë°°í¬ë˜ì§€ ì•Šì•„ Firestoreë§Œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
                              `Firebase Auth ê³„ì •ì€ Consoleì—ì„œ ì§ì ‘ ì‚­ì œí•´ì£¼ì„¸ìš”.`);
                    } catch (e) {
                        alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
                    }
                } else {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + (err.message || err));
                }
            }
        }

        // ==================== AI í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ====================
        let prompts = {};
        
        // í”„ë¡¬í”„íŠ¸ ë¡œë“œ
        async function loadPrompts() {
            try {
                const doc = await db.collection('settings').doc('prompts').get();
                if (doc.exists) {
                    prompts = doc.data();
                    document.getElementById('promptCompanyText').value = prompts.company || '';
                    document.getElementById('promptCeoText').value = prompts.ceo || '';
                    document.getElementById('promptGuaranteeText').value = prompts.guarantee || '';
                    document.getElementById('promptFfText').value = prompts.ff || '';
                }
            } catch (err) {
                console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', err);
            }
        }
        
        // í”„ë¡¬í”„íŠ¸ ì €ì¥
        async function savePrompt(type) {
            const textareaId = {
                'company': 'promptCompanyText',
                'ceo': 'promptCeoText',
                'guarantee': 'promptGuaranteeText',
                'ff': 'promptFfText'
            };
            
            const content = document.getElementById(textareaId[type]).value;
            
            try {
                await db.collection('settings').doc('prompts').set({
                    ...prompts,
                    [type]: content,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                prompts[type] = content;
                alert('âœ… í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (err) {
                console.error('í”„ë¡¬í”„íŠ¸ ì €ì¥ ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        }

        // ==================== ì œíœ´/ê±´ì˜ ê´€ë¦¬ ====================
        let suggestions = [];
        let suggestionPage = 1;
        const suggestionPerPage = 15;
        
        // ì œíœ´/ê±´ì˜ ë¦¬ìŠ¤ë„ˆ
        function initSuggestionsListener() {
            db.collection('suggestions').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                suggestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSuggestions();
            }, (error) => {
                console.error('suggestions ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            });
        }
        
        // ì œíœ´/ê±´ì˜ ë Œë”ë§
        function renderSuggestions() {
            const tbody = document.getElementById('suggestionTableBody');
            if (!tbody) return;
            
            // ìƒíƒœ í•„í„°
            const statusFilter = document.getElementById('suggestionStatusFilter')?.value || '';
            let filtered = suggestions;
            if (statusFilter) {
                filtered = suggestions.filter(s => s.status === statusFilter);
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">ë“±ë¡ëœ ì œíœ´/ê±´ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                document.getElementById('suggestionPagination').innerHTML = '';
                return;
            }
            
            // í˜ì´ì§€ë„¤ì´ì…˜
            const totalPages = Math.ceil(filtered.length / suggestionPerPage);
            const start = (suggestionPage - 1) * suggestionPerPage;
            const pageData = filtered.slice(start, start + suggestionPerPage);
            
            tbody.innerHTML = pageData.map((s, idx) => {
                const no = filtered.length - start - idx;
                let date = '-';
                if (s.createdAt) {
                    if (s.createdAt.toDate) {
                        date = s.createdAt.toDate().toLocaleDateString('ko-KR');
                    } else if (s.createdAt.seconds) {
                        date = new Date(s.createdAt.seconds * 1000).toLocaleDateString('ko-KR');
                    } else if (s.createdAt instanceof Date) {
                        date = s.createdAt.toLocaleDateString('ko-KR');
                    }
                }
                const statusBadge = {
                    'ëŒ€ê¸°': '<span class="badge badge-warning">ëŒ€ê¸°</span>',
                    'ê²€í† ì¤‘': '<span class="badge badge-info">ê²€í† ì¤‘</span>',
                    'ì™„ë£Œ': '<span class="badge badge-success">ì™„ë£Œ</span>'
                }[s.status] || '<span class="badge">ëŒ€ê¸°</span>';
                
                return `<tr>
                    <td>${no}</td>
                    <td><span class="badge" style="background:#6c757d;">${s.type || '-'}</span></td>
                    <td style="text-align:left; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${s.title || '-'}</td>
                    <td>${s.name || '-'}</td>
                    <td>${s.company || '-'}</td>
                    <td>${s.phone || '-'}</td>
                    <td>${date}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewSuggestion('${s.id}')">ìƒì„¸</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSuggestion('${s.id}')">ì‚­ì œ</button>
                    </td>
                </tr>`;
            }).join('');
            
            // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
            let paginationHtml = '';
            if (totalPages > 1) {
                paginationHtml += `<button ${suggestionPage === 1 ? 'disabled' : ''} onclick="suggestionPage = ${suggestionPage - 1}; renderSuggestions();">Prev</button>`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<button class="${suggestionPage === i ? 'active' : ''}" onclick="suggestionPage = ${i}; renderSuggestions();">${i}</button>`;
                }
                paginationHtml += `<button ${suggestionPage === totalPages ? 'disabled' : ''} onclick="suggestionPage = ${suggestionPage + 1}; renderSuggestions();">Next</button>`;
            }
            document.getElementById('suggestionPagination').innerHTML = paginationHtml;
        }
        
        // ì•Œë¦¼ ëª¨ë‹¬ ì—´ê¸°
        function openAlertModal(title, content) {
            document.getElementById('alertModalTitle').innerHTML = title;
            document.getElementById('alertModalBody').innerHTML = content;
            document.getElementById('alertModal').style.display = 'flex';
        }
        
        // ì•Œë¦¼ ëª¨ë‹¬ ë‹«ê¸°
        function closeAlertModal() {
            document.getElementById('alertModal').style.display = 'none';
        }
        
        // ì œíœ´/ê±´ì˜ ìƒì„¸ë³´ê¸°
        function viewSuggestion(docId) {
            const s = suggestions.find(item => item.id === docId);
            if (!s) return;
            
            let date = '-';
            if (s.createdAt) {
                if (s.createdAt.toDate) {
                    date = s.createdAt.toDate().toLocaleString('ko-KR');
                } else if (s.createdAt.seconds) {
                    date = new Date(s.createdAt.seconds * 1000).toLocaleString('ko-KR');
                } else if (s.createdAt instanceof Date) {
                    date = s.createdAt.toLocaleString('ko-KR');
                }
            }
            const fileLink = s.fileUrl ? `<a href="${s.fileUrl}" target="_blank" style="color:#3182ce;">${s.fileName || 'ì²¨ë¶€íŒŒì¼ ë³´ê¸°'}</a>` : 'ì—†ìŒ';
            
            const html = `
                <div style="padding: 1rem;">
                    <table style="width:100%; border-collapse: collapse;">
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600; width:100px;">ìœ í˜•</td><td style="padding:0.5rem;">${s.type || '-'}</td></tr>
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600;">ì œëª©</td><td style="padding:0.5rem;">${s.title || '-'}</td></tr>
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600;">ì„±ëª…</td><td style="padding:0.5rem;">${s.name || '-'}</td></tr>
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600;">íšŒì‚¬ëª…</td><td style="padding:0.5rem;">${s.company || '-'}</td></tr>
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600;">ì—°ë½ì²˜</td><td style="padding:0.5rem;">${s.phone || '-'}</td></tr>
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600;">ì´ë©”ì¼</td><td style="padding:0.5rem;">${s.email || '-'}</td></tr>
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600;">ì‘ì„±ì¼</td><td style="padding:0.5rem;">${date}</td></tr>
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600;">ì²¨ë¶€íŒŒì¼</td><td style="padding:0.5rem;">${fileLink}</td></tr>
                        <tr><td style="padding:0.5rem; background:#f8f9fa; font-weight:600; vertical-align:top;">ë‚´ìš©</td><td style="padding:0.5rem;"><pre style="white-space:pre-wrap; font-family:inherit; margin:0;">${s.content || '-'}</pre></td></tr>
                    </table>
                    <div style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">
                        <label style="font-weight:600;">ìƒíƒœ ë³€ê²½:</label>
                        <select id="suggestionStatusSelect" style="padding:0.4rem; border:1px solid #ddd; border-radius:4px;">
                            <option value="ëŒ€ê¸°" ${s.status === 'ëŒ€ê¸°' ? 'selected' : ''}>ëŒ€ê¸°</option>
                            <option value="ê²€í† ì¤‘" ${s.status === 'ê²€í† ì¤‘' ? 'selected' : ''}>ê²€í† ì¤‘</option>
                            <option value="ì™„ë£Œ" ${s.status === 'ì™„ë£Œ' ? 'selected' : ''}>ì™„ë£Œ</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="updateSuggestionStatus('${docId}')">ì €ì¥</button>
                    </div>
                </div>
            `;
            
            openAlertModal('ğŸ“® ì œíœ´/ê±´ì˜ ìƒì„¸', html);
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateSuggestionStatus(docId) {
            const newStatus = document.getElementById('suggestionStatusSelect').value;
            try {
                await db.collection('suggestions').doc(docId).update({ 
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('âœ… ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeAlertModal();
            } catch (err) {
                console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        }
        
        // ì œíœ´/ê±´ì˜ ì‚­ì œ
        async function deleteSuggestion(docId) {
            if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                // ì²¨ë¶€íŒŒì¼ì´ ìˆìœ¼ë©´ Storageì—ì„œë„ ì‚­ì œ
                const s = suggestions.find(item => item.id === docId);
                if (s && s.fileUrl) {
                    try {
                        const fileRef = firebase.storage().refFromURL(s.fileUrl);
                        await fileRef.delete();
                    } catch (e) {
                        console.log('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨ (ì´ë¯¸ ì‚­ì œë¨):', e);
                    }
                }
                
                await db.collection('suggestions').doc(docId).delete();
                alert('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (err) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        }
        
        // ==================== ê³µì§€ì‚¬í•­ ê´€ë¦¬ ====================
        let notices = [];
        
        // ê³µì§€ì‚¬í•­ ë¦¬ìŠ¤ë„ˆ
        function initNoticesListener() {
            db.collection('notices').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                notices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotices();
            }, (error) => {
                console.error('notices ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            });
        }
        
        // ê³µì§€ì‚¬í•­ ë Œë”ë§
        function renderNotices() {
            const searchEl = document.getElementById('noticeSearch');
            const tbody = document.getElementById('noticeTableBody');
            if (!tbody) return;
            
            const search = searchEl ? searchEl.value.toLowerCase() : '';
            const filtered = notices.filter(n => !search || (n.title && n.title.toLowerCase().includes(search)));
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map((n, idx) => {
                const dateStr = n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleDateString() : '-';
                const fileLink = n.fileUrl ? `<a href="${n.fileUrl}" target="_blank" class="btn btn-outline btn-sm">ğŸ“ ë³´ê¸°</a>` : '-';
                return `<tr>
                    <td>${filtered.length - idx}</td>
                    <td style="text-align:left; max-width:300px; overflow:hidden; text-overflow:ellipsis;">${n.title || '-'}</td>
                    <td>${dateStr}</td>
                    <td>${fileLink}</td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="editNotice('${n.id}')">ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteNotice('${n.id}')">ì‚­ì œ</button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        // ê³µì§€ì‚¬í•­ ëª¨ë‹¬ ì—´ê¸°
        function openNoticeModal() {
            document.getElementById('noticeModalTitle').textContent = 'ğŸ“¢ ìƒˆ ê³µì§€ ë“±ë¡';
            document.getElementById('noticeForm').reset();
            document.getElementById('noticeDocId').value = '';
            document.getElementById('noticeModal').style.display = 'flex';
        }
        
        function closeNoticeModal() {
            document.getElementById('noticeModal').style.display = 'none';
        }
        
        // ê³µì§€ì‚¬í•­ ìˆ˜ì •
        function editNotice(docId) {
            const notice = notices.find(n => n.id === docId);
            if (!notice) return;
            
            document.getElementById('noticeModalTitle').textContent = 'ğŸ“¢ ê³µì§€ ìˆ˜ì •';
            document.getElementById('noticeDocId').value = docId;
            document.getElementById('noticeTitle').value = notice.title || '';
            document.getElementById('noticeContent').value = notice.content || '';
            document.getElementById('noticeFileUrl').value = notice.fileUrl || '';
            document.getElementById('noticeModal').style.display = 'flex';
        }
        
        // ê³µì§€ì‚¬í•­ ì‚­ì œ
        async function deleteNotice(docId) {
            if (!confirm('ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await db.collection('notices').doc(docId).delete();
                alert('âœ… ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (err) {
                console.error('ê³µì§€ì‚¬í•­ ì‚­ì œ ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        }
        
        // ê³µì§€ì‚¬í•­ í¼ ì œì¶œ
        document.getElementById('noticeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const docId = document.getElementById('noticeDocId').value;
            const title = document.getElementById('noticeTitle').value.trim();
            const content = document.getElementById('noticeContent').value.trim();
            const fileUrl = document.getElementById('noticeFileUrl').value.trim();
            
            if (!title || !content) {
                alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const data = {
                    title: title,
                    content: content,
                    fileUrl: fileUrl || null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (docId) {
                    // ìˆ˜ì •
                    await db.collection('notices').doc(docId).update(data);
                    alert('âœ… ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // ì‹ ê·œ ë“±ë¡
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('notices').add(data);
                    alert('âœ… ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                closeNoticeModal();
            } catch (err) {
                console.error('ê³µì§€ì‚¬í•­ ì €ì¥ ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        });

        // ==================== ê´€ë¦¬ì ê´€ë¦¬ ====================
        let admins = [];
        
        // ê´€ë¦¬ì ë¦¬ìŠ¤ë„ˆ
        function initAdminsListener() {
            db.collection('admins').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                admins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdmins();
            }, (error) => {
                console.error('admins ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            });
        }
        
        // ê´€ë¦¬ì ë Œë”ë§
        function renderAdmins() {
            const tbody = document.getElementById('adminTableBody');
            if (!tbody) return;
            
            const roleMap = { 
                'super_admin': 'ìµœê³ ê´€ë¦¬ì', 
                'admin': 'ì¼ë°˜ê´€ë¦¬ì',
                'freeuser': 'ë¬´ë£Œì‚¬ìš©ì'
            };
            
            // â˜… í•˜ë“œì½”ë”©ëœ ê¸°ë³¸ ê´€ë¦¬ì (login.htmlì—ì„œ ì‚¬ìš©)
            const defaultAdmin = {
                userId: 'admin',
                password: 'kfpc0808',
                name: 'ê¸°ë³¸ ê´€ë¦¬ì',
                role: 'super_admin',
                isDefault: true
            };
            
            let html = `<tr style="background:#fff8e1;">
                <td><strong>${defaultAdmin.userId}</strong> <span class="badge badge-warning">ê¸°ë³¸</span></td>
                <td>${defaultAdmin.name}</td>
                <td><span class="badge badge-purple">ìµœê³ ê´€ë¦¬ì</span></td>
                <td><span style="color:#27ae60; font-weight:600;">ë¬´ì œí•œ</span></td>
                <td><span class="password-display">${defaultAdmin.password}</span></td>
                <td><span style="color:#888; font-size:0.8rem;">ì‚­ì œ ë¶ˆê°€</span></td>
            </tr>`;
            
            // Firebaseì—ì„œ ê°€ì ¸ì˜¨ ê´€ë¦¬ì ëª©ë¡ (admins ì»¬ë ‰ì…˜ + users ì»¬ë ‰ì…˜ì˜ admin)
            // users ì»¬ë ‰ì…˜ì—ì„œ admin íƒ€ì… ì‚¬ìš©ìë„ í‘œì‹œ
            const adminUsers = users.filter(u => u.type === 'admin' || u.role === 'admin' || u.isAdmin);
            
            // admins ì»¬ë ‰ì…˜ê³¼ users ì»¬ë ‰ì…˜ í•©ì¹˜ê¸° (ì¤‘ë³µ ì œê±°)
            const allAdmins = [...admins];
            adminUsers.forEach(au => {
                if (!allAdmins.find(a => a.userId === au.userId)) {
                    allAdmins.push(au);
                }
            });
            
            // â˜… í•˜ë“œì½”ë”©ëœ 'admin'ê³¼ ì¤‘ë³µë˜ëŠ” í•­ëª© ì œì™¸
            const filteredAdmins = allAdmins.filter(a => a.userId !== 'admin');
            
            if (filteredAdmins.length > 0) {
                html += filteredAdmins.map(a => {
                    const dateStr = a.createdAt ? new Date(a.createdAt.seconds * 1000).toLocaleDateString() : '-';
                    
                    // ê¶Œí•œ ë°°ì§€
                    let roleBadge = '';
                    if (a.role === 'super_admin') {
                        roleBadge = '<span class="badge badge-purple">ìµœê³ ê´€ë¦¬ì</span>';
                    } else if (a.role === 'freeuser') {
                        roleBadge = '<span class="badge badge-success" style="background:#27ae60;">ë¬´ë£Œì‚¬ìš©ì</span>';
                    } else {
                        roleBadge = '<span class="badge badge-blue">ì¼ë°˜ê´€ë¦¬ì</span>';
                    }
                    
                    // ìœ íš¨ê¸°ê°„ í‘œì‹œ
                    let expireDisplay = '<span style="color:#27ae60; font-weight:600;">ë¬´ì œí•œ</span>';
                    if (a.role === 'freeuser' && a.expireDate) {
                        const expireDate = new Date(a.expireDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (expireDate < today) {
                            expireDisplay = `<span style="color:#e74c3c; font-weight:600; text-decoration:line-through;">${a.expireDate}</span> <span class="badge badge-danger" style="font-size:0.7rem;">ë§Œë£Œ</span>`;
                        } else {
                            const diffDays = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
                            expireDisplay = `<span style="color:#1976d2; font-weight:600;">${a.expireDate}</span>`;
                            if (diffDays <= 7) {
                                expireDisplay += ` <span style="color:#f57c00; font-size:0.75rem;">(${diffDays}ì¼ ë‚¨ìŒ)</span>`;
                            }
                        }
                    }
                    
                    // â˜… ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ (í´ë¦­ ì‹œ ìˆ˜ì • ê°€ëŠ¥)
                    let pwDisplay = '-';
                    if (a.password) {
                        pwDisplay = `<span class="password-display" style="cursor:pointer;" onclick="editAdminPassword('${a.id}', '${a.userId}', '${a.password}')" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">${a.password}</span>`;
                    } else {
                        pwDisplay = `<button class="btn btn-outline btn-sm" onclick="editAdminPassword('${a.id}', '${a.userId}', '')">ì„¤ì •</button>`;
                    }
                    
                    return `<tr>
                        <td><strong>${a.userId || '-'}</strong></td>
                        <td>${a.name || '-'}</td>
                        <td>${roleBadge}</td>
                        <td>${expireDisplay}</td>
                        <td>${pwDisplay}</td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="editAdmin('${a.id}', '${a.userId}')">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAdmin('${a.id}', '${a.userId}')">ì‚­ì œ</button>
                        </td>
                    </tr>`;
                }).join('');
            }
            
            tbody.innerHTML = html;
        }
        
        // â˜… ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •
        async function editAdminPassword(docId, userId, currentPassword) {
            const newPassword = prompt(
                `[${userId}] ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •\n\n` +
                `í˜„ì¬ ë¹„ë°€ë²ˆí˜¸: ${currentPassword || 'ë¯¸ì„¤ì •'}\n\n` +
                `ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (6ì ì´ìƒ):`
            );
            
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm(`ë¹„ë°€ë²ˆí˜¸ë¥¼ "${newPassword}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                // â˜… Cloud Function í˜¸ì¶œ
                const changePassword = functions.httpsCallable('changeUserPassword');
                await changePassword({ uid: docId, newPassword: newPassword, adminSecret: ADMIN_SECRET });
                
                // admins ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸
                await db.collection('admins').doc(docId).update({
                    password: newPassword
                }).catch(() => {});
                
                // â˜… users ì»¬ë ‰ì…˜ë„ ë™ê¸°í™”
                await db.collection('users').doc(docId).update({
                    password: newPassword,
                    isPasswordChanged: true
                }).catch(() => console.log('â„¹ï¸ users ì»¬ë ‰ì…˜ì— í•´ë‹¹ ë¬¸ì„œ ì—†ìŒ'));
                
                alert(`âœ… ë¹„ë°€ë²ˆí˜¸ê°€ "${newPassword}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
            } catch (err) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', err);
                
                // Cloud Functions ì—†ìœ¼ë©´ Firestoreë§Œ ì—…ë°ì´íŠ¸
                if (err.code === 'functions/not-found' || err.message.includes('not found')) {
                    try {
                        await db.collection('admins').doc(docId).update({ password: newPassword });
                        console.log('âœ… admins ì»¬ë ‰ì…˜ ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                        
                        // â˜… users ì»¬ë ‰ì…˜ë„ ë™ê¸°í™”
                        await db.collection('users').doc(docId).update({ 
                            password: newPassword,
                            isPasswordChanged: true
                        });
                        console.log('âœ… users ì»¬ë ‰ì…˜ ë¹„ë°€ë²ˆí˜¸ ë™ê¸°í™” ì™„ë£Œ');
                        
                        alert(`âœ… Firestore ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
                              `âš ï¸ Firebase Auth ë¹„ë°€ë²ˆí˜¸ëŠ” Cloud Functions ë°°í¬ í›„ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    } catch (e) {
                        // usersì— ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš°
                        console.log('â„¹ï¸ users ì»¬ë ‰ì…˜ì— í•´ë‹¹ ë¬¸ì„œ ì—†ìŒ:', e.message);
                        alert(`âœ… Firestore ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
                              `âš ï¸ Firebase Auth ë¹„ë°€ë²ˆí˜¸ëŠ” Cloud Functions ë°°í¬ í›„ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    }
                } else {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + (err.message || err));
                }
            }
        }
        
        // ê´€ë¦¬ì ëª¨ë‹¬ ì—´ê¸°
        function openAdminModal() {
            document.getElementById('adminForm').reset();
            document.getElementById('adminUserPw').value = 'admin123';
            document.getElementById('adminRole').value = 'super_admin';
            document.getElementById('expireDateGroup').style.display = 'none';
            document.getElementById('dailyLimitGroup').style.display = 'none';  // â˜… ì¶”ê°€
            document.getElementById('adminExpireDate').value = '';
            document.getElementById('adminNoExpire').checked = false;
            document.getElementById('adminSummaryLimit').value = '';  // â˜… ì¶”ê°€
            document.getElementById('adminDetailLimit').value = '';   // â˜… ì¶”ê°€
            document.getElementById('adminModal').style.display = 'flex';
        }
        
        // ê¶Œí•œ ì„ íƒì— ë”°ë¼ ìœ íš¨ê¸°ê°„ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        function toggleExpireDateField() {
            const role = document.getElementById('adminRole').value;
            const expireGroup = document.getElementById('expireDateGroup');
            const limitGroup = document.getElementById('dailyLimitGroup');  // â˜… ì¶”ê°€
            
            if (role === 'freeuser') {
                expireGroup.style.display = 'block';
                limitGroup.style.display = 'block';  // â˜… ì¶”ê°€
                // ê¸°ë³¸ê°’: 30ì¼ í›„
                const defaultDate = new Date();
                defaultDate.setDate(defaultDate.getDate() + 30);
                document.getElementById('adminExpireDate').value = defaultDate.toISOString().split('T')[0];
            } else {
                expireGroup.style.display = 'none';
                limitGroup.style.display = 'none';  // â˜… ì¶”ê°€
            }
        }
        
        // ë¬´ì œí•œ ì²´í¬ë°•ìŠ¤ í† ê¸€
        function toggleExpireDateInput() {
            const noExpire = document.getElementById('adminNoExpire').checked;
            const dateInput = document.getElementById('adminExpireDate');
            
            if (noExpire) {
                dateInput.disabled = true;
                dateInput.value = '';
            } else {
                dateInput.disabled = false;
                // ê¸°ë³¸ê°’: 30ì¼ í›„
                const defaultDate = new Date();
                defaultDate.setDate(defaultDate.getDate() + 30);
                dateInput.value = defaultDate.toISOString().split('T')[0];
            }
        }
        
        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }
        
        // ê´€ë¦¬ì/ë¬´ë£Œì‚¬ìš©ì ìˆ˜ì •
        async function editAdmin(docId, userId) {
            try {
                const doc = await db.collection('admins').doc(docId).get();
                if (!doc.exists) {
                    alert('í•´ë‹¹ ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const data = doc.data();
                
                // ëª¨ë‹¬ì— ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('editAdminDocId').value = docId;
                document.getElementById('editAdminUserId').value = userId || data.userId || '';
                document.getElementById('editAdminName').value = data.name || '';
                document.getElementById('editAdminPassword').value = data.password || ''; // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
                document.getElementById('editAdminPassword').placeholder = data.password ? 'í˜„ì¬: ' + data.password : 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥';
                document.getElementById('editAdminRole').value = data.role || 'admin';
                
                // â˜… 1ì¼ ì œí•œ ì„¤ì • ë¡œë“œ
                document.getElementById('editAdminSummaryLimit').value = data.summaryLimit !== undefined && data.summaryLimit !== 999 ? data.summaryLimit : '';
                document.getElementById('editAdminDetailLimit').value = data.detailLimit !== undefined && data.detailLimit !== 999 ? data.detailLimit : '';
                
                // ìœ íš¨ê¸°ê°„ ì„¤ì •
                if (data.expireDate) {
                    document.getElementById('editAdminExpireDate').value = data.expireDate;
                    document.getElementById('editAdminNoExpire').checked = false;
                } else {
                    document.getElementById('editAdminExpireDate').value = '';
                    document.getElementById('editAdminNoExpire').checked = true;
                }
                
                // ìœ íš¨ê¸°ê°„ í•„ë“œ í‘œì‹œ ì—¬ë¶€
                toggleEditExpireDateField();
                toggleEditExpireDateInput();  // disabled ìƒíƒœë„ ì„¤ì •
                
                // ëª¨ë‹¬ ì—´ê¸°
                document.getElementById('adminEditModal').style.display = 'flex';
                
            } catch (err) {
                console.error('ìˆ˜ì • ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        }
        
        // ê´€ë¦¬ì ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeAdminEditModal() {
            document.getElementById('adminEditModal').style.display = 'none';
        }
        
        // ìœ íš¨ê¸°ê°„ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€ (ìˆ˜ì • ëª¨ë‹¬ìš©)
        function toggleEditExpireDateField() {
            const role = document.getElementById('editAdminRole').value;
            const group = document.getElementById('editExpireDateGroup');
            const limitGroup = document.getElementById('editDailyLimitGroup');  // â˜… ì¶”ê°€
            if (role === 'freeuser') {
                group.style.display = 'block';
                limitGroup.style.display = 'block';  // â˜… ì¶”ê°€
            } else {
                group.style.display = 'none';
                limitGroup.style.display = 'none';  // â˜… ì¶”ê°€
                document.getElementById('editAdminNoExpire').checked = true;
            }
        }
        
        // ìœ íš¨ê¸°ê°„ ì…ë ¥ í† ê¸€ (ìˆ˜ì • ëª¨ë‹¬ìš©)
        function toggleEditExpireDateInput() {
            const noExpire = document.getElementById('editAdminNoExpire').checked;
            document.getElementById('editAdminExpireDate').disabled = noExpire;
            if (noExpire) {
                document.getElementById('editAdminExpireDate').value = '';
            }
        }
        
        // ê´€ë¦¬ì ìˆ˜ì • ì €ì¥
        async function saveAdminEdit(e) {
            e.preventDefault();
            
            const docId = document.getElementById('editAdminDocId').value;
            const newName = document.getElementById('editAdminName').value.trim();
            const newPassword = document.getElementById('editAdminPassword').value.trim();
            const newRole = document.getElementById('editAdminRole').value;
            const noExpire = document.getElementById('editAdminNoExpire').checked;
            const newExpireDate = noExpire ? null : document.getElementById('editAdminExpireDate').value;
            
            // â˜… 1ì¼ ì œí•œ ì„¤ì • (ë¹„ì–´ìˆìœ¼ë©´ 999 = ë¬´ì œí•œ)
            const summaryLimitInput = document.getElementById('editAdminSummaryLimit').value.trim();
            const detailLimitInput = document.getElementById('editAdminDetailLimit').value.trim();
            const newSummaryLimit = summaryLimitInput === '' ? 999 : parseInt(summaryLimitInput);
            const newDetailLimit = detailLimitInput === '' ? 999 : parseInt(detailLimitInput);
            
            if (!newName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì—ˆê³  6ì ë¯¸ë§Œì´ë©´ ì—ëŸ¬
            if (newPassword && newPassword.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            try {
                // ê´€ë¦¬ì/ìµœê³ ê´€ë¦¬ìëŠ” expireDate í•­ìƒ null, ì œí•œë„ ë¬´ì œí•œ
                let finalExpireDate = newExpireDate;
                let finalSummaryLimit = newSummaryLimit;
                let finalDetailLimit = newDetailLimit;
                
                if (newRole !== 'freeuser') {
                    finalExpireDate = null;
                    finalSummaryLimit = 999;  // ê´€ë¦¬ìëŠ” ë¬´ì œí•œ
                    finalDetailLimit = 999;
                }
                
                // admins ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸
                const updateData = {
                    name: newName,
                    role: newRole,
                    expireDate: finalExpireDate,
                    summaryLimit: finalSummaryLimit,  // â˜… ì¶”ê°€
                    detailLimit: finalDetailLimit,    // â˜… ì¶”ê°€
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                if (newPassword) {
                    updateData.password = newPassword;
                }
                
                await db.collection('admins').doc(docId).update(updateData);
                
                // users ì»¬ë ‰ì…˜ì—ë„ ë°˜ì˜
                try {
                    const userUpdateData = {
                        name: newName,
                        expireDate: finalExpireDate
                    };
                    if (newPassword) {
                        userUpdateData.password = newPassword;
                        userUpdateData.isPasswordChanged = true;  // â˜… ì¶”ê°€
                    }
                    // ê¶Œí•œ ë³€ê²½ ì‹œ typeë„ ì—…ë°ì´íŠ¸
                    if (newRole === 'freeuser') {
                        userUpdateData.type = 'ë¬´ë£Œì‚¬ìš©ì';
                    } else {
                        // ê´€ë¦¬ìë¡œ ë³€ê²½ ì‹œ typeì„ ì´ë„ˆë¡œ ë˜ëŒë¦¼ (ì„ íƒì‚¬í•­)
                        // userUpdateData.type = 'ì´ë„ˆ';
                    }
                    await db.collection('users').doc(docId).update(userUpdateData);
                    console.log('âœ… users ì»¬ë ‰ì…˜ ë™ê¸°í™” ì™„ë£Œ:', docId, userUpdateData);
                } catch (e) {
                    console.log('â„¹ï¸ users ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸ ìƒëµ (í•´ë‹¹ ë¬¸ì„œ ì—†ìŒ):', docId);
                }
                
                // ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ëœ ê²½ìš° Firebase Authë„ ì—…ë°ì´íŠ¸ ì‹œë„
                let authPasswordChanged = false;
                if (newPassword) {
                    try {
                        const changePassword = functions.httpsCallable('changeUserPassword');
                        await changePassword({ uid: docId, newPassword: newPassword, adminSecret: ADMIN_SECRET });
                        authPasswordChanged = true;
                    } catch (pwErr) {
                        console.warn('Firebase Auth ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:', pwErr);
                        // Cloud Functions ì—†ìœ¼ë©´ ê²½ê³  í‘œì‹œ
                        alert('âš ï¸ ì£¼ì˜: Firestore ë¹„ë°€ë²ˆí˜¸ëŠ” ë³€ê²½ë˜ì—ˆìœ¼ë‚˜,\nFirebase Auth ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì‹¤ì œ ë¡œê·¸ì¸ì„ ìœ„í•´ Firebase Consoleì—ì„œ\nì§ì ‘ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.');
                    }
                }
                
                if (newPassword && authPasswordChanged) {
                    alert('âœ… ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në¹„ë°€ë²ˆí˜¸ê°€ ì •ìƒì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('âœ… ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                closeAdminEditModal();
                
            } catch (err) {
                console.error('ê´€ë¦¬ì ìˆ˜ì • ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        }
        
        // ê´€ë¦¬ì ì‚­ì œ
        async function deleteAdmin(docId, userId) {
            if (!confirm(`ê´€ë¦¬ì [${userId}]ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                // admins ì»¬ë ‰ì…˜ì—ì„œ ì‚­ì œ
                await db.collection('admins').doc(docId).delete().catch(() => {});
                
                // users ì»¬ë ‰ì…˜ì—ì„œë„ ì‚­ì œ
                await db.collection('users').doc(docId).delete().catch(() => {});
                
                alert('âœ… ê´€ë¦¬ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ Firebase Auth ê³„ì •ì€ Consoleì—ì„œ ì§ì ‘ ì‚­ì œí•´ì£¼ì„¸ìš”.');
            } catch (err) {
                console.error('ê´€ë¦¬ì ì‚­ì œ ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        }
        
        // ê´€ë¦¬ì í¼ ì œì¶œ
        document.getElementById('adminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('adminUserId').value.trim();
            const name = document.getElementById('adminUserName').value.trim();
            const password = document.getElementById('adminUserPw').value;
            const role = document.getElementById('adminRole').value;
            const noExpire = document.getElementById('adminNoExpire').checked;
            const expireDate = document.getElementById('adminExpireDate').value;
            
            // â˜… 1ì¼ ì œí•œ ì„¤ì • (ë¹„ì–´ìˆìœ¼ë©´ 999 = ë¬´ì œí•œ)
            const summaryLimitInput = document.getElementById('adminSummaryLimit').value.trim();
            const detailLimitInput = document.getElementById('adminDetailLimit').value.trim();
            const summaryLimit = summaryLimitInput === '' ? 999 : parseInt(summaryLimitInput);
            const detailLimit = detailLimitInput === '' ? 999 : parseInt(detailLimitInput);
            
            if (!userId || !name) {
                alert('ì•„ì´ë””ì™€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (password.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ë¬´ë£Œì‚¬ìš©ìì¸ë° ìœ íš¨ê¸°ê°„ì´ ì—†ê³  ë¬´ì œí•œë„ ì•„ë‹Œ ê²½ìš°
            if (role === 'freeuser' && !expireDate && !noExpire) {
                alert('ë¬´ë£Œì‚¬ìš©ìëŠ” ìœ íš¨ê¸°ê°„ì„ ì„¤ì •í•˜ê±°ë‚˜ ë¬´ì œí•œì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // 1. Firebase Authì— ì‚¬ìš©ì ìƒì„±
                const secondaryApp = firebase.initializeApp(firebaseConfig, 'SecondaryAdmin');
                const secondaryAuth = secondaryApp.auth();
                
                const authEmail = `${userId}@system.local`;
                const userCredential = await secondaryAuth.createUserWithEmailAndPassword(authEmail, password);
                const uid = userCredential.user.uid;
                
                await secondaryAuth.signOut();
                await secondaryApp.delete();
                
                // 2. admins ì»¬ë ‰ì…˜ì— ì €ì¥
                const adminData = {
                    userId: userId,
                    name: name,
                    password: password,
                    role: role,
                    isAdmin: role !== 'freeuser',  // ë¬´ë£Œì‚¬ìš©ìëŠ” ê´€ë¦¬ê¶Œí•œ ì—†ìŒ
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // ë¬´ë£Œì‚¬ìš©ìì¸ ê²½ìš° ìœ íš¨ê¸°ê°„ ë° ì œí•œ ì¶”ê°€
                if (role === 'freeuser') {
                    adminData.expireDate = noExpire ? null : expireDate;
                    adminData.summaryLimit = summaryLimit;  // â˜… ì¶”ê°€
                    adminData.detailLimit = detailLimit;    // â˜… ì¶”ê°€
                } else {
                    // ê´€ë¦¬ìëŠ” ë¬´ì œí•œ
                    adminData.summaryLimit = 999;
                    adminData.detailLimit = 999;
                }
                
                await db.collection('admins').doc(uid).set(adminData);
                
                // 3. users ì»¬ë ‰ì…˜ì—ë„ ì €ì¥
                const userData = {
                    userId: userId,
                    name: name,
                    password: password,
                    role: role === 'freeuser' ? 'freeuser' : 'admin',
                    type: role === 'freeuser' ? 'freeuser' : 'admin',
                    isAdmin: role !== 'freeuser',
                    isPasswordChanged: true,
                    status: 'active',
                    pointBalance: role === 'freeuser' ? 0 : 999999999,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (role === 'freeuser') {
                    userData.expireDate = noExpire ? null : expireDate;
                }
                
                await db.collection('users').doc(uid).set(userData);
                
                closeAdminModal();
                
                // ì„±ê³µ ë©”ì‹œì§€
                let successMsg = `âœ… ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì•„ì´ë””: ${userId}\në¹„ë°€ë²ˆí˜¸: ${password}\nê¶Œí•œ: ${role === 'freeuser' ? 'ë¬´ë£Œì‚¬ìš©ì' : (role === 'super_admin' ? 'ìµœê³ ê´€ë¦¬ì' : 'ì¼ë°˜ê´€ë¦¬ì')}`;
                
                if (role === 'freeuser') {
                    successMsg += `\nìœ íš¨ê¸°ê°„: ${noExpire ? 'ë¬´ì œí•œ' : expireDate}`;
                    // â˜… ì œí•œ ì •ë³´ ì¶”ê°€
                    const summaryLimitText = summaryLimit === 999 ? 'ë¬´ì œí•œ' : `${summaryLimit}íšŒ/ì¼`;
                    const detailLimitText = detailLimit === 999 ? 'ë¬´ì œí•œ' : `${detailLimit}íšŒ/ì¼`;
                    successMsg += `\nìš”ì•½ë¶„ì„: ${summaryLimitText}, ìƒì„¸ë¶„ì„: ${detailLimitText}`;
                } else {
                    successMsg += `\n\nì´ ê³„ì •ì€ ëª¨ë“  í”„ë¡œê·¸ë¨ì„ ë¬´ë£Œ/ë¬´ì œí•œìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                }
                
                alert(successMsg);
                
            } catch (err) {
                console.error('ê³„ì • ìƒì„± ì˜¤ë¥˜:', err);
                
                try {
                    const secondaryApp = firebase.app('SecondaryAdmin');
                    if (secondaryApp) {
                        await secondaryApp.auth().signOut();
                        await secondaryApp.delete();
                    }
                } catch(e) {}
                
                let errorMsg = 'ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
                if (err.code === 'auth/email-already-in-use') {
                    errorMsg = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';
                }
                alert(errorMsg);
            }
        });

        // ============================================================
        // ê¸°ì—…ë§ˆë‹¹ ìºì‹œ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ============================================================
        
        let cacheLogMessages = [];
        
        function addCacheLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const colors = {
                'info': '#666',
                'success': '#27ae60',
                'error': '#e74c3c',
                'warning': '#f39c12'
            };
            cacheLogMessages.unshift(`<div style="color: ${colors[type]};">[${timestamp}] ${message}</div>`);
            if (cacheLogMessages.length > 20) cacheLogMessages.pop();
            document.getElementById('cache-log').innerHTML = cacheLogMessages.join('');
        }
        
        async function refreshCacheStatus() {
            try {
                addCacheLog('ìºì‹œ ìƒíƒœ ì¡°íšŒ ì¤‘...', 'info');
                
                const getBizinfoCacheStatus = functions.httpsCallable('getBizinfoCacheStatus');
                const result = await getBizinfoCacheStatus();
                
                if (result.data.success) {
                    const status = result.data.status;
                    document.getElementById('cache-total-count').textContent = (status.totalCount || 0).toLocaleString() + 'ê°œ';
                    document.getElementById('cache-last-updated').textContent = status.lastUpdated || 'ì •ë³´ì—†ìŒ';
                    document.getElementById('cache-triggered-by').textContent = status.triggeredBy || 'ìë™ìˆ˜ì§‘';
                    addCacheLog(`ìºì‹œ ìƒíƒœ ì¡°íšŒ ì™„ë£Œ: ${status.totalCount}ê°œ ê³µê³ `, 'success');
                    
                    // ê³µê³  ëª©ë¡ë„ í•¨ê»˜ ë¡œë“œ
                    await loadCachePrograms();
                } else {
                    addCacheLog('ìºì‹œ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ' + (result.data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                }
            } catch (error) {
                console.error('ìºì‹œ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
                addCacheLog('ìºì‹œ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
        async function manualFetchBizinfo() {
            const btn = document.getElementById('btn-manual-fetch');
            const originalText = btn.innerHTML;
            
            if (!confirm('ê¸°ì—…ë§ˆë‹¹ì—ì„œ ê³µê³ ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì§‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìˆ˜ì§‘ì— 1~2ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> ìˆ˜ì§‘ ì¤‘...';
                addCacheLog('ìˆ˜ë™ ìˆ˜ì§‘ ì‹œì‘...', 'warning');
                
                // ğŸ”¥ íƒ€ì„ì•„ì›ƒ 10ë¶„ ì„¤ì • (ê¸°ë³¸ê°’ 70ì´ˆ â†’ 600ì´ˆ)
                const manualBizinfoFetch = functions.httpsCallable('manualBizinfoFetch', { timeout: 600000 });
                const result = await manualBizinfoFetch();
                
                if (result.data.success) {
                    addCacheLog(`âœ… ìˆ˜ë™ ìˆ˜ì§‘ ì™„ë£Œ: ${result.data.count}ê°œ ê³µê³  ì €ì¥`, 'success');
                    alert(`ìˆ˜ì§‘ ì™„ë£Œ!\n\n${result.data.count}ê°œ ê³µê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    refreshCacheStatus();
                } else {
                    addCacheLog('âŒ ìˆ˜ë™ ìˆ˜ì§‘ ì‹¤íŒ¨: ' + (result.data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                    alert('ìˆ˜ì§‘ ì‹¤íŒ¨: ' + (result.data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ìˆ˜ë™ ìˆ˜ì§‘ ì˜¤ë¥˜:', error);
                addCacheLog('âŒ ìˆ˜ë™ ìˆ˜ì§‘ ì˜¤ë¥˜: ' + error.message, 'error');
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function downloadCacheExcel() {
            const btn = document.getElementById('btn-download-excel');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> ì¤€ë¹„ ì¤‘...';
                addCacheLog('ì—‘ì…€ ë°ì´í„° ì¤€ë¹„ ì¤‘...', 'info');
                
                const getCachedPrograms = functions.httpsCallable('getCachedPrograms');
                const result = await getCachedPrograms();
                
                if (!result.data.success || !result.data.programs || result.data.programs.length === 0) {
                    addCacheLog('ë‹¤ìš´ë¡œë“œí•  ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    alert('ì €ì¥ëœ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € ìˆ˜ë™ ìˆ˜ì§‘ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const programs = result.data.programs;
                addCacheLog(`${programs.length}ê°œ ê³µê³  ì—‘ì…€ ë³€í™˜ ì¤‘...`, 'info');
                
                // ì—‘ì…€ìš© ë°ì´í„° ë³€í™˜
                const excelData = programs.map((p, idx) => ({
                    'ë²ˆí˜¸': idx + 1,
                    'ê³µê³ ëª…': p.name || '',
                    'ì£¼ê´€ê¸°ê´€': p.organization || '',
                    'ìˆ˜í–‰ê¸°ê´€': p.executor || '',
                    'ì§€ì›ë¶„ì•¼': p.category || '',
                    'ì§€ì›ëŒ€ìƒ': p.target || '',
                    'ì‚¬ì—…ê°œìš”': p.description || '',
                    'ì‹ ì²­ê¸°ê°„': p.applicationPeriod || '',
                    'ì ‘ìˆ˜ì¤‘': p.isOpen ? 'O' : 'X',
                    'í•´ì‹œíƒœê·¸': p.hashTags || '',
                    'ìƒì„¸URL': p.detailUrl || '',
                    'ì‹ ì²­URL': p.applicationUrl || '',
                    'ì²¨ë¶€íŒŒì¼URL': p.attachmentUrl || ''
                }));
                
                // SheetJSë¡œ ì—‘ì…€ ìƒì„±
                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ê¸°ì—…ë§ˆë‹¹ê³µê³ ');
                
                // ì—´ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 5 },   // ë²ˆí˜¸
                    { wch: 50 },  // ê³µê³ ëª…
                    { wch: 20 },  // ì£¼ê´€ê¸°ê´€
                    { wch: 20 },  // ìˆ˜í–‰ê¸°ê´€
                    { wch: 15 },  // ì§€ì›ë¶„ì•¼
                    { wch: 20 },  // ì§€ì›ëŒ€ìƒ
                    { wch: 60 },  // ì‚¬ì—…ê°œìš”
                    { wch: 25 },  // ì‹ ì²­ê¸°ê°„
                    { wch: 8 },   // ì ‘ìˆ˜ì¤‘
                    { wch: 30 },  // í•´ì‹œíƒœê·¸
                    { wch: 50 },  // ìƒì„¸URL
                    { wch: 50 },  // ì‹ ì²­URL
                    { wch: 50 }   // ì²¨ë¶€íŒŒì¼URL
                ];
                
                // ë‹¤ìš´ë¡œë“œ
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                XLSX.writeFile(wb, `ê¸°ì—…ë§ˆë‹¹ê³µê³ _${today}.xlsx`);
                
                addCacheLog(`âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${programs.length}ê°œ ê³µê³ `, 'success');
                
            } catch (error) {
                console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                addCacheLog('âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ' + error.message, 'error');
                alert('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // ë§ˆê° ê³µê³  ì‚­ì œ í•¨ìˆ˜
        async function deleteClosedPrograms() {
            const btn = document.getElementById('btn-delete-closed');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> í™•ì¸ ì¤‘...';
            
            try {
                addCacheLog('ë§ˆê° ê³µê³  ì¡°íšŒ ì¤‘...', 'info');
                
                // ëª¨ë“  ê³µê³  ê°€ì ¸ì˜¤ê¸°
                const snapshot = await db.collection('bizinfo_cache').get();
                
                let closedIds = [];
                
                snapshot.forEach(doc => {
                    if (doc.id === '_meta') return;
                    
                    const data = doc.data();
                    
                    // isOpen í•„ë“œê°€ ëª…í™•íˆ falseì¸ ê²½ìš°ë§Œ ë§ˆê°ìœ¼ë¡œ íŒë‹¨
                    if (data.isOpen === false) {
                        closedIds.push(doc.id);
                    }
                });
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (closedIds.length === 0) {
                    addCacheLog('ì‚­ì œí•  ë§ˆê° ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                    alert('ì‚­ì œí•  ë§ˆê° ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ì‚­ì œ ì „ í™•ì¸ (ê°œìˆ˜ í‘œì‹œ)
                if (!confirm(`ë§ˆê°ëœ ê³µê³  ${closedIds.length}ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    addCacheLog('ì‚­ì œ ì·¨ì†Œë¨', 'info');
                    return;
                }
                
                btn.disabled = true;
                btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> ì‚­ì œ ì¤‘...';
                
                addCacheLog(`ë§ˆê° ê³µê³  ${closedIds.length}ê°œ ì‚­ì œ ì‹œì‘...`, 'info');
                
                // Batchë¡œ ì‚­ì œ (450ê°œì”©)
                let batch = db.batch();
                let deletedCount = 0;
                
                for (const docId of closedIds) {
                    batch.delete(db.collection('bizinfo_cache').doc(docId));
                    deletedCount++;
                    
                    if (deletedCount % 450 === 0) {
                        await batch.commit();
                        addCacheLog(`${deletedCount}ê°œ ì‚­ì œ ì™„ë£Œ...`, 'info');
                        batch = db.batch();
                    }
                }
                
                await batch.commit();
                
                addCacheLog(`âœ… ë§ˆê° ê³µê³  ${deletedCount}ê°œ ì‚­ì œ ì™„ë£Œ!`, 'success');
                alert(`ë§ˆê° ê³µê³  ${deletedCount}ê°œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await refreshCacheStatus();
                
            } catch (error) {
                console.error('ë§ˆê° ê³µê³  ì‚­ì œ ì˜¤ë¥˜:', error);
                addCacheLog('âŒ ì‚­ì œ ì˜¤ë¥˜: ' + error.message, 'error');
                alert('ì‚­ì œ ì˜¤ë¥˜: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // ì „ì²´ ê³µê³  ì‚­ì œ í•¨ìˆ˜
        async function deleteAllPrograms() {
            const confirmText = prompt('âš ï¸ ê²½ê³ : ëª¨ë“  ê³µê³ ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤!\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì‚­ì œí•˜ë ¤ë©´ "ì „ì²´ì‚­ì œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (confirmText !== 'ì „ì²´ì‚­ì œ') {
                alert('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            const btn = document.getElementById('btn-delete-all');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> ì‚­ì œ ì¤‘...';
            
            try {
                addCacheLog('ì „ì²´ ê³µê³  ì‚­ì œ ì‹œì‘...', 'warning');
                
                // ëª¨ë“  ê³µê³  ê°€ì ¸ì˜¤ê¸°
                const snapshot = await db.collection('bizinfo_cache').get();
                
                let allIds = [];
                snapshot.forEach(doc => {
                    if (doc.id !== '_meta') {
                        allIds.push(doc.id);
                    }
                });
                
                if (allIds.length === 0) {
                    addCacheLog('ì‚­ì œí•  ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                    alert('ì‚­ì œí•  ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                addCacheLog(`ì „ì²´ ê³µê³  ${allIds.length}ê°œ ì‚­ì œ ì‹œì‘...`, 'warning');
                
                // Batchë¡œ ì‚­ì œ (450ê°œì”©)
                let batch = db.batch();
                let deletedCount = 0;
                
                for (const docId of allIds) {
                    batch.delete(db.collection('bizinfo_cache').doc(docId));
                    deletedCount++;
                    
                    if (deletedCount % 450 === 0) {
                        await batch.commit();
                        addCacheLog(`${deletedCount}ê°œ ì‚­ì œ ì™„ë£Œ...`, 'info');
                        batch = db.batch();
                    }
                }
                
                await batch.commit();
                
                // _meta ë¬¸ì„œë„ ì‚­ì œ
                await db.collection('bizinfo_cache').doc('_meta').delete();
                
                addCacheLog(`âœ… ì „ì²´ ê³µê³  ${deletedCount}ê°œ ì‚­ì œ ì™„ë£Œ!`, 'success');
                alert(`ì „ì²´ ê³µê³  ${deletedCount}ê°œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìˆ˜ë™ ìˆ˜ì§‘ì„ ì‹¤í–‰í•˜ì—¬ ìµœì‹  ê³µê³ ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.`);
                
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await refreshCacheStatus();
                
            } catch (error) {
                console.error('ì „ì²´ ê³µê³  ì‚­ì œ ì˜¤ë¥˜:', error);
                addCacheLog('âŒ ì‚­ì œ ì˜¤ë¥˜: ' + error.message, 'error');
                alert('ì‚­ì œ ì˜¤ë¥˜: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // ============================================================
        // ê³µê³  ëª©ë¡ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ============================================================
        
        let allCachePrograms = [];
        let filteredCachePrograms = [];
        let cacheProgramsPage = 1;
        const cacheProgramsPerPage = 15;
        
        async function loadCachePrograms() {
            try {
                addCacheLog('ê³µê³  ëª©ë¡ ë¡œë”© ì¤‘...', 'info');
                
                const getCachedPrograms = functions.httpsCallable('getCachedPrograms');
                const result = await getCachedPrograms();
                
                if (result.data.success && result.data.programs) {
                    allCachePrograms = result.data.programs;
                    filteredCachePrograms = [...allCachePrograms];
                    
                    // ë¶„ì•¼ í•„í„° ì˜µì…˜ ìƒì„±
                    const categories = [...new Set(allCachePrograms.map(p => p.category || '').filter(c => c))].sort();
                    const categorySelect = document.getElementById('cache-category-filter');
                    categorySelect.innerHTML = '<option value="">ì „ì²´ ë¶„ì•¼</option>' + 
                        categories.map(c => `<option value="${c}">${c}</option>`).join('');
                    
                    // ì£¼ê´€ê¸°ê´€ í•„í„° ì˜µì…˜ ìƒì„±
                    const orgs = [...new Set(allCachePrograms.map(p => p.organization || '').filter(o => o))].sort();
                    const orgSelect = document.getElementById('cache-org-filter');
                    orgSelect.innerHTML = '<option value="">ì „ì²´ ê¸°ê´€</option>' + 
                        orgs.slice(0, 50).map(o => `<option value="${o}">${o.length > 15 ? o.substring(0, 15) + '...' : o}</option>`).join('');
                    
                    cacheProgramsPage = 1;
                    renderCacheProgramsTable();
                    updateFilterInfo();
                    addCacheLog(`âœ… ê³µê³  ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ${allCachePrograms.length}ê°œ`, 'success');
                } else {
                    document.getElementById('cache-programs-tbody').innerHTML = 
                        '<tr><td colspan="6" style="text-align: center; color: #999; padding: 2rem;">ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ìˆ˜ì§‘ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</td></tr>';
                    addCacheLog('ê³µê³  ì—†ìŒ', 'warning');
                }
            } catch (error) {
                console.error('ê³µê³  ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                addCacheLog('âŒ ê³µê³  ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
        function filterCachePrograms() {
            const searchText = document.getElementById('cache-search').value.toLowerCase().trim();
            const category = document.getElementById('cache-category-filter').value;
            const org = document.getElementById('cache-org-filter').value;
            const status = document.getElementById('cache-status-filter').value;
            
            filteredCachePrograms = allCachePrograms.filter(p => {
                // í†µí•© ê²€ìƒ‰ (ê³µê³ ëª…, ê¸°ê´€, ì‚¬ì—…ê°œìš”, í•´ì‹œíƒœê·¸)
                const matchSearch = !searchText || 
                    (p.name || '').toLowerCase().includes(searchText) ||
                    (p.organization || '').toLowerCase().includes(searchText) ||
                    (p.executor || '').toLowerCase().includes(searchText) ||
                    (p.description || '').toLowerCase().includes(searchText) ||
                    (p.target || '').toLowerCase().includes(searchText) ||
                    (p.hashTags || '').toLowerCase().includes(searchText);
                
                // ë¶„ì•¼ í•„í„°
                const matchCategory = !category || (p.category || '') === category;
                
                // ì£¼ê´€ê¸°ê´€ í•„í„°
                const matchOrg = !org || (p.organization || '') === org;
                
                // ìƒíƒœ í•„í„° (ì ‘ìˆ˜ì¤‘/ë§ˆê°)
                let matchStatus = true;
                if (status === 'open') matchStatus = p.isOpen === true;
                else if (status === 'closed') matchStatus = p.isOpen === false;
                
                return matchSearch && matchCategory && matchOrg && matchStatus;
            });
            
            cacheProgramsPage = 1;
            renderCacheProgramsTable();
            updateFilterInfo();
        }
        
        function resetCacheFilters() {
            document.getElementById('cache-search').value = '';
            document.getElementById('cache-category-filter').value = '';
            document.getElementById('cache-org-filter').value = '';
            document.getElementById('cache-status-filter').value = '';
            filteredCachePrograms = [...allCachePrograms];
            cacheProgramsPage = 1;
            renderCacheProgramsTable();
            updateFilterInfo();
        }
        
        function updateFilterInfo() {
            const total = allCachePrograms.length;
            const filtered = filteredCachePrograms.length;
            const openCount = filteredCachePrograms.filter(p => p.isOpen).length;
            const closedCount = filtered - openCount;
            
            let infoText = `ì „ì²´ ${total.toLocaleString()}ê°œ`;
            if (filtered !== total) {
                infoText += ` ì¤‘ <strong>${filtered.toLocaleString()}ê°œ</strong> í‘œì‹œ`;
            }
            infoText += ` (ì ‘ìˆ˜ì¤‘: ${openCount}ê°œ, ë§ˆê°: ${closedCount}ê°œ)`;
            
            document.getElementById('cache-filter-info').innerHTML = infoText;
        }
        
        function renderCacheProgramsTable() {
            const tbody = document.getElementById('cache-programs-tbody');
            const startIdx = (cacheProgramsPage - 1) * cacheProgramsPerPage;
            const endIdx = startIdx + cacheProgramsPerPage;
            const pageData = filteredCachePrograms.slice(startIdx, endIdx);
            
            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999; padding: 2rem;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                document.getElementById('cache-pagination').innerHTML = '';
                return;
            }
            
            tbody.innerHTML = pageData.map((p, idx) => {
                const isOpen = p.isOpen;
                const statusBadge = isOpen 
                    ? '<span style="background: #27ae60; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">ì ‘ìˆ˜ì¤‘</span>'
                    : '<span style="background: #999; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">ë§ˆê°</span>';
                
                // ë“±ë¡ì¼ í¬ë§·íŒ…
                let regDateStr = '-';
                if (p.registeredDate) {
                    regDateStr = (p.registeredDate || '').substring(0, 10);
                }
                
                // ê³µê³ ë¬¸ ìœ ë¬´ í‘œì‹œ
                const hasPDF = p.printFileUrl || p.attachmentUrl;
                const pdfIcon = hasPDF 
                    ? '<span title="ê³µê³ ë¬¸ ìˆìŒ" style="color: #27ae60;">ğŸ“„</span>'
                    : '<span title="ê³µê³ ë¬¸ ì—†ìŒ" style="color: #ccc;">-</span>';
                
                return `<tr onclick="openProgramDetailModal('${p.id}')" style="cursor: pointer;">
                    <td>${startIdx + idx + 1}</td>
                    <td style="color: var(--accent-color); font-weight: 500;">${(p.name || '').substring(0, 50)}${(p.name || '').length > 50 ? '...' : ''}</td>
                    <td>${(p.organization || '').substring(0, 12)}${(p.organization || '').length > 12 ? '...' : ''}</td>
                    <td style="font-size: 0.8rem;">${(p.executor || '').substring(0, 12)}${(p.executor || '').length > 12 ? '...' : ''}</td>
                    <td>${p.category || '-'}</td>
                    <td style="font-size: 0.8rem;">${p.applicationPeriod || '-'}</td>
                    <td style="font-size: 0.8rem; color: #666;">${regDateStr}</td>
                    <td>${pdfIcon}</td>
                    <td>${statusBadge}</td>
                </tr>`;
            }).join('');
            
            renderCachePagination();
        }
        
        function renderCachePagination() {
            const totalPages = Math.ceil(filteredCachePrograms.length / cacheProgramsPerPage);
            const pagination = document.getElementById('cache-pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = `<span style="color: #666; font-size: 0.85rem;">ì´ ${filteredCachePrograms.length}ê°œ</span>`;
                return;
            }
            
            let html = '';
            
            // ì²˜ìŒ ë²„íŠ¼
            html += `<button class="btn btn-outline" onclick="goToCachePage(1)" ${cacheProgramsPage === 1 ? 'disabled' : ''} style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Â« ì²˜ìŒ</button>`;
            
            // ì´ì „ ë²„íŠ¼
            html += `<button class="btn btn-outline" onclick="goToCachePage(${cacheProgramsPage - 1})" ${cacheProgramsPage === 1 ? 'disabled' : ''} style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">â€¹ ì´ì „</button>`;
            
            // í˜ì´ì§€ ë²ˆí˜¸
            const startPage = Math.max(1, cacheProgramsPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="btn ${i === cacheProgramsPage ? 'btn-primary' : 'btn-outline'}" onclick="goToCachePage(${i})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">${i}</button>`;
            }
            
            // ë‹¤ìŒ ë²„íŠ¼
            html += `<button class="btn btn-outline" onclick="goToCachePage(${cacheProgramsPage + 1})" ${cacheProgramsPage === totalPages ? 'disabled' : ''} style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">ë‹¤ìŒ â€º</button>`;
            
            // ë ë²„íŠ¼
            html += `<button class="btn btn-outline" onclick="goToCachePage(${totalPages})" ${cacheProgramsPage === totalPages ? 'disabled' : ''} style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">ë Â»</button>`;
            
            html += `<span style="color: #666; font-size: 0.85rem; margin-left: 0.5rem;">${cacheProgramsPage}/${totalPages} (ì´ ${filteredCachePrograms.length}ê°œ)</span>`;
            
            pagination.innerHTML = html;
        }
        
        function goToCachePage(page) {
            const totalPages = Math.ceil(filteredCachePrograms.length / cacheProgramsPerPage);
            if (page < 1 || page > totalPages) return;
            cacheProgramsPage = page;
            renderCacheProgramsTable();
        }
        
        // ì •ë ¬ ìƒíƒœ ê´€ë¦¬
        let currentSortField = null;
        let currentSortOrder = 'asc'; // 'asc' or 'desc'
        
        function sortCachePrograms(field) {
            // ê°™ì€ í•„ë“œ í´ë¦­ ì‹œ ì •ë ¬ ë°©í–¥ í† ê¸€
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            
            // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = 'â†•';
                icon.style.color = '#999';
            });
            const activeIcon = document.getElementById('sort-' + field);
            if (activeIcon) {
                activeIcon.textContent = currentSortOrder === 'asc' ? 'â†‘' : 'â†“';
                activeIcon.style.color = 'var(--primary-color)';
            }
            
            // ì •ë ¬ ì‹¤í–‰
            filteredCachePrograms.sort((a, b) => {
                let valA, valB;
                
                if (field === 'isOpen') {
                    // ìƒíƒœ: ì ‘ìˆ˜ì¤‘(true) > ë§ˆê°(false)
                    valA = a.isOpen ? 1 : 0;
                    valB = b.isOpen ? 1 : 0;
                } else if (field === 'registeredDate' || field === 'applicationPeriod') {
                    // ë‚ ì§œ í•„ë“œ
                    valA = (a[field] || '').replace(/[^0-9]/g, '');
                    valB = (b[field] || '').replace(/[^0-9]/g, '');
                } else {
                    // ë¬¸ìì—´ í•„ë“œ
                    valA = (a[field] || '').toLowerCase();
                    valB = (b[field] || '').toLowerCase();
                }
                
                if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ì²« í˜ì´ì§€ë¡œ ì´ë™ í›„ í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
            cacheProgramsPage = 1;
            renderCacheProgramsTable();
        }
        
        function openProgramDetailModal(programId) {
            const program = allCachePrograms.find(p => p.id === programId);
            if (!program) return;
            
            const content = document.getElementById('programDetailContent');
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color); font-size: 1.1rem;">${program.name || 'ê³µê³ ëª… ì—†ìŒ'}</h4>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${program.isOpen 
                            ? '<span style="background: #27ae60; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">ì ‘ìˆ˜ì¤‘</span>'
                            : '<span style="background: #999; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">ë§ˆê°</span>'}
                        <span style="background: var(--accent-color); color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">${program.category || 'ë¶„ì•¼ ì—†ìŒ'}</span>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.7rem; font-weight: 600; color: #666; width: 100px;">ì£¼ê´€ê¸°ê´€</td>
                        <td style="padding: 0.7rem;">${program.organization || '-'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.7rem; font-weight: 600; color: #666;">ìˆ˜í–‰ê¸°ê´€</td>
                        <td style="padding: 0.7rem;">${program.executor || '-'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.7rem; font-weight: 600; color: #666;">ì§€ì›ëŒ€ìƒ</td>
                        <td style="padding: 0.7rem;">${program.target || '-'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.7rem; font-weight: 600; color: #666;">ì‹ ì²­ê¸°ê°„</td>
                        <td style="padding: 0.7rem;">${program.applicationPeriod || '-'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.7rem; font-weight: 600; color: #666; vertical-align: top;">ì‚¬ì—…ê°œìš”</td>
                        <td style="padding: 0.7rem; line-height: 1.6;">${program.description || '-'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.7rem; font-weight: 600; color: #666;">í•´ì‹œíƒœê·¸</td>
                        <td style="padding: 0.7rem;">${program.hashTags || '-'}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.7rem; font-weight: 600; color: #666;">ì¡°íšŒìˆ˜</td>
                        <td style="padding: 0.7rem;">${(program.views || 0).toLocaleString()}íšŒ</td>
                    </tr>
                    ${program.attachmentUrl ? `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.7rem; font-weight: 600; color: #666;">ì²¨ë¶€íŒŒì¼</td>
                        <td style="padding: 0.7rem;"><a href="${program.attachmentUrl}" target="_blank" style="color: var(--accent-color);">ğŸ“ ${program.attachmentName || 'ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ'}</a></td>
                    </tr>` : ''}
                </table>
            `;
            
            const detailLink = document.getElementById('programDetailLink');
            // detailUrlì´ ìˆê³  httpë¡œ ì‹œì‘í•˜ëŠ” ìœ íš¨í•œ URLì¸ ê²½ìš°ë§Œ í‘œì‹œ
            let validDetailUrl = null;
            if (program.detailUrl && program.detailUrl.startsWith('http')) {
                validDetailUrl = program.detailUrl;
            } else if (program.id) {
                // detailUrlì´ ì—†ìœ¼ë©´ ê¸°ì—…ë§ˆë‹¹ ê¸°ë³¸ URLë¡œ ìƒì„±
                validDetailUrl = `https://www.bizinfo.go.kr/web/lay1/bbs/S1T122C128/AS/74/view.do?pblancId=${program.id}`;
            }
            
            if (validDetailUrl) {
                detailLink.href = validDetailUrl;
                detailLink.style.display = 'inline-flex';
            } else {
                detailLink.style.display = 'none';
            }
            
            document.getElementById('programDetailModal').style.display = 'flex';
        }

        // ============================================================
        // API ì‚¬ìš©í˜„í™© (ì •ë¶€ì§€ì›ìê¸ˆ) ê´€ë ¨ í•¨ìˆ˜
        // ============================================================
        
        // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ
        function getKoreanToday() {
            const now = new Date();
            const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
            return koreaTime.toISOString().split('T')[0];
        }
        
        // ì˜¤ëŠ˜ API ì‚¬ìš©í˜„í™© ë¡œë“œ
        async function loadApiUsage() {
            const today = getKoreanToday();
            document.getElementById('usage-date-filter').value = today;
            await loadApiUsageByDate();
        }
        
        // íŠ¹ì • ë‚ ì§œ API ì‚¬ìš©í˜„í™© ë¡œë“œ
        async function loadApiUsageByDate() {
            const dateFilter = document.getElementById('usage-date-filter').value;
            if (!dateFilter) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('usage-date').textContent = dateFilter;
            document.getElementById('apiUsageBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;"><i class="ph ph-spinner ph-spin"></i> ë¡œë”© ì¤‘...</td></tr>';
            
            try {
                // 1. userUsage ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ ë‚ ì§œ ë°ì´í„° ì¡°íšŒ
                const usageSnapshot = await db.collection('userUsage')
                    .where('date', '==', dateFilter)
                    .get();
                
                if (usageSnapshot.empty) {
                    document.getElementById('usage-user-count').textContent = '0';
                    document.getElementById('usage-summary-total').textContent = '0';
                    document.getElementById('usage-detail-total').textContent = '0';
                    document.getElementById('apiUsageBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999; padding: 2rem;">í•´ë‹¹ ë‚ ì§œì— ì‚¬ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                
                // 2. ì‚¬ìš©ì ì •ë³´ì™€ í•¨ê»˜ ë°ì´í„° ì¡°í•©
                const usageData = [];
                let totalSummary = 0;
                let totalDetail = 0;
                
                for (const doc of usageSnapshot.docs) {
                    const uid = doc.id;
                    const data = doc.data();
                    
                    // users ì»¬ë ‰ì…˜ì—ì„œ íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    let userName = 'ì‚­ì œíšŒì›';
                    let userEmail = '(ì‚­ì œë¨)';
                    
                    try {
                        const userDoc = await db.collection('users').doc(uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            userName = userData.name || userData.displayName || '-';
                            userEmail = userData.email || userData.id || uid;
                        }
                    } catch (e) {
                        console.warn('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', uid, e);
                    }
                    
                    const summaryCount = data.summaryCount || 0;
                    const detailCount = data.detailCount || 0;
                    
                    usageData.push({
                        uid,
                        userName,
                        userEmail,
                        summaryCount,
                        detailCount,
                        total: summaryCount + detailCount
                    });
                    
                    totalSummary += summaryCount;
                    totalDetail += detailCount;
                }
                
                // 3. í•©ê³„ ê¸°ì¤€ ì •ë ¬ (ë§ì´ ì‚¬ìš©í•œ ìˆœ)
                usageData.sort((a, b) => b.total - a.total);
                
                // 4. ìš”ì•½ ì •ë³´ í‘œì‹œ
                document.getElementById('usage-user-count').textContent = usageData.length + 'ëª…';
                document.getElementById('usage-summary-total').textContent = totalSummary + 'íšŒ';
                document.getElementById('usage-detail-total').textContent = totalDetail + 'íšŒ';
                
                // 5. í…Œì´ë¸” ë Œë”ë§
                let html = '';
                usageData.forEach((item, index) => {
                    const isMaxed = item.summaryCount >= 10 || item.detailCount >= 10;
                    const statusBadge = isMaxed 
                        ? '<span style="background: #ffebee; color: #c62828; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">í•œë„ë„ë‹¬</span>'
                        : '<span style="background: #e8f5e9; color: #2e7d32; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">ì •ìƒ</span>';
                    
                    html += `
                        <tr>
                            <td style="text-align: center;">${index + 1}</td>
                            <td>${item.userName}</td>
                            <td style="font-size: 0.85rem; color: #666;">${item.userEmail}</td>
                            <td style="text-align: center; font-weight: 600; color: #f57c00;">${item.summaryCount} / 10</td>
                            <td style="text-align: center; font-weight: 600; color: #e91e63;">${item.detailCount} / 10</td>
                            <td style="text-align: center; font-weight: 700;">${item.total}</td>
                            <td style="text-align: center;">${statusBadge}</td>
                        </tr>
                    `;
                });
                
                document.getElementById('apiUsageBody').innerHTML = html || '<tr><td colspan="7" style="text-align: center; color: #999; padding: 2rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                
            } catch (error) {
                console.error('API ì‚¬ìš©í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('apiUsageBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #e74c3c; padding: 2rem;">ì˜¤ë¥˜: ' + error.message + '</td></tr>';
            }
        }
        
        // API ì‚¬ìš©í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function exportApiUsageToExcel() {
            const table = document.getElementById('apiUsageTable');
            if (!table) return;
            
            const dateFilter = document.getElementById('usage-date-filter').value || getKoreanToday();
            const wb = XLSX.utils.table_to_book(table, { sheet: "APIì‚¬ìš©í˜„í™©" });
            XLSX.writeFile(wb, `APIì‚¬ìš©í˜„í™©_${dateFilter}.xlsx`);
        }

        // ì´ˆê¸°í™”
        window.onload = function() {
            try {
                console.log('âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
                
                // ìƒë‹¨ ë°” ë‚ ì§œ ì„¤ì •
                document.getElementById('topBarDate').textContent = new Date().toLocaleDateString('ko-KR', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                
                // â˜… ê´€ë¦¬ì ì¸ì¦ ì²´í¬ í›„ Firebase ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                checkAdminAndInitialize();
                
                // â˜… íšŒì› ìˆ˜ì • í¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                document.getElementById('userEditForm').addEventListener('submit', saveUserEdit);
                
                // â˜… ì˜ìƒìë£Œì‹¤ ë¡œë“œ
                loadVideoLinks();
                
            } catch(e) {
                console.error('window.onload ì˜¤ë¥˜:', e);
            }
        }
    </script>
</body>
</html>