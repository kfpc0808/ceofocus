<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Executive Consulting Solution</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            color: #333;
        }

        /* ê³µí†µ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .container-box {
            background: white;
            padding: 2.5rem 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            animation: fadeIn 0.5s ease-out;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #0c2c54;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }

        .subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 2rem;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #0c2c54;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* ê¸°ë³¸ ì¸í’‹ ìŠ¤íƒ€ì¼ */
        input, select {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
            background: #fff;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2a5a8a;
        }

        /* ë¶„í• ëœ ì¸í’‹ ê·¸ë£¹ (ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, ì†Œì†/ì§í•¨) */
        .input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .input-group select {
            padding-right: 1.5rem; /* í™”ì‚´í‘œ ê³µê°„ */
        }

        /* ì „í™”ë²ˆí˜¸ ìŠ¤íƒ€ì¼ */
        .phone-group select { width: 30%; }
        .phone-group input { width: 35%; text-align: center; }
        .phone-group span { font-weight: bold; color: #999; }

        /* ì´ë©”ì¼ ìŠ¤íƒ€ì¼ */
        .email-group input { flex: 1; }
        .email-group select { flex: 1; }
        .email-group span { font-weight: bold; color: #999; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            background: #0c2c54;
            color: white;
        }

        .btn:active { transform: scale(0.98); }
        
        .btn-secondary {
            background: #fff;
            color: #0c2c54;
            border: 2px solid #0c2c54;
            margin-top: 0.5rem;
        }
        
        .btn-back {
            background: transparent;
            color: #666;
            font-size: 0.9rem;
            margin-top: 1rem;
            font-weight: normal;
        }

        .divider {
            text-align: center;
            margin: 1.5rem 0 1rem;
            color: #6c757d;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        .divider::before, .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #dee2e6;
        }
        .divider::before { margin-right: 10px; }
        .divider::after { margin-left: 10px; }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            white-space: pre-line;
            font-size: 0.9rem;
            text-align: center;
        }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.success { background: #d4edda; color: #155724; }
        .message.info { background: #e7f3ff; color: #0c2c54; }

        .hidden { display: none !important; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(12, 44, 84, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
        .dashboard-container {
            max-width: 800px;
            text-align: center;
        }
        .dashboard-menu {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }
        .menu-item {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: 0.3s;
        }
        .menu-item:hover {
            background: #e7f3ff;
            border-color: #2a5a8a;
        }
        .logout-btn {
            background: #6c757d;
            margin-top: 2rem;
        }
        small {
            color: #666;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }
        
        /* ê³„ì¢Œ ì •ë³´ ë°•ìŠ¤ */
        .account-info-box {
            background: #f1f8ff;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.25rem;
            border: 1px solid #d0e6fd;
        }
        .account-info-title {
            color: #0c2c54;
            font-weight: 700;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }
        .account-info-detail {
            color: #555;
            font-size: 0.9rem;
        }

        /* ì»¤ìŠ¤í…€ íŒì—… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.2s;
        }
        .custom-modal {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: scale(0.9);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn {
            to { transform: scale(1); }
        }
        .custom-modal h3 {
            color: #e74c3c;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        .custom-modal p {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            line-height: 1.4;
        }
        .custom-modal button {
            background: #0c2c54;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ íŒì—… -->
    <div class="custom-modal-overlay" id="customAlert">
        <div class="custom-modal">
            <h3>âš ï¸ ì…ë ¥ í™•ì¸</h3>
            <p id="customAlertMsg">ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <button onclick="closeCustomAlert()">í™•ì¸</button>
        </div>
    </div>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginView" class="container-box">
        <h1>ğŸ” ë¡œê·¸ì¸</h1>
        <p class="subtitle">Executive Consulting Solution</p>
        
        <div id="loginMessage" class="message"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label>ì•„ì´ë”” (ID)</label>
                <input type="text" id="userId" placeholder="ë³¸ì‚¬ì—ì„œ ì œê³µë°›ì€ ì•„ì´ë””" required autocomplete="username">
            </div>
            
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="userPw" placeholder="ì œê³µë°›ì€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required autocomplete="current-password">
            </div>
            
            <button type="submit" class="btn">ë¡œê·¸ì¸</button>
        </form>
        
        <div class="divider">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</div>
        
        <button type="button" class="btn btn-secondary" onclick="switchView('signup')">íšŒì›ê°€ì… ì‹ ì²­í•˜ê¸°</button>
        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
            * ì‹ ì²­í•˜ì‹œë©´ ë³¸ì‚¬ í™•ì¸ í›„ ì•„ì´ë””ë¥¼ ë°œê¸‰í•´ë“œë¦½ë‹ˆë‹¤.
        </div>
    </div>

    <!-- 2. íšŒì›ê°€ì… ì‹ ì²­ í™”ë©´ -->
    <div id="signupView" class="container-box hidden">
        <h1>ğŸ“ íšŒì›ê°€ì… ì‹ ì²­</h1>
        <p class="subtitle">ëª¨ë“  í•­ëª©ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.<br>ì •í™•í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        
        <div id="signupMessage" class="message"></div>

        <form id="signupForm" novalidate>
            <!-- ì„±ëª… -->
            <div class="form-group">
                <label>ì„±ëª… <span style="color:red">*</span></label>
                <input type="text" id="regName" placeholder="í™ê¸¸ë™">
            </div>

            <!-- ì—°ë½ì²˜ -->
            <div class="form-group">
                <label>ì—°ë½ì²˜ <span style="color:red">*</span></label>
                <div class="input-group phone-group">
                    <select id="phone1">
                        <option value="010" selected>010</option>
                        <option value="011">011</option>
                        <option value="016">016</option>
                        <option value="017">017</option>
                        <option value="018">018</option>
                        <option value="019">019</option>
                    </select>
                    <span>-</span>
                    <input type="tel" id="phone2" maxlength="4" inputmode="numeric" placeholder="1234" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <span>-</span>
                    <input type="tel" id="phone3" maxlength="4" inputmode="numeric" placeholder="5678" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
            </div>

            <!-- ì´ë©”ì¼ -->
            <div class="form-group">
                <label>ì´ë©”ì¼ <span style="color:red">*</span></label>
                <div class="input-group email-group">
                    <input type="text" id="emailId" placeholder="example" inputmode="email">
                    <span>@</span>
                    <select id="emailDomainSelect" onchange="toggleCustomDomain(this)">
                        <option value="">ì„ íƒ</option>
                        <option value="naver.com">naver.com</option>
                        <option value="gmail.com">gmail.com</option>
                        <option value="daum.net">daum.net</option>
                        <option value="nate.com">nate.com</option>
                        <option value="custom">ì§ì ‘ì…ë ¥</option>
                    </select>
                </div>
                <input type="text" id="emailCustomDomain" placeholder="ë„ë©”ì¸ ì…ë ¥ (ì˜ˆ: company.com)" class="hidden" style="margin-top: 0.5rem;">
            </div>

            <!-- ì†Œì†/ì§í•¨ -->
            <div class="form-group">
                <label>ì†Œì† / ì§í•¨ <span style="color:red">*</span></label>
                <div class="input-group">
                    <input type="text" id="regCompany" placeholder="í•œêµ­ìƒëª…">
                    <input type="text" id="regPosition" placeholder="ë§¤ë‹ˆì €">
                </div>
            </div>

            <!-- ì§€ì—­ -->
            <div class="form-group">
                <label>ì§€ì—­ <span style="color:red">*</span></label>
                <select id="regRegion">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ì„œìš¸">ì„œìš¸</option>
                    <option value="ê²½ê¸°">ê²½ê¸°</option>
                    <option value="ì¸ì²œ">ì¸ì²œ</option>
                    <option value="ê°•ì›">ê°•ì›</option>
                    <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                    <option value="ì¶©ë¶">ì¶©ë¶</option>
                    <option value="ëŒ€ì „">ëŒ€ì „</option>
                    <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                    <option value="ê²½ë¶">ê²½ë¶</option>
                    <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                    <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                    <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                    <option value="ì „ë‚¨">ì „ë‚¨</option>
                    <option value="ì „ë¶">ì „ë¶</option>
                    <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                    <option value="ì œì£¼">ì œì£¼</option>
                </select>
            </div>

            <!-- ê³„ì¢Œ ì •ë³´ -->
            <div class="account-info-box">
                <div class="account-info-title">[ì†¡ê¸ˆê³„ì¢Œ] êµ­ë¯¼ 378801-01-062695</div>
                <div class="account-info-detail">ì˜ˆê¸ˆì£¼: (ì£¼)í•œêµ­FPì„¼í„°</div>
            </div>

            <button type="submit" class="btn">ì‹ ì²­ì„œ ì œì¶œí•˜ê¸°</button>
            <button type="button" class="btn btn-back" onclick="switchView('login')">â† ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </form>
    </div>

    <!-- 3. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ -->
    <div id="changePwView" class="container-box hidden">
        <h1>ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h1>
        <p class="subtitle">ì•ˆì „í•œ ì‚¬ìš©ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.</p>
        
        <div class="message info" style="display: block;">
            âš ï¸ ìµœì´ˆ ë¡œê·¸ì¸ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì•¼ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        <div id="pwMessage" class="message"></div>

        <form id="changePwForm">
            <div class="form-group">
                <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="newPw" placeholder="ì˜ë¬¸, ìˆ«ì í¬í•¨ 6ì ì´ìƒ" required minlength="6">
            </div>
            
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="confirmPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥" required minlength="6">
            </div>
            
            <button type="submit" class="btn">ë³€ê²½í•˜ê³  ì‹œì‘í•˜ê¸°</button>
        </form>
    </div>

    <!-- 4. ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div id="mainView" class="container-box dashboard-container hidden">
        <h1>ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤!</h1>
        <p class="subtitle" id="welcomeText">Executive Consulting Solution ë©”ì¸í™”ë©´</p>
        
        <div class="message success" style="display: block;">
            âœ… ë¡œê·¸ì¸ ë° ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>

        <div class="dashboard-menu">
            <div class="menu-item">
                <h3>ğŸ“Š ê²½ì˜ ì§„ë‹¨</h3>
                <p>ê¸°ì—… ê²½ì˜ ìƒíƒœ ë¶„ì„</p>
            </div>
            <div class="menu-item">
                <h3>ğŸ“ ì»¨ì„¤íŒ… ë³´ê³ ì„œ</h3>
                <p>ë³´ê³ ì„œ ì‘ì„± ë° ê´€ë¦¬</p>
            </div>
            <div class="menu-item">
                <h3>ğŸ‘¥ ê³ ê° ê´€ë¦¬</h3>
                <p>ê³ ê° ì •ë³´ ë° ìƒë‹´ ì´ë ¥</p>
            </div>
            <div class="menu-item">
                <h3>âš™ï¸ ì„¤ì •</h3>
                <p>ê³„ì • ë° ì‹œìŠ¤í…œ ì„¤ì •</p>
            </div>
        </div>

        <button onclick="logout()" class="btn logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // --- 1. Firebase ì„¤ì • ë° ì´ˆê¸°í™” ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
            authDomain: "kfpc-company-support-project.firebaseapp.com",
            databaseURL: "https://kfpc-company-support-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kfpc-company-support-project",
            storageBucket: "kfpc-company-support-project.firebasestorage.app",
            messagingSenderId: "101260933373",
            appId: "1:101260933373:web:3436176f9ca2560056d914"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. ìƒíƒœ ê´€ë¦¬ ë° UI ì œì–´ ---
        const views = {
            login: document.getElementById('loginView'),
            signup: document.getElementById('signupView'),
            changePw: document.getElementById('changePwView'),
            main: document.getElementById('mainView')
        };
        const loading = document.getElementById('loadingOverlay');
        const customAlertOverlay = document.getElementById('customAlert');
        const customAlertMsg = document.getElementById('customAlertMsg');
        let alertFocusTarget = null;

        function showLoading() { loading.style.display = 'flex'; }
        function hideLoading() { loading.style.display = 'none'; }
        
        function showCustomAlert(msg, elementIdToFocus) {
            customAlertMsg.innerHTML = msg;
            customAlertOverlay.style.display = 'flex';
            if (elementIdToFocus) {
                alertFocusTarget = document.getElementById(elementIdToFocus);
            } else {
                alertFocusTarget = null;
            }
        }

        window.closeCustomAlert = function() {
            customAlertOverlay.style.display = 'none';
            if (alertFocusTarget) {
                alertFocusTarget.focus();
            }
        };

        function switchView(viewName) {
            document.querySelectorAll('.message').forEach(el => el.style.display = 'none');
            document.querySelectorAll('form').forEach(form => form.reset());
            document.getElementById('emailCustomDomain').classList.add('hidden');
            
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        }

        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message ${type}`;
            el.style.display = 'block';
        }

        window.toggleCustomDomain = function(select) {
            const customInput = document.getElementById('emailCustomDomain');
            if (select.value === 'custom') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        };

        // --- 3. ë¡œê·¸ì¸ ë¡œì§ (ê´€ë¦¬ì ì ‘ì† ê¸°ëŠ¥ ì¶”ê°€ë¨) ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('userId').value.trim();
            const userPw = document.getElementById('userPw').value.trim();

            if (!userId) {
                showCustomAlert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "userId");
                return;
            }
            if (!userPw) {
                showCustomAlert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "userPw");
                return;
            }

            // [ê´€ë¦¬ì ì ‘ì† ì²´í¬]
            if (userId === 'admin' && userPw === 'kfpc0808') {
                sessionStorage.setItem('adminLoggedIn', 'true');
                alert('ê´€ë¦¬ì ëª¨ë“œë¡œ ì ‘ì†í•©ë‹ˆë‹¤.');
                window.location.href = 'admin.html'; // ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™
                return;
            }

            // ì¼ë°˜ íšŒì› ë¡œê·¸ì¸ ì§„í–‰
            showLoading();
            
            try {
                const email = `${userId}@system.local`;
                const userCredential = await auth.signInWithEmailAndPassword(email, userPw);
                const user = userCredential.user;
                checkUserStatus(user);

            } catch (error) {
                console.error('Login Error:', error);
                hideLoading();
                let msg = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    msg = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
                showMessage('loginMessage', msg, 'error');
            }
        });

        // --- 4. íšŒì›ê°€ì… ì‹ ì²­ ë¡œì§ ---
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('regName').value.trim();
            const phone1 = document.getElementById('phone1').value;
            const phone2 = document.getElementById('phone2').value.trim();
            const phone3 = document.getElementById('phone3').value.trim();
            const emailId = document.getElementById('emailId').value.trim();
            const emailDomainSelect = document.getElementById('emailDomainSelect').value;
            const emailCustomDomain = document.getElementById('emailCustomDomain').value.trim();
            const company = document.getElementById('regCompany').value.trim();
            const position = document.getElementById('regPosition').value.trim();
            const region = document.getElementById('regRegion').value;

            if (!name) { showCustomAlert("ì„±ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "regName"); return; }
            if (!phone2) { showCustomAlert("ì—°ë½ì²˜(ê°€ìš´ë° ìë¦¬)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "phone2"); return; }
            if (!phone3) { showCustomAlert("ì—°ë½ì²˜(ë ìë¦¬)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "phone3"); return; }
            if (phone2.length < 3 || phone3.length < 4) { showCustomAlert("ì˜¬ë°”ë¥¸ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "phone2"); return; }
            if (!emailId) { showCustomAlert("ì´ë©”ì¼ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "emailId"); return; }
            if (!emailDomainSelect) { showCustomAlert("ì´ë©”ì¼ ë„ë©”ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "emailDomainSelect"); return; }
            if (emailDomainSelect === 'custom' && !emailCustomDomain) { showCustomAlert("ì´ë©”ì¼ ë„ë©”ì¸ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", "emailCustomDomain"); return; }
            if (!company) { showCustomAlert("ì†Œì†ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "regCompany"); return; }
            if (!position) { showCustomAlert("ì§í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "regPosition"); return; }
            if (!region) { showCustomAlert("ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "regRegion"); return; }

            const fullPhone = `${phone1}${phone2}${phone3}`;
            const finalDomain = (emailDomainSelect === 'custom') ? emailCustomDomain : emailDomainSelect;
            const fullEmail = `${emailId}@${finalDomain}`;

            showLoading();

            try {
                if (!auth.currentUser) {
                     // í•„ìš”ì‹œ ìµëª… ë¡œê·¸ì¸
                }

                await db.collection('account_requests').add({
                    name: name,
                    phone: fullPhone,
                    email: fullEmail,
                    company: company,
                    position: position,
                    region: region,
                    status: 'pending',
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoading();
                alert('âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\në‹´ë‹¹ìê°€ í™•ì¸ í›„ ì…ë ¥í•˜ì‹  ì—°ë½ì²˜ë¡œ\nì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.');
                switchView('login');

            } catch (error) {
                console.error('Signup Request Error:', error);
                hideLoading();
                showMessage('signupMessage', 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        });

        // --- 5. ì‚¬ìš©ì ìƒíƒœ í™•ì¸ ---
        async function checkUserStatus(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                const userData = userDoc.data();
                
                // Firestore roleì´ adminì¸ ê²½ìš°ì—ë„ ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™
                if (userData.role === 'admin') {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    window.location.href = 'admin.html';
                    return;
                }

                if (!userData.isPasswordChanged) {
                    hideLoading();
                    switchView('changePw');
                } else {
                    enterMainPage(userData);
                }

            } catch (error) {
                console.error(error);
                auth.signOut();
                hideLoading();
                showMessage('loginMessage', 'ê³„ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // --- 6. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ---
        document.getElementById('changePwForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPw = document.getElementById('newPw').value;
            const confirmPw = document.getElementById('confirmPw').value;
            const user = auth.currentUser;

            if (!user) {
                alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.reload();
                return;
            }

            if (newPw !== confirmPw) {
                showMessage('pwMessage', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (newPw.length < 6) {
                showMessage('pwMessage', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            showLoading();

            try {
                await user.updatePassword(newPw);
                await db.collection('users').doc(user.uid).update({
                    isPasswordChanged: true,
                    passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');
                const updatedDoc = await db.collection('users').doc(user.uid).get();
                enterMainPage(updatedDoc.data());

            } catch (error) {
                console.error('Password Change Error:', error);
                hideLoading();
                showMessage('pwMessage', 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        function enterMainPage(userData) {
            hideLoading();
            switchView('main');
            const name = userData.name || userData.userId || 'íšŒì›';
            document.getElementById('welcomeText').textContent = `${name}ë‹˜, ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”!`;
        }

        window.logout = function() {
            auth.signOut().then(() => {
                window.location.reload();
            });
        };
    </script>
</body>
</html>