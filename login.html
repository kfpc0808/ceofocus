<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Executive Consulting Solution</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #0c2c54 0%, #2a5a8a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            color: #333;
        }

        /* ê³µí†µ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .container-box {
            background: white;
            padding: 2rem 1.5rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 420px; /* ëª¨ë°”ì¼ ìµœì í™” í­ */
            animation: fadeIn 0.5s ease-out;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #0c2c54;
            margin-bottom: 0.25rem;
            font-size: 1.5rem; /* í°íŠ¸ ì‚¬ì´ì¦ˆ ì¶•ì†Œ */
        }

        .subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 1.25rem; /* ì—¬ë°± ì¶•ì†Œ */
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* í¼ ê·¸ë£¹ ê°„ê²© ì¶•ì†Œ */
        .form-group {
            margin-bottom: 0.8rem;
        }

        label {
            display: block;
            margin-bottom: 0.3rem;
            color: #0c2c54;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* ê¸°ë³¸ ì¸í’‹ ìŠ¤íƒ€ì¼ - ë†’ì´ ì¶•ì†Œ */
        input, select {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
            background: #fff;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2a5a8a;
        }

        /* 2ë‹¨ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ëª¨ë°”ì¼ ê³µê°„ ì ˆì•½ìš©) */
        .row-group {
            display: flex;
            gap: 0.5rem;
        }
        .row-group > div {
            flex: 1;
        }

        /* ë¶„í• ëœ ì¸í’‹ ê·¸ë£¹ */
        .input-group {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }
        
        .input-group select { padding-right: 1.2rem; }

        /* ì „í™”ë²ˆí˜¸ ìŠ¤íƒ€ì¼ */
        .phone-group select { width: 30%; padding: 0.6rem 0.2rem; text-align: center; }
        .phone-group input { width: 35%; text-align: center; padding: 0.6rem 0.2rem; }
        .phone-group span { font-weight: bold; color: #ccc; font-size: 0.8rem; }

        /* ì´ë©”ì¼ ìŠ¤íƒ€ì¼ */
        .email-group input { flex: 1; padding: 0.6rem; }
        .email-group select { flex: 1; padding: 0.6rem; }
        .email-group span { font-weight: bold; color: #ccc; font-size: 0.9rem; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 0.8rem;
            background: #0c2c54;
            color: white;
        }

        .btn:active { transform: scale(0.98); }
        
        .btn-secondary {
            background: #fff;
            color: #0c2c54;
            border: 2px solid #0c2c54;
            margin-top: 0.5rem;
        }
        
        .btn-back {
            background: transparent;
            color: #666;
            font-size: 0.85rem;
            margin-top: 0.8rem;
            font-weight: normal;
            padding: 0.5rem;
        }

        .divider {
            text-align: center;
            margin: 1.2rem 0 0.8rem;
            color: #6c757d;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
        }
        .divider::before, .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #dee2e6;
        }
        .divider::before { margin-right: 10px; }
        .divider::after { margin-left: 10px; }

        .message {
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            white-space: pre-line;
            font-size: 0.85rem;
            text-align: center;
        }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.success { background: #d4edda; color: #155724; }
        .message.info { background: #e7f3ff; color: #0c2c54; }

        .hidden { display: none !important; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(12, 44, 84, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ê³„ì¢Œ ì •ë³´ ë°•ìŠ¤ (ì»´íŒ©íŠ¸ ë²„ì „) */
        .account-info-box {
            background: #f1f8ff;
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #d0e6fd;
            text-align: center;
        }
        .account-info-title {
            color: #0c2c54;
            font-weight: 700;
            margin-bottom: 0.2rem;
            font-size: 0.85rem;
        }
        .account-info-detail {
            color: #555;
            font-size: 0.8rem;
        }

        /* ì»¤ìŠ¤í…€ íŒì—… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.2s;
        }
        .custom-modal {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            width: 85%;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: scale(0.9);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn {
            to { transform: scale(1); }
        }
        .custom-modal h3 {
            color: #e74c3c;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }
        .custom-modal p {
            color: #333;
            margin-bottom: 1.2rem;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .custom-modal button {
            background: #0c2c54;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            width: 100%;
        }
        
        /* ì»¤ìŠ¤í…€ ì²´í¬ë°•ìŠ¤ */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            position: relative;
        }
        .checkbox-label input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .checkbox-label .checkmark {
            width: 22px;
            height: 22px;
            background: #fff;
            border: 2px solid #4a90d9;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: #4a90d9;
        }
        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: 'âœ“';
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ íŒì—… -->
    <div class="custom-modal-overlay" id="customAlert">
        <div class="custom-modal">
            <h3>âš ï¸ ì…ë ¥ í™•ì¸</h3>
            <p id="customAlertMsg">ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <button onclick="closeCustomAlert()">í™•ì¸</button>
        </div>
    </div>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginView" class="container-box">
        <h1>ğŸ” ë¡œê·¸ì¸</h1>
        <p class="subtitle">Executive Consulting Solution</p>
        
        <div id="loginMessage" class="message"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label>ì•„ì´ë”” (ID)</label>
                <input type="text" id="userId" placeholder="ì•„ì´ë”” ì…ë ¥" required autocomplete="username">
            </div>
            
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="userPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required autocomplete="current-password">
            </div>
            
            <button type="submit" class="btn">ë¡œê·¸ì¸</button>
        </form>
        
        <div class="divider">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</div>
        
        <button type="button" class="btn btn-secondary" onclick="switchView('signup')">íšŒì›ê°€ì… ì‹ ì²­í•˜ê¸°</button>
        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.75rem; color: #666;">
            * ì‹ ì²­í•˜ì‹œë©´ ë³¸ì‚¬ í™•ì¸ í›„ ì•„ì´ë””ë¥¼ ë°œê¸‰í•´ë“œë¦½ë‹ˆë‹¤.
        </div>
    </div>

    <!-- 2. íšŒì›ê°€ì… ì‹ ì²­ í™”ë©´ (ëª¨ë°”ì¼ ìµœì í™”) -->
    <div id="signupView" class="container-box hidden">
        <h1>ğŸ“ íšŒì›ê°€ì… ì‹ ì²­</h1>
        <p class="subtitle">í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        
        <div id="signupMessage" class="message"></div>

        <form id="signupForm" novalidate>
            <!-- 1ì—´: ì„±ëª… / ì†Œì† -->
            <div class="row-group">
                <div class="form-group">
                    <label>ì„±ëª… <span style="color:red">*</span></label>
                    <input type="text" id="regName" placeholder="í™ê¸¸ë™">
                </div>
                <div class="form-group">
                    <label>ì†Œì† <span style="color:red">*</span></label>
                    <input type="text" id="regCompany" placeholder="í•œêµ­ìƒëª…">
                </div>
            </div>

            <!-- 2ì—´: ì§í•¨ / ì§€ì—­ -->
            <div class="row-group">
                <div class="form-group">
                    <label>ì§í•¨ <span style="color:red">*</span></label>
                    <input type="text" id="regPosition" placeholder="ë§¤ë‹ˆì €">
                </div>
                <div class="form-group">
                    <label>ì§€ì—­ <span style="color:red">*</span></label>
                    <select id="regRegion" style="padding: 0.7rem 0.2rem;">
                        <option value="">ì„ íƒ</option>
                        <option value="ì„œìš¸">ì„œìš¸</option>
                        <option value="ê²½ê¸°">ê²½ê¸°</option>
                        <option value="ì¸ì²œ">ì¸ì²œ</option>
                        <option value="ê°•ì›">ê°•ì›</option>
                        <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                        <option value="ì¶©ë¶">ì¶©ë¶</option>
                        <option value="ëŒ€ì „">ëŒ€ì „</option>
                        <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                        <option value="ê²½ë¶">ê²½ë¶</option>
                        <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                        <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                        <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                        <option value="ì „ë‚¨">ì „ë‚¨</option>
                        <option value="ì „ë¶">ì „ë¶</option>
                        <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                        <option value="ì œì£¼">ì œì£¼</option>
                    </select>
                </div>
            </div>

            <!-- 3ì—´: ì—°ë½ì²˜ -->
            <div class="form-group">
                <label>ì—°ë½ì²˜ <span style="color:red">*</span></label>
                <div class="input-group phone-group">
                    <select id="phone1">
                        <option value="010" selected>010</option>
                        <option value="011">011</option>
                        <option value="016">016</option>
                        <option value="017">017</option>
                        <option value="018">018</option>
                        <option value="019">019</option>
                    </select>
                    <span>-</span>
                    <input type="tel" id="phone2" maxlength="4" inputmode="numeric" placeholder="1234" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <span>-</span>
                    <input type="tel" id="phone3" maxlength="4" inputmode="numeric" placeholder="5678" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
            </div>

            <!-- 4ì—´: ì´ë©”ì¼ -->
            <div class="form-group">
                <label>ì´ë©”ì¼ <span style="color:red">*</span></label>
                <div class="input-group email-group">
                    <input type="text" id="emailId" placeholder="ID" inputmode="email">
                    <span>@</span>
                    <select id="emailDomainSelect" onchange="toggleCustomDomain(this)">
                        <option value="">ì„ íƒ</option>
                        <option value="naver.com">naver.com</option>
                        <option value="gmail.com">gmail.com</option>
                        <option value="daum.net">daum.net</option>
                        <option value="nate.com">nate.com</option>
                        <option value="custom">ì§ì ‘ì…ë ¥</option>
                    </select>
                </div>
                <input type="text" id="emailCustomDomain" placeholder="ë„ë©”ì¸ ì…ë ¥" class="hidden" style="margin-top: 0.4rem; padding: 0.6rem;">
            </div>

            <!-- ê³„ì¢Œ ì •ë³´ -->
            <div class="account-info-box">
                <div class="account-info-title">[ì†¡ê¸ˆê³„ì¢Œ] êµ­ë¯¼ 378801-01-062695</div>
                <div class="account-info-detail">ì˜ˆê¸ˆì£¼: (ì£¼)í•œêµ­FPì„¼í„°</div>
            </div>

            <!-- ì•½ê´€ ë™ì˜ -->
            <div class="terms-agreement" style="margin: 1.5rem 0; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <div style="margin-bottom: 0.8rem;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="agreeTerms">
                        <span class="checkmark"></span>
                        <span style="font-size: 0.9rem;">[í•„ìˆ˜] <a href="javascript:void(0)" onclick="showTermsPopup('service')" style="color: #4a90d9; text-decoration: underline;">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</a>ì— ë™ì˜í•©ë‹ˆë‹¤</span>
                    </label>
                </div>
                <div>
                    <label class="checkbox-label">
                        <input type="checkbox" id="agreePrivacy">
                        <span class="checkmark"></span>
                        <span style="font-size: 0.9rem;">[í•„ìˆ˜] <a href="javascript:void(0)" onclick="showTermsPopup('privacy')" style="color: #4a90d9; text-decoration: underline;">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤</span>
                    </label>
                </div>
            </div>

            <button type="submit" class="btn">ì‹ ì²­ì„œ ì œì¶œ</button>
            <button type="button" class="btn btn-back" onclick="switchView('login')">ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ</button>
        </form>
    </div>

    <!-- 3. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í™”ë©´ -->
    <div id="changePwView" class="container-box hidden">
        <h1>ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h1>
        <p class="subtitle">ìµœì´ˆ ì ‘ì† ì‹œ ë³€ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        
        <div id="pwMessage" class="message"></div>

        <form id="changePwForm">
            <div class="form-group">
                <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="newPw" placeholder="6ì ì´ìƒ ì…ë ¥" required minlength="6">
            </div>
            
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="confirmPw" placeholder="í•œë²ˆ ë” ì…ë ¥" required minlength="6">
            </div>
            
            <button type="submit" class="btn">ë³€ê²½ ì™„ë£Œ ë° ì‹œì‘</button>
        </form>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // --- 1. Firebase ì„¤ì • ë° ì´ˆê¸°í™” ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbufefZCVqCY8QQppcdQFoqVFpMriv1m0",
            authDomain: "kfpc-company-support-project.firebaseapp.com",
            databaseURL: "https://kfpc-company-support-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kfpc-company-support-project",
            storageBucket: "kfpc-company-support-project.firebasestorage.app",
            messagingSenderId: "101260933373",
            appId: "1:101260933373:web:3436176f9ca2560056d914"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. ìƒíƒœ ê´€ë¦¬ ë° UI ì œì–´ ---
        const views = {
            login: document.getElementById('loginView'),
            signup: document.getElementById('signupView'),
            changePw: document.getElementById('changePwView')
        };
        const loading = document.getElementById('loadingOverlay');
        const customAlertOverlay = document.getElementById('customAlert');
        const customAlertMsg = document.getElementById('customAlertMsg');
        let alertFocusTarget = null;

        function showLoading() { loading.style.display = 'flex'; }
        function hideLoading() { loading.style.display = 'none'; }
        
        function showCustomAlert(msg, elementIdToFocus) {
            customAlertMsg.innerHTML = msg;
            customAlertOverlay.style.display = 'flex';
            if (elementIdToFocus) {
                alertFocusTarget = document.getElementById(elementIdToFocus);
            } else {
                alertFocusTarget = null;
            }
        }

        window.closeCustomAlert = function() {
            customAlertOverlay.style.display = 'none';
            if (alertFocusTarget) {
                alertFocusTarget.focus();
            }
        };

        function switchView(viewName) {
            document.querySelectorAll('.message').forEach(el => el.style.display = 'none');
            document.querySelectorAll('form').forEach(form => form.reset());
            document.getElementById('emailCustomDomain').classList.add('hidden');
            
            Object.values(views).forEach(el => el.classList.add('hidden'));
            if(views[viewName]) views[viewName].classList.remove('hidden');
        }

        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message ${type}`;
            el.style.display = 'block';
        }

        window.toggleCustomDomain = function(select) {
            const customInput = document.getElementById('emailCustomDomain');
            if (select.value === 'custom') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        };

        // --- 3. ë¡œê·¸ì¸ ë¡œì§ ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('userId').value.trim();
            const userPw = document.getElementById('userPw').value.trim();

            if (!userId) { showCustomAlert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "userId"); return; }
            if (!userPw) { showCustomAlert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "userPw"); return; }

            // [ê´€ë¦¬ì ì ‘ì† ì²´í¬]
            if (userId === 'admin' && userPw === 'kfpc0808') {
                localStorage.setItem('adminLoggedIn', 'true');
                alert('ê´€ë¦¬ì ëª¨ë“œë¡œ ì ‘ì†í•©ë‹ˆë‹¤.');
                window.location.href = 'admin.html'; 
                return;
            }

            showLoading();
            
            try {
                const email = `${userId}@system.local`;
                const userCredential = await auth.signInWithEmailAndPassword(email, userPw);
                const user = userCredential.user;
                checkUserStatus(user);

            } catch (error) {
                console.error('Login Error:', error);
                hideLoading();
                let msg = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    msg = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
                showMessage('loginMessage', msg, 'error');
            }
        });

        // --- 4. íšŒì›ê°€ì… ì‹ ì²­ ë¡œì§ (ìˆ˜ì •ëœ ë¶€ë¶„: ìµëª… ë¡œê·¸ì¸ ì ìš©) ---
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('regName').value.trim();
            const phone1 = document.getElementById('phone1').value;
            const phone2 = document.getElementById('phone2').value.trim();
            const phone3 = document.getElementById('phone3').value.trim();
            const emailId = document.getElementById('emailId').value.trim();
            const emailDomainSelect = document.getElementById('emailDomainSelect').value;
            const emailCustomDomain = document.getElementById('emailCustomDomain').value.trim();
            const company = document.getElementById('regCompany').value.trim();
            const position = document.getElementById('regPosition').value.trim();
            const region = document.getElementById('regRegion').value;

            // ì•½ê´€ ë™ì˜ ì²´í¬
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const agreePrivacy = document.getElementById('agreePrivacy').checked;
            if (!agreeTerms) { showCustomAlert("ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.", "agreeTerms"); return; }
            if (!agreePrivacy) { showCustomAlert("ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•´ì£¼ì„¸ìš”.", "agreePrivacy"); return; }

            if (!name) { showCustomAlert("ì„±ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "regName"); return; }
            if (!company) { showCustomAlert("ì†Œì†ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "regCompany"); return; }
            if (!position) { showCustomAlert("ì§í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "regPosition"); return; }
            if (!region) { showCustomAlert("ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "regRegion"); return; }
            if (!phone2 || !phone3 || phone2.length < 3 || phone3.length < 4) { showCustomAlert("ì˜¬ë°”ë¥¸ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "phone2"); return; }
            if (!emailId) { showCustomAlert("ì´ë©”ì¼ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "emailId"); return; }
            if (!emailDomainSelect) { showCustomAlert("ì´ë©”ì¼ ë„ë©”ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "emailDomainSelect"); return; }
            if (emailDomainSelect === 'custom' && !emailCustomDomain) { showCustomAlert("ë„ë©”ì¸ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", "emailCustomDomain"); return; }

            const fullPhone = `${phone1}${phone2}${phone3}`;
            const finalDomain = (emailDomainSelect === 'custom') ? emailCustomDomain : emailDomainSelect;
            const fullEmail = `${emailId}@${finalDomain}`;

            showLoading();

            try {
                // *** í•µì‹¬ ìˆ˜ì •: ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ìµëª… ë¡œê·¸ì¸ ìˆ˜í–‰ ***
                if (!auth.currentUser) {
                    await auth.signInAnonymously();
                }

                await db.collection('account_requests').add({
                    name: name,
                    phone: fullPhone,
                    email: fullEmail,
                    company: company,
                    position: position,
                    region: region,
                    status: 'pending',
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoading();
                alert('âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\në‹´ë‹¹ìê°€ í™•ì¸ í›„ ì…ë ¥í•˜ì‹  ì—°ë½ì²˜ë¡œ\nì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.');
                
                // ìµëª… ê³„ì •ì€ ì‹ ì²­ í›„ ë¡œê·¸ì•„ì›ƒí•˜ì—¬ ì„¸ì…˜ ì •ë¦¬ (ì„ íƒ ì‚¬í•­ì´ë‚˜ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬)
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    await auth.signOut();
                }
                
                switchView('login');

            } catch (error) {
                console.error('Signup Request Error:', error);
                hideLoading();
                showMessage('signupMessage', 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (' + error.code + ')', 'error');
            }
        });

        // --- 5. ì‚¬ìš©ì ìƒíƒœ í™•ì¸ ë° ì´ë™ ---
        async function checkUserStatus(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                const userData = userDoc.data();
                
                // â˜… íšŒì› ìƒíƒœ ì²´í¬ (ë¹„í™œì„±, íƒˆí‡´ íšŒì› ë¡œê·¸ì¸ ì°¨ë‹¨)
                if (userData.status === 'inactive' || userData.status === 'withdrawn') {
                    await auth.signOut();
                    hideLoading();
                    showMessage('loginMessage', 'ì´ìš©ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.', 'error');
                    return;
                }
                
                if (userData.role === 'admin') {
                    localStorage.setItem('adminLoggedIn', 'true');
                    window.location.href = 'admin.html';
                    return;
                }

                if (!userData.isPasswordChanged) {
                    hideLoading();
                    switchView('changePw');
                } else {
                    // ë©”ì¸ í˜ì´ì§€(index.html)ë¡œ ì´ë™
                    window.location.href = 'index.html';
                }

            } catch (error) {
                console.error(error);
                auth.signOut();
                hideLoading();
                showMessage('loginMessage', 'ê³„ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // --- 6. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ---
        document.getElementById('changePwForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPw = document.getElementById('newPw').value;
            const confirmPw = document.getElementById('confirmPw').value;
            const user = auth.currentUser;

            if (!user) {
                alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.reload();
                return;
            }

            if (newPw !== confirmPw) { showMessage('pwMessage', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); return; }
            if (newPw.length < 6) { showMessage('pwMessage', '6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }

            showLoading();

            try {
                await user.updatePassword(newPw);
                await db.collection('users').doc(user.uid).update({
                    password: newPw,  // â˜… ë¹„ë°€ë²ˆí˜¸ë¥¼ Firestoreì—ë„ ì €ì¥ (ê´€ë¦¬ì ì¡°íšŒìš©)
                    isPasswordChanged: true,
                    passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';

            } catch (error) {
                console.error('Password Change Error:', error);
                hideLoading();
                showMessage('pwMessage', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // ì•½ê´€ íŒì—… í‘œì‹œ
        async function showTermsPopup(type) {
            const title = type === 'service' ? 'ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€' : 'ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨';
            let content = '';
            
            try {
                const doc = await db.collection('settings').doc('terms').get();
                if (doc.exists) {
                    content = doc.data()[type] || 'ì•½ê´€ ë‚´ìš©ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                } else {
                    content = 'ì•½ê´€ ë‚´ìš©ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                }
            } catch (error) {
                console.error('ì•½ê´€ ë¡œë“œ ì˜¤ë¥˜:', error);
                content = 'ì•½ê´€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
            
            // íŒì—… ìƒì„±
            const popup = document.createElement('div');
            popup.id = 'termsPopup';
            popup.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;';
            popup.innerHTML = `
                <div style="background:#fff;border-radius:12px;max-width:600px;width:100%;max-height:80vh;display:flex;flex-direction:column;">
                    <div style="padding:1.2rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;color:#1a2a3a;font-size:1.1rem;">${title}</h3>
                        <button onclick="closeTermsPopup()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;">&times;</button>
                    </div>
                    <div style="padding:1.2rem;overflow-y:auto;flex:1;white-space:pre-wrap;line-height:1.8;color:#333;font-size:0.9rem;">${content}</div>
                    <div style="padding:1rem;border-top:1px solid #eee;text-align:center;">
                        <button onclick="closeTermsPopup()" style="background:#1a2a3a;color:#fff;border:none;padding:0.7rem 2rem;border-radius:6px;cursor:pointer;">í™•ì¸</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }
        
        function closeTermsPopup() {
            const popup = document.getElementById('termsPopup');
            if (popup) popup.remove();
        }
    </script>
</body>
</html>