<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>KFPC ì€í‡´ ê³„ì‚°ê¸° (ë…ë¦½ ì‹¤í–‰í˜• Â· KRW)</title>
<meta name="description" content="ì€í‡´ ì¤€ë¹„ì— í•„ìš”í•œ ìê¸ˆ, ë§¤ì›” ì €ì¶•ì•¡, ê°€ëŠ¥í•œ ì¸ì¶œì•¡, ìê¸ˆ ì§€ì† ê¸°ê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤. (KRW ê¸°ì¤€)">
<style>
  /* ===== ê¸°ë³¸ ë¦¬ì…‹ & í°íŠ¸ ===== */
  html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR","Apple SD Gothic Neo",Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0b1f3a;background:#f3f5f9}
  *,*:before,*:after{box-sizing:border-box}
  :root{
    --navy:#0b1f3a;
    --blue:#2a5a8a;
    --gold:#c5a05b;
    --card:#ffffff;
    --line:#e8ecf3;
    --muted:#6b7a90;
    --accent:#5045E5;
  }

  /* ===== ë ˆì´ì•„ì›ƒ ===== */
  .wrapper{max-width:1100px;margin:24px auto;padding:0 16px}
  
  /* KFPC ë¡œê³  ìŠ¤íƒ€ì¼ */
  .header{display:flex;align-items:center;gap:20px;margin-bottom:20px;padding:15px 0;position:relative}
  .logo-kfpc{
    font-size:36px;
    font-weight:900;
    letter-spacing:4px;
    background:linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    text-shadow:0 2px 10px rgba(94,114,228,0.3);
  }
  .title-area{flex:1}
  .title-area h1{margin:0;font-size:28px;color:var(--navy)}
  .subtitle{margin:4px 0 0;color:#4a5a73;font-size:14px;line-height:1.5}

  .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
  @media (max-width: 900px){
    .grid{grid-template-columns:1fr}
    .logo-kfpc{font-size:28px;letter-spacing:3px}
    .title-area h1{font-size:24px}
  }
  @media (max-width: 480px){
    .logo-kfpc{font-size:24px;letter-spacing:2px}
    .title-area h1{font-size:20px}
    .subtitle{font-size:13px}
  }

  /* ===== ì¹´ë“œ ===== */
  .card{background:var(--card);border:1px solid rgba(10,20,40,.08);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
  .card.pad{padding:16px}
  .card h3{margin:0 0 10px;padding-bottom:10px;border-bottom:2px solid var(--line);font-size:18px;color:var(--navy)}

  /* ===== ì…ë ¥ ===== */
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .input{flex:1 1 160px;min-width:160px}
  .input .label{font-weight:700;margin:10px 2px 6px;color:var(--navy);font-size:14px}
  .input .sub{font-size:12px;color:var(--muted);margin:2px 2px 8px;line-height:1.4}
  .field{display:flex;align-items:center;gap:8px;border:1px solid #d7deea;background:#fff;border-radius:10px;padding:10px 12px;transition:all 0.2s}
  .field:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(80,69,229,0.1)}
  .field input,.field select{border:none;outline:none;font-size:15px;width:100%;background:transparent}
  .hint{font-size:12px;color:#7b879b;white-space:nowrap}
  .unit{font-weight:800;color:#65728a}
  .tab-select{width:100%;padding:10px 12px;border:1px solid #d7deea;border-radius:10px;background:#fff;font-size:14px;cursor:pointer}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:12px;padding:11px 16px;font-weight:800;cursor:pointer;transition:all 0.2s}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.primary:hover{background:#4038d4;transform:translateY(-1px);box-shadow:0 4px 12px rgba(80,69,229,0.3)}
  .btn.ghost{background:#eef1f7;color:#22324b}
  .btn-block{width:100%}

  /* ===== ê²°ê³¼ ===== */
  .result{padding:4px 0}
  .result .k{font-weight:800;color:var(--blue);font-size:18px}
  .explain{font-size:13px;color:#4a5a73;line-height:1.6;margin-top:8px;padding:10px;background:#f8f9fc;border-radius:8px}
  .callout{background:#f7f9ff;border:1px dashed #c8d2ff;border-radius:12px;padding:12px;margin-top:10px;font-size:13px;color:#25314a;line-height:1.5}

  /* ê·¸ë˜í”„ ì»¨í…Œì´ë„ˆ */
  .chart-container{margin-top:20px;padding:15px;background:#fff;border-radius:12px;border:1px solid #e8ecf3}
  .chart-container canvas{max-height:350px}

  /* ì—°ë„ë³„ í…Œì´ë¸” */
  .year-table{width:100%;margin-top:15px;border-collapse:collapse;font-size:13px}
  .year-table th{background:linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);color:#fff;padding:10px;text-align:center;font-weight:700}
  .year-table td{padding:8px;text-align:right;border-bottom:1px solid #e8ecf3}
  .year-table tr:hover{background:#f8f9fc}
  .year-table tr:last-child td{border-bottom:none}

  /* ===== ëª¨ë‹¬ ===== */
  .modal-back{position:fixed;inset:0;background:rgba(7,15,30,.72);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;padding:18px;border-radius:16px;max-width:720px;width:92%;box-shadow:0 12px 40px rgba(0,0,0,.25);max-height:85vh;overflow-y:auto}
  .modal h2{margin:0 0 8px;color:var(--navy)}
  .modal p{margin:8px 0;color:#33405a;font-size:14px;line-height:1.6}
  .modal .list{margin:8px 0 0 16px;color:#3a4a64;font-size:14px}
  .modal .list li{margin:6px 0}
  .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}

  /* í‘¸í„° */
  .footer{text-align:center;padding:30px 16px;color:#6b7a90;font-size:13px;border-top:1px solid #e8ecf3;margin-top:40px}

  /* iOS í´ë¦­ ê°•ì¡° ì œê±° */
  button,input,select{ -webkit-tap-highlight-color: rgba(0,0,0,0); }
</style>
</head>
<body>
<div id="welcome" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h2>ğŸ’° KFPC ì€í‡´ ê³„ì‚°ê¸° ì‚¬ìš© ì•ˆë‚´</h2>
    <p><strong>ì´ ê³„ì‚°ê¸°ëŠ” ì›í™” ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ ë„¤ ê°€ì§€ë¥¼ ë„ì™€ë“œë¦½ë‹ˆë‹¤.</strong></p>
    <ul class="list">
      <li><b>â‘  ì€í‡´ì— í•„ìš”í•œ ì´ ìê¸ˆ</b> â€” ìƒí™œë¹„Â·ë³´ì¡°ì†Œë“Â·ìˆ˜ìµë¥ Â·ì¸í”Œë ˆì´ì…˜ì„ ë°˜ì˜í•˜ì—¬ ì€í‡´ ì‹œì ì— í•„ìš”í•œ ê¸ˆì•¡ì„ ê³„ì‚°í•©ë‹ˆë‹¤</li>
      <li><b>â‘¡ ë§¤ì›” ì–¼ë§ˆë¥¼ ì €ì¶•í•´ì•¼ í•˜ë‚˜</b> â€” ëª©í‘œ ì‹œì (ì€í‡´ì—°ë ¹)ê¹Œì§€ í•„ìš”í•œ ì›” ì €ì¶•ì•¡ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤</li>
      <li><b>â‘¢ ë§¤ì›” ì–¼ë§ˆë‚˜ ì¸ì¶œí•  ìˆ˜ ìˆë‚˜</b> â€” ë³´ìœ  ìì‚°ìœ¼ë¡œ ê°€ëŠ¥í•œ ì•ˆì „ ì¸ì¶œì•¡ì„ ê³„ì‚°í•©ë‹ˆë‹¤</li>
      <li><b>â‘£ ë‚´ ìê¸ˆì´ ì–¼ë§ˆë‚˜ ì§€ì†ë˜ë‚˜</b> â€” í˜„ì¬ ìì‚°ê³¼ ì¸ì¶œì•¡ ê¸°ì¤€ ì§€ì† ê°€ëŠ¥ ê¸°ê°„ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤</li>
    </ul>
    <p><strong>ğŸ’¡ ì‚¬ìš© íŒ</strong></p>
    <ul class="list">
      <li>ëª¨ë“  ê¸ˆì•¡ì€ <b>â‚© ì›í™”</b> ê¸°ì¤€ì…ë‹ˆë‹¤</li>
      <li>ìˆ«ìë¥¼ ì…ë ¥í•˜ë©´ <b>ìë™ìœ¼ë¡œ 3ìë¦¬ ì½¤ë§ˆ</b>ê°€ í‘œì‹œë©ë‹ˆë‹¤</li>
      <li>ê³„ì‚° ê²°ê³¼ì—ëŠ” <b>ì—°ë„ë³„ ê·¸ë˜í”„ì™€ ìƒì„¸ í‘œ</b>ê°€ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤</li>
      <li>ê° í•­ëª©ë§ˆë‹¤ ì‰¬ìš´ ì„¤ëª…ì´ ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì„¸ìš”</li>
    </ul>
    <div class="modal-footer">
      <button class="btn primary" onclick="document.getElementById('welcome').style.display='none'">í™•ì¸í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>
</div>

<div class="wrapper">
  <div class="header">
    <div class="logo-kfpc">KFPC</div>
    <div class="title-area">
      <h1>ì€í‡´ ê³„ì‚°ê¸°</h1>
      <p class="subtitle">ë¯¸ë˜ ìì‚° ê³„íšì„ ìœ„í•œ ì¢…í•© ì€í‡´ ì‹œë®¬ë ˆì´í„° (ì›í™” ê¸°ì¤€ Â· ì‹¤ì‹œê°„ ê³„ì‚°)</p>
    </div>
  </div>

  <div class="grid">
    <!-- ì¢Œì¸¡: ì…ë ¥ -->
    <div class="card pad">
      <h3>ğŸ“ ì •ë³´ ì…ë ¥</h3>

      <div class="input">
        <div class="label">ê³„ì‚° ëª¨ë“œ ì„ íƒ</div>
        <select id="mode" class="tab-select" aria-label="ê³„ì‚° ëª¨ë“œ">
          <option value="need">â‘  ì€í‡´ì— í•„ìš”í•œ ì´ ê¸ˆì•¡ ê³„ì‚°</option>
          <option value="save">â‘¡ ë§¤ì›” ì €ì¶•í•´ì•¼ í•  ê¸ˆì•¡ ê³„ì‚°</option>
          <option value="withdraw">â‘¢ ë§¤ì›” ì¸ì¶œ ê°€ëŠ¥í•œ ê¸ˆì•¡ ê³„ì‚°</option>
          <option value="duration">â‘£ ìê¸ˆ ì§€ì† ê°€ëŠ¥ ê¸°ê°„ ê³„ì‚°</option>
        </select>
        <div class="sub">ğŸ’¡ ì›í•˜ì‹œëŠ” ê³„ì‚° ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</div>
      </div>

      <!-- ê³µí†µ: ë‚˜ì´ -->
      <div class="row">
        <div class="input">
          <div class="label">í˜„ì¬ ë‚˜ì´</div>
          <div class="field"><input id="current_age" inputmode="numeric" placeholder="ì˜ˆ: 35"><span class="hint">ì„¸</span></div>
          <div class="sub">ì§€ê¸ˆ ë§Œ ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        </div>
        <div class="input">
          <div class="label">ì€í‡´ ì˜ˆì • ë‚˜ì´</div>
          <div class="field"><input id="retire_age" inputmode="numeric" placeholder="ì˜ˆ: 65"><span class="hint">ì„¸</span></div>
          <div class="sub">ì€í‡´í•˜ì‹¤ ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        </div>
        <div class="input">
          <div class="label">ì˜ˆìƒ ìˆ˜ëª…</div>
          <div class="field"><input id="life_exp" inputmode="numeric" placeholder="ì˜ˆ: 85"><span class="hint">ì„¸</span></div>
          <div class="sub">ëª‡ ì„¸ê¹Œì§€ ìƒí™œë¹„ê°€ í•„ìš”í•œì§€</div>
        </div>
      </div>

      <!-- ìˆ˜ìµë¥ /ë¬¼ê°€ -->
      <div class="row">
        <div class="input">
          <div class="label">ì—°í‰ê·  íˆ¬ì ìˆ˜ìµë¥ </div>
          <div class="field"><input id="return_pct" inputmode="decimal" placeholder="ì˜ˆ: 6"><span class="hint">%</span></div>
          <div class="sub">íˆ¬ìë¡œ ì–»ì„ ìˆ˜ ìˆëŠ” ì—° ìˆ˜ìµë¥  (ë³´ìˆ˜ì  ê¶Œì¥)</div>
        </div>
        <div class="input">
          <div class="label">ì—°í‰ê·  ë¬¼ê°€ìƒìŠ¹ë¥ </div>
          <div class="field"><input id="inflation_pct" inputmode="decimal" placeholder="ì˜ˆ: 3"><span class="hint">%</span></div>
          <div class="sub">ë§¤ë…„ ë¬¼ê°€ê°€ ì˜¤ë¥´ëŠ” ë¹„ìœ¨</div>
        </div>
      </div>

      <!-- ëª¨ë“œë³„ ì¶”ê°€ ì…ë ¥ -->
      <div id="block-need" class="mode-block">
        <h3 style="margin-top:18px">ğŸ’° í•„ìš” ìê¸ˆ ê³„ì‚° ì •ë³´</h3>
        <div class="row">
          <div class="input">
            <div class="label">í˜„ì¬ ì—°ê°„ ì†Œë“</div>
            <div class="field"><span class="unit">â‚©</span><input id="current_income" placeholder="ì˜ˆ: 70,000,000" inputmode="numeric"></div>
            <div class="sub">í˜„ì¬ 1ë…„ ë™ì•ˆ ë²„ëŠ” ì´ ì†Œë“</div>
          </div>
          <div class="input">
            <div class="label">ì€í‡´ í›„ í•„ìš” ìƒí™œë¹„ ë¹„ìœ¨</div>
            <div class="field"><input id="replace_pct" placeholder="ì˜ˆ: 70" inputmode="decimal"><span class="hint">%</span></div>
            <div class="sub">ì€í‡´ í›„ í˜„ì¬ ì†Œë“ì˜ ëª‡ %ê°€ í•„ìš”í•œì§€</div>
          </div>
        </div>
        <div class="row">
          <div class="input">
            <div class="label">ë§¤ì›” ë°›ì„ êµ­ë¯¼ì—°ê¸ˆ ë“±</div>
            <div class="field"><span class="unit">â‚©</span><input id="ss_month" placeholder="ì˜ˆ: 1,200,000" inputmode="numeric"><span class="hint">/ì›”</span></div>
            <div class="sub">êµ­ë¯¼ì—°ê¸ˆÂ·ì„ëŒ€ë£Œ ë“± ë§¤ì›” ë°›ëŠ” ëˆ</div>
          </div>
          <div class="input">
            <div class="label">ê¸°íƒ€ ì›” ìˆ˜ì…</div>
            <div class="field"><span class="unit">â‚©</span><input id="other_month" placeholder="ì˜ˆ: 300,000" inputmode="numeric"><span class="hint">/ì›”</span></div>
            <div class="sub">ë¶€ì—…Â·ì´ì ë“± ì¶”ê°€ ìˆ˜ì…</div>
          </div>
        </div>
        <div class="row">
          <div class="input">
            <div class="label">í˜„ì¬ ëª¨ì•„ë‘” ì€í‡´ìê¸ˆ</div>
            <div class="field"><span class="unit">â‚©</span><input id="current_saving" placeholder="ì˜ˆ: 0" inputmode="numeric"></div>
            <div class="sub">ì§€ê¸ˆê¹Œì§€ ëª¨ì€ ì´ ê¸ˆì•¡</div>
          </div>
          <div class="input">
            <div class="label">ì•ìœ¼ë¡œ ì €ì¶•í•  ë¹„ìœ¨</div>
            <div class="field"><input id="save_rate_pct" placeholder="ì˜ˆ: 10" inputmode="decimal"><span class="hint">%</span></div>
            <div class="sub">ë§¤ë…„ ì†Œë“ì˜ ëª‡ %ë¥¼ ì €ì¶•í• ì§€</div>
          </div>
        </div>
      </div>

      <div id="block-save" class="mode-block" style="display:none">
        <h3 style="margin-top:18px">ğŸ’µ ì €ì¶•ì•¡ ì‚°ì • ì •ë³´</h3>
        <div class="row">
          <div class="input">
            <div class="label">ì€í‡´ ì‹œ ëª©í‘œ ê¸ˆì•¡</div>
            <div class="field"><span class="unit">â‚©</span><input id="goal_amount" placeholder="ì˜ˆ: 800,000,000" inputmode="numeric"></div>
            <div class="sub">ì€í‡´í•  ë•Œ ê°–ê³  ì‹¶ì€ ì´ ê¸ˆì•¡</div>
          </div>
          <div class="input">
            <div class="label">í˜„ì¬ ëª¨ì•„ë‘” ì€í‡´ìê¸ˆ</div>
            <div class="field"><span class="unit">â‚©</span><input id="current_saving2" placeholder="ì˜ˆ: 30,000,000" inputmode="numeric"></div>
            <div class="sub">ì§€ê¸ˆê¹Œì§€ ëª¨ì€ ê¸ˆì•¡</div>
          </div>
        </div>
      </div>

      <div id="block-withdraw" class="mode-block" style="display:none">
        <h3 style="margin-top:18px">ğŸ’¸ ì¸ì¶œì•¡ ê³„ì‚° ì •ë³´</h3>
        <div class="row">
          <div class="input">
            <div class="label">í˜„ì¬ ë³´ìœ í•œ ì€í‡´ìê¸ˆ</div>
            <div class="field"><span class="unit">â‚©</span><input id="balance_now" placeholder="ì˜ˆ: 800,000,000" inputmode="numeric"></div>
            <div class="sub">ì§€ê¸ˆ ê°–ê³  ìˆëŠ” ì´ ìì‚°</div>
          </div>
        </div>
      </div>

      <div id="block-duration" class="mode-block" style="display:none">
        <h3 style="margin-top:18px">â±ï¸ ì§€ì† ê¸°ê°„ ê³„ì‚° ì •ë³´</h3>
        <div class="row">
          <div class="input">
            <div class="label">í˜„ì¬ ë³´ìœ í•œ ì€í‡´ìê¸ˆ</div>
            <div class="field"><span class="unit">â‚©</span><input id="balance_now2" placeholder="ì˜ˆ: 600,000,000" inputmode="numeric"></div>
            <div class="sub">ì§€ê¸ˆ ê°–ê³  ìˆëŠ” ì´ ìì‚°</div>
          </div>
          <div class="input">
            <div class="label">ë§¤ì›” ì‚¬ìš©í•  ê¸ˆì•¡</div>
            <div class="field"><span class="unit">â‚©</span><input id="withdraw_month" placeholder="ì˜ˆ: 2,000,000" inputmode="numeric"><span class="hint">/ì›”</span></div>
            <div class="sub">í•œ ë‹¬ì— ì“¸ ìƒí™œë¹„</div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <button id="run" class="btn primary btn-block">ğŸ“Š ê³„ì‚°í•˜ê¸°</button>
      </div>
    </div>

    <!-- ìš°ì¸¡: ê²°ê³¼ -->
    <div class="card pad">
      <h3>ğŸ“ˆ ê³„ì‚° ê²°ê³¼</h3>
      <div id="result" class="result">
        <p>ì¢Œì¸¡ì— ê°’ì„ ì…ë ¥í•˜ê³  <b>ê³„ì‚°í•˜ê¸°</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”. ëª¨ë“  ê²°ê³¼ì—ëŠ” ì‰¬ìš´ ì„¤ëª…ê³¼ í•¨ê»˜ <b>ê·¸ë˜í”„</b>ì™€ <b>ì—°ë„ë³„ ìƒì„¸í‘œ</b>ê°€ ì œê³µë©ë‹ˆë‹¤.</p>
      </div>
      <div class="callout">
        ğŸ’¡ <b>ì‹¤ì§ˆìˆ˜ìµë¥  (= ëª…ëª©ìˆ˜ìµë¥  âˆ’ ì¸í”Œë ˆì´ì…˜)</b>ì´ ë‚®ì„ìˆ˜ë¡ í•„ìš”í•œ ìê¸ˆì€ ì»¤ì§€ê³ ,
        ë™ì¼ ìê¸ˆìœ¼ë¡œ ê°€ëŠ¥í•œ ì¸ì¶œì•¡/ì§€ì†ê¸°ê°„ì€ ì¤„ì–´ë“­ë‹ˆë‹¤. ë³´ìˆ˜ì ìœ¼ë¡œ ê³„ì‚°í•˜ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
      </div>
      <div id="chartArea"></div>
      <div id="tableArea"></div>
    </div>
  </div>

  <div class="footer">
    Copyright Â© 2025 KFPC Co., Ltd. All Rights Reserved.
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ===== ìœ í‹¸: ìˆ«ì í¬ë§· ===== */
const onlyDigits = s => (s||'').toString().replace(/[^\d.-]/g,'');
const toNumber = s => {
  const v = parseFloat(onlyDigits(s).replace(/,/g,''));
  return isNaN(v) ? 0 : v;
};
const fmtKRW = n => {
  const sign = n < 0 ? '-' : '';
  const v = Math.abs(n);
  return sign + v.toLocaleString('ko-KR');
};
function attachCommaInput(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', e=>{
    const cursor = el.selectionStart;
    const raw = onlyDigits(el.value);
    const parts = raw.split('.');
    let int = parts[0].replace(/^0+(?=\d)/,'');
    if(int==='') int='0';
    const dec = parts[1];
    let out = parseInt(int,10).toLocaleString('ko-KR');
    if(raw.includes('.') && dec!==undefined) out += '.'+dec;
    el.value = out === 'NaN' ? '' : out;
  });
}

/* ===== ëª¨ë“œ ì „í™˜ ===== */
const modeEl = document.getElementById('mode');
const blocks = {
  need: document.getElementById('block-need'),
  save: document.getElementById('block-save'),
  withdraw: document.getElementById('block-withdraw'),
  duration: document.getElementById('block-duration')
};
function switchMode(){
  const m = modeEl.value;
  Object.keys(blocks).forEach(k=>blocks[k].style.display = (k===m?'block':'none'));
}
modeEl.addEventListener('change', switchMode);

/* ===== ì…ë ¥ ì½¤ë§ˆ ì ìš© ===== */
['current_income','ss_month','other_month','current_saving','goal_amount','current_saving2','balance_now','balance_now2','withdraw_month']
.forEach(attachCommaInput);

/* ===== ê·¸ë˜í”„ ë³€ìˆ˜ ===== */
let chartInstance = null;

/* ===== ê³„ì‚° ë¡œì§ ===== */
function calc(){
  const mode = modeEl.value;

  const age = toNumber(document.getElementById('current_age').value);
  const retire = toNumber(document.getElementById('retire_age').value);
  const life = toNumber(document.getElementById('life_exp').value);
  const r_nom = toNumber(document.getElementById('return_pct').value)/100;
  const i_nom = toNumber(document.getElementById('inflation_pct').value)/100;

  const ny = Math.max(0, retire - age);
  const nd = Math.max(0, life - retire);
  const r_real_y = (1+r_nom)/(1+i_nom) - 1;
  const r_real_m = Math.pow(1+r_real_y, 1/12) - 1;

  let html = '';
  let chartData = null;
  let tableData = null;

  if(mode==='need'){
    const income = toNumber(document.getElementById('current_income').value);
    const replacePct = toNumber(document.getElementById('replace_pct').value)/100;
    const ss = toNumber(document.getElementById('ss_month').value);
    const other = toNumber(document.getElementById('other_month').value);
    const cur = toNumber(document.getElementById('current_saving').value);
    const saveRate = toNumber(document.getElementById('save_rate_pct').value)/100;

    const needMonthReal = Math.max(0, (income*replacePct)/12 - (ss + other));
    const N = Math.max(1, Math.round(nd*12));
    const r = r_real_m;
    const annuityPV = r === 0 ? needMonthReal * N : needMonthReal * (1 - Math.pow(1+r, -N)) / r;
    const needAtRetire = annuityPV;

    const Y = Math.max(0, Math.round(ny*12));
    const saveMonth = (income * saveRate) / 12;
    const grow = r_real_m;
    const curFV = cur * Math.pow(1+grow, Y);
    const saveFV = grow === 0 ? saveMonth * Y : saveMonth * (Math.pow(1+grow, Y)-1)/grow;
    const gap = Math.max(0, needAtRetire - (curFV + saveFV));

    html += `<p><b>ğŸ’° ì€í‡´ì— í•„ìš”í•œ ì´ ìê¸ˆ (ì€í‡´ ì‹œì Â·ì‹¤ì§ˆê°€ì¹˜)</b><br><span class="k">â‚© ${fmtKRW(needAtRetire.toFixed(0))}</span></p>`;
    html += `<div class="explain">ì€í‡´ í›„ <b>${nd}ë…„</b> ë™ì•ˆ ë§¤ì›” ì‹¤ì§ˆ <b>â‚©${fmtKRW(needMonthReal.toFixed(0))}</b>ì´ í•„ìš”í•˜ë‹¤ê³  ê°€ì •í–ˆì„ ë•Œì˜ ê¸ˆì•¡ì…ë‹ˆë‹¤. (ì‹¤ì§ˆìˆ˜ìµë¥ : ${(r_real_y*100).toFixed(2)}%/ë…„)</div>`;
    html += `<p><b>ğŸ“Š í˜„ì¬â†’ì€í‡´ê¹Œì§€ ì˜ˆìƒ ëˆ„ì  ìê¸ˆ</b><br><span class="k">â‚© ${fmtKRW((curFV+saveFV).toFixed(0))}</span></p>`;
    html += `<div class="explain">í˜„ì¬ ìê¸ˆ ì„±ì¥ë¶„ <b>â‚©${fmtKRW(curFV.toFixed(0))}</b> + ì›” ì €ì¶• <b>â‚©${fmtKRW(saveMonth.toFixed(0))}</b>ì˜ ëˆ„ì  ë¯¸ë˜ê°€ì¹˜ <b>â‚©${fmtKRW(saveFV.toFixed(0))}</b>ì˜ í•©ì…ë‹ˆë‹¤.</div>`;
    html += `<p><b>âš ï¸ ì¶”ê°€ë¡œ í•„ìš”í•œ ë¶€ì¡±ì•¡</b><br><span class="k" style="color:#e74c3c">â‚© ${fmtKRW(gap.toFixed(0))}</span></p>`;
    html += `<div class="explain">ë¶€ì¡±ì•¡ì„ ì¤„ì´ë ¤ë©´ <b>ì €ì¶•ë¥  ìƒí–¥</b>, <b>ìˆ˜ìµë¥  ê°œì„ </b>, <b>ì€í‡´ì‹œê¸° ì¡°ì •</b>, <b>í•„ìš” ìƒí™œë¹„ ì ê²€</b> ë“±ì„ ê³ ë ¤í•˜ì„¸ìš”.</div>`;

    // ê·¸ë˜í”„ ë°ì´í„°
    chartData = generateNeedChart(age, retire, life, cur, saveMonth, grow, needAtRetire, r_real_m);
    tableData = generateNeedTable(age, retire, life, cur, saveMonth, grow, needAtRetire, r_real_m, needMonthReal);
  }

  if(mode==='save'){
    const goal = toNumber(document.getElementById('goal_amount').value);
    const cur = toNumber(document.getElementById('current_saving2').value);

    const Y = Math.max(0, Math.round(ny*12));
    const r = r_real_m;
    const curFV = cur * Math.pow(1+r, Y);
    const needFV = Math.max(0, goal - curFV);
    const pmt = (r===0) ? (needFV / Math.max(1,Y)) : (needFV * r / (Math.pow(1+r,Y)-1));

    html += `<p><b>ğŸ’µ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì›” ì €ì¶•ì•¡</b><br><span class="k">â‚© ${fmtKRW(pmt.toFixed(0))}</span></p>`;
    html += `<div class="explain">í˜„ì¬ ìê¸ˆì€ ì€í‡´ê¹Œì§€ <b>â‚©${fmtKRW(curFV.toFixed(0))}</b>ë¡œ ì„±ì¥í•˜ê³ , ë¶€ì¡±í•œ <b>â‚©${fmtKRW(needFV.toFixed(0))}</b>ë¥¼ <b>${ny}ë…„</b> ë™ì•ˆ ë§¤ì›” ê· ë“± ì €ì¶•í•œë‹¤ê³  ê°€ì •í–ˆìŠµë‹ˆë‹¤.</div>`;

    chartData = generateSaveChart(age, retire, cur, pmt, r_real_m);
    tableData = generateSaveTable(age, retire, cur, pmt, r_real_m);
  }

  if(mode==='withdraw'){
    const bal = toNumber(document.getElementById('balance_now').value);
    const N = Math.max(1, Math.round(nd*12));
    const r = r_real_m;
    const pmt = (r===0) ? (bal / N) : (bal * r / (1 - Math.pow(1+r,-N)));

    html += `<p><b>ğŸ’¸ ë§¤ì›” ì¸ì¶œ ê°€ëŠ¥í•œ ê¸ˆì•¡ (ì‹¤ì§ˆê°€ì¹˜)</b><br><span class="k">â‚© ${fmtKRW(pmt.toFixed(0))}</span></p>`;
    html += `<div class="explain">ì€í‡´ í›„ <b>${nd}ë…„</b> ê°„ ë§¤ì›” ê°™ì€ ì‹¤ì§ˆê°€ì¹˜ë¡œ ì¸ì¶œí•œë‹¤ê³  ê°€ì •í–ˆìŠµë‹ˆë‹¤. (ì‹¤ì§ˆìˆ˜ìµë¥ : ${(r_real_y*100).toFixed(2)}%/ë…„)</div>`;

    chartData = generateWithdrawChart(retire, life, bal, pmt, r_real_m);
    tableData = generateWithdrawTable(retire, life, bal, pmt, r_real_m);
  }

  if(mode==='duration'){
    const bal = toNumber(document.getElementById('balance_now2').value);
    const pmt = toNumber(document.getElementById('withdraw_month').value);
    const r = r_real_m;
    let N;
    if(r===0){
      N = bal / Math.max(1,pmt);
    }else{
      if(pmt <= bal*r){
        html = `<p><b>â™¾ï¸ ìê¸ˆì´ ì´ë¡ ìƒ ì†Œì§„ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</b></p><div class="explain">ì›” ì¸ì¶œì•¡ì´ ì‹¤ì§ˆ ìˆ˜ìµìœ¼ë¡œ ë³´ì „ë˜ëŠ” ë²”ìœ„ ë‚´(<b>PMT â‰¤ rÃ—ì”ì•¡</b>)ë¼ë©´ ìê¸ˆì€ ì†Œì§„ë˜ì§€ ì•Šê³  ìœ ì§€/ì„±ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>`;
        document.getElementById('result').innerHTML = html;
        document.getElementById('chartArea').innerHTML = '';
        document.getElementById('tableArea').innerHTML = '';
        return;
      }else{
        N = Math.log(pmt/(pmt - r*bal))/Math.log(1+r);
      }
    }
    const years = N/12;
    html += `<p><b>â±ï¸ ì˜ˆìƒ ì§€ì† ê°€ëŠ¥ ê¸°ê°„</b><br><span class="k">${years.toFixed(1)} ë…„</span> (ì•½ ${Math.floor(N)} ê°œì›”)</p>`;
    html += `<div class="explain">í˜„ì¬ ìê¸ˆ <b>â‚©${fmtKRW(bal.toFixed(0))}</b>ì—ì„œ ì›” <b>â‚©${fmtKRW(pmt.toFixed(0))}</b>ë¥¼ ì¸ì¶œí•  ë•Œì˜ <b>ì‹¤ì§ˆ ê¸°ì¤€</b> ì§€ì† ê¸°ê°„ì…ë‹ˆë‹¤.</div>`;

    chartData = generateDurationChart(age, bal, pmt, r_real_m, N);
    tableData = generateDurationTable(age, bal, pmt, r_real_m, N);
  }

  document.getElementById('result').innerHTML = html;
  
  if(chartData) drawChart(chartData);
  if(tableData) drawTable(tableData);
}

/* ===== ê·¸ë˜í”„ ìƒì„± í•¨ìˆ˜ë“¤ ===== */
function generateNeedChart(age, retire, life, cur, saveMonth, grow, needAtRetire, withdrawRate){
  const labels = [];
  const assets = [];
  
  // ì€í‡´ ì „: ì €ì¶• ê¸°ê°„
  for(let y = age; y <= retire; y++){
    const months = (y - age) * 12;
    const curGrow = cur * Math.pow(1+grow, months);
    const saveGrow = grow === 0 ? saveMonth * months : saveMonth * (Math.pow(1+grow, months)-1)/grow;
    labels.push(y + 'ì„¸');
    assets.push(curGrow + saveGrow);
  }
  
  // ì€í‡´ í›„: ì¸ì¶œ ê¸°ê°„
  let balance = needAtRetire;
  for(let y = retire + 1; y <= life; y++){
    const months = (y - retire) * 12;
    const monthlyWithdraw = withdrawRate === 0 ? balance / ((life-retire)*12) : balance * withdrawRate / (1 - Math.pow(1+withdrawRate, -(life-retire)*12));
    // ê°„ë‹¨ ê·¼ì‚¬: ë§¤ë…„ 12ê°œì›”ì¹˜ ì¸ì¶œ
    balance = balance * Math.pow(1+withdrawRate, 12) - monthlyWithdraw * 12;
    labels.push(y + 'ì„¸');
    assets.push(Math.max(0, balance));
  }
  
  return {labels, datasets: [{label: 'ì˜ˆìƒ ìì‚°', data: assets, borderColor: '#5e72e4', backgroundColor: 'rgba(94,114,228,0.1)', fill: true, tension: 0.3}]};
}

function generateNeedTable(age, retire, life, cur, saveMonth, grow, needAtRetire, withdrawRate, needMonth){
  const rows = [];
  
  // ì €ì¶• ê¸°ê°„
  for(let y = age; y <= retire; y += 5){
    const months = (y - age) * 12;
    const curGrow = cur * Math.pow(1+grow, months);
    const saveGrow = grow === 0 ? saveMonth * months : saveMonth * (Math.pow(1+grow, months)-1)/grow;
    rows.push({year: y+'ì„¸', balance: curGrow + saveGrow, flow: '+â‚©'+fmtKRW(saveMonth.toFixed(0))});
  }
  
  // ì€í‡´ ì‹œì 
  rows.push({year: retire+'ì„¸ (ì€í‡´)', balance: needAtRetire, flow: 'ì€í‡´'});
  
  // ì¸ì¶œ ê¸°ê°„
  let balance = needAtRetire;
  for(let y = retire + 5; y <= life; y += 5){
    const months = (y - retire) * 12;
    const monthlyWithdraw = withdrawRate === 0 ? balance / ((life-retire)*12) : balance * withdrawRate / (1 - Math.pow(1+withdrawRate, -(life-retire)*12));
    balance = balance * Math.pow(1+withdrawRate, 12) - monthlyWithdraw * 12;
    rows.push({year: y+'ì„¸', balance: Math.max(0, balance), flow: '-â‚©'+fmtKRW(needMonth.toFixed(0))});
  }
  
  return rows;
}

function generateSaveChart(age, retire, cur, pmt, grow){
  const labels = [];
  const assets = [];
  
  for(let y = age; y <= retire; y++){
    const months = (y - age) * 12;
    const curGrow = cur * Math.pow(1+grow, months);
    const saveGrow = grow === 0 ? pmt * months : pmt * (Math.pow(1+grow, months)-1)/grow;
    labels.push(y + 'ì„¸');
    assets.push(curGrow + saveGrow);
  }
  
  return {labels, datasets: [{label: 'ì˜ˆìƒ ìì‚°', data: assets, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3}]};
}

function generateSaveTable(age, retire, cur, pmt, grow){
  const rows = [];
  for(let y = age; y <= retire; y += 5){
    const months = (y - age) * 12;
    const curGrow = cur * Math.pow(1+grow, months);
    const saveGrow = grow === 0 ? pmt * months : pmt * (Math.pow(1+grow, months)-1)/grow;
    rows.push({year: y+'ì„¸', balance: curGrow + saveGrow, flow: '+â‚©'+fmtKRW(pmt.toFixed(0))});
  }
  return rows;
}

function generateWithdrawChart(retire, life, bal, pmt, r){
  const labels = [];
  const assets = [];
  
  let balance = bal;
  for(let y = retire; y <= life; y++){
    labels.push(y + 'ì„¸');
    assets.push(Math.max(0, balance));
    balance = balance * Math.pow(1+r, 12) - pmt * 12;
  }
  
  return {labels, datasets: [{label: 'ì˜ˆìƒ ìì‚°', data: assets, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', fill: true, tension: 0.3}]};
}

function generateWithdrawTable(retire, life, bal, pmt, r){
  const rows = [];
  let balance = bal;
  for(let y = retire; y <= life; y += 5){
    rows.push({year: y+'ì„¸', balance: Math.max(0, balance), flow: '-â‚©'+fmtKRW(pmt.toFixed(0))});
    balance = balance * Math.pow(1+r, 60) - pmt * 60;
  }
  return rows;
}

function generateDurationChart(age, bal, pmt, r, totalMonths){
  const labels = [];
  const assets = [];
  
  let balance = bal;
  const years = Math.ceil(totalMonths / 12);
  for(let y = 0; y <= years; y++){
    labels.push((age+y) + 'ì„¸');
    assets.push(Math.max(0, balance));
    balance = balance * Math.pow(1+r, 12) - pmt * 12;
  }
  
  return {labels, datasets: [{label: 'ì˜ˆìƒ ìì‚°', data: assets, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true, tension: 0.3}]};
}

function generateDurationTable(age, bal, pmt, r, totalMonths){
  const rows = [];
  let balance = bal;
  const years = Math.ceil(totalMonths / 12);
  for(let y = 0; y <= years; y += 5){
    rows.push({year: (age+y)+'ì„¸', balance: Math.max(0, balance), flow: '-â‚©'+fmtKRW(pmt.toFixed(0))});
    balance = balance * Math.pow(1+r, 60) - pmt * 60;
  }
  return rows;
}

/* ===== ê·¸ë˜í”„ ê·¸ë¦¬ê¸° ===== */
function drawChart(data){
  const container = document.getElementById('chartArea');
  container.innerHTML = '<div class="chart-container"><canvas id="myChart"></canvas></div>';
  
  if(chartInstance) chartInstance.destroy();
  
  const ctx = document.getElementById('myChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {display: true, position: 'top'},
        tooltip: {
          callbacks: {
            label: function(context){
              return context.dataset.label + ': â‚©' + fmtKRW(context.parsed.y.toFixed(0));
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value){
              return 'â‚©' + (value/100000000).toFixed(1) + 'ì–µ';
            }
          }
        }
      }
    }
  });
}

/* ===== í…Œì´ë¸” ê·¸ë¦¬ê¸° ===== */
function drawTable(rows){
  const container = document.getElementById('tableArea');
  let html = '<table class="year-table"><thead><tr><th>ë‚˜ì´</th><th>ì˜ˆìƒ ìì‚°</th><th>ì›” íë¦„</th></tr></thead><tbody>';
  rows.forEach(row => {
    html += `<tr><td style="text-align:center">${row.year}</td><td>â‚©${fmtKRW(row.balance.toFixed(0))}</td><td>${row.flow}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
document.getElementById('run').addEventListener('click', calc);
switchMode();

/* ===== ê¸°ë³¸ê°’ ===== */
document.getElementById('current_age').value = '35';
document.getElementById('retire_age').value = '65';
document.getElementById('life_exp').value = '85';
document.getElementById('return_pct').value = '6';
document.getElementById('inflation_pct').value = '3';
document.getElementById('current_income').value = '70,000,000';
document.getElementById('replace_pct').value = '70';
document.getElementById('ss_month').value = '1,200,000';
document.getElementById('other_month').value = '300,000';
document.getElementById('current_saving').value = '0';
document.getElementById('save_rate_pct').value = '10';
document.getElementById('goal_amount').value = '800,000,000';
document.getElementById('current_saving2').value = '30,000,000';
document.getElementById('balance_now').value = '800,000,000';
document.getElementById('balance_now2').value = '600,000,000';
document.getElementById('withdraw_month').value = '2,000,000';
</script>
</body>
</html>